/*! jQuery UI - v1.11.3 - 2015-03-02
* http://jqueryui.com
* Includes: core.js, widget.js, mouse.js, position.js, sortable.js, autocomplete.js, menu.js
* Copyright 2015 jQuery Foundation and other contributors; Licensed MIT */


(function( factory ) {
	if ( typeof define === "function" && define.amd ) {

		// AMD. Register as an anonymous module.
		define([ "jquery" ], factory );
	} else {

		// Browser globals
		factory( jQuery );
	}
}(function( $ ) {
/*!
 * jQuery UI Core 1.11.3
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/category/ui-core/
 */


// $.ui might exist from components with no dependencies, e.g., $.ui.position
$.ui = $.ui || {};

$.extend( $.ui, {
	version: "1.11.3",

	keyCode: {
		BACKSPACE: 8,
		COMMA: 188,
		DELETE: 46,
		DOWN: 40,
		END: 35,
		ENTER: 13,
		ESCAPE: 27,
		HOME: 36,
		LEFT: 37,
		PAGE_DOWN: 34,
		PAGE_UP: 33,
		PERIOD: 190,
		RIGHT: 39,
		SPACE: 32,
		TAB: 9,
		UP: 38
	}
});

// plugins
$.fn.extend({
	scrollParent: function( includeHidden ) {
		var position = this.css( "position" ),
			excludeStaticParent = position === "absolute",
			overflowRegex = includeHidden ? /(auto|scroll|hidden)/ : /(auto|scroll)/,
			scrollParent = this.parents().filter( function() {
				var parent = $( this );
				if ( excludeStaticParent && parent.css( "position" ) === "static" ) {
					return false;
				}
				return overflowRegex.test( parent.css( "overflow" ) + parent.css( "overflow-y" ) + parent.css( "overflow-x" ) );
			}).eq( 0 );

		return position === "fixed" || !scrollParent.length ? $( this[ 0 ].ownerDocument || document ) : scrollParent;
	},

	uniqueId: (function() {
		var uuid = 0;

		return function() {
			return this.each(function() {
				if ( !this.id ) {
					this.id = "ui-id-" + ( ++uuid );
				}
			});
		};
	})(),

	removeUniqueId: function() {
		return this.each(function() {
			if ( /^ui-id-\d+$/.test( this.id ) ) {
				$( this ).removeAttr( "id" );
			}
		});
	}
});

// selectors
function focusable( element, isTabIndexNotNaN ) {
	var map, mapName, img,
		nodeName = element.nodeName.toLowerCase();
	if ( "area" === nodeName ) {
		map = element.parentNode;
		mapName = map.name;
		if ( !element.href || !mapName || map.nodeName.toLowerCase() !== "map" ) {
			return false;
		}
		img = $( "img[usemap='#" + mapName + "']" )[ 0 ];
		return !!img && visible( img );
	}
	return ( /^(input|select|textarea|button|object)$/.test( nodeName ) ?
		!element.disabled :
		"a" === nodeName ?
			element.href || isTabIndexNotNaN :
			isTabIndexNotNaN) &&
		// the element and all of its ancestors must be visible
		visible( element );
}

function visible( element ) {
	return $.expr.filters.visible( element ) &&
		!$( element ).parents().addBack().filter(function() {
			return $.css( this, "visibility" ) === "hidden";
		}).length;
}

$.extend( $.expr[ ":" ], {
	data: $.expr.createPseudo ?
		$.expr.createPseudo(function( dataName ) {
			return function( elem ) {
				return !!$.data( elem, dataName );
			};
		}) :
		// support: jQuery <1.8
		function( elem, i, match ) {
			return !!$.data( elem, match[ 3 ] );
		},

	focusable: function( element ) {
		return focusable( element, !isNaN( $.attr( element, "tabindex" ) ) );
	},

	tabbable: function( element ) {
		var tabIndex = $.attr( element, "tabindex" ),
			isTabIndexNaN = isNaN( tabIndex );
		return ( isTabIndexNaN || tabIndex >= 0 ) && focusable( element, !isTabIndexNaN );
	}
});

// support: jQuery <1.8
if ( !$( "<a>" ).outerWidth( 1 ).jquery ) {
	$.each( [ "Width", "Height" ], function( i, name ) {
		var side = name === "Width" ? [ "Left", "Right" ] : [ "Top", "Bottom" ],
			type = name.toLowerCase(),
			orig = {
				innerWidth: $.fn.innerWidth,
				innerHeight: $.fn.innerHeight,
				outerWidth: $.fn.outerWidth,
				outerHeight: $.fn.outerHeight
			};

		function reduce( elem, size, border, margin ) {
			$.each( side, function() {
				size -= parseFloat( $.css( elem, "padding" + this ) ) || 0;
				if ( border ) {
					size -= parseFloat( $.css( elem, "border" + this + "Width" ) ) || 0;
				}
				if ( margin ) {
					size -= parseFloat( $.css( elem, "margin" + this ) ) || 0;
				}
			});
			return size;
		}

		$.fn[ "inner" + name ] = function( size ) {
			if ( size === undefined ) {
				return orig[ "inner" + name ].call( this );
			}

			return this.each(function() {
				$( this ).css( type, reduce( this, size ) + "px" );
			});
		};

		$.fn[ "outer" + name] = function( size, margin ) {
			if ( typeof size !== "number" ) {
				return orig[ "outer" + name ].call( this, size );
			}

			return this.each(function() {
				$( this).css( type, reduce( this, size, true, margin ) + "px" );
			});
		};
	});
}

// support: jQuery <1.8
if ( !$.fn.addBack ) {
	$.fn.addBack = function( selector ) {
		return this.add( selector == null ?
			this.prevObject : this.prevObject.filter( selector )
		);
	};
}

// support: jQuery 1.6.1, 1.6.2 (http://bugs.jquery.com/ticket/9413)
if ( $( "<a>" ).data( "a-b", "a" ).removeData( "a-b" ).data( "a-b" ) ) {
	$.fn.removeData = (function( removeData ) {
		return function( key ) {
			if ( arguments.length ) {
				return removeData.call( this, $.camelCase( key ) );
			} else {
				return removeData.call( this );
			}
		};
	})( $.fn.removeData );
}

// deprecated
$.ui.ie = !!/msie [\w.]+/.exec( navigator.userAgent.toLowerCase() );

$.fn.extend({
	focus: (function( orig ) {
		return function( delay, fn ) {
			return typeof delay === "number" ?
				this.each(function() {
					var elem = this;
					setTimeout(function() {
						$( elem ).focus();
						if ( fn ) {
							fn.call( elem );
						}
					}, delay );
				}) :
				orig.apply( this, arguments );
		};
	})( $.fn.focus ),

	disableSelection: (function() {
		var eventType = "onselectstart" in document.createElement( "div" ) ?
			"selectstart" :
			"mousedown";

		return function() {
			return this.bind( eventType + ".ui-disableSelection", function( event ) {
				event.preventDefault();
			});
		};
	})(),

	enableSelection: function() {
		return this.unbind( ".ui-disableSelection" );
	},

	zIndex: function( zIndex ) {
		if ( zIndex !== undefined ) {
			return this.css( "zIndex", zIndex );
		}

		if ( this.length ) {
			var elem = $( this[ 0 ] ), position, value;
			while ( elem.length && elem[ 0 ] !== document ) {
				// Ignore z-index if position is set to a value where z-index is ignored by the browser
				// This makes behavior of this function consistent across browsers
				// WebKit always returns auto if the element is positioned
				position = elem.css( "position" );
				if ( position === "absolute" || position === "relative" || position === "fixed" ) {
					// IE returns 0 when zIndex is not specified
					// other browsers return a string
					// we ignore the case of nested elements with an explicit value of 0
					// <div style="z-index: -10;"><div style="z-index: 0;"></div></div>
					value = parseInt( elem.css( "zIndex" ), 10 );
					if ( !isNaN( value ) && value !== 0 ) {
						return value;
					}
				}
				elem = elem.parent();
			}
		}

		return 0;
	}
});

// $.ui.plugin is deprecated. Use $.widget() extensions instead.
$.ui.plugin = {
	add: function( module, option, set ) {
		var i,
			proto = $.ui[ module ].prototype;
		for ( i in set ) {
			proto.plugins[ i ] = proto.plugins[ i ] || [];
			proto.plugins[ i ].push( [ option, set[ i ] ] );
		}
	},
	call: function( instance, name, args, allowDisconnected ) {
		var i,
			set = instance.plugins[ name ];

		if ( !set ) {
			return;
		}

		if ( !allowDisconnected && ( !instance.element[ 0 ].parentNode || instance.element[ 0 ].parentNode.nodeType === 11 ) ) {
			return;
		}

		for ( i = 0; i < set.length; i++ ) {
			if ( instance.options[ set[ i ][ 0 ] ] ) {
				set[ i ][ 1 ].apply( instance.element, args );
			}
		}
	}
};


/*!
 * jQuery UI Widget 1.11.3
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/jQuery.widget/
 */


var widget_uuid = 0,
	widget_slice = Array.prototype.slice;

$.cleanData = (function( orig ) {
	return function( elems ) {
		var events, elem, i;
		for ( i = 0; (elem = elems[i]) != null; i++ ) {
			try {

				// Only trigger remove when necessary to save time
				events = $._data( elem, "events" );
				if ( events && events.remove ) {
					$( elem ).triggerHandler( "remove" );
				}

			// http://bugs.jquery.com/ticket/8235
			} catch ( e ) {}
		}
		orig( elems );
	};
})( $.cleanData );

$.widget = function( name, base, prototype ) {
	var fullName, existingConstructor, constructor, basePrototype,
		// proxiedPrototype allows the provided prototype to remain unmodified
		// so that it can be used as a mixin for multiple widgets (#8876)
		proxiedPrototype = {},
		namespace = name.split( "." )[ 0 ];

	name = name.split( "." )[ 1 ];
	fullName = namespace + "-" + name;

	if ( !prototype ) {
		prototype = base;
		base = $.Widget;
	}

	// create selector for plugin
	$.expr[ ":" ][ fullName.toLowerCase() ] = function( elem ) {
		return !!$.data( elem, fullName );
	};

	$[ namespace ] = $[ namespace ] || {};
	existingConstructor = $[ namespace ][ name ];
	constructor = $[ namespace ][ name ] = function( options, element ) {
		// allow instantiation without "new" keyword
		if ( !this._createWidget ) {
			return new constructor( options, element );
		}

		// allow instantiation without initializing for simple inheritance
		// must use "new" keyword (the code above always passes args)
		if ( arguments.length ) {
			this._createWidget( options, element );
		}
	};
	// extend with the existing constructor to carry over any static properties
	$.extend( constructor, existingConstructor, {
		version: prototype.version,
		// copy the object used to create the prototype in case we need to
		// redefine the widget later
		_proto: $.extend( {}, prototype ),
		// track widgets that inherit from this widget in case this widget is
		// redefined after a widget inherits from it
		_childConstructors: []
	});

	basePrototype = new base();
	// we need to make the options hash a property directly on the new instance
	// otherwise we'll modify the options hash on the prototype that we're
	// inheriting from
	basePrototype.options = $.widget.extend( {}, basePrototype.options );
	$.each( prototype, function( prop, value ) {
		if ( !$.isFunction( value ) ) {
			proxiedPrototype[ prop ] = value;
			return;
		}
		proxiedPrototype[ prop ] = (function() {
			var _super = function() {
					return base.prototype[ prop ].apply( this, arguments );
				},
				_superApply = function( args ) {
					return base.prototype[ prop ].apply( this, args );
				};
			return function() {
				var __super = this._super,
					__superApply = this._superApply,
					returnValue;

				this._super = _super;
				this._superApply = _superApply;

				returnValue = value.apply( this, arguments );

				this._super = __super;
				this._superApply = __superApply;

				return returnValue;
			};
		})();
	});
	constructor.prototype = $.widget.extend( basePrototype, {
		// TODO: remove support for widgetEventPrefix
		// always use the name + a colon as the prefix, e.g., draggable:start
		// don't prefix for widgets that aren't DOM-based
		widgetEventPrefix: existingConstructor ? (basePrototype.widgetEventPrefix || name) : name
	}, proxiedPrototype, {
		constructor: constructor,
		namespace: namespace,
		widgetName: name,
		widgetFullName: fullName
	});

	// If this widget is being redefined then we need to find all widgets that
	// are inheriting from it and redefine all of them so that they inherit from
	// the new version of this widget. We're essentially trying to replace one
	// level in the prototype chain.
	if ( existingConstructor ) {
		$.each( existingConstructor._childConstructors, function( i, child ) {
			var childPrototype = child.prototype;

			// redefine the child widget using the same prototype that was
			// originally used, but inherit from the new version of the base
			$.widget( childPrototype.namespace + "." + childPrototype.widgetName, constructor, child._proto );
		});
		// remove the list of existing child constructors from the old constructor
		// so the old child constructors can be garbage collected
		delete existingConstructor._childConstructors;
	} else {
		base._childConstructors.push( constructor );
	}

	$.widget.bridge( name, constructor );

	return constructor;
};

$.widget.extend = function( target ) {
	var input = widget_slice.call( arguments, 1 ),
		inputIndex = 0,
		inputLength = input.length,
		key,
		value;
	for ( ; inputIndex < inputLength; inputIndex++ ) {
		for ( key in input[ inputIndex ] ) {
			value = input[ inputIndex ][ key ];
			if ( input[ inputIndex ].hasOwnProperty( key ) && value !== undefined ) {
				// Clone objects
				if ( $.isPlainObject( value ) ) {
					target[ key ] = $.isPlainObject( target[ key ] ) ?
						$.widget.extend( {}, target[ key ], value ) :
						// Don't extend strings, arrays, etc. with objects
						$.widget.extend( {}, value );
				// Copy everything else by reference
				} else {
					target[ key ] = value;
				}
			}
		}
	}
	return target;
};

$.widget.bridge = function( name, object ) {
	var fullName = object.prototype.widgetFullName || name;
	$.fn[ name ] = function( options ) {
		var isMethodCall = typeof options === "string",
			args = widget_slice.call( arguments, 1 ),
			returnValue = this;

		if ( isMethodCall ) {
			this.each(function() {
				var methodValue,
					instance = $.data( this, fullName );
				if ( options === "instance" ) {
					returnValue = instance;
					return false;
				}
				if ( !instance ) {
					return $.error( "cannot call methods on " + name + " prior to initialization; " +
						"attempted to call method '" + options + "'" );
				}
				if ( !$.isFunction( instance[options] ) || options.charAt( 0 ) === "_" ) {
					return $.error( "no such method '" + options + "' for " + name + " widget instance" );
				}
				methodValue = instance[ options ].apply( instance, args );
				if ( methodValue !== instance && methodValue !== undefined ) {
					returnValue = methodValue && methodValue.jquery ?
						returnValue.pushStack( methodValue.get() ) :
						methodValue;
					return false;
				}
			});
		} else {

			// Allow multiple hashes to be passed on init
			if ( args.length ) {
				options = $.widget.extend.apply( null, [ options ].concat(args) );
			}

			this.each(function() {
				var instance = $.data( this, fullName );
				if ( instance ) {
					instance.option( options || {} );
					if ( instance._init ) {
						instance._init();
					}
				} else {
					$.data( this, fullName, new object( options, this ) );
				}
			});
		}

		return returnValue;
	};
};

$.Widget = function( /* options, element */ ) {};
$.Widget._childConstructors = [];

$.Widget.prototype = {
	widgetName: "widget",
	widgetEventPrefix: "",
	defaultElement: "<div>",
	options: {
		disabled: false,

		// callbacks
		create: null
	},
	_createWidget: function( options, element ) {
		element = $( element || this.defaultElement || this )[ 0 ];
		this.element = $( element );
		this.uuid = widget_uuid++;
		this.eventNamespace = "." + this.widgetName + this.uuid;

		this.bindings = $();
		this.hoverable = $();
		this.focusable = $();

		if ( element !== this ) {
			$.data( element, this.widgetFullName, this );
			this._on( true, this.element, {
				remove: function( event ) {
					if ( event.target === element ) {
						this.destroy();
					}
				}
			});
			this.document = $( element.style ?
				// element within the document
				element.ownerDocument :
				// element is window or document
				element.document || element );
			this.window = $( this.document[0].defaultView || this.document[0].parentWindow );
		}

		this.options = $.widget.extend( {},
			this.options,
			this._getCreateOptions(),
			options );

		this._create();
		this._trigger( "create", null, this._getCreateEventData() );
		this._init();
	},
	_getCreateOptions: $.noop,
	_getCreateEventData: $.noop,
	_create: $.noop,
	_init: $.noop,

	destroy: function() {
		this._destroy();
		// we can probably remove the unbind calls in 2.0
		// all event bindings should go through this._on()
		this.element
			.unbind( this.eventNamespace )
			.removeData( this.widgetFullName )
			// support: jquery <1.6.3
			// http://bugs.jquery.com/ticket/9413
			.removeData( $.camelCase( this.widgetFullName ) );
		this.widget()
			.unbind( this.eventNamespace )
			.removeAttr( "aria-disabled" )
			.removeClass(
				this.widgetFullName + "-disabled " +
				"ui-state-disabled" );

		// clean up events and states
		this.bindings.unbind( this.eventNamespace );
		this.hoverable.removeClass( "ui-state-hover" );
		this.focusable.removeClass( "ui-state-focus" );
	},
	_destroy: $.noop,

	widget: function() {
		return this.element;
	},

	option: function( key, value ) {
		var options = key,
			parts,
			curOption,
			i;

		if ( arguments.length === 0 ) {
			// don't return a reference to the internal hash
			return $.widget.extend( {}, this.options );
		}

		if ( typeof key === "string" ) {
			// handle nested keys, e.g., "foo.bar" => { foo: { bar: ___ } }
			options = {};
			parts = key.split( "." );
			key = parts.shift();
			if ( parts.length ) {
				curOption = options[ key ] = $.widget.extend( {}, this.options[ key ] );
				for ( i = 0; i < parts.length - 1; i++ ) {
					curOption[ parts[ i ] ] = curOption[ parts[ i ] ] || {};
					curOption = curOption[ parts[ i ] ];
				}
				key = parts.pop();
				if ( arguments.length === 1 ) {
					return curOption[ key ] === undefined ? null : curOption[ key ];
				}
				curOption[ key ] = value;
			} else {
				if ( arguments.length === 1 ) {
					return this.options[ key ] === undefined ? null : this.options[ key ];
				}
				options[ key ] = value;
			}
		}

		this._setOptions( options );

		return this;
	},
	_setOptions: function( options ) {
		var key;

		for ( key in options ) {
			this._setOption( key, options[ key ] );
		}

		return this;
	},
	_setOption: function( key, value ) {
		this.options[ key ] = value;

		if ( key === "disabled" ) {
			this.widget()
				.toggleClass( this.widgetFullName + "-disabled", !!value );

			// If the widget is becoming disabled, then nothing is interactive
			if ( value ) {
				this.hoverable.removeClass( "ui-state-hover" );
				this.focusable.removeClass( "ui-state-focus" );
			}
		}

		return this;
	},

	enable: function() {
		return this._setOptions({ disabled: false });
	},
	disable: function() {
		return this._setOptions({ disabled: true });
	},

	_on: function( suppressDisabledCheck, element, handlers ) {
		var delegateElement,
			instance = this;

		// no suppressDisabledCheck flag, shuffle arguments
		if ( typeof suppressDisabledCheck !== "boolean" ) {
			handlers = element;
			element = suppressDisabledCheck;
			suppressDisabledCheck = false;
		}

		// no element argument, shuffle and use this.element
		if ( !handlers ) {
			handlers = element;
			element = this.element;
			delegateElement = this.widget();
		} else {
			element = delegateElement = $( element );
			this.bindings = this.bindings.add( element );
		}

		$.each( handlers, function( event, handler ) {
			function handlerProxy() {
				// allow widgets to customize the disabled handling
				// - disabled as an array instead of boolean
				// - disabled class as method for disabling individual parts
				if ( !suppressDisabledCheck &&
						( instance.options.disabled === true ||
							$( this ).hasClass( "ui-state-disabled" ) ) ) {
					return;
				}
				return ( typeof handler === "string" ? instance[ handler ] : handler )
					.apply( instance, arguments );
			}

			// copy the guid so direct unbinding works
			if ( typeof handler !== "string" ) {
				handlerProxy.guid = handler.guid =
					handler.guid || handlerProxy.guid || $.guid++;
			}

			var match = event.match( /^([\w:-]*)\s*(.*)$/ ),
				eventName = match[1] + instance.eventNamespace,
				selector = match[2];
			if ( selector ) {
				delegateElement.delegate( selector, eventName, handlerProxy );
			} else {
				element.bind( eventName, handlerProxy );
			}
		});
	},

	_off: function( element, eventName ) {
		eventName = (eventName || "").split( " " ).join( this.eventNamespace + " " ) +
			this.eventNamespace;
		element.unbind( eventName ).undelegate( eventName );

		// Clear the stack to avoid memory leaks (#10056)
		this.bindings = $( this.bindings.not( element ).get() );
		this.focusable = $( this.focusable.not( element ).get() );
		this.hoverable = $( this.hoverable.not( element ).get() );
	},

	_delay: function( handler, delay ) {
		function handlerProxy() {
			return ( typeof handler === "string" ? instance[ handler ] : handler )
				.apply( instance, arguments );
		}
		var instance = this;
		return setTimeout( handlerProxy, delay || 0 );
	},

	_hoverable: function( element ) {
		this.hoverable = this.hoverable.add( element );
		this._on( element, {
			mouseenter: function( event ) {
				$( event.currentTarget ).addClass( "ui-state-hover" );
			},
			mouseleave: function( event ) {
				$( event.currentTarget ).removeClass( "ui-state-hover" );
			}
		});
	},

	_focusable: function( element ) {
		this.focusable = this.focusable.add( element );
		this._on( element, {
			focusin: function( event ) {
				$( event.currentTarget ).addClass( "ui-state-focus" );
			},
			focusout: function( event ) {
				$( event.currentTarget ).removeClass( "ui-state-focus" );
			}
		});
	},

	_trigger: function( type, event, data ) {
		var prop, orig,
			callback = this.options[ type ];

		data = data || {};
		event = $.Event( event );
		event.type = ( type === this.widgetEventPrefix ?
			type :
			this.widgetEventPrefix + type ).toLowerCase();
		// the original event may come from any element
		// so we need to reset the target on the new event
		event.target = this.element[ 0 ];

		// copy original event properties over to the new event
		orig = event.originalEvent;
		if ( orig ) {
			for ( prop in orig ) {
				if ( !( prop in event ) ) {
					event[ prop ] = orig[ prop ];
				}
			}
		}

		this.element.trigger( event, data );
		return !( $.isFunction( callback ) &&
			callback.apply( this.element[0], [ event ].concat( data ) ) === false ||
			event.isDefaultPrevented() );
	}
};

$.each( { show: "fadeIn", hide: "fadeOut" }, function( method, defaultEffect ) {
	$.Widget.prototype[ "_" + method ] = function( element, options, callback ) {
		if ( typeof options === "string" ) {
			options = { effect: options };
		}
		var hasOptions,
			effectName = !options ?
				method :
				options === true || typeof options === "number" ?
					defaultEffect :
					options.effect || defaultEffect;
		options = options || {};
		if ( typeof options === "number" ) {
			options = { duration: options };
		}
		hasOptions = !$.isEmptyObject( options );
		options.complete = callback;
		if ( options.delay ) {
			element.delay( options.delay );
		}
		if ( hasOptions && $.effects && $.effects.effect[ effectName ] ) {
			element[ method ]( options );
		} else if ( effectName !== method && element[ effectName ] ) {
			element[ effectName ]( options.duration, options.easing, callback );
		} else {
			element.queue(function( next ) {
				$( this )[ method ]();
				if ( callback ) {
					callback.call( element[ 0 ] );
				}
				next();
			});
		}
	};
});

var widget = $.widget;


/*!
 * jQuery UI Mouse 1.11.3
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/mouse/
 */


var mouseHandled = false;
$( document ).mouseup( function() {
	mouseHandled = false;
});

var mouse = $.widget("ui.mouse", {
	version: "1.11.3",
	options: {
		cancel: "input,textarea,button,select,option",
		distance: 1,
		delay: 0
	},
	_mouseInit: function() {
		var that = this;

		this.element
			.bind("mousedown." + this.widgetName, function(event) {
				return that._mouseDown(event);
			})
			.bind("click." + this.widgetName, function(event) {
				if (true === $.data(event.target, that.widgetName + ".preventClickEvent")) {
					$.removeData(event.target, that.widgetName + ".preventClickEvent");
					event.stopImmediatePropagation();
					return false;
				}
			});

		this.started = false;
	},

	// TODO: make sure destroying one instance of mouse doesn't mess with
	// other instances of mouse
	_mouseDestroy: function() {
		this.element.unbind("." + this.widgetName);
		if ( this._mouseMoveDelegate ) {
			this.document
				.unbind("mousemove." + this.widgetName, this._mouseMoveDelegate)
				.unbind("mouseup." + this.widgetName, this._mouseUpDelegate);
		}
	},

	_mouseDown: function(event) {
		// don't let more than one widget handle mouseStart
		if ( mouseHandled ) {
			return;
		}

		this._mouseMoved = false;

		// we may have missed mouseup (out of window)
		(this._mouseStarted && this._mouseUp(event));

		this._mouseDownEvent = event;

		var that = this,
			btnIsLeft = (event.which === 1),
			// event.target.nodeName works around a bug in IE 8 with
			// disabled inputs (#7620)
			elIsCancel = (typeof this.options.cancel === "string" && event.target.nodeName ? $(event.target).closest(this.options.cancel).length : false);
		if (!btnIsLeft || elIsCancel || !this._mouseCapture(event)) {
			return true;
		}

		this.mouseDelayMet = !this.options.delay;
		if (!this.mouseDelayMet) {
			this._mouseDelayTimer = setTimeout(function() {
				that.mouseDelayMet = true;
			}, this.options.delay);
		}

		if (this._mouseDistanceMet(event) && this._mouseDelayMet(event)) {
			this._mouseStarted = (this._mouseStart(event) !== false);
			if (!this._mouseStarted) {
				event.preventDefault();
				return true;
			}
		}

		// Click event may never have fired (Gecko & Opera)
		if (true === $.data(event.target, this.widgetName + ".preventClickEvent")) {
			$.removeData(event.target, this.widgetName + ".preventClickEvent");
		}

		// these delegates are required to keep context
		this._mouseMoveDelegate = function(event) {
			return that._mouseMove(event);
		};
		this._mouseUpDelegate = function(event) {
			return that._mouseUp(event);
		};

		this.document
			.bind( "mousemove." + this.widgetName, this._mouseMoveDelegate )
			.bind( "mouseup." + this.widgetName, this._mouseUpDelegate );

		event.preventDefault();

		mouseHandled = true;
		return true;
	},

	_mouseMove: function(event) {
		// Only check for mouseups outside the document if you've moved inside the document
		// at least once. This prevents the firing of mouseup in the case of IE<9, which will
		// fire a mousemove event if content is placed under the cursor. See #7778
		// Support: IE <9
		if ( this._mouseMoved ) {
			// IE mouseup check - mouseup happened when mouse was out of window
			if ($.ui.ie && ( !document.documentMode || document.documentMode < 9 ) && !event.button) {
				return this._mouseUp(event);

			// Iframe mouseup check - mouseup occurred in another document
			} else if ( !event.which ) {
				return this._mouseUp( event );
			}
		}

		if ( event.which || event.button ) {
			this._mouseMoved = true;
		}

		if (this._mouseStarted) {
			this._mouseDrag(event);
			return event.preventDefault();
		}

		if (this._mouseDistanceMet(event) && this._mouseDelayMet(event)) {
			this._mouseStarted =
				(this._mouseStart(this._mouseDownEvent, event) !== false);
			(this._mouseStarted ? this._mouseDrag(event) : this._mouseUp(event));
		}

		return !this._mouseStarted;
	},

	_mouseUp: function(event) {
		this.document
			.unbind( "mousemove." + this.widgetName, this._mouseMoveDelegate )
			.unbind( "mouseup." + this.widgetName, this._mouseUpDelegate );

		if (this._mouseStarted) {
			this._mouseStarted = false;

			if (event.target === this._mouseDownEvent.target) {
				$.data(event.target, this.widgetName + ".preventClickEvent", true);
			}

			this._mouseStop(event);
		}

		mouseHandled = false;
		return false;
	},

	_mouseDistanceMet: function(event) {
		return (Math.max(
				Math.abs(this._mouseDownEvent.pageX - event.pageX),
				Math.abs(this._mouseDownEvent.pageY - event.pageY)
			) >= this.options.distance
		);
	},

	_mouseDelayMet: function(/* event */) {
		return this.mouseDelayMet;
	},

	// These are placeholder methods, to be overriden by extending plugin
	_mouseStart: function(/* event */) {},
	_mouseDrag: function(/* event */) {},
	_mouseStop: function(/* event */) {},
	_mouseCapture: function(/* event */) { return true; }
});


/*!
 * jQuery UI Position 1.11.3
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/position/
 */

(function() {

$.ui = $.ui || {};

var cachedScrollbarWidth, supportsOffsetFractions,
	max = Math.max,
	abs = Math.abs,
	round = Math.round,
	rhorizontal = /left|center|right/,
	rvertical = /top|center|bottom/,
	roffset = /[\+\-]\d+(\.[\d]+)?%?/,
	rposition = /^\w+/,
	rpercent = /%$/,
	_position = $.fn.position;

function getOffsets( offsets, width, height ) {
	return [
		parseFloat( offsets[ 0 ] ) * ( rpercent.test( offsets[ 0 ] ) ? width / 100 : 1 ),
		parseFloat( offsets[ 1 ] ) * ( rpercent.test( offsets[ 1 ] ) ? height / 100 : 1 )
	];
}

function parseCss( element, property ) {
	return parseInt( $.css( element, property ), 10 ) || 0;
}

function getDimensions( elem ) {
	var raw = elem[0];
	if ( raw.nodeType === 9 ) {
		return {
			width: elem.width(),
			height: elem.height(),
			offset: { top: 0, left: 0 }
		};
	}
	if ( $.isWindow( raw ) ) {
		return {
			width: elem.width(),
			height: elem.height(),
			offset: { top: elem.scrollTop(), left: elem.scrollLeft() }
		};
	}
	if ( raw.preventDefault ) {
		return {
			width: 0,
			height: 0,
			offset: { top: raw.pageY, left: raw.pageX }
		};
	}
	return {
		width: elem.outerWidth(),
		height: elem.outerHeight(),
		offset: elem.offset()
	};
}

$.position = {
	scrollbarWidth: function() {
		if ( cachedScrollbarWidth !== undefined ) {
			return cachedScrollbarWidth;
		}
		var w1, w2,
			div = $( "<div style='display:block;position:absolute;width:50px;height:50px;overflow:hidden;'><div style='height:100px;width:auto;'></div></div>" ),
			innerDiv = div.children()[0];

		$( "body" ).append( div );
		w1 = innerDiv.offsetWidth;
		div.css( "overflow", "scroll" );

		w2 = innerDiv.offsetWidth;

		if ( w1 === w2 ) {
			w2 = div[0].clientWidth;
		}

		div.remove();

		return (cachedScrollbarWidth = w1 - w2);
	},
	getScrollInfo: function( within ) {
		var overflowX = within.isWindow || within.isDocument ? "" :
				within.element.css( "overflow-x" ),
			overflowY = within.isWindow || within.isDocument ? "" :
				within.element.css( "overflow-y" ),
			hasOverflowX = overflowX === "scroll" ||
				( overflowX === "auto" && within.width < within.element[0].scrollWidth ),
			hasOverflowY = overflowY === "scroll" ||
				( overflowY === "auto" && within.height < within.element[0].scrollHeight );
		return {
			width: hasOverflowY ? $.position.scrollbarWidth() : 0,
			height: hasOverflowX ? $.position.scrollbarWidth() : 0
		};
	},
	getWithinInfo: function( element ) {
		var withinElement = $( element || window ),
			isWindow = $.isWindow( withinElement[0] ),
			isDocument = !!withinElement[ 0 ] && withinElement[ 0 ].nodeType === 9;
		return {
			element: withinElement,
			isWindow: isWindow,
			isDocument: isDocument,
			offset: withinElement.offset() || { left: 0, top: 0 },
			scrollLeft: withinElement.scrollLeft(),
			scrollTop: withinElement.scrollTop(),

			// support: jQuery 1.6.x
			// jQuery 1.6 doesn't support .outerWidth/Height() on documents or windows
			width: isWindow || isDocument ? withinElement.width() : withinElement.outerWidth(),
			height: isWindow || isDocument ? withinElement.height() : withinElement.outerHeight()
		};
	}
};

$.fn.position = function( options ) {
	if ( !options || !options.of ) {
		return _position.apply( this, arguments );
	}

	// make a copy, we don't want to modify arguments
	options = $.extend( {}, options );

	var atOffset, targetWidth, targetHeight, targetOffset, basePosition, dimensions,
		target = $( options.of ),
		within = $.position.getWithinInfo( options.within ),
		scrollInfo = $.position.getScrollInfo( within ),
		collision = ( options.collision || "flip" ).split( " " ),
		offsets = {};

	dimensions = getDimensions( target );
	if ( target[0].preventDefault ) {
		// force left top to allow flipping
		options.at = "left top";
	}
	targetWidth = dimensions.width;
	targetHeight = dimensions.height;
	targetOffset = dimensions.offset;
	// clone to reuse original targetOffset later
	basePosition = $.extend( {}, targetOffset );

	// force my and at to have valid horizontal and vertical positions
	// if a value is missing or invalid, it will be converted to center
	$.each( [ "my", "at" ], function() {
		var pos = ( options[ this ] || "" ).split( " " ),
			horizontalOffset,
			verticalOffset;

		if ( pos.length === 1) {
			pos = rhorizontal.test( pos[ 0 ] ) ?
				pos.concat( [ "center" ] ) :
				rvertical.test( pos[ 0 ] ) ?
					[ "center" ].concat( pos ) :
					[ "center", "center" ];
		}
		pos[ 0 ] = rhorizontal.test( pos[ 0 ] ) ? pos[ 0 ] : "center";
		pos[ 1 ] = rvertical.test( pos[ 1 ] ) ? pos[ 1 ] : "center";

		// calculate offsets
		horizontalOffset = roffset.exec( pos[ 0 ] );
		verticalOffset = roffset.exec( pos[ 1 ] );
		offsets[ this ] = [
			horizontalOffset ? horizontalOffset[ 0 ] : 0,
			verticalOffset ? verticalOffset[ 0 ] : 0
		];

		// reduce to just the positions without the offsets
		options[ this ] = [
			rposition.exec( pos[ 0 ] )[ 0 ],
			rposition.exec( pos[ 1 ] )[ 0 ]
		];
	});

	// normalize collision option
	if ( collision.length === 1 ) {
		collision[ 1 ] = collision[ 0 ];
	}

	if ( options.at[ 0 ] === "right" ) {
		basePosition.left += targetWidth;
	} else if ( options.at[ 0 ] === "center" ) {
		basePosition.left += targetWidth / 2;
	}

	if ( options.at[ 1 ] === "bottom" ) {
		basePosition.top += targetHeight;
	} else if ( options.at[ 1 ] === "center" ) {
		basePosition.top += targetHeight / 2;
	}

	atOffset = getOffsets( offsets.at, targetWidth, targetHeight );
	basePosition.left += atOffset[ 0 ];
	basePosition.top += atOffset[ 1 ];

	return this.each(function() {
		var collisionPosition, using,
			elem = $( this ),
			elemWidth = elem.outerWidth(),
			elemHeight = elem.outerHeight(),
			marginLeft = parseCss( this, "marginLeft" ),
			marginTop = parseCss( this, "marginTop" ),
			collisionWidth = elemWidth + marginLeft + parseCss( this, "marginRight" ) + scrollInfo.width,
			collisionHeight = elemHeight + marginTop + parseCss( this, "marginBottom" ) + scrollInfo.height,
			position = $.extend( {}, basePosition ),
			myOffset = getOffsets( offsets.my, elem.outerWidth(), elem.outerHeight() );

		if ( options.my[ 0 ] === "right" ) {
			position.left -= elemWidth;
		} else if ( options.my[ 0 ] === "center" ) {
			position.left -= elemWidth / 2;
		}

		if ( options.my[ 1 ] === "bottom" ) {
			position.top -= elemHeight;
		} else if ( options.my[ 1 ] === "center" ) {
			position.top -= elemHeight / 2;
		}

		position.left += myOffset[ 0 ];
		position.top += myOffset[ 1 ];

		// if the browser doesn't support fractions, then round for consistent results
		if ( !supportsOffsetFractions ) {
			position.left = round( position.left );
			position.top = round( position.top );
		}

		collisionPosition = {
			marginLeft: marginLeft,
			marginTop: marginTop
		};

		$.each( [ "left", "top" ], function( i, dir ) {
			if ( $.ui.position[ collision[ i ] ] ) {
				$.ui.position[ collision[ i ] ][ dir ]( position, {
					targetWidth: targetWidth,
					targetHeight: targetHeight,
					elemWidth: elemWidth,
					elemHeight: elemHeight,
					collisionPosition: collisionPosition,
					collisionWidth: collisionWidth,
					collisionHeight: collisionHeight,
					offset: [ atOffset[ 0 ] + myOffset[ 0 ], atOffset [ 1 ] + myOffset[ 1 ] ],
					my: options.my,
					at: options.at,
					within: within,
					elem: elem
				});
			}
		});

		if ( options.using ) {
			// adds feedback as second argument to using callback, if present
			using = function( props ) {
				var left = targetOffset.left - position.left,
					right = left + targetWidth - elemWidth,
					top = targetOffset.top - position.top,
					bottom = top + targetHeight - elemHeight,
					feedback = {
						target: {
							element: target,
							left: targetOffset.left,
							top: targetOffset.top,
							width: targetWidth,
							height: targetHeight
						},
						element: {
							element: elem,
							left: position.left,
							top: position.top,
							width: elemWidth,
							height: elemHeight
						},
						horizontal: right < 0 ? "left" : left > 0 ? "right" : "center",
						vertical: bottom < 0 ? "top" : top > 0 ? "bottom" : "middle"
					};
				if ( targetWidth < elemWidth && abs( left + right ) < targetWidth ) {
					feedback.horizontal = "center";
				}
				if ( targetHeight < elemHeight && abs( top + bottom ) < targetHeight ) {
					feedback.vertical = "middle";
				}
				if ( max( abs( left ), abs( right ) ) > max( abs( top ), abs( bottom ) ) ) {
					feedback.important = "horizontal";
				} else {
					feedback.important = "vertical";
				}
				options.using.call( this, props, feedback );
			};
		}

		elem.offset( $.extend( position, { using: using } ) );
	});
};

$.ui.position = {
	fit: {
		left: function( position, data ) {
			var within = data.within,
				withinOffset = within.isWindow ? within.scrollLeft : within.offset.left,
				outerWidth = within.width,
				collisionPosLeft = position.left - data.collisionPosition.marginLeft,
				overLeft = withinOffset - collisionPosLeft,
				overRight = collisionPosLeft + data.collisionWidth - outerWidth - withinOffset,
				newOverRight;

			// element is wider than within
			if ( data.collisionWidth > outerWidth ) {
				// element is initially over the left side of within
				if ( overLeft > 0 && overRight <= 0 ) {
					newOverRight = position.left + overLeft + data.collisionWidth - outerWidth - withinOffset;
					position.left += overLeft - newOverRight;
				// element is initially over right side of within
				} else if ( overRight > 0 && overLeft <= 0 ) {
					position.left = withinOffset;
				// element is initially over both left and right sides of within
				} else {
					if ( overLeft > overRight ) {
						position.left = withinOffset + outerWidth - data.collisionWidth;
					} else {
						position.left = withinOffset;
					}
				}
			// too far left -> align with left edge
			} else if ( overLeft > 0 ) {
				position.left += overLeft;
			// too far right -> align with right edge
			} else if ( overRight > 0 ) {
				position.left -= overRight;
			// adjust based on position and margin
			} else {
				position.left = max( position.left - collisionPosLeft, position.left );
			}
		},
		top: function( position, data ) {
			var within = data.within,
				withinOffset = within.isWindow ? within.scrollTop : within.offset.top,
				outerHeight = data.within.height,
				collisionPosTop = position.top - data.collisionPosition.marginTop,
				overTop = withinOffset - collisionPosTop,
				overBottom = collisionPosTop + data.collisionHeight - outerHeight - withinOffset,
				newOverBottom;

			// element is taller than within
			if ( data.collisionHeight > outerHeight ) {
				// element is initially over the top of within
				if ( overTop > 0 && overBottom <= 0 ) {
					newOverBottom = position.top + overTop + data.collisionHeight - outerHeight - withinOffset;
					position.top += overTop - newOverBottom;
				// element is initially over bottom of within
				} else if ( overBottom > 0 && overTop <= 0 ) {
					position.top = withinOffset;
				// element is initially over both top and bottom of within
				} else {
					if ( overTop > overBottom ) {
						position.top = withinOffset + outerHeight - data.collisionHeight;
					} else {
						position.top = withinOffset;
					}
				}
			// too far up -> align with top
			} else if ( overTop > 0 ) {
				position.top += overTop;
			// too far down -> align with bottom edge
			} else if ( overBottom > 0 ) {
				position.top -= overBottom;
			// adjust based on position and margin
			} else {
				position.top = max( position.top - collisionPosTop, position.top );
			}
		}
	},
	flip: {
		left: function( position, data ) {
			var within = data.within,
				withinOffset = within.offset.left + within.scrollLeft,
				outerWidth = within.width,
				offsetLeft = within.isWindow ? within.scrollLeft : within.offset.left,
				collisionPosLeft = position.left - data.collisionPosition.marginLeft,
				overLeft = collisionPosLeft - offsetLeft,
				overRight = collisionPosLeft + data.collisionWidth - outerWidth - offsetLeft,
				myOffset = data.my[ 0 ] === "left" ?
					-data.elemWidth :
					data.my[ 0 ] === "right" ?
						data.elemWidth :
						0,
				atOffset = data.at[ 0 ] === "left" ?
					data.targetWidth :
					data.at[ 0 ] === "right" ?
						-data.targetWidth :
						0,
				offset = -2 * data.offset[ 0 ],
				newOverRight,
				newOverLeft;

			if ( overLeft < 0 ) {
				newOverRight = position.left + myOffset + atOffset + offset + data.collisionWidth - outerWidth - withinOffset;
				if ( newOverRight < 0 || newOverRight < abs( overLeft ) ) {
					position.left += myOffset + atOffset + offset;
				}
			} else if ( overRight > 0 ) {
				newOverLeft = position.left - data.collisionPosition.marginLeft + myOffset + atOffset + offset - offsetLeft;
				if ( newOverLeft > 0 || abs( newOverLeft ) < overRight ) {
					position.left += myOffset + atOffset + offset;
				}
			}
		},
		top: function( position, data ) {
			var within = data.within,
				withinOffset = within.offset.top + within.scrollTop,
				outerHeight = within.height,
				offsetTop = within.isWindow ? within.scrollTop : within.offset.top,
				collisionPosTop = position.top - data.collisionPosition.marginTop,
				overTop = collisionPosTop - offsetTop,
				overBottom = collisionPosTop + data.collisionHeight - outerHeight - offsetTop,
				top = data.my[ 1 ] === "top",
				myOffset = top ?
					-data.elemHeight :
					data.my[ 1 ] === "bottom" ?
						data.elemHeight :
						0,
				atOffset = data.at[ 1 ] === "top" ?
					data.targetHeight :
					data.at[ 1 ] === "bottom" ?
						-data.targetHeight :
						0,
				offset = -2 * data.offset[ 1 ],
				newOverTop,
				newOverBottom;
			if ( overTop < 0 ) {
				newOverBottom = position.top + myOffset + atOffset + offset + data.collisionHeight - outerHeight - withinOffset;
				if ( newOverBottom < 0 || newOverBottom < abs( overTop ) ) {
					position.top += myOffset + atOffset + offset;
				}
			} else if ( overBottom > 0 ) {
				newOverTop = position.top - data.collisionPosition.marginTop + myOffset + atOffset + offset - offsetTop;
				if ( newOverTop > 0 || abs( newOverTop ) < overBottom ) {
					position.top += myOffset + atOffset + offset;
				}
			}
		}
	},
	flipfit: {
		left: function() {
			$.ui.position.flip.left.apply( this, arguments );
			$.ui.position.fit.left.apply( this, arguments );
		},
		top: function() {
			$.ui.position.flip.top.apply( this, arguments );
			$.ui.position.fit.top.apply( this, arguments );
		}
	}
};

// fraction support test
(function() {
	var testElement, testElementParent, testElementStyle, offsetLeft, i,
		body = document.getElementsByTagName( "body" )[ 0 ],
		div = document.createElement( "div" );

	//Create a "fake body" for testing based on method used in jQuery.support
	testElement = document.createElement( body ? "div" : "body" );
	testElementStyle = {
		visibility: "hidden",
		width: 0,
		height: 0,
		border: 0,
		margin: 0,
		background: "none"
	};
	if ( body ) {
		$.extend( testElementStyle, {
			position: "absolute",
			left: "-1000px",
			top: "-1000px"
		});
	}
	for ( i in testElementStyle ) {
		testElement.style[ i ] = testElementStyle[ i ];
	}
	testElement.appendChild( div );
	testElementParent = body || document.documentElement;
	testElementParent.insertBefore( testElement, testElementParent.firstChild );

	div.style.cssText = "position: absolute; left: 10.7432222px;";

	offsetLeft = $( div ).offset().left;
	supportsOffsetFractions = offsetLeft > 10 && offsetLeft < 11;

	testElement.innerHTML = "";
	testElementParent.removeChild( testElement );
})();

})();

var position = $.ui.position;


/*!
 * jQuery UI Sortable 1.11.3
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/sortable/
 */


var sortable = $.widget("ui.sortable", $.ui.mouse, {
	version: "1.11.3",
	widgetEventPrefix: "sort",
	ready: false,
	options: {
		appendTo: "parent",
		axis: false,
		connectWith: false,
		containment: false,
		cursor: "auto",
		cursorAt: false,
		dropOnEmpty: true,
		forcePlaceholderSize: false,
		forceHelperSize: false,
		grid: false,
		handle: false,
		helper: "original",
		items: "> *",
		opacity: false,
		placeholder: false,
		revert: false,
		scroll: true,
		scrollSensitivity: 20,
		scrollSpeed: 20,
		scope: "default",
		tolerance: "intersect",
		zIndex: 1000,

		// callbacks
		activate: null,
		beforeStop: null,
		change: null,
		deactivate: null,
		out: null,
		over: null,
		receive: null,
		remove: null,
		sort: null,
		start: null,
		stop: null,
		update: null
	},

	_isOverAxis: function( x, reference, size ) {
		return ( x >= reference ) && ( x < ( reference + size ) );
	},

	_isFloating: function( item ) {
		return (/left|right/).test(item.css("float")) || (/inline|table-cell/).test(item.css("display"));
	},

	_create: function() {

		var o = this.options;
		this.containerCache = {};
		this.element.addClass("ui-sortable");

		//Get the items
		this.refresh();

		//Let's determine if the items are being displayed horizontally
		this.floating = this.items.length ? o.axis === "x" || this._isFloating(this.items[0].item) : false;

		//Let's determine the parent's offset
		this.offset = this.element.offset();

		//Initialize mouse events for interaction
		this._mouseInit();

		this._setHandleClassName();

		//We're ready to go
		this.ready = true;

	},

	_setOption: function( key, value ) {
		this._super( key, value );

		if ( key === "handle" ) {
			this._setHandleClassName();
		}
	},

	_setHandleClassName: function() {
		this.element.find( ".ui-sortable-handle" ).removeClass( "ui-sortable-handle" );
		$.each( this.items, function() {
			( this.instance.options.handle ?
				this.item.find( this.instance.options.handle ) : this.item )
				.addClass( "ui-sortable-handle" );
		});
	},

	_destroy: function() {
		this.element
			.removeClass( "ui-sortable ui-sortable-disabled" )
			.find( ".ui-sortable-handle" )
				.removeClass( "ui-sortable-handle" );
		this._mouseDestroy();

		for ( var i = this.items.length - 1; i >= 0; i-- ) {
			this.items[i].item.removeData(this.widgetName + "-item");
		}

		return this;
	},

	_mouseCapture: function(event, overrideHandle) {
		var currentItem = null,
			validHandle = false,
			that = this;

		if (this.reverting) {
			return false;
		}

		if(this.options.disabled || this.options.type === "static") {
			return false;
		}

		//We have to refresh the items data once first
		this._refreshItems(event);

		//Find out if the clicked node (or one of its parents) is a actual item in this.items
		$(event.target).parents().each(function() {
			if($.data(this, that.widgetName + "-item") === that) {
				currentItem = $(this);
				return false;
			}
		});
		if($.data(event.target, that.widgetName + "-item") === that) {
			currentItem = $(event.target);
		}

		if(!currentItem) {
			return false;
		}
		if(this.options.handle && !overrideHandle) {
			$(this.options.handle, currentItem).find("*").addBack().each(function() {
				if(this === event.target) {
					validHandle = true;
				}
			});
			if(!validHandle) {
				return false;
			}
		}

		this.currentItem = currentItem;
		this._removeCurrentsFromItems();
		return true;

	},

	_mouseStart: function(event, overrideHandle, noActivation) {

		var i, body,
			o = this.options;

		this.currentContainer = this;

		//We only need to call refreshPositions, because the refreshItems call has been moved to mouseCapture
		this.refreshPositions();

		//Create and append the visible helper
		this.helper = this._createHelper(event);

		//Cache the helper size
		this._cacheHelperProportions();

		/*
		 * - Position generation -
		 * This block generates everything position related - it's the core of draggables.
		 */

		//Cache the margins of the original element
		this._cacheMargins();

		//Get the next scrolling parent
		this.scrollParent = this.helper.scrollParent();

		//The element's absolute position on the page minus margins
		this.offset = this.currentItem.offset();
		this.offset = {
			top: this.offset.top - this.margins.top,
			left: this.offset.left - this.margins.left
		};

		$.extend(this.offset, {
			click: { //Where the click happened, relative to the element
				left: event.pageX - this.offset.left,
				top: event.pageY - this.offset.top
			},
			parent: this._getParentOffset(),
			relative: this._getRelativeOffset() //This is a relative to absolute position minus the actual position calculation - only used for relative positioned helper
		});

		// Only after we got the offset, we can change the helper's position to absolute
		// TODO: Still need to figure out a way to make relative sorting possible
		this.helper.css("position", "absolute");
		this.cssPosition = this.helper.css("position");

		//Generate the original position
		this.originalPosition = this._generatePosition(event);
		this.originalPageX = event.pageX;
		this.originalPageY = event.pageY;

		//Adjust the mouse offset relative to the helper if "cursorAt" is supplied
		(o.cursorAt && this._adjustOffsetFromHelper(o.cursorAt));

		//Cache the former DOM position
		this.domPosition = { prev: this.currentItem.prev()[0], parent: this.currentItem.parent()[0] };

		//If the helper is not the original, hide the original so it's not playing any role during the drag, won't cause anything bad this way
		if(this.helper[0] !== this.currentItem[0]) {
			this.currentItem.hide();
		}

		//Create the placeholder
		this._createPlaceholder();

		//Set a containment if given in the options
		if(o.containment) {
			this._setContainment();
		}

		if( o.cursor && o.cursor !== "auto" ) { // cursor option
			body = this.document.find( "body" );

			// support: IE
			this.storedCursor = body.css( "cursor" );
			body.css( "cursor", o.cursor );

			this.storedStylesheet = $( "<style>*{ cursor: "+o.cursor+" !important; }</style>" ).appendTo( body );
		}

		if(o.opacity) { // opacity option
			if (this.helper.css("opacity")) {
				this._storedOpacity = this.helper.css("opacity");
			}
			this.helper.css("opacity", o.opacity);
		}

		if(o.zIndex) { // zIndex option
			if (this.helper.css("zIndex")) {
				this._storedZIndex = this.helper.css("zIndex");
			}
			this.helper.css("zIndex", o.zIndex);
		}

		//Prepare scrolling
		if(this.scrollParent[0] !== this.document[0] && this.scrollParent[0].tagName !== "HTML") {
			this.overflowOffset = this.scrollParent.offset();
		}

		//Call callbacks
		this._trigger("start", event, this._uiHash());

		//Recache the helper size
		if(!this._preserveHelperProportions) {
			this._cacheHelperProportions();
		}


		//Post "activate" events to possible containers
		if( !noActivation ) {
			for ( i = this.containers.length - 1; i >= 0; i-- ) {
				this.containers[ i ]._trigger( "activate", event, this._uiHash( this ) );
			}
		}

		//Prepare possible droppables
		if($.ui.ddmanager) {
			$.ui.ddmanager.current = this;
		}

		if ($.ui.ddmanager && !o.dropBehaviour) {
			$.ui.ddmanager.prepareOffsets(this, event);
		}

		this.dragging = true;

		this.helper.addClass("ui-sortable-helper");
		this._mouseDrag(event); //Execute the drag once - this causes the helper not to be visible before getting its correct position
		return true;

	},

	_mouseDrag: function(event) {
		var i, item, itemElement, intersection,
			o = this.options,
			scrolled = false;

		//Compute the helpers position
		this.position = this._generatePosition(event);
		this.positionAbs = this._convertPositionTo("absolute");

		if (!this.lastPositionAbs) {
			this.lastPositionAbs = this.positionAbs;
		}

		//Do scrolling
		if(this.options.scroll) {
			if(this.scrollParent[0] !== this.document[0] && this.scrollParent[0].tagName !== "HTML") {

				if((this.overflowOffset.top + this.scrollParent[0].offsetHeight) - event.pageY < o.scrollSensitivity) {
					this.scrollParent[0].scrollTop = scrolled = this.scrollParent[0].scrollTop + o.scrollSpeed;
				} else if(event.pageY - this.overflowOffset.top < o.scrollSensitivity) {
					this.scrollParent[0].scrollTop = scrolled = this.scrollParent[0].scrollTop - o.scrollSpeed;
				}

				if((this.overflowOffset.left + this.scrollParent[0].offsetWidth) - event.pageX < o.scrollSensitivity) {
					this.scrollParent[0].scrollLeft = scrolled = this.scrollParent[0].scrollLeft + o.scrollSpeed;
				} else if(event.pageX - this.overflowOffset.left < o.scrollSensitivity) {
					this.scrollParent[0].scrollLeft = scrolled = this.scrollParent[0].scrollLeft - o.scrollSpeed;
				}

			} else {

				if(event.pageY - this.document.scrollTop() < o.scrollSensitivity) {
					scrolled = this.document.scrollTop(this.document.scrollTop() - o.scrollSpeed);
				} else if(this.window.height() - (event.pageY - this.document.scrollTop()) < o.scrollSensitivity) {
					scrolled = this.document.scrollTop(this.document.scrollTop() + o.scrollSpeed);
				}

				if(event.pageX - this.document.scrollLeft() < o.scrollSensitivity) {
					scrolled = this.document.scrollLeft(this.document.scrollLeft() - o.scrollSpeed);
				} else if(this.window.width() - (event.pageX - this.document.scrollLeft()) < o.scrollSensitivity) {
					scrolled = this.document.scrollLeft(this.document.scrollLeft() + o.scrollSpeed);
				}

			}

			if(scrolled !== false && $.ui.ddmanager && !o.dropBehaviour) {
				$.ui.ddmanager.prepareOffsets(this, event);
			}
		}

		//Regenerate the absolute position used for position checks
		this.positionAbs = this._convertPositionTo("absolute");

		//Set the helper position
		if(!this.options.axis || this.options.axis !== "y") {
			this.helper[0].style.left = this.position.left+"px";
		}
		if(!this.options.axis || this.options.axis !== "x") {
			this.helper[0].style.top = this.position.top+"px";
		}

		//Rearrange
		for (i = this.items.length - 1; i >= 0; i--) {

			//Cache variables and intersection, continue if no intersection
			item = this.items[i];
			itemElement = item.item[0];
			intersection = this._intersectsWithPointer(item);
			if (!intersection) {
				continue;
			}

			// Only put the placeholder inside the current Container, skip all
			// items from other containers. This works because when moving
			// an item from one container to another the
			// currentContainer is switched before the placeholder is moved.
			//
			// Without this, moving items in "sub-sortables" can cause
			// the placeholder to jitter between the outer and inner container.
			if (item.instance !== this.currentContainer) {
				continue;
			}

			// cannot intersect with itself
			// no useless actions that have been done before
			// no action if the item moved is the parent of the item checked
			if (itemElement !== this.currentItem[0] &&
				this.placeholder[intersection === 1 ? "next" : "prev"]()[0] !== itemElement &&
				!$.contains(this.placeholder[0], itemElement) &&
				(this.options.type === "semi-dynamic" ? !$.contains(this.element[0], itemElement) : true)
			) {

				this.direction = intersection === 1 ? "down" : "up";

				if (this.options.tolerance === "pointer" || this._intersectsWithSides(item)) {
					this._rearrange(event, item);
				} else {
					break;
				}

				this._trigger("change", event, this._uiHash());
				break;
			}
		}

		//Post events to containers
		this._contactContainers(event);

		//Interconnect with droppables
		if($.ui.ddmanager) {
			$.ui.ddmanager.drag(this, event);
		}

		//Call callbacks
		this._trigger("sort", event, this._uiHash());

		this.lastPositionAbs = this.positionAbs;
		return false;

	},

	_mouseStop: function(event, noPropagation) {

		if(!event) {
			return;
		}

		//If we are using droppables, inform the manager about the drop
		if ($.ui.ddmanager && !this.options.dropBehaviour) {
			$.ui.ddmanager.drop(this, event);
		}

		if(this.options.revert) {
			var that = this,
				cur = this.placeholder.offset(),
				axis = this.options.axis,
				animation = {};

			if ( !axis || axis === "x" ) {
				animation.left = cur.left - this.offset.parent.left - this.margins.left + (this.offsetParent[0] === this.document[0].body ? 0 : this.offsetParent[0].scrollLeft);
			}
			if ( !axis || axis === "y" ) {
				animation.top = cur.top - this.offset.parent.top - this.margins.top + (this.offsetParent[0] === this.document[0].body ? 0 : this.offsetParent[0].scrollTop);
			}
			this.reverting = true;
			$(this.helper).animate( animation, parseInt(this.options.revert, 10) || 500, function() {
				that._clear(event);
			});
		} else {
			this._clear(event, noPropagation);
		}

		return false;

	},

	cancel: function() {

		if(this.dragging) {

			this._mouseUp({ target: null });

			if(this.options.helper === "original") {
				this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper");
			} else {
				this.currentItem.show();
			}

			//Post deactivating events to containers
			for (var i = this.containers.length - 1; i >= 0; i--){
				this.containers[i]._trigger("deactivate", null, this._uiHash(this));
				if(this.containers[i].containerCache.over) {
					this.containers[i]._trigger("out", null, this._uiHash(this));
					this.containers[i].containerCache.over = 0;
				}
			}

		}

		if (this.placeholder) {
			//$(this.placeholder[0]).remove(); would have been the jQuery way - unfortunately, it unbinds ALL events from the original node!
			if(this.placeholder[0].parentNode) {
				this.placeholder[0].parentNode.removeChild(this.placeholder[0]);
			}
			if(this.options.helper !== "original" && this.helper && this.helper[0].parentNode) {
				this.helper.remove();
			}

			$.extend(this, {
				helper: null,
				dragging: false,
				reverting: false,
				_noFinalSort: null
			});

			if(this.domPosition.prev) {
				$(this.domPosition.prev).after(this.currentItem);
			} else {
				$(this.domPosition.parent).prepend(this.currentItem);
			}
		}

		return this;

	},

	serialize: function(o) {

		var items = this._getItemsAsjQuery(o && o.connected),
			str = [];
		o = o || {};

		$(items).each(function() {
			var res = ($(o.item || this).attr(o.attribute || "id") || "").match(o.expression || (/(.+)[\-=_](.+)/));
			if (res) {
				str.push((o.key || res[1]+"[]")+"="+(o.key && o.expression ? res[1] : res[2]));
			}
		});

		if(!str.length && o.key) {
			str.push(o.key + "=");
		}

		return str.join("&");

	},

	toArray: function(o) {

		var items = this._getItemsAsjQuery(o && o.connected),
			ret = [];

		o = o || {};

		items.each(function() { ret.push($(o.item || this).attr(o.attribute || "id") || ""); });
		return ret;

	},

	/* Be careful with the following core functions */
	_intersectsWith: function(item) {

		var x1 = this.positionAbs.left,
			x2 = x1 + this.helperProportions.width,
			y1 = this.positionAbs.top,
			y2 = y1 + this.helperProportions.height,
			l = item.left,
			r = l + item.width,
			t = item.top,
			b = t + item.height,
			dyClick = this.offset.click.top,
			dxClick = this.offset.click.left,
			isOverElementHeight = ( this.options.axis === "x" ) || ( ( y1 + dyClick ) > t && ( y1 + dyClick ) < b ),
			isOverElementWidth = ( this.options.axis === "y" ) || ( ( x1 + dxClick ) > l && ( x1 + dxClick ) < r ),
			isOverElement = isOverElementHeight && isOverElementWidth;

		if ( this.options.tolerance === "pointer" ||
			this.options.forcePointerForContainers ||
			(this.options.tolerance !== "pointer" && this.helperProportions[this.floating ? "width" : "height"] > item[this.floating ? "width" : "height"])
		) {
			return isOverElement;
		} else {

			return (l < x1 + (this.helperProportions.width / 2) && // Right Half
				x2 - (this.helperProportions.width / 2) < r && // Left Half
				t < y1 + (this.helperProportions.height / 2) && // Bottom Half
				y2 - (this.helperProportions.height / 2) < b ); // Top Half

		}
	},

	_intersectsWithPointer: function(item) {

		var isOverElementHeight = (this.options.axis === "x") || this._isOverAxis(this.positionAbs.top + this.offset.click.top, item.top, item.height),
			isOverElementWidth = (this.options.axis === "y") || this._isOverAxis(this.positionAbs.left + this.offset.click.left, item.left, item.width),
			isOverElement = isOverElementHeight && isOverElementWidth,
			verticalDirection = this._getDragVerticalDirection(),
			horizontalDirection = this._getDragHorizontalDirection();

		if (!isOverElement) {
			return false;
		}

		return this.floating ?
			( ((horizontalDirection && horizontalDirection === "right") || verticalDirection === "down") ? 2 : 1 )
			: ( verticalDirection && (verticalDirection === "down" ? 2 : 1) );

	},

	_intersectsWithSides: function(item) {

		var isOverBottomHalf = this._isOverAxis(this.positionAbs.top + this.offset.click.top, item.top + (item.height/2), item.height),
			isOverRightHalf = this._isOverAxis(this.positionAbs.left + this.offset.click.left, item.left + (item.width/2), item.width),
			verticalDirection = this._getDragVerticalDirection(),
			horizontalDirection = this._getDragHorizontalDirection();

		if (this.floating && horizontalDirection) {
			return ((horizontalDirection === "right" && isOverRightHalf) || (horizontalDirection === "left" && !isOverRightHalf));
		} else {
			return verticalDirection && ((verticalDirection === "down" && isOverBottomHalf) || (verticalDirection === "up" && !isOverBottomHalf));
		}

	},

	_getDragVerticalDirection: function() {
		var delta = this.positionAbs.top - this.lastPositionAbs.top;
		return delta !== 0 && (delta > 0 ? "down" : "up");
	},

	_getDragHorizontalDirection: function() {
		var delta = this.positionAbs.left - this.lastPositionAbs.left;
		return delta !== 0 && (delta > 0 ? "right" : "left");
	},

	refresh: function(event) {
		this._refreshItems(event);
		this._setHandleClassName();
		this.refreshPositions();
		return this;
	},

	_connectWith: function() {
		var options = this.options;
		return options.connectWith.constructor === String ? [options.connectWith] : options.connectWith;
	},

	_getItemsAsjQuery: function(connected) {

		var i, j, cur, inst,
			items = [],
			queries = [],
			connectWith = this._connectWith();

		if(connectWith && connected) {
			for (i = connectWith.length - 1; i >= 0; i--){
				cur = $(connectWith[i], this.document[0]);
				for ( j = cur.length - 1; j >= 0; j--){
					inst = $.data(cur[j], this.widgetFullName);
					if(inst && inst !== this && !inst.options.disabled) {
						queries.push([$.isFunction(inst.options.items) ? inst.options.items.call(inst.element) : $(inst.options.items, inst.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"), inst]);
					}
				}
			}
		}

		queries.push([$.isFunction(this.options.items) ? this.options.items.call(this.element, null, { options: this.options, item: this.currentItem }) : $(this.options.items, this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"), this]);

		function addItems() {
			items.push( this );
		}
		for (i = queries.length - 1; i >= 0; i--){
			queries[i][0].each( addItems );
		}

		return $(items);

	},

	_removeCurrentsFromItems: function() {

		var list = this.currentItem.find(":data(" + this.widgetName + "-item)");

		this.items = $.grep(this.items, function (item) {
			for (var j=0; j < list.length; j++) {
				if(list[j] === item.item[0]) {
					return false;
				}
			}
			return true;
		});

	},

	_refreshItems: function(event) {

		this.items = [];
		this.containers = [this];

		var i, j, cur, inst, targetData, _queries, item, queriesLength,
			items = this.items,
			queries = [[$.isFunction(this.options.items) ? this.options.items.call(this.element[0], event, { item: this.currentItem }) : $(this.options.items, this.element), this]],
			connectWith = this._connectWith();

		if(connectWith && this.ready) { //Shouldn't be run the first time through due to massive slow-down
			for (i = connectWith.length - 1; i >= 0; i--){
				cur = $(connectWith[i], this.document[0]);
				for (j = cur.length - 1; j >= 0; j--){
					inst = $.data(cur[j], this.widgetFullName);
					if(inst && inst !== this && !inst.options.disabled) {
						queries.push([$.isFunction(inst.options.items) ? inst.options.items.call(inst.element[0], event, { item: this.currentItem }) : $(inst.options.items, inst.element), inst]);
						this.containers.push(inst);
					}
				}
			}
		}

		for (i = queries.length - 1; i >= 0; i--) {
			targetData = queries[i][1];
			_queries = queries[i][0];

			for (j=0, queriesLength = _queries.length; j < queriesLength; j++) {
				item = $(_queries[j]);

				item.data(this.widgetName + "-item", targetData); // Data for target checking (mouse manager)

				items.push({
					item: item,
					instance: targetData,
					width: 0, height: 0,
					left: 0, top: 0
				});
			}
		}

	},

	refreshPositions: function(fast) {

		//This has to be redone because due to the item being moved out/into the offsetParent, the offsetParent's position will change
		if(this.offsetParent && this.helper) {
			this.offset.parent = this._getParentOffset();
		}

		var i, item, t, p;

		for (i = this.items.length - 1; i >= 0; i--){
			item = this.items[i];

			//We ignore calculating positions of all connected containers when we're not over them
			if(item.instance !== this.currentContainer && this.currentContainer && item.item[0] !== this.currentItem[0]) {
				continue;
			}

			t = this.options.toleranceElement ? $(this.options.toleranceElement, item.item) : item.item;

			if (!fast) {
				item.width = t.outerWidth();
				item.height = t.outerHeight();
			}

			p = t.offset();
			item.left = p.left;
			item.top = p.top;
		}

		if(this.options.custom && this.options.custom.refreshContainers) {
			this.options.custom.refreshContainers.call(this);
		} else {
			for (i = this.containers.length - 1; i >= 0; i--){
				p = this.containers[i].element.offset();
				this.containers[i].containerCache.left = p.left;
				this.containers[i].containerCache.top = p.top;
				this.containers[i].containerCache.width = this.containers[i].element.outerWidth();
				this.containers[i].containerCache.height = this.containers[i].element.outerHeight();
			}
		}

		return this;
	},

	_createPlaceholder: function(that) {
		that = that || this;
		var className,
			o = that.options;

		if(!o.placeholder || o.placeholder.constructor === String) {
			className = o.placeholder;
			o.placeholder = {
				element: function() {

					var nodeName = that.currentItem[0].nodeName.toLowerCase(),
						element = $( "<" + nodeName + ">", that.document[0] )
							.addClass(className || that.currentItem[0].className+" ui-sortable-placeholder")
							.removeClass("ui-sortable-helper");

					if ( nodeName === "tr" ) {
						that.currentItem.children().each(function() {
							$( "<td>&#160;</td>", that.document[0] )
								.attr( "colspan", $( this ).attr( "colspan" ) || 1 )
								.appendTo( element );
						});
					} else if ( nodeName === "img" ) {
						element.attr( "src", that.currentItem.attr( "src" ) );
					}

					if ( !className ) {
						element.css( "visibility", "hidden" );
					}

					return element;
				},
				update: function(container, p) {

					// 1. If a className is set as 'placeholder option, we don't force sizes - the class is responsible for that
					// 2. The option 'forcePlaceholderSize can be enabled to force it even if a class name is specified
					if(className && !o.forcePlaceholderSize) {
						return;
					}

					//If the element doesn't have a actual height by itself (without styles coming from a stylesheet), it receives the inline height from the dragged item
					if(!p.height()) { p.height(that.currentItem.innerHeight() - parseInt(that.currentItem.css("paddingTop")||0, 10) - parseInt(that.currentItem.css("paddingBottom")||0, 10)); }
					if(!p.width()) { p.width(that.currentItem.innerWidth() - parseInt(that.currentItem.css("paddingLeft")||0, 10) - parseInt(that.currentItem.css("paddingRight")||0, 10)); }
				}
			};
		}

		//Create the placeholder
		that.placeholder = $(o.placeholder.element.call(that.element, that.currentItem));

		//Append it after the actual current item
		that.currentItem.after(that.placeholder);

		//Update the size of the placeholder (TODO: Logic to fuzzy, see line 316/317)
		o.placeholder.update(that, that.placeholder);

	},

	_contactContainers: function(event) {
		var i, j, dist, itemWithLeastDistance, posProperty, sizeProperty, cur, nearBottom, floating, axis,
			innermostContainer = null,
			innermostIndex = null;

		// get innermost container that intersects with item
		for (i = this.containers.length - 1; i >= 0; i--) {

			// never consider a container that's located within the item itself
			if($.contains(this.currentItem[0], this.containers[i].element[0])) {
				continue;
			}

			if(this._intersectsWith(this.containers[i].containerCache)) {

				// if we've already found a container and it's more "inner" than this, then continue
				if(innermostContainer && $.contains(this.containers[i].element[0], innermostContainer.element[0])) {
					continue;
				}

				innermostContainer = this.containers[i];
				innermostIndex = i;

			} else {
				// container doesn't intersect. trigger "out" event if necessary
				if(this.containers[i].containerCache.over) {
					this.containers[i]._trigger("out", event, this._uiHash(this));
					this.containers[i].containerCache.over = 0;
				}
			}

		}

		// if no intersecting containers found, return
		if(!innermostContainer) {
			return;
		}

		// move the item into the container if it's not there already
		if(this.containers.length === 1) {
			if (!this.containers[innermostIndex].containerCache.over) {
				this.containers[innermostIndex]._trigger("over", event, this._uiHash(this));
				this.containers[innermostIndex].containerCache.over = 1;
			}
		} else {

			//When entering a new container, we will find the item with the least distance and append our item near it
			dist = 10000;
			itemWithLeastDistance = null;
			floating = innermostContainer.floating || this._isFloating(this.currentItem);
			posProperty = floating ? "left" : "top";
			sizeProperty = floating ? "width" : "height";
			axis = floating ? "clientX" : "clientY";

			for (j = this.items.length - 1; j >= 0; j--) {
				if(!$.contains(this.containers[innermostIndex].element[0], this.items[j].item[0])) {
					continue;
				}
				if(this.items[j].item[0] === this.currentItem[0]) {
					continue;
				}

				cur = this.items[j].item.offset()[posProperty];
				nearBottom = false;
				if ( event[ axis ] - cur > this.items[ j ][ sizeProperty ] / 2 ) {
					nearBottom = true;
				}

				if ( Math.abs( event[ axis ] - cur ) < dist ) {
					dist = Math.abs( event[ axis ] - cur );
					itemWithLeastDistance = this.items[ j ];
					this.direction = nearBottom ? "up": "down";
				}
			}

			//Check if dropOnEmpty is enabled
			if(!itemWithLeastDistance && !this.options.dropOnEmpty) {
				return;
			}

			if(this.currentContainer === this.containers[innermostIndex]) {
				if ( !this.currentContainer.containerCache.over ) {
					this.containers[ innermostIndex ]._trigger( "over", event, this._uiHash() );
					this.currentContainer.containerCache.over = 1;
				}
				return;
			}

			itemWithLeastDistance ? this._rearrange(event, itemWithLeastDistance, null, true) : this._rearrange(event, null, this.containers[innermostIndex].element, true);
			this._trigger("change", event, this._uiHash());
			this.containers[innermostIndex]._trigger("change", event, this._uiHash(this));
			this.currentContainer = this.containers[innermostIndex];

			//Update the placeholder
			this.options.placeholder.update(this.currentContainer, this.placeholder);

			this.containers[innermostIndex]._trigger("over", event, this._uiHash(this));
			this.containers[innermostIndex].containerCache.over = 1;
		}


	},

	_createHelper: function(event) {

		var o = this.options,
			helper = $.isFunction(o.helper) ? $(o.helper.apply(this.element[0], [event, this.currentItem])) : (o.helper === "clone" ? this.currentItem.clone() : this.currentItem);

		//Add the helper to the DOM if that didn't happen already
		if(!helper.parents("body").length) {
			$(o.appendTo !== "parent" ? o.appendTo : this.currentItem[0].parentNode)[0].appendChild(helper[0]);
		}

		if(helper[0] === this.currentItem[0]) {
			this._storedCSS = { width: this.currentItem[0].style.width, height: this.currentItem[0].style.height, position: this.currentItem.css("position"), top: this.currentItem.css("top"), left: this.currentItem.css("left") };
		}

		if(!helper[0].style.width || o.forceHelperSize) {
			helper.width(this.currentItem.width());
		}
		if(!helper[0].style.height || o.forceHelperSize) {
			helper.height(this.currentItem.height());
		}

		return helper;

	},

	_adjustOffsetFromHelper: function(obj) {
		if (typeof obj === "string") {
			obj = obj.split(" ");
		}
		if ($.isArray(obj)) {
			obj = {left: +obj[0], top: +obj[1] || 0};
		}
		if ("left" in obj) {
			this.offset.click.left = obj.left + this.margins.left;
		}
		if ("right" in obj) {
			this.offset.click.left = this.helperProportions.width - obj.right + this.margins.left;
		}
		if ("top" in obj) {
			this.offset.click.top = obj.top + this.margins.top;
		}
		if ("bottom" in obj) {
			this.offset.click.top = this.helperProportions.height - obj.bottom + this.margins.top;
		}
	},

	_getParentOffset: function() {


		//Get the offsetParent and cache its position
		this.offsetParent = this.helper.offsetParent();
		var po = this.offsetParent.offset();

		// This is a special case where we need to modify a offset calculated on start, since the following happened:
		// 1. The position of the helper is absolute, so it's position is calculated based on the next positioned parent
		// 2. The actual offset parent is a child of the scroll parent, and the scroll parent isn't the document, which means that
		//    the scroll is included in the initial calculation of the offset of the parent, and never recalculated upon drag
		if(this.cssPosition === "absolute" && this.scrollParent[0] !== this.document[0] && $.contains(this.scrollParent[0], this.offsetParent[0])) {
			po.left += this.scrollParent.scrollLeft();
			po.top += this.scrollParent.scrollTop();
		}

		// This needs to be actually done for all browsers, since pageX/pageY includes this information
		// with an ugly IE fix
		if( this.offsetParent[0] === this.document[0].body || (this.offsetParent[0].tagName && this.offsetParent[0].tagName.toLowerCase() === "html" && $.ui.ie)) {
			po = { top: 0, left: 0 };
		}

		return {
			top: po.top + (parseInt(this.offsetParent.css("borderTopWidth"),10) || 0),
			left: po.left + (parseInt(this.offsetParent.css("borderLeftWidth"),10) || 0)
		};

	},

	_getRelativeOffset: function() {

		if(this.cssPosition === "relative") {
			var p = this.currentItem.position();
			return {
				top: p.top - (parseInt(this.helper.css("top"),10) || 0) + this.scrollParent.scrollTop(),
				left: p.left - (parseInt(this.helper.css("left"),10) || 0) + this.scrollParent.scrollLeft()
			};
		} else {
			return { top: 0, left: 0 };
		}

	},

	_cacheMargins: function() {
		this.margins = {
			left: (parseInt(this.currentItem.css("marginLeft"),10) || 0),
			top: (parseInt(this.currentItem.css("marginTop"),10) || 0)
		};
	},

	_cacheHelperProportions: function() {
		this.helperProportions = {
			width: this.helper.outerWidth(),
			height: this.helper.outerHeight()
		};
	},

	_setContainment: function() {

		var ce, co, over,
			o = this.options;
		if(o.containment === "parent") {
			o.containment = this.helper[0].parentNode;
		}
		if(o.containment === "document" || o.containment === "window") {
			this.containment = [
				0 - this.offset.relative.left - this.offset.parent.left,
				0 - this.offset.relative.top - this.offset.parent.top,
				o.containment === "document" ? this.document.width() : this.window.width() - this.helperProportions.width - this.margins.left,
				(o.containment === "document" ? this.document.width() : this.window.height() || this.document[0].body.parentNode.scrollHeight) - this.helperProportions.height - this.margins.top
			];
		}

		if(!(/^(document|window|parent)$/).test(o.containment)) {
			ce = $(o.containment)[0];
			co = $(o.containment).offset();
			over = ($(ce).css("overflow") !== "hidden");

			this.containment = [
				co.left + (parseInt($(ce).css("borderLeftWidth"),10) || 0) + (parseInt($(ce).css("paddingLeft"),10) || 0) - this.margins.left,
				co.top + (parseInt($(ce).css("borderTopWidth"),10) || 0) + (parseInt($(ce).css("paddingTop"),10) || 0) - this.margins.top,
				co.left+(over ? Math.max(ce.scrollWidth,ce.offsetWidth) : ce.offsetWidth) - (parseInt($(ce).css("borderLeftWidth"),10) || 0) - (parseInt($(ce).css("paddingRight"),10) || 0) - this.helperProportions.width - this.margins.left,
				co.top+(over ? Math.max(ce.scrollHeight,ce.offsetHeight) : ce.offsetHeight) - (parseInt($(ce).css("borderTopWidth"),10) || 0) - (parseInt($(ce).css("paddingBottom"),10) || 0) - this.helperProportions.height - this.margins.top
			];
		}

	},

	_convertPositionTo: function(d, pos) {

		if(!pos) {
			pos = this.position;
		}
		var mod = d === "absolute" ? 1 : -1,
			scroll = this.cssPosition === "absolute" && !(this.scrollParent[0] !== this.document[0] && $.contains(this.scrollParent[0], this.offsetParent[0])) ? this.offsetParent : this.scrollParent,
			scrollIsRootNode = (/(html|body)/i).test(scroll[0].tagName);

		return {
			top: (
				pos.top	+																// The absolute mouse position
				this.offset.relative.top * mod +										// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.parent.top * mod -											// The offsetParent's offset without borders (offset + border)
				( ( this.cssPosition === "fixed" ? -this.scrollParent.scrollTop() : ( scrollIsRootNode ? 0 : scroll.scrollTop() ) ) * mod)
			),
			left: (
				pos.left +																// The absolute mouse position
				this.offset.relative.left * mod +										// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.parent.left * mod	-										// The offsetParent's offset without borders (offset + border)
				( ( this.cssPosition === "fixed" ? -this.scrollParent.scrollLeft() : scrollIsRootNode ? 0 : scroll.scrollLeft() ) * mod)
			)
		};

	},

	_generatePosition: function(event) {

		var top, left,
			o = this.options,
			pageX = event.pageX,
			pageY = event.pageY,
			scroll = this.cssPosition === "absolute" && !(this.scrollParent[0] !== this.document[0] && $.contains(this.scrollParent[0], this.offsetParent[0])) ? this.offsetParent : this.scrollParent, scrollIsRootNode = (/(html|body)/i).test(scroll[0].tagName);

		// This is another very weird special case that only happens for relative elements:
		// 1. If the css position is relative
		// 2. and the scroll parent is the document or similar to the offset parent
		// we have to refresh the relative offset during the scroll so there are no jumps
		if(this.cssPosition === "relative" && !(this.scrollParent[0] !== this.document[0] && this.scrollParent[0] !== this.offsetParent[0])) {
			this.offset.relative = this._getRelativeOffset();
		}

		/*
		 * - Position constraining -
		 * Constrain the position to a mix of grid, containment.
		 */

		if(this.originalPosition) { //If we are not dragging yet, we won't check for options

			if(this.containment) {
				if(event.pageX - this.offset.click.left < this.containment[0]) {
					pageX = this.containment[0] + this.offset.click.left;
				}
				if(event.pageY - this.offset.click.top < this.containment[1]) {
					pageY = this.containment[1] + this.offset.click.top;
				}
				if(event.pageX - this.offset.click.left > this.containment[2]) {
					pageX = this.containment[2] + this.offset.click.left;
				}
				if(event.pageY - this.offset.click.top > this.containment[3]) {
					pageY = this.containment[3] + this.offset.click.top;
				}
			}

			if(o.grid) {
				top = this.originalPageY + Math.round((pageY - this.originalPageY) / o.grid[1]) * o.grid[1];
				pageY = this.containment ? ( (top - this.offset.click.top >= this.containment[1] && top - this.offset.click.top <= this.containment[3]) ? top : ((top - this.offset.click.top >= this.containment[1]) ? top - o.grid[1] : top + o.grid[1])) : top;

				left = this.originalPageX + Math.round((pageX - this.originalPageX) / o.grid[0]) * o.grid[0];
				pageX = this.containment ? ( (left - this.offset.click.left >= this.containment[0] && left - this.offset.click.left <= this.containment[2]) ? left : ((left - this.offset.click.left >= this.containment[0]) ? left - o.grid[0] : left + o.grid[0])) : left;
			}

		}

		return {
			top: (
				pageY -																// The absolute mouse position
				this.offset.click.top -													// Click offset (relative to the element)
				this.offset.relative.top	-											// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.parent.top +												// The offsetParent's offset without borders (offset + border)
				( ( this.cssPosition === "fixed" ? -this.scrollParent.scrollTop() : ( scrollIsRootNode ? 0 : scroll.scrollTop() ) ))
			),
			left: (
				pageX -																// The absolute mouse position
				this.offset.click.left -												// Click offset (relative to the element)
				this.offset.relative.left	-											// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.parent.left +												// The offsetParent's offset without borders (offset + border)
				( ( this.cssPosition === "fixed" ? -this.scrollParent.scrollLeft() : scrollIsRootNode ? 0 : scroll.scrollLeft() ))
			)
		};

	},

	_rearrange: function(event, i, a, hardRefresh) {

		a ? a[0].appendChild(this.placeholder[0]) : i.item[0].parentNode.insertBefore(this.placeholder[0], (this.direction === "down" ? i.item[0] : i.item[0].nextSibling));

		//Various things done here to improve the performance:
		// 1. we create a setTimeout, that calls refreshPositions
		// 2. on the instance, we have a counter variable, that get's higher after every append
		// 3. on the local scope, we copy the counter variable, and check in the timeout, if it's still the same
		// 4. this lets only the last addition to the timeout stack through
		this.counter = this.counter ? ++this.counter : 1;
		var counter = this.counter;

		this._delay(function() {
			if(counter === this.counter) {
				this.refreshPositions(!hardRefresh); //Precompute after each DOM insertion, NOT on mousemove
			}
		});

	},

	_clear: function(event, noPropagation) {

		this.reverting = false;
		// We delay all events that have to be triggered to after the point where the placeholder has been removed and
		// everything else normalized again
		var i,
			delayedTriggers = [];

		// We first have to update the dom position of the actual currentItem
		// Note: don't do it if the current item is already removed (by a user), or it gets reappended (see #4088)
		if(!this._noFinalSort && this.currentItem.parent().length) {
			this.placeholder.before(this.currentItem);
		}
		this._noFinalSort = null;

		if(this.helper[0] === this.currentItem[0]) {
			for(i in this._storedCSS) {
				if(this._storedCSS[i] === "auto" || this._storedCSS[i] === "static") {
					this._storedCSS[i] = "";
				}
			}
			this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper");
		} else {
			this.currentItem.show();
		}

		if(this.fromOutside && !noPropagation) {
			delayedTriggers.push(function(event) { this._trigger("receive", event, this._uiHash(this.fromOutside)); });
		}
		if((this.fromOutside || this.domPosition.prev !== this.currentItem.prev().not(".ui-sortable-helper")[0] || this.domPosition.parent !== this.currentItem.parent()[0]) && !noPropagation) {
			delayedTriggers.push(function(event) { this._trigger("update", event, this._uiHash()); }); //Trigger update callback if the DOM position has changed
		}

		// Check if the items Container has Changed and trigger appropriate
		// events.
		if (this !== this.currentContainer) {
			if(!noPropagation) {
				delayedTriggers.push(function(event) { this._trigger("remove", event, this._uiHash()); });
				delayedTriggers.push((function(c) { return function(event) { c._trigger("receive", event, this._uiHash(this)); };  }).call(this, this.currentContainer));
				delayedTriggers.push((function(c) { return function(event) { c._trigger("update", event, this._uiHash(this));  }; }).call(this, this.currentContainer));
			}
		}


		//Post events to containers
		function delayEvent( type, instance, container ) {
			return function( event ) {
				container._trigger( type, event, instance._uiHash( instance ) );
			};
		}
		for (i = this.containers.length - 1; i >= 0; i--){
			if (!noPropagation) {
				delayedTriggers.push( delayEvent( "deactivate", this, this.containers[ i ] ) );
			}
			if(this.containers[i].containerCache.over) {
				delayedTriggers.push( delayEvent( "out", this, this.containers[ i ] ) );
				this.containers[i].containerCache.over = 0;
			}
		}

		//Do what was originally in plugins
		if ( this.storedCursor ) {
			this.document.find( "body" ).css( "cursor", this.storedCursor );
			this.storedStylesheet.remove();
		}
		if(this._storedOpacity) {
			this.helper.css("opacity", this._storedOpacity);
		}
		if(this._storedZIndex) {
			this.helper.css("zIndex", this._storedZIndex === "auto" ? "" : this._storedZIndex);
		}

		this.dragging = false;

		if(!noPropagation) {
			this._trigger("beforeStop", event, this._uiHash());
		}

		//$(this.placeholder[0]).remove(); would have been the jQuery way - unfortunately, it unbinds ALL events from the original node!
		this.placeholder[0].parentNode.removeChild(this.placeholder[0]);

		if ( !this.cancelHelperRemoval ) {
			if ( this.helper[ 0 ] !== this.currentItem[ 0 ] ) {
				this.helper.remove();
			}
			this.helper = null;
		}

		if(!noPropagation) {
			for (i=0; i < delayedTriggers.length; i++) {
				delayedTriggers[i].call(this, event);
			} //Trigger all delayed events
			this._trigger("stop", event, this._uiHash());
		}

		this.fromOutside = false;
		return !this.cancelHelperRemoval;

	},

	_trigger: function() {
		if ($.Widget.prototype._trigger.apply(this, arguments) === false) {
			this.cancel();
		}
	},

	_uiHash: function(_inst) {
		var inst = _inst || this;
		return {
			helper: inst.helper,
			placeholder: inst.placeholder || $([]),
			position: inst.position,
			originalPosition: inst.originalPosition,
			offset: inst.positionAbs,
			item: inst.currentItem,
			sender: _inst ? _inst.element : null
		};
	}

});


/*!
 * jQuery UI Menu 1.11.3
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/menu/
 */


var menu = $.widget( "ui.menu", {
	version: "1.11.3",
	defaultElement: "<ul>",
	delay: 300,
	options: {
		icons: {
			submenu: "ui-icon-carat-1-e"
		},
		items: "> *",
		menus: "ul",
		position: {
			my: "left-1 top",
			at: "right top"
		},
		role: "menu",

		// callbacks
		blur: null,
		focus: null,
		select: null
	},

	_create: function() {
		this.activeMenu = this.element;

		// Flag used to prevent firing of the click handler
		// as the event bubbles up through nested menus
		this.mouseHandled = false;
		this.element
			.uniqueId()
			.addClass( "ui-menu ui-widget ui-widget-content" )
			.toggleClass( "ui-menu-icons", !!this.element.find( ".ui-icon" ).length )
			.attr({
				role: this.options.role,
				tabIndex: 0
			});

		if ( this.options.disabled ) {
			this.element
				.addClass( "ui-state-disabled" )
				.attr( "aria-disabled", "true" );
		}

		this._on({
			// Prevent focus from sticking to links inside menu after clicking
			// them (focus should always stay on UL during navigation).
			"mousedown .ui-menu-item": function( event ) {
				event.preventDefault();
			},
			"click .ui-menu-item": function( event ) {
				var target = $( event.target );
				if ( !this.mouseHandled && target.not( ".ui-state-disabled" ).length ) {
					this.select( event );

					// Only set the mouseHandled flag if the event will bubble, see #9469.
					if ( !event.isPropagationStopped() ) {
						this.mouseHandled = true;
					}

					// Open submenu on click
					if ( target.has( ".ui-menu" ).length ) {
						this.expand( event );
					} else if ( !this.element.is( ":focus" ) && $( this.document[ 0 ].activeElement ).closest( ".ui-menu" ).length ) {

						// Redirect focus to the menu
						this.element.trigger( "focus", [ true ] );

						// If the active item is on the top level, let it stay active.
						// Otherwise, blur the active item since it is no longer visible.
						if ( this.active && this.active.parents( ".ui-menu" ).length === 1 ) {
							clearTimeout( this.timer );
						}
					}
				}
			},
			"mouseenter .ui-menu-item": function( event ) {
				// Ignore mouse events while typeahead is active, see #10458.
				// Prevents focusing the wrong item when typeahead causes a scroll while the mouse
				// is over an item in the menu
				if ( this.previousFilter ) {
					return;
				}
				var target = $( event.currentTarget );
				// Remove ui-state-active class from siblings of the newly focused menu item
				// to avoid a jump caused by adjacent elements both having a class with a border
				target.siblings( ".ui-state-active" ).removeClass( "ui-state-active" );
				this.focus( event, target );
			},
			mouseleave: "collapseAll",
			"mouseleave .ui-menu": "collapseAll",
			focus: function( event, keepActiveItem ) {
				// If there's already an active item, keep it active
				// If not, activate the first item
				var item = this.active || this.element.find( this.options.items ).eq( 0 );

				if ( !keepActiveItem ) {
					this.focus( event, item );
				}
			},
			blur: function( event ) {
				this._delay(function() {
					if ( !$.contains( this.element[0], this.document[0].activeElement ) ) {
						this.collapseAll( event );
					}
				});
			},
			keydown: "_keydown"
		});

		this.refresh();

		// Clicks outside of a menu collapse any open menus
		this._on( this.document, {
			click: function( event ) {
				if ( this._closeOnDocumentClick( event ) ) {
					this.collapseAll( event );
				}

				// Reset the mouseHandled flag
				this.mouseHandled = false;
			}
		});
	},

	_destroy: function() {
		// Destroy (sub)menus
		this.element
			.removeAttr( "aria-activedescendant" )
			.find( ".ui-menu" ).addBack()
				.removeClass( "ui-menu ui-widget ui-widget-content ui-menu-icons ui-front" )
				.removeAttr( "role" )
				.removeAttr( "tabIndex" )
				.removeAttr( "aria-labelledby" )
				.removeAttr( "aria-expanded" )
				.removeAttr( "aria-hidden" )
				.removeAttr( "aria-disabled" )
				.removeUniqueId()
				.show();

		// Destroy menu items
		this.element.find( ".ui-menu-item" )
			.removeClass( "ui-menu-item" )
			.removeAttr( "role" )
			.removeAttr( "aria-disabled" )
			.removeUniqueId()
			.removeClass( "ui-state-hover" )
			.removeAttr( "tabIndex" )
			.removeAttr( "role" )
			.removeAttr( "aria-haspopup" )
			.children().each( function() {
				var elem = $( this );
				if ( elem.data( "ui-menu-submenu-carat" ) ) {
					elem.remove();
				}
			});

		// Destroy menu dividers
		this.element.find( ".ui-menu-divider" ).removeClass( "ui-menu-divider ui-widget-content" );
	},

	_keydown: function( event ) {
		var match, prev, character, skip,
			preventDefault = true;

		switch ( event.keyCode ) {
		case $.ui.keyCode.PAGE_UP:
			this.previousPage( event );
			break;
		case $.ui.keyCode.PAGE_DOWN:
			this.nextPage( event );
			break;
		case $.ui.keyCode.HOME:
			this._move( "first", "first", event );
			break;
		case $.ui.keyCode.END:
			this._move( "last", "last", event );
			break;
		case $.ui.keyCode.UP:
			this.previous( event );
			break;
		case $.ui.keyCode.DOWN:
			this.next( event );
			break;
		case $.ui.keyCode.LEFT:
			this.collapse( event );
			break;
		case $.ui.keyCode.RIGHT:
			if ( this.active && !this.active.is( ".ui-state-disabled" ) ) {
				this.expand( event );
			}
			break;
		case $.ui.keyCode.ENTER:
		case $.ui.keyCode.SPACE:
			this._activate( event );
			break;
		case $.ui.keyCode.ESCAPE:
			this.collapse( event );
			break;
		default:
			preventDefault = false;
			prev = this.previousFilter || "";
			character = String.fromCharCode( event.keyCode );
			skip = false;

			clearTimeout( this.filterTimer );

			if ( character === prev ) {
				skip = true;
			} else {
				character = prev + character;
			}

			match = this._filterMenuItems( character );
			match = skip && match.index( this.active.next() ) !== -1 ?
				this.active.nextAll( ".ui-menu-item" ) :
				match;

			// If no matches on the current filter, reset to the last character pressed
			// to move down the menu to the first item that starts with that character
			if ( !match.length ) {
				character = String.fromCharCode( event.keyCode );
				match = this._filterMenuItems( character );
			}

			if ( match.length ) {
				this.focus( event, match );
				this.previousFilter = character;
				this.filterTimer = this._delay(function() {
					delete this.previousFilter;
				}, 1000 );
			} else {
				delete this.previousFilter;
			}
		}

		if ( preventDefault ) {
			event.preventDefault();
		}
	},

	_activate: function( event ) {
		if ( !this.active.is( ".ui-state-disabled" ) ) {
			if ( this.active.is( "[aria-haspopup='true']" ) ) {
				this.expand( event );
			} else {
				this.select( event );
			}
		}
	},

	refresh: function() {
		var menus, items,
			that = this,
			icon = this.options.icons.submenu,
			submenus = this.element.find( this.options.menus );

		this.element.toggleClass( "ui-menu-icons", !!this.element.find( ".ui-icon" ).length );

		// Initialize nested menus
		submenus.filter( ":not(.ui-menu)" )
			.addClass( "ui-menu ui-widget ui-widget-content ui-front" )
			.hide()
			.attr({
				role: this.options.role,
				"aria-hidden": "true",
				"aria-expanded": "false"
			})
			.each(function() {
				var menu = $( this ),
					item = menu.parent(),
					submenuCarat = $( "<span>" )
						.addClass( "ui-menu-icon ui-icon " + icon )
						.data( "ui-menu-submenu-carat", true );

				item
					.attr( "aria-haspopup", "true" )
					.prepend( submenuCarat );
				menu.attr( "aria-labelledby", item.attr( "id" ) );
			});

		menus = submenus.add( this.element );
		items = menus.find( this.options.items );

		// Initialize menu-items containing spaces and/or dashes only as dividers
		items.not( ".ui-menu-item" ).each(function() {
			var item = $( this );
			if ( that._isDivider( item ) ) {
				item.addClass( "ui-widget-content ui-menu-divider" );
			}
		});

		// Don't refresh list items that are already adapted
		items.not( ".ui-menu-item, .ui-menu-divider" )
			.addClass( "ui-menu-item" )
			.uniqueId()
			.attr({
				tabIndex: -1,
				role: this._itemRole()
			});

		// Add aria-disabled attribute to any disabled menu item
		items.filter( ".ui-state-disabled" ).attr( "aria-disabled", "true" );

		// If the active item has been removed, blur the menu
		if ( this.active && !$.contains( this.element[ 0 ], this.active[ 0 ] ) ) {
			this.blur();
		}
	},

	_itemRole: function() {
		return {
			menu: "menuitem",
			listbox: "option"
		}[ this.options.role ];
	},

	_setOption: function( key, value ) {
		if ( key === "icons" ) {
			this.element.find( ".ui-menu-icon" )
				.removeClass( this.options.icons.submenu )
				.addClass( value.submenu );
		}
		if ( key === "disabled" ) {
			this.element
				.toggleClass( "ui-state-disabled", !!value )
				.attr( "aria-disabled", value );
		}
		this._super( key, value );
	},

	focus: function( event, item ) {
		var nested, focused;
		this.blur( event, event && event.type === "focus" );

		this._scrollIntoView( item );

		this.active = item.first();
		focused = this.active.addClass( "ui-state-focus" ).removeClass( "ui-state-active" );
		// Only update aria-activedescendant if there's a role
		// otherwise we assume focus is managed elsewhere
		if ( this.options.role ) {
			this.element.attr( "aria-activedescendant", focused.attr( "id" ) );
		}

		// Highlight active parent menu item, if any
		this.active
			.parent()
			.closest( ".ui-menu-item" )
			.addClass( "ui-state-active" );

		if ( event && event.type === "keydown" ) {
			this._close();
		} else {
			this.timer = this._delay(function() {
				this._close();
			}, this.delay );
		}

		nested = item.children( ".ui-menu" );
		if ( nested.length && event && ( /^mouse/.test( event.type ) ) ) {
			this._startOpening(nested);
		}
		this.activeMenu = item.parent();

		this._trigger( "focus", event, { item: item } );
	},

	_scrollIntoView: function( item ) {
		var borderTop, paddingTop, offset, scroll, elementHeight, itemHeight;
		if ( this._hasScroll() ) {
			borderTop = parseFloat( $.css( this.activeMenu[0], "borderTopWidth" ) ) || 0;
			paddingTop = parseFloat( $.css( this.activeMenu[0], "paddingTop" ) ) || 0;
			offset = item.offset().top - this.activeMenu.offset().top - borderTop - paddingTop;
			scroll = this.activeMenu.scrollTop();
			elementHeight = this.activeMenu.height();
			itemHeight = item.outerHeight();

			if ( offset < 0 ) {
				this.activeMenu.scrollTop( scroll + offset );
			} else if ( offset + itemHeight > elementHeight ) {
				this.activeMenu.scrollTop( scroll + offset - elementHeight + itemHeight );
			}
		}
	},

	blur: function( event, fromFocus ) {
		if ( !fromFocus ) {
			clearTimeout( this.timer );
		}

		if ( !this.active ) {
			return;
		}

		this.active.removeClass( "ui-state-focus" );
		this.active = null;

		this._trigger( "blur", event, { item: this.active } );
	},

	_startOpening: function( submenu ) {
		clearTimeout( this.timer );

		// Don't open if already open fixes a Firefox bug that caused a .5 pixel
		// shift in the submenu position when mousing over the carat icon
		if ( submenu.attr( "aria-hidden" ) !== "true" ) {
			return;
		}

		this.timer = this._delay(function() {
			this._close();
			this._open( submenu );
		}, this.delay );
	},

	_open: function( submenu ) {
		var position = $.extend({
			of: this.active
		}, this.options.position );

		clearTimeout( this.timer );
		this.element.find( ".ui-menu" ).not( submenu.parents( ".ui-menu" ) )
			.hide()
			.attr( "aria-hidden", "true" );

		submenu
			.show()
			.removeAttr( "aria-hidden" )
			.attr( "aria-expanded", "true" )
			.position( position );
	},

	collapseAll: function( event, all ) {
		clearTimeout( this.timer );
		this.timer = this._delay(function() {
			// If we were passed an event, look for the submenu that contains the event
			var currentMenu = all ? this.element :
				$( event && event.target ).closest( this.element.find( ".ui-menu" ) );

			// If we found no valid submenu ancestor, use the main menu to close all sub menus anyway
			if ( !currentMenu.length ) {
				currentMenu = this.element;
			}

			this._close( currentMenu );

			this.blur( event );
			this.activeMenu = currentMenu;
		}, this.delay );
	},

	// With no arguments, closes the currently active menu - if nothing is active
	// it closes all menus.  If passed an argument, it will search for menus BELOW
	_close: function( startMenu ) {
		if ( !startMenu ) {
			startMenu = this.active ? this.active.parent() : this.element;
		}

		startMenu
			.find( ".ui-menu" )
				.hide()
				.attr( "aria-hidden", "true" )
				.attr( "aria-expanded", "false" )
			.end()
			.find( ".ui-state-active" ).not( ".ui-state-focus" )
				.removeClass( "ui-state-active" );
	},

	_closeOnDocumentClick: function( event ) {
		return !$( event.target ).closest( ".ui-menu" ).length;
	},

	_isDivider: function( item ) {

		// Match hyphen, em dash, en dash
		return !/[^\-\u2014\u2013\s]/.test( item.text() );
	},

	collapse: function( event ) {
		var newItem = this.active &&
			this.active.parent().closest( ".ui-menu-item", this.element );
		if ( newItem && newItem.length ) {
			this._close();
			this.focus( event, newItem );
		}
	},

	expand: function( event ) {
		var newItem = this.active &&
			this.active
				.children( ".ui-menu " )
				.find( this.options.items )
				.first();

		if ( newItem && newItem.length ) {
			this._open( newItem.parent() );

			// Delay so Firefox will not hide activedescendant change in expanding submenu from AT
			this._delay(function() {
				this.focus( event, newItem );
			});
		}
	},

	next: function( event ) {
		this._move( "next", "first", event );
	},

	previous: function( event ) {
		this._move( "prev", "last", event );
	},

	isFirstItem: function() {
		return this.active && !this.active.prevAll( ".ui-menu-item" ).length;
	},

	isLastItem: function() {
		return this.active && !this.active.nextAll( ".ui-menu-item" ).length;
	},

	_move: function( direction, filter, event ) {
		var next;
		if ( this.active ) {
			if ( direction === "first" || direction === "last" ) {
				next = this.active
					[ direction === "first" ? "prevAll" : "nextAll" ]( ".ui-menu-item" )
					.eq( -1 );
			} else {
				next = this.active
					[ direction + "All" ]( ".ui-menu-item" )
					.eq( 0 );
			}
		}
		if ( !next || !next.length || !this.active ) {
			next = this.activeMenu.find( this.options.items )[ filter ]();
		}

		this.focus( event, next );
	},

	nextPage: function( event ) {
		var item, base, height;

		if ( !this.active ) {
			this.next( event );
			return;
		}
		if ( this.isLastItem() ) {
			return;
		}
		if ( this._hasScroll() ) {
			base = this.active.offset().top;
			height = this.element.height();
			this.active.nextAll( ".ui-menu-item" ).each(function() {
				item = $( this );
				return item.offset().top - base - height < 0;
			});

			this.focus( event, item );
		} else {
			this.focus( event, this.activeMenu.find( this.options.items )
				[ !this.active ? "first" : "last" ]() );
		}
	},

	previousPage: function( event ) {
		var item, base, height;
		if ( !this.active ) {
			this.next( event );
			return;
		}
		if ( this.isFirstItem() ) {
			return;
		}
		if ( this._hasScroll() ) {
			base = this.active.offset().top;
			height = this.element.height();
			this.active.prevAll( ".ui-menu-item" ).each(function() {
				item = $( this );
				return item.offset().top - base + height > 0;
			});

			this.focus( event, item );
		} else {
			this.focus( event, this.activeMenu.find( this.options.items ).first() );
		}
	},

	_hasScroll: function() {
		return this.element.outerHeight() < this.element.prop( "scrollHeight" );
	},

	select: function( event ) {
		// TODO: It should never be possible to not have an active item at this
		// point, but the tests don't trigger mouseenter before click.
		this.active = this.active || $( event.target ).closest( ".ui-menu-item" );
		var ui = { item: this.active };
		if ( !this.active.has( ".ui-menu" ).length ) {
			this.collapseAll( event, true );
		}
		this._trigger( "select", event, ui );
	},

	_filterMenuItems: function(character) {
		var escapedCharacter = character.replace( /[\-\[\]{}()*+?.,\\\^$|#\s]/g, "\\$&" ),
			regex = new RegExp( "^" + escapedCharacter, "i" );

		return this.activeMenu
			.find( this.options.items )

			// Only match on items, not dividers or other content (#10571)
			.filter( ".ui-menu-item" )
			.filter(function() {
				return regex.test( $.trim( $( this ).text() ) );
			});
	}
});


/*!
 * jQuery UI Autocomplete 1.11.3
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/autocomplete/
 */


$.widget( "ui.autocomplete", {
	version: "1.11.3",
	defaultElement: "<input>",
	options: {
		appendTo: null,
		autoFocus: false,
		delay: 300,
		minLength: 1,
		position: {
			my: "left top",
			at: "left bottom",
			collision: "none"
		},
		source: null,

		// callbacks
		change: null,
		close: null,
		focus: null,
		open: null,
		response: null,
		search: null,
		select: null
	},

	requestIndex: 0,
	pending: 0,

	_create: function() {
		// Some browsers only repeat keydown events, not keypress events,
		// so we use the suppressKeyPress flag to determine if we've already
		// handled the keydown event. #7269
		// Unfortunately the code for & in keypress is the same as the up arrow,
		// so we use the suppressKeyPressRepeat flag to avoid handling keypress
		// events when we know the keydown event was used to modify the
		// search term. #7799
		var suppressKeyPress, suppressKeyPressRepeat, suppressInput,
			nodeName = this.element[ 0 ].nodeName.toLowerCase(),
			isTextarea = nodeName === "textarea",
			isInput = nodeName === "input";

		this.isMultiLine =
			// Textareas are always multi-line
			isTextarea ? true :
			// Inputs are always single-line, even if inside a contentEditable element
			// IE also treats inputs as contentEditable
			isInput ? false :
			// All other element types are determined by whether or not they're contentEditable
			this.element.prop( "isContentEditable" );

		this.valueMethod = this.element[ isTextarea || isInput ? "val" : "text" ];
		this.isNewMenu = true;

		this.element
			.addClass( "ui-autocomplete-input" )
			.attr( "autocomplete", "off" );

		this._on( this.element, {
			keydown: function( event ) {
				if ( this.element.prop( "readOnly" ) ) {
					suppressKeyPress = true;
					suppressInput = true;
					suppressKeyPressRepeat = true;
					return;
				}

				suppressKeyPress = false;
				suppressInput = false;
				suppressKeyPressRepeat = false;
				var keyCode = $.ui.keyCode;
				switch ( event.keyCode ) {
				case keyCode.PAGE_UP:
					suppressKeyPress = true;
					this._move( "previousPage", event );
					break;
				case keyCode.PAGE_DOWN:
					suppressKeyPress = true;
					this._move( "nextPage", event );
					break;
				case keyCode.UP:
					suppressKeyPress = true;
					this._keyEvent( "previous", event );
					break;
				case keyCode.DOWN:
					suppressKeyPress = true;
					this._keyEvent( "next", event );
					break;
				case keyCode.ENTER:
					// when menu is open and has focus
					if ( this.menu.active ) {
						// #6055 - Opera still allows the keypress to occur
						// which causes forms to submit
						suppressKeyPress = true;
						event.preventDefault();
						this.menu.select( event );
					}
					break;
				case keyCode.TAB:
					if ( this.menu.active ) {
						this.menu.select( event );
					}
					break;
				case keyCode.ESCAPE:
					if ( this.menu.element.is( ":visible" ) ) {
						if ( !this.isMultiLine ) {
							this._value( this.term );
						}
						this.close( event );
						// Different browsers have different default behavior for escape
						// Single press can mean undo or clear
						// Double press in IE means clear the whole form
						event.preventDefault();
					}
					break;
				default:
					suppressKeyPressRepeat = true;
					// search timeout should be triggered before the input value is changed
					this._searchTimeout( event );
					break;
				}
			},
			keypress: function( event ) {
				if ( suppressKeyPress ) {
					suppressKeyPress = false;
					if ( !this.isMultiLine || this.menu.element.is( ":visible" ) ) {
						event.preventDefault();
					}
					return;
				}
				if ( suppressKeyPressRepeat ) {
					return;
				}

				// replicate some key handlers to allow them to repeat in Firefox and Opera
				var keyCode = $.ui.keyCode;
				switch ( event.keyCode ) {
				case keyCode.PAGE_UP:
					this._move( "previousPage", event );
					break;
				case keyCode.PAGE_DOWN:
					this._move( "nextPage", event );
					break;
				case keyCode.UP:
					this._keyEvent( "previous", event );
					break;
				case keyCode.DOWN:
					this._keyEvent( "next", event );
					break;
				}
			},
			input: function( event ) {
				if ( suppressInput ) {
					suppressInput = false;
					event.preventDefault();
					return;
				}
				this._searchTimeout( event );
			},
			focus: function() {
				this.selectedItem = null;
				this.previous = this._value();
			},
			blur: function( event ) {
				if ( this.cancelBlur ) {
					delete this.cancelBlur;
					return;
				}

				clearTimeout( this.searching );
				this.close( event );
				this._change( event );
			}
		});

		this._initSource();
		this.menu = $( "<ul>" )
			.addClass( "ui-autocomplete ui-front" )
			.appendTo( this._appendTo() )
			.menu({
				// disable ARIA support, the live region takes care of that
				role: null
			})
			.hide()
			.menu( "instance" );

		this._on( this.menu.element, {
			mousedown: function( event ) {
				// prevent moving focus out of the text field
				event.preventDefault();

				// IE doesn't prevent moving focus even with event.preventDefault()
				// so we set a flag to know when we should ignore the blur event
				this.cancelBlur = true;
				this._delay(function() {
					delete this.cancelBlur;
				});

				// clicking on the scrollbar causes focus to shift to the body
				// but we can't detect a mouseup or a click immediately afterward
				// so we have to track the next mousedown and close the menu if
				// the user clicks somewhere outside of the autocomplete
				var menuElement = this.menu.element[ 0 ];
				if ( !$( event.target ).closest( ".ui-menu-item" ).length ) {
					this._delay(function() {
						var that = this;
						this.document.one( "mousedown", function( event ) {
							if ( event.target !== that.element[ 0 ] &&
									event.target !== menuElement &&
									!$.contains( menuElement, event.target ) ) {
								that.close();
							}
						});
					});
				}
			},
			menufocus: function( event, ui ) {
				var label, item;
				// support: Firefox
				// Prevent accidental activation of menu items in Firefox (#7024 #9118)
				if ( this.isNewMenu ) {
					this.isNewMenu = false;
					if ( event.originalEvent && /^mouse/.test( event.originalEvent.type ) ) {
						this.menu.blur();

						this.document.one( "mousemove", function() {
							$( event.target ).trigger( event.originalEvent );
						});

						return;
					}
				}

				item = ui.item.data( "ui-autocomplete-item" );
				if ( false !== this._trigger( "focus", event, { item: item } ) ) {
					// use value to match what will end up in the input, if it was a key event
					if ( event.originalEvent && /^key/.test( event.originalEvent.type ) ) {
						this._value( item.value );
					}
				}

				// Announce the value in the liveRegion
				label = ui.item.attr( "aria-label" ) || item.value;
				if ( label && $.trim( label ).length ) {
					this.liveRegion.children().hide();
					$( "<div>" ).text( label ).appendTo( this.liveRegion );
				}
			},
			menuselect: function( event, ui ) {
				var item = ui.item.data( "ui-autocomplete-item" ),
					previous = this.previous;

				// only trigger when focus was lost (click on menu)
				if ( this.element[ 0 ] !== this.document[ 0 ].activeElement ) {
					this.element.focus();
					this.previous = previous;
					// #6109 - IE triggers two focus events and the second
					// is asynchronous, so we need to reset the previous
					// term synchronously and asynchronously :-(
					this._delay(function() {
						this.previous = previous;
						this.selectedItem = item;
					});
				}

				if ( false !== this._trigger( "select", event, { item: item } ) ) {
					this._value( item.value );
				}
				// reset the term after the select event
				// this allows custom select handling to work properly
				this.term = this._value();

				this.close( event );
				this.selectedItem = item;
			}
		});

		this.liveRegion = $( "<span>", {
				role: "status",
				"aria-live": "assertive",
				"aria-relevant": "additions"
			})
			.addClass( "ui-helper-hidden-accessible" )
			.appendTo( this.document[ 0 ].body );

		// turning off autocomplete prevents the browser from remembering the
		// value when navigating through history, so we re-enable autocomplete
		// if the page is unloaded before the widget is destroyed. #7790
		this._on( this.window, {
			beforeunload: function() {
				this.element.removeAttr( "autocomplete" );
			}
		});
	},

	_destroy: function() {
		clearTimeout( this.searching );
		this.element
			.removeClass( "ui-autocomplete-input" )
			.removeAttr( "autocomplete" );
		this.menu.element.remove();
		this.liveRegion.remove();
	},

	_setOption: function( key, value ) {
		this._super( key, value );
		if ( key === "source" ) {
			this._initSource();
		}
		if ( key === "appendTo" ) {
			this.menu.element.appendTo( this._appendTo() );
		}
		if ( key === "disabled" && value && this.xhr ) {
			this.xhr.abort();
		}
	},

	_appendTo: function() {
		var element = this.options.appendTo;

		if ( element ) {
			element = element.jquery || element.nodeType ?
				$( element ) :
				this.document.find( element ).eq( 0 );
		}

		if ( !element || !element[ 0 ] ) {
			element = this.element.closest( ".ui-front" );
		}

		if ( !element.length ) {
			element = this.document[ 0 ].body;
		}

		return element;
	},

	_initSource: function() {
		var array, url,
			that = this;
		if ( $.isArray( this.options.source ) ) {
			array = this.options.source;
			this.source = function( request, response ) {
				response( $.ui.autocomplete.filter( array, request.term ) );
			};
		} else if ( typeof this.options.source === "string" ) {
			url = this.options.source;
			this.source = function( request, response ) {
				if ( that.xhr ) {
					that.xhr.abort();
				}
				that.xhr = $.ajax({
					url: url,
					data: request,
					dataType: "json",
					success: function( data ) {
						response( data );
					},
					error: function() {
						response([]);
					}
				});
			};
		} else {
			this.source = this.options.source;
		}
	},

	_searchTimeout: function( event ) {
		clearTimeout( this.searching );
		this.searching = this._delay(function() {

			// Search if the value has changed, or if the user retypes the same value (see #7434)
			var equalValues = this.term === this._value(),
				menuVisible = this.menu.element.is( ":visible" ),
				modifierKey = event.altKey || event.ctrlKey || event.metaKey || event.shiftKey;

			if ( !equalValues || ( equalValues && !menuVisible && !modifierKey ) ) {
				this.selectedItem = null;
				this.search( null, event );
			}
		}, this.options.delay );
	},

	search: function( value, event ) {
		value = value != null ? value : this._value();

		// always save the actual value, not the one passed as an argument
		this.term = this._value();

		if ( value.length < this.options.minLength ) {
			return this.close( event );
		}

		if ( this._trigger( "search", event ) === false ) {
			return;
		}

		return this._search( value );
	},

	_search: function( value ) {
		this.pending++;
		this.element.addClass( "ui-autocomplete-loading" );
		this.cancelSearch = false;

		this.source( { term: value }, this._response() );
	},

	_response: function() {
		var index = ++this.requestIndex;

		return $.proxy(function( content ) {
			if ( index === this.requestIndex ) {
				this.__response( content );
			}

			this.pending--;
			if ( !this.pending ) {
				this.element.removeClass( "ui-autocomplete-loading" );
			}
		}, this );
	},

	__response: function( content ) {
		if ( content ) {
			content = this._normalize( content );
		}
		this._trigger( "response", null, { content: content } );
		if ( !this.options.disabled && content && content.length && !this.cancelSearch ) {
			this._suggest( content );
			this._trigger( "open" );
		} else {
			// use ._close() instead of .close() so we don't cancel future searches
			this._close();
		}
	},

	close: function( event ) {
		this.cancelSearch = true;
		this._close( event );
	},

	_close: function( event ) {
		if ( this.menu.element.is( ":visible" ) ) {
			this.menu.element.hide();
			this.menu.blur();
			this.isNewMenu = true;
			this._trigger( "close", event );
		}
	},

	_change: function( event ) {
		if ( this.previous !== this._value() ) {
			this._trigger( "change", event, { item: this.selectedItem } );
		}
	},

	_normalize: function( items ) {
		// assume all items have the right format when the first item is complete
		if ( items.length && items[ 0 ].label && items[ 0 ].value ) {
			return items;
		}
		return $.map( items, function( item ) {
			if ( typeof item === "string" ) {
				return {
					label: item,
					value: item
				};
			}
			return $.extend( {}, item, {
				label: item.label || item.value,
				value: item.value || item.label
			});
		});
	},

	_suggest: function( items ) {
		var ul = this.menu.element.empty();
		this._renderMenu( ul, items );
		this.isNewMenu = true;
		this.menu.refresh();

		// size and position menu
		ul.show();
		this._resizeMenu();
		ul.position( $.extend({
			of: this.element
		}, this.options.position ) );

		if ( this.options.autoFocus ) {
			this.menu.next();
		}
	},

	_resizeMenu: function() {
		var ul = this.menu.element;
		ul.outerWidth( Math.max(
			// Firefox wraps long text (possibly a rounding bug)
			// so we add 1px to avoid the wrapping (#7513)
			ul.width( "" ).outerWidth() + 1,
			this.element.outerWidth()
		) );
	},

	_renderMenu: function( ul, items ) {
		var that = this;
		$.each( items, function( index, item ) {
			that._renderItemData( ul, item );
		});
	},

	_renderItemData: function( ul, item ) {
		return this._renderItem( ul, item ).data( "ui-autocomplete-item", item );
	},

	_renderItem: function( ul, item ) {
		return $( "<li>" ).text( item.label ).appendTo( ul );
	},

	_move: function( direction, event ) {
		if ( !this.menu.element.is( ":visible" ) ) {
			this.search( null, event );
			return;
		}
		if ( this.menu.isFirstItem() && /^previous/.test( direction ) ||
				this.menu.isLastItem() && /^next/.test( direction ) ) {

			if ( !this.isMultiLine ) {
				this._value( this.term );
			}

			this.menu.blur();
			return;
		}
		this.menu[ direction ]( event );
	},

	widget: function() {
		return this.menu.element;
	},

	_value: function() {
		return this.valueMethod.apply( this.element, arguments );
	},

	_keyEvent: function( keyEvent, event ) {
		if ( !this.isMultiLine || this.menu.element.is( ":visible" ) ) {
			this._move( keyEvent, event );

			// prevents moving cursor to beginning/end of the text field in some browsers
			event.preventDefault();
		}
	}
});

$.extend( $.ui.autocomplete, {
	escapeRegex: function( value ) {
		return value.replace( /[\-\[\]{}()*+?.,\\\^$|#\s]/g, "\\$&" );
	},
	filter: function( array, term ) {
		var matcher = new RegExp( $.ui.autocomplete.escapeRegex( term ), "i" );
		return $.grep( array, function( value ) {
			return matcher.test( value.label || value.value || value );
		});
	}
});

// live region extension, adding a `messages` option
// NOTE: This is an experimental API. We are still investigating
// a full solution for string manipulation and internationalization.
$.widget( "ui.autocomplete", $.ui.autocomplete, {
	options: {
		messages: {
			noResults: "No search results.",
			results: function( amount ) {
				return amount + ( amount > 1 ? " results are" : " result is" ) +
					" available, use up and down arrow keys to navigate.";
			}
		}
	},

	__response: function( content ) {
		var message;
		this._superApply( arguments );
		if ( this.options.disabled || this.cancelSearch ) {
			return;
		}
		if ( content && content.length ) {
			message = this.options.messages.results( content.length );
		} else {
			message = this.options.messages.noResults;
		}
		this.liveRegion.children().hide();
		$( "<div>" ).text( message ).appendTo( this.liveRegion );
	}
});

var autocomplete = $.ui.autocomplete;



}));
/**
 * jquery.multisortable.js - v0.2
 * https://github.com/shvetsgroup/jquery.multisortable
 *
 * Author: Ethan Atlakson, Jay Hayes, Gabriel Such, Alexander Shvets
 * Last Revision 3/16/2012
 * multi-selectable, multi-sortable jQuery plugin
 */


!function($) {

	$.fn.multiselectable = function(options) {
		if (!options) {
			options = {}
		}
		options = $.extend({}, $.fn.multiselectable.defaults, options);

		function mouseDown(e) {
			var item = $(this),
				parent = item.parent(),
				myIndex = item.index();

			var prev = parent.find('.multiselectable-previous');
			// If no previous selection found, start selecting from first selected item.
			prev = prev.length ? prev : $(parent.find('.' + options.selectedClass)[0]).addClass('multiselectable-previous');
			var prevIndex = prev.index();

			if (e.ctrlKey || e.metaKey) {
				if (item.hasClass(options.selectedClass)) {
					item.removeClass(options.selectedClass).removeClass('multiselectable-previous')
					if (item.not('.child').length) {
						item.nextUntil(':not(.child)').removeClass(options.selectedClass);
					}
				}
				else {
					parent.find('.multiselectable-previous').removeClass('multiselectable-previous');
					item.addClass(options.selectedClass).addClass('multiselectable-previous')
					if (item.not('.child').length) {
						item.nextUntil(':not(.child)').addClass(options.selectedClass);
					}
				}
			}

			if (e.shiftKey) {
				var last_shift_range = parent.find('.multiselectable-shift');
				last_shift_range.removeClass(options.selectedClass).removeClass('multiselectable-shift');

				var shift_range;
				if (prevIndex < myIndex) {
					shift_range = item.prevUntil('.multiselectable-previous').add(prev).add(item);
				}
				else if (prevIndex > myIndex) {
					shift_range = item.nextUntil('.multiselectable-previous').add(prev).add(item);
				}
				shift_range.addClass(options.selectedClass).addClass('multiselectable-shift');
			}
			else {
				parent.find('.multiselectable-shift').removeClass('multiselectable-shift');
			}

			if (!e.ctrlKey && !e.metaKey && !e.shiftKey) {
				parent.find('.multiselectable-previous').removeClass('multiselectable-previous');
				if (!item.hasClass(options.selectedClass)) {
					parent.find('.' + options.selectedClass).removeClass(options.selectedClass);
					item.addClass(options.selectedClass).addClass('multiselectable-previous');
					if (item.not('.child').length) {
						item.nextUntil(':not(.child)').addClass(options.selectedClass);
					}
				}
			}

			options.mousedown(e, item);
		}

		function click(e) {
			if ( $(this).is('.ui-draggable-dragging') ) {
				return;
			}

			var item = $(this),	parent = item.parent();

			// If item wasn't draged and is not multiselected, it should reset selection for other items.
			if (!e.ctrlKey && !e.metaKey && !e.shiftKey) {
				parent.find('.multiselectable-previous').removeClass('multiselectable-previous');
				parent.find('.' + options.selectedClass).removeClass(options.selectedClass);
				item.addClass(options.selectedClass).addClass('multiselectable-previous');
				if (item.not('.child').length) {
					item.nextUntil(':not(.child)').addClass(options.selectedClass);
				}
			}

			options.click(e, item);
		}

		return this.each(function() {
			var list = $(this);

			if (!list.data('multiselectable')) {
				list.data('multiselectable', true)
					.delegate(options.items, 'mousedown', mouseDown)
					.delegate(options.items, 'click', click)
					.disableSelection();
			}
		})
	};

	$.fn.multiselectable.defaults = {
		click: function(event, elem) {},
		mousedown: function(event, elem) {},
		selectedClass: 'selected',
		items: 'li'
	};


	$.fn.multisortable = function(options) {
		if (!options) {
			options = {}
		}
		var settings = $.extend({}, $.fn.multisortable.defaults, options);

		function regroup(item, list) {
			if (list.find('.' + settings.selectedClass).length > 0) {
				var myIndex = item.data('i');

				var itemsBefore = list.find('.' + settings.selectedClass).filter(function() {
					return $(this).data('i') < myIndex
				}).css({
						position: '',
						width: '',
						left: '',
						top: '',
						zIndex: ''
					});

				item.before(itemsBefore);

				var itemsAfter = list.find('.' + settings.selectedClass).filter(function() {
					return $(this).data('i') > myIndex
				}).css({
						position: '',
						width: '',
						left: '',
						top: '',
						zIndex: ''
					});

				item.after(itemsAfter);

				setTimeout(function() {
					itemsAfter.add(itemsBefore).addClass(settings.selectedClass);
				}, 0);
			}
		}

		return this.each(function() {
			var list = $(this);

			//enable multi-selection
			list.multiselectable({
				selectedClass: settings.selectedClass,
				click: settings.click,
				items: settings.items,
				mousedown: settings.mousedown
			});

			//enable sorting
			options.cancel = settings.items + ':not(.' + settings.selectedClass + ')';
			options.placeholder = settings.placeholder;
			options.start = function(event, ui) {
				if (ui.item.hasClass(settings.selectedClass)) {
					var parent = ui.item.parent();

					//assign indexes to all selected items
					parent.find('.' + settings.selectedClass).each(function(i) {
						$(this).data('i', i);
					});

					// adjust placeholder size to be size of items
					var height = parent.find('.' + settings.selectedClass).length * ui.item.outerHeight();
					ui.placeholder.height(height);
				}

				settings.start(event, ui);
			};

			options.stop = function(event, ui) {
				regroup(ui.item, ui.item.parent());
				settings.stop(event, ui);
			};

			options.sort = function(event, ui) {
				var parent = ui.item.parent(),
					myIndex = ui.item.data('i'),
					top = parseInt(ui.item.css('top').replace('px', '')),
					left = parseInt(ui.item.css('left').replace('px', ''));

				// fix to keep compatibility using prototype.js and jquery together
				$.fn.reverse = Array.prototype._reverse || Array.prototype.reverse

				var height = 0;
				$('.' + settings.selectedClass, parent).filter(function() {
					return $(this).data('i') < myIndex;
				}).reverse().each(function() {
						height += $(this).outerHeight();
						$(this).css({
							left: left,
							top: top - height,
							position: 'absolute',
							zIndex: 1000,
							width: ui.item.width()
						})
					});

				height = ui.item.outerHeight();
				$('.' + settings.selectedClass, parent).filter(function() {
					return $(this).data('i') > myIndex;
				}).each(function() {
						var item = $(this);
						item.css({
							left: left,
							top: top + height,
							position: 'absolute',
							zIndex: 1000,
							width: ui.item.width()
						});

						height += item.outerHeight();
					});

				settings.sort(event, ui);
			};

			options.receive = function(event, ui) {
				regroup(ui.item, ui.sender);
				settings.receive(event, ui);
			};

			list.sortable(options).disableSelection();
		})
	};

	$.fn.multisortable.defaults = {
		start: function(event, ui) {},
		stop: function(event, ui) {},
		sort: function(event, ui) {},
		receive: function(event, ui) {},
		click: function(event, elem) {},
		mousedown: function(event, elem) {},
		selectedClass: 'selected',
		placeholder: 'placeholder',
		items: 'li'
	};

}(jQuery);
if (!window.console && !document.console) {
  window.console = {
    log: function() {}
  }
}
;
// https://github.com/mwalsher/actioncable-js
(function() {
  var slice = [].slice;

  this.ActionCable = {
    INTERNAL: {
      "message_types": {
        "welcome": "welcome",
        "ping": "ping",
        "confirmation": "confirm_subscription",
        "rejection": "reject_subscription"
      },
      "default_mount_path": "/cable",
      "protocols": ["actioncable-v1-json", "actioncable-unsupported"]
    },
    createConsumer: function(url) {
      var ref;
      if (url == null) {
        url = (ref = this.getConfig("url")) != null ? ref : this.INTERNAL.default_mount_path;
      }
      return new ActionCable.Consumer(this.createWebSocketURL(url));
    },
    getConfig: function(name) {
      var element;
      element = document.head.querySelector("meta[name='action-cable-" + name + "']");
      return element != null ? element.getAttribute("content") : void 0;
    },
    createWebSocketURL: function(url) {
      var a;
      if (url && !/^wss?:/i.test(url)) {
        a = document.createElement("a");
        a.href = url;
        a.href = a.href;
        a.protocol = a.protocol.replace("http", "ws");
        return a.href;
      } else {
        return url;
      }
    },
    startDebugging: function() {
      return this.debugging = true;
    },
    stopDebugging: function() {
      return this.debugging = null;
    },
    log: function() {
      var messages;
      messages = 1 <= arguments.length ? slice.call(arguments, 0) : [];
      if (this.debugging) {
        messages.push(Date.now());
        return console.log.apply(console, ["[ActionCable]"].concat(slice.call(messages)));
      }
    }
  };

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  ActionCable.ConnectionMonitor = (function() {
    var clamp, now, secondsSince;

    ConnectionMonitor.pollInterval = {
      min: 3,
      max: 30
    };

    ConnectionMonitor.staleThreshold = 6;

    function ConnectionMonitor(connection) {
      this.connection = connection;
      this.visibilityDidChange = bind(this.visibilityDidChange, this);
      this.reconnectAttempts = 0;
    }

    ConnectionMonitor.prototype.start = function() {
      if (!this.isRunning()) {
        this.startedAt = now();
        delete this.stoppedAt;
        this.startPolling();
        document.addEventListener("visibilitychange", this.visibilityDidChange);
        return ActionCable.log("ConnectionMonitor started. pollInterval = " + (this.getPollInterval()) + " ms");
      }
    };

    ConnectionMonitor.prototype.stop = function() {
      if (this.isRunning()) {
        this.stoppedAt = now();
        this.stopPolling();
        document.removeEventListener("visibilitychange", this.visibilityDidChange);
        return ActionCable.log("ConnectionMonitor stopped");
      }
    };

    ConnectionMonitor.prototype.isRunning = function() {
      return (this.startedAt != null) && (this.stoppedAt == null);
    };

    ConnectionMonitor.prototype.recordPing = function() {
      return this.pingedAt = now();
    };

    ConnectionMonitor.prototype.recordConnect = function() {
      this.reconnectAttempts = 0;
      this.recordPing();
      delete this.disconnectedAt;
      return ActionCable.log("ConnectionMonitor recorded connect");
    };

    ConnectionMonitor.prototype.recordDisconnect = function() {
      this.disconnectedAt = now();
      return ActionCable.log("ConnectionMonitor recorded disconnect");
    };

    ConnectionMonitor.prototype.startPolling = function() {
      this.stopPolling();
      return this.poll();
    };

    ConnectionMonitor.prototype.stopPolling = function() {
      return clearTimeout(this.pollTimeout);
    };

    ConnectionMonitor.prototype.poll = function() {
      return this.pollTimeout = setTimeout((function(_this) {
        return function() {
          _this.reconnectIfStale();
          return _this.poll();
        };
      })(this), this.getPollInterval());
    };

    ConnectionMonitor.prototype.getPollInterval = function() {
      var interval, max, min, ref;
      ref = this.constructor.pollInterval, min = ref.min, max = ref.max;
      interval = 5 * Math.log(this.reconnectAttempts + 1);
      return Math.round(clamp(interval, min, max) * 1000);
    };

    ConnectionMonitor.prototype.reconnectIfStale = function() {
      if (this.connectionIsStale()) {
        ActionCable.log("ConnectionMonitor detected stale connection. reconnectAttempts = " + this.reconnectAttempts + ", pollInterval = " + (this.getPollInterval()) + " ms, time disconnected = " + (secondsSince(this.disconnectedAt)) + " s, stale threshold = " + this.constructor.staleThreshold + " s");
        this.reconnectAttempts++;
        if (this.disconnectedRecently()) {
          return ActionCable.log("ConnectionMonitor skipping reopening recent disconnect");
        } else {
          ActionCable.log("ConnectionMonitor reopening");
          return this.connection.reopen();
        }
      }
    };

    ConnectionMonitor.prototype.connectionIsStale = function() {
      var ref;
      return secondsSince((ref = this.pingedAt) != null ? ref : this.startedAt) > this.constructor.staleThreshold;
    };

    ConnectionMonitor.prototype.disconnectedRecently = function() {
      return this.disconnectedAt && secondsSince(this.disconnectedAt) < this.constructor.staleThreshold;
    };

    ConnectionMonitor.prototype.visibilityDidChange = function() {
      if (document.visibilityState === "visible") {
        return setTimeout((function(_this) {
          return function() {
            if (_this.connectionIsStale() || !_this.connection.isOpen()) {
              ActionCable.log("ConnectionMonitor reopening stale connection on visibilitychange. visbilityState = " + document.visibilityState);
              return _this.connection.reopen();
            }
          };
        })(this), 200);
      }
    };

    now = function() {
      return new Date().getTime();
    };

    secondsSince = function(time) {
      return (now() - time) / 1000;
    };

    clamp = function(number, min, max) {
      return Math.max(min, Math.min(max, number));
    };

    return ConnectionMonitor;

  })();

}).call(this);
(function() {
  var i, message_types, protocols, ref, supportedProtocols, unsupportedProtocol,
    slice = [].slice,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  ref = ActionCable.INTERNAL, message_types = ref.message_types, protocols = ref.protocols;

  supportedProtocols = 2 <= protocols.length ? slice.call(protocols, 0, i = protocols.length - 1) : (i = 0, []), unsupportedProtocol = protocols[i++];

  ActionCable.Connection = (function() {
    Connection.reopenDelay = 500;

    function Connection(consumer) {
      this.consumer = consumer;
      this.open = bind(this.open, this);
      this.subscriptions = this.consumer.subscriptions;
      this.monitor = new ActionCable.ConnectionMonitor(this);
      this.disconnected = true;
    }

    Connection.prototype.send = function(data) {
      if (this.isOpen()) {
        this.webSocket.send(JSON.stringify(data));
        return true;
      } else {
        return false;
      }
    };

    Connection.prototype.open = function() {
      if (this.isActive()) {
        ActionCable.log("Attempted to open WebSocket, but existing socket is " + (this.getState()));
        throw new Error("Existing connection must be closed before opening");
      } else {
        ActionCable.log("Opening WebSocket, current state is " + (this.getState()) + ", subprotocols: " + protocols);
        if (this.webSocket != null) {
          this.uninstallEventHandlers();
        }
        this.webSocket = new WebSocket(this.consumer.url, protocols);
        this.installEventHandlers();
        this.monitor.start();
        return true;
      }
    };

    Connection.prototype.close = function(arg) {
      var allowReconnect, ref1;
      allowReconnect = (arg != null ? arg : {
        allowReconnect: true
      }).allowReconnect;
      if (!allowReconnect) {
        this.monitor.stop();
      }
      if (this.isActive()) {
        return (ref1 = this.webSocket) != null ? ref1.close() : void 0;
      }
    };

    Connection.prototype.reopen = function() {
      var error, error1;
      ActionCable.log("Reopening WebSocket, current state is " + (this.getState()));
      if (this.isActive()) {
        try {
          return this.close();
        } catch (error1) {
          error = error1;
          return ActionCable.log("Failed to reopen WebSocket", error);
        } finally {
          ActionCable.log("Reopening WebSocket in " + this.constructor.reopenDelay + "ms");
          setTimeout(this.open, this.constructor.reopenDelay);
        }
      } else {
        return this.open();
      }
    };

    Connection.prototype.getProtocol = function() {
      var ref1;
      return (ref1 = this.webSocket) != null ? ref1.protocol : void 0;
    };

    Connection.prototype.isOpen = function() {
      return this.isState("open");
    };

    Connection.prototype.isActive = function() {
      return this.isState("open", "connecting");
    };

    Connection.prototype.isProtocolSupported = function() {
      var ref1;
      return ref1 = this.getProtocol(), indexOf.call(supportedProtocols, ref1) >= 0;
    };

    Connection.prototype.isState = function() {
      var ref1, states;
      states = 1 <= arguments.length ? slice.call(arguments, 0) : [];
      return ref1 = this.getState(), indexOf.call(states, ref1) >= 0;
    };

    Connection.prototype.getState = function() {
      var ref1, state, value;
      for (state in WebSocket) {
        value = WebSocket[state];
        if (value === ((ref1 = this.webSocket) != null ? ref1.readyState : void 0)) {
          return state.toLowerCase();
        }
      }
      return null;
    };

    Connection.prototype.installEventHandlers = function() {
      var eventName, handler;
      for (eventName in this.events) {
        handler = this.events[eventName].bind(this);
        this.webSocket["on" + eventName] = handler;
      }
    };

    Connection.prototype.uninstallEventHandlers = function() {
      var eventName;
      for (eventName in this.events) {
        this.webSocket["on" + eventName] = function() {};
      }
    };

    Connection.prototype.events = {
      message: function(event) {
        var identifier, message, ref1, type;
        if (!this.isProtocolSupported()) {
          return;
        }
        ref1 = JSON.parse(event.data), identifier = ref1.identifier, message = ref1.message, type = ref1.type;
        switch (type) {
          case message_types.welcome:
            this.monitor.recordConnect();
            return this.subscriptions.reload();
          case message_types.ping:
            return this.monitor.recordPing();
          case message_types.confirmation:
            return this.subscriptions.notify(identifier, "connected");
          case message_types.rejection:
            return this.subscriptions.reject(identifier);
          default:
            return this.subscriptions.notify(identifier, "received", message);
        }
      },
      open: function() {
        ActionCable.log("WebSocket onopen event, using '" + (this.getProtocol()) + "' subprotocol");
        this.disconnected = false;
        if (!this.isProtocolSupported()) {
          ActionCable.log("Protocol is unsupported. Stopping monitor and disconnecting.");
          return this.close({
            allowReconnect: false
          });
        }
      },
      close: function(event) {
        ActionCable.log("WebSocket onclose event");
        if (this.disconnected) {
          return;
        }
        this.disconnected = true;
        this.monitor.recordDisconnect();
        return this.subscriptions.notifyAll("disconnected", {
          willAttemptReconnect: this.monitor.isRunning()
        });
      },
      error: function() {
        return ActionCable.log("WebSocket onerror event");
      }
    };

    return Connection;

  })();

}).call(this);
(function() {
  var slice = [].slice;

  ActionCable.Subscriptions = (function() {
    function Subscriptions(consumer) {
      this.consumer = consumer;
      this.subscriptions = [];
    }

    Subscriptions.prototype.create = function(channelName, mixin) {
      var channel, params, subscription;
      channel = channelName;
      params = typeof channel === "object" ? channel : {
        channel: channel
      };
      subscription = new ActionCable.Subscription(this.consumer, params, mixin);
      return this.add(subscription);
    };

    Subscriptions.prototype.add = function(subscription) {
      this.subscriptions.push(subscription);
      this.consumer.ensureActiveConnection();
      this.notify(subscription, "initialized");
      this.sendCommand(subscription, "subscribe");
      return subscription;
    };

    Subscriptions.prototype.remove = function(subscription) {
      this.forget(subscription);
      if (!this.findAll(subscription.identifier).length) {
        this.sendCommand(subscription, "unsubscribe");
      }
      return subscription;
    };

    Subscriptions.prototype.reject = function(identifier) {
      var i, len, ref, results, subscription;
      ref = this.findAll(identifier);
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        subscription = ref[i];
        this.forget(subscription);
        this.notify(subscription, "rejected");
        results.push(subscription);
      }
      return results;
    };

    Subscriptions.prototype.forget = function(subscription) {
      var s;
      this.subscriptions = (function() {
        var i, len, ref, results;
        ref = this.subscriptions;
        results = [];
        for (i = 0, len = ref.length; i < len; i++) {
          s = ref[i];
          if (s !== subscription) {
            results.push(s);
          }
        }
        return results;
      }).call(this);
      return subscription;
    };

    Subscriptions.prototype.findAll = function(identifier) {
      var i, len, ref, results, s;
      ref = this.subscriptions;
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        s = ref[i];
        if (s.identifier === identifier) {
          results.push(s);
        }
      }
      return results;
    };

    Subscriptions.prototype.reload = function() {
      var i, len, ref, results, subscription;
      ref = this.subscriptions;
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        subscription = ref[i];
        results.push(this.sendCommand(subscription, "subscribe"));
      }
      return results;
    };

    Subscriptions.prototype.notifyAll = function() {
      var args, callbackName, i, len, ref, results, subscription;
      callbackName = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];
      ref = this.subscriptions;
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        subscription = ref[i];
        results.push(this.notify.apply(this, [subscription, callbackName].concat(slice.call(args))));
      }
      return results;
    };

    Subscriptions.prototype.notify = function() {
      var args, callbackName, i, len, results, subscription, subscriptions;
      subscription = arguments[0], callbackName = arguments[1], args = 3 <= arguments.length ? slice.call(arguments, 2) : [];
      if (typeof subscription === "string") {
        subscriptions = this.findAll(subscription);
      } else {
        subscriptions = [subscription];
      }
      results = [];
      for (i = 0, len = subscriptions.length; i < len; i++) {
        subscription = subscriptions[i];
        results.push(typeof subscription[callbackName] === "function" ? subscription[callbackName].apply(subscription, args) : void 0);
      }
      return results;
    };

    Subscriptions.prototype.sendCommand = function(subscription, command) {
      var identifier;
      identifier = subscription.identifier;
      return this.consumer.send({
        command: command,
        identifier: identifier
      });
    };

    return Subscriptions;

  })();

}).call(this);
(function() {
  ActionCable.Subscription = (function() {
    var extend;

    function Subscription(consumer, params, mixin) {
      this.consumer = consumer;
      if (params == null) {
        params = {};
      }
      this.identifier = JSON.stringify(params);
      extend(this, mixin);
    }

    Subscription.prototype.perform = function(action, data) {
      if (data == null) {
        data = {};
      }
      data.action = action;
      return this.send(data);
    };

    Subscription.prototype.send = function(data) {
      return this.consumer.send({
        command: "message",
        identifier: this.identifier,
        data: JSON.stringify(data)
      });
    };

    Subscription.prototype.unsubscribe = function() {
      return this.consumer.subscriptions.remove(this);
    };

    extend = function(object, properties) {
      var key, value;
      if (properties != null) {
        for (key in properties) {
          value = properties[key];
          object[key] = value;
        }
      }
      return object;
    };

    return Subscription;

  })();

}).call(this);
(function() {
  ActionCable.Consumer = (function() {
    function Consumer(url) {
      this.url = url;
      this.subscriptions = new ActionCable.Subscriptions(this);
      this.connection = new ActionCable.Connection(this);
    }

    Consumer.prototype.send = function(data) {
      return this.connection.send(data);
    };

    Consumer.prototype.connect = function() {
      return this.connection.open();
    };

    Consumer.prototype.disconnect = function() {
      return this.connection.close({
        allowReconnect: false
      });
    };

    Consumer.prototype.ensureActiveConnection = function() {
      if (!this.connection.isActive()) {
        return this.connection.open();
      }
    };

    return Consumer;

  })();

}).call(this);
(function() {
  var Bacon, BufferingSource, Bus, CompositeUnsubscribe, ConsumingSource, Desc, Dispatcher, End, Error, Event, EventStream, Initial, Next, None, Observable, Property, PropertyDispatcher, Some, Source, UpdateBarrier, addPropertyInitValueToStream, assert, assertArray, assertEventStream, assertFunction, assertNoArguments, assertString, cloneArray, compositeUnsubscribe, containsDuplicateDeps, convertArgsToFunction, describe, end, eventIdCounter, findDeps, flatMap_, former, idCounter, initial, isArray, isFieldKey, isFunction, isObservable, latterF, liftCallback, makeFunction, makeFunctionArgs, makeFunction_, makeObservable, makeSpawner, next, nop, partiallyApplied, recursionDepth, registerObs, spys, toCombinator, toEvent, toFieldExtractor, toFieldKey, toOption, toSimpleExtractor, withDescription, withMethodCallSupport, _, _ref,
    __slice = [].slice,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  Bacon = {
    toString: function() {
      return "Bacon";
    }
  };

  Bacon.version = '0.7.16';

  Bacon.fromBinder = function(binder, eventTransformer) {
    if (eventTransformer == null) {
      eventTransformer = _.id;
    }
    return new EventStream(describe(Bacon, "fromBinder", binder, eventTransformer), function(sink) {
      var unbinder;
      return unbinder = binder(function() {
        var args, event, reply, value, _i, _len;
        args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
        value = eventTransformer.apply(null, args);
        if (!(isArray(value) && _.last(value) instanceof Event)) {
          value = [value];
        }
        reply = Bacon.more;
        for (_i = 0, _len = value.length; _i < _len; _i++) {
          event = value[_i];
          reply = sink(event = toEvent(event));
          if (reply === Bacon.noMore || event.isEnd()) {
            if (unbinder != null) {
              unbinder();
            } else {
              Bacon.scheduler.setTimeout((function() {
                return unbinder();
              }), 0);
            }
            return reply;
          }
        }
        return reply;
      });
    });
  };

  Bacon.$ = {
    asEventStream: function(eventName, selector, eventTransformer) {
      var _ref;
      if (isFunction(selector)) {
        _ref = [selector, null], eventTransformer = _ref[0], selector = _ref[1];
      }
      return withDescription(this.selector || this, "asEventStream", eventName, Bacon.fromBinder((function(_this) {
        return function(handler) {
          _this.on(eventName, selector, handler);
          return function() {
            return _this.off(eventName, selector, handler);
          };
        };
      })(this), eventTransformer));
    }
  };

  if ((_ref = typeof jQuery !== "undefined" && jQuery !== null ? jQuery : typeof Zepto !== "undefined" && Zepto !== null ? Zepto : null) != null) {
    _ref.fn.asEventStream = Bacon.$.asEventStream;
  }

  Bacon.fromEventTarget = function(target, eventName, eventTransformer) {
    var sub, unsub, _ref1, _ref2, _ref3, _ref4;
    sub = (_ref1 = target.addEventListener) != null ? _ref1 : (_ref2 = target.addListener) != null ? _ref2 : target.bind;
    unsub = (_ref3 = target.removeEventListener) != null ? _ref3 : (_ref4 = target.removeListener) != null ? _ref4 : target.unbind;
    return withDescription(Bacon, "fromEventTarget", target, eventName, Bacon.fromBinder(function(handler) {
      sub.call(target, eventName, handler);
      return function() {
        return unsub.call(target, eventName, handler);
      };
    }, eventTransformer));
  };

  Bacon.fromPromise = function(promise, abort) {
    return withDescription(Bacon, "fromPromise", promise, Bacon.fromBinder(function(handler) {
      promise.then(handler, function(e) {
        return handler(new Error(e));
      });
      return function() {
        if (abort) {
          return typeof promise.abort === "function" ? promise.abort() : void 0;
        }
      };
    }, (function(value) {
      return [value, end()];
    })));
  };

  Bacon.noMore = ["<no-more>"];

  Bacon.more = ["<more>"];

  Bacon.later = function(delay, value) {
    return withDescription(Bacon, "later", delay, value, Bacon.sequentially(delay, [value]));
  };

  Bacon.sequentially = function(delay, values) {
    var index;
    index = 0;
    return withDescription(Bacon, "sequentially", delay, values, Bacon.fromPoll(delay, function() {
      var value;
      value = values[index++];
      if (index < values.length) {
        return value;
      } else if (index === values.length) {
        return [value, end()];
      } else {
        return end();
      }
    }));
  };

  Bacon.repeatedly = function(delay, values) {
    var index;
    index = 0;
    return withDescription(Bacon, "repeatedly", delay, values, Bacon.fromPoll(delay, function() {
      return values[index++ % values.length];
    }));
  };

  Bacon.spy = function(spy) {
    return spys.push(spy);
  };

  spys = [];

  registerObs = function(obs) {
    var spy, _i, _len, _results;
    if (spys.length) {
      if (!registerObs.running) {
        try {
          registerObs.running = true;
          _results = [];
          for (_i = 0, _len = spys.length; _i < _len; _i++) {
            spy = spys[_i];
            _results.push(spy(obs));
          }
          return _results;
        } finally {
          delete registerObs.running;
        }
      }
    }
  };

  withMethodCallSupport = function(wrapped) {
    return function() {
      var args, context, f, methodName;
      f = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      if (typeof f === "object" && args.length) {
        context = f;
        methodName = args[0];
        f = function() {
          return context[methodName].apply(context, arguments);
        };
        args = args.slice(1);
      }
      return wrapped.apply(null, [f].concat(__slice.call(args)));
    };
  };

  liftCallback = function(desc, wrapped) {
    return withMethodCallSupport(function() {
      var args, f, stream;
      f = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      stream = partiallyApplied(wrapped, [
        function(values, callback) {
          return f.apply(null, __slice.call(values).concat([callback]));
        }
      ]);
      return withDescription.apply(null, [Bacon, desc, f].concat(__slice.call(args), [Bacon.combineAsArray(args).flatMap(stream)]));
    });
  };

  Bacon.fromCallback = liftCallback("fromCallback", function() {
    var args, f;
    f = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    return Bacon.fromBinder(function(handler) {
      makeFunction(f, args)(handler);
      return nop;
    }, (function(value) {
      return [value, end()];
    }));
  });

  Bacon.fromNodeCallback = liftCallback("fromNodeCallback", function() {
    var args, f;
    f = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    return Bacon.fromBinder(function(handler) {
      makeFunction(f, args)(handler);
      return nop;
    }, function(error, value) {
      if (error) {
        return [new Error(error), end()];
      }
      return [value, end()];
    });
  });

  Bacon.fromPoll = function(delay, poll) {
    return withDescription(Bacon, "fromPoll", delay, poll, Bacon.fromBinder((function(handler) {
      var id;
      id = Bacon.scheduler.setInterval(handler, delay);
      return function() {
        return Bacon.scheduler.clearInterval(id);
      };
    }), poll));
  };

  Bacon.interval = function(delay, value) {
    if (value == null) {
      value = {};
    }
    return withDescription(Bacon, "interval", delay, value, Bacon.fromPoll(delay, function() {
      return next(value);
    }));
  };

  Bacon.constant = function(value) {
    return new Property(describe(Bacon, "constant", value), function(sink) {
      sink(initial(value));
      sink(end());
      return nop;
    });
  };

  Bacon.never = function() {
    return withDescription(Bacon, "never", Bacon.fromArray([]));
  };

  Bacon.once = function(value) {
    return withDescription(Bacon, "once", value, Bacon.fromArray([value]));
  };

  Bacon.fromArray = function(values) {
    assertArray(values);
    values = cloneArray(values);
    return new EventStream(describe(Bacon, "fromArray", values), function(sink) {
      var reply, unsubd, value;
      unsubd = false;
      reply = Bacon.more;
      while ((reply !== Bacon.noMore) && !unsubd) {
        if (_.empty(values)) {
          sink(end());
          reply = Bacon.noMore;
        } else {
          value = values.splice(0, 1)[0];
          reply = sink(toEvent(value));
        }
      }
      return function() {
        return unsubd = true;
      };
    });
  };

  Bacon.mergeAll = function() {
    var streams;
    streams = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    if (isArray(streams[0])) {
      streams = streams[0];
    }
    if (streams.length) {
      return new EventStream(describe.apply(null, [Bacon, "mergeAll"].concat(__slice.call(streams))), function(sink) {
        var ends, sinks, smartSink;
        ends = 0;
        smartSink = function(obs) {
          return function(unsubBoth) {
            return obs.subscribeInternal(function(event) {
              var reply;
              if (event.isEnd()) {
                ends++;
                if (ends === streams.length) {
                  return sink(end());
                } else {
                  return Bacon.more;
                }
              } else {
                reply = sink(event);
                if (reply === Bacon.noMore) {
                  unsubBoth();
                }
                return reply;
              }
            });
          };
        };
        sinks = _.map(smartSink, streams);
        return compositeUnsubscribe.apply(null, sinks);
      });
    } else {
      return Bacon.never();
    }
  };

  Bacon.zipAsArray = function() {
    var streams;
    streams = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    if (isArray(streams[0])) {
      streams = streams[0];
    }
    return withDescription.apply(null, [Bacon, "zipAsArray"].concat(__slice.call(streams), [Bacon.zipWith(streams, function() {
      var xs;
      xs = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      return xs;
    })]));
  };

  Bacon.zipWith = function() {
    var f, streams, _ref1;
    f = arguments[0], streams = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    if (!isFunction(f)) {
      _ref1 = [f, streams[0]], streams = _ref1[0], f = _ref1[1];
    }
    streams = _.map((function(s) {
      return s.toEventStream();
    }), streams);
    return withDescription.apply(null, [Bacon, "zipWith", f].concat(__slice.call(streams), [Bacon.when(streams, f)]));
  };

  Bacon.groupSimultaneous = function() {
    var s, sources, streams;
    streams = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    if (streams.length === 1 && isArray(streams[0])) {
      streams = streams[0];
    }
    sources = (function() {
      var _i, _len, _results;
      _results = [];
      for (_i = 0, _len = streams.length; _i < _len; _i++) {
        s = streams[_i];
        _results.push(new BufferingSource(s));
      }
      return _results;
    })();
    return withDescription.apply(null, [Bacon, "groupSimultaneous"].concat(__slice.call(streams), [Bacon.when(sources, (function() {
      var xs;
      xs = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      return xs;
    }))]));
  };

  Bacon.combineAsArray = function() {
    var index, s, sources, stream, streams, _i, _len;
    streams = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    if (streams.length === 1 && isArray(streams[0])) {
      streams = streams[0];
    }
    for (index = _i = 0, _len = streams.length; _i < _len; index = ++_i) {
      stream = streams[index];
      if (!(isObservable(stream))) {
        streams[index] = Bacon.constant(stream);
      }
    }
    if (streams.length) {
      sources = (function() {
        var _j, _len1, _results;
        _results = [];
        for (_j = 0, _len1 = streams.length; _j < _len1; _j++) {
          s = streams[_j];
          _results.push(new Source(s, true, s.subscribeInternal));
        }
        return _results;
      })();
      return withDescription.apply(null, [Bacon, "combineAsArray"].concat(__slice.call(streams), [Bacon.when(sources, (function() {
        var xs;
        xs = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
        return xs;
      })).toProperty()]));
    } else {
      return Bacon.constant([]);
    }
  };

  Bacon.onValues = function() {
    var f, streams, _i;
    streams = 2 <= arguments.length ? __slice.call(arguments, 0, _i = arguments.length - 1) : (_i = 0, []), f = arguments[_i++];
    return Bacon.combineAsArray(streams).onValues(f);
  };

  Bacon.combineWith = function() {
    var f, streams;
    f = arguments[0], streams = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    return withDescription.apply(null, [Bacon, "combineWith", f].concat(__slice.call(streams), [Bacon.combineAsArray(streams).map(function(values) {
      return f.apply(null, values);
    })]));
  };

  Bacon.combineTemplate = function(template) {
    var applyStreamValue, combinator, compile, compileTemplate, constantValue, current, funcs, mkContext, setValue, streams;
    funcs = [];
    streams = [];
    current = function(ctxStack) {
      return ctxStack[ctxStack.length - 1];
    };
    setValue = function(ctxStack, key, value) {
      return current(ctxStack)[key] = value;
    };
    applyStreamValue = function(key, index) {
      return function(ctxStack, values) {
        return setValue(ctxStack, key, values[index]);
      };
    };
    constantValue = function(key, value) {
      return function(ctxStack) {
        return setValue(ctxStack, key, value);
      };
    };
    mkContext = function(template) {
      if (isArray(template)) {
        return [];
      } else {
        return {};
      }
    };
    compile = function(key, value) {
      var popContext, pushContext;
      if (isObservable(value)) {
        streams.push(value);
        return funcs.push(applyStreamValue(key, streams.length - 1));
      } else if (value === Object(value) && typeof value !== "function" && !(value instanceof RegExp) && !(value instanceof Date)) {
        pushContext = function(key) {
          return function(ctxStack) {
            var newContext;
            newContext = mkContext(value);
            setValue(ctxStack, key, newContext);
            return ctxStack.push(newContext);
          };
        };
        popContext = function(ctxStack) {
          return ctxStack.pop();
        };
        funcs.push(pushContext(key));
        compileTemplate(value);
        return funcs.push(popContext);
      } else {
        return funcs.push(constantValue(key, value));
      }
    };
    compileTemplate = function(template) {
      return _.each(template, compile);
    };
    compileTemplate(template);
    combinator = function(values) {
      var ctxStack, f, rootContext, _i, _len;
      rootContext = mkContext(template);
      ctxStack = [rootContext];
      for (_i = 0, _len = funcs.length; _i < _len; _i++) {
        f = funcs[_i];
        f(ctxStack, values);
      }
      return rootContext;
    };
    return withDescription(Bacon, "combineTemplate", template, Bacon.combineAsArray(streams).map(combinator));
  };

  Bacon.retry = function(options) {
    var delay, isRetryable, maxRetries, retries, retry, source;
    if (!isFunction(options.source)) {
      throw "'source' option has to be a function";
    }
    source = options.source;
    retries = options.retries || 0;
    maxRetries = options.maxRetries || retries;
    delay = options.delay || function() {
      return 0;
    };
    isRetryable = options.isRetryable || function() {
      return true;
    };
    retry = function(context) {
      var delayedRetry, nextAttemptOptions;
      nextAttemptOptions = {
        source: source,
        retries: retries - 1,
        maxRetries: maxRetries,
        delay: delay,
        isRetryable: isRetryable
      };
      delayedRetry = function() {
        return Bacon.retry(nextAttemptOptions);
      };
      return Bacon.later(delay(context)).filter(false).concat(Bacon.once().flatMap(delayedRetry));
    };
    return withDescription(Bacon, "retry", options, source().flatMapError(function(e) {
      if (isRetryable(e) && retries > 0) {
        return retry({
          error: e,
          retriesDone: maxRetries - retries
        });
      } else {
        return Bacon.once(new Bacon.Error(e));
      }
    }));
  };

  eventIdCounter = 0;

  Event = (function() {
    function Event() {
      this.id = ++eventIdCounter;
    }

    Event.prototype.isEvent = function() {
      return true;
    };

    Event.prototype.isEnd = function() {
      return false;
    };

    Event.prototype.isInitial = function() {
      return false;
    };

    Event.prototype.isNext = function() {
      return false;
    };

    Event.prototype.isError = function() {
      return false;
    };

    Event.prototype.hasValue = function() {
      return false;
    };

    Event.prototype.filter = function() {
      return true;
    };

    Event.prototype.inspect = function() {
      return this.toString();
    };

    Event.prototype.log = function() {
      return this.toString();
    };

    return Event;

  })();

  Next = (function(_super) {
    __extends(Next, _super);

    function Next(valueF) {
      Next.__super__.constructor.call(this);
      if (isFunction(valueF)) {
        this.value = _.cached(valueF);
      } else {
        this.value = _.always(valueF);
      }
    }

    Next.prototype.isNext = function() {
      return true;
    };

    Next.prototype.hasValue = function() {
      return true;
    };

    Next.prototype.fmap = function(f) {
      var value;
      value = this.value;
      return this.apply(function() {
        return f(value());
      });
    };

    Next.prototype.apply = function(value) {
      return new Next(value);
    };

    Next.prototype.filter = function(f) {
      return f(this.value());
    };

    Next.prototype.toString = function() {
      return _.toString(this.value());
    };

    Next.prototype.log = function() {
      return this.value();
    };

    return Next;

  })(Event);

  Initial = (function(_super) {
    __extends(Initial, _super);

    function Initial() {
      return Initial.__super__.constructor.apply(this, arguments);
    }

    Initial.prototype.isInitial = function() {
      return true;
    };

    Initial.prototype.isNext = function() {
      return false;
    };

    Initial.prototype.apply = function(value) {
      return new Initial(value);
    };

    Initial.prototype.toNext = function() {
      return new Next(this.value);
    };

    return Initial;

  })(Next);

  End = (function(_super) {
    __extends(End, _super);

    function End() {
      return End.__super__.constructor.apply(this, arguments);
    }

    End.prototype.isEnd = function() {
      return true;
    };

    End.prototype.fmap = function() {
      return this;
    };

    End.prototype.apply = function() {
      return this;
    };

    End.prototype.toString = function() {
      return "<end>";
    };

    return End;

  })(Event);

  Error = (function(_super) {
    __extends(Error, _super);

    function Error(error) {
      this.error = error;
    }

    Error.prototype.isError = function() {
      return true;
    };

    Error.prototype.fmap = function() {
      return this;
    };

    Error.prototype.apply = function() {
      return this;
    };

    Error.prototype.toString = function() {
      return "<error> " + _.toString(this.error);
    };

    return Error;

  })(Event);

  idCounter = 0;

  Observable = (function() {
    function Observable(desc) {
      this.flatMapError = __bind(this.flatMapError, this);
      this.id = ++idCounter;
      withDescription(desc, this);
    }

    Observable.prototype.onValue = function() {
      var f;
      f = makeFunctionArgs(arguments);
      return this.subscribe(function(event) {
        if (event.hasValue()) {
          return f(event.value());
        }
      });
    };

    Observable.prototype.onValues = function(f) {
      return this.onValue(function(args) {
        return f.apply(null, args);
      });
    };

    Observable.prototype.onError = function() {
      var f;
      f = makeFunctionArgs(arguments);
      return this.subscribe(function(event) {
        if (event.isError()) {
          return f(event.error);
        }
      });
    };

    Observable.prototype.onEnd = function() {
      var f;
      f = makeFunctionArgs(arguments);
      return this.subscribe(function(event) {
        if (event.isEnd()) {
          return f();
        }
      });
    };

    Observable.prototype.errors = function() {
      return withDescription(this, "errors", this.filter(function() {
        return false;
      }));
    };

    Observable.prototype.filter = function() {
      var args, f;
      f = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      return convertArgsToFunction(this, f, args, function(f) {
        return withDescription(this, "filter", f, this.withHandler(function(event) {
          if (event.filter(f)) {
            return this.push(event);
          } else {
            return Bacon.more;
          }
        }));
      });
    };

    Observable.prototype.takeWhile = function() {
      var args, f;
      f = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      return convertArgsToFunction(this, f, args, function(f) {
        return withDescription(this, "takeWhile", f, this.withHandler(function(event) {
          if (event.filter(f)) {
            return this.push(event);
          } else {
            this.push(end());
            return Bacon.noMore;
          }
        }));
      });
    };

    Observable.prototype.endOnError = function() {
      var args, f;
      f = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      if (f == null) {
        f = true;
      }
      return convertArgsToFunction(this, f, args, function(f) {
        return withDescription(this, "endOnError", this.withHandler(function(event) {
          if (event.isError() && f(event.error)) {
            this.push(event);
            return this.push(end());
          } else {
            return this.push(event);
          }
        }));
      });
    };

    Observable.prototype.take = function(count) {
      if (count <= 0) {
        return Bacon.never();
      }
      return withDescription(this, "take", count, this.withHandler(function(event) {
        if (!event.hasValue()) {
          return this.push(event);
        } else {
          count--;
          if (count > 0) {
            return this.push(event);
          } else {
            if (count === 0) {
              this.push(event);
            }
            this.push(end());
            return Bacon.noMore;
          }
        }
      }));
    };

    Observable.prototype.map = function() {
      var args, p;
      p = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      if (p instanceof Property) {
        return p.sampledBy(this, former);
      } else {
        return convertArgsToFunction(this, p, args, function(f) {
          return withDescription(this, "map", f, this.withHandler(function(event) {
            return this.push(event.fmap(f));
          }));
        });
      }
    };

    Observable.prototype.mapError = function() {
      var f;
      f = makeFunctionArgs(arguments);
      return withDescription(this, "mapError", f, this.withHandler(function(event) {
        if (event.isError()) {
          return this.push(next(f(event.error)));
        } else {
          return this.push(event);
        }
      }));
    };

    Observable.prototype.mapEnd = function() {
      var f;
      f = makeFunctionArgs(arguments);
      return withDescription(this, "mapEnd", f, this.withHandler(function(event) {
        if (event.isEnd()) {
          this.push(next(f(event)));
          this.push(end());
          return Bacon.noMore;
        } else {
          return this.push(event);
        }
      }));
    };

    Observable.prototype.doAction = function() {
      var f;
      f = makeFunctionArgs(arguments);
      return withDescription(this, "doAction", f, this.withHandler(function(event) {
        if (event.hasValue()) {
          f(event.value());
        }
        return this.push(event);
      }));
    };

    Observable.prototype.skip = function(count) {
      return withDescription(this, "skip", count, this.withHandler(function(event) {
        if (!event.hasValue()) {
          return this.push(event);
        } else if (count > 0) {
          count--;
          return Bacon.more;
        } else {
          return this.push(event);
        }
      }));
    };

    Observable.prototype.skipDuplicates = function(isEqual) {
      if (isEqual == null) {
        isEqual = function(a, b) {
          return a === b;
        };
      }
      return withDescription(this, "skipDuplicates", this.withStateMachine(None, function(prev, event) {
        if (!event.hasValue()) {
          return [prev, [event]];
        } else if (event.isInitial() || prev === None || !isEqual(prev.get(), event.value())) {
          return [new Some(event.value()), [event]];
        } else {
          return [prev, []];
        }
      }));
    };

    Observable.prototype.skipErrors = function() {
      return withDescription(this, "skipErrors", this.withHandler(function(event) {
        if (event.isError()) {
          return Bacon.more;
        } else {
          return this.push(event);
        }
      }));
    };

    Observable.prototype.withStateMachine = function(initState, f) {
      var state;
      state = initState;
      return withDescription(this, "withStateMachine", initState, f, this.withHandler(function(event) {
        var fromF, newState, output, outputs, reply, _i, _len;
        fromF = f(state, event);
        newState = fromF[0], outputs = fromF[1];
        state = newState;
        reply = Bacon.more;
        for (_i = 0, _len = outputs.length; _i < _len; _i++) {
          output = outputs[_i];
          reply = this.push(output);
          if (reply === Bacon.noMore) {
            return reply;
          }
        }
        return reply;
      }));
    };

    Observable.prototype.scan = function(seed, f, options) {
      var acc, f_, resultProperty, subscribe;
      if (options == null) {
        options = {};
      }
      f_ = toCombinator(f);
      f = options.lazyF ? f_ : function(x, y) {
        return f_(x(), y());
      };
      acc = toOption(seed).map(function(x) {
        return _.always(x);
      });
      subscribe = (function(_this) {
        return function(sink) {
          var initSent, reply, sendInit, unsub;
          initSent = false;
          unsub = nop;
          reply = Bacon.more;
          sendInit = function() {
            if (!initSent) {
              return acc.forEach(function(valueF) {
                initSent = true;
                reply = sink(new Initial(valueF));
                if (reply === Bacon.noMore) {
                  unsub();
                  return unsub = nop;
                }
              });
            }
          };
          unsub = _this.subscribeInternal(function(event) {
            var next, prev;
            if (event.hasValue()) {
              if (initSent && event.isInitial()) {
                return Bacon.more;
              } else {
                if (!event.isInitial()) {
                  sendInit();
                }
                initSent = true;
                prev = acc.getOrElse(function() {
                  return void 0;
                });
                next = _.cached(function() {
                  return f(prev, event.value);
                });
                acc = new Some(next);
                if (options.eager) {
                  next();
                }
                return sink(event.apply(next));
              }
            } else {
              if (event.isEnd()) {
                reply = sendInit();
              }
              if (reply !== Bacon.noMore) {
                return sink(event);
              }
            }
          });
          UpdateBarrier.whenDoneWith(resultProperty, sendInit);
          return unsub;
        };
      })(this);
      return resultProperty = new Property(describe(this, "scan", seed, f), subscribe);
    };

    Observable.prototype.fold = function(seed, f, options) {
      return withDescription(this, "fold", seed, f, this.scan(seed, f, options).sampledBy(this.filter(false).mapEnd().toProperty()));
    };

    Observable.prototype.zip = function(other, f) {
      if (f == null) {
        f = Array;
      }
      return withDescription(this, "zip", other, Bacon.zipWith([this, other], f));
    };

    Observable.prototype.diff = function(start, f) {
      f = toCombinator(f);
      return withDescription(this, "diff", start, f, this.scan([start], function(prevTuple, next) {
        return [next, f(prevTuple[0], next)];
      }).filter(function(tuple) {
        return tuple.length === 2;
      }).map(function(tuple) {
        return tuple[1];
      }));
    };

    Observable.prototype.flatMap = function() {
      return flatMap_(this, makeSpawner(arguments));
    };

    Observable.prototype.flatMapFirst = function() {
      return flatMap_(this, makeSpawner(arguments), true);
    };

    Observable.prototype.flatMapWithConcurrencyLimit = function() {
      var args, limit;
      limit = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      return withDescription.apply(null, [this, "flatMapWithConcurrencyLimit", limit].concat(__slice.call(args), [flatMap_(this, makeSpawner(args), false, limit)]));
    };

    Observable.prototype.flatMapLatest = function() {
      var f, stream;
      f = makeSpawner(arguments);
      stream = this.toEventStream();
      return withDescription(this, "flatMapLatest", f, stream.flatMap(function(value) {
        return makeObservable(f(value)).takeUntil(stream);
      }));
    };

    Observable.prototype.flatMapError = function(fn) {
      return withDescription(this, "flatMapError", fn, this.mapError(function(err) {
        return new Bacon.Error(err);
      }).flatMap(function(x) {
        if (x instanceof Bacon.Error) {
          return fn(x.error);
        } else {
          return Bacon.once(x);
        }
      }));
    };

    Observable.prototype.flatMapConcat = function() {
      return withDescription.apply(null, [this, "flatMapConcat"].concat(__slice.call(arguments), [this.flatMapWithConcurrencyLimit.apply(this, [1].concat(__slice.call(arguments)))]));
    };

    Observable.prototype.bufferingThrottle = function(minimumInterval) {
      return withDescription(this, "bufferingThrottle", minimumInterval, this.flatMapConcat(function(x) {
        return Bacon.once(x).concat(Bacon.later(minimumInterval).filter(false));
      }));
    };

    Observable.prototype.not = function() {
      return withDescription(this, "not", this.map(function(x) {
        return !x;
      }));
    };

    Observable.prototype.log = function() {
      var args;
      args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      this.subscribe(function(event) {
        return typeof console !== "undefined" && console !== null ? typeof console.log === "function" ? console.log.apply(console, __slice.call(args).concat([event.log()])) : void 0 : void 0;
      });
      return this;
    };

    Observable.prototype.slidingWindow = function(n, minValues) {
      if (minValues == null) {
        minValues = 0;
      }
      return withDescription(this, "slidingWindow", n, minValues, this.scan([], (function(window, value) {
        return window.concat([value]).slice(-n);
      })).filter((function(values) {
        return values.length >= minValues;
      })));
    };

    Observable.prototype.combine = function(other, f) {
      var combinator;
      combinator = toCombinator(f);
      return withDescription(this, "combine", other, f, Bacon.combineAsArray(this, other).map(function(values) {
        return combinator(values[0], values[1]);
      }));
    };

    Observable.prototype.decode = function(cases) {
      return withDescription(this, "decode", cases, this.combine(Bacon.combineTemplate(cases), function(key, values) {
        return values[key];
      }));
    };

    Observable.prototype.awaiting = function(other) {
      return withDescription(this, "awaiting", other, Bacon.groupSimultaneous(this, other).map(function(_arg) {
        var myValues, otherValues;
        myValues = _arg[0], otherValues = _arg[1];
        return otherValues.length === 0;
      }).toProperty(false).skipDuplicates());
    };

    Observable.prototype.name = function(name) {
      this.toString = function() {
        return name;
      };
      return this;
    };

    Observable.prototype.withDescription = function() {
      return describe.apply(null, arguments).apply(this);
    };

    return Observable;

  })();

  Observable.prototype.reduce = Observable.prototype.fold;

  Observable.prototype.assign = Observable.prototype.onValue;

  flatMap_ = function(root, f, firstOnly, limit) {
    var deps, result;
    deps = [root];
    result = new EventStream(describe(root, "flatMap" + (firstOnly ? "First" : ""), f), function(sink) {
      var checkEnd, checkQueue, composite, queue, spawn;
      composite = new CompositeUnsubscribe();
      queue = [];
      spawn = function(event) {
        var child;
        child = makeObservable(f(event.value()));
        deps.push(child);
        UpdateBarrier.flushDepCache();
        return composite.add(function(unsubAll, unsubMe) {
          return child.subscribeInternal(function(event) {
            var reply;
            if (event.isEnd()) {
              _.remove(child, deps);
              UpdateBarrier.flushDepCache();
              checkQueue();
              checkEnd(unsubMe);
              return Bacon.noMore;
            } else {
              if (event instanceof Initial) {
                event = event.toNext();
              }
              reply = sink(event);
              if (reply === Bacon.noMore) {
                unsubAll();
              }
              return reply;
            }
          });
        });
      };
      checkQueue = function() {
        var event;
        event = queue.splice(0, 1)[0];
        if (event) {
          return spawn(event);
        }
      };
      checkEnd = function(unsub) {
        unsub();
        if (composite.empty()) {
          return sink(end());
        }
      };
      composite.add(function(__, unsubRoot) {
        return root.subscribeInternal(function(event) {
          if (event.isEnd()) {
            return checkEnd(unsubRoot);
          } else if (event.isError()) {
            return sink(event);
          } else if (firstOnly && composite.count() > 1) {
            return Bacon.more;
          } else {
            if (composite.unsubscribed) {
              return Bacon.noMore;
            }
            if (limit && composite.count() > limit) {
              return queue.push(event);
            } else {
              return spawn(event);
            }
          }
        });
      });
      return composite.unsubscribe;
    });
    result.internalDeps = function() {
      return deps;
    };
    return result;
  };

  EventStream = (function(_super) {
    __extends(EventStream, _super);

    function EventStream(desc, subscribe) {
      var dispatcher;
      if (isFunction(desc)) {
        subscribe = desc;
        desc = [];
      }
      EventStream.__super__.constructor.call(this, desc);
      assertFunction(subscribe);
      dispatcher = new Dispatcher(subscribe);
      this.subscribeInternal = dispatcher.subscribe;
      this.subscribe = UpdateBarrier.wrappedSubscribe(this);
      this.hasSubscribers = dispatcher.hasSubscribers;
      registerObs(this);
    }

    EventStream.prototype.delay = function(delay) {
      return withDescription(this, "delay", delay, this.flatMap(function(value) {
        return Bacon.later(delay, value);
      }));
    };

    EventStream.prototype.debounce = function(delay) {
      return withDescription(this, "debounce", delay, this.flatMapLatest(function(value) {
        return Bacon.later(delay, value);
      }));
    };

    EventStream.prototype.debounceImmediate = function(delay) {
      return withDescription(this, "debounceImmediate", delay, this.flatMapFirst(function(value) {
        return Bacon.once(value).concat(Bacon.later(delay).filter(false));
      }));
    };

    EventStream.prototype.throttle = function(delay) {
      return withDescription(this, "throttle", delay, this.bufferWithTime(delay).map(function(values) {
        return values[values.length - 1];
      }));
    };

    EventStream.prototype.bufferWithTime = function(delay) {
      return withDescription(this, "bufferWithTime", delay, this.bufferWithTimeOrCount(delay, Number.MAX_VALUE));
    };

    EventStream.prototype.bufferWithCount = function(count) {
      return withDescription(this, "bufferWithCount", count, this.bufferWithTimeOrCount(void 0, count));
    };

    EventStream.prototype.bufferWithTimeOrCount = function(delay, count) {
      var flushOrSchedule;
      flushOrSchedule = function(buffer) {
        if (buffer.values.length === count) {
          return buffer.flush();
        } else if (delay !== void 0) {
          return buffer.schedule();
        }
      };
      return withDescription(this, "bufferWithTimeOrCount", delay, count, this.buffer(delay, flushOrSchedule, flushOrSchedule));
    };

    EventStream.prototype.buffer = function(delay, onInput, onFlush) {
      var buffer, delayMs, reply;
      if (onInput == null) {
        onInput = (function() {});
      }
      if (onFlush == null) {
        onFlush = (function() {});
      }
      buffer = {
        scheduled: false,
        end: null,
        values: [],
        flush: function() {
          var reply;
          this.scheduled = false;
          if (this.values.length > 0) {
            reply = this.push(next(this.values));
            this.values = [];
            if (this.end != null) {
              return this.push(this.end);
            } else if (reply !== Bacon.noMore) {
              return onFlush(this);
            }
          } else {
            if (this.end != null) {
              return this.push(this.end);
            }
          }
        },
        schedule: function() {
          if (!this.scheduled) {
            this.scheduled = true;
            return delay((function(_this) {
              return function() {
                return _this.flush();
              };
            })(this));
          }
        }
      };
      reply = Bacon.more;
      if (!isFunction(delay)) {
        delayMs = delay;
        delay = function(f) {
          return Bacon.scheduler.setTimeout(f, delayMs);
        };
      }
      return withDescription(this, "buffer", this.withHandler(function(event) {
        buffer.push = this.push;
        if (event.isError()) {
          reply = this.push(event);
        } else if (event.isEnd()) {
          buffer.end = event;
          if (!buffer.scheduled) {
            buffer.flush();
          }
        } else {
          buffer.values.push(event.value());
          onInput(buffer);
        }
        return reply;
      }));
    };

    EventStream.prototype.merge = function(right) {
      var left;
      assertEventStream(right);
      left = this;
      return withDescription(left, "merge", right, Bacon.mergeAll(this, right));
    };

    EventStream.prototype.toProperty = function(initValue) {
      if (arguments.length === 0) {
        initValue = None;
      }
      return withDescription(this, "toProperty", initValue, this.scan(initValue, latterF, {
        lazyF: true
      }));
    };

    EventStream.prototype.toEventStream = function() {
      return this;
    };

    EventStream.prototype.sampledBy = function(sampler, combinator) {
      return withDescription(this, "sampledBy", sampler, combinator, this.toProperty().sampledBy(sampler, combinator));
    };

    EventStream.prototype.concat = function(right) {
      var left;
      left = this;
      return new EventStream(describe(left, "concat", right), function(sink) {
        var unsubLeft, unsubRight;
        unsubRight = nop;
        unsubLeft = left.subscribeInternal(function(e) {
          if (e.isEnd()) {
            return unsubRight = right.subscribeInternal(sink);
          } else {
            return sink(e);
          }
        });
        return function() {
          unsubLeft();
          return unsubRight();
        };
      });
    };

    EventStream.prototype.takeUntil = function(stopper) {
      var endMarker;
      endMarker = {};
      return withDescription(this, "takeUntil", stopper, Bacon.groupSimultaneous(this.mapEnd(endMarker), stopper.skipErrors()).withHandler(function(event) {
        var data, reply, value, _i, _len, _ref1;
        if (!event.hasValue()) {
          return this.push(event);
        } else {
          _ref1 = event.value(), data = _ref1[0], stopper = _ref1[1];
          if (stopper.length) {
            return this.push(end());
          } else {
            reply = Bacon.more;
            for (_i = 0, _len = data.length; _i < _len; _i++) {
              value = data[_i];
              if (value === endMarker) {
                reply = this.push(end());
              } else {
                reply = this.push(next(value));
              }
            }
            return reply;
          }
        }
      }));
    };

    EventStream.prototype.skipUntil = function(starter) {
      var started;
      started = starter.take(1).map(true).toProperty(false);
      return withDescription(this, "skipUntil", starter, this.filter(started));
    };

    EventStream.prototype.skipWhile = function() {
      var args, f, ok;
      f = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      ok = false;
      return convertArgsToFunction(this, f, args, function(f) {
        return withDescription(this, "skipWhile", f, this.withHandler(function(event) {
          if (ok || !event.hasValue() || !f(event.value())) {
            if (event.hasValue()) {
              ok = true;
            }
            return this.push(event);
          } else {
            return Bacon.more;
          }
        }));
      });
    };

    EventStream.prototype.holdWhen = function(valve) {
      var putToHold, releaseHold, valve_;
      valve_ = valve.startWith(false);
      releaseHold = valve_.filter(function(x) {
        return !x;
      });
      putToHold = valve_.filter(_.id);
      return withDescription(this, "holdWhen", valve, this.filter(false).merge(valve_.flatMapConcat((function(_this) {
        return function(shouldHold) {
          if (!shouldHold) {
            return _this.takeUntil(putToHold);
          } else {
            return _this.scan([], (function(xs, x) {
              return xs.concat(x);
            }), {
              eager: true
            }).sampledBy(releaseHold).take(1).flatMap(Bacon.fromArray);
          }
        };
      })(this))));
    };

    EventStream.prototype.startWith = function(seed) {
      return withDescription(this, "startWith", seed, Bacon.once(seed).concat(this));
    };

    EventStream.prototype.withHandler = function(handler) {
      var dispatcher;
      dispatcher = new Dispatcher(this.subscribeInternal, handler);
      return new EventStream(describe(this, "withHandler", handler), dispatcher.subscribe);
    };

    return EventStream;

  })(Observable);

  Property = (function(_super) {
    __extends(Property, _super);

    function Property(desc, subscribe, handler) {
      if (isFunction(desc)) {
        handler = subscribe;
        subscribe = desc;
        desc = [];
      }
      Property.__super__.constructor.call(this, desc);
      assertFunction(subscribe);
      if (handler === true) {
        this.subscribeInternal = subscribe;
      } else {
        this.subscribeInternal = new PropertyDispatcher(this, subscribe, handler).subscribe;
      }
      this.subscribe = UpdateBarrier.wrappedSubscribe(this);
      registerObs(this);
    }

    Property.prototype.sampledBy = function(sampler, combinator) {
      var lazy, result, samplerSource, stream, thisSource;
      if (combinator != null) {
        combinator = toCombinator(combinator);
      } else {
        lazy = true;
        combinator = function(f) {
          return f();
        };
      }
      thisSource = new Source(this, false, this.subscribeInternal, lazy);
      samplerSource = new Source(sampler, true, sampler.subscribeInternal, lazy);
      stream = Bacon.when([thisSource, samplerSource], combinator);
      result = sampler instanceof Property ? stream.toProperty() : stream;
      return withDescription(this, "sampledBy", sampler, combinator, result);
    };

    Property.prototype.sample = function(interval) {
      return withDescription(this, "sample", interval, this.sampledBy(Bacon.interval(interval, {})));
    };

    Property.prototype.changes = function() {
      return new EventStream(describe(this, "changes"), (function(_this) {
        return function(sink) {
          return _this.subscribeInternal(function(event) {
            if (!event.isInitial()) {
              return sink(event);
            }
          });
        };
      })(this));
    };

    Property.prototype.withHandler = function(handler) {
      return new Property(describe(this, "withHandler", handler), this.subscribeInternal, handler);
    };

    Property.prototype.toProperty = function() {
      assertNoArguments(arguments);
      return this;
    };

    Property.prototype.toEventStream = function() {
      return new EventStream(describe(this, "toEventStream"), (function(_this) {
        return function(sink) {
          return _this.subscribeInternal(function(event) {
            if (event.isInitial()) {
              event = event.toNext();
            }
            return sink(event);
          });
        };
      })(this));
    };

    Property.prototype.and = function(other) {
      return withDescription(this, "and", other, this.combine(other, function(x, y) {
        return x && y;
      }));
    };

    Property.prototype.or = function(other) {
      return withDescription(this, "or", other, this.combine(other, function(x, y) {
        return x || y;
      }));
    };

    Property.prototype.delay = function(delay) {
      return this.delayChanges("delay", delay, function(changes) {
        return changes.delay(delay);
      });
    };

    Property.prototype.debounce = function(delay) {
      return this.delayChanges("debounce", delay, function(changes) {
        return changes.debounce(delay);
      });
    };

    Property.prototype.throttle = function(delay) {
      return this.delayChanges("throttle", delay, function(changes) {
        return changes.throttle(delay);
      });
    };

    Property.prototype.delayChanges = function() {
      var desc, f, _i;
      desc = 2 <= arguments.length ? __slice.call(arguments, 0, _i = arguments.length - 1) : (_i = 0, []), f = arguments[_i++];
      return withDescription.apply(null, [this].concat(__slice.call(desc), [addPropertyInitValueToStream(this, f(this.changes()))]));
    };

    Property.prototype.takeUntil = function(stopper) {
      var changes;
      changes = this.changes().takeUntil(stopper);
      return withDescription(this, "takeUntil", stopper, addPropertyInitValueToStream(this, changes));
    };

    Property.prototype.startWith = function(value) {
      return withDescription(this, "startWith", value, this.scan(value, function(prev, next) {
        return next;
      }));
    };

    Property.prototype.bufferingThrottle = function() {
      var _ref1;
      return (_ref1 = Property.__super__.bufferingThrottle.apply(this, arguments)).bufferingThrottle.apply(_ref1, arguments).toProperty();
    };

    return Property;

  })(Observable);

  convertArgsToFunction = function(obs, f, args, method) {
    var sampled;
    if (f instanceof Property) {
      sampled = f.sampledBy(obs, function(p, s) {
        return [p, s];
      });
      return method.apply(sampled, [
        function(_arg) {
          var p, s;
          p = _arg[0], s = _arg[1];
          return p;
        }
      ]).map(function(_arg) {
        var p, s;
        p = _arg[0], s = _arg[1];
        return s;
      });
    } else {
      f = makeFunction(f, args);
      return method.apply(obs, [f]);
    }
  };

  addPropertyInitValueToStream = function(property, stream) {
    var justInitValue;
    justInitValue = new EventStream(describe(property, "justInitValue"), function(sink) {
      var unsub, value;
      value = null;
      unsub = property.subscribeInternal(function(event) {
        if (event.hasValue()) {
          value = event;
        }
        return Bacon.noMore;
      });
      UpdateBarrier.whenDoneWith(justInitValue, function() {
        if (value != null) {
          sink(value);
        }
        return sink(end());
      });
      return unsub;
    });
    return justInitValue.concat(stream).toProperty();
  };

  Dispatcher = (function() {
    function Dispatcher(subscribe, handleEvent) {
      var done, ended, prevError, pushIt, pushing, queue, removeSub, subscriptions, unsubscribeFromSource, waiters;
      if (subscribe == null) {
        subscribe = function() {
          return nop;
        };
      }
      subscriptions = [];
      queue = [];
      pushing = false;
      ended = false;
      this.hasSubscribers = function() {
        return subscriptions.length > 0;
      };
      prevError = null;
      unsubscribeFromSource = nop;
      removeSub = function(subscription) {
        return subscriptions = _.without(subscription, subscriptions);
      };
      waiters = null;
      done = function() {
        var w, ws, _i, _len, _results;
        if (waiters != null) {
          ws = waiters;
          waiters = null;
          _results = [];
          for (_i = 0, _len = ws.length; _i < _len; _i++) {
            w = ws[_i];
            _results.push(w());
          }
          return _results;
        }
      };
      pushIt = function(event) {
        var reply, sub, success, tmp, _i, _len;
        if (!pushing) {
          if (event === prevError) {
            return;
          }
          if (event.isError()) {
            prevError = event;
          }
          success = false;
          try {
            pushing = true;
            tmp = subscriptions;
            for (_i = 0, _len = tmp.length; _i < _len; _i++) {
              sub = tmp[_i];
              reply = sub.sink(event);
              if (reply === Bacon.noMore || event.isEnd()) {
                removeSub(sub);
              }
            }
            success = true;
          } finally {
            pushing = false;
            if (!success) {
              queue = [];
            }
          }
          success = true;
          while (queue.length) {
            event = queue.shift();
            this.push(event);
          }
          done(event);
          if (this.hasSubscribers()) {
            return Bacon.more;
          } else {
            unsubscribeFromSource();
            return Bacon.noMore;
          }
        } else {
          queue.push(event);
          return Bacon.more;
        }
      };
      this.push = (function(_this) {
        return function(event) {
          return UpdateBarrier.inTransaction(event, _this, pushIt, [event]);
        };
      })(this);
      if (handleEvent == null) {
        handleEvent = function(event) {
          return this.push(event);
        };
      }
      this.handleEvent = (function(_this) {
        return function(event) {
          if (event.isEnd()) {
            ended = true;
          }
          return handleEvent.apply(_this, [event]);
        };
      })(this);
      this.subscribe = (function(_this) {
        return function(sink) {
          var subscription, unsubSrc;
          if (ended) {
            sink(end());
            return nop;
          } else {
            assertFunction(sink);
            subscription = {
              sink: sink
            };
            subscriptions.push(subscription);
            if (subscriptions.length === 1) {
              unsubSrc = subscribe(_this.handleEvent);
              unsubscribeFromSource = function() {
                unsubSrc();
                return unsubscribeFromSource = nop;
              };
            }
            assertFunction(unsubscribeFromSource);
            return function() {
              removeSub(subscription);
              if (!_this.hasSubscribers()) {
                return unsubscribeFromSource();
              }
            };
          }
        };
      })(this);
    }

    return Dispatcher;

  })();

  PropertyDispatcher = (function(_super) {
    __extends(PropertyDispatcher, _super);

    function PropertyDispatcher(p, subscribe, handleEvent) {
      var current, currentValueRootId, ended, push;
      PropertyDispatcher.__super__.constructor.call(this, subscribe, handleEvent);
      current = None;
      currentValueRootId = void 0;
      push = this.push;
      subscribe = this.subscribe;
      ended = false;
      this.push = (function(_this) {
        return function(event) {
          if (event.isEnd()) {
            ended = true;
          }
          if (event.hasValue()) {
            current = new Some(event);
            currentValueRootId = UpdateBarrier.currentEventId();
          }
          return push.apply(_this, [event]);
        };
      })(this);
      this.subscribe = (function(_this) {
        return function(sink) {
          var dispatchingId, initSent, maybeSubSource, reply, valId;
          initSent = false;
          reply = Bacon.more;
          maybeSubSource = function() {
            if (reply === Bacon.noMore) {
              return nop;
            } else if (ended) {
              sink(end());
              return nop;
            } else {
              return subscribe.apply(this, [sink]);
            }
          };
          if (current.isDefined && (_this.hasSubscribers() || ended)) {
            dispatchingId = UpdateBarrier.currentEventId();
            valId = currentValueRootId;
            if (!ended && valId && dispatchingId && dispatchingId !== valId) {
              UpdateBarrier.whenDoneWith(p, function() {
                if (currentValueRootId === valId) {
                  return sink(initial(current.get().value()));
                }
              });
              return maybeSubSource();
            } else {
              UpdateBarrier.inTransaction(void 0, _this, (function() {
                return reply = sink(initial(current.get().value()));
              }), []);
              return maybeSubSource();
            }
          } else {
            return maybeSubSource();
          }
        };
      })(this);
    }

    return PropertyDispatcher;

  })(Dispatcher);

  Bus = (function(_super) {
    __extends(Bus, _super);

    function Bus() {
      var ended, guardedSink, sink, subscribeAll, subscribeInput, subscriptions, unsubAll, unsubscribeInput;
      sink = void 0;
      subscriptions = [];
      ended = false;
      guardedSink = (function(_this) {
        return function(input) {
          return function(event) {
            if (event.isEnd()) {
              unsubscribeInput(input);
              return Bacon.noMore;
            } else {
              return sink(event);
            }
          };
        };
      })(this);
      unsubAll = function() {
        var sub, _i, _len, _results;
        _results = [];
        for (_i = 0, _len = subscriptions.length; _i < _len; _i++) {
          sub = subscriptions[_i];
          _results.push(typeof sub.unsub === "function" ? sub.unsub() : void 0);
        }
        return _results;
      };
      subscribeInput = function(subscription) {
        return subscription.unsub = subscription.input.subscribeInternal(guardedSink(subscription.input));
      };
      unsubscribeInput = function(input) {
        var i, sub, _i, _len;
        for (i = _i = 0, _len = subscriptions.length; _i < _len; i = ++_i) {
          sub = subscriptions[i];
          if (sub.input === input) {
            if (typeof sub.unsub === "function") {
              sub.unsub();
            }
            subscriptions.splice(i, 1);
            return;
          }
        }
      };
      subscribeAll = (function(_this) {
        return function(newSink) {
          var subscription, _i, _len, _ref1;
          sink = newSink;
          _ref1 = cloneArray(subscriptions);
          for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
            subscription = _ref1[_i];
            subscribeInput(subscription);
          }
          return unsubAll;
        };
      })(this);
      Bus.__super__.constructor.call(this, describe(Bacon, "Bus"), subscribeAll);
      this.plug = (function(_this) {
        return function(input) {
          var sub;
          if (ended) {
            return;
          }
          sub = {
            input: input
          };
          subscriptions.push(sub);
          if ((sink != null)) {
            subscribeInput(sub);
          }
          return function() {
            return unsubscribeInput(input);
          };
        };
      })(this);
      this.push = (function(_this) {
        return function(value) {
          return typeof sink === "function" ? sink(next(value)) : void 0;
        };
      })(this);
      this.error = (function(_this) {
        return function(error) {
          return typeof sink === "function" ? sink(new Error(error)) : void 0;
        };
      })(this);
      this.end = (function(_this) {
        return function() {
          ended = true;
          unsubAll();
          return typeof sink === "function" ? sink(end()) : void 0;
        };
      })(this);
    }

    return Bus;

  })(EventStream);

  Source = (function() {
    function Source(obs, sync, subscribe, lazy) {
      this.obs = obs;
      this.sync = sync;
      this.subscribe = subscribe;
      this.lazy = lazy != null ? lazy : false;
      this.queue = [];
      if (this.subscribe == null) {
        this.subscribe = this.obs.subscribeInternal;
      }
      this.toString = this.obs.toString;
    }

    Source.prototype.markEnded = function() {
      return this.ended = true;
    };

    Source.prototype.consume = function() {
      if (this.lazy) {
        return _.always(this.queue[0]);
      } else {
        return this.queue[0];
      }
    };

    Source.prototype.push = function(x) {
      return this.queue = [x];
    };

    Source.prototype.mayHave = function() {
      return true;
    };

    Source.prototype.hasAtLeast = function() {
      return this.queue.length;
    };

    Source.prototype.flatten = true;

    return Source;

  })();

  ConsumingSource = (function(_super) {
    __extends(ConsumingSource, _super);

    function ConsumingSource() {
      return ConsumingSource.__super__.constructor.apply(this, arguments);
    }

    ConsumingSource.prototype.consume = function() {
      return this.queue.shift();
    };

    ConsumingSource.prototype.push = function(x) {
      return this.queue.push(x);
    };

    ConsumingSource.prototype.mayHave = function(c) {
      return !this.ended || this.queue.length >= c;
    };

    ConsumingSource.prototype.hasAtLeast = function(c) {
      return this.queue.length >= c;
    };

    ConsumingSource.prototype.flatten = false;

    return ConsumingSource;

  })(Source);

  BufferingSource = (function(_super) {
    __extends(BufferingSource, _super);

    function BufferingSource(obs) {
      this.obs = obs;
      BufferingSource.__super__.constructor.call(this, this.obs, true, this.obs.subscribeInternal);
    }

    BufferingSource.prototype.consume = function() {
      var values;
      values = this.queue;
      this.queue = [];
      return function() {
        return values;
      };
    };

    BufferingSource.prototype.push = function(x) {
      return this.queue.push(x());
    };

    BufferingSource.prototype.hasAtLeast = function() {
      return true;
    };

    return BufferingSource;

  })(Source);

  Source.isTrigger = function(s) {
    if (s instanceof Source) {
      return s.sync;
    } else {
      return s instanceof EventStream;
    }
  };

  Source.fromObservable = function(s) {
    if (s instanceof Source) {
      return s;
    } else if (s instanceof Property) {
      return new Source(s, false);
    } else {
      return new ConsumingSource(s, true);
    }
  };

  describe = function() {
    var args, context, method;
    context = arguments[0], method = arguments[1], args = 3 <= arguments.length ? __slice.call(arguments, 2) : [];
    if ((context || method) instanceof Desc) {
      return context || method;
    } else {
      return new Desc(context, method, args);
    }
  };

  findDeps = function(x) {
    if (isArray(x)) {
      return _.flatMap(findDeps, x);
    } else if (isObservable(x)) {
      return [x];
    } else if (x instanceof Source) {
      return [x.obs];
    } else {
      return [];
    }
  };

  Desc = (function() {
    function Desc(context, method, args) {
      this.context = context;
      this.method = method;
      this.args = args;
    }

    Desc.prototype.apply = function(obs) {
      var deps, that;
      that = this;
      deps = _.cached((function() {
        return findDeps([that.context].concat(that.args));
      }));
      obs.internalDeps = obs.internalDeps || deps;
      obs.dependsOn = UpdateBarrier.dependsOn;
      obs.deps = deps;
      obs.toString = (function() {
        return _.toString(that.context) + "." + _.toString(that.method) + "(" + _.map(_.toString, that.args) + ")";
      });
      obs.inspect = function() {
        return obs.toString();
      };
      obs.desc = (function() {
        return {
          context: that.context,
          method: that.method,
          args: that.args
        };
      });
      return obs;
    };

    return Desc;

  })();

  withDescription = function() {
    var desc, obs, _i;
    desc = 2 <= arguments.length ? __slice.call(arguments, 0, _i = arguments.length - 1) : (_i = 0, []), obs = arguments[_i++];
    return describe.apply(null, desc).apply(obs);
  };

  Bacon.when = function() {
    var f, i, index, ix, len, needsBarrier, pat, patSources, pats, patterns, resultStream, s, sources, triggerFound, usage, _i, _j, _len, _len1, _ref1;
    patterns = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    if (patterns.length === 0) {
      return Bacon.never();
    }
    len = patterns.length;
    usage = "when: expecting arguments in the form (Observable+,function)+";
    assert(usage, len % 2 === 0);
    sources = [];
    pats = [];
    i = 0;
    while (i < len) {
      patSources = _.toArray(patterns[i]);
      f = patterns[i + 1];
      pat = {
        f: (isFunction(f) ? f : (function() {
          return f;
        })),
        ixs: []
      };
      triggerFound = false;
      for (_i = 0, _len = patSources.length; _i < _len; _i++) {
        s = patSources[_i];
        index = _.indexOf(sources, s);
        if (!triggerFound) {
          triggerFound = Source.isTrigger(s);
        }
        if (index < 0) {
          sources.push(s);
          index = sources.length - 1;
        }
        _ref1 = pat.ixs;
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          ix = _ref1[_j];
          if (ix.index === index) {
            ix.count++;
          }
        }
        pat.ixs.push({
          index: index,
          count: 1
        });
      }
      assert("At least one EventStream required", triggerFound ||  (!patSources.length));
      if (patSources.length > 0) {
        pats.push(pat);
      }
      i = i + 2;
    }
    if (!sources.length) {
      return Bacon.never();
    }
    sources = _.map(Source.fromObservable, sources);
    needsBarrier = (_.any(sources, function(s) {
      return s.flatten;
    })) && (containsDuplicateDeps(_.map((function(s) {
      return s.obs;
    }), sources)));
    return resultStream = new EventStream(describe.apply(null, [Bacon, "when"].concat(__slice.call(patterns))), function(sink) {
      var cannotMatch, cannotSync, ends, match, nonFlattened, part, triggers;
      triggers = [];
      ends = false;
      match = function(p) {
        var _k, _len2, _ref2;
        _ref2 = p.ixs;
        for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
          i = _ref2[_k];
          if (!sources[i.index].hasAtLeast(i.count)) {
            return false;
          }
        }
        return true;
      };
      cannotSync = function(source) {
        return !source.sync || source.ended;
      };
      cannotMatch = function(p) {
        var _k, _len2, _ref2;
        _ref2 = p.ixs;
        for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
          i = _ref2[_k];
          if (!sources[i.index].mayHave(i.count)) {
            return true;
          }
        }
      };
      nonFlattened = function(trigger) {
        return !trigger.source.flatten;
      };
      part = function(source) {
        return function(unsubAll) {
          var flush, flushLater, flushWhileTriggers;
          flushLater = function() {
            return UpdateBarrier.whenDoneWith(resultStream, flush);
          };
          flushWhileTriggers = function() {
            var functions, p, reply, trigger, _k, _len2;
            if (triggers.length > 0) {
              reply = Bacon.more;
              trigger = triggers.pop();
              for (_k = 0, _len2 = pats.length; _k < _len2; _k++) {
                p = pats[_k];
                if (match(p)) {
                  functions = (function() {
                    var _l, _len3, _ref2, _results;
                    _ref2 = p.ixs;
                    _results = [];
                    for (_l = 0, _len3 = _ref2.length; _l < _len3; _l++) {
                      i = _ref2[_l];
                      _results.push(sources[i.index].consume());
                    }
                    return _results;
                  })();
                  reply = sink(trigger.e.apply(function() {
                    var fun, values;
                    values = (function() {
                      var _l, _len3, _results;
                      _results = [];
                      for (_l = 0, _len3 = functions.length; _l < _len3; _l++) {
                        fun = functions[_l];
                        _results.push(fun());
                      }
                      return _results;
                    })();
                    return p.f.apply(p, values);
                  }));
                  if (triggers.length && needsBarrier) {
                    triggers = _.filter(nonFlattened, triggers);
                  }
                  if (reply === Bacon.noMore) {
                    return reply;
                  } else {
                    return flushWhileTriggers();
                  }
                }
              }
            } else {
              return Bacon.more;
            }
          };
          flush = function() {
            var reply;
            reply = flushWhileTriggers();
            if (ends) {
              ends = false;
              if (_.all(sources, cannotSync) || _.all(pats, cannotMatch)) {
                reply = Bacon.noMore;
                sink(end());
              }
            }
            if (reply === Bacon.noMore) {
              unsubAll();
            }
            return reply;
          };
          return source.subscribe(function(e) {
            var reply;
            if (e.isEnd()) {
              ends = true;
              source.markEnded();
              flushLater();
            } else if (e.isError()) {
              reply = sink(e);
            } else {
              source.push(e.value);
              if (source.sync) {
                triggers.push({
                  source: source,
                  e: e
                });
                if (needsBarrier || UpdateBarrier.hasWaiters()) {
                  flushLater();
                } else {
                  flush();
                }
              }
            }
            if (reply === Bacon.noMore) {
              unsubAll();
            }
            return reply || Bacon.more;
          });
        };
      };
      return compositeUnsubscribe.apply(null, (function() {
        var _k, _len2, _results;
        _results = [];
        for (_k = 0, _len2 = sources.length; _k < _len2; _k++) {
          s = sources[_k];
          _results.push(part(s));
        }
        return _results;
      })());
    });
  };

  containsDuplicateDeps = function(observables, state) {
    var checkObservable;
    if (state == null) {
      state = [];
    }
    checkObservable = function(obs) {
      var deps;
      if (Bacon._.contains(state, obs)) {
        return true;
      } else {
        deps = obs.internalDeps();
        if (deps.length) {
          state.push(obs);
          return Bacon._.any(deps, checkObservable);
        } else {
          state.push(obs);
          return false;
        }
      }
    };
    return Bacon._.any(observables, checkObservable);
  };

  Bacon.update = function() {
    var i, initial, lateBindFirst, patterns;
    initial = arguments[0], patterns = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    lateBindFirst = function(f) {
      return function() {
        var args;
        args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
        return function(i) {
          return f.apply(null, [i].concat(args));
        };
      };
    };
    i = patterns.length - 1;
    while (i > 0) {
      if (!(patterns[i] instanceof Function)) {
        patterns[i] = (function(x) {
          return function() {
            return x;
          };
        })(patterns[i]);
      }
      patterns[i] = lateBindFirst(patterns[i]);
      i = i - 2;
    }
    return withDescription.apply(null, [Bacon, "update", initial].concat(__slice.call(patterns), [Bacon.when.apply(Bacon, patterns).scan(initial, (function(x, f) {
      return f(x);
    }))]));
  };

  compositeUnsubscribe = function() {
    var ss;
    ss = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    return new CompositeUnsubscribe(ss).unsubscribe;
  };

  CompositeUnsubscribe = (function() {
    function CompositeUnsubscribe(ss) {
      var s, _i, _len;
      if (ss == null) {
        ss = [];
      }
      this.unsubscribe = __bind(this.unsubscribe, this);
      this.unsubscribed = false;
      this.subscriptions = [];
      this.starting = [];
      for (_i = 0, _len = ss.length; _i < _len; _i++) {
        s = ss[_i];
        this.add(s);
      }
    }

    CompositeUnsubscribe.prototype.add = function(subscription) {
      var ended, unsub, unsubMe;
      if (this.unsubscribed) {
        return;
      }
      ended = false;
      unsub = nop;
      this.starting.push(subscription);
      unsubMe = (function(_this) {
        return function() {
          if (_this.unsubscribed) {
            return;
          }
          ended = true;
          _this.remove(unsub);
          return _.remove(subscription, _this.starting);
        };
      })(this);
      unsub = subscription(this.unsubscribe, unsubMe);
      if (!(this.unsubscribed || ended)) {
        this.subscriptions.push(unsub);
      }
      _.remove(subscription, this.starting);
      return unsub;
    };

    CompositeUnsubscribe.prototype.remove = function(unsub) {
      if (this.unsubscribed) {
        return;
      }
      if ((_.remove(unsub, this.subscriptions)) !== void 0) {
        return unsub();
      }
    };

    CompositeUnsubscribe.prototype.unsubscribe = function() {
      var s, _i, _len, _ref1;
      if (this.unsubscribed) {
        return;
      }
      this.unsubscribed = true;
      _ref1 = this.subscriptions;
      for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
        s = _ref1[_i];
        s();
      }
      this.subscriptions = [];
      return this.starting = [];
    };

    CompositeUnsubscribe.prototype.count = function() {
      if (this.unsubscribed) {
        return 0;
      }
      return this.subscriptions.length + this.starting.length;
    };

    CompositeUnsubscribe.prototype.empty = function() {
      return this.count() === 0;
    };

    return CompositeUnsubscribe;

  })();

  Bacon.CompositeUnsubscribe = CompositeUnsubscribe;

  Some = (function() {
    function Some(value) {
      this.value = value;
    }

    Some.prototype.getOrElse = function() {
      return this.value;
    };

    Some.prototype.get = function() {
      return this.value;
    };

    Some.prototype.filter = function(f) {
      if (f(this.value)) {
        return new Some(this.value);
      } else {
        return None;
      }
    };

    Some.prototype.map = function(f) {
      return new Some(f(this.value));
    };

    Some.prototype.forEach = function(f) {
      return f(this.value);
    };

    Some.prototype.isDefined = true;

    Some.prototype.toArray = function() {
      return [this.value];
    };

    Some.prototype.inspect = function() {
      return "Some(" + this.value + ")";
    };

    Some.prototype.toString = function() {
      return this.inspect();
    };

    return Some;

  })();

  None = {
    getOrElse: function(value) {
      return value;
    },
    filter: function() {
      return None;
    },
    map: function() {
      return None;
    },
    forEach: function() {},
    isDefined: false,
    toArray: function() {
      return [];
    },
    inspect: function() {
      return "None";
    },
    toString: function() {
      return this.inspect();
    }
  };

  UpdateBarrier = (function() {
    var afterTransaction, afters, collectDeps, currentEventId, dependsOn, findIndependent, flatDeps, flush, flushDepCache, hasWaiters, inTransaction, independent, rootEvent, waiters, whenDoneWith, wrappedSubscribe;
    rootEvent = void 0;
    waiters = [];
    afters = [];
    afterTransaction = function(f) {
      if (rootEvent) {
        return afters.push(f);
      } else {
        return f();
      }
    };
    independent = function(waiter) {
      return !_.any(waiters, (function(other) {
        return waiter.obs.dependsOn(other.obs);
      }));
    };
    whenDoneWith = function(obs, f) {
      if (rootEvent) {
        return waiters.push({
          obs: obs,
          f: f
        });
      } else {
        return f();
      }
    };
    findIndependent = function() {
      while (!independent(waiters[0])) {
        waiters.push(waiters.splice(0, 1)[0]);
      }
      return waiters.splice(0, 1)[0];
    };
    flush = function() {
      var _results;
      _results = [];
      while (waiters.length) {
        _results.push(findIndependent().f());
      }
      return _results;
    };
    inTransaction = function(event, context, f, args) {
      var flatDeps, result;
      if (rootEvent) {
        return f.apply(context, args);
      } else {
        rootEvent = event;
        try {
          result = f.apply(context, args);
          flush();
        } finally {
          rootEvent = void 0;
          while (afters.length) {
            f = afters.splice(0, 1)[0];
            f();
          }
          flatDeps = {};
        }
        return result;
      }
    };
    currentEventId = function() {
      if (rootEvent) {
        return rootEvent.id;
      } else {
        return void 0;
      }
    };
    wrappedSubscribe = function(obs) {
      return function(sink) {
        var doUnsub, unsub, unsubd;
        unsubd = false;
        doUnsub = function() {};
        unsub = function() {
          unsubd = true;
          return doUnsub();
        };
        doUnsub = obs.subscribeInternal(function(event) {
          return afterTransaction(function() {
            var reply;
            if (!unsubd) {
              reply = sink(event);
              if (reply === Bacon.noMore) {
                return unsub();
              }
            }
          });
        });
        return unsub;
      };
    };
    hasWaiters = function() {
      return waiters.length > 0;
    };
    flatDeps = {};
    dependsOn = function(b) {
      var myDeps;
      myDeps = flatDeps[this.id];
      if (!myDeps) {
        myDeps = flatDeps[this.id] = {};
        collectDeps(this, this);
      }
      return myDeps[b.id];
    };
    collectDeps = function(orig, o) {
      var dep, _i, _len, _ref1, _results;
      _ref1 = o.internalDeps();
      _results = [];
      for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
        dep = _ref1[_i];
        flatDeps[orig.id][dep.id] = true;
        _results.push(collectDeps(orig, dep));
      }
      return _results;
    };
    flushDepCache = function() {
      return flatDeps = {};
    };
    return {
      whenDoneWith: whenDoneWith,
      hasWaiters: hasWaiters,
      inTransaction: inTransaction,
      currentEventId: currentEventId,
      wrappedSubscribe: wrappedSubscribe,
      dependsOn: dependsOn,
      flushDepCache: flushDepCache
    };
  })();

  Bacon.EventStream = EventStream;

  Bacon.Property = Property;

  Bacon.Observable = Observable;

  Bacon.Bus = Bus;

  Bacon.Initial = Initial;

  Bacon.Next = Next;

  Bacon.End = End;

  Bacon.Error = Error;

  nop = function() {};

  latterF = function(_, x) {
    return x();
  };

  former = function(x, _) {
    return x;
  };

  initial = function(value) {
    return new Initial(_.always(value));
  };

  next = function(value) {
    return new Next(_.always(value));
  };

  end = function() {
    return new End();
  };

  toEvent = function(x) {
    if (x instanceof Event) {
      return x;
    } else {
      return next(x);
    }
  };

  cloneArray = function(xs) {
    return xs.slice(0);
  };

  assert = function(message, condition) {
    if (!condition) {
      throw message;
    }
  };

  assertEventStream = function(event) {
    if (!(event instanceof EventStream)) {
      throw "not an EventStream : " + event;
    }
  };

  assertFunction = function(f) {
    return assert("not a function : " + f, isFunction(f));
  };

  isFunction = function(f) {
    return typeof f === "function";
  };

  isArray = function(xs) {
    return xs instanceof Array;
  };

  isObservable = function(x) {
    return x instanceof Observable;
  };

  assertArray = function(xs) {
    if (!isArray(xs)) {
      throw "not an array : " + xs;
    }
  };

  assertNoArguments = function(args) {
    return assert("no arguments supported", args.length === 0);
  };

  assertString = function(x) {
    if (typeof x !== "string") {
      throw "not a string : " + x;
    }
  };

  partiallyApplied = function(f, applied) {
    return function() {
      var args;
      args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      return f.apply(null, applied.concat(args));
    };
  };

  makeSpawner = function(args) {
    if (args.length === 1 && isObservable(args[0])) {
      return _.always(args[0]);
    } else {
      return makeFunctionArgs(args);
    }
  };

  makeFunctionArgs = function(args) {
    args = Array.prototype.slice.call(args);
    return makeFunction_.apply(null, args);
  };

  makeFunction_ = withMethodCallSupport(function() {
    var args, f;
    f = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    if (isFunction(f)) {
      if (args.length) {
        return partiallyApplied(f, args);
      } else {
        return f;
      }
    } else if (isFieldKey(f)) {
      return toFieldExtractor(f, args);
    } else {
      return _.always(f);
    }
  });

  makeFunction = function(f, args) {
    return makeFunction_.apply(null, [f].concat(__slice.call(args)));
  };

  makeObservable = function(x) {
    if (isObservable(x)) {
      return x;
    } else {
      return Bacon.once(x);
    }
  };

  isFieldKey = function(f) {
    return (typeof f === "string") && f.length > 1 && f.charAt(0) === ".";
  };

  Bacon.isFieldKey = isFieldKey;

  toFieldExtractor = function(f, args) {
    var partFuncs, parts;
    parts = f.slice(1).split(".");
    partFuncs = _.map(toSimpleExtractor(args), parts);
    return function(value) {
      var _i, _len;
      for (_i = 0, _len = partFuncs.length; _i < _len; _i++) {
        f = partFuncs[_i];
        value = f(value);
      }
      return value;
    };
  };

  toSimpleExtractor = function(args) {
    return function(key) {
      return function(value) {
        var fieldValue;
        if (value == null) {
          return void 0;
        } else {
          fieldValue = value[key];
          if (isFunction(fieldValue)) {
            return fieldValue.apply(value, args);
          } else {
            return fieldValue;
          }
        }
      };
    };
  };

  toFieldKey = function(f) {
    return f.slice(1);
  };

  toCombinator = function(f) {
    var key;
    if (isFunction(f)) {
      return f;
    } else if (isFieldKey(f)) {
      key = toFieldKey(f);
      return function(left, right) {
        return left[key](right);
      };
    } else {
      return assert("not a function or a field key: " + f, false);
    }
  };

  toOption = function(v) {
    if (v instanceof Some || v === None) {
      return v;
    } else {
      return new Some(v);
    }
  };

  _ = {
    indexOf: Array.prototype.indexOf ? function(xs, x) {
      return xs.indexOf(x);
    } : function(xs, x) {
      var i, y, _i, _len;
      for (i = _i = 0, _len = xs.length; _i < _len; i = ++_i) {
        y = xs[i];
        if (x === y) {
          return i;
        }
      }
      return -1;
    },
    indexWhere: function(xs, f) {
      var i, y, _i, _len;
      for (i = _i = 0, _len = xs.length; _i < _len; i = ++_i) {
        y = xs[i];
        if (f(y)) {
          return i;
        }
      }
      return -1;
    },
    head: function(xs) {
      return xs[0];
    },
    always: function(x) {
      return function() {
        return x;
      };
    },
    negate: function(f) {
      return function(x) {
        return !f(x);
      };
    },
    empty: function(xs) {
      return xs.length === 0;
    },
    tail: function(xs) {
      return xs.slice(1, xs.length);
    },
    filter: function(f, xs) {
      var filtered, x, _i, _len;
      filtered = [];
      for (_i = 0, _len = xs.length; _i < _len; _i++) {
        x = xs[_i];
        if (f(x)) {
          filtered.push(x);
        }
      }
      return filtered;
    },
    map: function(f, xs) {
      var x, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = xs.length; _i < _len; _i++) {
        x = xs[_i];
        _results.push(f(x));
      }
      return _results;
    },
    each: function(xs, f) {
      var key, value, _results;
      _results = [];
      for (key in xs) {
        value = xs[key];
        _results.push(f(key, value));
      }
      return _results;
    },
    toArray: function(xs) {
      if (isArray(xs)) {
        return xs;
      } else {
        return [xs];
      }
    },
    contains: function(xs, x) {
      return _.indexOf(xs, x) !== -1;
    },
    id: function(x) {
      return x;
    },
    last: function(xs) {
      return xs[xs.length - 1];
    },
    all: function(xs, f) {
      var x, _i, _len;
      if (f == null) {
        f = _.id;
      }
      for (_i = 0, _len = xs.length; _i < _len; _i++) {
        x = xs[_i];
        if (!f(x)) {
          return false;
        }
      }
      return true;
    },
    any: function(xs, f) {
      var x, _i, _len;
      if (f == null) {
        f = _.id;
      }
      for (_i = 0, _len = xs.length; _i < _len; _i++) {
        x = xs[_i];
        if (f(x)) {
          return true;
        }
      }
      return false;
    },
    without: function(x, xs) {
      return _.filter((function(y) {
        return y !== x;
      }), xs);
    },
    remove: function(x, xs) {
      var i;
      i = _.indexOf(xs, x);
      if (i >= 0) {
        return xs.splice(i, 1);
      }
    },
    fold: function(xs, seed, f) {
      var x, _i, _len;
      for (_i = 0, _len = xs.length; _i < _len; _i++) {
        x = xs[_i];
        seed = f(seed, x);
      }
      return seed;
    },
    flatMap: function(f, xs) {
      return _.fold(xs, [], (function(ys, x) {
        return ys.concat(f(x));
      }));
    },
    cached: function(f) {
      var value;
      value = None;
      return function() {
        if (value === None) {
          value = f();
          f = null;
        }
        return value;
      };
    },
    toString: function(obj) {
      var ex, internals, key, value;
      try {
        recursionDepth++;
        if (obj == null) {
          return "undefined";
        } else if (isFunction(obj)) {
          return "function";
        } else if (isArray(obj)) {
          if (recursionDepth > 5) {
            return "[..]";
          }
          return "[" + _.map(_.toString, obj).toString() + "]";
        } else if (((obj != null ? obj.toString : void 0) != null) && obj.toString !== Object.prototype.toString) {
          return obj.toString();
        } else if (typeof obj === "object") {
          if (recursionDepth > 5) {
            return "{..}";
          }
          internals = (function() {
            var _results;
            _results = [];
            for (key in obj) {
              if (!__hasProp.call(obj, key)) continue;
              value = (function() {
                try {
                  return obj[key];
                } catch (_error) {
                  ex = _error;
                  return ex;
                }
              })();
              _results.push(_.toString(key) + ":" + _.toString(value));
            }
            return _results;
          })();
          return "{" + internals + "}";
        } else {
          return obj;
        }
      } finally {
        recursionDepth--;
      }
    }
  };

  recursionDepth = 0;

  Bacon._ = _;

  Bacon.scheduler = {
    setTimeout: function(f, d) {
      return setTimeout(f, d);
    },
    setInterval: function(f, i) {
      return setInterval(f, i);
    },
    clearInterval: function(id) {
      return clearInterval(id);
    },
    now: function() {
      return new Date().getTime();
    }
  };

  if ((typeof define !== "undefined" && define !== null) && (define.amd != null)) {
    define([], function() {
      return Bacon;
    });
    this.Bacon = Bacon;
  } else if (typeof module !== "undefined" && module !== null) {
    module.exports = Bacon;
    Bacon.Bacon = Bacon;
  } else {
    this.Bacon = Bacon;
  }

}).call(this);

//jquery.class.js

(function( $ ) {

	// if we are initializing a new class
	var initializing = false,

		// tests if we can get super in .toString()
		fnTest = /xyz/.test(function() {
			xyz;
		}) ? /\b_super\b/ : /.*/,

		// overwrites an object with methods, sets up _super
		inheritProps = function( newProps, oldProps, addTo ) {
			addTo = addTo || newProps
			for ( var name in newProps ) {
				// Check if we're overwriting an existing function
				addTo[name] = typeof newProps[name] == "function" && typeof oldProps[name] == "function" && fnTest.test(newProps[name]) ? (function( name, fn ) {
					return function() {
						var tmp = this._super,
							ret;

						// Add a new ._super() method that is the same method
						// but on the super-class
						this._super = oldProps[name];

						// The method only need to be bound temporarily, so we
						// remove it when we're done executing
						ret = fn.apply(this, arguments);
						this._super = tmp;
						return ret;
					};
				})(name, newProps[name]) : newProps[name];
			}
		};


	/**
	 * @class jQuery.Class
	 * @plugin jquery/class
	 * @tag core
	 * @download dist/jquery/jquery.class.js
	 * @test jquery/class/qunit.html
	 * Class provides simulated inheritance in JavaScript. Use $.Class to bridge the gap between
	 * jQuery's functional programming style and Object Oriented Programming.
	 * It is based off John Resig's [http://ejohn.org/blog/simple-javascript-inheritance/|Simple Class]
	 * Inheritance library.  Besides prototypal inheritance, it includes a few important features:
	 * <ul>
	 *     <li>Static inheritance</li>
	 *     <li>Introspection</li>
	 *     <li>Namespaces</li>
	 *     <li>Setup and initialization methods</li>
	 *     <li>Easy callback function creation</li>
	 * </ul>
	 * <h2>Static v. Prototype</h2>
	 * <p>Before learning about Class, it's important to
	 * understand the difference between
	 * a class's <b>static</b> and <b>prototype</b> properties.
	 * </p>
	 * @codestart
	 * //STATIC
	 * MyClass.staticProperty  //shared property
	 *
	 * //PROTOTYPE
	 * myclass = new MyClass()
	 * myclass.prototypeMethod() //instance method
	 * @codeend
	 * <p>A static (or class) property is on the Class constructor
	 * function itself
	 * and can be thought of being shared by all instances of the Class.
	 * Prototype propertes are available only on instances of the Class.
	 * </p>
	 * <h2>A Basic Class</h2>
	 * <p>The following creates a Monster class with a
	 * name (for introspection), static, and prototype members.
	 * Every time a monster instance is created, the static
	 * count is incremented.
	 *
	 * </p>
	 * @codestart
	 * $.Class.extend('Monster',
	 * /* @static *|
	 * {
	 *   count: 0
	 * },
	 * /* @prototype *|
	 * {
	 *   init: function( name ) {
	 *
	 *     // saves name on the monster instance
	 *     this.name = name;
	 *
	 *     // sets the health
	 *     this.health = 10;
	 *
	 *     // increments count
	 *     this.Class.count++;
	 *   },
	 *   eat: function( smallChildren ){
	 *     this.health += smallChildren;
	 *   },
	 *   fight: function() {
	 *     this.health -= 2;
	 *   }
	 * });
	 *
	 * hydra = new Monster('hydra');
	 *
	 * dragon = new Monster('dragon');
	 *
	 * hydra.name        // -> hydra
	 * Monster.count     // -> 2
	 * Monster.shortName // -> 'Monster'
	 *
	 * hydra.eat(2);     // health = 12
	 *
	 * dragon.fight();   // health = 8
	 *
	 * @codeend
	 *
	 * <p>
	 * Notice that the prototype <b>init</b> function is called when a new instance of Monster is created.
	 * </p>
	 * <h2>Inheritance</h2>
	 * <p>When a class is extended, all static and prototype properties are available on the new class.
	 * If you overwrite a function, you can call the base class's function by calling
	 * <code>this._super</code>.  Lets create a SeaMonster class.  SeaMonsters are less
	 * efficient at eating small children, but more powerful fighters.
	 * </p>
	 * @codestart
	 * Monster.extend("SeaMonster",{
	 *   eat: function( smallChildren ) {
	 *     this._super(smallChildren / 2);
	 *   },
	 *   fight: function() {
	 *     this.health -= 1;
	 *   }
	 * });
	 *
	 * lockNess = new SeaMonster('Lock Ness');
	 * lockNess.eat(4);   //health = 12
	 * lockNess.fight();  //health = 11
	 * @codeend
	 * <h3>Static property inheritance</h3>
	 * You can also inherit static properties in the same way:
	 * @codestart
	 * $.Class.extend("First",
	 * {
	 *     staticMethod: function() { return 1;}
	 * },{})
	 *
	 * First.extend("Second",{
	 *     staticMethod: function() { return this._super()+1;}
	 * },{})
	 *
	 * Second.staticMethod() // -> 2
	 * @codeend
	 * <h2>Namespaces</h2>
	 * <p>Namespaces are a good idea! We encourage you to namespace all of your code.
	 * It makes it possible to drop your code into another app without problems.
	 * Making a namespaced class is easy:
	 * </p>
	 * @codestart
	 * $.Class.extend("MyNamespace.MyClass",{},{});
	 *
	 * new MyNamespace.MyClass()
	 * @codeend
	 * <h2 id='introspection'>Introspection</h2>
	 * Often, it's nice to create classes whose name helps determine functionality.  Ruby on
	 * Rails's [http://api.rubyonrails.org/classes/ActiveRecord/Base.html|ActiveRecord] ORM class
	 * is a great example of this.  Unfortunately, JavaScript doesn't have a way of determining
	 * an object's name, so the developer must provide a name.  Class fixes this by taking a String name for the class.
	 * @codestart
	 * $.Class.extend("MyOrg.MyClass",{},{})
	 * MyOrg.MyClass.shortName //-> 'MyClass'
	 * MyOrg.MyClass.fullName //->  'MyOrg.MyClass'
	 * @codeend
	 * The fullName (with namespaces) and the shortName (without namespaces) are added to the Class's
	 * static properties.
	 *
	 *
	 * <h2>Setup and initialization methods</h2>
	 * <p>
	 * Class provides static and prototype initialization functions.
	 * These come in two flavors - setup and init.
	 * Setup is called before init and
	 * can be used to 'normalize' init's arguments.
	 * </p>
	 * <div class='whisper'>PRO TIP: Typically, you don't need setup methods in your classes. Use Init instead.
	 * Reserve setup methods for when you need to do complex pre-processing of your class before init is called.
	 *
	 * </div>
	 * @codestart
	 * $.Class.extend("MyClass",
	 * {
	 *   setup: function() {} //static setup
	 *   init: function() {} //static constructor
	 * },
	 * {
	 *   setup: function() {} //prototype setup
	 *   init: function() {} //prototype constructor
	 * })
	 * @codeend
	 *
	 * <h3>Setup</h3>
	 * <p>Setup functions are called before init functions.  Static setup functions are passed
	 * the base class followed by arguments passed to the extend function.
	 * Prototype static functions are passed the Class constructor function arguments.</p>
	 * <p>If a setup function returns an array, that array will be used as the arguments
	 * for the following init method.  This provides setup functions the ability to normalize
	 * arguments passed to the init constructors.  They are also excellent places
	 * to put setup code you want to almost always run.</p>
	 * <p>
	 * The following is similar to how [jQuery.Controller.prototype.setup]
	 * makes sure init is always called with a jQuery element and merged options
	 * even if it is passed a raw
	 * HTMLElement and no second parameter.
	 * </p>
	 * @codestart
	 * $.Class.extend("jQuery.Controller",{
	 *   ...
	 * },{
	 *   setup: function( el, options ) {
	 *     ...
	 *     return [$(el),
	 *             $.extend(true,
	 *                this.Class.defaults,
	 *                options || {} ) ]
	 *   }
	 * })
	 * @codeend
	 * Typically, you won't need to make or overwrite setup functions.
	 * <h3>Init</h3>
	 *
	 * <p>Init functions are called after setup functions.
	 * Typically, they receive the same arguments
	 * as their preceding setup function.  The Foo class's <code>init</code> method
	 * gets called in the following example:
	 * </p>
	 * @codestart
	 * $.Class.Extend("Foo", {
	 *   init: function( arg1, arg2, arg3 ) {
	 *     this.sum = arg1+arg2+arg3;
	 *   }
	 * })
	 * var foo = new Foo(1,2,3);
	 * foo.sum //-> 6
	 * @codeend
	 * <h2>Callbacks</h2>
	 * <p>Similar to jQuery's proxy method, Class provides a
	 * [jQuery.Class.static.callback callback]
	 * function that returns a callback to a method that will always
	 * have
	 * <code>this</code> set to the class or instance of the class.
	 * </p>
	 * The following example uses this.callback to make sure
	 * <code>this.name</code> is available in <code>show</code>.
	 * @codestart
	 * $.Class.extend("Todo",{
	 *   init: function( name ) { this.name = name }
	 *   get: function() {
	 *     $.get("/stuff",this.callback('show'))
	 *   },
	 *   show: function( txt ) {
	 *     alert(this.name+txt)
	 *   }
	 * })
	 * new Todo("Trash").get()
	 * @codeend
	 * <p>Callback is available as a static and prototype method.</p>
	 * <h2>Demo</h2>
	 * @demo jquery/class/class.html
	 *
	 * @constructor Creating a new instance of an object that has extended jQuery.Class
	 *     calls the init prototype function and returns a new instance of the class.
	 *
	 */

	jQuery.Class = function() {
		if (arguments.length) {
			jQuery.Class.extend.apply(jQuery.Class, arguments);
		}
	};

	/* @Static*/
	$.extend($.Class, {
		/**
		 * @function callback
		 * Returns a callback function for a function on this Class.
		 * The callback function ensures that 'this' is set appropriately.  
		 * @codestart
		 * $.Class.extend("MyClass",{
		 *     getData: function() {
		 *         this.showing = null;
		 *         $.get("data.json",this.callback('gotData'),'json')
		 *     },
		 *     gotData: function( data ) {
		 *         this.showing = data;
		 *     }
		 * },{});
		 * MyClass.showData();
		 * @codeend
		 * <h2>Currying Arguments</h2>
		 * Additional arguments to callback will fill in arguments on the returning function.
		 * @codestart
		 * $.Class.extend("MyClass",{
		 *    getData: function( <b>callback</b> ) {
		 *      $.get("data.json",this.callback('process',<b>callback</b>),'json');
		 *    },
		 *    process: function( <b>callback</b>, jsonData ) { //callback is added as first argument
		 *        jsonData.processed = true;
		 *        callback(jsonData);
		 *    }
		 * },{});
		 * MyClass.getData(showDataFunc)
		 * @codeend
		 * <h2>Nesting Functions</h2>
		 * Callback can take an array of functions to call as the first argument.  When the returned callback function
		 * is called each function in the array is passed the return value of the prior function.  This is often used
		 * to eliminate currying initial arguments.
		 * @codestart
		 * $.Class.extend("MyClass",{
		 *    getData: function( callback ) {
		 *      //calls process, then callback with value from process
		 *      $.get("data.json",this.callback(['process2',callback]),'json') 
		 *    },
		 *    process2: function( type,jsonData ) {
		 *        jsonData.processed = true;
		 *        return [jsonData];
		 *    }
		 * },{});
		 * MyClass.getData(showDataFunc);
		 * @codeend
		 * @param {String|Array} fname If a string, it represents the function to be called.  
		 * If it is an array, it will call each function in order and pass the return value of the prior function to the
		 * next function.
		 * @return {Function} the callback function.
		 */
		callback: function( funcs ) {

			//args that should be curried
			var args = jQuery.makeArray(arguments),
				self;

			funcs = args.shift();

			if (!jQuery.isArray(funcs) ) {
				funcs = [funcs];
			}

			self = this;
			
			return function class_cb() {
				var cur = args.concat(jQuery.makeArray(arguments)),
					isString, 
					length = funcs.length,
					f = 0,
					func;

				for (; f < length; f++ ) {
					func = funcs[f];
					if (!func ) {
						continue;
					}

					isString = typeof func == "string";
					if ( isString && self._set_called ) {
						self.called = func;
					}
					cur = (isString ? self[func] : func).apply(self, cur || []);
					if ( f < length - 1 ) {
						cur = !jQuery.isArray(cur) || cur._use_call ? [cur] : cur
					}
				}
				return cur;
			}
		},
		/**
		 *   @function getObject 
		 *   Gets an object from a String.
		 *   If the object or namespaces the string represent do not
		 *   exist it will create them.  
		 *   @codestart
		 *   Foo = {Bar: {Zar: {"Ted"}}}
		 *   $.Class.getobject("Foo.Bar.Zar") //-> "Ted"
		 *   @codeend
		 *   @param {String} objectName the object you want to get
		 *   @param {Object} [current=window] the object you want to look in.
		 *   @return {Object} the object you are looking for.
		 */
		getObject: function( objectName, current ) {
			var current = current || window,
				parts = objectName ? objectName.split(/\./) : [],
				i = 0;
			for (; i < parts.length; i++ ) {
				current = current[parts[i]] || (current[parts[i]] = {})
			}
			return current;
		},
		/**
		 * @function newInstance
		 * Creates a new instance of the class.  This method is useful for creating new instances
		 * with arbitrary parameters.
		 * <h3>Example</h3>
		 * @codestart
		 * $.Class.extend("MyClass",{},{})
		 * var mc = MyClass.newInstance.apply(null, new Array(parseInt(Math.random()*10,10))
		 * @codeend
		 * @return {class} instance of the class
		 */
		newInstance: function() {
			var inst = this.rawInstance(),
				args;
			if ( inst.setup ) {
				args = inst.setup.apply(inst, arguments);
			}
			if ( inst.init ) {
				inst.init.apply(inst, $.isArray(args) ? args : arguments);
			}
			return inst;
		},
		/**
		 * Copy and overwrite options from old class
		 * @param {Object} oldClass
		 * @param {String} fullName
		 * @param {Object} staticProps
		 * @param {Object} protoProps
		 */
		setup: function( oldClass, fullName ) {
			this.defaults = $.extend(true, {}, oldClass.defaults, this.defaults);
			return arguments;
		},
		rawInstance: function() {
			initializing = true;
			var inst = new this();
			initializing = false;
			return inst;
		},
		/**
		 * Extends a class with new static and prototype functions.  There are a variety of ways
		 * to use extend:
		 * @codestart
		 * //with className, static and prototype functions
		 * $.Class.extend('Task',{ STATIC },{ PROTOTYPE })
		 * //with just classname and prototype functions
		 * $.Class.extend('Task',{ PROTOTYPE })
		 * //With just a className
		 * $.Class.extend('Task')
		 * @codeend
		 * @param {String} [fullName]  the classes name (used for classes w/ introspection)
		 * @param {Object} [klass]  the new classes static/class functions
		 * @param {Object} [proto]  the new classes prototype functions
		 * @return {jQuery.Class} returns the new class
		 */
		extend: function( fullName, klass, proto ) {
			// figure out what was passed
			if ( typeof fullName != 'string' ) {
				proto = klass;
				klass = fullName;
				fullName = null;
			}
			if (!proto ) {
				proto = klass;
				klass = null;
			}

			proto = proto || {};
			var _super_class = this,
				_super = this.prototype,
				name, shortName, namespace, prototype;

			// Instantiate a base class (but only create the instance,
			// don't run the init constructor)
			initializing = true;
			prototype = new this();
			initializing = false;
			// Copy the properties over onto the new prototype
			inheritProps(proto, _super, prototype);

			// The dummy class constructor

			function Class() {
				// All construction is actually done in the init method
				if ( initializing ) return;

				if ( this.constructor !== Class && arguments.length ) { //we are being called w/o new
					return arguments.callee.extend.apply(arguments.callee, arguments)
				} else { //we are being called w/ new
					return this.Class.newInstance.apply(this.Class, arguments)
				}
			}
			// Copy old stuff onto class
			for ( name in this ) {
				if ( this.hasOwnProperty(name) && $.inArray(name, ['prototype', 'defaults', 'getObject']) == -1 ) {
					Class[name] = this[name];
				}
			}

			// do static inheritance
			inheritProps(klass, this, Class);

			// do namespace stuff
			if ( fullName ) {

				var parts = fullName.split(/\./),
					shortName = parts.pop(),
					current = $.Class.getObject(parts.join('.')),
					namespace = current;

				
				current[shortName] = Class;
			}

			// set things that can't be overwritten
			$.extend(Class, {
				prototype: prototype,
				namespace: namespace,
				shortName: shortName,
				constructor: Class,
				fullName: fullName
			});

			//make sure our prototype looks nice
			Class.prototype.Class = Class.prototype.constructor = Class;


			/**
			 * @attribute fullName 
			 * The full name of the class, including namespace, provided for introspection purposes.
			 * @codestart
			 * $.Class.extend("MyOrg.MyClass",{},{})
			 * MyOrg.MyClass.shortName //-> 'MyClass'
			 * MyOrg.MyClass.fullName //->  'MyOrg.MyClass'
			 * @codeend
			 */

			var args = Class.setup.apply(Class, [_super_class].concat($.makeArray(arguments)));

			if ( Class.init ) {
				Class.init.apply(Class, args || []);
			}

			/* @Prototype*/
			return Class;
			/** 
			 * @function setup
			 * Called with the same arguments as new Class(arguments ...) when a new instance is created.
			 * @codestart
			 * $.Class.extend("MyClass",
			 * {
			 *    setup: function( val ) {
			 *       this.val = val;
			 *    }
			 * })
			 * var mc = new MyClass("Check Check")
			 * mc.val //-> 'Check Check'
			 * @codeend
			 * 
			 * <div class='whisper'>PRO TIP: 
			 * Setup functions are used to normalize constructor arguments and provide a place for
			 * setup code that extending classes don't have to remember to call _super to
			 * run.
			 * </div>
			 * 
			 * @return {Array|undefined} If an array is return, [jQuery.Class.prototype.init] is 
			 * called with those arguments; otherwise, the original arguments are used.
			 */
			//break up
			/** 
			 * @function init
			 * Called with the same arguments as new Class(arguments ...) when a new instance is created.
			 * @codestart
			 * $.Class.extend("MyClass",
			 * {
			 *    init: function( val ) {
			 *       this.val = val;
			 *    }
			 * })
			 * var mc = new MyClass("Check Check")
			 * mc.val //-> 'Check Check'
			 * @codeend
			 */
			//Breaks up code
			/**
			 * @attribute Class
			 * References the static properties of the instance's class.
			 * <h3>Quick Example</h3>
			 * @codestart
			 * // a class with a static classProperty property
			 * $.Class.extend("MyClass", {classProperty : true}, {});
			 * 
			 * // a new instance of myClass
			 * var mc1 = new MyClass();
			 * 
			 * //
			 * mc1.Class.classProperty = false;
			 * 
			 * // creates a new MyClass
			 * var mc2 = new mc.Class();
			 * @codeend
			 * Getting static properties via the Class property, such as it's 
			 * [jQuery.Class.static.fullName fullName] is very common.
			 */
		}

	})





	jQuery.Class.prototype.
	/**
	 * @function callback
	 * Returns a callback function.  This does the same thing as and is described better in [jQuery.Class.static.callback].
	 * The only difference is this callback works
	 * on a instance instead of a class.
	 * @param {String|Array} fname If a string, it represents the function to be called.  
	 * If it is an array, it will call each function in order and pass the return value of the prior function to the
	 * next function.
	 * @return {Function} the callback function
	 */
	callback = jQuery.Class.callback;


})(jQuery);

//jquery.lang.js

(function( $ ) {
	// Several of the methods in this plugin use code adapated from Prototype
	//  Prototype JavaScript framework, version 1.6.0.1
	//  (c) 2005-2007 Sam Stephenson
	var regs = {
		undHash: /_|-/,
		colons: /::/,
		words: /([A-Z]+)([A-Z][a-z])/g,
		lowerUpper: /([a-z\d])([A-Z])/g,
		dash: /([a-z\d])([A-Z])/g,
		replacer: /\{([^\}]+)\}/g
	},
	getObject = function( objectName, current, remove) {
		var current = current || window,
			parts = objectName ? objectName.split(/\./) : [],
			ret,
			i = 0;
		for (; i < parts.length-1 && current; i++ ) {
			current = current[parts[i]]
		}
		ret = current[parts[i]];
		if(remove){
			delete current[parts[i]];
		}
		return ret;
	};

	/** 
	 * @class jQuery.String
	 */
	var str = ($.String =
	{
		/**
		 * @function strip
		 * @param {String} s returns a string with leading and trailing whitespace removed.
		 */
		strip: function( string ) {
			return string.replace(/^\s+/, '').replace(/\s+$/, '');
		},
		/**
		 * Capitalizes a string
		 * @param {String} s the string to be lowercased.
		 * @return {String} a string with the first character capitalized, and everything else lowercased
		 */
		capitalize: function( s, cache ) {
			return s.charAt(0).toUpperCase() + s.substr(1);
		},

		/**
		 * Returns if string ends with another string
		 * @param {String} s String that is being scanned
		 * @param {String} pattern What the string might end with
		 * @return {Boolean} true if the string ends wtih pattern, false if otherwise
		 */
		endsWith: function( s, pattern ) {
			var d = s.length - pattern.length;
			return d >= 0 && s.lastIndexOf(pattern) === d;
		},
		/**
		 * Capitalizes a string from something undercored. Examples:
		 * @codestart
		 * jQuery.String.camelize("one_two") //-> "oneTwo"
		 * "three-four".camelize() //-> threeFour
		 * @codeend
		 * @param {String} s
		 * @return {String} a the camelized string
		 */
		camelize: function( s ) {
			var parts = s.split(regs.undHash),
				i = 1;
			parts[0] = parts[0].charAt(0).toLowerCase() + parts[0].substr(1);
			for (; i < parts.length; i++ ) {
				parts[i] = str.capitalize(parts[i]);
			}

			return parts.join('');
		},
		/**
		 * Like camelize, but the first part is also capitalized
		 * @param {String} s
		 * @return {String} the classized string
		 */
		classize: function( s ) {
			var parts = s.split(regs.undHash),
				i = 0;
			for (; i < parts.length; i++ ) {
				parts[i] = str.capitalize(parts[i]);
			}

			return parts.join('');
		},
		/**
		 * Like [jQuery.String.classize|classize], but a space separates each 'word'
		 * @codestart
		 * jQuery.String.niceName("one_two") //-> "One Two"
		 * @codeend
		 * @param {String} s
		 * @return {String} the niceName
		 */
		niceName: function( s ) {
			var parts = s.split(regs.undHash),
				i = 0;
			for (; i < parts.length; i++ ) {
				parts[i] = str.capitalize(parts[i]);
			}

			return parts.join(' ');
		},

		/**
		 * Underscores a string.
		 * @codestart
		 * jQuery.String.underscore("OneTwo") //-> "one_two"
		 * @codeend
		 * @param {String} s
		 * @return {String} the underscored string
		 */
		underscore: function( s ) {
			return s.replace(regs.colons, '/').replace(regs.words, '$1_$2').replace(regs.lowerUpper, '$1_$2').replace(regs.dash, '_').toLowerCase();
		},
		/**
		 * Returns a string with {param} replaced with parameters
		 * from data.
		 *     $.String.sub("foo {bar}",{bar: "far"})
		 *     //-> "foo far"
		 * @param {String} s
		 * @param {Object} data
		 */
		sub : function( s, data, remove ){
			return s.replace(regs.replacer, function( whole, inside ) {
				//convert inside to type
				return getObject(inside, data, remove).toString(); //gets the value in options
			})
		}
	});

})(jQuery);

//jquery.event.js



//jquery.event.destroyed.js

(function( $ ) {
	/**
	 * @attribute destroyed
	 * @parent specialevents
	 * @download  http://jmvcsite.heroku.com/pluginify?plugins[]=jquery/dom/destroyed/destroyed.js
	 * @test jquery/event/destroyed/qunit.html
	 * Provides a destroyed event on an element.
	 * <p>
	 * The destroyed event is called when the element
	 * is removed as a result of jQuery DOM manipulators like remove, html,
	 * replaceWith, etc. Destroyed events do not bubble, so make sure you don't use live or delegate with destroyed
	 * events.
	 * </p>
	 * <h2>Quick Example</h2>
	 * @codestart
	 * $(".foo").bind("destroyed", function(){
	 *    //clean up code
	 * })
	 * @codeend
	 * <h2>Quick Demo</h2>
	 * @demo jquery/event/destroyed/destroyed.html 
	 * <h2>More Involved Demo</h2>
	 * @demo jquery/event/destroyed/destroyed_menu.html 
	 */

	var oldClean = jQuery.cleanData;

	$.cleanData = function( elems ) {
		for ( var i = 0, elem;
		(elem = elems[i]) !== undefined; i++ ) {
			$(elem).triggerHandler("destroyed");
			//$.event.remove( elem, 'destroyed' );
		}
		oldClean(elems);
	};

})(jQuery);

//jquery.controller.js

(function( $ ) {

	// ------- helpers  ------
	// Binds an element, returns a function that unbinds
	var bind = function( el, ev, callback ) {
		var wrappedCallback;
		//this is for events like >click.
		if ( ev.indexOf(">") === 0 ) {
			ev = ev.substr(1);
			wrappedCallback = function( event ) {
				if ( event.target === el ) {
					callback.apply(this, arguments);
				} else {
					event.handled = null;
				}
			};
		}
		$(el).bind(ev, wrappedCallback || callback);
		// if ev name has >, change the name and bind
		// in the wrapped callback, check that the element matches the actual element
		return function() {
			$(el).unbind(ev, wrappedCallback || callback);
			el = ev = callback = wrappedCallback = null;
		};
	},
		// Binds an element, returns a function that unbinds
		delegate = function( el, selector, ev, callback ) {
			$(el).delegate(selector, ev, callback);
			return function() {
				$(el).undelegate(selector, ev, callback);
				el = ev = callback = selector = null;
			};
		},
		binder = function( el, ev, callback, selector ) {
			return selector ? delegate(el, selector, ev, callback) : bind(el, ev, callback);
		},
		/**
		 * moves 'this' to the first argument 
		 */
		shifter = function shifter(cb) {
			return function() {
				return cb.apply(null, [$(this)].concat(Array.prototype.slice.call(arguments, 0)));
			};
		},
		// matches dots
		dotsReg = /\./g,
		// matches controller
		controllersReg = /_?controllers?/ig,
		//used to remove the controller from the name
		underscoreAndRemoveController = function( className ) {
			return $.String.underscore(className.replace("jQuery.","").replace(dotsReg, '_').replace(controllersReg, ""));
		},
		// checks if it looks like an action
		actionMatcher = /[^\w]/,
		// gets jus the event
		eventCleaner = /^(>?default\.)|(>)/,
		// handles parameterized action names
		parameterReplacer = /\{([^\}]+)\}/g,
		breaker = /^(?:(.*?)\s)?([\w\.\:>]+)$/,
		basicProcessor;
	/**
	 * @tag core
	 * @plugin jquery/controller
	 * @download  http://jmvcsite.heroku.com/pluginify?plugins[]=jquery/controller/controller.js
	 * @test jquery/controller/qunit.html
	 * 
	 * Controllers organize event handlers using event delegation. 
	 * If something happens in your application (a user click or a [jQuery.Model|Model] instance being updated), 
	 * a controller should respond to it.  
	 * 
	 * Controllers make your code deterministic, reusable, organized and can tear themselves 
	 * down auto-magically. Read about [http://jupiterjs.com/news/writing-the-perfect-jquery-plugin 
	 * the theory behind controller] and 
	 * a [http://jupiterjs.com/news/organize-jquery-widgets-with-jquery-controller walkthrough of its features]
	 * on Jupiter's blog.
	 * 
	 * 
	 * ## Basic Example
	 * 
	 * Instead of
	 * 
	 * @codestart
	 * $(function(){
	 *   $('#tabs').click(someCallbackFunction1)
	 *   $('#tabs .tab').click(someCallbackFunction2)
	 *   $('#tabs .delete click').click(someCallbackFunction3)
	 * });
	 * @codeend
	 * 
	 * do this
	 * 
	 * @codestart
	 * $.Controller('Tabs',{
	 *   click: function() {...},
	 *   '.tab click' : function() {...},
	 *   '.delete click' : function() {...}
	 * })
	 * $('#tabs').tabs();
	 * @codeend
	 * 
	 * ## Tabs Example
	 * 
	 * @demo jquery/controller/controller.html
	 * 
	 * 
	 * ## Using Controller
	 * 
	 * Controller helps you build and organize jQuery plugins.  It can be used
	 * to build simple widgets, like a slider, or organize multiple
	 * widgets into something greater.
	 * 
	 * To understand how to use Controller, you need to understand 
	 * the typical lifecycle of a jQuery widget and how that maps to
	 * controller's functionality:
	 * 
	 * ### A controller class is created.
	 *       
	 *     $.Controller("MyWidget",
	 *     {
	 *       defaults :  {
	 *         message : "Remove Me"
	 *       }
	 *     },
	 *     {
	 *       init : function(rawEl, rawOptions){ 
	 *         this.element.append(
	 *            "<div>"+this.options.message+"</div>"
	 *           );
	 *       },
	 *       "div click" : function(div, ev){ 
	 *         div.remove();
	 *       }  
	 *     }) 
	 *     
	 * This creates a <code>$.fn.my_widget</code> [jquery.controller.plugin jQuery helper function]
	 * that can be used to create a new controller instance on an element.
	 *       
	 * ### An instance of controller is created on an element
	 * 
	 *     $('.thing').my_widget(options) // calls new MyWidget(el, options)
	 * 
	 * This calls <code>new MyWidget(el, options)</code> on 
	 * each <code>'.thing'</code> element.  
	 *     
	 * When a new [jQuery.Class Class] instance is created, it calls the class's
	 * prototype setup and init methods. Controller's [jQuery.Controller.prototype.setup setup]
	 * method:
	 *     
	 *  - Sets [jQuery.Controller.prototype.element this.element] and adds the controller's name to element's className.
	 *  - Merges passed in options with defaults object and sets it as [jQuery.Controller.prototype.options this.options]
	 *  - Saves a reference to the controller in <code>$.data</code>.
	 *  - [jquery.controller.listening Binds all event handler methods].
	 *   
	 * 
	 * ### The controller responds to events
	 * 
	 * Typically, Controller event handlers are automatically bound.  However, there are
	 * multiple ways to [jquery.controller.listening listen to events] with a controller.
	 * 
	 * Once an event does happen, the callback function is always called with 'this' 
	 * referencing the controller instance.  This makes it easy to use helper functions and
	 * save state on the controller.
	 * 
	 * 
	 * ### The widget is destroyed
	 * 
	 * If the element is removed from the page, the 
	 * controller's [jQuery.Controller.prototype.destroy] method is called.
	 * This is a great place to put any additional teardown functionality.
	 * 
	 * You can also teardown a controller programatically like:
	 * 
	 *     $('.thing').my_widget('destroy');
	 * 
	 * ## Todos Example
	 * 
	 * Lets look at a very basic example - 
	 * a list of todos and a button you want to click to create a new todo.
	 * Your HTML might look like:
	 * 
	 * @codestart html
	 * &lt;div id='todos'>
	 *  &lt;ol>
	 *    &lt;li class="todo">Laundry&lt;/li>
	 *    &lt;li class="todo">Dishes&lt;/li>
	 *    &lt;li class="todo">Walk Dog&lt;/li>
	 *  &lt;/ol>
	 *  &lt;a class="create">Create&lt;/a>
	 * &lt;/div>
	 * @codeend
	 * 
	 * To add a mousover effect and create todos, your controller might look like:
	 * 
	 * @codestart
	 * $.Controller.extend('Todos',{
	 *   ".todo mouseover" : function( el, ev ) {
	 *    el.css("backgroundColor","red")
	 *   },
	 *   ".todo mouseout" : function( el, ev ) {
	 *    el.css("backgroundColor","")
	 *   },
	 *   ".create click" : function() {
	 *    this.find("ol").append("&lt;li class='todo'>New Todo&lt;/li>"); 
	 *   }
	 * })
	 * @codeend
	 * 
	 * Now that you've created the controller class, you've must attach the event handlers on the '#todos' div by
	 * creating [jQuery.Controller.prototype.setup|a new controller instance].  There are 2 ways of doing this.
	 * 
	 * @codestart
	 * //1. Create a new controller directly:
	 * new Todos($('#todos'));
	 * //2. Use jQuery function
	 * $('#todos').todos();
	 * @codeend
	 * 
	 * ## Controller Initialization
	 * 
	 * It can be extremely useful to add an init method with 
	 * setup functionality for your widget.
	 * 
	 * In the following example, I create a controller that when created, will put a message as the content of the element:
	 * 
	 * @codestart
	 * $.Controller.extend("SpecialController",
	 * {
	 *   init: function( el, message ) {
	 *      this.element.html(message)
	 *   }
	 * })
	 * $(".special").special("Hello World")
	 * @codeend
	 * 
	 * ## Removing Controllers
	 * 
	 * Controller removal is built into jQuery.  So to remove a controller, you just have to remove its element:
	 * 
	 * @codestart
	 * $(".special_controller").remove()
	 * $("#containsControllers").html("")
	 * @codeend
	 * 
	 * It's important to note that if you use raw DOM methods (<code>innerHTML, removeChild</code>), the controllers won't be destroyed.
	 * 
	 * If you just want to remove controller functionality, call destroy on the controller instance:
	 * 
	 * @codestart
	 * $(".special_controller").controller().destroy()
	 * @codeend
	 * 
	 * ## Accessing Controllers
	 * 
	 * Often you need to get a reference to a controller, there are a few ways of doing that.  For the 
	 * following example, we assume there are 2 elements with <code>className="special"</code>.
	 * 
	 * @codestart
	 * //creates 2 foo controllers
	 * $(".special").foo()
	 * 
	 * //creates 2 bar controllers
	 * $(".special").bar()
	 * 
	 * //gets all controllers on all elements:
	 * $(".special").controllers() //-> [foo, bar, foo, bar]
	 * 
	 * //gets only foo controllers
	 * $(".special").controllers(FooController) //-> [foo, foo]
	 * 
	 * //gets all bar controllers
	 * $(".special").controllers(BarController) //-> [bar, bar]
	 * 
	 * //gets first controller
	 * $(".special").controller() //-> foo
	 * 
	 * //gets foo controller via data
	 * $(".special").data("controllers")["FooController"] //-> foo
	 * @codeend
	 * 
	 * ## Calling methods on Controllers
	 * 
	 * Once you have a reference to an element, you can call methods on it.  However, Controller has
	 * a few shortcuts:
	 * 
	 * @codestart
	 * //creates foo controller
	 * $(".special").foo({name: "value"})
	 * 
	 * //calls FooController.prototype.update
	 * $(".special").foo({name: "value2"})
	 * 
	 * //calls FooController.prototype.bar
	 * $(".special").foo("bar","something I want to pass")
	 * @codeend
	 */
	$.Class.extend("jQuery.Controller",
	/** 
	 * @Static
	 */
	{
		/**
		 * Does 3 things:
		 * <ol>
		 *     <li>Creates a jQuery helper for this controller.</li>
		 *     <li>Calculates and caches which functions listen for events.</li>
		 *     <li> and attaches this element to the documentElement if onDocument is true.</li>
		 * </ol>   
		 * <h3>jQuery Helper Naming Examples</h3>
		 * @codestart
		 * "TaskController" -> $().task_controller()
		 * "Controllers.Task" -> $().controllers_task()
		 * @codeend
		 */
		init: function() {
			// if you didn't provide a name, or are controller, don't do anything
			if (!this.shortName || this.fullName == "jQuery.Controller" ) {
				return;
			}

			// cache the underscored names
			this._fullName = underscoreAndRemoveController(this.fullName);
			this._shortName = underscoreAndRemoveController(this.shortName);

			var controller = this,
				pluginname = this.pluginName || this._fullName,
				funcName, forLint;

			// create jQuery plugin
			if (!$.fn[pluginname] ) {
				$.fn[pluginname] = function( options ) {

					var args = $.makeArray(arguments),
						//if the arg is a method on this controller
						isMethod = typeof options == "string" && $.isFunction(controller.prototype[options]),
						meth = args[0];
					this.each(function() {
						//check if created
						var controllers = $.data(this, "controllers"),
							//plugin is actually the controller instance
							plugin = controllers && controllers[pluginname];

						if ( plugin ) {
							if ( isMethod ) {
								// call a method on the controller with the remaining args
								plugin[meth].apply(plugin, args.slice(1));
							} else {
								// call the plugin's update method
								plugin.update.apply(plugin, args);
							}

						} else {
							//create a new controller instance
							controller.newInstance.apply(controller, [this].concat(args));
						}
					});
					//always return the element
					return this;
				};
			}

			// make sure listensTo is an array
			
			// calculate and cache actions
			this.actions = {};

			for ( funcName in this.prototype ) {
				if (!$.isFunction(this.prototype[funcName]) ) {
					continue;
				}
				if ( this._isAction(funcName) ) {
					this.actions[funcName] = this._getAction(funcName);
				}
			}

			/**
			 * @attribute onDocument
			 * Set to true if you want to automatically attach this element to the documentElement.
			 */
			if ( this.onDocument ) {
				forLint = new controller(document.documentElement);
			}
		},
		hookup: function( el ) {
			return new this(el);
		},

		/**
		 * @hide
		 * @param {String} methodName a prototype function
		 * @return {Boolean} truthy if an action or not
		 */
		_isAction: function( methodName ) {
			if ( actionMatcher.test(methodName) ) {
				return true;
			} else {
				var cleanedEvent = methodName.replace(eventCleaner, "");
				return $.inArray(cleanedEvent, this.listensTo) > -1 || $.event.special[cleanedEvent] || $.Controller.processors[cleanedEvent];
			}

		},
		/**
		 * @hide
		 * @param {Object} methodName the method that will be bound
		 * @param {Object} [options] first param merged with class default options
		 * @return {Object} null or the processor and pre-split parts.  
		 * The processor is what does the binding/subscribing.
		 */
		_getAction: function( methodName, options ) {
			//if we don't have a controller instance, we'll break this guy up later
			parameterReplacer.lastIndex = 0;
			if (!options && parameterReplacer.test(methodName) ) {
				return null;
			}
			var convertedName = options ? $.String.sub(methodName, options) : methodName,
				parts = convertedName.match(breaker),
				event = parts[2],
				processor = this.processors[event] || basicProcessor;
			return {
				processor: processor,
				parts: parts
			};
		},
		/**
		 * @attribute processors
		 * An object of {eventName : function} pairs that Controller uses to hook up events
		 * auto-magically.  A processor function looks like:
		 * 
		 *     jQuery.Controller.processors.
		 *       myprocessor = function( el, event, selector, cb, controller ) {
		 *          //el - the controller's element
		 *          //event - the event (myprocessor)
		 *          //selector - the left of the selector
		 *          //cb - the function to call
		 *          //controller - the binding controller
		 * 	     };
		 * 
		 * This would bind anything like: "foo~3242 myprocessor".
		 * 
		 * The processor must return a function that when called, 
		 * unbinds the event handler.
		 * 
		 */
		processors: {},
		/**
		 * @attribute listensTo
		 * A list of special events this controller listens too.  You only need to add event names that
		 * are whole words (ie have no special characters).
		 */
		listensTo: [],
		/**
		 * @attribute defaults
		 * A object of name-value pairs that act as default values for a controller's 
		 * [jQuery.Controller.prototype.options options].
		 * 
		 *     $.Controller("Message",
		 *     {
		 *       defaults : {
		 *         message : "Hello World"
		 *       }
		 *     },{
		 *       init : function(){
		 *         this.element.text(this.options.message);
		 *       }
		 *     })
		 *     
		 *     $("#el1").message(); //writes "Hello World"
		 *     $("#el12").message({message: "hi"}); //writes hi
		 */
		defaults : {}
	},
	/** 
	 * @Prototype
	 */
	{
		/**
		 * Setup is where most of controller's magic happens.  It does the following:
		 * 
		 * ### Sets this.element
		 * 
		 * The first parameter passed to new Controller(el, options) is expected to be 
		 * an element.  This gets converted to a jQuery wrapped element and set as
		 * [jQuery.Controller.prototype.element this.element].
		 * 
		 * ### Adds the controller's name to the element's className.
		 * 
		 * Controller adds it's plugin name to the element's className for easier 
		 * debugging.  For example, if your Controller is named "Foo.Bar", it adds
		 * "foo_bar" to the className.
		 * 
		 * ### Saves the controller in $.data
		 * 
		 * A reference to the controller instance is saved in $.data.  You can find 
		 * instances of "Foo.Bar" like: 
		 * 
		 *     $("#el").data("controllers")['foo_bar'].
		 * 
		 * ### Binds event handlers
		 * 
		 * Setup does the event binding described in [jquery.controller.listening Listening To Events].
		 * 
		 * ## API
		 * @param {HTMLElement} element the element this instance operates on.
		 * @param {Object} [options] option values for the controller.  These get added to
		 * this.options.
		 */
		setup: function( element, options ) {
			var funcName, ready, cls = this.Class;

			//want the raw element here
			element = element.jquery ? element[0] : element;

			//set element and className on element
			this.element = $(element);

			//set in data
			($.data(element, "controllers") || $.data(element, "controllers", {}))[cls._fullName] = this;

			//adds bindings
			this._bindings = [];
			/**
			 * @attribute options
			 * Options is [jQuery.Controller.static.defaults] merged with the 2nd argument
			 * passed to a controller (or the first argument passed to the 
			 * [jquery.controller.plugin controller's jQuery plugin]).
			 * 
			 * For example:
			 * 
			 *     $.Controller("Tabs", 
			 *     {
			 *        defaults : {
			 *          activeClass: "ui-active-state"
			 *        }
			 *     },
			 *     {
			 *        init : function(){
			 *          this.element.addClass(this.options.activeClass);
			 *        }
			 *     })
			 *     
			 *     $("#tabs1").tabs()                         // adds 'ui-active-state'
			 *     $("#tabs2").tabs({activeClass : 'active'}) // adds 'active'
			 *     
			 *  
			 */
			this.options = $.extend($.extend(true, {}, cls.defaults), options);

			//go through the cached list of actions and use the processor to bind
			for ( funcName in cls.actions ) {
				ready = cls.actions[funcName] || cls._getAction(funcName, this.options);

				this._bindings.push(
				ready.processor(element, ready.parts[2], ready.parts[1], this.callback(funcName), this));
			}


			/**
			 * @attribute called
			 * String name of current function being called on controller instance.  This is 
			 * used for picking the right view in render.
			 * @hide
			 */
			this.called = "init";

			//setup to be destroyed ... don't bind b/c we don't want to remove it
			//this.element.bind('destroyed', this.callback('destroy'))
			var destroyCB = shifter(this.callback("destroy"));
			this.element.bind("destroyed", destroyCB);
			this._bindings.push(function( el ) {
				destroyCB.removed = true;
				$(element).unbind("destroyed", destroyCB);
			});

			/**
			 * @attribute element
			 * The controller instance's delegated element. This 
			 * is set by [jQuery.Controller.prototype.setup setup]. It 
			 * is a jQuery wrapped element.
			 * 
			 * For example, if I add MyWidget to a '#myelement' element like:
			 * 
			 *     $.Controller("MyWidget",{
			 *       init : function(){
			 *         this.element.css("color","red")
			 *       }
			 *     })
			 *     
			 *     $("#myelement").my_widget()
			 * 
			 * MyWidget will turn #myelement's font color red.
			 * 
			 * ## Using a different element.
			 * 
			 * Sometimes, you want a different element to be this.element.  A
			 * very common example is making progressively enhanced form widgets.
			 * 
			 * To change this.element, overwrite Controller's setup method like:
			 * 
			 *     $.Controller("Combobox",{
			 *       setup : function(el, options){
			 *          this.oldElement = $(el);
			 *          var newEl = $('<div/>');
			 *          this.oldElement.wrap(newEl);
			 *          this._super(newEl, options);
			 *       },
			 *       init : function(){
			 *          this.element //-> the div
			 *       },
			 *       ".option click" : function(){
			 *         // event handler bound on the div
			 *       },
			 *       destroy : function(){
			 *          var div = this.element; //save reference
			 *          this._super();
			 *          div.replaceWith(this.oldElement);
			 *       }
			 *     }
			 */
			return this.element;
		},
		/**
		 * Bind attaches event handlers that will be removed when the controller is removed.  
		 * This is a good way to attach to an element not in the controller's element.
		 * <br/>
		 * <h3>Examples:</h3>
		 * @codestart
		 * init: function() {
		 *    // calls somethingClicked(el,ev)
		 *    this.bind('click','somethingClicked') 
		 * 
		 *    // calls function when the window is clicked
		 *    this.bind(window, 'click', function(ev){
		 *      //do something
		 *    })
		 * },
		 * somethingClicked: function( el, ev ) {
		 *   
		 * }
		 * @codeend
		 * @param {HTMLElement|jQuery.fn} [el=this.element] The element to be bound
		 * @param {String} eventName The event to listen for.
		 * @param {Function|String} func A callback function or the String name of a controller function.  If a controller
		 * function name is given, the controller function is called back with the bound element and event as the first
		 * and second parameter.  Otherwise the function is called back like a normal bind.
		 * @return {Integer} The id of the binding in this._bindings
		 */
		bind: function( el, eventName, func ) {
			if ( typeof el == 'string' ) {
				func = eventName;
				eventName = el;
				el = this.element;
			}
			return this._binder(el, eventName, func);
		},
		_binder: function( el, eventName, func, selector ) {
			if ( typeof func == 'string' ) {
				func = shifter(this.callback(func));
			}
			this._bindings.push(binder(el, eventName, func, selector));
			return this._bindings.length;
		},
		/**
		 * Delegate will delegate on an elememt and will be undelegated when the controller is removed.
		 * This is a good way to delegate on elements not in a controller's element.<br/>
		 * <h3>Example:</h3>
		 * @codestart
		 * // calls function when the any 'a.foo' is clicked.
		 * this.delegate(document.documentElement,'a.foo', 'click', function(ev){
		 *   //do something
		 * })
		 * @codeend
		 * @param {HTMLElement|jQuery.fn} [element=this.element] the element to delegate from
		 * @param {String} selector the css selector
		 * @param {String} eventName the event to bind to
		 * @param {Function|String} func A callback function or the String name of a controller function.  If a controller
		 * function name is given, the controller function is called back with the bound element and event as the first
		 * and second parameter.  Otherwise the function is called back like a normal bind.
		 * @return {Integer} The id of the binding in this._bindings
		 */
		delegate: function( element, selector, eventName, func ) {

			if ( typeof element == 'string' ) {
				func = eventName;
				eventName = selector;
				selector = element;
				element = this.element;
			}
			return this._binder(element, eventName, func, selector);
		},
		/**
		 * Called if an controller's [jquery.controller.plugin jQuery helper] is called on an element that already has a controller instance
		 * of the same type.  Extends [jQuery.Controller.prototype.options this.options] with the options passed in.  If you overwrite this, you might want to call
		 * this._super.
		 * <h3>Examples</h3>
		 * @codestart
		 * $.Controller.extend("Thing",{
		 * init: function( el, options ) {
		 *    alert('init')
		 * },
		 * update: function( options ) {
		 *    this._super(options);
		 *    alert('update')
		 * }
		 * });
		 * $('#myel').thing(); // alerts init
		 * $('#myel').thing(); // alerts update
		 * @codeend
		 * @param {Object} options
		 */
		update: function( options ) {
			$.extend(this.options, options);
		},
		/**
		 * Destroy unbinds and undelegates all event handlers on this controller, 
		 * and prevents memory leaks.  This is called automatically
		 * if the element is removed.  You can overwrite it to add your own
		 * teardown functionality:
		 * 
		 *     $.Controller("ChangeText",{
		 *       init : function(){
		 *         this.oldText = this.element.text();
		 *         this.element.text("Changed!!!")
		 *       },
		 *       destroy : function(){
		 *         this.element.text(this.oldText);
		 *         this._super(); //Always call this!
		 *     })
		 * 
		 * You could call destroy manually on an element with ChangeText
		 * added like:
		 * 
		 *     $("#changed").change_text("destroy");
		 *     
		 * ### API
		 */
		destroy: function( ) {
			if ( this._destroyed ) {
				throw this.Class.shortName + " controller instance has been deleted";
			}
			var self = this,
				fname = this.Class._fullName;
			this._destroyed = true;
			this.element.removeClass(fname);

			$.each(this._bindings, function( key, value ) {
				if ( $.isFunction(value) ) {
					value(self.element[0]);
				}
			});

			delete this._actions;


			var controllers = this.element.data("controllers");
			if ( controllers && controllers[fname] ) {
				delete controllers[fname];
			}
			$(this).triggerHandler("destroyed"); //in case we want to know if the controller is removed
			this.element = null;
		},
		/**
		 * Queries from the controller's element.
		 * @codestart
		 * ".destroy_all click" : function() {
		 *    this.find(".todos").remove();
		 * }
		 * @codeend
		 * @param {String} selector selection string
		 * @return {jQuery.fn} returns the matched elements
		 */
		find: function( selector ) {
			return this.element.find(selector);
		},
		//tells callback to set called on this.  I hate this.
		_set_called: true
	});


	//------------- PROCESSSORS -----------------------------
	//processors do the binding.  They return a function that
	//unbinds when called.
	//the basic processor that binds events
	basicProcessor = function( el, event, selector, cb, controller ) {
		var c = controller.Class;

		// document controllers use their name as an ID prefix.
		if ( c.onDocument && !/^Main(Controller)?$/.test(c.shortName) ) { //prepend underscore name if necessary
			selector = selector ? "#" + c._shortName + " " + selector : "#" + c._shortName;
		}
		return binder(el, event, shifter(cb), selector);
	};

	var processors = $.Controller.processors,

		//a window event only happens on the window
		windowEvent = function( el, event, selector, cb ) {
			return binder(window, event.replace(/window/, ""), shifter(cb));
		};

	//set commong events to be processed as a basicProcessor
	$.each("change click contextmenu dblclick keydown keyup keypress mousedown mousemove mouseout mouseover mouseup reset windowresize resize windowscroll scroll select submit dblclick focusin focusout load unload ready hashchange mouseenter mouseleave".split(" "), function( i, v ) {
		processors[v] = basicProcessor;
	});
	$.each(["windowresize", "windowscroll", "load", "ready", "unload", "hashchange"], function( i, v ) {
		processors[v] = windowEvent;
	});
	//the ready processor happens on the document
	processors.ready = function( el, event, selector, cb ) {
		$(shifter(cb)); //cant really unbind
	};
	/**
	 *  @add jQuery.fn
	 */

	$.fn.mixin = function() {
		//create a bunch of controllers
		var controllers = $.makeArray(arguments),
			forLint;
		return this.each(function() {
			for ( var i = 0; i < controllers.length; i++ ) {
				forLint = new controllers[i](this);
			}

		});
	};
	//used to determine if a controller instance is one of controllers
	//controllers can be strings or classes
	var isAControllerOf = function( instance, controllers ) {
		for ( var i = 0; i < controllers.length; i++ ) {
			if ( typeof controllers[i] == 'string' ? instance.Class._shortName == controllers[i] : instance instanceof controllers[i] ) {
				return true;
			}
		}
		return false;
	};

	/**
	 * @function controllers
	 * Gets all controllers in the jQuery element.
	 * @return {Array} an array of controller instances.
	 */
	$.fn.controllers = function() {
		var controllerNames = $.makeArray(arguments),
			instances = [],
			controllers;
		//check if arguments
		this.each(function() {
			controllers = $.data(this, "controllers");
			if (!controllers ) {
				return;
			}
			for ( var cname in controllers ) {
				var c = controllers[cname];
				if (!controllerNames.length || isAControllerOf(c, controllerNames) ) {
					instances.push(c);
				}
			}
		});
		return instances;
	};
	/**
	 * @function controller
	 * Gets a controller in the jQuery element.  With no arguments, returns the first one found.
	 * @param {Object} controller (optional) if exists, the first controller instance with this class type will be returned.
	 * @return {jQuery.Controller} the first controller.
	 */
	$.fn.controller = function( controller ) {
		return this.controllers.apply(this, arguments)[0];
	};

})(jQuery);

//jquery.lang.openajax.js

(function(){
// prevent re-definition of the OpenAjax object
if(!window["OpenAjax"]){
	/**
	 * @class OpenAjax
	 * Use OpenAjax.hub to publish and subscribe to messages.
	 */
    OpenAjax = new function(){
		var t = true;
		var f = false;
		var g = window;
		var ooh = "org.openajax.hub.";

		var h = {};
		this.hub = h;
		h.implementer = "http://openajax.org";
		h.implVersion = "1.0";
		h.specVersion = "1.0";
		h.implExtraData = {};
		var libs = {};
		h.libraries = libs;

		h.registerLibrary = function(prefix, nsURL, version, extra){
			libs[prefix] = {
				prefix: prefix,
				namespaceURI: nsURL,
				version: version,
				extraData: extra 
			};
			this.publish(ooh+"registerLibrary", libs[prefix]);
		}
		h.unregisterLibrary = function(prefix){
			this.publish(ooh+"unregisterLibrary", libs[prefix]);
			delete libs[prefix];
		}

		h._subscriptions = { c:{}, s:[] };
		h._cleanup = [];
		h._subIndex = 0;
		h._pubDepth = 0;

		h.subscribe = function(name, callback, scope, subscriberData, filter)			
		{
			if(!scope){
				scope = window;
			}
			var handle = name + "." + this._subIndex;
			var sub = { scope: scope, cb: callback, fcb: filter, data: subscriberData, sid: this._subIndex++, hdl: handle };
			var path = name.split(".");
	 		this._subscribe(this._subscriptions, path, 0, sub);
			return handle;
		}

		h.publish = function(name, message)		
		{
			var path = name.split(".");
			this._pubDepth++;
			this._publish(this._subscriptions, path, 0, name, message);
			this._pubDepth--;
			if((this._cleanup.length > 0) && (this._pubDepth == 0)) {
				for(var i = 0; i < this._cleanup.length; i++) 
					this.unsubscribe(this._cleanup[i].hdl);
				delete(this._cleanup);
				this._cleanup = [];
			}
		}

		h.unsubscribe = function(sub) 
		{
			var path = sub.split(".");
			var sid = path.pop();
			this._unsubscribe(this._subscriptions, path, 0, sid);
		}
		
		h._subscribe = function(tree, path, index, sub) 
		{
			var token = path[index];
			if(index == path.length) 	
				tree.s.push(sub);
			else { 
				if(typeof tree.c == "undefined")
					 tree.c = {};
				if(typeof tree.c[token] == "undefined") {
					tree.c[token] = { c: {}, s: [] }; 
					this._subscribe(tree.c[token], path, index + 1, sub);
				}
				else 
					this._subscribe( tree.c[token], path, index + 1, sub);
			}
		}

		h._publish = function(tree, path, index, name, msg, pcb, pcid) {
			if(typeof tree != "undefined") {
				var node;
				if(index == path.length) {
					node = tree;
				} else {
					this._publish(tree.c[path[index]], path, index + 1, name, msg, pcb, pcid);
					this._publish(tree.c["*"], path, index + 1, name, msg, pcb, pcid);			
					node = tree.c["**"];
				}
				if(typeof node != "undefined") {
					var callbacks = node.s;
					var max = callbacks.length;
					for(var i = 0; i < max; i++) {
						if(callbacks[i].cb) {
							var sc = callbacks[i].scope;
							var cb = callbacks[i].cb;
							var fcb = callbacks[i].fcb;
							var d = callbacks[i].data;
							var sid = callbacks[i].sid;
							var scid = callbacks[i].cid;
							if(typeof cb == "string"){
								// get a function object
								cb = sc[cb];
							}
							if(typeof fcb == "string"){
								// get a function object
								fcb = sc[fcb];
							}
							if((!fcb) || (fcb.call(sc, name, msg, d))) {
							  if((!pcb) || (pcb(name, msg, pcid, scid))) {
								  cb.call(sc, name, msg, d, sid);
							  }
							}
						}
					}
				}
			}
		}
			
		h._unsubscribe = function(tree, path, index, sid) {
			if(typeof tree != "undefined") {
				if(index < path.length) {
					var childNode = tree.c[path[index]];
					this._unsubscribe(childNode, path, index + 1, sid);
					if(childNode.s.length == 0) {
						for(var x in childNode.c) 
					 		return;		
						delete tree.c[path[index]];	
					}
					return;
				}
				else {
					var callbacks = tree.s;
					var max = callbacks.length;
					for(var i = 0; i < max; i++) 
						if(sid == callbacks[i].sid) {
							if(this._pubDepth > 0) {
								callbacks[i].cb = null;	
								this._cleanup.push(callbacks[i]);						
							}
							else
								callbacks.splice(i, 1);
							return; 	
						}
				}
			}
		}
		// The following function is provided for automatic testing purposes.
		// It is not expected to be deployed in run-time OpenAjax Hub implementations.
		h.reinit = function()
		{
			for (var lib in OpenAjax.hub.libraries) {
				delete OpenAjax.hub.libraries[lib];
			}
			OpenAjax.hub.registerLibrary("OpenAjax", "http://openajax.org/hub", "1.0", {});

			delete OpenAjax._subscriptions;
			OpenAjax._subscriptions = {c:{},s:[]};
			delete OpenAjax._cleanup;
			OpenAjax._cleanup = [];
			OpenAjax._subIndex = 0;
			OpenAjax._pubDepth = 0;
		}
	};
	// Register the OpenAjax Hub itself as a library.
	OpenAjax.hub.registerLibrary("OpenAjax", "http://openajax.org/hub", "1.0", {});

}
OpenAjax.hub.registerLibrary("JavaScriptMVC", "http://JavaScriptMVC.com", "1.5", {});
})(jQuery);

//jquery.controller.subscribe.js

(function() {

	/**
	 * @function jQuery.Controller.static.processors.subscribe
	 * @parent jQuery.Controller.static.processors
	 * @plugin jquery/controller/subscribe
	 * Adds OpenAjax.Hub subscribing to controllers.
	 * 
	 *     $.Controller("Subscriber",{
	 *       "recipe.updated subscribe" : function(called, recipe){
	 *         
	 *       },
	 *       "todo.* subscribe" : function(called, todo){
	 *       
	 *       }
	 *     })
	 * 
	 * You should typically be listening to jQuery triggered events when communicating between
	 * controllers.  Subscribe should be used for listening to model changes.
	 * 
	 * ### API
	 * 
	 * This is the call signiture for the processor, not the controller subscription callbacks.
	 * 
	 * @param {HTMLElement} el the element being bound.  This isn't used.
	 * @param {String} event the event type (subscribe).
	 * @param {String} selector the subscription name
	 * @param {Function} cb the callback function
	 */
	jQuery.Controller.processors.subscribe = function( el, event, selector, cb ) {
		var subscription = OpenAjax.hub.subscribe(selector, cb);
		return function() {
			var sub = subscription;
			OpenAjax.hub.unsubscribe(sub);
		};
	};

	/**
	 * @add jQuery.Controller.prototype
	 */
	//breaker
	/**
	 * @function publish
	 * @hide
	 * Publishes a message to OpenAjax.hub.
	 * @param {String} message Message name, ex: "Something.Happened".
	 * @param {Object} data The data sent.
	 */
	jQuery.Controller.prototype.publish = function() {
		OpenAjax.hub.publish.apply(OpenAjax.hub, arguments);
	};
})(jQuery);

//jquery.event.hashchange.js



//jquery.controller.history.js

(function($){

/**
 * @class
 * The controller history plugin adds browser hash (#) based history support.
 * This class itself helps break up parts of the hash of the url
 * @constructor 
 * Takes a url and extracts information out of it.
 * @param {Object} path
 */

var keyBreaker = /([^\[\]]+)|(\[\])/g;

$.Controller.History = {
	/**
	 * 
	 * returns the pathname part
	 * 
	 * @codestart
	 * "#foo/bar&foo=bar" ->  'foo/bar'
	 * @codeend
	 */
	pathname : function(path) {
		var parts =  path.match(/#([^&]*)/);
		return parts ? parts[1] : null
	},
	/**
	 * returns the search part, but without the first &
	 * @codestart
	 * "#foo/bar&foo=bar" ->  'foo=barr'
	 * @codeend
	 */
	search : function(path) {
		var parts =  path.match(/#[^&]*&(.*)/);
		return parts ? parts[1] : null
	},
	getData: function(path) {
		var search = $.Controller.History.search(path),
			digitTest = /^\d+$/;
		if(! search || ! search.match(/([^?#]*)(#.*)?$/) ) {
			return {};
		} 
	   
		// Support the legacy format that used MVC.Object.to_query_string that used %20 for
		// spaces and not the '+' sign;
		search = search.replace(/\+/g,"%20")
	   
		var data = {},
			pairs = search.split('&'),
			current;
			
		for(var i=0; i < pairs.length; i++){
			current = data;
			var pair = pairs[i].split('=');
			
			// if we find foo=1+1=2
			if(pair.length != 2) { 
				pair = [pair[0], pair.slice(1).join("=")]
			}
			
			var key = decodeURIComponent(pair[0]), 
				value = decodeURIComponent(pair[1]),
				parts = key.match(keyBreaker);
	
			for ( var j = 0; j < parts.length - 1; j++ ) {
				var part = parts[j];
				if (!current[part] ) {
					current[part] = digitTest.test(part) || parts[j+1] == "[]" ? [] : {}
				}
				current = current[part];
			}
			lastPart = parts[parts.length - 1];
			if(lastPart == "[]"){
				current.push(value)
			}else{
				current[lastPart] = value;
			}
		}
		return data;
	}
};





jQuery(function($) {
	$(window).bind('hashchange',function() {
		var data = $.Controller.History.getData(location.href),
			folders = $.Controller.History.pathname(location.href) || 'index',
			hasSlash = (folders.indexOf('/') != -1);
		
		if( !hasSlash && folders != 'index' ) {
			folders += '/index';
		}
		
		OpenAjax.hub.publish("history."+folders.replace("/","."), data);
	});
	
	setTimeout(function(){
		$(window).trigger('hashchange')
	},1) //immediately after ready
})
   
   
$.extend($.Controller.prototype, {
   /**
	* Redirects to another page.
	* @plugin 'dom/history'
	* @param {Object} options an object that will turned into a url like #controller/action&param1=value1
	*/
   redirectTo: function(options){
		var point = this._get_history_point(options);
		location.hash = point;
   },
   /**
	* Redirects to another page by replacing current URL with the given one.  This
	* call will not create a new entry in the history.
	* @plugin 'dom/history'
	* @param {Object} options an object that will turned into a url like #controller/action&param1=value1
	*/
   replaceWith: function(options){
		var point = this._get_history_point(options);
		location.replace(location.href.split('#')[0] + point);
   },
   /**
	* Adds history point to browser history.
	* @plugin 'dom/history'
	* @param {Object} options an object that will turned into a url like #controller/action&param1=value1
	* @param {Object} data extra data saved in history	-- NO LONGER SUPPORTED
	*/
   historyAdd : function(options, data) {
	   var point = this._get_history_point(options);
	  location.hash = point;
   },
   /**
	* Creates a history point from given options. Resultant history point is like #controller/action&param1=value1
	* @plugin 'dom/history'
	* @param {Object} options an object that will turned into history point
	*/
   _get_history_point: function(options) {
	   var controller_name = options.controller || this.Class.underscoreName;
	   var action_name = options.action || 'index';
	  
	   /* Convert the options to parameters (removing controller and action if needed) */
	   if(options.controller)
		   delete options.controller;
	   if(options.action)
		   delete options.action;
	   
	   var paramString = (options) ? $.param(options) : '';
	   if(paramString.length)
		   paramString = '&' + paramString;
	   
	   return '#' + controller_name + '/' + action_name + paramString;
   },

   /**
	* Provides current window.location parameters as object properties.
	* @plugin 'dom/history'
	*/
   pathData :function() {
	   return $.Controller.History.getData(location.href);
   }
});
		
	


   
})(jQuery);

//jquery.view.js

(function( $ ) {

	// converts to an ok dom id
	var toId = function( src ) {
		return src.replace(/^\/\//, "").replace(/[\/\.]/g, "_");
	},
		// used for hookup ids
		id = 1;

	/**
	 * @class jQuery.View
	 * @tag core
	 * @plugin jquery/view
	 * @test jquery/view/qunit.html
	 * @download dist/jquery.view.js
	 * 
	 * View provides a uniform interface for using templates with 
	 * jQuery. When template engines [jQuery.View.register register] 
	 * themselves, you are able to:
	 * 
	 *  - Use views with jQuery extensions [jQuery.fn.after after], [jQuery.fn.append append],
	 *   [jQuery.fn.before before], [jQuery.fn.html html], [jQuery.fn.prepend prepend],
	 *      [jQuery.fn.replace replace], [jQuery.fn.replaceWith replaceWith], [jQuery.fn.text text].
	 *  - Template loading from html elements and external files.
	 *  - Synchronous and asynchronous template loading.
	 *  - Template caching.
	 *  - Bundling of processed templates in production builds.
	 *  - Hookup jquery plugins directly in the template.
	 *  
	 * ## Use
	 * 
	 * 
	 * When using views, you're almost always wanting to insert the results 
	 * of a rendered template into the page. jQuery.View overwrites the 
	 * jQuery modifiers so using a view is as easy as: 
	 * 
	 *     $("#foo").html('mytemplate.ejs',{message: 'hello world'})
	 *
	 * This code:
	 * 
	 *  - Loads the template a 'mytemplate.ejs'. It might look like:
	 *    <pre><code>&lt;h2>&lt;%= message %>&lt;/h2></pre></code>
	 *  
	 *  - Renders it with {message: 'hello world'}, resulting in:
	 *    <pre><code>&lt;div id='foo'>"&lt;h2>hello world&lt;/h2>&lt;/div></pre></code>
	 *  
	 *  - Inserts the result into the foo element. Foo might look like:
	 *    <pre><code>&lt;div id='foo'>&lt;h2>hello world&lt;/h2>&lt;/div></pre></code>
	 * 
	 * ## jQuery Modifiers
	 * 
	 * You can use a template with the following jQuery modifiers:
	 * 
	 * <table>
	 * <tr><td>[jQuery.fn.after after]</td><td> <code>$('#bar').after('temp.jaml',{});</code></td></tr>
	 * <tr><td>[jQuery.fn.after append] </td><td>  <code>$('#bar').append('temp.jaml',{});</code></td></tr>
	 * <tr><td>[jQuery.fn.after before] </td><td> <code>$('#bar').before('temp.jaml',{});</code></td></tr>
	 * <tr><td>[jQuery.fn.after html] </td><td> <code>$('#bar').html('temp.jaml',{});</code></td></tr>
	 * <tr><td>[jQuery.fn.after prepend] </td><td> <code>$('#bar').prepend('temp.jaml',{});</code></td></tr>
	 * <tr><td>[jQuery.fn.after replace] </td><td> <code>$('#bar').replace('temp.jaml',{});</code></td></tr>
	 * <tr><td>[jQuery.fn.after replaceWith] </td><td> <code>$('#bar').replaceWidth('temp.jaml',{});</code></td></tr>
	 * <tr><td>[jQuery.fn.after text] </td><td> <code>$('#bar').text('temp.jaml',{});</code></td></tr>
	 * </table>
	 * 
	 * You always have to pass a string and an object (or function) for the jQuery modifier 
	 * to user a template.
	 * 
	 * ## Template Locations
	 * 
	 * View can load from script tags or from files. 
	 * 
	 * ## From Script Tags
	 * 
	 * To load from a script tag, create a script tag with your template and an id like: 
	 * 
	 * <pre><code>&lt;script type='text/ejs' id='recipes'>
	 * &lt;% for(var i=0; i &lt; recipes.length; i++){ %>
	 *   &lt;li>&lt;%=recipes[i].name %>&lt;/li>
	 * &lt;%} %>
	 * &lt;/script></code></pre>
	 * 
	 * Render with this template like: 
	 * 
	 * @codestart
	 * $("#foo").html('recipes',recipeData)
	 * @codeend
	 * 
	 * Notice we passed the id of the element we want to render.
	 * 
	 * ## From File
	 * 
	 * You can pass the path of a template file location like:
	 * 
	 *     $("#foo").html('templates/recipes.ejs',recipeData)
	 * 
	 * However, you typically want to make the template work from whatever page they 
	 * are called from.  To do this, use // to look up templates from JMVC root:
	 * 
	 *     $("#foo").html('//app/views/recipes.ejs',recipeData)
	 *     
	 * Finally, the [jQuery.Controller.prototype.view controller/view] plugin can make looking
	 * up a thread (and adding helpers) even easier:
	 * 
	 *     $("#foo").html( this.view('recipes', recipeData) )
	 * 
	 * ## Packaging Templates
	 * 
	 * If you're making heavy use of templates, you want to organize 
	 * them in files so they can be reused between pages and applications.
	 * 
	 * But, this organization would come at a high price 
	 * if the browser has to 
	 * retrieve each template individually. The additional 
	 * HTTP requests would slow down your app. 
	 * 
	 * Fortunately, [steal.static.views steal.views] can build templates 
	 * into your production files. You just have to point to the view file like: 
	 * 
	 *     steal.views('path/to/the/view.ejs');
     *
	 * ## Asynchronous
	 * 
	 * By default, retrieving requests is done synchronously. This is 
	 * fine because StealJS packages view templates with your JS download. 
	 * 
	 * However, some people might not be using StealJS or want to delay loading 
	 * templates until necessary. If you have the need, you can 
	 * provide a callback paramter like: 
	 * 
	 *     $("#foo").html('recipes',recipeData, function(result){
	 *       this.fadeIn()
	 *     });
	 * 
	 * The callback function will be called with the result of the 
	 * rendered template and 'this' will be set to the original jQuery object.
	 * 
	 * ## Just Render Templates
	 * 
	 * Sometimes, you just want to get the result of a rendered 
	 * template without inserting it, you can do this with $.View: 
	 * 
	 *     var out = $.View('path/to/template.jaml',{});
	 *     
     * ## Preloading Templates
	 * 
	 * You can preload templates asynchronously like:
	 * 
	 *     $.View('path/to/template.jaml',{}, function(){});
	 * 
	 * ## Supported Template Engines
	 * 
	 * JavaScriptMVC comes with the following template languages:
	 * 
	 *   - EmbeddedJS
	 *     <pre><code>&lt;h2>&lt;%= message %>&lt;/h2></code></pre>
	 *     
	 *   - JAML
	 *     <pre><code>h2(data.message);</code></pre>
	 *     
	 *   - Micro
	 *     <pre><code>&lt;h2>{%= message %}&lt;/h2></code></pre>
	 *     
	 *   - jQuery.Tmpl
	 *     <pre><code>&lt;h2>${message}&lt;/h2></code></pre>

	 * 
	 * The popular <a href='http://awardwinningfjords.com/2010/08/09/mustache-for-javascriptmvc-3.html'>Mustache</a> 
	 * template engine is supported in a 2nd party plugin.
	 * 
	 * ## Using other Template Engines
	 * 
	 * It's easy to integrate your favorite template into $.View and Steal.  Read 
	 * how in [jQuery.View.register].
	 * 
	 * @constructor
	 * 
	 * Looks up a template, processes it, caches it, then renders the template
	 * with data and optional helpers.
	 * 
	 * With [stealjs StealJS], views are typically bundled in the production build.
	 * This makes it ok to use views synchronously like:
	 * 
	 * @codestart
	 * $.View("//myplugin/views/init.ejs",{message: "Hello World"})
	 * @codeend
	 * 
	 * If you aren't using StealJS, it's best to use views asynchronously like:
	 * 
	 * @codestart
	 * $.View("//myplugin/views/init.ejs",
	 *        {message: "Hello World"}, function(result){
	 *   // do something with result
	 * })
	 * @codeend
	 * 
	 * @param {String} view The url or id of an element to use as the template's source.
	 * @param {Object} data The data to be passed to the view.
	 * @param {Object} [helpers] Optional helper functions the view might use. Not all
	 * templates support helpers.
	 * @param {Object} [callback] Optional callback function.  If present, the template is 
	 * retrieved asynchronously.  This is a good idea if you aren't compressing the templates
	 * into your view.
	 * @return {String} The rendered result of the view.
	 */

	var $view, render, checkText, get;

	$view = $.View = function( view, data, helpers, callback ) {
		var suffix = view.match(/\.[\w\d]+$/),
			type, el, id, renderer, url = view;
		if ( typeof helpers === 'function' ) {
			callback = helpers;
			helpers = undefined;
		}
		//if there is no suffix, add one
		if (!suffix ) {
			suffix = $.View.ext;
			url = url + $.View.ext;
		}

		//convert to a unique and valid id
		id = toId(url);

		//if a absolute path, use steal to get it
		if ( url.match(/^\/\//) ) {
			url = steal.root.join(url.substr(2)); //can steal be removed?
		}

		//get the template engine
		type = $.View.types[suffix];

		//get the renderer function
		renderer =
		$.View.cached[id] ? // is it cached?
		$.View.cached[id] : // use the cached version
		((el = document.getElementById(view)) ? //is it in the document?
		type.renderer(id, el.innerHTML) : //use the innerHTML of the elemnt
		get(type, id, url, data, helpers, callback) //do an ajax request for it
		);
		// we won't always get a renderer (if async ajax)
		return renderer && render(renderer, type, id, data, helpers, callback);
	};
	// caches the template, renders the content, and calls back if it should
	render = function( renderer, type, id, data, helpers, callback ) {
		var res, stub;
		if ( $.View.cache ) {
			$.View.cached[id] = renderer;
		}
		res = renderer.call(type, data, helpers);
		stub = callback && callback(res);
		return res;
	};
	// makes sure there's a template
	checkText = function( text, url ) {
		if (!text.match(/[^\s]/) ) {
			throw "$.View ERROR: There is no template or an empty template at " + url;
		}
	};
	// gets a template, if there's a callback, renders and calls back its;ef
	get = function( type, id, url, data, helpers, callback ) {
		if ( callback ) {
			$.ajax({
				url: url,
				dataType: "text",
				error: function() {
					checkText("", url);
				},
				success: function( text ) {
					checkText(text, url);
					render(type.renderer(id, text), type, id, data, helpers, callback);
				}
			});
		} else {
			var text = $.ajax({
				async: false,
				url: url,
				dataType: "text",
				error: function() {
					checkText("", url);
				}
			}).responseText;
			checkText(text, url);
			return type.renderer(id, text);
		}

	};


	$.extend($.View, {
		/**
		 * @attribute hookups
		 * @hide
		 * A list of pending 'hookups'
		 */
		hookups: {},
		/**
		 * @function hookup
		 * Registers a hookup function to be called back after the html is put on the page
		 * @param {Function} cb a callback function to be called with the element
		 * @param {Number} the hookup number
		 */
		hookup: function( cb ) {
			var myid = ++id;
			$view.hookups[myid] = cb;
			return myid;
		},
		/**
		 * @attribute cached
		 * @hide
		 * Cached are put in this object
		 */
		cached: {},
		/**
		 * @attribute cache
		 * Should the views be cached or reloaded from the server. Defaults to true.
		 */
		cache: true,
		/**
		 * @function register
		 * Registers a template engine to be used with 
		 * view helpers and compression.  
		 * 
		 * ## Example
		 * 
		 * @codestart
		 * $.View.register({
		 * 	suffix : "tmpl",
		 * 	renderer: function( id, text ) {
		 * 		return function(data){
		 * 			return jQuery.render( text, data );
		 * 		}
		 * 	},
		 * 	script: function( id, text ) {
		 * 		var tmpl = $.tmpl(text).toString();
		 * 		return "function(data){return ("+
		 * 		  	tmpl+
		 * 			").call(jQuery, jQuery, data); }";
		 * 	}
		 * })
		 * @codeend
		 * Here's what each property does:
		 * 
 		 *    * suffix - files that use this suffix will be processed by this template engine
 		 *    * renderer - returns a function that will render the template provided by text
 		 *    * script - returns a string form of the processed template function.
		 * 
		 * @param {Object} info a object of method and properties 
		 * 
		 * that enable template integration:
		 * <ul>
		 *   <li>suffix - the view extension.  EX: 'ejs'</li>
		 *   <li>script(id, src) - a function that returns a string that when evaluated returns a function that can be 
		 *    used as the render (i.e. have func.call(data, data, helpers) called on it).</li>
		 *   <li>renderer(id, text) - a function that takes the id of the template and the text of the template and
		 *    returns a render function.</li>
		 * </ul>
		 */
		register: function( info ) {
			this.types["." + info.suffix] = info;
		},
		types: {},
		/**
		 * @attribute ext
		 * The default suffix to use if none is provided in the view's url.  
		 * This is set to .ejs by default.
		 */
		ext: ".ejs",
		/**
		 * Returns the text that 
		 * @hide 
		 * @param {Object} type
		 * @param {Object} id
		 * @param {Object} src
		 */
		registerScript: function( type, id, src ) {
			return "$.View.preload('" + id + "'," + $.View.types["." + type].script(id, src) + ");";
		},
		/**
		 * @hide
		 * Called by a production script to pre-load a renderer function
		 * into the view cache.
		 * @param {String} id
		 * @param {Function} renderer
		 */
		preload: function( id, renderer ) {
			$.View.cached[id] = function( data, helpers ) {
				return renderer.call(data, data, helpers);
			};
		}

	});


	//---- ADD jQUERY HELPERS -----
	//converts jquery functions to use views	
	var convert, modify, isTemplate, getCallback, hookupView, funcs;

	convert = function( func_name ) {
		var old = $.fn[func_name];

		$.fn[func_name] = function() {
			var args = $.makeArray(arguments),
				callbackNum, callback, self = this;

			//check if a template
			if ( isTemplate(args) ) {

				// if we should operate async
				if ((callbackNum = getCallback(args))) {
					callback = args[callbackNum];
					args[callbackNum] = function( result ) {
						modify.call(self, [result], old);
						callback.call(self, result);
					};
					$.View.apply($.View, args);
					return this;
				}

				//otherwise do the template now
				args = [$.View.apply($.View, args)];
			}

			return modify.call(this, args, old);
		};
	};
	// modifies the html of the element
	modify = function( args, old ) {
		var res, stub, hooks;

		//check if there are new hookups
		for ( var hasHookups in jQuery.View.hookups ) {
			break;
		}

		//if there are hookups, get jQuery object
		if ( hasHookups ) {
			hooks = $.View.hookups;
			$.View.hookups = {};
			args[0] = $(args[0]);
		}
		res = old.apply(this, args);

		//now hookup hookups
		if ( hasHookups ) {
			hookupView(args[0], hooks);
		}
		return res;
	};

	// returns true or false if the args indicate a template is being used
	isTemplate = function( args ) {
		var secArgType = typeof args[1];

		return typeof args[0] == "string" && (secArgType == 'object' || secArgType == 'function') && !args[1].nodeType && !args[1].jquery;
	};

	//returns the callback if there is one (for async view use)
	getCallback = function( args ) {
		return typeof args[3] === 'function' ? 3 : typeof args[2] === 'function' && 2;
	};

	hookupView = function( els , hooks) {
		//remove all hookups
		var hookupEls, 
			len, i = 0,
			id, func;
		els = els.filter(function(){
			return this.nodeType != 3; //filter out text nodes
		})
		hookupEls = els.add("[data-view-id]", els);
		len = hookupEls.length;
		for (; i < len; i++ ) {
			if ( hookupEls[i].getAttribute && (id = hookupEls[i].getAttribute('data-view-id')) && (func = hooks[id]) ) {
				func(hookupEls[i], id);
				delete hooks[id];
				hookupEls[i].removeAttribute('data-view-id');
			}
		}
		//copy remaining hooks back
		$.extend($.View.hookups, hooks);
	};

	/**
	 *  @add jQuery.fn
	 */
	funcs = [
	/**
	 *  @function prepend
	 *  @parent jQuery.View
	 *  abc
	 */
	"prepend",
	/**
	 *  @function append
	 *  @parent jQuery.View
	 *  abc
	 */
	"append",
	/**
	 *  @function after
	 *  @parent jQuery.View
	 *  abc
	 */
	"after",
	/**
	 *  @function before
	 *  @parent jQuery.View
	 *  abc
	 */
	"before",
	/**
	 *  @function replace
	 *  @parent jQuery.View
	 *  abc
	 */
	"replace",
	/**
	 *  @function text
	 *  @parent jQuery.View
	 *  abc
	 */
	"text",
	/**
	 *  @function html
	 *  @parent jQuery.View
	 *  abc
	 */
	"html",
	/**
	 *  @function replaceWith
	 *  @parent jQuery.View
	 *  abc
	 */
	"replaceWith"];

	//go through helper funcs and convert
	for ( var i = 0; i < funcs.length; i++ ) {
		convert(funcs[i]);
	}

})(jQuery);

//jquery.controller.view.js

(function( $ ) {
	jQuery.Controller.getFolder = function() {
		return jQuery.String.underscore(this.fullName.replace(/\./g, "/")).replace("/Controllers", "");
	};

	var calculatePosition = function( Class, view, action_name ) {
		var slashes = Class.fullName.replace(/\./g, "/"),
			hasControllers = slashes.indexOf("/Controllers/" + Class.shortName) != -1,
			path = jQuery.String.underscore(slashes.replace("/Controllers/" + Class.shortName, "")),
			controller_name = Class._shortName,
			suffix = (typeof view == "string" && view.match(/\.[\w\d]+$/)) || jQuery.View.ext;

		//calculate view
		if ( typeof view == "string" ) {
			if ( view.substr(0, 2) == "//" ) { //leave where it is
			} else {
				view = "//" + new steal.File('views/' + (view.indexOf('/') !== -1 ? view : (hasControllers ? controller_name + '/' : "") + view)).joinFrom(path) + suffix;
			}
		} else if (!view ) {
			view = "//" + new steal.File('views/' + (hasControllers ? controller_name + '/' : "") + action_name.replace(/\.|#/g, '').replace(/ /g, '_')).joinFrom(path) + suffix;
		}
		return view;
	};
	var calculateHelpers = function( myhelpers ) {
		var helpers = {};
		if ( myhelpers ) {
			if ( jQuery.isArray(myhelpers) ) {
				for ( var h = 0; h < myhelpers.length; h++ ) {
					jQuery.extend(helpers, myhelpers[h]);
				}
			}
			else {
				jQuery.extend(helpers, myhelpers);
			}
		} else {
			if ( this._default_helpers ) {
				helpers = this._default_helpers;
			}
			//load from name
			var current = window;
			var parts = this.Class.fullName.split(/\./);
			for ( var i = 0; i < parts.length; i++ ) {
				if ( typeof current.Helpers == 'object' ) {
					jQuery.extend(helpers, current.Helpers);
				}
				current = current[parts[i]];
			}
			if ( typeof current.Helpers == 'object' ) {
				jQuery.extend(helpers, current.Helpers);
			}
			this._default_helpers = helpers;
		}
		return helpers;
	};

	/**
	 * @add jQuery.Controller.prototype
	 */

	jQuery.Controller.prototype.
	/**
	 * @tag view
	 * Renders a View template with the controller instance. If the first argument
	 * is not supplied, 
	 * it looks for a view in /views/controller_name/action_name.ejs.
	 * If data is not provided, it uses the controller instance as data.
	 * @codestart
	 * TasksController = $.Controller.extend('TasksController',{
	 *   click: function( el ) {
	 *     // renders with views/tasks/click.ejs
	 *     el.html( this.view() ) 
	 *     // renders with views/tasks/under.ejs
	 *     el.after( this.view("under", [1,2]) );
	 *     // renders with views/shared/top.ejs
	 *     el.before( this.view("shared/top", {phrase: "hi"}) );
	 *   }
	 * })
	 * @codeend
	 * @plugin controller/view
	 * @return {String} the rendered result of the view.
	 * @param {String} [optional1] view The view you are going to render.  If a view isn't explicity given
	 * this function will try to guess at the correct view as show in the example code above.
	 * @param {Object} [optional2] data data to be provided to the view.  If not present, the controller instance 
	 * is used.
	 * @param {Object} [optional3] myhelpers an object of helpers that will be available in the view.  If not present
	 * this controller class's "Helpers" property will be used.
	 *
	 */
	view = function( view, data, myhelpers ) {
		//shift args if no view is provided
		if ( typeof view != "string" && !myhelpers ) {
			myhelpers = data;
			data = view;
			view = null;
		}
		//guess from controller name
		view = calculatePosition(this.Class, view, this.called);

		//calculate data
		data = data || this;

		//calculate helpers
		var helpers = calculateHelpers.call(this, myhelpers);


		return jQuery.View(view, data, helpers); //what about controllers in other folders?
	};


})(jQuery);

//jquery.dom.js



//jquery.dom.closest.js

(function(){
	/**
	 * @function closest
	 * @parent dom
	 * Overwrites closest to allow open > selectors.  This allows controller actions such as:
	 * @codestart
	 * ">li click" : function( el, ev ) { ... }
	 * @codeend
	 */
	var oldClosest = jQuery.fn.closest;
	jQuery.fn.closest = function(selectors, context){
		var rooted = {}, res, result, thing, i, j, selector, rootedIsEmpty = true, selector, selectorsArr = selectors;
		if(typeof selectors == "string") selectorsArr = [selectors];
		
		$.each(selectorsArr, function(i, selector){
		    if(selector.indexOf(">") == 0 ){
				if(selector.indexOf(" ") != -1){
					throw " closest does not work with > followed by spaces!"
				}
				rooted[( selectorsArr[i] = selector.substr(1)  )] = selector;
				if(typeof selectors == "string") selectors = selector.substr(1);
				rootedIsEmpty = false;
			}
		})
		
		res = oldClosest.call(this, selectors, context);
		
		if(rootedIsEmpty) return res;
		i =0;
		while(i < res.length){
			result = res[i], selector = result.selector;
			if (rooted[selector] !== undefined) {
				result.selector = rooted[selector];
				rooted[selector] = false;
				if(typeof result.selector !== "string"  || result.elem.parentNode !== context ){
					res.splice(i,1);
						continue;
				}
			}
			i++;
		}
		return res;
	}
})(jQuery);

//jquery.dom.compare.js

(function($){
/**
 * @function compare
 * @parent dom
 * @download http://jmvcsite.heroku.com/pluginify?plugins[]=jquery/dom/compare/compare.js 
 * Compares the position of two nodes and returns a bitmask detailing how they are positioned 
 * relative to each other.  You can expect it to return the same results as 
 * [http://www.w3.org/TR/DOM-Level-3-Core/core.html#Node3-compareDocumentPosition | compareDocumentPosition].
 * Parts of this documentation and source come from [http://ejohn.org/blog/comparing-document-position | John Resig].
 * <h2>Demo</h2>
 * @demo jquery/dom/compare/compare.html
 * @test jquery/dom/compare/qunit.html
 * @plugin dom/compare
 * @param {HTMLElement} a the first node
 * @param {HTMLElement} b the second node
 * @return {Number} A bitmap with the following digit values:
 * <table class='options'>
 *     <tr><th>Bits</th><th>Number</th><th>Meaning</th></tr>
 *     <tr><td>000000</td><td>0</td><td>Elements are identical.</td></tr>
 *     <tr><td>000001</td><td>1</td><td>The nodes are in different documents (or one is outside of a document).</td></tr>
 *     <tr><td>000010</td><td>2</td><td>Node B precedes Node A.</td></tr>
 *     <tr><td>000100</td><td>4</td><td>Node A precedes Node B.</td></tr>
 *     <tr><td>001000</td><td>8</td><td>Node B contains Node A.</td></tr>
 *     <tr><td>010000</td><td>16</td><td>Node A contains Node B.</td></tr>
 * </table>
 */
jQuery.fn.compare = function(b){ //usually 
	//b is usually a relatedTarget, but b/c it is we have to avoid a few FF errors
	
	try{ //FF3 freaks out with XUL
		b = b.jquery ? b[0] : b;
	}catch(e){
		return null;
	}
	if (window.HTMLElement) { //make sure we aren't coming from XUL element
		var s = HTMLElement.prototype.toString.call(b)
		if (s == '[xpconnect wrapped native prototype]' || s == '[object XULElement]') return null;
	}
	if(this[0].compareDocumentPosition){
		return this[0].compareDocumentPosition(b);
	}
	if(this[0] == document && b != document) return 8;
	var number = (this[0] !== b && this[0].contains(b) && 16) + (this[0] != b && b.contains(this[0]) && 8),
		docEl = document.documentElement;
	if(this[0].sourceIndex){
		number += (this[0].sourceIndex < b.sourceIndex && 4)
		number += (this[0].sourceIndex > b.sourceIndex && 2)
		number += (this[0].ownerDocument !== b.ownerDocument ||
			(this[0] != docEl && this[0].sourceIndex <= 0 ) ||
			(b != docEl && b.sourceIndex <= 0 )) && 1
	}else{
		var range = document.createRange(), 
			sourceRange = document.createRange(),
			compare;
		range.selectNode(this[0]);
		sourceRange.selectNode(b);
		compare = range.compareBoundaryPoints(Range.START_TO_START, sourceRange);
		
	}

	return number;
}

})(jQuery);

//jquery.lang.json.js

(function(){
(function($) {
    /** jQuery.toJSON( json-serializble )
        Converts the given argument into a JSON respresentation.

        If an object has a "toJSON" function, that will be used to get the representation.
        Non-integer/string keys are skipped in the object, as are keys that point to a function.

        json-serializble:
            The *thing* to be converted.
     **/
    $.toJSON = function(o, replacer, space, recurse)
    {
        if (typeof(JSON) == 'object' && JSON.stringify)
            return JSON.stringify(o, replacer, space);

        if (!recurse && $.isFunction(replacer))
            o = replacer("", o);

        if (typeof space == "number")
            space = "          ".substring(0, space);
        space = (typeof space == "string") ? space.substring(0, 10) : "";
        
        var type = typeof(o);
    
        if (o === null)
            return "null";
    
        if (type == "undefined" || type == "function")
            return undefined;
        
        if (type == "number" || type == "boolean")
            return o + "";
    
        if (type == "string")
            return $.quoteString(o);
    
        if (type == 'object')
        {
            if (typeof o.toJSON == "function") 
                return $.toJSON( o.toJSON(), replacer, space, true );
            
            if (o.constructor === Date)
            {
                var month = o.getUTCMonth() + 1;
                if (month < 10) month = '0' + month;

                var day = o.getUTCDate();
                if (day < 10) day = '0' + day;

                var year = o.getUTCFullYear();
                
                var hours = o.getUTCHours();
                if (hours < 10) hours = '0' + hours;
                
                var minutes = o.getUTCMinutes();
                if (minutes < 10) minutes = '0' + minutes;
                
                var seconds = o.getUTCSeconds();
                if (seconds < 10) seconds = '0' + seconds;
                
                var milli = o.getUTCMilliseconds();
                if (milli < 100) milli = '0' + milli;
                if (milli < 10) milli = '0' + milli;

                return '"' + year + '-' + month + '-' + day + 'T' +
                             hours + ':' + minutes + ':' + seconds + 
                             '.' + milli + 'Z"'; 
            }

            var process = ($.isFunction(replacer)) ?
                function (k, v) { return replacer(k, v); } :
                function (k, v) { return v; },
                nl = (space) ? "\n" : "",
                sp = (space) ? " " : "";

            if (o.constructor === Array) 
            {
                var ret = [];
                for (var i = 0; i < o.length; i++)
                    ret.push(( $.toJSON( process(i, o[i]), replacer, space, true ) || "null" ).replace(/^/gm, space));

                return "[" + nl + ret.join("," + nl) + nl + "]";
            }
        
            var pairs = [], proplist;
            if ($.isArray(replacer)) {
                proplist = $.map(replacer, function (v) {
                    return (typeof v == "string" || typeof v == "number") ?
                        v + "" :
                        null;
                });
            }
            for (var k in o) {
                var name, val, type = typeof k;

                if (proplist && $.inArray(k + "", proplist) == -1)
                    continue;

                if (type == "number")
                    name = '"' + k + '"';
                else if (type == "string")
                    name = $.quoteString(k);
                else
                    continue;  //skip non-string or number keys
            
                val = $.toJSON( process(k, o[k]), replacer, space, true );
            
                if (typeof val == "undefined")
                    continue;  //skip pairs where the value is a function.
            
                pairs.push((name + ":" + sp + val).replace(/^/gm, space));
            }

            return "{" + nl + pairs.join("," + nl) + nl + "}";
        }
    };

    /** jQuery.evalJSON(src)
        Evaluates a given piece of json source.
     **/
    $.evalJSON = function(src)
    {
        if (typeof(JSON) == 'object' && JSON.parse)
            return JSON.parse(src);
        return eval("(" + src + ")");
    };
    
    /** jQuery.secureEvalJSON(src)
        Evals JSON in a way that is *more* secure.
    **/
    $.secureEvalJSON = function(src)
    {
        if (typeof(JSON) == 'object' && JSON.parse)
            return JSON.parse(src);
        
        var filtered = src;
        filtered = filtered.replace(/\\["\\\/bfnrtu]/g, '@');
        filtered = filtered.replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, ']');
        filtered = filtered.replace(/(?:^|:|,)(?:\s*\[)+/g, '');
        
        if (/^[\],:{}\s]*$/.test(filtered))
            return eval("(" + src + ")");
        else
            throw new SyntaxError("Error parsing JSON, source is not valid.");
    };

    /** jQuery.quoteString(string)
        Returns a string-repr of a string, escaping quotes intelligently.  
        Mostly a support function for toJSON.
    
        Examples:
            >>> jQuery.quoteString("apple")
            "apple"
        
            >>> jQuery.quoteString('"Where are we going?", she asked.')
            "\"Where are we going?\", she asked."
     **/
    $.quoteString = function(string)
    {
        if (string.match(_escapeable))
        {
            return '"' + string.replace(_escapeable, function (a) 
            {
                var c = _meta[a];
                if (typeof c === 'string') return c;
                c = a.charCodeAt();
                return '\\u00' + Math.floor(c / 16).toString(16) + (c % 16).toString(16);
            }) + '"';
        }
        return '"' + string + '"';
    };
    
    var _escapeable = /["\\\x00-\x1f\x7f-\x9f]/g;
    
    var _meta = {
        '\b': '\\b',
        '\t': '\\t',
        '\n': '\\n',
        '\f': '\\f',
        '\r': '\\r',
        '"' : '\\"',
        '\\': '\\\\'
    };
})(jQuery);
})(jQuery);

//jquery.dom.cookie.js

(function() {
    // break
    /**
     * @function jQuery.cookie
     * @parent dom
     * @author Klaus Hartl/klaus.hartl@stilbuero.de
     *
     * <h3>Cookie plugin</h3>
     *
     *
	 *  <p>
	 *  Copyright (c) 2006 Klaus Hartl (stilbuero.de)<br />
	 *  Dual licensed under the MIT and GPL licenses:<br />
	 *  http://www.opensource.org/licenses/mit-license.php<br />
	 *  http://www.gnu.org/licenses/gpl.html
	 *  </p>
	 *  <p>
	 *  Create a cookie with the given name and value and other optional parameters.
	 *  / Get the value of a cookie with the given name.
	 *  </p>
	 *  <h3>Quick Examples</h3>
	 * 
	 *  Set the value of a cookie.
	 *  @codestart
	 *  * $.cookie('the_cookie', 'the_value');
	 *  @codeend
	 * 
	 *  Create a cookie with all available options.
	 *  @codestart
	 *  $.cookie('the_cookie', 'the_value',
	 *  { expires: 7, path: '/', domain: 'jquery.com', secure: true });
	 *  @codeend
	 * 
	 *  Create a session cookie.
	 *  @codestart
	 *  $.cookie('the_cookie', 'the_value');
	 *  @codeend
	 * 
	 *  Delete a cookie by passing null as value. Keep in mind that you have to use the same path and domain
	 *  used when the cookie was set.
	 *  @codestart
	 *  $.cookie('the_cookie', null);
	 *  @codeend
	 * 
	 *  Get the value of a cookie.
	 *  @codestart
	 *  $.cookie('the_cookie');
	 *  @codeend
	 * 
     *
     * @param {String} [name] The name of the cookie.
     * @param {String} [value] The value of the cookie.
     * @param {Object} [options] An object literal containing key/value pairs to provide optional cookie attributes.<br />
     * @param {Number|Date} [expires] Either an integer specifying the expiration date from now on in days or a Date object.
     *                             If a negative value is specified (e.g. a date in the past), the cookie will be deleted.
     *                             If set to null or omitted, the cookie will be a session cookie and will not be retained
     *                             when the the browser exits.<br />
     * @param {String} [path] The value of the path atribute of the cookie (default: path of page that created the cookie).<br />
     * @param {String} [domain] The value of the domain attribute of the cookie (default: domain of page that created the cookie).<br />
     * @param {Boolean} secure If true, the secure attribute of the cookie will be set and the cookie transmission will
     *                        require a secure protocol (like HTTPS).<br />
     * @return {String} or {undefined} when setting the cookie.
     */
    jQuery.cookie = function(name, value, options) {
        if (typeof value != 'undefined') { // name and value given, set cookie
            options = options ||
            {};
            if (value === null) {
                value = '';
                options.expires = -1;
            }
            if (typeof value == 'object' && jQuery.toJSON) {
                value = jQuery.toJSON(value);
            }
            var expires = '';
            if (options.expires && (typeof options.expires == 'number' || options.expires.toUTCString)) {
                var date;
                if (typeof options.expires == 'number') {
                    date = new Date();
                    date.setTime(date.getTime() + (options.expires * 24 * 60 * 60 * 1000));
                }
                else {
                    date = options.expires;
                }
                expires = '; expires=' + date.toUTCString(); // use expires attribute, max-age is not supported by IE
            }
            // CAUTION: Needed to parenthesize options.path and options.domain
            // in the following expressions, otherwise they evaluate to undefined
            // in the packed version for some reason...
            var path = options.path ? '; path=' + (options.path) : '';
            var domain = options.domain ? '; domain=' + (options.domain) : '';
            var secure = options.secure ? '; secure' : '';
            document.cookie = [name, '=', encodeURIComponent(value), expires, path, domain, secure].join('');
        }
        else { // only name given, get cookie
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            if (jQuery.evalJSON && cookieValue && cookieValue.match(/^\s*\{/)) {
                try {
                    cookieValue = jQuery.evalJSON(cookieValue);
                }
                catch (e) {
                }
            }
            return cookieValue;
        }
    };

})(jQuery);

//jquery.dom.cur_styles.js

(function($){

var getComputedStyle = document.defaultView && document.defaultView.getComputedStyle,
	rupper = /([A-Z])/g,
	rdashAlpha = /-([a-z])/ig,
	fcamelCase = function(all, letter) {
		return letter.toUpperCase();
	},
	getStyle = function(elem) {
		if (getComputedStyle) {
			return getComputedStyle(elem, null);
		}
		else if (elem.currentStyle) {
			return elem.currentStyle
		}
	},
	rfloat = /float/i,
	rnumpx = /^-?\d+(?:px)?$/i,
	rnum = /^-?\d/;
/**
 * @add jQuery
 */
//
/**
 * @function curStyles
 * @param {HTMLElement} el
 * @param {Array} styles An array of style names like <code>['marginTop','borderLeft']</code>
 * @return {Object} an object of style:value pairs.  Style names are camelCase.
 */
$.curStyles = function(el, styles) {
	if(!el){
		return null;
	}
	var currentS = getStyle(el), 
				   oldName, 
				   val, 
				   style = el.style,
				   results = {},
				   i=0,
				   name;
	
	for(; i < styles.length; i++){
		name = styles[i];
		oldName = name.replace(rdashAlpha, fcamelCase);
		
		if ( rfloat.test( name ) ) {
			name = jQuery.support.cssFloat ? "float" : "styleFloat";
			oldName = "cssFloat"
		}
		
		if (getComputedStyle) {
			name = name.replace(rupper, "-$1").toLowerCase();
			val = currentS.getPropertyValue(name);
			if ( name === "opacity" && val === "" ) {
				val = "1";
			}
			results[oldName] = val;
		} else {
			var camelCase = name.replace(rdashAlpha, fcamelCase);
			results[oldName] = currentS[name] || currentS[camelCase];


			if (!rnumpx.test(results[oldName]) && rnum.test(results[oldName])) { //convert to px
				// Remember the original values
				var left = style.left, 
					rsLeft = el.runtimeStyle.left;

				// Put in the new values to get a computed value out
				el.runtimeStyle.left = el.currentStyle.left;
				style.left = camelCase === "fontSize" ? "1em" : (results[oldName] || 0);
				results[oldName] = style.pixelLeft + "px";

				// Revert the changed values
				style.left = left;
				el.runtimeStyle.left = rsLeft;
			}

		}
	}
	
	return results;
};
/**
 *  @add jQuery.fn
 */


$.fn.
/**
 * @parent dom
 * @plugin jquery/dom/cur_styles
 * @download http://jmvcsite.heroku.com/pluginify?plugins[]=jquery/dom/cur_styles/cur_styles.js
 * @test jquery/dom/cur_styles/qunit.html
 * Use curStyles to rapidly get a bunch of computed styles from an element.
 * <h3>Quick Example</h3>
 * @codestart
 * $("#foo").curStyles('float','display') //-> 
 * // {
 * //  cssFloat: "left", display: "block"
 * // }
 * @codeend
 * <h2>Use</h2>
 * <p>An element's <b>computed</b> style is the current calculated style of the property.
 * This is different than the values on <code>element.style</code> as
 * <code>element.style</code> doesn't reflect styles provided by css or the browser's default
 * css properties.</p>
 * <p>Getting computed values individually is expensive! This plugin lets you get all
 * the style properties you need all at once.</p>
 * <h2>Demo</h2>
 * <p>The following demo illustrates the performance improvement curStyle provides by providing
 * a faster 'height' jQuery function called 'fastHeight'.</p>
 * @demo jquery/dom/cur_styles/cur_styles.html
 * @param {String} style pass style names as arguments 
 * @return {Object} an object of style:value pairs
 */
curStyles = function(){
	return $.curStyles(this[0], $.makeArray(arguments))
}

})(jQuery);

//jquery.dom.dimensions.js

(function($) {
/**
 * @page dimensions dimensions
 * @parent dom
 * <h1>jquery/dom/dimensions <span class="Constructor type">Plugin</span></h1>
 * The dimensions plugin adds support for setting+animating inner+outer height and widths.
 * <h3>Quick Examples</h3>
@codestart
$('#foo').outerWidth(100).innerHeight(50);
$('#bar').animate({outerWidth: 500});
@codeend
 * <h2>Use</h2>
 * <p>When writing reusable plugins, you often want to 
 * set or animate an element's width and height that include its padding,
 * border, or margin.  This is especially important in plugins that
 * allow custom styling.
 * The dimensions plugin overwrites [jQuery.fn.outerHeight outerHeight],
 * [jQuery.fn.outerWidth outerWidth], [jQuery.fn.innerHeight innerHeight] 
 * and [jQuery.fn.innerWidth innerWidth]
 * to let you set and animate these properties.
 * </p>
 * <h2>Demo</h2>
 * @demo jquery/dom/dimensions/dimensions.html
 */

var weird = /button|select/i, //margin is inside border
	getBoxes = {},
    checks = {
        width: ["Left", "Right"],
        height: ['Top', 'Bottom'],
        oldOuterHeight: $.fn.outerHeight,
        oldOuterWidth: $.fn.outerWidth,
        oldInnerWidth: $.fn.innerWidth,
        oldInnerHeight: $.fn.innerHeight
    };
/**
 *  @add jQuery.fn
 */
$.each({ 

/*
 * @function outerWidth
 * @parent dimensions
 * Lets you set the outer height on an object
 * @param {Number} [height] 
 * @param {Boolean} [includeMargin]
 */
width: 
/*
 * @function innerWidth
 * @parent dimensions
 * Lets you set the inner height of an object
 * @param {Number} [height] 
 */
"Width", 
/*
 * @function outerHeight
 * @parent dimensions
 * Lets you set the outer height of an object where: <br/> 
 * <code>outerHeight = height + padding + border + (margin)</code>.  
 * @codestart
 * $("#foo").outerHeight(100); //sets outer height
 * $("#foo").outerHeight(100, true); //uses margins
 * $("#foo").outerHeight(); //returns outer height
 * $("#foo").outerHeight(true); //returns outer height with margins
 * @codeend
 * When setting the outerHeight, it adjusts the height of the element.
 * @param {Number|Boolean} [height] If a number is provided -> sets the outer height of the object.<br/>
 * If true is given ->  returns the outer height and includes margins.<br/>
 * If no value is given -> returns the outer height without margin.
 * @param {Boolean} [includeMargin] Makes setting the outerHeight adjust for margin.
 * @return {jQuery|Number} If you are setting the value, returns the jQuery wrapped elements.
 * Otherwise, returns outerHeight in pixels.
 */
height: 
/*
 * @function innerHeight
 * @parent dimensions
 * Lets you set the outer width on an object
 * @param {Number} [height] 
 */
"Height" }, function(lower, Upper) {

    //used to get the padding and border for an element in a given direction
    getBoxes[lower] = function(el, boxes) {
        var val = 0;
        if (!weird.test(el.nodeName)) {
            //make what to check for ....
            var myChecks = [];
            $.each(checks[lower], function() {
                var direction = this;
                $.each(boxes, function(name, val) {
                    if (val)
                        myChecks.push(name + direction+ (name == 'border' ? "Width" : "") );
                })
            })
            $.each($.curStyles(el, myChecks), function(name, value) {
                val += (parseFloat(value) || 0);
            })
        }
        return val;
    }

    //getter / setter
    $.fn["outer" + Upper] = function(v, margin) {
        if (typeof v == 'number') {
            this[lower](v - getBoxes[lower](this[0], {padding: true, border: true, margin: margin}))
            return this;
        } else {
            return checks["oldOuter" + Upper].call(this, v)
        }
    }
    $.fn["inner" + Upper] = function(v) {
        if (typeof v == 'number') {
            this[lower](v - getBoxes[lower](this[0], { padding: true }))
            return this;
        } else {
            return checks["oldInner" + Upper].call(this, v)
        }
    }
    //provides animations
	var animate = function(boxes){
		return function(fx){
			if (fx.state == 0) {
	            fx.start = $(fx.elem)[lower]();
	            fx.end = fx.end - getBoxes[lower](fx.elem,boxes);
	        }
	        fx.elem.style[lower] = (fx.pos * (fx.end - fx.start) + fx.start) + "px"
		}
	}
    $.fx.step["outer" + Upper] = animate({padding: true, border: true})
	
	$.fx.step["outer" + Upper+"Margin"] =  animate({padding: true, border: true, margin: true})
	
	$.fx.step["inner" + Upper] = animate({padding: true})

})

})(jQuery);

//jquery.dom.fixture.js

(function( $ ) {

	var ajax = $.ajax;

	/**
	 * @class jQuery.fixture
	 * @plugin jquery/dom/fixture
	 * @download http://jmvcsite.heroku.com/pluginify?plugins[]=jquery/dom/fixture/fixture.js
	 * @test jquery/dom/fixture/qunit.html
	 * @parent dom
	 * 
	 * Fixtures simulate AJAX responses by overwriting 
	 * [jQuery.ajax $.ajax], 
	 * [jQuery.get $.get], and 
	 * [jQuery.post $.post].  
	 * Instead of making a request to a server, fixtures simulate 
	 * the repsonse with a file or function.
	 * 
	 * They are a great technique when you want to develop JavaScript 
	 * independently of the backend. 
	 * 
	 * <h3>Quick Example</h3>
	 * <p>Instead of making a request to <code>/tasks.json</code>,
	 *    $.ajax will look in <code>fixtures/tasks.json</code>.
	 *    It's expected that a static <code>fixtures/tasks.json</code> 
	 *    file exists relative to the current page. 
	 * </p>
	 * @codestart
	 * $.ajax({url: "/tasks.json",
	 *   dataType: "json",
	 *   type: "get",
	 *   fixture: "fixtures/tasks.json",
	 *   success: myCallback});
	 * @codeend
	 * <h2>Using Fixtures</h2>
	 * To enable fixtures, you must add this plugin to your page and 
	 * set the fixture property.  
	 * 
	 * The fixture property is set as ...
	 * @codestart
	 * //... a property with $.ajax
	 * $.ajax({fixture: FIXTURE_VALUE})
	 * 
	 * //... a parameter in $.get and $.post
	 * $.get (  url, data, callback, type, FIXTURE_VALUE )
	 * $.post(  url, data, callback, type, FIXTURE_VALUE )
	 * @codeend
	 * <h3>Turning Off Fixtures</h3>
	 * <p>To turn off fixtures, simply remove the fixture plugin from 
	 *  your page.  The Ajax methods will ignore <code>FIXTURE_VALUE</code>
	 *  and revert to their normal behavior.  If you want to ignore a single
	 *  fixture, we suggest commenting it out.
	 * </p>
	 * <div class='whisper'>
	 * PRO TIP:  Don't worry about leaving the fixture values in your source.  
	 * They don't take up many characters and won't impact how jQuery makes
	 * requests.  They can be useful even after the service they simulate
	 * is created.
	 * </div>
	 * <h2>Types of Fixtures</h2>
	 * <p>There are 2 types of fixtures</p>
	 * <ul>
	 *  <li><b>Static</b> - the response is in a file.
	 *  </li>
	 *  <li>
	 *   <b>Dynamic</b> - the response is generated by a function.
	 *  </li>
	 * </ul>
	 * There are different ways to lookup static and dynamic fixtures.
	 * <h3>Static Fixtures</h3>
	 * Static fixture locations can be calculated:
	 * @codestart
	 * // looks in test/fixtures/tasks/1.get
	 * $.ajax({type:"get", 
	 *        url: "tasks/1", 
	 *        fixture: true}) 
	 * @codeend
	 * Or provided:
	 * @codestart
	 * // looks in fixtures/tasks1.json relative to page
	 * $.ajax({type:"get", 
	 *        url: "tasks/1", 
	 *        fixture: "fixtures/task1.json"})
	 * 
	 * // looks in fixtures/tasks1.json relative to jmvc root
	 * // this assumes you are using steal
	 * $.ajax({type:"get", 
	 *        url: "tasks/1", 
	 *        fixture: "//fixtures/task1.json"})` 
	 * @codeend
	 * <div class='whisper'>
	 *   PRO TIP: Use provided fixtures.  It's easier to understand what it is going.
	 *   Also, create a fixtures folder in your app to hold your fixtures.
	 * </div>
	 * <h3>Dynamic Fixtures</h3>
	 * <p>Dynamic Fixtures are functions that return the arguments the $.ajax callbacks 
	 *   (<code>beforeSend</code>, <code>success</code>, <code>complete</code>, 
	 *    <code>error</code>) expect.  </p>
	 * <p>For example, the "<code>success</code>" of a json request is called with 
	 * <code>[data, textStatus, XMLHttpRequest].</p>
	 * <p>There are 2 ways to lookup dynamic fixtures.<p>
	 * They can provided:
	 * @codestart
	 * //just use a function as the fixture property
	 * $.ajax({
	 *   type:     "get", 
	 *   url:      "tasks",
	 *   data:     {id: 5},
	 *   dataType: "json",
	 *   fixture: function( settings, callbackType ) {
	 *     var xhr = {responseText: "{id:"+settings.data.id+"}"}
	 *     switch(callbackType){
	 *       case "success": 
	 *         return [{id: settings.data.id},"success",xhr]
	 *       case "complete":
	 *         return [xhr,"success"]
	 *     }
	 *   }
	 * })
	 * @codeend
	 * Or found by name on $.fixture:
	 * @codestart
	 * // add your function on $.fixture
	 * // We use -FUNC by convention
	 * $.fixture["-myGet"] = function(settings, cbType){...}
	 * 
	 * // reference it
	 * $.ajax({
	 *   type:"get", 
	 *   url: "tasks/1", 
	 *   dataType: "json", 
	 *   fixture: "-myGet"})
	 * @codeend
	 * <p>Dynamic fixture functions are called with:</p>
	 * <ul>
	 * <li> settings - the settings data passed to <code>$.ajax()</code>
	 * <li> calbackType - the type of callback about to be called: 
	 *  <code>"beforeSend"</code>, <code>"success"</code>, <code>"complete"</code>, 
	 *    <code>"error"</code></li>
	 * </ul>
	 * and should return an array of arguments for the callback.<br/><br/>
	 * <div class='whisper'>PRO TIP: 
	 * Dynamic fixtures are awesome for performance testing.  Want to see what 
	 * 10000 files does to your app's performance?  Make a fixture that returns 10000 items.
	 * 
	 * What to see what the app feels like when a request takes 5 seconds to return?  Set
	 * [jQuery.fixture.delay] to 5000.
	 * </div>
	 * <h2>Helpers</h2>
	 * <p>The fixture plugin comes with a few ready-made dynamic fixtures and 
	 * fixture helpers:</p>
	 * <ul>
	 * <li>[jQuery.fixture.make] - creates fixtures for findAll, findOne.</li>
	 * <li>[jQuery.fixture.-restCreate] - a fixture for restful creates.</li>
	 * <li>[jQuery.fixture.-restDestroy] - a fixture for restful updates.</li>
	 * <li>[jQuery.fixture.-restUpdate] - a fixture for restful destroys.</li>
	 * </ul>
	 * @demo jquery/dom/fixture/fixture.html
	 * @constructor
	 * Takes an ajax settings and returns a url to look for a fixture.  Overwrite this if you want a custom lookup method.
	 * @param {Object} settings
	 * @return {String} the url that will be used for the fixture
	 */
	$.fixture = function( settings ) {
		var url = settings.url,
			match, left, right;
		url = url.replace(/%2F/g, "~").replace(/%20/g, "_");

		if ( settings.data && settings.processData && typeof settings.data !== "string" ) {
			settings.data = jQuery.param(settings.data);
		}


		if ( settings.data && settings.type.toLowerCase() == "get" ) {
			url += ($.String.include(url, '?') ? '&' : '?') + settings.data;
		}

		match = url.match(/^(?:https?:\/\/[^\/]*)?\/?([^\?]*)\??(.*)?/);
		left = match[1];

		right = settings.type ? '.' + settings.type.toLowerCase() : '.post';
		if ( match[2] ) {
			left += '/';
			right = match[2].replace(/\#|&/g, '-').replace(/\//g, '~') + right;
		}
		return left + right;
	};

	$.extend($.fixture, {
		/**
		 * Provides a rest update fixture function
		 */
		"-restUpdate": function( settings, cbType ) {
			switch ( cbType ) {
			case "success":
				return [$.extend({
					id: parseInt(settings.url, 10)
				}, settings.data), "success", $.fixture.xhr()];
			case "complete":
				return [$.fixture.xhr(), "success"];
			}
		},
		/**
		 * Provides a rest destroy fixture function
		 */
		"-restDestroy": function( settings, cbType ) {
			switch ( cbType ) {
			case "success":
				return [true, "success", $.fixture.xhr()];
			case "complete":
				return [$.fixture.xhr(), "success"];
			}
		},
		/**
		 * Provides a rest create fixture function
		 */
		"-restCreate": function( settings, cbType ) {
			switch ( cbType ) {
			case "success":
				return [{
					id: parseInt(Math.random() * 1000, 10)
				}, "success", $.fixture.xhr()];
			case "complete":
				return [$.fixture.xhr({
					getResponseHeader: function() {
						return settings.url + "/" + parseInt(Math.random() * 1000, 10);
					}
				}), "success"];
			}


		},
		/**
		 * Used to make fixtures for findAll / findOne style requests.
		 * @codestart
		 * //makes a threaded list of messages
		 * $.fixture.make(["messages","message"],1000, function(i, messages){
		 *   return {
		 *     subject: "This is message "+i,
		 *     body: "Here is some text for this message",
		 *     date: Math.floor( new Date().getTime() ),
		 *     parentId : i < 100 ? null : Math.floor(Math.random()*i)
		 *   }
		 * })
		 * //uses the message fixture to return messages limited by offset, limit, order, etc.
		 * $.ajax({
		 *   url: "messages",
		 *   data:{ 
		 *      offset: 100, 
		 *      limit: 50, 
		 *      order: "date ASC",
		 *      parentId: 5},
		 *    },
		 *    fixture: "-messages",
		 *    success: function( messages ) {  ... }
		 * });
		 * @codeend
		 * @param {Array} types An array of the fixture names
		 * @param {Number} count the number of items to create
		 * @param {Function} make a function that will return json data representing the object.
		 */
		make: function( types, count, make ) {
			// make all items
			var items = ($.fixture["~" + types[0]] = []);
			for ( var i = 0; i < (count); i++ ) {
				//call back provided make
				var item = make(i, items);

				if (!item.id ) {
					item.id = i;
				}
				items.push(item);
			}
			//set plural fixture for findAll
			$.fixture["-" + types[0]] = function( settings ) {

				//copy array of items
				var retArr = items.slice(0);

				//sort using order
				//order looks like ["age ASC","gender DESC"]
				$.each((settings.data.order || []).slice(0).reverse(), function( i, name ) {
					var split = name.split(" ");
					retArr = retArr.sort(function( a, b ) {
						if ( split[1].toUpperCase() !== "ASC" ) {
							return a[split[0]] < b[split[0]];
						}
						else {
							return a[split[0]] > b[split[0]];
						}
					});
				});

				//group is just like a sort
				$.each((settings.data.group || []).slice(0).reverse(), function( i, name ) {
					var split = name.split(" ");
					retArr = retArr.sort(function( a, b ) {
						return a[split[0]] > b[split[0]];
					});
				});


				var offset = parseInt(settings.data.offset, 10) || 0,
					limit = parseInt(settings.data.limit, 10) || (count - offset),
					i = 0;

				//filter results if someone added an attr like parentId
				for ( var param in settings.data ) {
					if ( param.indexOf("Id") != -1 || param.indexOf("_id") != -1 ) {
						while ( i < retArr.length ) {
							if ( settings.data[param] != retArr[i][param] ) {
								retArr.splice(i, 1);
							} else {
								i++;
							}
						}
					}
				}

				//return data spliced with limit and offset
				return [{
					"count": retArr.length,
					"limit": settings.data.limit,
					"offset": settings.data.offset,
					"data": retArr.slice(offset, offset + limit)
				}];
			};

			$.fixture["-" + types[1]] = function( settings ) {
				for ( var i = 0; i < (count); i++ ) {
					if ( settings.data.id == items[i].id ) {
						return [items[i]];
					}
				}
			};

		},
		/**
		 * Use $.fixture.xhr to create an object that looks like an xhr object. 
		 * <h3>Example</h3>
		 * The following example shows how the -restCreate fixture uses xhr to return 
		 * a simulated xhr object:
		 * @codestart
		 * "-restCreate" : function( settings, cbType ) {
		 *   switch(cbType){
		 *     case "success": 
		 *       return [
		 *         {id: parseInt(Math.random()*1000)}, 
		 *         "success", 
		 *         $.fixture.xhr()];
		 *     case "complete":
		 *       return [ 
		 *         $.fixture.xhr({
		 *           getResponseHeader: function() { 
		 *             return settings.url+"/"+parseInt(Math.random()*1000);
		 *           }
		 *         }),
		 *         "success"];
		 *   }
		 * }
		 * @codeend
		 * @param {Object} [xhr] properties that you want to overwrite
		 * @return {Object} an object that looks like a successful XHR object.
		 */
		xhr: function( xhr ) {
			return $.extend({}, {
				abort: $.noop,
				getAllResponseHeaders: function() {
					return "";
				},
				getResponseHeader: function() {
					return "";
				},
				open: $.noop,
				overrideMimeType: $.noop,
				readyState: 4,
				responseText: "",
				responseXML: null,
				send: $.noop,
				setRequestHeader: $.noop,
				status: 200,
				statusText: "OK"
			}, xhr);
		}
	});
	/**
	 * @attribute delay
	 * Sets the delay in milliseconds between an ajax request is made and
	 * the success and complete handlers are called.  This only sets
	 * functional fixtures.  By default, the delay is 200ms.
	 * @codestart
	 * steal.plugins('jquery/dom/fixtures').then(function(){
	 *   $.fixture.delay = 1000;
	 * })
	 * @codeend
	 */
	$.fixture.delay = 200;

	$.fixture["-handleFunction"] = function( settings ) {
		if ( typeof settings.fixture === "string" && $.fixture[settings.fixture] ) {
			settings.fixture = $.fixture[settings.fixture];
		}
		if ( typeof settings.fixture == "function" ) {
			setTimeout(function() {
				if ( settings.success ) {
					settings.success.apply(null, settings.fixture(settings, "success"));
				}
				if ( settings.complete ) {
					settings.complete.apply(null, settings.fixture(settings, "complete"));
				}
			}, $.fixture.delay);
			return true;
		}
		return false;
	};

	/**
	 *  @add jQuery
	 */
	// break
	$.
	/**
	 * Adds the fixture option to settings. If present, loads from fixture location instead
	 * of provided url.  This is useful for simulating ajax responses before the server is done.
	 * @param {Object} settings
	 */
	ajax = function( settings ) {
		var func = $.fixture;
		if (!settings.fixture ) {
			return ajax.apply($, arguments);
		}
		if ( $.fixture["-handleFunction"](settings) ) {
			return;
		}
		if ( typeof settings.fixture == "string" ) {
			var url = settings.fixture;
			if (/^\/\//.test(url) ) {
				url = steal.root.join(settings.fixture.substr(2));
			}
			
			settings.url = url;
			settings.data = null;
			settings.type = "GET";
			if (!settings.error ) {
				settings.error = function( xhr, error, message ) {
					throw "fixtures.js Error " + error + " " + message;
				};
			}
			return ajax(settings);

		}
		settings = jQuery.extend(true, settings, jQuery.extend(true, {}, jQuery.ajaxSettings, settings));

		settings.url = steal.root.join('test/fixtures/' + func(settings)); // convert settings
		settings.data = null;
		settings.type = 'GET';
		return ajax(settings);
	};

	$.extend($.ajax, ajax);

	$.
	/**
	 * Adds a fixture param.  
	 * @param {Object} url
	 * @param {Object} data
	 * @param {Object} callback
	 * @param {Object} type
	 * @param {Object} fixture
	 */
	get = function( url, data, callback, type, fixture ) {
		// shift arguments if data argument was ommited
		if ( jQuery.isFunction(data) ) {
			fixture = type;
			type = callback;
			callback = data;
			data = null;
		}

		return jQuery.ajax({
			type: "GET",
			url: url,
			data: data,
			success: callback,
			dataType: type,
			fixture: fixture
		});
	};

	$.
	/**
	 * Adds a fixture param.
	 * @param {Object} url
	 * @param {Object} data
	 * @param {Object} callback
	 * @param {Object} type
	 * @param {Object} fixture
	 */
	post = function( url, data, callback, type, fixture ) {
		if ( jQuery.isFunction(data) ) {
			fixture = type;
			type = callback;
			callback = data;
			data = {};
		}

		return jQuery.ajax({
			type: "POST",
			url: url,
			data: data,
			success: callback,
			dataType: type,
			fixture: fixture
		});
	};
})(jQuery);

//jquery.dom.form_params.js

(function( $ ) {
	var radioCheck = /radio|checkbox/i,
		keyBreaker = /[^\[\]]+/g,
		numberMatcher = /^[\-+]?[0-9]*\.?[0-9]+([eE][\-+]?[0-9]+)?$/;

	var isNumber = function( value ) {
		if ( typeof value == 'number' ) {
			return true;
		}

		if ( typeof value != 'string' ) {
			return false;
		}

		return value.match(numberMatcher);
	};

	$.fn.extend({
		/**
		 * @parent dom
		 * @download http://jmvcsite.heroku.com/pluginify?plugins[]=jquery/dom/form_params/form_params.js
		 * @plugin jquery/dom/form_params
		 * @test jquery/dom/form_params/qunit.html
		 * <p>Returns an object of name-value pairs that represents values in a form.  
		 * It is able to nest values whose element's name has square brackets. </p>
		 * Example html:
		 * @codestart html
		 * &lt;form>
		 *   &lt;input name="foo[bar]" value='2'/>
		 *   &lt;input name="foo[ced]" value='4'/>
		 * &lt;form/>
		 * @codeend
		 * Example code:
		 * @codestart
		 * $('form').formParams() //-> { foo:{bar:2, ced: 4} }
		 * @codeend
		 * 
		 * @demo jquery/dom/form_params/form_params.html
		 * 
		 * @param {Boolean} [convert] True if strings that look like numbers and booleans should be converted.  Defaults to true.
		 * @return {Object} An object of name-value pairs.
		 */
		formParams: function( convert ) {
			if ( this[0].nodeName.toLowerCase() == 'form' && this[0].elements ) {

				return jQuery(jQuery.makeArray(this[0].elements)).getParams(convert);
			}
			return jQuery("input[name], textarea[name], select[name]", this[0]).getParams(convert);
		},
		getParams: function( convert ) {
			var data = {},
				current;

			convert = convert === undefined ? true : convert;

			this.each(function() {
				var el = this,
					type = el.type && el.type.toLowerCase();
				//if we are submit, ignore
				if ((type == 'submit') || !el.name ) {
					return;
				}

				var key = el.name,
					value = $.fn.val.call([el]) || $.data(el, "value"),
					isRadioCheck = radioCheck.test(el.type),
					parts = key.match(keyBreaker),
					write = !isRadioCheck || !! el.checked,
					//make an array of values
					lastPart;

				if ( convert ) {
					if ( isNumber(value) ) {
						value = parseFloat(value);
					} else if ( value === 'true' || value === 'false' ) {
						value = Boolean(value);
					}

				}

				// go through and create nested objects
				current = data;
				for ( var i = 0; i < parts.length - 1; i++ ) {
					if (!current[parts[i]] ) {
						current[parts[i]] = {};
					}
					current = current[parts[i]];
				}
				lastPart = parts[parts.length - 1];

				//now we are on the last part, set the value
				if ( lastPart in current && type === "checkbox" ) {
					if (!$.isArray(current[lastPart]) ) {
						current[lastPart] = current[lastPart] === undefined ? [] : [current[lastPart]];
					}
					if ( write ) {
						current[lastPart].push(value);
					}
				} else if ( write || !current[lastPart] ) {
					current[lastPart] = write ? value : undefined;
				}

			});
			return data;
		}
	});

})(jQuery);

//jquery.dom.within.js

(function($){
   var withinBox = function(x, y, left, top, width, height ){
        return (y >= top &&
                y <  top + height &&
                x >= left &&
                x <  left + width);
    } 
/**
 * @function within
 * @parent dom
 * Returns if the elements are within the position
 * @param {Object} x
 * @param {Object} y
 * @param {Object} cache
 */
$.fn.within= function(x, y, cache) {
    var ret = []
    this.each(function(){
        var q = jQuery(this);

        if(this == document.documentElement) return ret.push(this);

        var offset = cache ? jQuery.data(this,"offset", q.offset()) : q.offset();

        var res =  withinBox(x, y, 
                                      offset.left, offset.top,
                                      this.offsetWidth, this.offsetHeight );

        if(res) ret.push(this);
    });
    
    return this.pushStack( jQuery.unique( ret ), "within", x+","+y );
}


/**
 * @function withinBox
 * returns if elements are within the box
 * @param {Object} left
 * @param {Object} top
 * @param {Object} width
 * @param {Object} height
 * @param {Object} cache
 */
$.fn.withinBox = function(left, top, width, height, cache){
  	var ret = []
    this.each(function(){
        var q = jQuery(this);

        if(this == document.documentElement) return  this.ret.push(this);

        var offset = cache ? jQuery.data(this,"offset", q.offset()) : q.offset();

        var ew = q.width(), eh = q.height();

		res =  !( (offset.top > top+height) || (offset.top +eh < top) || (offset.left > left+width ) || (offset.left+ew < left));

        if(res)
            ret.push(this);
    });
    return this.pushStack( jQuery.unique( ret ), "withinBox", jQuery.makeArray(arguments).join(",") );
}
    
})(jQuery);
//! moment.js
//! version : 2.3.1
//! authors : Tim Wood, Iskren Chernev, Moment.js contributors
//! license : MIT
//! momentjs.com
(function(a){function b(a,b){return function(c){return i(a.call(this,c),b)}}function c(a,b){return function(c){return this.lang().ordinal(a.call(this,c),b)}}function d(){}function e(a){u(a),g(this,a)}function f(a){var b=o(a),c=b.year||0,d=b.month||0,e=b.week||0,f=b.day||0,g=b.hour||0,h=b.minute||0,i=b.second||0,j=b.millisecond||0;this._input=a,this._milliseconds=+j+1e3*i+6e4*h+36e5*g,this._days=+f+7*e,this._months=+d+12*c,this._data={},this._bubble()}function g(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return b.hasOwnProperty("toString")&&(a.toString=b.toString),b.hasOwnProperty("valueOf")&&(a.valueOf=b.valueOf),a}function h(a){return 0>a?Math.ceil(a):Math.floor(a)}function i(a,b){for(var c=a+"";c.length<b;)c="0"+c;return c}function j(a,b,c,d){var e,f,g=b._milliseconds,h=b._days,i=b._months;g&&a._d.setTime(+a._d+g*c),(h||i)&&(e=a.minute(),f=a.hour()),h&&a.date(a.date()+h*c),i&&a.month(a.month()+i*c),g&&!d&&bb.updateOffset(a),(h||i)&&(a.minute(e),a.hour(f))}function k(a){return"[object Array]"===Object.prototype.toString.call(a)}function l(a){return"[object Date]"===Object.prototype.toString.call(a)}function m(a,b,c){var d,e=Math.min(a.length,b.length),f=Math.abs(a.length-b.length),g=0;for(d=0;e>d;d++)(c&&a[d]!==b[d]||!c&&q(a[d])!==q(b[d]))&&g++;return g+f}function n(a){if(a){var b=a.toLowerCase().replace(/(.)s$/,"$1");a=Jb[a]||Kb[b]||b}return a}function o(a){var b,c,d={};for(c in a)a.hasOwnProperty(c)&&(b=n(c),b&&(d[b]=a[c]));return d}function p(b){var c,d;if(0===b.indexOf("week"))c=7,d="day";else{if(0!==b.indexOf("month"))return;c=12,d="month"}bb[b]=function(e,f){var g,h,i=bb.fn._lang[b],j=[];if("number"==typeof e&&(f=e,e=a),h=function(a){var b=bb().utc().set(d,a);return i.call(bb.fn._lang,b,e||"")},null!=f)return h(f);for(g=0;c>g;g++)j.push(h(g));return j}}function q(a){var b=+a,c=0;return 0!==b&&isFinite(b)&&(c=b>=0?Math.floor(b):Math.ceil(b)),c}function r(a,b){return new Date(Date.UTC(a,b+1,0)).getUTCDate()}function s(a){return t(a)?366:365}function t(a){return 0===a%4&&0!==a%100||0===a%400}function u(a){var b;a._a&&-2===a._pf.overflow&&(b=a._a[gb]<0||a._a[gb]>11?gb:a._a[hb]<1||a._a[hb]>r(a._a[fb],a._a[gb])?hb:a._a[ib]<0||a._a[ib]>23?ib:a._a[jb]<0||a._a[jb]>59?jb:a._a[kb]<0||a._a[kb]>59?kb:a._a[lb]<0||a._a[lb]>999?lb:-1,a._pf._overflowDayOfYear&&(fb>b||b>hb)&&(b=hb),a._pf.overflow=b)}function v(a){a._pf={empty:!1,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:!1,invalidMonth:null,invalidFormat:!1,userInvalidated:!1}}function w(a){return null==a._isValid&&(a._isValid=!isNaN(a._d.getTime())&&a._pf.overflow<0&&!a._pf.empty&&!a._pf.invalidMonth&&!a._pf.nullInput&&!a._pf.invalidFormat&&!a._pf.userInvalidated,a._strict&&(a._isValid=a._isValid&&0===a._pf.charsLeftOver&&0===a._pf.unusedTokens.length)),a._isValid}function x(a){return a?a.toLowerCase().replace("_","-"):a}function y(a,b){return b.abbr=a,mb[a]||(mb[a]=new d),mb[a].set(b),mb[a]}function z(a){delete mb[a]}function A(a){var b,c,d,e,f=0,g=function(a){if(!mb[a]&&nb)try{require("./lang/"+a)}catch(b){}return mb[a]};if(!a)return bb.fn._lang;if(!k(a)){if(c=g(a))return c;a=[a]}for(;f<a.length;){for(e=x(a[f]).split("-"),b=e.length,d=x(a[f+1]),d=d?d.split("-"):null;b>0;){if(c=g(e.slice(0,b).join("-")))return c;if(d&&d.length>=b&&m(e,d,!0)>=b-1)break;b--}f++}return bb.fn._lang}function B(a){return a.match(/\[[\s\S]/)?a.replace(/^\[|\]$/g,""):a.replace(/\\/g,"")}function C(a){var b,c,d=a.match(rb);for(b=0,c=d.length;c>b;b++)d[b]=Ob[d[b]]?Ob[d[b]]:B(d[b]);return function(e){var f="";for(b=0;c>b;b++)f+=d[b]instanceof Function?d[b].call(e,a):d[b];return f}}function D(a,b){return a.isValid()?(b=E(b,a.lang()),Lb[b]||(Lb[b]=C(b)),Lb[b](a)):a.lang().invalidDate()}function E(a,b){function c(a){return b.longDateFormat(a)||a}var d=5;for(sb.lastIndex=0;d>=0&&sb.test(a);)a=a.replace(sb,c),sb.lastIndex=0,d-=1;return a}function F(a,b){var c;switch(a){case"DDDD":return vb;case"YYYY":case"GGGG":case"gggg":return wb;case"YYYYY":case"GGGGG":case"ggggg":return xb;case"S":case"SS":case"SSS":case"DDD":return ub;case"MMM":case"MMMM":case"dd":case"ddd":case"dddd":return yb;case"a":case"A":return A(b._l)._meridiemParse;case"X":return Bb;case"Z":case"ZZ":return zb;case"T":return Ab;case"MM":case"DD":case"YY":case"GG":case"gg":case"HH":case"hh":case"mm":case"ss":case"M":case"D":case"d":case"H":case"h":case"m":case"s":case"w":case"ww":case"W":case"WW":case"e":case"E":return tb;default:return c=new RegExp(N(M(a.replace("\\","")),"i"))}}function G(a){var b=(zb.exec(a)||[])[0],c=(b+"").match(Gb)||["-",0,0],d=+(60*c[1])+q(c[2]);return"+"===c[0]?-d:d}function H(a,b,c){var d,e=c._a;switch(a){case"M":case"MM":null!=b&&(e[gb]=q(b)-1);break;case"MMM":case"MMMM":d=A(c._l).monthsParse(b),null!=d?e[gb]=d:c._pf.invalidMonth=b;break;case"D":case"DD":null!=b&&(e[hb]=q(b));break;case"DDD":case"DDDD":null!=b&&(c._dayOfYear=q(b));break;case"YY":e[fb]=q(b)+(q(b)>68?1900:2e3);break;case"YYYY":case"YYYYY":e[fb]=q(b);break;case"a":case"A":c._isPm=A(c._l).isPM(b);break;case"H":case"HH":case"h":case"hh":e[ib]=q(b);break;case"m":case"mm":e[jb]=q(b);break;case"s":case"ss":e[kb]=q(b);break;case"S":case"SS":case"SSS":e[lb]=q(1e3*("0."+b));break;case"X":c._d=new Date(1e3*parseFloat(b));break;case"Z":case"ZZ":c._useUTC=!0,c._tzm=G(b);break;case"w":case"ww":case"W":case"WW":case"d":case"dd":case"ddd":case"dddd":case"e":case"E":a=a.substr(0,1);case"gg":case"gggg":case"GG":case"GGGG":case"GGGGG":a=a.substr(0,2),b&&(c._w=c._w||{},c._w[a]=b)}}function I(a){var b,c,d,e,f,g,h,i,j,k,l=[];if(!a._d){for(d=K(a),a._w&&null==a._a[hb]&&null==a._a[gb]&&(f=function(b){return b?b.length<3?parseInt(b,10)>68?"19"+b:"20"+b:b:null==a._a[fb]?bb().weekYear():a._a[fb]},g=a._w,null!=g.GG||null!=g.W||null!=g.E?h=X(f(g.GG),g.W||1,g.E,4,1):(i=A(a._l),j=null!=g.d?T(g.d,i):null!=g.e?parseInt(g.e,10)+i._week.dow:0,k=parseInt(g.w,10)||1,null!=g.d&&j<i._week.dow&&k++,h=X(f(g.gg),k,j,i._week.doy,i._week.dow)),a._a[fb]=h.year,a._dayOfYear=h.dayOfYear),a._dayOfYear&&(e=null==a._a[fb]?d[fb]:a._a[fb],a._dayOfYear>s(e)&&(a._pf._overflowDayOfYear=!0),c=S(e,0,a._dayOfYear),a._a[gb]=c.getUTCMonth(),a._a[hb]=c.getUTCDate()),b=0;3>b&&null==a._a[b];++b)a._a[b]=l[b]=d[b];for(;7>b;b++)a._a[b]=l[b]=null==a._a[b]?2===b?1:0:a._a[b];l[ib]+=q((a._tzm||0)/60),l[jb]+=q((a._tzm||0)%60),a._d=(a._useUTC?S:R).apply(null,l)}}function J(a){var b;a._d||(b=o(a._i),a._a=[b.year,b.month,b.day,b.hour,b.minute,b.second,b.millisecond],I(a))}function K(a){var b=new Date;return a._useUTC?[b.getUTCFullYear(),b.getUTCMonth(),b.getUTCDate()]:[b.getFullYear(),b.getMonth(),b.getDate()]}function L(a){a._a=[],a._pf.empty=!0;var b,c,d,e,f,g=A(a._l),h=""+a._i,i=h.length,j=0;for(d=E(a._f,g).match(rb)||[],b=0;b<d.length;b++)e=d[b],c=(F(e,a).exec(h)||[])[0],c&&(f=h.substr(0,h.indexOf(c)),f.length>0&&a._pf.unusedInput.push(f),h=h.slice(h.indexOf(c)+c.length),j+=c.length),Ob[e]?(c?a._pf.empty=!1:a._pf.unusedTokens.push(e),H(e,c,a)):a._strict&&!c&&a._pf.unusedTokens.push(e);a._pf.charsLeftOver=i-j,h.length>0&&a._pf.unusedInput.push(h),a._isPm&&a._a[ib]<12&&(a._a[ib]+=12),a._isPm===!1&&12===a._a[ib]&&(a._a[ib]=0),I(a),u(a)}function M(a){return a.replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(a,b,c,d,e){return b||c||d||e})}function N(a){return a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function O(a){var b,c,d,e,f;if(0===a._f.length)return a._pf.invalidFormat=!0,a._d=new Date(0/0),void 0;for(e=0;e<a._f.length;e++)f=0,b=g({},a),v(b),b._f=a._f[e],L(b),w(b)&&(f+=b._pf.charsLeftOver,f+=10*b._pf.unusedTokens.length,b._pf.score=f,(null==d||d>f)&&(d=f,c=b));g(a,c||b)}function P(a){var b,c=a._i,d=Cb.exec(c);if(d){for(b=4;b>0;b--)if(d[b]){a._f=Eb[b-1]+(d[6]||" ");break}for(b=0;4>b;b++)if(Fb[b][1].exec(c)){a._f+=Fb[b][0];break}zb.exec(c)&&(a._f+=" Z"),L(a)}else a._d=new Date(c)}function Q(b){var c=b._i,d=ob.exec(c);c===a?b._d=new Date:d?b._d=new Date(+d[1]):"string"==typeof c?P(b):k(c)?(b._a=c.slice(0),I(b)):l(c)?b._d=new Date(+c):"object"==typeof c?J(b):b._d=new Date(c)}function R(a,b,c,d,e,f,g){var h=new Date(a,b,c,d,e,f,g);return 1970>a&&h.setFullYear(a),h}function S(a){var b=new Date(Date.UTC.apply(null,arguments));return 1970>a&&b.setUTCFullYear(a),b}function T(a,b){if("string"==typeof a)if(isNaN(a)){if(a=b.weekdaysParse(a),"number"!=typeof a)return null}else a=parseInt(a,10);return a}function U(a,b,c,d,e){return e.relativeTime(b||1,!!c,a,d)}function V(a,b,c){var d=eb(Math.abs(a)/1e3),e=eb(d/60),f=eb(e/60),g=eb(f/24),h=eb(g/365),i=45>d&&["s",d]||1===e&&["m"]||45>e&&["mm",e]||1===f&&["h"]||22>f&&["hh",f]||1===g&&["d"]||25>=g&&["dd",g]||45>=g&&["M"]||345>g&&["MM",eb(g/30)]||1===h&&["y"]||["yy",h];return i[2]=b,i[3]=a>0,i[4]=c,U.apply({},i)}function W(a,b,c){var d,e=c-b,f=c-a.day();return f>e&&(f-=7),e-7>f&&(f+=7),d=bb(a).add("d",f),{week:Math.ceil(d.dayOfYear()/7),year:d.year()}}function X(a,b,c,d,e){var f,g,h=new Date(Date.UTC(a,0)).getUTCDay();return c=null!=c?c:e,f=e-h+(h>d?7:0),g=7*(b-1)+(c-e)+f+1,{year:g>0?a:a-1,dayOfYear:g>0?g:s(a-1)+g}}function Y(a){var b=a._i,c=a._f;return"undefined"==typeof a._pf&&v(a),null===b?bb.invalid({nullInput:!0}):("string"==typeof b&&(a._i=b=A().preparse(b)),bb.isMoment(b)?(a=g({},b),a._d=new Date(+b._d)):c?k(c)?O(a):L(a):Q(a),new e(a))}function Z(a,b){bb.fn[a]=bb.fn[a+"s"]=function(a){var c=this._isUTC?"UTC":"";return null!=a?(this._d["set"+c+b](a),bb.updateOffset(this),this):this._d["get"+c+b]()}}function $(a){bb.duration.fn[a]=function(){return this._data[a]}}function _(a,b){bb.duration.fn["as"+a]=function(){return+this/b}}function ab(){"undefined"==typeof ender&&(this.moment=bb)}for(var bb,cb,db="2.3.1",eb=Math.round,fb=0,gb=1,hb=2,ib=3,jb=4,kb=5,lb=6,mb={},nb="undefined"!=typeof module&&module.exports,ob=/^\/?Date\((\-?\d+)/i,pb=/(\-)?(?:(\d*)\.)?(\d+)\:(\d+)(?:\:(\d+)\.?(\d{3})?)?/,qb=/^(-)?P(?:(?:([0-9,.]*)Y)?(?:([0-9,.]*)M)?(?:([0-9,.]*)D)?(?:T(?:([0-9,.]*)H)?(?:([0-9,.]*)M)?(?:([0-9,.]*)S)?)?|([0-9,.]*)W)$/,rb=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|mm?|ss?|SS?S?|X|zz?|ZZ?|.)/g,sb=/(\[[^\[]*\])|(\\)?(LT|LL?L?L?|l{1,4})/g,tb=/\d\d?/,ub=/\d{1,3}/,vb=/\d{3}/,wb=/\d{1,4}/,xb=/[+\-]?\d{1,6}/,yb=/[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,zb=/Z|[\+\-]\d\d:?\d\d/i,Ab=/T/i,Bb=/[\+\-]?\d+(\.\d{1,3})?/,Cb=/^\s*\d{4}-(?:(\d\d-\d\d)|(W\d\d$)|(W\d\d-\d)|(\d\d\d))((T| )(\d\d(:\d\d(:\d\d(\.\d\d?\d?)?)?)?)?([\+\-]\d\d:?\d\d)?)?$/,Db="YYYY-MM-DDTHH:mm:ssZ",Eb=["YYYY-MM-DD","GGGG-[W]WW","GGGG-[W]WW-E","YYYY-DDD"],Fb=[["HH:mm:ss.S",/(T| )\d\d:\d\d:\d\d\.\d{1,3}/],["HH:mm:ss",/(T| )\d\d:\d\d:\d\d/],["HH:mm",/(T| )\d\d:\d\d/],["HH",/(T| )\d\d/]],Gb=/([\+\-]|\d\d)/gi,Hb="Date|Hours|Minutes|Seconds|Milliseconds".split("|"),Ib={Milliseconds:1,Seconds:1e3,Minutes:6e4,Hours:36e5,Days:864e5,Months:2592e6,Years:31536e6},Jb={ms:"millisecond",s:"second",m:"minute",h:"hour",d:"day",D:"date",w:"week",W:"isoWeek",M:"month",y:"year",DDD:"dayOfYear",e:"weekday",E:"isoWeekday",gg:"weekYear",GG:"isoWeekYear"},Kb={dayofyear:"dayOfYear",isoweekday:"isoWeekday",isoweek:"isoWeek",weekyear:"weekYear",isoweekyear:"isoWeekYear"},Lb={},Mb="DDD w W M D d".split(" "),Nb="M D H h m s w W".split(" "),Ob={M:function(){return this.month()+1},MMM:function(a){return this.lang().monthsShort(this,a)},MMMM:function(a){return this.lang().months(this,a)},D:function(){return this.date()},DDD:function(){return this.dayOfYear()},d:function(){return this.day()},dd:function(a){return this.lang().weekdaysMin(this,a)},ddd:function(a){return this.lang().weekdaysShort(this,a)},dddd:function(a){return this.lang().weekdays(this,a)},w:function(){return this.week()},W:function(){return this.isoWeek()},YY:function(){return i(this.year()%100,2)},YYYY:function(){return i(this.year(),4)},YYYYY:function(){return i(this.year(),5)},gg:function(){return i(this.weekYear()%100,2)},gggg:function(){return this.weekYear()},ggggg:function(){return i(this.weekYear(),5)},GG:function(){return i(this.isoWeekYear()%100,2)},GGGG:function(){return this.isoWeekYear()},GGGGG:function(){return i(this.isoWeekYear(),5)},e:function(){return this.weekday()},E:function(){return this.isoWeekday()},a:function(){return this.lang().meridiem(this.hours(),this.minutes(),!0)},A:function(){return this.lang().meridiem(this.hours(),this.minutes(),!1)},H:function(){return this.hours()},h:function(){return this.hours()%12||12},m:function(){return this.minutes()},s:function(){return this.seconds()},S:function(){return q(this.milliseconds()/100)},SS:function(){return i(q(this.milliseconds()/10),2)},SSS:function(){return i(this.milliseconds(),3)},Z:function(){var a=-this.zone(),b="+";return 0>a&&(a=-a,b="-"),b+i(q(a/60),2)+":"+i(q(a)%60,2)},ZZ:function(){var a=-this.zone(),b="+";return 0>a&&(a=-a,b="-"),b+i(q(10*a/6),4)},z:function(){return this.zoneAbbr()},zz:function(){return this.zoneName()},X:function(){return this.unix()}},Pb=["months","monthsShort","weekdays","weekdaysShort","weekdaysMin"];Mb.length;)cb=Mb.pop(),Ob[cb+"o"]=c(Ob[cb],cb);for(;Nb.length;)cb=Nb.pop(),Ob[cb+cb]=b(Ob[cb],2);for(Ob.DDDD=b(Ob.DDD,3),g(d.prototype,{set:function(a){var b,c;for(c in a)b=a[c],"function"==typeof b?this[c]=b:this["_"+c]=b},_months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),months:function(a){return this._months[a.month()]},_monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),monthsShort:function(a){return this._monthsShort[a.month()]},monthsParse:function(a){var b,c,d;for(this._monthsParse||(this._monthsParse=[]),b=0;12>b;b++)if(this._monthsParse[b]||(c=bb.utc([2e3,b]),d="^"+this.months(c,"")+"|^"+this.monthsShort(c,""),this._monthsParse[b]=new RegExp(d.replace(".",""),"i")),this._monthsParse[b].test(a))return b},_weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdays:function(a){return this._weekdays[a.day()]},_weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysShort:function(a){return this._weekdaysShort[a.day()]},_weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),weekdaysMin:function(a){return this._weekdaysMin[a.day()]},weekdaysParse:function(a){var b,c,d;for(this._weekdaysParse||(this._weekdaysParse=[]),b=0;7>b;b++)if(this._weekdaysParse[b]||(c=bb([2e3,1]).day(b),d="^"+this.weekdays(c,"")+"|^"+this.weekdaysShort(c,"")+"|^"+this.weekdaysMin(c,""),this._weekdaysParse[b]=new RegExp(d.replace(".",""),"i")),this._weekdaysParse[b].test(a))return b},_longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D YYYY",LLL:"MMMM D YYYY LT",LLLL:"dddd, MMMM D YYYY LT"},longDateFormat:function(a){var b=this._longDateFormat[a];return!b&&this._longDateFormat[a.toUpperCase()]&&(b=this._longDateFormat[a.toUpperCase()].replace(/MMMM|MM|DD|dddd/g,function(a){return a.slice(1)}),this._longDateFormat[a]=b),b},isPM:function(a){return"p"===(a+"").toLowerCase().charAt(0)},_meridiemParse:/[ap]\.?m?\.?/i,meridiem:function(a,b,c){return a>11?c?"pm":"PM":c?"am":"AM"},_calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},calendar:function(a,b){var c=this._calendar[a];return"function"==typeof c?c.apply(b):c},_relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},relativeTime:function(a,b,c,d){var e=this._relativeTime[c];return"function"==typeof e?e(a,b,c,d):e.replace(/%d/i,a)},pastFuture:function(a,b){var c=this._relativeTime[a>0?"future":"past"];return"function"==typeof c?c(b):c.replace(/%s/i,b)},ordinal:function(a){return this._ordinal.replace("%d",a)},_ordinal:"%d",preparse:function(a){return a},postformat:function(a){return a},week:function(a){return W(a,this._week.dow,this._week.doy).week},_week:{dow:0,doy:6},_invalidDate:"Invalid date",invalidDate:function(){return this._invalidDate}}),bb=function(b,c,d,e){return"boolean"==typeof d&&(e=d,d=a),Y({_i:b,_f:c,_l:d,_strict:e,_isUTC:!1})},bb.utc=function(b,c,d,e){var f;return"boolean"==typeof d&&(e=d,d=a),f=Y({_useUTC:!0,_isUTC:!0,_l:d,_i:b,_f:c,_strict:e}).utc()},bb.unix=function(a){return bb(1e3*a)},bb.duration=function(a,b){var c,d,e,g=bb.isDuration(a),h="number"==typeof a,i=g?a._input:h?{}:a,j=null;return h?b?i[b]=a:i.milliseconds=a:(j=pb.exec(a))?(c="-"===j[1]?-1:1,i={y:0,d:q(j[hb])*c,h:q(j[ib])*c,m:q(j[jb])*c,s:q(j[kb])*c,ms:q(j[lb])*c}):(j=qb.exec(a))&&(c="-"===j[1]?-1:1,e=function(a){var b=a&&parseFloat(a.replace(",","."));return(isNaN(b)?0:b)*c},i={y:e(j[2]),M:e(j[3]),d:e(j[4]),h:e(j[5]),m:e(j[6]),s:e(j[7]),w:e(j[8])}),d=new f(i),g&&a.hasOwnProperty("_lang")&&(d._lang=a._lang),d},bb.version=db,bb.defaultFormat=Db,bb.updateOffset=function(){},bb.lang=function(a,b){var c;return a?(b?y(x(a),b):null===b?(z(a),a="en"):mb[a]||A(a),c=bb.duration.fn._lang=bb.fn._lang=A(a),c._abbr):bb.fn._lang._abbr},bb.langData=function(a){return a&&a._lang&&a._lang._abbr&&(a=a._lang._abbr),A(a)},bb.isMoment=function(a){return a instanceof e},bb.isDuration=function(a){return a instanceof f},cb=Pb.length-1;cb>=0;--cb)p(Pb[cb]);for(bb.normalizeUnits=function(a){return n(a)},bb.invalid=function(a){var b=bb.utc(0/0);return null!=a?g(b._pf,a):b._pf.userInvalidated=!0,b},bb.parseZone=function(a){return bb(a).parseZone()},g(bb.fn=e.prototype,{clone:function(){return bb(this)},valueOf:function(){return+this._d+6e4*(this._offset||0)},unix:function(){return Math.floor(+this/1e3)},toString:function(){return this.clone().lang("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")},toDate:function(){return this._offset?new Date(+this):this._d},toISOString:function(){return D(bb(this).utc(),"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]")},toArray:function(){var a=this;return[a.year(),a.month(),a.date(),a.hours(),a.minutes(),a.seconds(),a.milliseconds()]},isValid:function(){return w(this)},isDSTShifted:function(){return this._a?this.isValid()&&m(this._a,(this._isUTC?bb.utc(this._a):bb(this._a)).toArray())>0:!1},parsingFlags:function(){return g({},this._pf)},invalidAt:function(){return this._pf.overflow},utc:function(){return this.zone(0)},local:function(){return this.zone(0),this._isUTC=!1,this},format:function(a){var b=D(this,a||bb.defaultFormat);return this.lang().postformat(b)},add:function(a,b){var c;return c="string"==typeof a?bb.duration(+b,a):bb.duration(a,b),j(this,c,1),this},subtract:function(a,b){var c;return c="string"==typeof a?bb.duration(+b,a):bb.duration(a,b),j(this,c,-1),this},diff:function(a,b,c){var d,e,f=this._isUTC?bb(a).zone(this._offset||0):bb(a).local(),g=6e4*(this.zone()-f.zone());return b=n(b),"year"===b||"month"===b?(d=432e5*(this.daysInMonth()+f.daysInMonth()),e=12*(this.year()-f.year())+(this.month()-f.month()),e+=(this-bb(this).startOf("month")-(f-bb(f).startOf("month")))/d,e-=6e4*(this.zone()-bb(this).startOf("month").zone()-(f.zone()-bb(f).startOf("month").zone()))/d,"year"===b&&(e/=12)):(d=this-f,e="second"===b?d/1e3:"minute"===b?d/6e4:"hour"===b?d/36e5:"day"===b?(d-g)/864e5:"week"===b?(d-g)/6048e5:d),c?e:h(e)},from:function(a,b){return bb.duration(this.diff(a)).lang(this.lang()._abbr).humanize(!b)},fromNow:function(a){return this.from(bb(),a)},calendar:function(){var a=this.diff(bb().zone(this.zone()).startOf("day"),"days",!0),b=-6>a?"sameElse":-1>a?"lastWeek":0>a?"lastDay":1>a?"sameDay":2>a?"nextDay":7>a?"nextWeek":"sameElse";return this.format(this.lang().calendar(b,this))},isLeapYear:function(){return t(this.year())},isDST:function(){return this.zone()<this.clone().month(0).zone()||this.zone()<this.clone().month(5).zone()},day:function(a){var b=this._isUTC?this._d.getUTCDay():this._d.getDay();return null!=a?(a=T(a,this.lang()),this.add({d:a-b})):b},month:function(a){var b,c=this._isUTC?"UTC":"";return null!=a?"string"==typeof a&&(a=this.lang().monthsParse(a),"number"!=typeof a)?this:(b=this.date(),this.date(1),this._d["set"+c+"Month"](a),this.date(Math.min(b,this.daysInMonth())),bb.updateOffset(this),this):this._d["get"+c+"Month"]()},startOf:function(a){switch(a=n(a)){case"year":this.month(0);case"month":this.date(1);case"week":case"isoWeek":case"day":this.hours(0);case"hour":this.minutes(0);case"minute":this.seconds(0);case"second":this.milliseconds(0)}return"week"===a?this.weekday(0):"isoWeek"===a&&this.isoWeekday(1),this},endOf:function(a){return a=n(a),this.startOf(a).add("isoWeek"===a?"week":a,1).subtract("ms",1)},isAfter:function(a,b){return b="undefined"!=typeof b?b:"millisecond",+this.clone().startOf(b)>+bb(a).startOf(b)},isBefore:function(a,b){return b="undefined"!=typeof b?b:"millisecond",+this.clone().startOf(b)<+bb(a).startOf(b)},isSame:function(a,b){return b="undefined"!=typeof b?b:"millisecond",+this.clone().startOf(b)===+bb(a).startOf(b)},min:function(a){return a=bb.apply(null,arguments),this>a?this:a},max:function(a){return a=bb.apply(null,arguments),a>this?this:a},zone:function(a){var b=this._offset||0;return null==a?this._isUTC?b:this._d.getTimezoneOffset():("string"==typeof a&&(a=G(a)),Math.abs(a)<16&&(a=60*a),this._offset=a,this._isUTC=!0,b!==a&&j(this,bb.duration(b-a,"m"),1,!0),this)},zoneAbbr:function(){return this._isUTC?"UTC":""},zoneName:function(){return this._isUTC?"Coordinated Universal Time":""},parseZone:function(){return"string"==typeof this._i&&this.zone(this._i),this},hasAlignedHourOffset:function(a){return a=a?bb(a).zone():0,0===(this.zone()-a)%60},daysInMonth:function(){return r(this.year(),this.month())},dayOfYear:function(a){var b=eb((bb(this).startOf("day")-bb(this).startOf("year"))/864e5)+1;return null==a?b:this.add("d",a-b)},weekYear:function(a){var b=W(this,this.lang()._week.dow,this.lang()._week.doy).year;return null==a?b:this.add("y",a-b)},isoWeekYear:function(a){var b=W(this,1,4).year;return null==a?b:this.add("y",a-b)},week:function(a){var b=this.lang().week(this);return null==a?b:this.add("d",7*(a-b))},isoWeek:function(a){var b=W(this,1,4).week;return null==a?b:this.add("d",7*(a-b))},weekday:function(a){var b=(this.day()+7-this.lang()._week.dow)%7;return null==a?b:this.add("d",a-b)},isoWeekday:function(a){return null==a?this.day()||7:this.day(this.day()%7?a:a-7)},get:function(a){return a=n(a),this[a]()},set:function(a,b){return a=n(a),"function"==typeof this[a]&&this[a](b),this},lang:function(b){return b===a?this._lang:(this._lang=A(b),this)}}),cb=0;cb<Hb.length;cb++)Z(Hb[cb].toLowerCase().replace(/s$/,""),Hb[cb]);Z("year","FullYear"),bb.fn.days=bb.fn.day,bb.fn.months=bb.fn.month,bb.fn.weeks=bb.fn.week,bb.fn.isoWeeks=bb.fn.isoWeek,bb.fn.toJSON=bb.fn.toISOString,g(bb.duration.fn=f.prototype,{_bubble:function(){var a,b,c,d,e=this._milliseconds,f=this._days,g=this._months,i=this._data;i.milliseconds=e%1e3,a=h(e/1e3),i.seconds=a%60,b=h(a/60),i.minutes=b%60,c=h(b/60),i.hours=c%24,f+=h(c/24),i.days=f%30,g+=h(f/30),i.months=g%12,d=h(g/12),i.years=d},weeks:function(){return h(this.days()/7)},valueOf:function(){return this._milliseconds+864e5*this._days+2592e6*(this._months%12)+31536e6*q(this._months/12)},humanize:function(a){var b=+this,c=V(b,!a,this.lang());return a&&(c=this.lang().pastFuture(b,c)),this.lang().postformat(c)},add:function(a,b){var c=bb.duration(a,b);return this._milliseconds+=c._milliseconds,this._days+=c._days,this._months+=c._months,this._bubble(),this},subtract:function(a,b){var c=bb.duration(a,b);return this._milliseconds-=c._milliseconds,this._days-=c._days,this._months-=c._months,this._bubble(),this},get:function(a){return a=n(a),this[a.toLowerCase()+"s"]()},as:function(a){return a=n(a),this["as"+a.charAt(0).toUpperCase()+a.slice(1)+"s"]()},lang:bb.fn.lang,toIsoString:function(){var a=Math.abs(this.years()),b=Math.abs(this.months()),c=Math.abs(this.days()),d=Math.abs(this.hours()),e=Math.abs(this.minutes()),f=Math.abs(this.seconds()+this.milliseconds()/1e3);return this.asSeconds()?(this.asSeconds()<0?"-":"")+"P"+(a?a+"Y":"")+(b?b+"M":"")+(c?c+"D":"")+(d||e||f?"T":"")+(d?d+"H":"")+(e?e+"M":"")+(f?f+"S":""):"P0D"}});for(cb in Ib)Ib.hasOwnProperty(cb)&&(_(cb,Ib[cb]),$(cb.toLowerCase()));_("Weeks",6048e5),bb.duration.fn.asMonths=function(){return(+this-31536e6*this.years())/2592e6+12*this.years()},bb.lang("en",{ordinal:function(a){var b=a%10,c=1===q(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th";return a+c}}),nb?(module.exports=bb,ab()):"function"==typeof define&&define.amd?define("moment",function(a,b,c){return c.config().noGlobal!==!0&&ab(),bb}):ab()}).call(this);
/* NProgress, (c) 2013, 2014 Rico Sta. Cruz - http://ricostacruz.com/nprogress
 * @license MIT */


;(function(root, factory) {

  if (typeof define === 'function' && define.amd) {
    define(factory);
  } else if (typeof exports === 'object') {
    module.exports = factory();
  } else {
    root.NProgress = factory();
  }

})(this, function() {
  var NProgress = {};

  NProgress.version = '0.1.6';

  var Settings = NProgress.settings = {
    minimum: 0.08,
    easing: 'ease',
    positionUsing: '',
    speed: 200,
    trickle: true,
    trickleRate: 0.02,
    trickleSpeed: 800,
    showSpinner: true,
    barSelector: '[role="bar"]',
    spinnerSelector: '[role="spinner"]',
    parent: 'body',
    template: '<div class="bar" role="bar"><div class="peg"></div></div><div class="spinner" role="spinner"><div class="spinner-icon"></div></div>'
  };

  /**
   * Updates configuration.
   *
   *     NProgress.configure({
   *       minimum: 0.1
   *     });
   */
  NProgress.configure = function(options) {
    var key, value;
    for (key in options) {
      value = options[key];
      if (value !== undefined && options.hasOwnProperty(key)) Settings[key] = value;
    }

    return this;
  };

  /**
   * Last number.
   */

  NProgress.status = null;

  /**
   * Sets the progress bar status, where `n` is a number from `0.0` to `1.0`.
   *
   *     NProgress.set(0.4);
   *     NProgress.set(1.0);
   */

  NProgress.set = function(n) {
    var started = NProgress.isStarted();

    n = clamp(n, Settings.minimum, 1);
    NProgress.status = (n === 1 ? null : n);

    var progress = NProgress.render(!started),
        bar      = progress.querySelector(Settings.barSelector),
        speed    = Settings.speed,
        ease     = Settings.easing;

    progress.offsetWidth; /* Repaint */

    queue(function(next) {
      // Set positionUsing if it hasn't already been set
      if (Settings.positionUsing === '') Settings.positionUsing = NProgress.getPositioningCSS();

      // Add transition
      css(bar, barPositionCSS(n, speed, ease));

      if (n === 1) {
        // Fade out
        css(progress, { 
          transition: 'none', 
          opacity: 1 
        });
        progress.offsetWidth; /* Repaint */

        setTimeout(function() {
          css(progress, { 
            transition: 'all ' + speed + 'ms linear', 
            opacity: 0 
          });
          setTimeout(function() {
            NProgress.remove();
            next();
          }, speed);
        }, speed);
      } else {
        setTimeout(next, speed);
      }
    });

    return this;
  };

  NProgress.isStarted = function() {
    return typeof NProgress.status === 'number';
  };

  /**
   * Shows the progress bar.
   * This is the same as setting the status to 0%, except that it doesn't go backwards.
   *
   *     NProgress.start();
   *
   */
  NProgress.start = function() {
    if (!NProgress.status) NProgress.set(0);

    var work = function() {
      setTimeout(function() {
        if (!NProgress.status) return;
        NProgress.trickle();
        work();
      }, Settings.trickleSpeed);
    };

    if (Settings.trickle) work();

    return this;
  };

  /**
   * Hides the progress bar.
   * This is the *sort of* the same as setting the status to 100%, with the
   * difference being `done()` makes some placebo effect of some realistic motion.
   *
   *     NProgress.done();
   *
   * If `true` is passed, it will show the progress bar even if its hidden.
   *
   *     NProgress.done(true);
   */

  NProgress.done = function(force) {
    if (!force && !NProgress.status) return this;

    return NProgress.inc(0.3 + 0.5 * Math.random()).set(1);
  };

  /**
   * Increments by a random amount.
   */

  NProgress.inc = function(amount) {
    var n = NProgress.status;

    if (!n) {
      return NProgress.start();
    } else {
      if (typeof amount !== 'number') {
        amount = (1 - n) * clamp(Math.random() * n, 0.1, 0.95);
      }

      n = clamp(n + amount, 0, 0.994);
      return NProgress.set(n);
    }
  };

  NProgress.trickle = function() {
    return NProgress.inc(Math.random() * Settings.trickleRate);
  };

  /**
   * Waits for all supplied jQuery promises and
   * increases the progress as the promises resolve.
   * 
   * @param $promise jQUery Promise
   */
  (function() {
    var initial = 0, current = 0;
    
    NProgress.promise = function($promise) {
      if (!$promise || $promise.state() == "resolved") {
        return this;
      }
      
      if (current == 0) {
        NProgress.start();
      }
      
      initial++;
      current++;
      
      $promise.always(function() {
        current--;
        if (current == 0) {
            initial = 0;
            NProgress.done();
        } else {
            NProgress.set((initial - current) / initial);
        }
      });
      
      return this;
    };
    
  })();

  /**
   * (Internal) renders the progress bar markup based on the `template`
   * setting.
   */

  NProgress.render = function(fromStart) {
    if (NProgress.isRendered()) return document.getElementById('nprogress');

    addClass(document.documentElement, 'nprogress-busy');
    
    var progress = document.createElement('div');
    progress.id = 'nprogress';
    progress.innerHTML = Settings.template;

    var bar      = progress.querySelector(Settings.barSelector),
        perc     = fromStart ? '-100' : toBarPerc(NProgress.status || 0),
        parent   = document.querySelector(Settings.parent),
        spinner;
    
    css(bar, {
      transition: 'all 0 linear',
      transform: 'translate3d(' + perc + '%,0,0)'
    });

    if (!Settings.showSpinner) {
      spinner = progress.querySelector(Settings.spinnerSelector);
      spinner && removeElement(spinner);
    }

    if (parent != document.body) {
      addClass(parent, 'nprogress-custom-parent');
    }

    parent.appendChild(progress);
    return progress;
  };

  /**
   * Removes the element. Opposite of render().
   */

  NProgress.remove = function() {
    removeClass(document.documentElement, 'nprogress-busy');
    removeClass(document.querySelector(Settings.parent), 'nprogress-custom-parent')
    var progress = document.getElementById('nprogress');
    progress && removeElement(progress);
  };

  /**
   * Checks if the progress bar is rendered.
   */

  NProgress.isRendered = function() {
    return !!document.getElementById('nprogress');
  };

  /**
   * Determine which positioning CSS rule to use.
   */

  NProgress.getPositioningCSS = function() {
    // Sniff on document.body.style
    var bodyStyle = document.body.style;

    // Sniff prefixes
    var vendorPrefix = ('WebkitTransform' in bodyStyle) ? 'Webkit' :
                       ('MozTransform' in bodyStyle) ? 'Moz' :
                       ('msTransform' in bodyStyle) ? 'ms' :
                       ('OTransform' in bodyStyle) ? 'O' : '';

    if (vendorPrefix + 'Perspective' in bodyStyle) {
      // Modern browsers with 3D support, e.g. Webkit, IE10
      return 'translate3d';
    } else if (vendorPrefix + 'Transform' in bodyStyle) {
      // Browsers without 3D support, e.g. IE9
      return 'translate';
    } else {
      // Browsers without translate() support, e.g. IE7-8
      return 'margin';
    }
  };

  /**
   * Helpers
   */

  function clamp(n, min, max) {
    if (n < min) return min;
    if (n > max) return max;
    return n;
  }

  /**
   * (Internal) converts a percentage (`0..1`) to a bar translateX
   * percentage (`-100%..0%`).
   */

  function toBarPerc(n) {
    return (-1 + n) * 100;
  }


  /**
   * (Internal) returns the correct CSS for changing the bar's
   * position given an n percentage, and speed and ease from Settings
   */

  function barPositionCSS(n, speed, ease) {
    var barCSS;

    if (Settings.positionUsing === 'translate3d') {
      barCSS = { transform: 'translate3d('+toBarPerc(n)+'%,0,0)' };
    } else if (Settings.positionUsing === 'translate') {
      barCSS = { transform: 'translate('+toBarPerc(n)+'%,0)' };
    } else {
      barCSS = { 'margin-left': toBarPerc(n)+'%' };
    }

    barCSS.transition = 'all '+speed+'ms '+ease;

    return barCSS;
  }

  /**
   * (Internal) Queues a function to be executed.
   */

  var queue = (function() {
    var pending = [];
    
    function next() {
      var fn = pending.shift();
      if (fn) {
        fn(next);
      }
    }

    return function(fn) {
      pending.push(fn);
      if (pending.length == 1) next();
    };
  })();

  /**
   * (Internal) Applies css properties to an element, similar to the jQuery 
   * css method.
   *
   * While this helper does assist with vendor prefixed property names, it 
   * does not perform any manipulation of values prior to setting styles.
   */

  var css = (function() {
    var cssPrefixes = [ 'Webkit', 'O', 'Moz', 'ms' ],
        cssProps    = {};

    function camelCase(string) {
      return string.replace(/^-ms-/, 'ms-').replace(/-([\da-z])/gi, function(match, letter) {
        return letter.toUpperCase();
      });
    }

    function getVendorProp(name) {
      var style = document.body.style;
      if (name in style) return name;

      var i = cssPrefixes.length,
          capName = name.charAt(0).toUpperCase() + name.slice(1),
          vendorName;
      while (i--) {
        vendorName = cssPrefixes[i] + capName;
        if (vendorName in style) return vendorName;
      }

      return name;
    }

    function getStyleProp(name) {
      name = camelCase(name);
      return cssProps[name] || (cssProps[name] = getVendorProp(name));
    }

    function applyCss(element, prop, value) {
      prop = getStyleProp(prop);
      element.style[prop] = value;
    }

    return function(element, properties) {
      var args = arguments,
          prop, 
          value;

      if (args.length == 2) {
        for (prop in properties) {
          value = properties[prop];
          if (value !== undefined && properties.hasOwnProperty(prop)) applyCss(element, prop, value);
        }
      } else {
        applyCss(element, args[1], args[2]);
      }
    }
  })();

  /**
   * (Internal) Determines if an element or space separated list of class names contains a class name.
   */

  function hasClass(element, name) {
    var list = typeof element == 'string' ? element : classList(element);
    return list.indexOf(' ' + name + ' ') >= 0;
  }

  /**
   * (Internal) Adds a class to an element.
   */

  function addClass(element, name) {
    var oldList = classList(element),
        newList = oldList + name;

    if (hasClass(oldList, name)) return; 

    // Trim the opening space.
    element.className = newList.substring(1);
  }

  /**
   * (Internal) Removes a class from an element.
   */

  function removeClass(element, name) {
    var oldList = classList(element),
        newList;

    if (!hasClass(element, name)) return;

    // Replace the class name.
    newList = oldList.replace(' ' + name + ' ', ' ');

    // Trim the opening and closing spaces.
    element.className = newList.substring(1, newList.length - 1);
  }

  /**
   * (Internal) Gets a space separated list of the class names on the element. 
   * The list is wrapped with a single space on each end to facilitate finding 
   * matches within the list.
   */

  function classList(element) {
    return (' ' + (element.className || '') + ' ').replace(/\s+/gi, ' ');
  }

  /**
   * (Internal) Removes an element from the DOM.
   */

  function removeElement(element) {
    element && element.parentNode && element.parentNode.removeChild(element);
  }

  return NProgress;
});

/*!
 * numeral.js
 * version : 1.5.2
 * author : Adam Draper
 * license : MIT
 * http://adamwdraper.github.com/Numeral-js/
 */


(function () {

    /************************************
        Constants
    ************************************/

    var numeral,
        VERSION = '1.5.2',
        // internal storage for language config files
        languages = {},
        currentLanguage = 'en',
        zeroFormat = null,
        defaultFormat = '0,0',
        // check for nodeJS
        hasModule = (typeof module !== 'undefined' && module.exports);


    /************************************
        Constructors
    ************************************/


    // Numeral prototype object
    function Numeral (number) {
        this._value = number;
    }

    /**
     * Implementation of toFixed() that treats floats more like decimals
     *
     * Fixes binary rounding issues (eg. (0.615).toFixed(2) === '0.61') that present
     * problems for accounting- and finance-related software.
     */
    function toFixed (value, precision, roundingFunction, optionals) {
        var power = Math.pow(10, precision),
            optionalsRegExp,
            output;
            
        //roundingFunction = (roundingFunction !== undefined ? roundingFunction : Math.round);
        // Multiply up by precision, round accurately, then divide and use native toFixed():
        output = (roundingFunction(value * power) / power).toFixed(precision);

        if (optionals) {
            optionalsRegExp = new RegExp('0{1,' + optionals + '}$');
            output = output.replace(optionalsRegExp, '');
        }

        return output.toString();
    }

    /************************************
        Formatting
    ************************************/

    // determine what type of formatting we need to do
    function formatNumeral (n, format, roundingFunction) {
        var output;

        // figure out what kind of format we are dealing with
        if (format.indexOf('$') > -1) { // currency!!!!!
            output = formatCurrency(n, format, roundingFunction);
        } else if (format.indexOf('%') > -1) { // percentage
            output = formatPercentage(n, format, roundingFunction);
        } else if (format.indexOf(':') > -1) { // time
            output = formatTime(n, format);
        } else { // plain ol' numbers or bytes
            output = formatNumber(n._value, format, roundingFunction);
        }

        // return string
        return output;
    }

    // revert to number
    function unformatNumeral (n, string) {
        var stringOriginal = string,
            thousandRegExp,
            millionRegExp,
            billionRegExp,
            trillionRegExp,
            suffixes = ['KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'],
            bytesMultiplier = false,
            power;

        if (string.indexOf(':') > -1) {
            n._value = unformatTime(string);
        } else {
            if (string === zeroFormat) {
                n._value = 0;
            } else {
                if (languages[currentLanguage].delimiters.decimal !== '.') {
                    string = string.replace(/\./g,'').replace(languages[currentLanguage].delimiters.decimal, '.');
                }

                // see if abbreviations are there so that we can multiply to the correct number
                thousandRegExp = new RegExp('[^a-zA-Z]' + languages[currentLanguage].abbreviations.thousand + '(?:\\)|(\\' + languages[currentLanguage].currency.symbol + ')?(?:\\))?)?$');
                millionRegExp = new RegExp('[^a-zA-Z]' + languages[currentLanguage].abbreviations.million + '(?:\\)|(\\' + languages[currentLanguage].currency.symbol + ')?(?:\\))?)?$');
                billionRegExp = new RegExp('[^a-zA-Z]' + languages[currentLanguage].abbreviations.billion + '(?:\\)|(\\' + languages[currentLanguage].currency.symbol + ')?(?:\\))?)?$');
                trillionRegExp = new RegExp('[^a-zA-Z]' + languages[currentLanguage].abbreviations.trillion + '(?:\\)|(\\' + languages[currentLanguage].currency.symbol + ')?(?:\\))?)?$');

                // see if bytes are there so that we can multiply to the correct number
                for (power = 0; power <= suffixes.length; power++) {
                    bytesMultiplier = (string.indexOf(suffixes[power]) > -1) ? Math.pow(1024, power + 1) : false;

                    if (bytesMultiplier) {
                        break;
                    }
                }

                // do some math to create our number
                n._value = ((bytesMultiplier) ? bytesMultiplier : 1) * ((stringOriginal.match(thousandRegExp)) ? Math.pow(10, 3) : 1) * ((stringOriginal.match(millionRegExp)) ? Math.pow(10, 6) : 1) * ((stringOriginal.match(billionRegExp)) ? Math.pow(10, 9) : 1) * ((stringOriginal.match(trillionRegExp)) ? Math.pow(10, 12) : 1) * ((string.indexOf('%') > -1) ? 0.01 : 1) * (((string.split('-').length + Math.min(string.split('(').length-1, string.split(')').length-1)) % 2)? 1: -1) * Number(string.replace(/[^0-9\.]+/g, ''));

                // round if we are talking about bytes
                n._value = (bytesMultiplier) ? Math.ceil(n._value) : n._value;
            }
        }
        return n._value;
    }

    function formatCurrency (n, format, roundingFunction) {
        var prependSymbol = format.indexOf('$') <= 1 ? true : false,
            space = '',
            output;

        // check for space before or after currency
        if (format.indexOf(' $') > -1) {
            space = ' ';
            format = format.replace(' $', '');
        } else if (format.indexOf('$ ') > -1) {
            space = ' ';
            format = format.replace('$ ', '');
        } else {
            format = format.replace('$', '');
        }

        // format the number
        output = formatNumber(n._value, format, roundingFunction);

        // position the symbol
        if (prependSymbol) {
            if (output.indexOf('(') > -1 || output.indexOf('-') > -1) {
                output = output.split('');
                output.splice(1, 0, languages[currentLanguage].currency.symbol + space);
                output = output.join('');
            } else {
                output = languages[currentLanguage].currency.symbol + space + output;
            }
        } else {
            if (output.indexOf(')') > -1) {
                output = output.split('');
                output.splice(-1, 0, space + languages[currentLanguage].currency.symbol);
                output = output.join('');
            } else {
                output = output + space + languages[currentLanguage].currency.symbol;
            }
        }

        return output;
    }

    function formatPercentage (n, format, roundingFunction) {
        var space = '',
            output,
            value = n._value * 100;

        // check for space before %
        if (format.indexOf(' %') > -1) {
            space = ' ';
            format = format.replace(' %', '');
        } else {
            format = format.replace('%', '');
        }

        output = formatNumber(value, format, roundingFunction);
        
        if (output.indexOf(')') > -1 ) {
            output = output.split('');
            output.splice(-1, 0, space + '%');
            output = output.join('');
        } else {
            output = output + space + '%';
        }

        return output;
    }

    function formatTime (n) {
        var hours = Math.floor(n._value/60/60),
            minutes = Math.floor((n._value - (hours * 60 * 60))/60),
            seconds = Math.round(n._value - (hours * 60 * 60) - (minutes * 60));
        return hours + ':' + ((minutes < 10) ? '0' + minutes : minutes) + ':' + ((seconds < 10) ? '0' + seconds : seconds);
    }

    function unformatTime (string) {
        var timeArray = string.split(':'),
            seconds = 0;
        // turn hours and minutes into seconds and add them all up
        if (timeArray.length === 3) {
            // hours
            seconds = seconds + (Number(timeArray[0]) * 60 * 60);
            // minutes
            seconds = seconds + (Number(timeArray[1]) * 60);
            // seconds
            seconds = seconds + Number(timeArray[2]);
        } else if (timeArray.length === 2) {
            // minutes
            seconds = seconds + (Number(timeArray[0]) * 60);
            // seconds
            seconds = seconds + Number(timeArray[1]);
        }
        return Number(seconds);
    }

    function formatNumber (value, format, roundingFunction) {
        var negP = false,
            signed = false,
            optDec = false,
            abbr = '',
            bytes = '',
            ord = '',
            abs = Math.abs(value),
            suffixes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'],
            min,
            max,
            power,
            w,
            precision,
            thousands,
            d = '',
            neg = false;

        // check if number is zero and a custom zero format has been set
        if (value === 0 && zeroFormat !== null) {
            return zeroFormat;
        } else {
            // see if we should use parentheses for negative number or if we should prefix with a sign
            // if both are present we default to parentheses
            if (format.indexOf('(') > -1) {
                negP = true;
                format = format.slice(1, -1);
            } else if (format.indexOf('+') > -1) {
                signed = true;
                format = format.replace(/\+/g, '');
            }

            // see if abbreviation is wanted
            if (format.indexOf('a') > -1) {
                // check for space before abbreviation
                if (format.indexOf(' a') > -1) {
                    abbr = ' ';
                    format = format.replace(' a', '');
                } else {
                    format = format.replace('a', '');
                }

                if (abs >= Math.pow(10, 12)) {
                    // trillion
                    abbr = abbr + languages[currentLanguage].abbreviations.trillion;
                    value = value / Math.pow(10, 12);
                } else if (abs < Math.pow(10, 12) && abs >= Math.pow(10, 9)) {
                    // billion
                    abbr = abbr + languages[currentLanguage].abbreviations.billion;
                    value = value / Math.pow(10, 9);
                } else if (abs < Math.pow(10, 9) && abs >= Math.pow(10, 6)) {
                    // million
                    abbr = abbr + languages[currentLanguage].abbreviations.million;
                    value = value / Math.pow(10, 6);
                } else if (abs < Math.pow(10, 6) && abs >= Math.pow(10, 3)) {
                    // thousand
                    abbr = abbr + languages[currentLanguage].abbreviations.thousand;
                    value = value / Math.pow(10, 3);
                }
            }

            // see if we are formatting bytes
            if (format.indexOf('b') > -1) {
                // check for space before
                if (format.indexOf(' b') > -1) {
                    bytes = ' ';
                    format = format.replace(' b', '');
                } else {
                    format = format.replace('b', '');
                }

                for (power = 0; power <= suffixes.length; power++) {
                    min = Math.pow(1024, power);
                    max = Math.pow(1024, power+1);

                    if (value >= min && value < max) {
                        bytes = bytes + suffixes[power];
                        if (min > 0) {
                            value = value / min;
                        }
                        break;
                    }
                }
            }

            // see if ordinal is wanted
            if (format.indexOf('o') > -1) {
                // check for space before
                if (format.indexOf(' o') > -1) {
                    ord = ' ';
                    format = format.replace(' o', '');
                } else {
                    format = format.replace('o', '');
                }

                ord = ord + languages[currentLanguage].ordinal(value);
            }

            if (format.indexOf('[.]') > -1) {
                optDec = true;
                format = format.replace('[.]', '.');
            }

            w = value.toString().split('.')[0];
            precision = format.split('.')[1];
            thousands = format.indexOf(',');

            if (precision) {
                if (precision.indexOf('[') > -1) {
                    precision = precision.replace(']', '');
                    precision = precision.split('[');
                    d = toFixed(value, (precision[0].length + precision[1].length), roundingFunction, precision[1].length);
                } else {
                    d = toFixed(value, precision.length, roundingFunction);
                }

                w = d.split('.')[0];

                if (d.split('.')[1].length) {
                    d = languages[currentLanguage].delimiters.decimal + d.split('.')[1];
                } else {
                    d = '';
                }

                if (optDec && Number(d.slice(1)) === 0) {
                    d = '';
                }
            } else {
                w = toFixed(value, null, roundingFunction);
            }

            // format number
            if (w.indexOf('-') > -1) {
                w = w.slice(1);
                neg = true;
            }

            if (thousands > -1) {
                w = w.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1' + languages[currentLanguage].delimiters.thousands);
            }

            if (format.indexOf('.') === 0) {
                w = '';
            }

            return ((negP && neg) ? '(' : '') + ((!negP && neg) ? '-' : '') + ((!neg && signed) ? '+' : '') + w + d + ((ord) ? ord : '') + ((abbr) ? abbr : '') + ((bytes) ? bytes : '') + ((negP && neg) ? ')' : '');
        }
    }

    /************************************
        Top Level Functions
    ************************************/

    numeral = function (input) {
        if (numeral.isNumeral(input)) {
            input = input.value();
        } else if (input === 0 || typeof input === 'undefined') {
            input = 0;
        } else if (!Number(input)) {
            input = numeral.fn.unformat(input);
        }

        return new Numeral(Number(input));
    };

    // version number
    numeral.version = VERSION;

    // compare numeral object
    numeral.isNumeral = function (obj) {
        return obj instanceof Numeral;
    };

    // This function will load languages and then set the global language.  If
    // no arguments are passed in, it will simply return the current global
    // language key.
    numeral.language = function (key, values) {
        if (!key) {
            return currentLanguage;
        }

        if (key && !values) {
            if(!languages[key]) {
                throw new Error('Unknown language : ' + key);
            }
            currentLanguage = key;
        }

        if (values || !languages[key]) {
            loadLanguage(key, values);
        }

        return numeral;
    };
    
    // This function provides access to the loaded language data.  If
    // no arguments are passed in, it will simply return the current
    // global language object.
    numeral.languageData = function (key) {
        if (!key) {
            return languages[currentLanguage];
        }
        
        if (!languages[key]) {
            throw new Error('Unknown language : ' + key);
        }
        
        return languages[key];
    };

    numeral.language('en', {
        delimiters: {
            thousands: ',',
            decimal: '.'
        },
        abbreviations: {
            thousand: 'k',
            million: 'm',
            billion: 'b',
            trillion: 't'
        },
        ordinal: function (number) {
            var b = number % 10;
            return (~~ (number % 100 / 10) === 1) ? 'th' :
                (b === 1) ? 'st' :
                (b === 2) ? 'nd' :
                (b === 3) ? 'rd' : 'th';
        },
        currency: {
            symbol: '$'
        }
    });

    numeral.zeroFormat = function (format) {
        zeroFormat = typeof(format) === 'string' ? format : null;
    };

    numeral.defaultFormat = function (format) {
        defaultFormat = typeof(format) === 'string' ? format : '0.0';
    };

    /************************************
        Helpers
    ************************************/

    function loadLanguage(key, values) {
        languages[key] = values;
    }


    /************************************
        Numeral Prototype
    ************************************/


    numeral.fn = Numeral.prototype = {

        clone : function () {
            return numeral(this);
        },

        format : function (inputString, roundingFunction) {
            return formatNumeral(this, 
                  inputString ? inputString : defaultFormat, 
                  (roundingFunction !== undefined) ? roundingFunction : Math.round
              );
        },

        unformat : function (inputString) {
            if (Object.prototype.toString.call(inputString) === '[object Number]') { 
                return inputString; 
            }
            return unformatNumeral(this, inputString ? inputString : defaultFormat);
        },

        value : function () {
            return this._value;
        },

        valueOf : function () {
            return this._value;
        },

        set : function (value) {
            this._value = Number(value);
            return this;
        },

        add : function (value) {
            this._value = this._value + Number(value);
            return this;
        },

        subtract : function (value) {
            this._value = this._value - Number(value);
            return this;
        },

        multiply : function (value) {
            this._value = this._value * Number(value);
            return this;
        },

        divide : function (value) {
            this._value = this._value / Number(value);
            return this;
        },

        difference : function (value) {
            var difference = this._value - Number(value);

            if (difference < 0) {
                difference = -difference;
            }

            return difference;
        }

    };

    /************************************
        Exposing Numeral
    ************************************/

    // CommonJS module is defined
    if (hasModule) {
        module.exports = numeral;
    }

    /*global ender:false */
    if (typeof ender === 'undefined') {
        // here, `this` means `window` in the browser, or `global` on the server
        // add `numeral` as a global object via a string identifier,
        // for Closure Compiler 'advanced' mode
        this['numeral'] = numeral;
    }

    /*global define:false */
    if (typeof define === 'function' && define.amd) {
        define([], function () {
            return numeral;
        });
    }
}).call(this);
(function (root, pluralize) {
  /* istanbul ignore else */
  if (typeof require === 'function' && typeof exports === 'object' && typeof module === 'object') {
    // Node.
    module.exports = pluralize();
  } else if (typeof define === 'function' && define.amd) {
    // AMD, registers as an anonymous module.
    define(function () {
      return pluralize();
    });
  } else {
    // Browser global.
    root.pluralize = pluralize();
  }
})(this, function () {
  // Rule storage - pluralize and singularize need to be run sequentially,
  // while other rules can be optimized using an object for instant lookups.
  var pluralRules      = [];
  var singularRules    = [];
  var uncountables     = {};
  var irregularPlurals = {};
  var irregularSingles = {};

  /**
   * Title case a string.
   *
   * @param  {string} str
   * @return {string}
   */
  function toTitleCase (str) {
    return str.charAt(0).toUpperCase() + str.substr(1).toLowerCase();
  }

  /**
   * Sanitize a pluralization rule to a usable regular expression.
   *
   * @param  {(RegExp|string)} rule
   * @return {RegExp}
   */
  function sanitizeRule (rule) {
    if (typeof rule === 'string') {
      return new RegExp('^' + rule + '$', 'i');
    }

    return rule;
  }

  /**
   * Pass in a word token to produce a function that can replicate the case on
   * another word.
   *
   * @param  {string}   word
   * @param  {string}   token
   * @return {Function}
   */
  function restoreCase (word, token) {
    // Upper cased words. E.g. "HELLO".
    if (word === word.toUpperCase()) {
      return token.toUpperCase();
    }

    // Title cased words. E.g. "Title".
    if (word[0] === word[0].toUpperCase()) {
      return toTitleCase(token);
    }

    // Lower cased words. E.g. "test".
    return token.toLowerCase();
  }

  /**
   * Interpolate a regexp string.
   *
   * @param  {[type]} str  [description]
   * @param  {[type]} args [description]
   * @return {[type]}      [description]
   */
  function interpolate (str, args) {
    return str.replace(/\$(\d{1,2})/g, function (match, index) {
      return args[index] || '';
    });
  }

  /**
   * Sanitize a word by passing in the word and sanitization rules.
   *
   * @param  {String}   word
   * @param  {Array}    collection
   * @return {String}
   */
  function sanitizeWord (word, collection) {
    // Empty string or doesn't need fixing.
    if (!word.length || uncountables.hasOwnProperty(word)) {
      return word;
    }

    var len = collection.length;

    // Iterate over the sanitization rules and use the first one to match.
    while (len--) {
      var rule = collection[len];

      // If the rule passes, return the replacement.
      if (rule[0].test(word)) {
        return word.replace(rule[0], function (match, index, word) {
          var result = interpolate(rule[1], arguments);

          if (match === '') {
            return restoreCase(word[index - 1], result);
          }

          return restoreCase(match, result);
        });
      }
    }

    return word;
  }

  /**
   * Replace a word with the updated word.
   *
   * @param  {Object}   replaceMap
   * @param  {Object}   keepMap
   * @param  {Array}    rules
   * @return {Function}
   */
  function replaceWord (replaceMap, keepMap, rules) {
    return function (word) {
      // Get the correct token and case restoration functions.
      var token = word.toLowerCase();

      // Check against the keep object map.
      if (keepMap.hasOwnProperty(token)) {
        return restoreCase(word, token);
      }

      // Check against the replacement map for a direct word replacement.
      if (replaceMap.hasOwnProperty(token)) {
        return restoreCase(word, replaceMap[token]);
      }

      // Run all the rules against the word.
      return sanitizeWord(word, rules);
    };
  }

  /**
   * Pluralize or singularize a word based on the passed in count.
   *
   * @param  {String}  word
   * @param  {Number}  count
   * @param  {Boolean} inclusive
   * @return {String}
   */
  function pluralize (word, count, inclusive) {
    var pluralized = count === 1 ?
      pluralize.singular(word) : pluralize.plural(word);

    return (inclusive ? count + ' ' : '') + pluralized;
  }

  /**
   * Pluralize a word.
   *
   * @type {Function}
   */
  pluralize.plural = replaceWord(
    irregularSingles, irregularPlurals, pluralRules
  );

  /**
   * Singularize a word.
   *
   * @type {Function}
   */
  pluralize.singular = replaceWord(
    irregularPlurals, irregularSingles, singularRules
  );

  /**
   * Add a pluralization rule to the collection.
   *
   * @param {(string|RegExp)} rule
   * @param {string}          replacement
   */
  pluralize.addPluralRule = function (rule, replacement) {
    pluralRules.push([sanitizeRule(rule), replacement]);
  };

  /**
   * Add a singularization rule to the collection.
   *
   * @param {(string|RegExp)} rule
   * @param {string}          replacement
   */
  pluralize.addSingularRule = function (rule, replacement) {
    singularRules.push([sanitizeRule(rule), replacement]);
  };

  /**
   * Add an uncountable word rule.
   *
   * @param {(string|RegExp)} word
   */
  pluralize.addUncountableRule = function (word) {
    if (typeof word === 'string') {
      return uncountables[word.toLowerCase()] = true;
    }

    // Set singular and plural references for the word.
    pluralize.addPluralRule(word, '$0');
    pluralize.addSingularRule(word, '$0');
  };

  /**
   * Add an irregular word definition.
   *
   * @param {String} single
   * @param {String} plural
   */
  pluralize.addIrregularRule = function (single, plural) {
    plural = plural.toLowerCase();
    single = single.toLowerCase();

    irregularSingles[single] = plural;
    irregularPlurals[plural] = single;
  };

  /**
   * Irregular rules.
   */
  [
    // Pronouns.
    ['I',        'we'],
    ['me',       'us'],
    ['he',       'they'],
    ['she',      'they'],
    ['them',     'them'],
    ['myself',   'ourselves'],
    ['yourself', 'yourselves'],
    ['itself',   'themselves'],
    ['herself',  'themselves'],
    ['himself',  'themselves'],
    ['themself', 'themselves'],
    ['this',     'these'],
    ['that',     'those'],
    // Words ending in with a consonant and `o`.
    ['echo', 'echoes'],
    ['dingo', 'dingoes'],
    ['volcano', 'volcanoes'],
    ['tornado', 'tornadoes'],
    ['torpedo', 'torpedoes'],
    // Ends with `us`.
    ['genus',  'genera'],
    ['viscus', 'viscera'],
    // Ends with `ma`.
    ['stigma',   'stigmata'],
    ['stoma',    'stomata'],
    ['dogma',    'dogmata'],
    ['lemma',    'lemmata'],
    ['schema',   'schemata'],
    ['anathema', 'anathemata'],
    // Other irregular rules.
    ['ox',      'oxen'],
    ['axe',     'axes'],
    ['die',     'dice'],
    ['yes',     'yeses'],
    ['foot',    'feet'],
    ['eave',    'eaves'],
    ['goose',   'geese'],
    ['tooth',   'teeth'],
    ['quiz',    'quizzes'],
    ['human',   'humans'],
    ['proof',   'proofs'],
    ['carve',   'carves'],
    ['valve',   'valves'],
    ['thief',   'thieves'],
    ['genie',   'genies'],
    ['groove',  'grooves'],
    ['pickaxe', 'pickaxes'],
    ['whiskey', 'whiskies']
  ].forEach(function (rule) {
    return pluralize.addIrregularRule(rule[0], rule[1]);
  });

  /**
   * Pluralization rules.
   */
  [
    [/s?$/i, 's'],
    [/([^aeiou]ese)$/i, '$1'],
    [/(ax|test)is$/i, '$1es'],
    [/(alias|[^aou]us|tlas|gas|ris)$/i, '$1es'],
    [/(e[mn]u)s?$/i, '$1s'],
    [/([^l]ias|[aeiou]las|[emjzr]as|[iu]am)$/i, '$1'],
    [/(alumn|syllab|octop|vir|radi|nucle|fung|cact|stimul|termin|bacill|foc|uter|loc|strat)(?:us|i)$/i, '$1i'],
    [/(alumn|alg|vertebr)(?:a|ae)$/i, '$1ae'],
    [/(seraph|cherub)(?:im)?$/i, '$1im'],
    [/(her|at|gr)o$/i, '$1oes'],
    [/(agend|addend|millenni|dat|extrem|bacteri|desiderat|strat|candelabr|errat|ov|symposi|curricul|automat|quor)(?:a|um)$/i, '$1a'],
    [/(apheli|hyperbat|periheli|asyndet|noumen|phenomen|criteri|organ|prolegomen|\w+hedr)(?:a|on)$/i, '$1a'],
    [/sis$/i, 'ses'],
    [/(?:(i)fe|(ar|l|ea|eo|oa|hoo)f)$/i, '$1$2ves'],
    [/([^aeiouy]|qu)y$/i, '$1ies'],
    [/([^ch][ieo][ln])ey$/i, '$1ies'],
    [/(x|ch|ss|sh|zz)$/i, '$1es'],
    [/(matr|cod|mur|sil|vert|ind|append)(?:ix|ex)$/i, '$1ices'],
    [/(m|l)(?:ice|ouse)$/i, '$1ice'],
    [/(pe)(?:rson|ople)$/i, '$1ople'],
    [/(child)(?:ren)?$/i, '$1ren'],
    [/eaux$/i, '$0'],
    [/m[ae]n$/i, 'men']
  ].forEach(function (rule) {
    return pluralize.addPluralRule(rule[0], rule[1]);
  });

  /**
   * Singularization rules.
   */
  [
    [/s$/i, ''],
    [/(ss)$/i, '$1'],
    [/((a)naly|(b)a|(d)iagno|(p)arenthe|(p)rogno|(s)ynop|(t)he)(?:sis|ses)$/i, '$1sis'],
    [/(^analy)(?:sis|ses)$/i, '$1sis'],
    [/([^aeflor])ves$/i, '$1fe'],
    [/(hive|tive|dr?ive)s$/i, '$1'],
    [/(ar|(?:wo|[ae])l|[eo][ao])ves$/i, '$1f'],
    [/([^aeiouy]|qu)ies$/i, '$1y'],
    [/(^[pl]|zomb|^(?:neck)?t|[aeo][lt]|cut)ies$/i, '$1ie'],
    [/([^c][eor]n|smil)ies$/i, '$1ey'],
    [/(m|l)ice$/i, '$1ouse'],
    [/(seraph|cherub)im$/i, '$1'],
    [/(x|ch|ss|sh|zz|tto|go|cho|alias|[^aou]us|tlas|gas|(?:her|at|gr)o|ris)(?:es)?$/i, '$1'],
    [/(e[mn]u)s?$/i, '$1'],
    [/(movie|twelve)s$/i, '$1'],
    [/(cris|test|diagnos)(?:is|es)$/i, '$1is'],
    [/(alumn|syllab|octop|vir|radi|nucle|fung|cact|stimul|termin|bacill|foc|uter|loc|strat)(?:us|i)$/i, '$1us'],
    [/(agend|addend|millenni|dat|extrem|bacteri|desiderat|strat|candelabr|errat|ov|symposi|curricul|automat|quor)a$/i, '$1um'],
    [/(apheli|hyperbat|periheli|asyndet|noumen|phenomen|criteri|organ|prolegomen|\w+hedr)a$/i, '$1on'],
    [/(alumn|alg|vertebr)ae$/i, '$1a'],
    [/(cod|mur|sil|vert|ind)ices$/i, '$1ex'],
    [/(matr|append)ices$/i, '$1ix'],
    [/(pe)(rson|ople)$/i, '$1rson'],
    [/(child)ren$/i, '$1'],
    [/(eau)x?$/i, '$1'],
    [/men$/i, 'man']
  ].forEach(function (rule) {
    return pluralize.addSingularRule(rule[0], rule[1]);
  });

  /**
   * Uncountable rules.
   */
  [
    // Singular words with no plurals.
    'advice',
    'agenda',
    'bison',
    'bream',
    'buffalo',
    'carp',
    'chassis',
    'cod',
    'cooperation',
    'corps',
    'digestion',
    'debris',
    'diabetes',
    'energy',
    'equipment',
    'elk',
    'excretion',
    'expertise',
    'flounder',
    'gallows',
    'graffiti',
    'headquarters',
    'health',
    'herpes',
    'highjinks',
    'homework',
    'information',
    'jeans',
    'justice',
    'kudos',
    'labour',
    'machinery',
    'mackerel',
    'media',
    'mews',
    'moose',
    'news',
    'pike',
    'plankton',
    'pliers',
    'pollution',
    'premises',
    'rain',
    'rice',
    'salmon',
    'scissors',
    'series',
    'sewage',
    'shambles',
    'shrimp',
    'species',
    'staff',
    'swine',
    'trout',
    'tuna',
    'whiting',
    'wildebeest',
    'wildlife',
    // Regexes.
    /pox$/i, // "chickpox", "smallpox"
    /ois$/i,
    /deer$/i, // "deer", "reindeer"
    /fish$/i, // "fish", "blowfish", "angelfish"
    /sheep$/i,
    /measles$/i,
    /[^aeiou]ese$/i // "chinese", "japanese"
  ].forEach(pluralize.addUncountableRule);

  return pluralize;
});
(function(factory) {
    'use strict';
    if (typeof define === 'function' && define.amd) {
        define([], function(){
            return factory(window, document);
        });
    } else if (typeof exports !== 'undefined') {
        module.exports = factory(window, document);
    } else {
        window.wysiwyg = factory(window, document);
    }
})(function(window, document){
    'use strict';

    // http://stackoverflow.com/questions/97962/debounce-clicks-when-submitting-a-web-form
    var debounce = function( callback, wait, cancelprevious )
    {
        var timeout;
        return function()
        {
            if( timeout )
            {
                if( ! cancelprevious )
                    return ;
                clearTimeout( timeout );
            }
            var context = this,
                args = arguments;
            timeout = setTimeout(
                function()
                {
                    timeout = null;
                    callback.apply( context, args );
                }, wait );
        };
    };

    // http://stackoverflow.com/questions/12949590/how-to-detach-event-in-ie-6-7-8-9-using-javascript
    var addEvent = function( element, type, handler, useCapture )
    {
        if( element.addEventListener ) {
            element.addEventListener( type, handler, useCapture ? true : false );
        }
        else if( element.attachEvent ) {
            element.attachEvent( 'on' + type, handler );
        }
        else if( element != window )
            element['on' + type] = handler;
    };
    var removeEvent = function( element, type, handler, useCapture )
    {
        if( element.removeEventListener ) {
            element.removeEventListener( type, handler, useCapture ? true : false );
        }
        else if( element.detachEvent) {
            element.detachEvent( 'on' + type, handler );
        }
        else if( element != window )
            element['on' + type] = null;
    };
    // http://www.cristinawithout.com/content/function-trigger-events-javascript
    var fireEvent = function( element, type, bubbles, cancelable )
    {
        if( document.createEvent ) {
            var event = document.createEvent('Event');
            event.initEvent( type, bubbles !== undefined ? bubbles : true, cancelable !== undefined ? cancelable : false );
            element.dispatchEvent(event);
        }
        else if( document.createEventObject ) { //IE
            var event = document.createEventObject();
            element.fireEvent( 'on' + type, event );
        }
        else if( typeof(element['on' + type]) == 'function' )
            element['on' + type]();
    };
    // prevent default
    var cancelEvent = function( e )
    {
        if( e.preventDefault )
            e.preventDefault();
        else
            e.returnValue = false;
        if( e.stopPropagation )
            e.stopPropagation();
        else
            e.cancelBubble = true;
        return false;
    };

    // http://stackoverflow.com/questions/13377887/javascript-node-undefined-in-ie8-and-under
    var Node_ELEMENT_NODE = typeof(Node) != 'undefined' ? Node.ELEMENT_NODE : 1;
    var Node_TEXT_NODE = typeof(Node) != 'undefined' ? Node.TEXT_NODE : 3;

    // http://stackoverflow.com/questions/2234979/how-to-check-in-javascript-if-one-element-is-a-child-of-another
    var isOrContainsNode = function( ancestor, descendant )
    {
        var node = descendant;
        while( node )
        {
            if( node === ancestor )
                return true;
            node = node.parentNode;
        }
        return false;
    };

    // http://stackoverflow.com/questions/667951/how-to-get-nodes-lying-inside-a-range-with-javascript
    var nextNode = function( node, container )
    {
        if( node.firstChild )
            return node.firstChild;
        while( node )
        {
            if( node == container ) // do not walk out of the container
                return null;
            if( node.nextSibling )
                return node.nextSibling;
            node = node.parentNode;
        }
        return null;
    };

    // save/restore selection
    // http://stackoverflow.com/questions/13949059/persisting-the-changes-of-range-objects-after-selection-in-html/13950376#13950376
    var saveSelection = function( containerNode )
    {
        if( window.getSelection )
        {
            var sel = window.getSelection();
            if( sel.rangeCount > 0 )
                return sel.getRangeAt(0);
        }
        else if( document.selection )
        {
            var sel = document.selection;
            return sel.createRange();
        }
        return null;
    };
    var restoreSelection = function( containerNode, savedSel )
    {
        if( ! savedSel )
            return;
        if( window.getSelection )
        {
            var sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(savedSel);
        }
        else if( document.selection )
        {
            savedSel.select();
        }
    };

    // http://stackoverflow.com/questions/12603397/calculate-width-height-of-the-selected-text-javascript
    // http://stackoverflow.com/questions/6846230/coordinates-of-selected-text-in-browser-page
    var getSelectionRect = function()
    {
        if( window.getSelection )
        {
            var sel = window.getSelection();
            if( ! sel.rangeCount )
                return false;
            var range = sel.getRangeAt(0).cloneRange();
            if( range.getBoundingClientRect ) // Missing for Firefox 3.5+3.6
            {
                var rect = range.getBoundingClientRect();
                // Safari 5.1 returns null, IE9 returns 0/0/0/0 if image selected
                if( rect && rect.left && rect.top && rect.right && rect.bottom )
                    return {
                        // Modern browsers return floating-point numbers
                        left: parseInt(rect.left),
                        top: parseInt(rect.top),
                        width: parseInt(rect.right - rect.left),
                        height: parseInt(rect.bottom - rect.top)
                    };
                // on Webkit 'range.getBoundingClientRect()' sometimes return 0/0/0/0 - but 'range.getClientRects()' works
                var rects = range.getClientRects ? range.getClientRects() : [];
                for( var i=0; i < rects.length; ++i )
                {
                    var rect = rects[i];
                    if( rect.left && rect.top && rect.right && rect.bottom )
                        return {
                            // Modern browsers return floating-point numbers
                            left: parseInt(rect.left),
                            top: parseInt(rect.top),
                            width: parseInt(rect.right - rect.left),
                            height: parseInt(rect.bottom - rect.top)
                        };
                }
            }
            /*
            // Fall back to inserting a temporary element (only for Firefox 3.5 and 3.6)
            var span = document.createElement('span');
            if( span.getBoundingClientRect )
            {
                // Ensure span has dimensions and position by
                // adding a zero-width space character
                span.appendChild( document.createTextNode('\u200b') );
                range.insertNode( span );
                var rect = span.getBoundingClientRect();
                var spanParent = span.parentNode;
                spanParent.removeChild( span );
                // Glue any broken text nodes back together
                spanParent.normalize();
                return {
                    left: parseInt(rect.left),
                    top: parseInt(rect.top),
                    width: parseInt(rect.right - rect.left),
                    height: parseInt(rect.bottom - rect.top)
                };
            }
            */
        }
        else if( document.selection )
        {
            var sel = document.selection;
            if( sel.type != 'Control' )
            {
                var range = sel.createRange();
                // IE8 return 0/0/0/0 if caret right before newline
                if( range.boundingLeft || range.boundingTop || range.boundingWidth || range.boundingHeight )
                    return {
                        left: range.boundingLeft,
                        top: range.boundingTop,
                        width: range.boundingWidth,
                        height: range.boundingHeight
                    };
            }
        }
        return false;
    };

    var getSelectionCollapsed = function( containerNode )
    {
        if( window.getSelection )
        {
            var sel = window.getSelection();
            if( sel.isCollapsed )
                return true;
            return false;
        }
        else if( document.selection )
        {
            var sel = document.selection;
            if( sel.type == 'Text' )
            {
                var range = document.selection.createRange();
                var textrange = document.body.createTextRange();
                textrange.moveToElementText(containerNode);
                textrange.setEndPoint('EndToStart', range);
                return range.htmlText.length == 0;
            }
            if( sel.type == 'Control' ) // e.g. an image selected
                return false;
            // sel.type == 'None' -> collapsed selection
        }
        return true;
    };

    // http://stackoverflow.com/questions/7781963/js-get-array-of-all-selected-nodes-in-contenteditable-div
    var getSelectedNodes = function( containerNode )
    {
        if( window.getSelection )
        {
            var sel = window.getSelection();
            if( ! sel.rangeCount )
                return [];
            var nodes = [];
            for( var i=0; i < sel.rangeCount; ++i )
            {
                var range = sel.getRangeAt(i),
                    node = range.startContainer,
                    endNode = range.endContainer;
                while( node )
                {
                    // add this node?
                    if( node != containerNode )
                    {
                        var node_inside_selection = false;
                        if( sel.containsNode )
                            node_inside_selection = sel.containsNode( node, true );
                        else // IE11
                        {
                            // http://stackoverflow.com/questions/5884210/how-to-find-if-a-htmlelement-is-enclosed-in-selected-text
                            var noderange = document.createRange();
                            noderange.selectNodeContents( node );
                            for( var i=0; i < sel.rangeCount; ++i )
                            {
                                var range = sel.getRangeAt(i);
                                // start after or end before -> skip node
                                if( range.compareBoundaryPoints(range.END_TO_START,noderange) >= 0 &&
                                    range.compareBoundaryPoints(range.START_TO_END,noderange) <= 0 )
                                {
                                    node_inside_selection = true;
                                    break;
                                }
                            }
                        }
                        if( node_inside_selection )
                            nodes.push( node );
                    }
                    node = nextNode( node, node == endNode ? endNode : containerNode );
                }
            }
            // Fallback
            if( nodes.length == 0 && isOrContainsNode(containerNode,sel.focusNode) && sel.focusNode != containerNode )
                nodes.push( sel.focusNode );
            return nodes;
        }
        else if( document.selection )
        {
            var sel = document.selection;
            if( sel.type == 'Text' )
            {
                var nodes = [];
                var ranges = sel.createRangeCollection();
                for( var i=0; i < ranges.length; ++i )
                {
                    var range = ranges[i],
                        parentNode = range.parentElement(),
                        node = parentNode;
                    while( node )
                    {
                        // No clue how to detect whether a TextNode is within the selection...
                        // ElementNode is easy: http://stackoverflow.com/questions/5884210/how-to-find-if-a-htmlelement-is-enclosed-in-selected-text
                        var noderange = range.duplicate();
                        noderange.moveToElementText( node.nodeType != Node_ELEMENT_NODE ? node.parentNode : node );
                        // start after or end before -> skip node
                        if( noderange.compareEndPoints('EndToStart',range) >= 0 &&
                            noderange.compareEndPoints('StartToEnd',range) <= 0 )
                        {
                            // no "Array.indexOf()" in IE8
                            var in_array = false;
                            for( var j=0; j < nodes.length; ++j )
                            {
                                if( nodes[j] !== node )
                                    continue;
                                in_array = true;
                                break;
                            }
                            if( ! in_array )
                                nodes.push( node );
                        }
                        node = nextNode( node, parentNode );
                    }
                }
                // Fallback
                if( nodes.length == 0 && isOrContainsNode(containerNode,document.activeElement) && document.activeElement != containerNode )
                    nodes.push( document.activeElement );
                return nodes;
            }
            if( sel.type == 'Control' ) // e.g. an image selected
            {
                var nodes = [];
                // http://msdn.microsoft.com/en-us/library/ie/hh826021%28v=vs.85%29.aspx
                var range = sel.createRange();
                for( var i=0; i < range.length; ++i )
                    nodes.push( range(i) );
                return nodes;
            }
        }
        return [];
    };

    // http://stackoverflow.com/questions/8513368/collapse-selection-to-start-of-selection-not-div
    var collapseSelectionEnd = function()
    {
        if( window.getSelection )
        {
            var sel = window.getSelection();
            if( ! sel.isCollapsed )
            {
                // Form-submits via Enter throw 'NS_ERROR_FAILURE' on Firefox 34
                try {
                    sel.collapseToEnd();
                }
                catch( e ) {
                }
            }
        }
        else if( document.selection )
        {
            var sel = document.selection;
            if( sel.type != 'Control' )
            {
                var range = sel.createRange();
                range.collapse(false);
                range.select();
            }
        }
    };

    // http://stackoverflow.com/questions/15157435/get-last-character-before-caret-position-in-javascript
    // http://stackoverflow.com/questions/11247737/how-can-i-get-the-word-that-the-caret-is-upon-inside-a-contenteditable-div
    var expandSelectionCaret = function( containerNode, preceding, following )
    {
        if( window.getSelection )
        {
            var sel = window.getSelection();
            if( sel.modify )
            {
                for( var i=0; i < preceding; ++i )
                    sel.modify('extend', 'backward', 'character');
                for( var i=0; i < following; ++i )
                    sel.modify('extend', 'forward', 'character');
            }
            else
            {
                // not so easy if the steps would cover multiple nodes ...
                var range = sel.getRangeAt(0);
                range.setStart( range.startContainer, range.startOffset - preceding );
                range.setEnd( range.endContainer, range.endOffset + following );
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }
        else if( document.selection )
        {
            var sel = document.selection;
            if( sel.type != 'Control' )
            {
                var range = sel.createRange();
                range.collapse(true);
                range.moveStart('character', -preceding);
                range.moveEnd('character', following);
                range.select();
            }
        }
    };

    // http://stackoverflow.com/questions/4652734/return-html-from-a-user-selected-text/4652824#4652824
    var getSelectionHtml = function( containerNode )
    {
        if( getSelectionCollapsed( containerNode ) )
            return null;
        if( window.getSelection )
        {
            var sel = window.getSelection();
            if( sel.rangeCount )
            {
                var container = document.createElement('div'),
                    len = sel.rangeCount;
                for( var i=0; i < len; ++i )
                {
                    var contents = sel.getRangeAt(i).cloneContents();
                    container.appendChild(contents);
                }
                return container.innerHTML;
            }
        }
        else if( document.selection )
        {
            var sel = document.selection;
            if( sel.type == 'Text' )
            {
                var range = sel.createRange();
                return range.htmlText;
            }
        }
        return null;
    };

    var selectionInside = function( containerNode, force )
    {
        // selection inside editor?
        if( window.getSelection )
        {
            var sel = window.getSelection();
            if( isOrContainsNode(containerNode,sel.anchorNode) && isOrContainsNode(containerNode,sel.focusNode) )
                return true;
            // selection at least partly outside editor
            if( ! force )
                return false;
            // force selection to editor
            var range = document.createRange();
            range.selectNodeContents( containerNode );
            range.collapse( false );
            sel.removeAllRanges();
            sel.addRange(range);
        }
        else if( document.selection )
        {
            var sel = document.selection;
            if( sel.type == 'Control' ) // e.g. an image selected
            {
                // http://msdn.microsoft.com/en-us/library/ie/hh826021%28v=vs.85%29.aspx
                var range = sel.createRange();
                if( range.length != 0 && isOrContainsNode(containerNode,range(0)) ) // test only the first element
                    return true;
            }
            else //if( sel.type == 'Text' || sel.type == 'None' )
            {
                // Range of container
                // http://stackoverflow.com/questions/12243898/how-to-select-all-text-in-contenteditable-div
                var rangeContainer = document.body.createTextRange();
                rangeContainer.moveToElementText(containerNode);
                // Compare with selection range
                var range = sel.createRange();
                if( rangeContainer.inRange(range) )
                    return true;
            }
            // selection at least partly outside editor
            if( ! force )
                return false;
            // force selection to editor
            // http://stackoverflow.com/questions/12243898/how-to-select-all-text-in-contenteditable-div
            var range = document.body.createTextRange();
            range.moveToElementText(containerNode);
            range.setEndPoint('StartToEnd',range); // collapse
            range.select();
        }
        return true;
    };

    /*
    var clipSelectionTo = function( containerNode )
    {
        if( window.getSelection && containerNode.compareDocumentPosition )
        {
            var sel = window.getSelection();
            var left_node = sel.anchorNode,
                left_offset = sel.anchorOffset,
                right_node = sel.focusNode,
                right_offset = sel.focusOffset;
            // http://stackoverflow.com/questions/10710733/dom-determine-if-the-anchornode-or-focusnode-is-on-the-left-side
            if( (left_node == right_node && left_offset > right_offset) ||
                (left_node.compareDocumentPosition(right_node) & Node.DOCUMENT_POSITION_PRECEDING) )
            {
                // Right-to-left selection
                left_node = sel.focusNode;
                left_offset = sel.focusOffset;
                right_node = sel.anchorNode,
                right_offset = sel.anchorOffset;
            }
            // Speed up: selection inside editor
            var left_inside = isOrContainsNode(containerNode,left_node),
                right_inside = isOrContainsNode(containerNode,right_node);
            if( left_inside && right_inside )
                return true;
            // Selection before/after container?
            if( ! left_inside && containerNode.compareDocumentPosition(left_node) & Node.DOCUMENT_POSITION_FOLLOWING )
                return false; // selection after
            if( ! right_inside && containerNode.compareDocumentPosition(right_node) & Node.DOCUMENT_POSITION_PRECEDING )
                return false; // selection before
            // Selection partly before/after container
            // http://stackoverflow.com/questions/12243898/how-to-select-all-text-in-contenteditable-div
            var range = document.createRange();
            range.selectNodeContents( containerNode );
            if( left_inside )
                range.setStart( left_node, left_offset );
            if( right_inside )
                range.setEnd( right_node, right_offset );
            sel.removeAllRanges();
            sel.addRange(range);
            return true;
        }
        else if( document.selection )
        {
            var sel = document.selection;
            if( sel.type == 'Text' )
            {
                // Range of container
                // http://stackoverflow.com/questions/12243898/how-to-select-all-text-in-contenteditable-div
                var rangeContainer = document.body.createTextRange();
                rangeContainer.moveToElementText(containerNode);
                // Compare with selection range
                var range = sel.createRange();
                if( rangeContainer.inRange(range) )
                    return true;
                // Selection before/after container?
                if( rangeContainer.compareEndPoints('StartToEnd',range) > 0 )
                    return false;
                if( rangeContainer.compareEndPoints('EndToStart',range) < 0 )
                    return false;
                // Selection partly before/after container
                if( rangeContainer.compareEndPoints('StartToStart',range) > 0 )
                    range.setEndPoint('StartToStart',rangeContainer);
                if( rangeContainer.compareEndPoints('EndToEnd',range) < 0 )
                    range.setEndPoint('EndToEnd',rangeContainer);
                // select range
                range.select();
                return true;
            }
        }
        return true;
    };
    */

    // http://stackoverflow.com/questions/6690752/insert-html-at-caret-in-a-contenteditable-div/6691294#6691294
    // http://stackoverflow.com/questions/4823691/insert-an-html-element-in-a-contenteditable-element
    // http://stackoverflow.com/questions/6139107/programatically-select-text-in-a-contenteditable-html-element
    var pasteHtmlAtCaret = function( containerNode, html )
    {
        if( window.getSelection )
        {
            // IE9 and non-IE
            var sel = window.getSelection();
            if( sel.getRangeAt && sel.rangeCount )
            {
                var range = sel.getRangeAt(0);
                // Range.createContextualFragment() would be useful here but is
                // only relatively recently standardized and is not supported in
                // some browsers (IE9, for one)
                var el = document.createElement('div');
                el.innerHTML = html;
                var frag = document.createDocumentFragment(), node, lastNode;
                while ( (node = el.firstChild) ) {
                    lastNode = frag.appendChild(node);
                }
                if( isOrContainsNode(containerNode, range.commonAncestorContainer) )
                {
                    range.deleteContents();
                    range.insertNode(frag);
                }
                else {
                    containerNode.appendChild(frag);
                }
                // Preserve the selection
                if( lastNode )
                {
                    range = range.cloneRange();
                    range.setStartAfter(lastNode);
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }
        }
        else if( document.selection )
        {
            // IE <= 8
            var sel = document.selection;
            if( sel.type != 'Control' )
            {
                var originalRange = sel.createRange();
                originalRange.collapse(true);
                var range = sel.createRange();
                if( isOrContainsNode(containerNode, range.parentElement()) )
                    range.pasteHTML( html );
                else // simply append to Editor
                {
                    var textRange = document.body.createTextRange();
                    textRange.moveToElementText(containerNode);
                    textRange.collapse(false);
                    textRange.select();
                    textRange.pasteHTML( html );
                }
                // Preserve the selection
                range = sel.createRange();
                range.setEndPoint('StartToEnd', originalRange);
                range.select();
            }
        }
    };

    // Interface: Create wysiwyg
    var wysiwyg = function( option )
    {
        // Options
        option = option || {};
        var option_element = option.element || null;
        if( typeof(option_element) == 'string' )
            option_element = document.getElementById( option_element );
        var option_contenteditable = option.contenteditable || null;
        if( typeof(option_contenteditable) == 'string' )
            option_contenteditable = document.getElementById( option_contenteditable );
        var option_onkeydown = option.onKeyDown || null;
        var option_onkeypress = option.onKeyPress || null;
        var option_onkeyup = option.onKeyUp || null;
        var option_onselection = option.onSelection || null;
        var option_onplaceholder = option.onPlaceholder || null;
        var option_onopenpopup = option.onOpenpopup || null;
        var option_onclosepopup = option.onClosepopup || null;
        var option_hijackcontextmenu = option.hijackContextmenu || false;
        var option_readonly = option.readOnly || false;

        // Keep textarea if browser can't handle content-editable
        var is_textarea = option_element.nodeName == 'TEXTAREA' || option_element.nodeName == 'INPUT';
        if( is_textarea )
        {
            // http://stackoverflow.com/questions/1882205/how-do-i-detect-support-for-contenteditable-via-javascript
            var canContentEditable = 'contentEditable' in document.body;
            if( canContentEditable )
            {
                // Sniffer useragent...
                var webkit = navigator.userAgent.match(/(?:iPad|iPhone|Android).* AppleWebKit\/([^ ]+)/);
                if( webkit && 420 <= parseInt(webkit[1]) && parseInt(webkit[1]) < 534 ) // iPhone 1 was Webkit/420
                    canContentEditable = false;
            }
            if( ! canContentEditable )
            {
                // Keep textarea
                var node_textarea = option_element;
                // Add a 'newline' after each '<br>'
                var newlineAfterBR = function( html ) {
                    return html.replace(/<br[ \/]*>\n?/gi,'<br>\n');
                };
                node_textarea.value = newlineAfterBR( node_textarea.value );
                // Command structure
                var dummy_this = function() {
                    return this;
                };
                var dummy_null = function() {
                    return null;
                };
                return {
                    legacy: true,
                    // properties
                    getElement: function()
                    {
                        return node_textarea;
                    },
                    getHTML: function()
                    {
                        return node_textarea.value;
                    },
                    setHTML: function( html )
                    {
                        node_textarea.value = newlineAfterBR( html );
                        return this;
                    },
                    getSelectedHTML: dummy_null,
                    sync: dummy_this,
                    readOnly: function( readonly )
                    {
                        // query read-only
                        if( readonly === undefined )
                            return node_textarea.hasAttribute ? node_textarea.hasAttribute('readonly') :
                                                                !!node_textarea.getAttribute('readonly'); // IE7
                        // set read-only
                        if( readonly )
                            node_textarea.setAttribute( 'readonly', 'readonly' );
                        else
                            node_textarea.removeAttribute( 'readonly' );
                        return this;
                    },
                    // selection and popup
                    collapseSelection: dummy_this,
                    expandSelection: dummy_this,
                    openPopup: dummy_null,
                    closePopup: dummy_this,
                    // exec commands
                    removeFormat: dummy_this,
                    bold: dummy_this,
                    italic: dummy_this,
                    underline: dummy_this,
                    strikethrough: dummy_this,
                    forecolor: dummy_this,
                    highlight: dummy_this,
                    fontName: dummy_this,
                    fontSize: dummy_this,
                    subscript: dummy_this,
                    superscript: dummy_this,
                    align: dummy_this,
                    format: dummy_this,
                    indent: dummy_this,
                    insertLink: dummy_this,
                    insertImage: dummy_this,
                    insertHTML: dummy_this,
                    insertList: dummy_this
                };
            }
        }

        // create content-editable
        var node_textarea = null,
            node_wysiwyg = null;
        if( is_textarea )
        {
            // Textarea
            node_textarea = option_element;
            node_textarea.style.display = 'none';

            // Contenteditable
            if( option_contenteditable )
                node_wysiwyg = option_contenteditable;
            else
            {
                node_wysiwyg = document.createElement( 'DIV' );
                node_wysiwyg.innerHTML = node_textarea.value || '';
                var parent = node_textarea.parentNode,
                    next = node_textarea.nextSibling;
                if( next )
                    parent.insertBefore( node_wysiwyg, next );
                else
                    parent.appendChild( node_wysiwyg );
            }
        }
        else
            node_wysiwyg = option_element;
        // If not read-only
        if( ! option_readonly )
            node_wysiwyg.setAttribute( 'contentEditable', 'true' ); // IE7 is case sensitive

        // IE8 uses 'document' instead of 'window'
        // http://tanalin.com/en/articles/ie-version-js/ - http://stackoverflow.com/questions/10964966/detect-ie-version-prior-to-v9-in-javascript
        var window_ie8 = (document.all && (! document.documentMode || document.documentMode <= 8)) ? document : window;

        // Sync Editor with Textarea
        var syncTextarea = null,
            callUpdates;
        if( false/*is_textarea*/ ) // мы сами синхронизируем textarea и wysiwyg
        {
            var previous_html = node_wysiwyg.innerHTML;
            syncTextarea = function()
            {
                var new_html = node_wysiwyg.innerHTML;
                if( new_html == previous_html )
                    return ;
                // HTML changed
                node_textarea.value = new_html;
                previous_html = new_html;
                // Event Handler
                fireEvent( node_textarea, 'change', false );
            };

            // handle reset event
            var form = node_textarea.form;
            if( form )
            {
                addEvent( form, 'reset', function() {
                    node_wysiwyg.innerHTML = '';
                    syncTextarea();
                    callUpdates( true );
                });
            }
        }

        // Show placeholder
        var showPlaceholder;
        if( option_onplaceholder )
        {
            var placeholder_visible = false;
            showPlaceholder = function()
            {
                // Test if wysiwyg has content
                var wysiwyg_empty = true;
                var node = node_wysiwyg;
                while( node )
                {
                    node = nextNode( node, node_wysiwyg );
                    // Test if node contains something visible
                    if( ! node )
                        ;
                    else if( node.nodeType == Node_ELEMENT_NODE )
                    {
                        if( node.nodeName == 'IMG' )
                        {
                            wysiwyg_empty = false;
                            break;
                        }
                    }
                    else if( node.nodeType == Node_TEXT_NODE )
                    {
                        var text = node.nodeValue;
                        if( text && text.search(/[^\s]/) != -1 )
                        {
                            wysiwyg_empty = false;
                            break;
                        }
                    }
                }
                if( placeholder_visible != wysiwyg_empty )
                {
                    option_onplaceholder( wysiwyg_empty );
                    placeholder_visible = wysiwyg_empty;
                }
            };
            showPlaceholder();
        }

        // Handle selection
        var popup_saved_selection = null, // preserve selection during popup
            handleSelection = null,
            debounced_handleSelection = null;
        if( option_onselection )
        {
            handleSelection = function( clientX, clientY, rightclick )
            {
                // Detect collapsed selection
                var collapsed = getSelectionCollapsed( node_wysiwyg );
                // List of all selected nodes
                var nodes = getSelectedNodes( node_wysiwyg );
                // Rectangle of the selection
                var rect = (clientX === null || clientY === null) ? null :
                            {
                                left: clientX,
                                top: clientY,
                                width: 0,
                                height: 0
                            };
                var selectionRect = getSelectionRect();
                if( selectionRect )
                    rect = selectionRect;
                if( rect )
                {
                    // So far 'rect' is relative to viewport
                    if( node_wysiwyg.getBoundingClientRect )
                    {
                        // Make it relative to the editor via 'getBoundingClientRect()'
                        var boundingrect = node_wysiwyg.getBoundingClientRect();
                        rect.left -= parseInt(boundingrect.left);
                        rect.top -= parseInt(boundingrect.top);
                    }
                    else
                    {
                        var node = node_wysiwyg,
                            offsetLeft = 0,
                            offsetTop = 0,
                            fixed = false;
                        do {
                            offsetLeft += node.offsetLeft ? parseInt(node.offsetLeft) : 0;
                            offsetTop += node.offsetTop ? parseInt(node.offsetTop) : 0;
                            if( node.style.position == 'fixed' )
                                fixed = true;
                        }
                        while( node = node.offsetParent );
                        rect.left -= offsetLeft - (fixed ? 0 : window.pageXOffset);
                        rect.top -= offsetTop - (fixed ? 0 : window.pageYOffset);
                    }
                    // Trim rectangle to the editor
                    if( rect.left < 0 )
                        rect.left = 0;
                    if( rect.top < 0 )
                        rect.top = 0;
                    if( rect.width > node_wysiwyg.offsetWidth )
                        rect.width = node_wysiwyg.offsetWidth;
                    if( rect.height > node_wysiwyg.offsetHeight )
                        rect.height = node_wysiwyg.offsetHeight;
                }
                else if( nodes.length )
                {
                    // What else could we do? Offset of first element...
                    for( var i=0; i < nodes.length; ++i )
                    {
                        var node = nodes[i];
                        if( node.nodeType != Node_ELEMENT_NODE )
                            continue;
                        rect = {
                                left: node.offsetLeft,
                                top: node.offsetTop,
                                width: node.offsetWidth,
                                height: node.offsetHeight
                            };
                        break;
                    }
                }
                // Callback
                option_onselection( collapsed, rect, nodes, rightclick );
            };
            debounced_handleSelection = debounce( handleSelection, 1 );
        }

        // Open popup
        var node_popup = null;
        var popupClickClose = function( e )
        {
            // http://www.quirksmode.org/js/events_properties.html
            if( !e )
                var e = window.event;
            var target = e.target || e.srcElement;
            if( target.nodeType == Node_TEXT_NODE ) // defeat Safari bug
                target = target.parentNode;
            // Click within popup?
            if( isOrContainsNode(node_popup,target) )
                return ;
            // close popup
            popupClose();
        };
        var popupOpen = function()
        {
            // Already open?
            if( node_popup )
                return node_popup;

            // Global click closes popup
            addEvent( window_ie8, 'mousedown', popupClickClose, true );

            // Create popup element
            node_popup = document.createElement( 'DIV' );
            var parent = node_wysiwyg.parentNode,
                next = node_wysiwyg.nextSibling;
            if( next )
                parent.insertBefore( node_popup, next );
            else
                parent.appendChild( node_popup );
            if( option_onopenpopup )
                option_onopenpopup();
            return node_popup;
        };
        var popupClose = function()
        {
            if( ! node_popup )
                return ;
            node_popup.parentNode.removeChild( node_popup );
            node_popup = null;
            removeEvent( window_ie8, 'mousedown', popupClickClose, true );
            if( option_onclosepopup )
                option_onclosepopup();
        };

        // Focus/Blur events
        addEvent( node_wysiwyg, 'focus', function()
        {
            // forward focus/blur to the textarea
            if( node_textarea )
                fireEvent( node_textarea, 'focus', false );
        });
        addEvent( node_wysiwyg, 'blur', function()
        {
            // sync textarea immediately
            if( syncTextarea )
                syncTextarea();
            // forward focus/blur to the textarea
            if( node_textarea )
                fireEvent( node_textarea, 'blur', false );
        });

        // Change events
        var debounced_changeHandler = null;
        if( showPlaceholder || syncTextarea )
        {
            // debounce 'syncTextarea' a second time, because 'innerHTML' is quite burdensome
            var debounced_syncTextarea = syncTextarea ? debounce( syncTextarea, 250, true ) : null; // high timeout is save, because of "onblur" fires immediately
            var changeHandler = function( e )
            {
                if( showPlaceholder )
                    showPlaceholder();
                if( debounced_syncTextarea )
                    debounced_syncTextarea();
            };
            debounced_changeHandler = debounce( changeHandler, 1 );

            // Catch change events
            // http://stackoverflow.com/questions/1391278/contenteditable-change-events/1411296#1411296
            // http://stackoverflow.com/questions/8694054/onchange-event-with-contenteditable/8694125#8694125
            // https://github.com/mindmup/bootstrap-wysiwyg/pull/50/files
            // http://codebits.glennjones.net/editing/events-contenteditable.htm
            addEvent( node_wysiwyg, 'input', debounced_changeHandler );
            addEvent( node_wysiwyg, 'DOMNodeInserted', debounced_changeHandler );
            addEvent( node_wysiwyg, 'DOMNodeRemoved', debounced_changeHandler );
            addEvent( node_wysiwyg, 'DOMSubtreeModified', debounced_changeHandler );
            addEvent( node_wysiwyg, 'DOMCharacterDataModified', debounced_changeHandler ); // polyfill input in IE 9-10
            addEvent( node_wysiwyg, 'propertychange', debounced_changeHandler );
            addEvent( node_wysiwyg, 'textInput', debounced_changeHandler );
            addEvent( node_wysiwyg, 'paste', debounced_changeHandler );
            addEvent( node_wysiwyg, 'cut', debounced_changeHandler );
            addEvent( node_wysiwyg, 'drop', debounced_changeHandler );
        }

        // Key events
        // http://sandbox.thewikies.com/html5-experiments/key-events.html
        var keyHandler = function( e, phase )
        {
            // http://www.quirksmode.org/js/events_properties.html
            if( !e )
                var e = window.event;
            // https://developer.mozilla.org/en-US/docs/Web/API/KeyboardEvent
            // http://stackoverflow.com/questions/1444477/keycode-and-charcode
            // http://stackoverflow.com/questions/4285627/javascript-keycode-vs-charcode-utter-confusion
            // http://unixpapa.com/js/key.html
            var key = e.which || e.keyCode,
                character = String.fromCharCode(key || e.charCode),
                shiftKey = e.shiftKey || false,
                altKey = e.altKey || false,
                ctrlKey = e.ctrlKey || false,
                metaKey = e.metaKey || false;
             if( phase == 1 )
            {
                // Callback
                if( option_onkeydown && option_onkeydown(key, character, shiftKey, altKey, ctrlKey, metaKey) === false )
                    return cancelEvent( e ); // dismiss key
            }
            else if( phase == 2 )
            {
                // Callback
                if( option_onkeypress && option_onkeypress(key, character, shiftKey, altKey, ctrlKey, metaKey) === false )
                    return cancelEvent( e ); // dismiss key
            }
            else if( phase == 3 )
            {
                // Callback
                if( option_onkeyup && option_onkeyup(key, character, shiftKey, altKey, ctrlKey, metaKey) === false )
                    return cancelEvent( e ); // dismiss key
            }

            // Keys can change the selection
            if( phase == 2 || phase == 3 )
            {
                popup_saved_selection = null;
                if( debounced_handleSelection )
                    debounced_handleSelection( null, null, false );
            }
            // Most keys can cause text-changes
            if( phase == 2 && debounced_changeHandler )
            {
                switch( key )
                {
                    case 33: // pageUp
                    case 34: // pageDown
                    case 35: // end
                    case 36: // home
                    case 37: // left
                    case 38: // up
                    case 39: // right
                    case 40: // down
                        // cursors do not
                        break;
                    default:
                        // call change handler
                        debounced_changeHandler();
                        break;
                }
            }
        };
        addEvent( node_wysiwyg, 'keydown', function( e )
        {
            return keyHandler( e, 1 );
        });
        addEvent( node_wysiwyg, 'keypress', function( e )
        {
            return keyHandler( e, 2 );
        });
        addEvent( node_wysiwyg, 'keyup', function( e )
        {
            return keyHandler( e, 3 );
        });

        // Mouse events
        var mouseHandler = function( e, rightclick )
        {
            // http://www.quirksmode.org/js/events_properties.html
            if( !e )
                var e = window.event;
            // mouse position
            var clientX = null,
                clientY = null;
            if( e.clientX && e.clientY )
            {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            else if( e.pageX && e.pageY )
            {
                clientX = e.pageX - window.pageXOffset;
                clientY = e.pageY - window.pageYOffset;
            }
            // mouse button
            if( e.which && e.which == 3 )
                rightclick = true;
            else if( e.button && e.button == 2 )
                rightclick = true;

            // remove event handler
            removeEvent( window_ie8, 'mouseup', mouseHandler );
            // Callback selection
            popup_saved_selection = null;
            if( ! option_hijackcontextmenu && rightclick )
                return ;
            if( debounced_handleSelection )
                debounced_handleSelection( clientX, clientY, rightclick );
        };
        addEvent( node_wysiwyg, 'mousedown', function( e )
        {
            // catch event if 'mouseup' outside 'node_wysiwyg'
            removeEvent( window_ie8, 'mouseup', mouseHandler );
            addEvent( window_ie8, 'mouseup', mouseHandler );
        });
        addEvent( node_wysiwyg, 'mouseup', function( e )
        {
            mouseHandler( e );
            // Trigger change
            if( debounced_changeHandler )
                debounced_changeHandler();
        });
        addEvent( node_wysiwyg, 'dblclick', function( e )
        {
            mouseHandler( e );
        });
        addEvent( node_wysiwyg, 'selectionchange',  function( e )
        {
            mouseHandler( e );
        });
        if( option_hijackcontextmenu )
        {
            addEvent( node_wysiwyg, 'contextmenu', function( e )
            {
                mouseHandler( e, true );
                return cancelEvent( e );
            });
        }


        // exec command
        // https://developer.mozilla.org/en-US/docs/Web/API/document.execCommand
        // http://www.quirksmode.org/dom/execCommand.html
        var execCommand = function( command, param, force_selection )
        {
            // give selection to contenteditable element
            restoreSelection( node_wysiwyg, popup_saved_selection );
            // tried to avoid forcing focus(), but ... - https://github.com/wysiwygjs/wysiwyg.js/issues/51
            node_wysiwyg.focus();
            if( ! selectionInside(node_wysiwyg, force_selection) ) // returns 'selection inside editor'
                return false;

            // for webkit, mozilla, opera
            if( window.getSelection )
            {
                // Buggy, call within 'try/catch'
                try {
                    if( document.queryCommandSupported && ! document.queryCommandSupported(command) )
                        return false;
                    return document.execCommand( command, false, param );
                }
                catch( e ) {
                }
            }
            // for IE
            else if( document.selection )
            {
                var sel = document.selection;
                if( sel.type != 'None' )
                {
                    var range = sel.createRange();
                    // Buggy, call within 'try/catch'
                    try {
                        if( ! range.queryCommandEnabled(command) )
                            return false;
                        return range.execCommand( command, false, param );
                    }
                    catch( e ) {
                    }
                }
            }
            return false;
        };

        // copy/paste images from clipboard - if FileReader-API is available
        if( window.FileReader )
        {
            addEvent( node_wysiwyg, 'paste', function( e )
            {
                var clipboardData = e.clipboardData;
                if( ! clipboardData )
                    return;
                var items = clipboardData.items;
                if( ! items || ! items.length )
                    return;
                var item = items[0];
                if( ! item.type.match(/^image\//) )
                    return;
                // Insert image from clipboard
                var filereader = new FileReader();
                filereader.onloadend = function( e )
                {
                    var image = e.target.result;
                    if( image )
                        execCommand( 'insertImage', image );
                };
                filereader.readAsDataURL( item.getAsFile() );
                return cancelEvent( e ); // dismiss paste
            });
        }

        // Workaround IE11 - https://github.com/wysiwygjs/wysiwyg.js/issues/14
        var trailingDiv = null;
        var IEtrailingDIV = function()
        {
            // Detect IE - http://stackoverflow.com/questions/17907445/how-to-detect-ie11
            if( document.all || !!window.MSInputMethodContext )
            {
                trailingDiv = document.createElement( 'DIV' );
                node_wysiwyg.appendChild( trailingDiv );
            }
        };
        // Command structure
        callUpdates = function( selection_destroyed )
        {
            // Remove IE11 workaround
            if( trailingDiv )
            {
                node_wysiwyg.removeChild( trailingDiv );
                trailingDiv = null;
            }
            // change-handler
            if( debounced_changeHandler )
                debounced_changeHandler();
            // handle saved selection
            if( selection_destroyed )
            {
                collapseSelectionEnd();
                popup_saved_selection = null; // selection destroyed
            }
            else if( popup_saved_selection )
                popup_saved_selection = saveSelection( node_wysiwyg );
        };
        return {
            // properties
            getElement: function()
            {
                return node_wysiwyg;
            },
            getHTML: function()
            {
                return node_wysiwyg.innerHTML;
            },
            setHTML: function( html )
            {
                node_wysiwyg.innerHTML = html || '<br>';
                callUpdates( true ); // selection destroyed
                return this;
            },
            getSelectedHTML: function()
            {
                restoreSelection( node_wysiwyg, popup_saved_selection );
                if( ! selectionInside(node_wysiwyg) )
                    return null;
                return getSelectionHtml( node_wysiwyg );
            },
            sync: function()
            {
                if( syncTextarea )
                    syncTextarea();
                return this;
            },
            readOnly: function( readonly )
            {
                // query read-only
                if( readonly === undefined )
                    return node_wysiwyg.hasAttribute ? !node_wysiwyg.hasAttribute('contentEditable') :
                                                       !node_wysiwyg.getAttribute('contentEditable'); // IE7
                // set read-only
                if( readonly )
                    node_wysiwyg.removeAttribute( 'contentEditable' );
                else
                    node_wysiwyg.setAttribute( 'contentEditable', 'true' ); // IE7 is case sensitive
                return this;
            },
            // selection and popup
            collapseSelection: function()
            {
                collapseSelectionEnd();
                popup_saved_selection = null; // selection destroyed
                return this;
            },
            expandSelection: function( preceding, following )
            {
                restoreSelection( node_wysiwyg, popup_saved_selection );
                if( ! selectionInside(node_wysiwyg) )
                    return this;
                expandSelectionCaret( node_wysiwyg, preceding, following );
                popup_saved_selection = saveSelection( node_wysiwyg ); // save new selection
                return this;
            },
            openPopup: function()
            {
                if( ! popup_saved_selection )
                    popup_saved_selection = saveSelection( node_wysiwyg ); // save current selection
                return popupOpen();
            },
            closePopup: function()
            {
                popupClose();
                return this;
            },
            removeFormat: function()
            {
                execCommand( 'removeFormat' );
                execCommand( 'unlink' );
                callUpdates();
                return this;
            },
            bold: function()
            {
                execCommand( 'bold' );
                callUpdates();
                return this;
            },
            italic: function()
            {
                execCommand( 'italic' );
                callUpdates();
                return this;
            },
            underline: function()
            {
                execCommand( 'underline' );
                callUpdates();
                return this;
            },
            strikethrough: function()
            {
                execCommand( 'strikeThrough' );
                callUpdates();
                return this;
            },
            forecolor: function( color )
            {
                execCommand( 'foreColor', color );
                callUpdates();
                return this;
            },
            highlight: function( color )
            {
                // http://stackoverflow.com/questions/2756931/highlight-the-text-of-the-dom-range-element
                if( ! execCommand('hiliteColor',color) ) // some browsers apply 'backColor' to the whole block
                    execCommand( 'backColor', color );
                callUpdates();
                return this;
            },
            fontName: function( name )
            {
                execCommand( 'fontName', name );
                callUpdates();
                return this;
            },
            fontSize: function( size )
            {
                execCommand( 'fontSize', size );
                callUpdates();
                return this;
            },
            subscript: function()
            {
                execCommand( 'subscript' );
                callUpdates();
                return this;
            },
            superscript: function()
            {
                execCommand( 'superscript' );
                callUpdates();
                return this;
            },
            align: function( align )
            {
                IEtrailingDIV();
                if( align == 'left' )
                    execCommand( 'justifyLeft' );
                else if( align == 'center' )
                    execCommand( 'justifyCenter' );
                else if( align == 'right' )
                    execCommand( 'justifyRight' );
                else if( align == 'justify' )
                    execCommand( 'justifyFull' );
                callUpdates();
                return this;
            },
            format: function( tagname )
            {
                IEtrailingDIV();
                execCommand( 'formatBlock', tagname );
                callUpdates();
                return this;
            },
            indent: function( outdent )
            {
                IEtrailingDIV();
                execCommand( outdent ? 'outdent' : 'indent' );
                callUpdates();
                return this;
            },
            insertLink: function( url )
            {
                execCommand( 'createLink', url );
                callUpdates( true ); // selection destroyed
                return this;
            },
            insertImage: function( url )
            {
                execCommand( 'insertImage', url, true );
                callUpdates( true ); // selection destroyed
                return this;
            },
            insertHTML: function( html )
            {
                if( ! execCommand('insertHTML', html, true) )
                {
                    // IE 11 still does not support 'insertHTML'
                    restoreSelection( node_wysiwyg, popup_saved_selection );
                    selectionInside( node_wysiwyg, true );
                    pasteHtmlAtCaret( node_wysiwyg, html );
                }
                callUpdates( true ); // selection destroyed
                return this;
            },
            insertList: function( ordered )
            {
                IEtrailingDIV();
                execCommand( ordered ? 'insertOrderedList' : 'insertUnorderedList' );
                callUpdates();
                return this;
            }
        };
    };

    return wysiwyg;
});
/*
 CSS Browser Selector 0.81
 Originally written by Rafael Lima (http://rafael.adm.br)
 http://rafael.adm.br/css_browser_selector
 License: http://creativecommons.org/licenses/by/2.5/

 Co-maintained by:
 https://github.com/ridjohansen/css_browser_selector
 https://github.com/delka/css_browser_selector
 https://github.com/verbatim/css_browser_selector
 */

(function() {
var uaInfo = {
	ua : '',
	is : function (t) {
		return RegExp(t, "i").test(uaInfo.ua);
	},
	version : function (p, n) {
		n = n.replace(".", "_");
		var i = n.indexOf('_'),
			ver = "";
		while (i > 0) {
			ver += " " + p + n.substring(0, i);
			i = n.indexOf('_', i + 1);
		}
		ver += " " + p + n;
		return ver;
	},
	getBrowser : function() {
		var g = 'gecko',
			w = 'webkit',
			c = 'chrome',
			f = 'firefox',
			s = 'safari',
			o = 'opera',

			ua = uaInfo.ua,
			is = uaInfo.is;

		return [
			(!(/opera|webtv/i.test(ua)) && /msie\s(\d+)/.test(ua)) ? ('ie ie' + (/trident\/4\.0/.test(ua) ? '8' : RegExp.$1))
				:is('edge\/') ? 'edge ie' + (/edge\/(\d+)\.(\d+)/.test(ua) ? RegExp.$1 + ' ie' + RegExp.$1 + '_' + RegExp.$2 : '') // IE Edge
				:is('trident\/') ? 'ie ie'+ (/trident\/.+rv:(\d+)/i.test(ua) ? RegExp.$1 : '') //ie11+
				:is('firefox/') ? g + " " + f + (/firefox\/((\d+)(\.(\d+))(\.\d+)*)/.test(ua) ? ' ' + f + RegExp.$2 + ' ' + f + RegExp.$2 + "_" + RegExp.$4 : '')
				:is('gecko/') ? g
				:is('opera') ? o + (/version\/((\d+)(\.(\d+))(\.\d+)*)/.test(ua) ? ' ' + o + RegExp.$2 + ' ' + o + RegExp.$2 + "_" + RegExp.$4 : (/opera(\s|\/)(\d+)\.(\d+)/.test(ua) ? ' ' + o + RegExp.$2 + " " + o + RegExp.$2 + "_" + RegExp.$3 : ''))
				:is('konqueror') ? 'konqueror'
				:is('chrome') ? w + ' ' + c + (/chrome\/((\d+)(\.(\d+))(\.\d+)*)/.test(ua) ? ' ' + c + RegExp.$2 + ((RegExp.$4 > 0) ? ' ' + c + RegExp.$2 + "_" + RegExp.$4 : '') : '')
				:is('iron') ? w + ' iron'
				:is('applewebkit/') ? (w + ' ' + s + (/version\/((\d+)(\.(\d+))(\.\d+)*)/.test(ua) ? ' ' + s + RegExp.$2 + " " + s + RegExp.$2 + RegExp.$3.replace('.', '_') : (/ Safari\/(\d+)/i.test(ua) ? ((RegExp.$1 == "419" || RegExp.$1 == "417" || RegExp.$1 == "416" || RegExp.$1 == "412") ? ' ' + s + '2_0' : RegExp.$1 == "312" ? ' ' + s + '1_3' : RegExp.$1 == "125" ? ' ' + s + '1_2' : RegExp.$1 == "85" ? ' ' + s + '1_0' : '') : ''))) //applewebkit
				:is('mozilla/') ? g : ''
		];
	},
	getPlatform : function() {
		var wp = 'winphone',
			a  = 'android',
			bb = 'blackberry',
			dv = 'device_',

			ua = uaInfo.ua,
			version = uaInfo.version,
			is = uaInfo.is;

		return [
			is('j2me') ? 'j2me'
			:is('windows phone') ? (wp + (/Windows Phone (\d+)(\.(\d+))+/i.test(ua) ? " " + wp + RegExp.$1 + " " + wp + RegExp.$1 + RegExp.$2.replace('.', '_') : (/Windows Phone OS (\d+)(\.(\d+))+/i.test(ua) ? " " + wp + RegExp.$1 + " " + wp + RegExp.$1 + RegExp.$2.replace('.', '_') : ''))) // Windows Phone
			:is('blackberry') ? (bb + (/Version\/(\d+)(\.(\d+)+)/i.test(ua) ? " " + bb + RegExp.$1 + " " + bb + RegExp.$1 + RegExp.$2.replace('.', '_') : (/Blackberry ?(([0-9]+)([a-z]?))[\/|;]/gi.test(ua) ? ' ' + bb + RegExp.$2 + (RegExp.$3 ? ' ' + bb + RegExp.$2 + RegExp.$3 : '') : ''))) // blackberry
			:is('android') ? (a + (/Version\/(\d+)(\.(\d+))+/i.test(ua) ? " " + a + RegExp.$1 + " " + a + RegExp.$1 + RegExp.$2.replace('.', '_') : '') + (/Android (.+); (.+) Build/i.test(ua) ? ' ' + dv + ((RegExp.$2).replace(/ /g, "_")).replace(/-/g, "_") : '')) //android
			:is('ipad|ipod|iphone') ? (
			(/CPU( iPhone)? OS (\d+[_|\.]\d+([_|\.]\d+)*)/i.test(ua) ? 'ios' + version('ios', RegExp.$2) : '') + ' ' + (/(ip(ad|od|hone))/gi.test(ua) ? RegExp.$1 : "")) //'iphone'
			//:is('ipod')?'ipod'
			//:is('ipad')?'ipad'
			:is('playbook') ? 'playbook'
			:is('kindle|silk') ? 'kindle'
			:is('playbook') ? 'playbook'
			:is('mac') ? 'mac' + (/mac os x ((\d+)[.|_](\d+))/.test(ua) ? (' mac' + (RegExp.$2) + ' mac' + (RegExp.$1).replace('.', "_")) : '')
			:is('win') ? 'win' + (is('windows nt 10.0') ? ' win10'
			:is('windows nt 6.3') ? ' win8_1'
			:is('windows nt 6.2') ? ' win8'
			:is('windows nt 6.1') ? ' win7'
			:is('windows nt 6.0') ? ' vista'
			:is('windows nt 5.2') || is('windows nt 5.1') ? ' win_xp'
			:is('windows nt 5.0') ? ' win_2k'
			:is('windows nt 4.0') || is('WinNT4.0') ? ' win_nt' : '')
			:is('freebsd') ? 'freebsd'
			:is('x11|linux') ? 'linux' : ''
		];
	},
	getMobile : function() {
		var is = uaInfo.is;
		return [
			is("android|mobi|mobile|j2me|iphone|ipod|ipad|blackberry|winphone|playbook|kindle|silk") ? 'mobile' : ''
		];
	},
	getIpadApp : function() {
		var is = uaInfo.is;
		return [
			(is('ipad|iphone|ipod') && !is('safari')) ? 'ipad_app' : ''
		];
	},
	getLang : function() {
		var ua = uaInfo.ua;

		return [
			/[; |\[](([a-z]{2})(\-[a-z]{2})?)[)|;|\]]/i.test(ua) ? ('lang_' + RegExp.$2).replace("-", "_") + (RegExp.$3 != '' ? (' ' + 'lang_' + RegExp.$1).replace("-", "_") : '') : ''
		];
	}
}

if (typeof html =='undefined') { 
	html=document.documentElement;
}

var screenInfo = {
	width : (window.outerWidth || html.clientWidth) - 15,
	height : window.outerHeight || html.clientHeight,
	screens : [0, 768, 980, 1200],
	
	screenSize : function () {
		screenInfo.width = (window.outerWidth || html.clientWidth) - 15;
		screenInfo.height = window.outerHeight || html.clientHeight;
			
		var screens = screenInfo.screens,
			i = screens.length,
			arr = [],
			maxw, 
			minw;
		
		while(i--) {
			if (screenInfo.width >= screens[i]) {
				if(i) {
					arr.push("minw_" + screens[(i)]);
				}
				if (i <= 2) {
					arr.push("maxw_" + (screens[(i) + 1] - 1));
				}
				break;
			}
		}
		return arr;
	},
	getOrientation : function() {
		return screenInfo.width < screenInfo.height ? ["orientation_portrait"] : ["orientation_landscape"];
	},
	getInfo : function() {
		var arr = [];
		arr = arr.concat(screenInfo.screenSize());
		arr = arr.concat(screenInfo.getOrientation());
		return  arr;
	},
	getPixelRatio : function() {
		var arr = [],
			pixelRatio = window.devicePixelRatio ? window.devicePixelRatio : 1;

		if(pixelRatio > 1) {
			arr.push('retina_' + parseInt(pixelRatio) + 'x');
			arr.push('hidpi');
		} else {
			arr.push('no-hidpi');
		}
		return arr;
	}
}

var dataUriInfo = {
	data : new Image(),
	div : document.createElement("div"),
	isIeLessThan9 : false,
	getImg : function() {

		dataUriInfo.data.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
		dataUriInfo.div.innerHTML = "<!--[if lt IE 9]><i></i><![endif]-->";
		dataUriInfo.isIeLessThan9 = dataUriInfo.div.getElementsByTagName("i").length == 1;

		return dataUriInfo.data;
	},
	checkSupport : function() {
		if(dataUriInfo.data.width != 1 || dataUriInfo.data.height != 1 || dataUriInfo.isIeLessThan9) {
			return ["no-datauri"];
		}
		else {
			return ["datauri"];
		}
	}

}

function css_browser_selector(u, ns) {
	var html = document.documentElement,
		b = []
		ns = ns ? ns : "";

	/* ua */
	uaInfo.ua = u.toLowerCase();
	b = b.concat(uaInfo.getBrowser());
	b = b.concat(uaInfo.getPlatform());
	b = b.concat(uaInfo.getMobile());
	b = b.concat(uaInfo.getIpadApp());
	b = b.concat(uaInfo.getLang());


	/* js */
	b = b.concat(['js']);

	/* pixel ratio */
	b = b.concat(screenInfo.getPixelRatio());

	/* screen */
	b = b.concat(screenInfo.getInfo());

	var updateScreen = function() {
		html.className = html.className.replace(/ ?orientation_\w+/g, "").replace(/ [min|max|cl]+[w|h]_\d+/g, "");
		html.className = html.className + ' ' + screenInfo.getInfo().join(' ');
	}

	if (window.addEventListener) {
		window.addEventListener('resize', updateScreen);
		window.addEventListener('orientationchange', updateScreen);
	} else if (window.attachEvent) {
		window.attachEvent('onresize', updateScreen);
	}

	/* dataURI */
	var data = dataUriInfo.getImg();
	data.onload = data.onerror = function(){
		html.className += ' ' + dataUriInfo.checkSupport().join(' ');
	}


	/* save & add existing html classes */
	var classes = html.className;
	var classesArray = classes.split(/ /);

	/* merge existing classes on html tag */
	b = b.concat(classesArray);

	/* removendo itens invalidos do array */
	/* add filter function polyfill for IE8 */
	if (!Array.prototype.filter) {
		Array.prototype.filter = function(fun/*, thisArg*/) {
			'use strict';

			if (this === void 0 || this === null) {
				throw new TypeError();
			}

			var t = Object(this);
			var len = t.length >>> 0;
			if (typeof fun !== 'function') {
				throw new TypeError();
			}

			var res = [];
			var thisArg = arguments.length >= 2 ? arguments[1] : void 0;
			for (var i = 0; i < len; i++) {
				if (i in t) {
					var val = t[i];

					// NOTE: Technically this should Object.defineProperty at
					//			 the next index, as push can be affected by
					//			 properties on Object.prototype and Array.prototype.
					//			 But that method's new, and collisions should be
					//			 rare, so use the more-compatible alternative.
					if (fun.call(thisArg, val, i, t)) {
						res.push(val);
					}
				}
			}

			return res;
		};
	}

	b = b.filter(function(e){
		/* if no-js class exists, remove it */
		if (e === 'no-js') {
			return false;
        }
		return e;
	});

	/* prefixo do namespace */
	b[0] = ns ? ns + b[0] : b[0];
	html.className = b.join(' ' + ns);
	return html.className;
}

// Add css_browser_selector as a global object.
window.css_browser_selector = css_browser_selector;
})();

// define css_browser_selector_ns before loading this script to assign a namespace
var css_browser_selector_ns = css_browser_selector_ns || "";

// init
css_browser_selector(navigator.userAgent, css_browser_selector_ns);
(function ($) {

  /**
   * Augment jQuery prototype.
   */

  $.fn.antiscroll = function (options) {
    return this.each(function () {
      if ($(this).data('antiscroll')) {
        $(this).data('antiscroll').destroy();
      }

      $(this).data('antiscroll', new $.Antiscroll(this, options));
    });
  };

  /**
   * Expose constructor.
   */

  $.Antiscroll = Antiscroll;

  /**
   * Antiscroll pane constructor.
   *
   * @param {Element|jQuery} main pane
   * @parma {Object} options
   * @api public
   */

  function Antiscroll (el, opts) {
    this.el = $(el);
    this.options = opts || {};

    this.x = (false !== this.options.x) || this.options.forceHorizontal;
    this.y = (false !== this.options.y) || this.options.forceVertical;
    this.autoHide = false !== this.options.autoHide;
    this.padding = undefined == this.options.padding ? 2 : this.options.padding;

    this.inner = this.el.find('.antiscroll-inner');
    this.inner.css({
        'width':  '+=' + (this.y ? scrollbarSize() : 0)
      , 'height': '+=' + (this.x ? scrollbarSize() : 0)
    });

    this.refresh();
  };

  /**
   * refresh scrollbars
   *
   * @api public
   */

  Antiscroll.prototype.refresh = function() {
    var needHScroll = this.inner.get(0).scrollWidth > this.el.width() + (this.y ? scrollbarSize() : 0),
	    needVScroll = this.inner.get(0).scrollHeight > this.el.height() + (this.x ? scrollbarSize() : 0);

    if (this.x) {
      if (!this.horizontal && needHScroll) {
        this.horizontal = new Scrollbar.Horizontal(this);
      } else if (this.horizontal && !needHScroll)  {
        this.horizontal.destroy();
        this.horizontal = null;
      } else if (this.horizontal) {
        this.horizontal.update();
      }
    }

    if (this.y) {
      if (!this.vertical && needVScroll) {
        this.vertical = new Scrollbar.Vertical(this);
      } else if (this.vertical && !needVScroll)  {
        this.vertical.destroy();
        this.vertical = null;
      } else if (this.vertical) {
        this.vertical.update();
      }
    }
  };

  /**
   * Cleans up.
   *
   * @return {Antiscroll} for chaining
   * @api public
   */

  Antiscroll.prototype.destroy = function () {
    if (this.horizontal) {
      this.horizontal.destroy();
      this.horizontal = null
    }
    if (this.vertical) {
      this.vertical.destroy();
      this.vertical = null
    }
    return this;
  };

  /**
   * Rebuild Antiscroll.
   *
   * @return {Antiscroll} for chaining
   * @api public
   */

  Antiscroll.prototype.rebuild = function () {
    this.destroy();
    this.inner.attr('style', '');
    Antiscroll.call(this, this.el, this.options);
    return this;
  };

  /**
   * Scrollbar constructor.
   *
   * @param {Element|jQuery} element
   * @api public
   */

  function Scrollbar (pane) {
    this.pane = pane;
    this.pane.el.append(this.el);
    this.innerEl = this.pane.inner.get(0);

    this.dragging = false;
    this.enter = false;
    this.shown = false;

    // hovering
    this.pane.el.mouseenter($.proxy(this, 'mouseenter'));
    this.pane.el.mouseleave($.proxy(this, 'mouseleave'));

    // dragging
    this.el.mousedown($.proxy(this, 'mousedown'));

    // scrolling
    this.innerPaneScrollListener = $.proxy(this, 'scroll');
    this.pane.inner.scroll(this.innerPaneScrollListener);

    // wheel -optional-
    this.innerPaneMouseWheelListener = $.proxy(this, 'mousewheel');
    this.pane.inner.bind('mousewheel', this.innerPaneMouseWheelListener);

    // show
    var initialDisplay = this.pane.options.initialDisplay;

    if (initialDisplay !== false) {
      this.show();
      if (this.pane.autoHide) {
          this.hiding = setTimeout($.proxy(this, 'hide'), parseInt(initialDisplay, 10) || 3000);
      }
    }
  };

  /**
   * Cleans up.
   *
   * @return {Scrollbar} for chaining
   * @api public
   */

  Scrollbar.prototype.destroy = function () {
    this.el.remove();
    this.pane.inner.unbind('scroll', this.innerPaneScrollListener);
    this.pane.inner.unbind('mousewheel', this.innerPaneMouseWheelListener);
    return this;
  };

  /**
   * Called upon mouseenter.
   *
   * @api private
   */

  Scrollbar.prototype.mouseenter = function () {
    this.enter = true;
    this.show();
  };

  /**
   * Called upon mouseleave.
   *
   * @api private
   */

  Scrollbar.prototype.mouseleave = function () {
    this.enter = false;

    if (!this.dragging) {
        if (this.pane.autoHide) {
            this.hide();
        }
    }
  };

  /**
   * Called upon wrap scroll.
   *
   * @api private
   */

  Scrollbar.prototype.scroll = function () {
    if (!this.shown) {
      this.show();
      if (!this.enter && !this.dragging) {
        if (this.pane.autoHide) {
            this.hiding = setTimeout($.proxy(this, 'hide'), 1500);
        }
      }
    }

    this.update();
  };

  /**
   * Called upon scrollbar mousedown.
   *
   * @api private
   */

  Scrollbar.prototype.mousedown = function (ev) {
    ev.preventDefault();

    this.dragging = true;

    this.startPageY = ev.pageY - parseInt(this.el.css('top'), 10);
    this.startPageX = ev.pageX - parseInt(this.el.css('left'), 10);

    // prevent crazy selections on IE
    this.el[0].ownerDocument.onselectstart = function () { return false; };

    var pane = this.pane,
	    move = $.proxy(this, 'mousemove'),
		self = this

    $(this.el[0].ownerDocument)
      .mousemove(move)
      .mouseup(function () {
        self.dragging = false;
        this.onselectstart = null;

        $(this).unbind('mousemove', move);

        if (!self.enter) {
          self.hide();
        }
      });
  };

  /**
   * Show scrollbar.
   *
   * @api private
   */

  Scrollbar.prototype.show = function (duration) {
    if (!this.shown && this.update()) {
      this.el.addClass('antiscroll-scrollbar-shown');
      if (this.hiding) {
        clearTimeout(this.hiding);
        this.hiding = null;
      }
      this.shown = true;
    }
  };

  /**
   * Hide scrollbar.
   *
   * @api private
   */

  Scrollbar.prototype.hide = function () {
    if (this.pane.autoHide !== false && this.shown) {
      // check for dragging
      this.el.removeClass('antiscroll-scrollbar-shown');
      this.shown = false;
    }
  };

  /**
   * Horizontal scrollbar constructor
   *
   * @api private
   */

  Scrollbar.Horizontal = function (pane) {
    this.el = $('<div class="antiscroll-scrollbar antiscroll-scrollbar-horizontal"/>', pane.el);
    Scrollbar.call(this, pane);
  };

  /**
   * Inherits from Scrollbar.
   */

  inherits(Scrollbar.Horizontal, Scrollbar);

  /**
   * Updates size/position of scrollbar.
   *
   * @api private
   */

  Scrollbar.Horizontal.prototype.update = function () {
    var paneWidth = this.pane.el.width(),
	    trackWidth = paneWidth - this.pane.padding * 2,
		innerEl = this.pane.inner.get(0)

    this.el
      .css('width', trackWidth * paneWidth / innerEl.scrollWidth)
      .css('left', trackWidth * innerEl.scrollLeft / innerEl.scrollWidth);

    return paneWidth < innerEl.scrollWidth;
  };

  /**
   * Called upon drag.
   *
   * @api private
   */

  Scrollbar.Horizontal.prototype.mousemove = function (ev) {
    var trackWidth = this.pane.el.width() - this.pane.padding * 2,
	    pos = ev.pageX - this.startPageX,
		barWidth = this.el.width(),
		innerEl = this.pane.inner.get(0)

    // minimum top is 0, maximum is the track height
    var y = Math.min(Math.max(pos, 0), trackWidth - barWidth);

    innerEl.scrollLeft = (innerEl.scrollWidth - this.pane.el.width())
      * y / (trackWidth - barWidth);
  };

  /**
   * Called upon container mousewheel.
   *
   * @api private
   */

  Scrollbar.Horizontal.prototype.mousewheel = function (ev, delta, x, y) {
    if ((x < 0 && 0 == this.pane.inner.get(0).scrollLeft) ||
        (x > 0 && (this.innerEl.scrollLeft + Math.ceil(this.pane.el.width())
          == this.innerEl.scrollWidth))) {
      ev.preventDefault();
      return false;
    }
  };

  /**
   * Vertical scrollbar constructor
   *
   * @api private
   */

  Scrollbar.Vertical = function (pane) {
    this.el = $('<div class="antiscroll-scrollbar antiscroll-scrollbar-vertical"/>', pane.el);
    Scrollbar.call(this, pane);
  };

  /**
   * Inherits from Scrollbar.
   */

  inherits(Scrollbar.Vertical, Scrollbar);

  /**
   * Updates size/position of scrollbar.
   *
   * @api private
   */

  Scrollbar.Vertical.prototype.update = function () {
    var paneHeight = this.pane.el.height(),
	    trackHeight = paneHeight - this.pane.padding * 2,
		innerEl = this.innerEl;

    var scrollbarHeight = trackHeight * paneHeight / innerEl.scrollHeight;
    scrollbarHeight = scrollbarHeight < 20 ? 20 : scrollbarHeight;

    var topPos = trackHeight * innerEl.scrollTop / innerEl.scrollHeight;

    if((topPos + scrollbarHeight) > trackHeight) {
        var diff = (topPos + scrollbarHeight) - trackHeight;
        topPos = topPos - diff - 3;
    }

    this.el
      .css('height', scrollbarHeight)
      .css('top', topPos);

	  return paneHeight < innerEl.scrollHeight;
  };

  /**
   * Called upon drag.
   *
   * @api private
   */

  Scrollbar.Vertical.prototype.mousemove = function (ev) {
    var paneHeight = this.pane.el.height(),
	    trackHeight = paneHeight - this.pane.padding * 2,
		pos = ev.pageY - this.startPageY,
		barHeight = this.el.height(),
		innerEl = this.innerEl

    // minimum top is 0, maximum is the track height
    var y = Math.min(Math.max(pos, 0), trackHeight - barHeight);

    innerEl.scrollTop = (innerEl.scrollHeight - paneHeight)
      * y / (trackHeight - barHeight);
  };

  /**
   * Called upon container mousewheel.
   *
   * @api private
   */

  Scrollbar.Vertical.prototype.mousewheel = function (ev, delta, x, y) {
    if ((y > 0 && 0 == this.innerEl.scrollTop) ||
        (y < 0 && (this.innerEl.scrollTop + Math.ceil(this.pane.el.height())
          == this.innerEl.scrollHeight))) {
      ev.preventDefault();
      return false;
    }
  };

  /**
   * Cross-browser inheritance.
   *
   * @param {Function} constructor
   * @param {Function} constructor we inherit from
   * @api private
   */

  function inherits (ctorA, ctorB) {
    function f() {};
    f.prototype = ctorB.prototype;
    ctorA.prototype = new f;
  };

  /**
   * Scrollbar size detection.
   */

  var size;

  function scrollbarSize () {
    if (size === undefined) {
      var div = $(
          '<div class="antiscroll-inner" style="width:50px;height:50px;overflow-y:scroll;'
        + 'position:absolute;top:-200px;left:-200px;"><div style="height:100px;width:100%"/>'
        + '</div>'
      );

      $('body').append(div);
      var w1 = $(div).innerWidth();
      var w2 = $('div', div).innerWidth();
      $(div).remove();

      size = w1 - w2;
    }

    return size;
  };

})(jQuery);
/*!
	Autosize v1.18.4 - 2014-01-11
	Automatically adjust textarea height based on user input.
	(c) 2014 Jack Moore - http://www.jacklmoore.com/autosize
	license: http://www.opensource.org/licenses/mit-license.php
*/

!function(a){var b,c={className:"autosizejs",append:"",callback:!1,resizeDelay:10,placeholder:!0},d='<textarea tabindex="-1" style="position:absolute; top:-999px; left:0; right:auto; bottom:auto; border:0; padding: 0; -moz-box-sizing:content-box; -webkit-box-sizing:content-box; box-sizing:content-box; word-wrap:break-word; height:0 !important; min-height:0 !important; overflow:hidden; transition:none; -webkit-transition:none; -moz-transition:none;"/>',e=["fontFamily","fontSize","fontWeight","fontStyle","letterSpacing","textTransform","wordSpacing","textIndent"],f=a(d).data("autosize",!0)[0];f.style.lineHeight="99px","99px"===a(f).css("lineHeight")&&e.push("lineHeight"),f.style.lineHeight="",a.fn.autosize=function(d){return this.length?(d=a.extend({},c,d||{}),f.parentNode!==document.body&&a(document.body).append(f),this.each(function(){function c(){var b,c=window.getComputedStyle?window.getComputedStyle(m,null):!1;c?(b=m.getBoundingClientRect().width,0===b&&(b=parseInt(c.width,10)),a.each(["paddingLeft","paddingRight","borderLeftWidth","borderRightWidth"],function(a,d){b-=parseInt(c[d],10)})):b=Math.max(n.width(),0),f.style.width=b+"px"}function g(){var g={};if(b=m,f.className=d.className,j=parseInt(n.css("maxHeight"),10),a.each(e,function(a,b){g[b]=n.css(b)}),a(f).css(g),c(),window.chrome){var h=m.style.width;m.style.width="0px";{m.offsetWidth}m.style.width=h}}function h(){var e,h;b!==m?g():c(),f.value=!m.value&&d.placeholder?(a(m).attr("placeholder")||"")+d.append:m.value+d.append,f.style.overflowY=m.style.overflowY,h=parseInt(m.style.height,10),f.scrollTop=0,f.scrollTop=9e4,e=f.scrollTop,j&&e>j?(m.style.overflowY="scroll",e=j):(m.style.overflowY="hidden",k>e&&(e=k)),e+=o,h!==e&&(m.style.height=e+"px",p&&d.callback.call(m,m))}function i(){clearTimeout(l),l=setTimeout(function(){var a=n.width();a!==r&&(r=a,h())},parseInt(d.resizeDelay,10))}var j,k,l,m=this,n=a(m),o=0,p=a.isFunction(d.callback),q={height:m.style.height,overflow:m.style.overflow,overflowY:m.style.overflowY,wordWrap:m.style.wordWrap,resize:m.style.resize},r=n.width();n.data("autosize")||(n.data("autosize",!0),("border-box"===n.css("box-sizing")||"border-box"===n.css("-moz-box-sizing")||"border-box"===n.css("-webkit-box-sizing"))&&(o=n.outerHeight()-n.height()),k=Math.max(parseInt(n.css("minHeight"),10)-o||0,n.height()),n.css({overflow:"hidden",overflowY:"hidden",wordWrap:"break-word",resize:"none"===n.css("resize")||"vertical"===n.css("resize")?"none":"horizontal"}),"onpropertychange"in m?"oninput"in m?n.on("input.autosize keyup.autosize",h):n.on("propertychange.autosize",function(){"value"===event.propertyName&&h()}):n.on("input.autosize",h),d.resizeDelay!==!1&&a(window).on("resize.autosize",i),n.on("autosize.resize",h),n.on("autosize.resizeIncludeStyle",function(){b=null,h()}),n.on("autosize.destroy",function(){b=null,clearTimeout(l),a(window).off("resize",i),n.off("autosize").off(".autosize").css(q).removeData("autosize")}),h())})):this}}(window.jQuery||window.$);
/*!
 * jQuery Cookie Plugin v1.4.1
 * https://github.com/carhartl/jquery-cookie
 *
 * Copyright 2013 Klaus Hartl
 * Released under the MIT license
 */

(function (factory) {
  if (typeof define === 'function' && define.amd) {
    // AMD
    define(['jquery'], factory);
  } else if (typeof exports === 'object') {
    // CommonJS
    factory(require('jquery'));
  } else {
    // Browser globals
    factory(jQuery);
  }
}(function ($) {

  var pluses = /\+/g;

  function encode(s) {
    return config.raw ? s : encodeURIComponent(s);
  }

  function decode(s) {
    return config.raw ? s : decodeURIComponent(s);
  }

  function stringifyCookieValue(value) {
    return encode(config.json ? JSON.stringify(value) : String(value));
  }

  function parseCookieValue(s) {
    if (s.indexOf('"') === 0) {
      // This is a quoted cookie as according to RFC2068, unescape...
      s = s.slice(1, -1).replace(/\\"/g, '"').replace(/\\\\/g, '\\');
    }

    try {
      // Replace server-side written pluses with spaces.
      // If we can't decode the cookie, ignore it, it's unusable.
      // If we can't parse the cookie, ignore it, it's unusable.
      s = decodeURIComponent(s.replace(pluses, ' '));
      return config.json ? JSON.parse(s) : s;
    } catch(e) {}
  }

  function read(s, converter) {
    var value = config.raw ? s : parseCookieValue(s);
    return $.isFunction(converter) ? converter(value) : value;
  }

  var config = $.cookie = function (key, value, options) {

    // Write

    if (value !== undefined && !$.isFunction(value)) {
      options = $.extend({}, config.defaults, options);

      if (typeof options.expires === 'number') {
        var days = options.expires, t = options.expires = new Date();
        t.setTime(+t + days * 864e+5);
      }

      return (document.cookie = [
        encode(key), '=', stringifyCookieValue(value),
        options.expires ? '; expires=' + options.expires.toUTCString() : '', // use expires attribute, max-age is not supported by IE
        options.path    ? '; path=' + options.path : '',
        options.domain  ? '; domain=' + options.domain : '',
        options.secure  ? '; secure' : ''
      ].join(''));
    }

    // Read

    var result = key ? undefined : {};

    // To prevent the for loop in the first place assign an empty array
    // in case there are no cookies at all. Also prevents odd result when
    // calling $.cookie().
    var cookies = document.cookie ? document.cookie.split('; ') : [];

    for (var i = 0, l = cookies.length; i < l; i++) {
      var parts = cookies[i].split('=');
      var name = decode(parts.shift());
      var cookie = parts.join('=');

      if (key && key === name) {
        // If second argument (value) is a function it's a converter...
        result = read(cookie, value);
        break;
      }

      // Prevent storing a cookie that we couldn't decode.
      if (!key && (cookie = read(cookie)) !== undefined) {
        result[name] = cookie;
      }
    }

    return result;
  };

  config.defaults = {};

  $.removeCookie = function (key, options) {
    if ($.cookie(key) === undefined) {
      return false;
    }

    // Must not alter options, thus extending a fresh object...
    $.cookie(key, '', $.extend({}, options, { expires: -1 }));
    return !$.cookie(key);
  };

}));
(function($){
  $.event.special.dom_remove = {
    remove: function(o) {
      if (o.handler) {
        o.handler();
      }
    }
  }
})(jQuery);
/*
 jquery.fullscreen 1.1.5
 https://github.com/kayahr/jquery-fullscreen-plugin
 Copyright (C) 2012-2013 Klaus Reimer <k@ailis.de>
 Licensed under the MIT license
 (See http://www.opensource.org/licenses/mit-license)
*/

function d(c){var b,a;if(!this.length)return this;b=this[0];b.ownerDocument?a=b.ownerDocument:(a=b,b=a.documentElement);if(null==c){if(!a.exitFullscreen&&!a.webkitExitFullscreen&&!a.webkitCancelFullScreen&&!a.msExitFullscreen&&!a.mozCancelFullScreen)return null;c=!!a.fullscreenElement||!!a.msFullscreenElement||!!a.webkitIsFullScreen||!!a.mozFullScreen;return!c?c:a.fullscreenElement||a.webkitFullscreenElement||a.webkitCurrentFullScreenElement||a.msFullscreenElement||a.mozFullScreenElement||c}c?(c=
b.requestFullscreen||b.webkitRequestFullscreen||b.webkitRequestFullScreen||b.msRequestFullscreen||b.mozRequestFullScreen)&&c.call(b):(c=a.exitFullscreen||a.webkitExitFullscreen||a.webkitCancelFullScreen||a.msExitFullscreen||a.mozCancelFullScreen)&&c.call(a);return this}jQuery.fn.fullScreen=d;jQuery.fn.toggleFullScreen=function(){return d.call(this,!d.call(this))};var e,f,g;e=document;
e.webkitCancelFullScreen?(f="webkitfullscreenchange",g="webkitfullscreenerror"):e.msExitFullscreen?(f="MSFullscreenChange",g="MSFullscreenError"):e.mozCancelFullScreen?(f="mozfullscreenchange",g="mozfullscreenerror"):(f="fullscreenchange",g="fullscreenerror");jQuery(document).bind(f,function(){jQuery(document).trigger(new jQuery.Event("fullscreenchange"))});jQuery(document).bind(g,function(){jQuery(document).trigger(new jQuery.Event("fullscreenerror"))});
(function(e,t){"use strict";var n=e.History=e.History||{},r=e.jQuery;if(typeof n.Adapter!="undefined")throw new Error("History.js Adapter has already been loaded...");n.Adapter={bind:function(e,t,n){r(e).bind(t,n)},trigger:function(e,t,n){r(e).trigger(t,n)},extractEventData:function(e,n,r){var i=n&&n.originalEvent&&n.originalEvent[e]||r&&r[e]||t;return i},onDomLoad:function(e){r(e)}},typeof n.init!="undefined"&&n.init()})(window),function(e,t){"use strict";var n=e.console||t,r=e.document,i=e.navigator,s=!1,o=e.setTimeout,u=e.clearTimeout,a=e.setInterval,f=e.clearInterval,l=e.JSON,c=e.alert,h=e.History=e.History||{},p=e.history;try{s=e.sessionStorage,s.setItem("TEST","1"),s.removeItem("TEST")}catch(d){s=!1}l.stringify=l.stringify||l.encode,l.parse=l.parse||l.decode;if(typeof h.init!="undefined")throw new Error("History.js Core has already been loaded...");h.init=function(e){return typeof h.Adapter=="undefined"?!1:(typeof h.initCore!="undefined"&&h.initCore(),typeof h.initHtml4!="undefined"&&h.initHtml4(),!0)},h.initCore=function(d){if(typeof h.initCore.initialized!="undefined")return!1;h.initCore.initialized=!0,h.options=h.options||{},h.options.hashChangeInterval=h.options.hashChangeInterval||100,h.options.safariPollInterval=h.options.safariPollInterval||500,h.options.doubleCheckInterval=h.options.doubleCheckInterval||500,h.options.disableSuid=h.options.disableSuid||!1,h.options.storeInterval=h.options.storeInterval||1e3,h.options.busyDelay=h.options.busyDelay||250,h.options.debug=h.options.debug||!1,h.options.initialTitle=h.options.initialTitle||r.title,h.options.html4Mode=h.options.html4Mode||!1,h.options.delayInit=h.options.delayInit||!1,h.intervalList=[],h.clearAllIntervals=function(){var e,t=h.intervalList;if(typeof t!="undefined"&&t!==null){for(e=0;e<t.length;e++)f(t[e]);h.intervalList=null}},h.debug=function(){(h.options.debug||!1)&&h.log.apply(h,arguments)},h.log=function(){var e=typeof n!="undefined"&&typeof n.log!="undefined"&&typeof n.log.apply!="undefined",t=r.getElementById("log"),i,s,o,u,a;e?(u=Array.prototype.slice.call(arguments),i=u.shift(),typeof n.debug!="undefined"?n.debug.apply(n,[i,u]):n.log.apply(n,[i,u])):i="\n"+arguments[0]+"\n";for(s=1,o=arguments.length;s<o;++s){a=arguments[s];if(typeof a=="object"&&typeof l!="undefined")try{a=l.stringify(a)}catch(f){}i+="\n"+a+"\n"}return t?(t.value+=i+"\n-----\n",t.scrollTop=t.scrollHeight-t.clientHeight):e||c(i),!0},h.getInternetExplorerMajorVersion=function(){var e=h.getInternetExplorerMajorVersion.cached=typeof h.getInternetExplorerMajorVersion.cached!="undefined"?h.getInternetExplorerMajorVersion.cached:function(){var e=3,t=r.createElement("div"),n=t.getElementsByTagName("i");while((t.innerHTML="<!--[if gt IE "+ ++e+"]><i></i><![endif]-->")&&n[0]);return e>4?e:!1}();return e},h.isInternetExplorer=function(){var e=h.isInternetExplorer.cached=typeof h.isInternetExplorer.cached!="undefined"?h.isInternetExplorer.cached:Boolean(h.getInternetExplorerMajorVersion());return e},h.options.html4Mode?h.emulated={pushState:!0,hashChange:!0}:h.emulated={pushState:!Boolean(e.history&&e.history.pushState&&e.history.replaceState&&!/ Mobile\/([1-7][a-z]|(8([abcde]|f(1[0-8]))))/i.test(i.userAgent)&&!/AppleWebKit\/5([0-2]|3[0-2])/i.test(i.userAgent)),hashChange:Boolean(!("onhashchange"in e||"onhashchange"in r)||h.isInternetExplorer()&&h.getInternetExplorerMajorVersion()<8)},h.enabled=!h.emulated.pushState,h.bugs={setHash:Boolean(!h.emulated.pushState&&i.vendor==="Apple Computer, Inc."&&/AppleWebKit\/5([0-2]|3[0-3])/.test(i.userAgent)),safariPoll:Boolean(!h.emulated.pushState&&i.vendor==="Apple Computer, Inc."&&/AppleWebKit\/5([0-2]|3[0-3])/.test(i.userAgent)),ieDoubleCheck:Boolean(h.isInternetExplorer()&&h.getInternetExplorerMajorVersion()<8),hashEscape:Boolean(h.isInternetExplorer()&&h.getInternetExplorerMajorVersion()<7)},h.isEmptyObject=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},h.cloneObject=function(e){var t,n;return e?(t=l.stringify(e),n=l.parse(t)):n={},n},h.getRootUrl=function(){var e=r.location.protocol+"//"+(r.location.hostname||r.location.host);if(r.location.port||!1)e+=":"+r.location.port;return e+="/",e},h.getBaseHref=function(){var e=r.getElementsByTagName("base"),t=null,n="";return e.length===1&&(t=e[0],n=t.href.replace(/[^\/]+$/,"")),n=n.replace(/\/+$/,""),n&&(n+="/"),n},h.getBaseUrl=function(){var e=h.getBaseHref()||h.getBasePageUrl()||h.getRootUrl();return e},h.getPageUrl=function(){var e=h.getState(!1,!1),t=(e||{}).url||h.getLocationHref(),n;return n=t.replace(/\/+$/,"").replace(/[^\/]+$/,function(e,t,n){return/\./.test(e)?e:e+"/"}),n},h.getBasePageUrl=function(){var e=h.getLocationHref().replace(/[#\?].*/,"").replace(/[^\/]+$/,function(e,t,n){return/[^\/]$/.test(e)?"":e}).replace(/\/+$/,"")+"/";return e},h.getFullUrl=function(e,t){var n=e,r=e.substring(0,1);return t=typeof t=="undefined"?!0:t,/[a-z]+\:\/\//.test(e)||(r==="/"?n=h.getRootUrl()+e.replace(/^\/+/,""):r==="#"?n=h.getPageUrl().replace(/#.*/,"")+e:r==="?"?n=h.getPageUrl().replace(/[\?#].*/,"")+e:t?n=h.getBaseUrl()+e.replace(/^(\.\/)+/,""):n=h.getBasePageUrl()+e.replace(/^(\.\/)+/,"")),n.replace(/\#$/,"")},h.getShortUrl=function(e){var t=e,n=h.getBaseUrl(),r=h.getRootUrl();return h.emulated.pushState&&(t=t.replace(n,"")),t=t.replace(r,"/"),h.isTraditionalAnchor(t)&&(t="./"+t),t=t.replace(/^(\.\/)+/g,"./").replace(/\#$/,""),t},h.getLocationHref=function(e){return e=e||r,e.URL===e.location.href?e.location.href:e.location.href===decodeURIComponent(e.URL)?e.URL:e.location.hash&&decodeURIComponent(e.location.href.replace(/^[^#]+/,""))===e.location.hash?e.location.href:e.URL.indexOf("#")==-1&&e.location.href.indexOf("#")!=-1?e.location.href:e.URL||e.location.href},h.store={},h.idToState=h.idToState||{},h.stateToId=h.stateToId||{},h.urlToId=h.urlToId||{},h.storedStates=h.storedStates||[],h.savedStates=h.savedStates||[],h.normalizeStore=function(){h.store.idToState=h.store.idToState||{},h.store.urlToId=h.store.urlToId||{},h.store.stateToId=h.store.stateToId||{}},h.getState=function(e,t){typeof e=="undefined"&&(e=!0),typeof t=="undefined"&&(t=!0);var n=h.getLastSavedState();return!n&&t&&(n=h.createStateObject()),e&&(n=h.cloneObject(n),n.url=n.cleanUrl||n.url),n},h.getIdByState=function(e){var t=h.extractId(e.url),n;if(!t){n=h.getStateString(e);if(typeof h.stateToId[n]!="undefined")t=h.stateToId[n];else if(typeof h.store.stateToId[n]!="undefined")t=h.store.stateToId[n];else{for(;;){t=(new Date).getTime()+String(Math.random()).replace(/\D/g,"");if(typeof h.idToState[t]=="undefined"&&typeof h.store.idToState[t]=="undefined")break}h.stateToId[n]=t,h.idToState[t]=e}}return t},h.normalizeState=function(e){var t,n;if(!e||typeof e!="object")e={};if(typeof e.normalized!="undefined")return e;if(!e.data||typeof e.data!="object")e.data={};return t={},t.normalized=!0,t.title=e.title||"",t.url=h.getFullUrl(e.url?e.url:h.getLocationHref()),t.hash=h.getShortUrl(t.url),t.data=h.cloneObject(e.data),t.id=h.getIdByState(t),t.cleanUrl=t.url.replace(/\??\&_suid.*/,""),t.url=t.cleanUrl,n=!h.isEmptyObject(t.data),(t.title||n)&&h.options.disableSuid!==!0&&(t.hash=h.getShortUrl(t.url).replace(/\??\&_suid.*/,""),/\?/.test(t.hash)||(t.hash+="?"),t.hash+="&_suid="+t.id),t.hashedUrl=h.getFullUrl(t.hash),(h.emulated.pushState||h.bugs.safariPoll)&&h.hasUrlDuplicate(t)&&(t.url=t.hashedUrl),t},h.createStateObject=function(e,t,n){var r={data:e,title:t,url:n};return r=h.normalizeState(r),r},h.getStateById=function(e){e=String(e);var n=h.idToState[e]||h.store.idToState[e]||t;return n},h.getStateString=function(e){var t,n,r;return t=h.normalizeState(e),n={data:t.data,title:e.title,url:e.url},r=l.stringify(n),r},h.getStateId=function(e){var t,n;return t=h.normalizeState(e),n=t.id,n},h.getHashByState=function(e){var t,n;return t=h.normalizeState(e),n=t.hash,n},h.extractId=function(e){var t,n,r,i;return e.indexOf("#")!=-1?i=e.split("#")[0]:i=e,n=/(.*)\&_suid=([0-9]+)$/.exec(i),r=n?n[1]||e:e,t=n?String(n[2]||""):"",t||!1},h.isTraditionalAnchor=function(e){var t=!/[\/\?\.]/.test(e);return t},h.extractState=function(e,t){var n=null,r,i;return t=t||!1,r=h.extractId(e),r&&(n=h.getStateById(r)),n||(i=h.getFullUrl(e),r=h.getIdByUrl(i)||!1,r&&(n=h.getStateById(r)),!n&&t&&!h.isTraditionalAnchor(e)&&(n=h.createStateObject(null,null,i))),n},h.getIdByUrl=function(e){var n=h.urlToId[e]||h.store.urlToId[e]||t;return n},h.getLastSavedState=function(){return h.savedStates[h.savedStates.length-1]||t},h.getLastStoredState=function(){return h.storedStates[h.storedStates.length-1]||t},h.hasUrlDuplicate=function(e){var t=!1,n;return n=h.extractState(e.url),t=n&&n.id!==e.id,t},h.storeState=function(e){return h.urlToId[e.url]=e.id,h.storedStates.push(h.cloneObject(e)),e},h.isLastSavedState=function(e){var t=!1,n,r,i;return h.savedStates.length&&(n=e.id,r=h.getLastSavedState(),i=r.id,t=n===i),t},h.saveState=function(e){return h.isLastSavedState(e)?!1:(h.savedStates.push(h.cloneObject(e)),!0)},h.getStateByIndex=function(e){var t=null;return typeof e=="undefined"?t=h.savedStates[h.savedStates.length-1]:e<0?t=h.savedStates[h.savedStates.length+e]:t=h.savedStates[e],t},h.getCurrentIndex=function(){var e=null;return h.savedStates.length<1?e=0:e=h.savedStates.length-1,e},h.getHash=function(e){var t=h.getLocationHref(e),n;return n=h.getHashByUrl(t),n},h.unescapeHash=function(e){var t=h.normalizeHash(e);return t=decodeURIComponent(t),t},h.normalizeHash=function(e){var t=e.replace(/[^#]*#/,"").replace(/#.*/,"");return t},h.setHash=function(e,t){var n,i;return t!==!1&&h.busy()?(h.pushQueue({scope:h,callback:h.setHash,args:arguments,queue:t}),!1):(h.busy(!0),n=h.extractState(e,!0),n&&!h.emulated.pushState?h.pushState(n.data,n.title,n.url,!1):h.getHash()!==e&&(h.bugs.setHash?(i=h.getPageUrl(),h.pushState(null,null,i+"#"+e,!1)):r.location.hash=e),h)},h.escapeHash=function(t){var n=h.normalizeHash(t);return n=e.encodeURIComponent(n),h.bugs.hashEscape||(n=n.replace(/\%21/g,"!").replace(/\%26/g,"&").replace(/\%3D/g,"=").replace(/\%3F/g,"?")),n},h.getHashByUrl=function(e){var t=String(e).replace(/([^#]*)#?([^#]*)#?(.*)/,"$2");return t=h.unescapeHash(t),t},h.setTitle=function(e){var t=e.title,n;t||(n=h.getStateByIndex(0),n&&n.url===e.url&&(t=n.title||h.options.initialTitle));try{r.getElementsByTagName("title")[0].innerHTML=t.replace("<","&lt;").replace(">","&gt;").replace(" & "," &amp; ")}catch(i){}return r.title=t,h},h.queues=[],h.busy=function(e){typeof e!="undefined"?h.busy.flag=e:typeof h.busy.flag=="undefined"&&(h.busy.flag=!1);if(!h.busy.flag){u(h.busy.timeout);var t=function(){var e,n,r;if(h.busy.flag)return;for(e=h.queues.length-1;e>=0;--e){n=h.queues[e];if(n.length===0)continue;r=n.shift(),h.fireQueueItem(r),h.busy.timeout=o(t,h.options.busyDelay)}};h.busy.timeout=o(t,h.options.busyDelay)}return h.busy.flag},h.busy.flag=!1,h.fireQueueItem=function(e){return e.callback.apply(e.scope||h,e.args||[])},h.pushQueue=function(e){return h.queues[e.queue||0]=h.queues[e.queue||0]||[],h.queues[e.queue||0].push(e),h},h.queue=function(e,t){return typeof e=="function"&&(e={callback:e}),typeof t!="undefined"&&(e.queue=t),h.busy()?h.pushQueue(e):h.fireQueueItem(e),h},h.clearQueue=function(){return h.busy.flag=!1,h.queues=[],h},h.stateChanged=!1,h.doubleChecker=!1,h.doubleCheckComplete=function(){return h.stateChanged=!0,h.doubleCheckClear(),h},h.doubleCheckClear=function(){return h.doubleChecker&&(u(h.doubleChecker),h.doubleChecker=!1),h},h.doubleCheck=function(e){return h.stateChanged=!1,h.doubleCheckClear(),h.bugs.ieDoubleCheck&&(h.doubleChecker=o(function(){return h.doubleCheckClear(),h.stateChanged||e(),!0},h.options.doubleCheckInterval)),h},h.safariStatePoll=function(){var t=h.extractState(h.getLocationHref()),n;if(!h.isLastSavedState(t))return n=t,n||(n=h.createStateObject()),h.Adapter.trigger(e,"popstate"),h;return},h.back=function(e){return e!==!1&&h.busy()?(h.pushQueue({scope:h,callback:h.back,args:arguments,queue:e}),!1):(h.busy(!0),h.doubleCheck(function(){h.back(!1)}),p.go(-1),!0)},h.forward=function(e){return e!==!1&&h.busy()?(h.pushQueue({scope:h,callback:h.forward,args:arguments,queue:e}),!1):(h.busy(!0),h.doubleCheck(function(){h.forward(!1)}),p.go(1),!0)},h.go=function(e,t){var n;if(e>0)for(n=1;n<=e;++n)h.forward(t);else{if(!(e<0))throw new Error("History.go: History.go requires a positive or negative integer passed.");for(n=-1;n>=e;--n)h.back(t)}return h};if(h.emulated.pushState){var v=function(){};h.pushState=h.pushState||v,h.replaceState=h.replaceState||v}else h.onPopState=function(t,n){var r=!1,i=!1,s,o;return h.doubleCheckComplete(),s=h.getHash(),s?(o=h.extractState(s||h.getLocationHref(),!0),o?h.replaceState(o.data,o.title,o.url,!1):(h.Adapter.trigger(e,"anchorchange"),h.busy(!1)),h.expectedStateId=!1,!1):(r=h.Adapter.extractEventData("state",t,n)||!1,r?i=h.getStateById(r):h.expectedStateId?i=h.getStateById(h.expectedStateId):i=h.extractState(h.getLocationHref()),i||(i=h.createStateObject(null,null,h.getLocationHref())),h.expectedStateId=!1,h.isLastSavedState(i)?(h.busy(!1),!1):(h.storeState(i),h.saveState(i),h.setTitle(i),h.Adapter.trigger(e,"statechange"),h.busy(!1),!0))},h.Adapter.bind(e,"popstate",h.onPopState),h.pushState=function(t,n,r,i){if(h.getHashByUrl(r)&&h.emulated.pushState)throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(i!==!1&&h.busy())return h.pushQueue({scope:h,callback:h.pushState,args:arguments,queue:i}),!1;h.busy(!0);var s=h.createStateObject(t,n,r);return h.isLastSavedState(s)?h.busy(!1):(h.storeState(s),h.expectedStateId=s.id,p.pushState(s.id,s.title,s.url),h.Adapter.trigger(e,"popstate")),!0},h.replaceState=function(t,n,r,i){if(h.getHashByUrl(r)&&h.emulated.pushState)throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(i!==!1&&h.busy())return h.pushQueue({scope:h,callback:h.replaceState,args:arguments,queue:i}),!1;h.busy(!0);var s=h.createStateObject(t,n,r);return h.isLastSavedState(s)?h.busy(!1):(h.storeState(s),h.expectedStateId=s.id,p.replaceState(s.id,s.title,s.url),h.Adapter.trigger(e,"popstate")),!0};if(s){try{h.store=l.parse(s.getItem("History.store"))||{}}catch(m){h.store={}}h.normalizeStore()}else h.store={},h.normalizeStore();h.Adapter.bind(e,"unload",h.clearAllIntervals),h.saveState(h.storeState(h.extractState(h.getLocationHref(),!0))),s&&(h.onUnload=function(){var e,t,n;try{e=l.parse(s.getItem("History.store"))||{}}catch(r){e={}}e.idToState=e.idToState||{},e.urlToId=e.urlToId||{},e.stateToId=e.stateToId||{};for(t in h.idToState){if(!h.idToState.hasOwnProperty(t))continue;e.idToState[t]=h.idToState[t]}for(t in h.urlToId){if(!h.urlToId.hasOwnProperty(t))continue;e.urlToId[t]=h.urlToId[t]}for(t in h.stateToId){if(!h.stateToId.hasOwnProperty(t))continue;e.stateToId[t]=h.stateToId[t]}h.store=e,h.normalizeStore(),n=l.stringify(e);try{s.setItem("History.store",n)}catch(i){if(i.code!==DOMException.QUOTA_EXCEEDED_ERR)throw i;s.length&&(s.removeItem("History.store"),s.setItem("History.store",n))}},h.intervalList.push(a(h.onUnload,h.options.storeInterval)),h.Adapter.bind(e,"beforeunload",h.onUnload),h.Adapter.bind(e,"unload",h.onUnload));if(!h.emulated.pushState){h.bugs.safariPoll&&h.intervalList.push(a(h.safariStatePoll,h.options.safariPollInterval));if(i.vendor==="Apple Computer, Inc."||(i.appCodeName||"")==="Mozilla")h.Adapter.bind(e,"hashchange",function(){h.Adapter.trigger(e,"popstate")}),h.getHash()&&h.Adapter.onDomLoad(function(){h.Adapter.trigger(e,"hashchange")})}},(!h.options||!h.options.delayInit)&&h.init()}(window)
;
(function(c,q){var m="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";c.fn.imagesLoaded=function(f){function n(){var b=c(j),a=c(h);d&&(h.length?d.reject(e,b,a):d.resolve(e));c.isFunction(f)&&f.call(g,e,b,a)}function p(b){k(b.target,"error"===b.type)}function k(b,a){b.src===m||-1!==c.inArray(b,l)||(l.push(b),a?h.push(b):j.push(b),c.data(b,"imagesLoaded",{isBroken:a,src:b.src}),r&&d.notifyWith(c(b),[a,e,c(j),c(h)]),e.length===l.length&&(setTimeout(n),e.unbind(".imagesLoaded",
p)))}var g=this,d=c.isFunction(c.Deferred)?c.Deferred():0,r=c.isFunction(d.notify),e=g.find("img").add(g.filter("img")),l=[],j=[],h=[];c.isPlainObject(f)&&c.each(f,function(b,a){if("callback"===b)f=a;else if(d)d[b](a)});e.length?e.bind("load.imagesLoaded error.imagesLoaded",p).each(function(b,a){var d=a.src,e=c.data(a,"imagesLoaded");if(e&&e.src===d)k(a,e.isBroken);else if(a.complete&&a.naturalWidth!==q)k(a,0===a.naturalWidth||0===a.naturalHeight);else if(a.readyState||a.complete)a.src=m,a.src=d}):
n();return d?d.promise(g):g}})(jQuery);
/**
 * jQuery Masonry v2.1.08
 * A dynamic layout plugin for jQuery
 * The flip-side of CSS Floats
 * http://masonry.desandro.com
 *
 * Licensed under the MIT license.
 * Copyright 2012 David DeSandro
 */

(function(e,t,n){"use strict";var r=t.event,i;r.special.smartresize={setup:function(){t(this).bind("resize",r.special.smartresize.handler)},teardown:function(){t(this).unbind("resize",r.special.smartresize.handler)},handler:function(e,t){var n=this,s=arguments;e.type="smartresize",i&&clearTimeout(i),i=setTimeout(function(){r.dispatch.apply(n,s)},t==="execAsap"?0:100)}},t.fn.smartresize=function(e){return e?this.bind("smartresize",e):this.trigger("smartresize",["execAsap"])},t.Mason=function(e,n){this.element=t(n),this._create(e),this._init()},t.Mason.settings={isResizable:!0,isAnimated:!1,animationOptions:{queue:!1,duration:500},gutterWidth:0,isRTL:!1,isFitWidth:!1,containerStyle:{position:"relative"}},t.Mason.prototype={_filterFindBricks:function(e){var t=this.options.itemSelector;return t?e.filter(t).add(e.find(t)):e},_getBricks:function(e){var t=this._filterFindBricks(e).css({position:"absolute"}).addClass("masonry-brick");return t},_create:function(n){this.options=t.extend(!0,{},t.Mason.settings,n),this.styleQueue=[];var r=this.element[0].style;this.originalStyle={height:r.height||""};var i=this.options.containerStyle;for(var s in i)this.originalStyle[s]=r[s]||"";this.element.css(i),this.horizontalDirection=this.options.isRTL?"right":"left";var o=this.element.css("padding-"+this.horizontalDirection),u=this.element.css("padding-top");this.offset={x:o?parseInt(o,10):0,y:u?parseInt(u,10):0},this.isFluid=this.options.columnWidth&&typeof this.options.columnWidth=="function";var a=this;setTimeout(function(){a.element.addClass("masonry")},0),this.options.isResizable&&t(e).bind("smartresize.masonry",function(){a.resize()}),this.reloadItems()},_init:function(e){this._getColumns(),this._reLayout(e)},option:function(e,n){t.isPlainObject(e)&&(this.options=t.extend(!0,this.options,e))},layout:function(e,t){for(var n=0,r=e.length;n<r;n++)this._placeBrick(e[n]);var i={};i.height=Math.max.apply(Math,this.colYs);if(this.options.isFitWidth){var s=0;n=this.cols;while(--n){if(this.colYs[n]!==0)break;s++}i.width=(this.cols-s)*this.columnWidth-this.options.gutterWidth}this.styleQueue.push({$el:this.element,style:i});var o=this.isLaidOut?this.options.isAnimated?"animate":"css":"css",u=this.options.animationOptions,a;for(n=0,r=this.styleQueue.length;n<r;n++)a=this.styleQueue[n],a.$el[o](a.style,u);this.styleQueue=[],t&&t.call(e),this.isLaidOut=!0},_getColumns:function(){var e=this.options.isFitWidth?this.element.parent():this.element,t=e.width();this.columnWidth=this.isFluid?this.options.columnWidth(t):this.options.columnWidth||this.$bricks.outerWidth(!0)||t,this.columnWidth+=this.options.gutterWidth,this.cols=Math.floor((t+this.options.gutterWidth)/this.columnWidth),this.cols=Math.max(this.cols,1)},_placeBrick:function(e){var n=t(e),r,i,s,o,u;r=Math.ceil(n.outerWidth(!0)/this.columnWidth),r=Math.min(r,this.cols);if(r===1)s=this.colYs;else{i=this.cols+1-r,s=[];for(u=0;u<i;u++)o=this.colYs.slice(u,u+r),s[u]=Math.max.apply(Math,o)}var a=Math.min.apply(Math,s),f=0;for(var l=0,c=s.length;l<c;l++)if(s[l]===a){f=l;break}var h={top:a+this.offset.y};h[this.horizontalDirection]=this.columnWidth*f+this.offset.x,this.styleQueue.push({$el:n,style:h});var p=a+n.outerHeight(!0),d=this.cols+1-c;for(l=0;l<d;l++)this.colYs[f+l]=p},resize:function(){var e=this.cols;this._getColumns(),(this.isFluid||this.cols!==e)&&this._reLayout()},_reLayout:function(e){var t=this.cols;this.colYs=[];while(t--)this.colYs.push(0);this.layout(this.$bricks,e)},reloadItems:function(){this.$bricks=this._getBricks(this.element.children())},reload:function(e){this.reloadItems(),this._init(e)},appended:function(e,t,n){if(t){this._filterFindBricks(e).css({top:this.element.height()});var r=this;setTimeout(function(){r._appended(e,n)},1)}else this._appended(e,n)},_appended:function(e,t){var n=this._getBricks(e);this.$bricks=this.$bricks.add(n),this.layout(n,t)},remove:function(e){this.$bricks=this.$bricks.not(e),e.remove()},destroy:function(){this.$bricks.removeClass("masonry-brick").each(function(){this.style.position="",this.style.top="",this.style.left=""});var n=this.element[0].style;for(var r in this.originalStyle)n[r]=this.originalStyle[r];this.element.unbind(".masonry").removeClass("masonry").removeData("masonry"),t(e).unbind(".masonry")}};var s=function(t){e.console&&e.console.error(t)};t.fn.masonry=function(e){if(typeof e=="string"){var n=Array.prototype.slice.call(arguments,1);this.each(function(){var r=t.data(this,"masonry");if(!r){s("cannot call methods on masonry prior to initialization; attempted to call method '"+e+"'");return}if(!t.isFunction(r[e])||e.charAt(0)==="_"){s("no such method '"+e+"' for masonry instance");return}r[e].apply(r,n)})}else this.each(function(){var n=t.data(this,"masonry");n?(n.option(e||{}),n._init()):t.data(this,"masonry",new t.Mason(e,this))});return this}})(window,jQuery);


// http://desandro.github.io/masonry/demos/corner-stamp.html
// Masonry corner stamp modifications
$.Mason.prototype.resize = function() {
  this._getColumns();
  this._reLayout();
};

$.Mason.prototype._reLayout = function(callback) {
  var freeCols = this.cols,
      $cornerStamp = $(this.options.cornerStamp).filter(function() {
        return $(this).height() > 0;
      });

  if ($cornerStamp.length) {
    if ($cornerStamp && $cornerStamp.length === 1) {
      var cornerStampX = $cornerStamp.offset().left -
        (this.element.offset().left + this.offset.x + parseInt($cornerStamp.css('marginLeft')));
      freeCols = Math.floor(cornerStampX / this.columnWidth);
    }
  }
  // reset columns
  var i = this.cols;

  this.colYs = [];
  while (i--) {
    this.colYs.push(this.offset.y);
  }

  if ($cornerStamp.length) {
    var colShift = $cornerStamp.offset().top - this.element.offset().top + $cornerStamp.outerHeight(true);

    for (i = freeCols; i < this.cols; i++) {
      this.colYs[i] = this.offset.y + colShift;
    }
  }

  // apply layout logic to all bricks
  this.layout(this.$bricks, callback);
};
/*! Copyright (c) 2011 Brandon Aaron (http://brandonaaron.net)
 * Licensed under the MIT License (LICENSE.txt).
 *
 * Thanks to: http://adomas.org/javascript-mouse-wheel/ for some pointers.
 * Thanks to: Mathias Bank(http://www.mathias-bank.de) for a scope bug fix.
 * Thanks to: Seamus Leahy for adding deltaX and deltaY
 *
 * Version: 3.0.6
 * 
 * Requires: 1.2.2+
 */


(function($) {

var types = ['DOMMouseScroll', 'mousewheel'];

if ($.event.fixHooks) {
    for ( var i=types.length; i; ) {
        $.event.fixHooks[ types[--i] ] = $.event.mouseHooks;
    }
}

$.event.special.mousewheel = {
    setup: function() {
        if ( this.addEventListener ) {
            for ( var i=types.length; i; ) {
                this.addEventListener( types[--i], handler, false );
            }
        } else {
            this.onmousewheel = handler;
        }
    },
    
    teardown: function() {
        if ( this.removeEventListener ) {
            for ( var i=types.length; i; ) {
                this.removeEventListener( types[--i], handler, false );
            }
        } else {
            this.onmousewheel = null;
        }
    }
};

$.fn.extend({
    mousewheel: function(fn) {
        return fn ? this.bind("mousewheel", fn) : this.trigger("mousewheel");
    },
    
    unmousewheel: function(fn) {
        return this.unbind("mousewheel", fn);
    }
});


function handler(event) {
    var orgEvent = event || window.event, args = [].slice.call( arguments, 1 ), delta = 0, returnValue = true, deltaX = 0, deltaY = 0;
    event = $.event.fix(orgEvent);
    event.type = "mousewheel";
    
    // Old school scrollwheel delta
    if ( orgEvent.wheelDelta ) { delta = orgEvent.wheelDelta/120; }
    if ( orgEvent.detail     ) { delta = -orgEvent.detail/3; }
    
    // New school multidimensional scroll (touchpads) deltas
    deltaY = delta;
    
    // Gecko
    if ( orgEvent.axis !== undefined && orgEvent.axis === orgEvent.HORIZONTAL_AXIS ) {
        deltaY = 0;
        deltaX = -1*delta;
    }
    
    // Webkit
    if ( orgEvent.wheelDeltaY !== undefined ) { deltaY = orgEvent.wheelDeltaY/120; }
    if ( orgEvent.wheelDeltaX !== undefined ) { deltaX = -1*orgEvent.wheelDeltaX/120; }
    
    // Add event and delta to the front of the arguments
    args.unshift(event, delta, deltaX, deltaY);
    
    return ($.event.dispatch || $.event.handle).apply(this, args);
}

})(jQuery);
/*
 * Password Strength (0.1.4)
 * by Sagie Maoz (n0nick.net)
 * n0nick@php.net
 *
 * This plugin will check the value of a password field and evaluate the
 * strength of the typed password. This is done by checking for
 * the diversity of character types: numbers, lowercase and uppercase
 * letters and special characters.
 *
 * Copyright (c) 2010 Sagie Maoz <n0nick@php.net>
 * Licensed under the GPL license, see http://www.gnu.org/licenses/gpl-3.0.html 
 *
 *
 * NOTE: This script requires jQuery to work.  Download jQuery at www.jquery.com
 *
 */


(function($){

var passwordStrength = new function()
{
	this.countRegexp = function(val, rex)
	{
		var match = val.match(rex);
		return match ? match.length : 0;
	};
	
	this.getStrength = function(val, minLength)
	{	
		var len = val.length;
		
		// too short =(
		if (len < minLength)
		{
			return 0;
		}
		
		var nums = this.countRegexp(val, /\d/g),
			lowers = this.countRegexp(val, /[a-z]/g),
			uppers = this.countRegexp(val, /[A-Z]/g),
			specials = len - nums - lowers - uppers;
		
		// just one type of characters =(
		if (nums == len || lowers == len || uppers == len || specials == len)
		{
			return 1;
		}
		
		var strength = 0;
		if (nums)	{ strength+= 2; }
		if (lowers)	{ strength+= uppers? 4 : 3; }
		if (uppers)	{ strength+= lowers? 4 : 3; }
		if (specials) { strength+= 5; }
		if (len > 10) { strength+= 1; }
		
		return strength;
	};
	
	this.getStrengthLevel = function(val, minLength)
	{
		var strength = this.getStrength(val, minLength);

		val = 1;
		if (strength <= 0) {
			val = 1;
		} else if (strength > 0 && strength <= 4) {
			val = 2;
		} else if (strength > 4 && strength <= 8) {
			val = 3;
		} else if (strength > 8 && strength <= 12) {
			val = 4;
		} else if (strength > 12) {
			val = 5;
		}

		return val;
	};
};

$.fn.password_strength = function(options)
{
	var settings = $.extend({
		'container' : null,
		'bar': null, // thanks codemonkeyking
		'minLength' : 6,
		'texts' : {
			1 : 'Too weak',
			2 : 'Weak password',
			3 : 'Normal strength',
			4 : 'Strong password',
			5 : 'Very strong password'
		},
		'onCheck': null
	}, options);
	
	return this.each(function()
	{
		var container = null, $bar = null;
		if (settings.container)
		{
			container = $(settings.container);
		}
		else
		{
			container = $('<span/>').attr('class', 'password_strength');
			$(this).after(container);
		}

		if (settings.bar)
		{
			$bar = $(settings.bar);
		}
		
		$(this).bind('keyup.password_strength', function()
		{
			var val = $(this).val(),
					level = passwordStrength.getStrengthLevel(val, settings.minLength);

			if (val.length > 0)
			{
				var _class = 'password_strength_' + level,
						_barClass = 'password_bar_' + level;
				
				if (!container.hasClass(_class) && level in settings.texts)
				{
					container.text(settings.texts[level]).attr('class', 'password_strength ' + _class);
				}
				if ($bar && !$bar.hasClass(_barClass))
				{
					$bar.attr('class', 'password_bar ' + _barClass);
				}
			}
			else
			{
				container.text('').attr('class', 'password_strength');
				if ($bar) {
					$bar.attr('class', 'password_bar');
				}
			}
			if (settings.onCheck) {
				settings.onCheck.call(this, level);
			}
		});

		if ($(this).val() != '') { // thanks Jason Judge
				$(this).trigger('keyup.password_strength');
		}
	});
};

})(jQuery);
(function($){
  var special = jQuery.event.special;
  var handlers = [];
  var timeout = null;
  
  var fireHandlers = function() {
    for (var i in handlers) {
      handlers[i].handler();
    }
  }

  var scrollHandler = function() {
    if (timeout) { clearTimeout(timeout) };
    timeout = setTimeout(fireHandlers, 200);
  }

  $.event.special.periodic_scroll = {
    setup: function(){
      $(this).bind("scroll", scrollHandler);
    },
    teardown: function(){
      $(this).unbind('scroll', scrollHandler);
    },
    add: function(handleObj) {
      handlers.push(handleObj);
    },
    remove: function(handleObj) {
      var outArr = [];
      for(var i in handlers) {
        if (handlers[i] != handleObj) {
          outArr.push(handlers[i]);
        }
      }

      handlers = outArr;
    }
  };

})(jQuery);

(function ($) {
  $(document).on('change keydown keypress input', 'div[data-placeholder]', function() {
    if (this.textContent) {
      this.setAttribute('data-div-placeholder-content', 'true');
    }
    else {
      this.removeAttribute('data-div-placeholder-content');
    }
  });
})(jQuery);
/*!
 * jQuery postMessage - v0.5 - 9/11/2009
 * http://benalman.com/projects/jquery-postmessage-plugin/
 * 
 * Copyright (c) 2009 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */

// Script: jQuery postMessage: Cross-domain scripting goodness
//
// *Version: 0.5, Last updated: 9/11/2009*
// 
// Project Home - http://benalman.com/projects/jquery-postmessage-plugin/
// GitHub       - http://github.com/cowboy/jquery-postmessage/
// Source       - http://github.com/cowboy/jquery-postmessage/raw/master/jquery.ba-postmessage.js
// (Minified)   - http://github.com/cowboy/jquery-postmessage/raw/master/jquery.ba-postmessage.min.js (0.9kb)
// 
// About: License
// 
// Copyright (c) 2009 "Cowboy" Ben Alman,
// Dual licensed under the MIT and GPL licenses.
// http://benalman.com/about/license/
// 
// About: Examples
// 
// This working example, complete with fully commented code, illustrates one
// way in which this plugin can be used.
// 
// Iframe resizing - http://benalman.com/code/projects/jquery-postmessage/examples/iframe/
// 
// About: Support and Testing
// 
// Information about what version or versions of jQuery this plugin has been
// tested with and what browsers it has been tested in.
// 
// jQuery Versions - 1.3.2
// Browsers Tested - Internet Explorer 6-8, Firefox 3, Safari 3-4, Chrome, Opera 9.
// 
// About: Release History
// 
// 0.5 - (9/11/2009) Improved cache-busting
// 0.4 - (8/25/2009) Initial release

(function($){
  '$:nomunge'; // Used by YUI compressor.
  
  // A few vars used in non-awesome browsers.
  var interval_id,
    last_hash,
    cache_bust = 1,
    
    // A var used in awesome browsers.
    rm_callback,
    
    // A few convenient shortcuts.
    window = this,
    FALSE = false,
    
    // Reused internal strings.
    postMessage = 'postMessage',
    addEventListener = 'addEventListener',
    
    p_receiveMessage,
    
    // I couldn't get window.postMessage to actually work in Opera 9.64!
    has_postMessage = window[postMessage];
  
  // Method: jQuery.postMessage
  // 
  // This method will call window.postMessage if available, setting the
  // targetOrigin parameter to the base of the target_url parameter for maximum
  // security in browsers that support it. If window.postMessage is not available,
  // the target window's location.hash will be used to pass the message. If an
  // object is passed as the message param, it will be serialized into a string
  // using the jQuery.param method.
  // 
  // Usage:
  // 
  // > jQuery.postMessage( message, target_url [, target ] );
  // 
  // Arguments:
  // 
  //  message - (String) A message to be passed to the other frame.
  //  message - (Object) An object to be serialized into a params string, using
  //    the jQuery.param method.
  //  target_url - (String) The URL of the other frame this window is
  //    attempting to communicate with. This must be the exact URL (including
  //    any query string) of the other window for this script to work in
  //    browsers that don't support window.postMessage.
  //  target - (Object) A reference to the other frame this window is
  //    attempting to communicate with. If omitted, defaults to `parent`.
  // 
  // Returns:
  // 
  //  Nothing.
  
  $[postMessage] = function( message, target_url, target ) {
    if ( !target_url ) { return; }
    
    // Serialize the message if not a string. Note that this is the only real
    // jQuery dependency for this script. If removed, this script could be
    // written as very basic JavaScript.
    message = typeof message === 'string' ? message : $.param( message );
    
    // Default to parent if unspecified.
    target = target || parent;
    
    if ( has_postMessage ) {
      // The browser supports window.postMessage, so call it with a targetOrigin
      // set appropriately, based on the target_url parameter.
      target[postMessage]( message, target_url.replace( /([^:]+:\/\/[^\/]+).*/, '$1' ) );
      
    } else if ( target_url ) {
      // The browser does not support window.postMessage, so set the location
      // of the target to target_url#message. A bit ugly, but it works! A cache
      // bust parameter is added to ensure that repeat messages trigger the
      // callback.
      target.location = target_url.replace( /#.*$/, '' ) + '#' + (+new Date) + (cache_bust++) + '&' + message;
    }
  };
  
  // Method: jQuery.receiveMessage
  // 
  // Register a single callback for either a window.postMessage call, if
  // supported, or if unsupported, for any change in the current window
  // location.hash. If window.postMessage is supported and source_origin is
  // specified, the source window will be checked against this for maximum
  // security. If window.postMessage is unsupported, a polling loop will be
  // started to watch for changes to the location.hash.
  // 
  // Note that for simplicity's sake, only a single callback can be registered
  // at one time. Passing no params will unbind this event (or stop the polling
  // loop), and calling this method a second time with another callback will
  // unbind the event (or stop the polling loop) first, before binding the new
  // callback.
  // 
  // Also note that if window.postMessage is available, the optional
  // source_origin param will be used to test the event.origin property. From
  // the MDC window.postMessage docs: This string is the concatenation of the
  // protocol and "://", the host name if one exists, and ":" followed by a port
  // number if a port is present and differs from the default port for the given
  // protocol. Examples of typical origins are https://example.org (implying
  // port 443), http://example.net (implying port 80), and http://example.com:8080.
  // 
  // Usage:
  // 
  // > jQuery.receiveMessage( callback [, source_origin ] [, delay ] );
  // 
  // Arguments:
  // 
  //  callback - (Function) This callback will execute whenever a <jQuery.postMessage>
  //    message is received, provided the source_origin matches. If callback is
  //    omitted, any existing receiveMessage event bind or polling loop will be
  //    canceled.
  //  source_origin - (String) If window.postMessage is available and this value
  //    is not equal to the event.origin property, the callback will not be
  //    called.
  //  source_origin - (Function) If window.postMessage is available and this
  //    function returns false when passed the event.origin property, the
  //    callback will not be called.
  //  delay - (Number) An optional zero-or-greater delay in milliseconds at
  //    which the polling loop will execute (for browser that don't support
  //    window.postMessage). If omitted, defaults to 100.
  // 
  // Returns:
  // 
  //  Nothing!
  
  $.receiveMessage = p_receiveMessage = function( callback, source_origin, delay ) {
    if ( has_postMessage ) {
      // Since the browser supports window.postMessage, the callback will be
      // bound to the actual event associated with window.postMessage.
      
      if ( callback ) {
        // Unbind an existing callback if it exists.
        rm_callback && p_receiveMessage();
        
        // Bind the callback. A reference to the callback is stored for ease of
        // unbinding.
        rm_callback = function(e) {
          if ( ( typeof source_origin === 'string' && e.origin !== source_origin )
            || ( $.isFunction( source_origin ) && source_origin( e.origin ) === FALSE ) ) {
            return FALSE;
          }
          callback( e );
        };
      }
      
      if ( window[addEventListener] ) {
        window[ callback ? addEventListener : 'removeEventListener' ]( 'message', rm_callback, FALSE );
      } else {
        window[ callback ? 'attachEvent' : 'detachEvent' ]( 'onmessage', rm_callback );
      }
      
    } else {
      // Since the browser sucks, a polling loop will be started, and the
      // callback will be called whenever the location.hash changes.
      
      interval_id && clearInterval( interval_id );
      interval_id = null;
      
      if ( callback ) {
        delay = typeof source_origin === 'number'
          ? source_origin
          : typeof delay === 'number'
            ? delay
            : 100;
        
        interval_id = setInterval(function(){
          var hash = document.location.hash,
            re = /^#?\d+&/;
          if ( hash !== last_hash && re.test( hash ) ) {
            last_hash = hash;
            callback({ data: hash.replace( re, '' ) });
          }
        }, delay );
      }
    }
  };
  
})(jQuery);

/*
 * Copyright 2011 Andrey “A.I.” Sitnik <andrey@sitnik.ru>,
 * sponsored by Evil Martians.
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 * 
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

/*
 * Add shortcuts to make PUT and DELETE AJAX requests.
 * 
 * Shorcuts create POST request and override HTTP method by
 * X-HTTP-Method-Override header.
 */

;(function($) {
    var methods = {}
    $.each({ put: 'PUT', del: 'DELETE' }, function(prop, method) {
        methods[prop] = function(url, data, callback, type) {
            if ($.isFunction(data)) {
                type = type || callback
                callback = data
                data = { }
            }
            
            return $.ajax({ headers: { 'X-HTTP-Method-Override': method },
                            type:    'POST',
                            url:     url,
                            data:    data,
                            success: callback,
                            dataType: type })
        }
    })
    $.extend(methods)
})(jQuery);

//
// Use internal $.serializeArray to get list of form elements which is
// consistent with $.serialize
//
// From version 2.0.0, $.serializeObject will stop converting [name] values
// to camelCase format. This is *consistent* with other serialize methods:
//
//   - $.serialize
//   - $.serializeArray
//
// If you require camel casing, you can either download version 1.0.4 or map
// them yourself.
//

(function($){
	$.fn.serializeObject = function () {
		"use strict";

		var result = {};
		var extend = function (i, element) {
			var node = result[element.name];

	// If node with same name exists already, need to convert it to an array as it
	// is a multi-value field (i.e., checkboxes)

			if ('undefined' !== typeof node && node !== null) {
				if ($.isArray(node)) {
					node.push(element.value);
				} else {
					result[element.name] = [node, element.value];
				}
			} else {
				result[element.name] = element.value;
			}
		};

		$.each(this.serializeArray(), extend);
		return result;
	};
})(jQuery);
/*
 * jQuery store - Plugin for persistent data storage using localStorage, userData (and window.name)
 * 
 * Authors: Rodney Rehm
 * Web: http://medialize.github.com/jQuery-store/
 * 
 * Licensed under the MIT License:
 *   http://www.opensource.org/licenses/mit-license.php
 *
 */

/**********************************************************************************
 * INITIALIZE EXAMPLES:
 **********************************************************************************
 * 	// automatically detect best suited storage driver and use default serializers
 *	$.storage = new $.store();
 *	// optionally initialize with specific driver and or serializers
 *	$.storage = new $.store( [driver] [, serializers] );
 *		driver		can be the key (e.g. "windowName") or the driver-object itself
 *		serializers	can be a list of named serializers like $.store.serializers
 **********************************************************************************
 * USAGE EXAMPLES:
 **********************************************************************************
 *	$.storage.get( key );			// retrieves a value
 *	$.storage.set( key, value );	// saves a value
 *	$.storage.del( key );			// deletes a value
 *	$.storage.flush();				// deletes aall values
 **********************************************************************************
 */


(function($,undefined){

/**********************************************************************************
 * $.store base and convinience accessor
 **********************************************************************************/

$.store = function( driver, serializers )
{
	var that = this;
	
	if( typeof driver == 'string' )
	{
		if( $.store.drivers[ driver ] )
			this.driver = $.store.drivers[ driver ];
		else
			throw new Error( 'Unknown driver '+ driver );
	}
	else if( typeof driver == 'object' )
	{
		var invalidAPI = !$.isFunction( driver.init )
			|| !$.isFunction( driver.get )
			|| !$.isFunction( driver.set )
			|| !$.isFunction( driver.del )
			|| !$.isFunction( driver.flush );
			
		if( invalidAPI )
			throw new Error( 'The specified driver does not fulfill the API requirements' );
		
		this.driver = driver;
	}
	else
	{
		// detect and initialize storage driver
		$.each( $.store.drivers, function()
		{
			// skip unavailable drivers
			if( !$.isFunction( this.available ) || !this.available() )
				return true; // continue;
			
			that.driver = this;
			if( that.driver.init() === false )
			{
				that.driver = null;
				return true; // continue;
			}
			
			return false; // break;
		});
	}
	
	// use default serializers if not told otherwise
	if( !serializers )
		serializers = $.store.serializers;
	
	// intialize serializers
	this.serializers = {};
	$.each( serializers, function( key, serializer )
	{
		// skip invalid processors
		if( !$.isFunction( this.init ) )
			return true; // continue;
		
		that.serializers[ key ] = this;
		that.serializers[ key ].init( that.encoders, that.decoders );
	});
};


/**********************************************************************************
 * $.store API
 **********************************************************************************/

$.extend( $.store.prototype, {
	get: function( key )
	{
		var value = this.driver.get( key );
		return this.driver.encodes ? value : this.unserialize( value );
	},
	set: function( key, value )
	{
		this.driver.set( key, this.driver.encodes ? value : this.serialize( value ) );
	},
	del: function( key )
	{
		this.driver.del( key );
	},
	flush: function()
	{
		this.driver.flush();
	},
	driver : undefined,
	encoders : [],
	decoders : [],
	serialize: function( value )
	{
		var that = this;
		
		$.each( this.encoders, function()
		{
			var serializer = that.serializers[ this + "" ];
			if( !serializer || !serializer.encode )
				return true; // continue;
			try
			{
				value = serializer.encode( value );
			}
			catch( e ){}
		});

		return value;
	},
	unserialize: function( value )
	{
		var that = this;
		if( !value )
			return value;
		
		$.each( this.decoders, function()
		{
			var serializer = that.serializers[ this + "" ];
			if( !serializer || !serializer.decode )
				return true; // continue;

			value = serializer.decode( value );
		});

		return value;
	}
});


/**********************************************************************************
 * $.store drivers
 **********************************************************************************/

$.store.drivers = {
	// Firefox 3.5, Safari 4.0, Chrome 5, Opera 10.5, IE8
	'localStorage': {
		// see https://developer.mozilla.org/en/dom/storage#localStorage
		ident: "$.store.drivers.localStorage",
		scope: 'browser',
		available: function()
		{
			try
			{
				// Firefox won't allow localStorage if cookies are disabled
				if (!!window.localStorage) {
					// Safari's "Private" mode throws a QUOTA_EXCEEDED_ERR on setItem
					window.localStorage.setItem("jQuery Store Availability test", true);
					window.localStorage.removeItem("jQuery Store Availability test");
					return true;
				};
				return false;
			}
			catch(e)
			{
				return false;
			}
		},
		init: $.noop,
		get: function( key )
		{
			return window.localStorage.getItem( key );
		},
		set: function( key, value )
		{
			window.localStorage.setItem( key, value );
		},
		del: function( key )
		{
			window.localStorage.removeItem( key );
		},
		flush: function()
		{
			window.localStorage.clear();
		}
	},
	
	// IE6, IE7
	'userData': {
		// see http://msdn.microsoft.com/en-us/library/ms531424.aspx
		ident: "$.store.drivers.userData",
		element: null,
		nodeName: 'userdatadriver',
		scope: 'browser',
		initialized: false,
		available: function()
		{
			try
			{
				return !!( document.documentElement && document.documentElement.addBehavior );
			}
			catch(e)
			{
				return false;
			}
		},
		init: function()
		{
			// $.store can only utilize one userData store at a time, thus avoid duplicate initialization
			if( this.initialized )
				return;
			
			try
			{
				// Create a non-existing element and append it to the root element (html)
				this.element = document.createElement( this.nodeName );
				document.documentElement.insertBefore( this.element, document.getElementsByTagName('title')[0] );
				// Apply userData behavior
				this.element.addBehavior( "#default#userData" );
				this.initialized = true;
			}
			catch( e )
			{
				return false; 
			}
		},
		get: function( key )
		{
			this.element.load( this.nodeName );
			return this.element.getAttribute( key );
		},
		set: function( key, value )
		{
			this.element.setAttribute( key, value );
			this.element.save( this.nodeName );
		},
		del: function( key )
		{
			this.element.removeAttribute( key );
			this.element.save( this.nodeName );
			
		},
		flush: function()
		{
			// flush by expiration
			var attrs = this.element.xmlDocument.firstChild.attributes;
			for (var i = attrs.length - 1; i >= 0; i--) {
				this.element.removeAttribute( attrs[i].nodeName );
			}
        		this.element.save( this.nodeName );
		}
	},
	
	// most other browsers
	'windowName': {
		ident: "$.store.drivers.windowName",
		scope: 'window',
		cache: {},
		encodes: true,
		available: function()
		{
			return true;
		},
		init: function()
		{
			this.load();
		},
		save: function()
		{
			window.name = $.store.serializers.json.encode( this.cache );
		},
		load: function()
		{
			try
			{
				this.cache = $.store.serializers.json.decode( window.name + "" );
				if( typeof this.cache != "object" )
					this.cache = {};
			}
			catch(e)
			{
				this.cache = {};
				window.name = "{}";
			}
		},
		get: function( key )
		{
			return this.cache[ key ];
		},
		set: function( key, value )
		{
			this.cache[ key ] = value;
			this.save();
		},
		del: function( key )
		{
			try
			{
				delete this.cache[ key ];
			}
			catch(e)
			{
				this.cache[ key ] = undefined;
			}
			
			this.save();
		},
		flush: function()
		{
			window.name = "{}";
		}
	}
};

/**********************************************************************************
 * $.store serializers
 **********************************************************************************/

$.store.serializers = {
	
	'json': {
		ident: "$.store.serializers.json",
		init: function( encoders, decoders )
		{
			encoders.push( "json" );
			decoders.push( "json" );
		},
		encode: JSON.stringify,
		decode: JSON.parse
	},
	
	// TODO: html serializer
	// 'html' : {},
	
	'xml': {
		ident: "$.store.serializers.xml",
		init: function( encoders, decoders )
		{
			encoders.unshift( "xml" );
			decoders.push( "xml" );
		},
		
		// wouldn't be necessary if jQuery exposed this function
		isXML: function( value )
		{
			var documentElement = ( value ? value.ownerDocument || value : 0 ).documentElement;
			return documentElement ? documentElement.nodeName.toLowerCase() !== "html" : false;
		},

		// encodes a XML node to string (taken from $.jStorage, MIT License)
		encode: function( value )
		{
			if( !value || value._serialized || !this.isXML( value ) )
				return value;

			var _value = { _serialized: this.ident, value: value };
			
			try
			{
				// Mozilla, Webkit, Opera
				_value.value = new XMLSerializer().serializeToString( value );
				return _value;
			}
			catch(E1)
			{
				try
				{
					// Internet Explorer
					_value.value = value.xml;
					return _value;
				}
				catch(E2){}
			}
			
			return value;
		},
		
		// decodes a XML node from string (taken from $.jStorage, MIT License)
		decode: function( value )
		{
			if( !value || !value._serialized || value._serialized != this.ident )
				return value;

			var dom_parser = ( "DOMParser" in window && (new DOMParser()).parseFromString );
			if( !dom_parser && window.ActiveXObject )
			{
				dom_parser = function( _xmlString )
				{
					var xml_doc = new ActiveXObject( 'Microsoft.XMLDOM' );
					xml_doc.async = 'false';
					xml_doc.loadXML( _xmlString );
					return xml_doc;
				}
			}

			if( !dom_parser )
			{
				return undefined;
			}
			
			value.value = dom_parser.call(
				"DOMParser" in window && (new DOMParser()) || window, 
				value.value, 
				'text/xml'
			);
			
			return this.isXML( value.value ) ? value.value : undefined;
		}
	}
};

})(jQuery);
/*! jQuery Validation Plugin - v1.11.0 - 2/4/2013
* https://github.com/jzaefferer/jquery-validation
* Copyright (c) 2013 JÃ¶rn Zaefferer; Licensed MIT */

(function(e){e.extend(e.fn,{validate:function(t){if(!this.length){t&&t.debug&&window.console&&console.warn("Nothing selected, can't validate, returning nothing.");return}var n=e.data(this[0],"validator");return n?n:(this.attr("novalidate","novalidate"),n=new e.validator(t,this[0]),e.data(this[0],"validator",n),n.settings.onsubmit&&(this.validateDelegate(":submit","click",function(t){n.settings.submitHandler&&(n.submitButton=t.target),e(t.target).hasClass("cancel")&&(n.cancelSubmit=!0)}),this.submit(function(t){function r(){var r;return n.settings.submitHandler?(n.submitButton&&(r=e("<input type='hidden'/>").attr("name",n.submitButton.name).val(n.submitButton.value).appendTo(n.currentForm)),n.settings.submitHandler.call(n,n.currentForm,t),n.submitButton&&r.remove(),!1):!0}return n.settings.debug&&t.preventDefault(),n.cancelSubmit?(n.cancelSubmit=!1,r()):n.form()?n.pendingRequest?(n.formSubmitted=!0,!1):r():(n.focusInvalid(),!1)})),n)},valid:function(){if(e(this[0]).is("form"))return this.validate().form();var t=!0,n=e(this[0].form).validate();return this.each(function(){t&=n.element(this)}),t},removeAttrs:function(t){var n={},r=this;return e.each(t.split(/\s/),function(e,t){n[t]=r.attr(t),r.removeAttr(t)}),n},rules:function(t,n){var r=this[0];if(t){var i=e.data(r.form,"validator").settings,s=i.rules,o=e.validator.staticRules(r);switch(t){case"add":e.extend(o,e.validator.normalizeRule(n)),s[r.name]=o,n.messages&&(i.messages[r.name]=e.extend(i.messages[r.name],n.messages));break;case"remove":if(!n)return delete s[r.name],o;var u={};return e.each(n.split(/\s/),function(e,t){u[t]=o[t],delete o[t]}),u}}var a=e.validator.normalizeRules(e.extend({},e.validator.classRules(r),e.validator.attributeRules(r),e.validator.dataRules(r),e.validator.staticRules(r)),r);if(a.required){var f=a.required;delete a.required,a=e.extend({required:f},a)}return a}}),e.extend(e.expr[":"],{blank:function(t){return!e.trim(""+t.value)},filled:function(t){return!!e.trim(""+t.value)},unchecked:function(e){return!e.checked}}),e.validator=function(t,n){this.settings=e.extend(!0,{},e.validator.defaults,t),this.currentForm=n,this.init()},e.validator.format=function(t,n){return arguments.length===1?function(){var n=e.makeArray(arguments);return n.unshift(t),e.validator.format.apply(this,n)}:(arguments.length>2&&n.constructor!==Array&&(n=e.makeArray(arguments).slice(1)),n.constructor!==Array&&(n=[n]),e.each(n,function(e,n){t=t.replace(new RegExp("\\{"+e+"\\}","g"),function(){return n})}),t)},e.extend(e.validator,{defaults:{messages:{},groups:{},rules:{},errorClass:"error",validClass:"valid",errorElement:"label",focusInvalid:!0,errorContainer:e([]),errorLabelContainer:e([]),onsubmit:!0,ignore:":hidden",ignoreTitle:!1,onfocusin:function(e,t){this.lastActive=e,this.settings.focusCleanup&&!this.blockFocusCleanup&&(this.settings.unhighlight&&this.settings.unhighlight.call(this,e,this.settings.errorClass,this.settings.validClass),this.addWrapper(this.errorsFor(e)).hide())},onfocusout:function(e,t){!this.checkable(e)&&(e.name in this.submitted||!this.optional(e))&&this.element(e)},onkeyup:function(e,t){if(t.which===9&&this.elementValue(e)==="")return;(e.name in this.submitted||e===this.lastElement)&&this.element(e)},onclick:function(e,t){e.name in this.submitted?this.element(e):e.parentNode.name in this.submitted&&this.element(e.parentNode)},highlight:function(t,n,r){t.type==="radio"?this.findByName(t.name).addClass(n).removeClass(r):e(t).addClass(n).removeClass(r)},unhighlight:function(t,n,r){t.type==="radio"?this.findByName(t.name).removeClass(n).addClass(r):e(t).removeClass(n).addClass(r)}},setDefaults:function(t){e.extend(e.validator.defaults,t)},messages:{required:"This field is required.",remote:"Please fix this field.",email:"Please enter a valid email address.",url:"Please enter a valid URL.",date:"Please enter a valid date.",dateISO:"Please enter a valid date (ISO).",number:"Please enter a valid number.",digits:"Please enter only digits.",creditcard:"Please enter a valid credit card number.",equalTo:"Please enter the same value again.",maxlength:e.validator.format("Please enter no more than {0} characters."),minlength:e.validator.format("Please enter at least {0} characters."),rangelength:e.validator.format("Please enter a value between {0} and {1} characters long."),range:e.validator.format("Please enter a value between {0} and {1}."),max:e.validator.format("Please enter a value less than or equal to {0}."),min:e.validator.format("Please enter a value greater than or equal to {0}.")},autoCreateRanges:!1,prototype:{init:function(){function r(t){var n=e.data(this[0].form,"validator"),r="on"+t.type.replace(/^validate/,"");n.settings[r]&&n.settings[r].call(n,this[0],t)}this.labelContainer=e(this.settings.errorLabelContainer),this.errorContext=this.labelContainer.length&&this.labelContainer||e(this.currentForm),this.containers=e(this.settings.errorContainer).add(this.settings.errorLabelContainer),this.submitted={},this.valueCache={},this.pendingRequest=0,this.pending={},this.invalid={},this.reset();var t=this.groups={};e.each(this.settings.groups,function(n,r){typeof r=="string"&&(r=r.split(/\s/)),e.each(r,function(e,r){t[r]=n})});var n=this.settings.rules;e.each(n,function(t,r){n[t]=e.validator.normalizeRule(r)}),e(this.currentForm).validateDelegate(":text, [type='password'], [type='file'], select, textarea, [type='number'], [type='search'] ,[type='tel'], [type='url'], [type='email'], [type='datetime'], [type='date'], [type='month'], [type='week'], [type='time'], [type='datetime-local'], [type='range'], [type='color'] ","focusin focusout keyup",r).validateDelegate("[type='radio'], [type='checkbox'], select, option","click",r),this.settings.invalidHandler&&e(this.currentForm).bind("invalid-form.validate",this.settings.invalidHandler)},form:function(){return this.checkForm(),e.extend(this.submitted,this.errorMap),this.invalid=e.extend({},this.errorMap),this.valid()||e(this.currentForm).triggerHandler("invalid-form",[this]),this.showErrors(),this.valid()},checkForm:function(){this.prepareForm();for(var e=0,t=this.currentElements=this.elements();t[e];e++)this.check(t[e]);return this.valid()},element:function(t){t=this.validationTargetFor(this.clean(t)),this.lastElement=t,this.prepareElement(t),this.currentElements=e(t);var n=this.check(t)!==!1;return n?delete this.invalid[t.name]:this.invalid[t.name]=!0,this.numberOfInvalids()||(this.toHide=this.toHide.add(this.containers)),this.showErrors(),n},showErrors:function(t){if(t){e.extend(this.errorMap,t),this.errorList=[];for(var n in t)this.errorList.push({message:t[n],element:this.findByName(n)[0]});this.successList=e.grep(this.successList,function(e){return!(e.name in t)})}this.settings.showErrors?this.settings.showErrors.call(this,this.errorMap,this.errorList):this.defaultShowErrors()},resetForm:function(){e.fn.resetForm&&e(this.currentForm).resetForm(),this.submitted={},this.lastElement=null,this.prepareForm(),this.hideErrors(),this.elements().removeClass(this.settings.errorClass).removeData("previousValue")},numberOfInvalids:function(){return this.objectLength(this.invalid)},objectLength:function(e){var t=0;for(var n in e)t++;return t},hideErrors:function(){this.addWrapper(this.toHide).hide()},valid:function(){return this.size()===0},size:function(){return this.errorList.length},focusInvalid:function(){if(this.settings.focusInvalid)try{e(this.findLastActive()||this.errorList.length&&this.errorList[0].element||[]).filter(":visible").focus().trigger("focusin")}catch(t){}},findLastActive:function(){var t=this.lastActive;return t&&e.grep(this.errorList,function(e){return e.element.name===t.name}).length===1&&t},elements:function(){var t=this,n={};return e(this.currentForm).find("input, select, textarea").not(":submit, :reset, :image, [disabled]").not(this.settings.ignore).filter(function(){return!this.name&&t.settings.debug&&window.console&&console.error("%o has no name assigned",this),this.name in n||!t.objectLength(e(this).rules())?!1:(n[this.name]=!0,!0)})},clean:function(t){return e(t)[0]},errors:function(){var t=this.settings.errorClass.replace(" ",".");return e(this.settings.errorElement+"."+t,this.errorContext)},reset:function(){this.successList=[],this.errorList=[],this.errorMap={},this.toShow=e([]),this.toHide=e([]),this.currentElements=e([])},prepareForm:function(){this.reset(),this.toHide=this.errors().add(this.containers)},prepareElement:function(e){this.reset(),this.toHide=this.errorsFor(e)},elementValue:function(t){var n=e(t).attr("type"),r=e(t).val();return n==="radio"||n==="checkbox"?e("input[name='"+e(t).attr("name")+"']:checked").val():typeof r=="string"?r.replace(/\r/g,""):r},check:function(t){t=this.validationTargetFor(this.clean(t));var n=e(t).rules(),r=!1,i=this.elementValue(t),s;for(var o in n){var u={method:o,parameters:n[o]};try{s=e.validator.methods[o].call(this,i,t,u.parameters);if(s==="dependency-mismatch"){r=!0;continue}r=!1;if(s==="pending"){this.toHide=this.toHide.not(this.errorsFor(t));return}if(!s)return this.formatAndAdd(t,u),!1}catch(a){throw this.settings.debug&&window.console&&console.log("Exception occured when checking element "+t.id+", check the '"+u.method+"' method.",a),a}}if(r)return;return this.objectLength(n)&&this.successList.push(t),!0},customDataMessage:function(t,n){return e(t).data("msg-"+n.toLowerCase())||t.attributes&&e(t).attr("data-msg-"+n.toLowerCase())},customMessage:function(e,t){var n=this.settings.messages[e];return n&&(n.constructor===String?n:n[t])},findDefined:function(){for(var e=0;e<arguments.length;e++)if(arguments[e]!==undefined)return arguments[e];return undefined},defaultMessage:function(t,n){return this.findDefined(this.customMessage(t.name,n),this.customDataMessage(t,n),!this.settings.ignoreTitle&&t.title||undefined,e.validator.messages[n],"<strong>Warning: No message defined for "+t.name+"</strong>")},formatAndAdd:function(t,n){var r=this.defaultMessage(t,n.method),i=/\$?\{(\d+)\}/g;typeof r=="function"?r=r.call(this,n.parameters,t):i.test(r)&&(r=e.validator.format(r.replace(i,"{$1}"),n.parameters)),this.errorList.push({message:r,element:t}),this.errorMap[t.name]=r,this.submitted[t.name]=r},addWrapper:function(e){return this.settings.wrapper&&(e=e.add(e.parent(this.settings.wrapper))),e},defaultShowErrors:function(){var e,t;for(e=0;this.errorList[e];e++){var n=this.errorList[e];this.settings.highlight&&this.settings.highlight.call(this,n.element,this.settings.errorClass,this.settings.validClass),this.showLabel(n.element,n.message)}this.errorList.length&&(this.toShow=this.toShow.add(this.containers));if(this.settings.success)for(e=0;this.successList[e];e++)this.showLabel(this.successList[e]);if(this.settings.unhighlight)for(e=0,t=this.validElements();t[e];e++)this.settings.unhighlight.call(this,t[e],this.settings.errorClass,this.settings.validClass);this.toHide=this.toHide.not(this.toShow),this.hideErrors(),this.addWrapper(this.toShow).show()},validElements:function(){return this.currentElements.not(this.invalidElements())},invalidElements:function(){return e(this.errorList).map(function(){return this.element})},showLabel:function(t,n){var r=this.errorsFor(t);r.length?(r.removeClass(this.settings.validClass).addClass(this.settings.errorClass),r.html(n)):(r=e("<"+this.settings.errorElement+">").attr("for",this.idOrName(t)).addClass(this.settings.errorClass).html(n||""),this.settings.wrapper&&(r=r.hide().show().wrap("<"+this.settings.wrapper+"/>").parent()),this.labelContainer.append(r).length||(this.settings.errorPlacement?this.settings.errorPlacement(r,e(t)):r.insertAfter(t))),!n&&this.settings.success&&(r.text(""),typeof this.settings.success=="string"?r.addClass(this.settings.success):this.settings.success(r,t)),this.toShow=this.toShow.add(r)},errorsFor:function(t){var n=this.idOrName(t);return this.errors().filter(function(){return e(this).attr("for")===n})},idOrName:function(e){return this.groups[e.name]||(this.checkable(e)?e.name:e.id||e.name)},validationTargetFor:function(e){return this.checkable(e)&&(e=this.findByName(e.name).not(this.settings.ignore)[0]),e},checkable:function(e){return/radio|checkbox/i.test(e.type)},findByName:function(t){return e(this.currentForm).find("[name='"+t+"']")},getLength:function(t,n){switch(n.nodeName.toLowerCase()){case"select":return e("option:selected",n).length;case"input":if(this.checkable(n))return this.findByName(n.name).filter(":checked").length}return t.length},depend:function(e,t){return this.dependTypes[typeof e]?this.dependTypes[typeof e](e,t):!0},dependTypes:{"boolean":function(e,t){return e},string:function(t,n){return!!e(t,n.form).length},"function":function(e,t){return e(t)}},optional:function(t){var n=this.elementValue(t);return!e.validator.methods.required.call(this,n,t)&&"dependency-mismatch"},startRequest:function(e){this.pending[e.name]||(this.pendingRequest++,this.pending[e.name]=!0)},stopRequest:function(t,n){this.pendingRequest--,this.pendingRequest<0&&(this.pendingRequest=0),delete this.pending[t.name],n&&this.pendingRequest===0&&this.formSubmitted&&this.form()?(e(this.currentForm).submit(),this.formSubmitted=!1):!n&&this.pendingRequest===0&&this.formSubmitted&&(e(this.currentForm).triggerHandler("invalid-form",[this]),this.formSubmitted=!1)},previousValue:function(t){return e.data(t,"previousValue")||e.data(t,"previousValue",{old:null,valid:!0,message:this.defaultMessage(t,"remote")})}},classRuleSettings:{required:{required:!0},email:{email:!0},url:{url:!0},date:{date:!0},dateISO:{dateISO:!0},number:{number:!0},digits:{digits:!0},creditcard:{creditcard:!0}},addClassRules:function(t,n){t.constructor===String?this.classRuleSettings[t]=n:e.extend(this.classRuleSettings,t)},classRules:function(t){var n={},r=e(t).attr("class");return r&&e.each(r.split(" "),function(){this in e.validator.classRuleSettings&&e.extend(n,e.validator.classRuleSettings[this])}),n},attributeRules:function(t){var n={},r=e(t);for(var i in e.validator.methods){var s;i==="required"?(s=r.get(0).getAttribute(i),s===""&&(s=!0),s=!!s):s=r.attr(i),s?n[i]=s:r[0].getAttribute("type")===i&&(n[i]=!0)}return n.maxlength&&/-1|2147483647|524288/.test(n.maxlength)&&delete n.maxlength,n},dataRules:function(t){var n,r,i={},s=e(t);for(n in e.validator.methods)r=s.data("rule-"+n.toLowerCase()),r!==undefined&&(i[n]=r);return i},staticRules:function(t){var n={},r=e.data(t.form,"validator");return r.settings.rules&&(n=e.validator.normalizeRule(r.settings.rules[t.name])||{}),n},normalizeRules:function(t,n){return e.each(t,function(r,i){if(i===!1){delete t[r];return}if(i.param||i.depends){var s=!0;switch(typeof i.depends){case"string":s=!!e(i.depends,n.form).length;break;case"function":s=i.depends.call(n,n)}s?t[r]=i.param!==undefined?i.param:!0:delete t[r]}}),e.each(t,function(r,i){t[r]=e.isFunction(i)?i(n):i}),e.each(["minlength","maxlength"],function(){t[this]&&(t[this]=Number(t[this]))}),e.each(["rangelength"],function(){var n;t[this]&&(e.isArray(t[this])?t[this]=[Number(t[this][0]),Number(t[this][1])]:typeof t[this]=="string"&&(n=t[this].split(/[\s,]+/),t[this]=[Number(n[0]),Number(n[1])]))}),e.validator.autoCreateRanges&&(t.min&&t.max&&(t.range=[t.min,t.max],delete t.min,delete t.max),t.minlength&&t.maxlength&&(t.rangelength=[t.minlength,t.maxlength],delete t.minlength,delete t.maxlength)),t},normalizeRule:function(t){if(typeof t=="string"){var n={};e.each(t.split(/\s/),function(){n[this]=!0}),t=n}return t},addMethod:function(t,n,r){e.validator.methods[t]=n,e.validator.messages[t]=r!==undefined?r:e.validator.messages[t],n.length<3&&e.validator.addClassRules(t,e.validator.normalizeRule(t))},methods:{required:function(t,n,r){if(!this.depend(r,n))return"dependency-mismatch";if(n.nodeName.toLowerCase()==="select"){var i=e(n).val();return i&&i.length>0}return this.checkable(n)?this.getLength(t,n)>0:e.trim(t).length>0},remote:function(t,n,r){if(this.optional(n))return"dependency-mismatch";var i=this.previousValue(n);this.settings.messages[n.name]||(this.settings.messages[n.name]={}),i.originalMessage=this.settings.messages[n.name].remote,this.settings.messages[n.name].remote=i.message,r=typeof r=="string"&&{url:r}||r;if(i.old===t)return i.valid;i.old=t;var s=this;this.startRequest(n);var o={};return o[n.name]=t,e.ajax(e.extend(!0,{url:r,mode:"abort",port:"validate"+n.name,dataType:"json",data:o,success:function(r){s.settings.messages[n.name].remote=i.originalMessage;var o=r===!0||r==="true";if(o){var u=s.formSubmitted;s.prepareElement(n),s.formSubmitted=u,s.successList.push(n),delete s.invalid[n.name],s.showErrors()}else{var a={},f=r||s.defaultMessage(n,"remote");a[n.name]=i.message=e.isFunction(f)?f(t):f,s.invalid[n.name]=!0,s.showErrors(a)}i.valid=o,s.stopRequest(n,o)}},r)),"pending"},minlength:function(t,n,r){var i=e.isArray(t)?t.length:this.getLength(e.trim(t),n);return this.optional(n)||i>=r},maxlength:function(t,n,r){var i=e.isArray(t)?t.length:this.getLength(e.trim(t),n);return this.optional(n)||i<=r},rangelength:function(t,n,r){var i=e.isArray(t)?t.length:this.getLength(e.trim(t),n);return this.optional(n)||i>=r[0]&&i<=r[1]},min:function(e,t,n){return this.optional(t)||e>=n},max:function(e,t,n){return this.optional(t)||e<=n},range:function(e,t,n){return this.optional(t)||e>=n[0]&&e<=n[1]},email:function(e,t){return this.optional(t)||/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i.test(e)},url:function(e,t){return this.optional(t)||/^(https?|s?ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(e)},date:function(e,t){return this.optional(t)||!/Invalid|NaN/.test((new Date(e)).toString())},dateISO:function(e,t){return this.optional(t)||/^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}$/.test(e)},number:function(e,t){return this.optional(t)||/^-?(?:\d+|\d{1,3}(?:,\d{3})+)?(?:\.\d+)?$/.test(e)},digits:function(e,t){return this.optional(t)||/^\d+$/.test(e)},creditcard:function(e,t){if(this.optional(t))return"dependency-mismatch";if(/[^0-9 \-]+/.test(e))return!1;var n=0,r=0,i=!1;e=e.replace(/\D/g,"");for(var s=e.length-1;s>=0;s--){var o=e.charAt(s);r=parseInt(o,10),i&&(r*=2)>9&&(r-=9),n+=r,i=!i}return n%10===0},equalTo:function(t,n,r){var i=e(r);return this.settings.onfocusout&&i.unbind(".validate-equalTo").bind("blur.validate-equalTo",function(){e(n).valid()}),t===i.val()}}}),e.format=e.validator.format})(jQuery),function(e){var t={};if(e.ajaxPrefilter)e.ajaxPrefilter(function(e,n,r){var i=e.port;e.mode==="abort"&&(t[i]&&t[i].abort(),t[i]=r)});else{var n=e.ajax;e.ajax=function(r){var i=("mode"in r?r:e.ajaxSettings).mode,s=("port"in r?r:e.ajaxSettings).port;return i==="abort"?(t[s]&&t[s].abort(),t[s]=n.apply(this,arguments)):n.apply(this,arguments)}}}(jQuery),function(e){e.extend(e.fn,{validateDelegate:function(t,n,r){return this.bind(n,function(n){var i=e(n.target);if(i.is(t))return r.apply(i,arguments)})}})}(jQuery);
(function($) {
  var viewportOffset = function(el) {
    var o = $(el).offset()
    o.bottom = o.top + el.height();
    return o
  }

  var windowOffset = function(multiplier) {
    var obj = {
      top: $(window).scrollTop(),
      bottom: $(window).scrollTop() + $(window).height()
    }

    if (multiplier) {
      obj.top = obj.top - $(window).height() * multiplier;
      obj.bottom = obj.bottom + $(window).height() * multiplier;
    }

    return obj
  }

  $.inviewport = function(element, multiplier) {
    var el = $(element);
    if (!el.is(':visible')) return false;

    var offset = viewportOffset(el);
    var wOffset = windowOffset(multiplier);
    return offset.top >= wOffset.top && offset.bottom <= wOffset.bottom
  };

  $.indoubleviewport = function(element) {
    return $.inviewport(element, 1)
  }

  $.intripleviewport = function(element) {
    return $.inviewport(element, 2)
  }

  $.partlyInviewport = function(element) {
    var el = $(element);
    if (!el.is(':visible')) return false;

    var offset = viewportOffset(el);
    var wOffset = windowOffset();
    return (offset.bottom > wOffset.top && offset.top < wOffset.top) || (offset.top < wOffset.bottom && offset.bottom > wOffset.bottom) || $.inviewport(element);
  }

  $.notinviewport = function(element) {
    var el = $(element);
    if (!el.is(':visible')) return true;

    var offset = viewportOffset(el);
    var wOffset = windowOffset();
    return (offset.bottom < wOffset.top || offset.top > wOffset.bottom);
  }

  // вьюпорт сдвинут на shift по вертикали
  $.inViewportWithShift = function(element, shift) {
    var el = $(element);
    if (!el.is(':visible')) return false;

    var offset = viewportOffset(el);
    var wOffset = windowOffset();
    wOffset.top += shift;
    wOffset.bottom += shift;
    return offset.top > wOffset.top && offset.bottom < wOffset.bottom;
  }

  // вьюпорт уменьшен на offsetTop сверху и на offsetBottom снизу
  $.inViewportWithOffsets = function(element, offsetTop, offsetBottom) {
    var el = $(element);
    if (!el.is(':visible')) return false;

    var offset = viewportOffset(el);
    var wOffset = windowOffset();
    wOffset.top += offsetTop;
    wOffset.bottom -= offsetBottom;
    return offset.top > wOffset.top && offset.bottom < wOffset.bottom;
  }

  // вьюпорт сдвинут на shift по вертикали
  $.partlyInviewportWithShift = function(element, shift) {
    var el = $(element);
    if (!el.is(':visible')) return false;

    var offset = viewportOffset(el);
    var wOffset = windowOffset();
    wOffset.top += shift;
    wOffset.bottom += shift;
    return (offset.bottom > wOffset.top && offset.top < wOffset.top) || (offset.top < wOffset.bottom && offset.bottom > wOffset.bottom) || $.inviewport(element);
  }

  // вьюпорт уменьшен на offsetTop сверху и на offsetBottom снизу
  $.partlyInviewportWithOffsets = function(element, offsetTop, offsetBottom) {
    var el = $(element);
    if (!el.is(':visible')) return false;

    var offset = viewportOffset(el);
    var wOffset = windowOffset();
    wOffset.top += offsetTop;
    wOffset.bottom -= offsetBottom;
    return (offset.bottom > wOffset.top && offset.top < wOffset.top) || (offset.top < wOffset.bottom && offset.bottom > wOffset.bottom) || $.inviewport(element);
  }

  $.extend($.expr[':'], {
    "in-viewport": function(a, i, m) {
      return $.inviewport(a);
    },
    "in-viewport-partly": function(a, i, m) {
      return $.partlyInviewport(a);
    },
    "in-double-viewport": function(a, i, m) {
      return $.indoubleviewport(a);
    },
    "in-triple-viewport": function(a, i, m) {
      return $.intripleviewport(a);
    },
    "not-in-viewport": function(a, i, m) {
      return $.notinviewport(a);
    },
    "in-viewport-with-shift": function(a, i, m) {
      var shift = parseInt(m[m.length - 1]);
      return $.inViewportWithShift(a, shift)
    },
    "in-viewport-with-offsets": function(a, i, m) {
      var offsets = m[m.length - 1].split(',');
      var offsetTop = parseInt(offsets[0]) || 0;
      var offsetBottom = parseInt(offsets[1]) || 0;
      return $.inViewportWithOffsets(a, offsetTop, offsetBottom)
    },
    "in-viewport-partly-with-shift": function(a, i, m) {
      var shift = parseInt(m[m.length - 1]);
      return $.partlyInviewportWithShift(a, shift)
    },
    "in-viewport-partly-with-offsets": function(a, i, m) {
      var offsets = m[m.length - 1].split(',');
      var offsetTop = parseInt(offsets[0]) || 0;
      var offsetBottom = parseInt(offsets[1]) || 0;
      return $.partlyInviewportWithOffsets(a, offsetTop, offsetBottom)
    }
  });
})(jQuery);
!function($) {
  var getSize = function(el) {
    if (el.hasClass("tiny")) {
      return 16;
    } else if (el.hasClass("small")) {
      return 22;
    } else if (el.hasClass("big")) {
      return 90;
    }
    return 45;
  };

  var buildRotator = function($el) {
    if ($el.hasClass("-loader-embedded"))
      return true;

    var spinnerSize = getSize($el);

    $el.css({
      width: spinnerSize,
      height: spinnerSize
    }).addClass("-loader-embedded");

    for (var i = 1; i <= 12; i++) {
       $el.append('<span class="s-' + i + '"/>');
    }
  };

  $.fn.extend({
    makeLoader: function() {
      this.each(function(i, el) {
        buildRotator($(el));
      });
    }
  });
}(jQuery);
$.fn.extend({
  scrollWidth: function() {
    return this.get(0).scrollWidth;
  },

  scrollHeight: function() {
    return this.get(0).scrollHeight;
  },

  positionedOffset: function() {
    return {
      left: parseInt(this.css("left")),
      right: parseInt(this.css("left")) + this.width()
    }
  },

  groupBind: function(group, cbk) {
    var el = $(this)
    var cbks = {}
    var checkIfAllIsDone = function() {
      var values = _.values(cbks);
      if (_.uniq(values) == [true]) {
        cbk();
      }
    }

    _.each(group, function(g) {
      cbks[group] = false;

      el.bind(group, function() {
        console.log('ckbs is done', group)
        cbks[group] = true;
      })
    })
  },

  getJSON: function() {
    return JSON.parse($(this).html());
  },

  getLeft: function() {
    return parseInt($(this).css('left')) || 0;
  },

  getTop: function() {
    return parseInt($(this).css('top')) || 0;
  },

  reverse: function() {
    return this.pushStack(this.get().reverse(), arguments);
  }
});

$.scrollTo = function(y, duration) {
  $("html, body").stop(true).animate({scrollTop: y, duration: duration});
};

$.handleRedirect = function(u) {
  if (u == window.location.href) {
    window.location.reload();
  } else {
    window.location.href = u;
  }
};

Math.randomFromTwo = function(from, to) {
  return Math.floor(Math.random() * (to - from + 1) + from);
};

(function($){
    $.validator && $.validator.addMethod('clearance_0_16_email', function(value) {
      var re = /^[a-z0-9!#\$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#\$%&'*+\/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$/i;
      return re.test(value);
    }, "Incorrect email");

    $.fn.serializeObject = function(){
        var self = this,
            json = {},
            push_counters = {},
            patterns = {
                "validate": /^[a-zA-Z][a-zA-Z0-9_]*(?:\[(?:\d*|[a-zA-Z0-9_]+)\])*$/,
                "key":      /[a-zA-Z0-9_]+|(?=\[\])/g,
                "push":     /^$/,
                "fixed":    /^\d+$/,
                "named":    /^[a-zA-Z0-9_]+$/
            };


        this.build = function(base, key, value){
            base[key] = value;
            return base;
        };

        this.push_counter = function(key){
            if(push_counters[key] === undefined){
                push_counters[key] = 0;
            }
            return push_counters[key]++;
        };

        $.each($(this).serializeArray(), function(){

            // skip invalid keys
            if(!patterns.validate.test(this.name)){
                return;
            }

            var k,
                keys = this.name.match(patterns.key),
                merge = this.value,
                reverse_key = this.name;

            while((k = keys.pop()) !== undefined){

                // adjust reverse_key
                reverse_key = reverse_key.replace(new RegExp("\\[" + k + "\\]$"), '');

                // push
                if(k.match(patterns.push)){
                    merge = self.build([], self.push_counter(reverse_key), merge);
                }

                // fixed
                else if(k.match(patterns.fixed)){
                    merge = self.build([], k, merge);
                }

                // named
                else if(k.match(patterns.named)){
                    merge = self.build({}, k, merge);
                }
            }

            json = $.extend(true, json, merge);
        });

        return json;
    };
})(jQuery);

/* Modernizr 2.5.3 (Custom Build) | MIT & BSD
 * Build: http://www.modernizr.com/download/#-fontface-backgroundsize-borderimage-borderradius-boxshadow-flexbox-flexbox_legacy-hsla-multiplebgs-opacity-rgba-textshadow-cssanimations-csscolumns-generatedcontent-cssgradients-cssreflections-csstransforms-csstransforms3d-csstransitions-applicationcache-canvas-canvastext-draganddrop-hashchange-history-audio-video-indexeddb-input-inputtypes-localstorage-postmessage-sessionstorage-websockets-websqldatabase-webworkers-geolocation-inlinesvg-smil-svg-svgclippaths-touch-webgl-shiv-cssclasses-teststyles-testprop-testallprops-hasevent-prefixes-domprefixes-load
 */

;window.Modernizr=function(a,b,c){function C(a){j.cssText=a}function D(a,b){return C(n.join(a+";")+(b||""))}function E(a,b){return typeof a===b}function F(a,b){return!!~(""+a).indexOf(b)}function G(a,b){for(var d in a)if(j[a[d]]!==c)return b=="pfx"?a[d]:!0;return!1}function H(a,b,d){for(var e in a){var f=b[a[e]];if(f!==c)return d===!1?a[e]:E(f,"function")?f.bind(d||b):f}return!1}function I(a,b,c){var d=a.charAt(0).toUpperCase()+a.substr(1),e=(a+" "+p.join(d+" ")+d).split(" ");return E(b,"string")||E(b,"undefined")?G(e,b):(e=(a+" "+q.join(d+" ")+d).split(" "),H(e,b,c))}function K(){e.input=function(c){for(var d=0,e=c.length;d<e;d++)u[c[d]]=c[d]in k;return u.list&&(u.list=!!b.createElement("datalist")&&!!a.HTMLDataListElement),u}("autocomplete autofocus list placeholder max min multiple pattern required step".split(" ")),e.inputtypes=function(a){for(var d=0,e,f,h,i=a.length;d<i;d++)k.setAttribute("type",f=a[d]),e=k.type!=="text",e&&(k.value=l,k.style.cssText="position:absolute;visibility:hidden;",/^range$/.test(f)&&k.style.WebkitAppearance!==c?(g.appendChild(k),h=b.defaultView,e=h.getComputedStyle&&h.getComputedStyle(k,null).WebkitAppearance!=="textfield"&&k.offsetHeight!==0,g.removeChild(k)):/^(search|tel)$/.test(f)||(/^(url|email)$/.test(f)?e=k.checkValidity&&k.checkValidity()===!1:/^color$/.test(f)?(g.appendChild(k),g.offsetWidth,e=k.value!=l,g.removeChild(k)):e=k.value!=l)),t[a[d]]=!!e;return t}("search tel url email datetime date month week time datetime-local number range color".split(" "))}var d="2.5.3",e={},f=!0,g=b.documentElement,h="modernizr",i=b.createElement(h),j=i.style,k=b.createElement("input"),l=":)",m={}.toString,n=" -webkit- -moz- -o- -ms- ".split(" "),o="Webkit Moz O ms",p=o.split(" "),q=o.toLowerCase().split(" "),r={svg:"http://www.w3.org/2000/svg"},s={},t={},u={},v=[],w=v.slice,x,y=function(a,c,d,e){var f,i,j,k=b.createElement("div"),l=b.body,m=l?l:b.createElement("body");if(parseInt(d,10))while(d--)j=b.createElement("div"),j.id=e?e[d]:h+(d+1),k.appendChild(j);return f=["&#173;","<style>",a,"</style>"].join(""),k.id=h,m.innerHTML+=f,m.appendChild(k),l||(m.style.background="",g.appendChild(m)),i=c(k,a),l?k.parentNode.removeChild(k):m.parentNode.removeChild(m),!!i},z=function(){function d(d,e){e=e||b.createElement(a[d]||"div"),d="on"+d;var f=d in e;return f||(e.setAttribute||(e=b.createElement("div")),e.setAttribute&&e.removeAttribute&&(e.setAttribute(d,""),f=E(e[d],"function"),E(e[d],"undefined")||(e[d]=c),e.removeAttribute(d))),e=null,f}var a={select:"input",change:"input",submit:"form",reset:"form",error:"img",load:"img",abort:"img"};return d}(),A={}.hasOwnProperty,B;!E(A,"undefined")&&!E(A.call,"undefined")?B=function(a,b){return A.call(a,b)}:B=function(a,b){return b in a&&E(a.constructor.prototype[b],"undefined")},Function.prototype.bind||(Function.prototype.bind=function(b){var c=this;if(typeof c!="function")throw new TypeError;var d=w.call(arguments,1),e=function(){if(this instanceof e){var a=function(){};a.prototype=c.prototype;var f=new a,g=c.apply(f,d.concat(w.call(arguments)));return Object(g)===g?g:f}return c.apply(b,d.concat(w.call(arguments)))};return e});var J=function(c,d){var f=c.join(""),g=d.length;y(f,function(c,d){var f=b.styleSheets[b.styleSheets.length-1],h=f?f.cssRules&&f.cssRules[0]?f.cssRules[0].cssText:f.cssText||"":"",i=c.childNodes,j={};while(g--)j[i[g].id]=i[g];e.touch="ontouchstart"in a||a.DocumentTouch&&b instanceof DocumentTouch||(j.touch&&j.touch.offsetTop)===9,e.csstransforms3d=(j.csstransforms3d&&j.csstransforms3d.offsetLeft)===9&&j.csstransforms3d.offsetHeight===3,e.generatedcontent=(j.generatedcontent&&j.generatedcontent.offsetHeight)>=1,e.fontface=/src/i.test(h)&&h.indexOf(d.split(" ")[0])===0},g,d)}(['@font-face {font-family:"font";src:url("https://")}',["@media (",n.join("touch-enabled),("),h,")","{#touch{top:9px;position:absolute}}"].join(""),["@media (",n.join("transform-3d),("),h,")","{#csstransforms3d{left:9px;position:absolute;height:3px;}}"].join(""),['#generatedcontent:after{content:"',l,'";visibility:hidden}'].join("")],["fontface","touch","csstransforms3d","generatedcontent"]);s.flexbox=function(){return I("flexOrder")},s["flexbox-legacy"]=function(){return I("boxDirection")},s.canvas=function(){var a=b.createElement("canvas");return!!a.getContext&&!!a.getContext("2d")},s.canvastext=function(){return!!e.canvas&&!!E(b.createElement("canvas").getContext("2d").fillText,"function")},s.webgl=function(){try{var d=b.createElement("canvas"),e;e=!(!a.WebGLRenderingContext||!d.getContext("experimental-webgl")&&!d.getContext("webgl")),d=c}catch(f){e=!1}return e},s.touch=function(){return e.touch},s.geolocation=function(){return!!navigator.geolocation},s.postmessage=function(){return!!a.postMessage},s.websqldatabase=function(){return!!a.openDatabase},s.indexedDB=function(){return!!I("indexedDB",a)},s.hashchange=function(){return z("hashchange",a)&&(b.documentMode===c||b.documentMode>7)},s.history=function(){return!!a.history&&!!history.pushState},s.draganddrop=function(){var a=b.createElement("div");return"draggable"in a||"ondragstart"in a&&"ondrop"in a},s.websockets=function(){for(var b=-1,c=p.length;++b<c;)if(a[p[b]+"WebSocket"])return!0;return"WebSocket"in a},s.rgba=function(){return C("background-color:rgba(150,255,150,.5)"),F(j.backgroundColor,"rgba")},s.hsla=function(){return C("background-color:hsla(120,40%,100%,.5)"),F(j.backgroundColor,"rgba")||F(j.backgroundColor,"hsla")},s.multiplebgs=function(){return C("background:url(https://),url(https://),red url(https://)"),/(url\s*\(.*?){3}/.test(j.background)},s.backgroundsize=function(){return I("backgroundSize")},s.borderimage=function(){return I("borderImage")},s.borderradius=function(){return I("borderRadius")},s.boxshadow=function(){return I("boxShadow")},s.textshadow=function(){return b.createElement("div").style.textShadow===""},s.opacity=function(){return D("opacity:.55"),/^0.55$/.test(j.opacity)},s.cssanimations=function(){return I("animationName")},s.csscolumns=function(){return I("columnCount")},s.cssgradients=function(){var a="background-image:",b="gradient(linear,left top,right bottom,from(#9f9),to(white));",c="linear-gradient(left top,#9f9, white);";return C((a+"-webkit- ".split(" ").join(b+a)+n.join(c+a)).slice(0,-a.length)),F(j.backgroundImage,"gradient")},s.cssreflections=function(){return I("boxReflect")},s.csstransforms=function(){return!!I("transform")},s.csstransforms3d=function(){var a=!!I("perspective");return a&&"webkitPerspective"in g.style&&(a=e.csstransforms3d),a},s.csstransitions=function(){return I("transition")},s.fontface=function(){return e.fontface},s.generatedcontent=function(){return e.generatedcontent},s.video=function(){var a=b.createElement("video"),c=!1;try{if(c=!!a.canPlayType)c=new Boolean(c),c.ogg=a.canPlayType('video/ogg; codecs="theora"').replace(/^no$/,""),c.h264=a.canPlayType('video/mp4; codecs="avc1.42E01E"').replace(/^no$/,""),c.webm=a.canPlayType('video/webm; codecs="vp8, vorbis"').replace(/^no$/,"")}catch(d){}return c},s.audio=function(){var a=b.createElement("audio"),c=!1;try{if(c=!!a.canPlayType)c=new Boolean(c),c.ogg=a.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),c.mp3=a.canPlayType("audio/mpeg;").replace(/^no$/,""),c.wav=a.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),c.m4a=(a.canPlayType("audio/x-m4a;")||a.canPlayType("audio/aac;")).replace(/^no$/,"")}catch(d){}return c},s.localstorage=function(){try{return localStorage.setItem(h,h),localStorage.removeItem(h),!0}catch(a){return!1}},s.sessionstorage=function(){try{return sessionStorage.setItem(h,h),sessionStorage.removeItem(h),!0}catch(a){return!1}},s.webworkers=function(){return!!a.Worker},s.applicationcache=function(){return!!a.applicationCache},s.svg=function(){return!!b.createElementNS&&!!b.createElementNS(r.svg,"svg").createSVGRect},s.inlinesvg=function(){var a=b.createElement("div");return a.innerHTML="<svg/>",(a.firstChild&&a.firstChild.namespaceURI)==r.svg},s.smil=function(){return!!b.createElementNS&&/SVGAnimate/.test(m.call(b.createElementNS(r.svg,"animate")))},s.svgclippaths=function(){return!!b.createElementNS&&/SVGClipPath/.test(m.call(b.createElementNS(r.svg,"clipPath")))};for(var L in s)B(s,L)&&(x=L.toLowerCase(),e[x]=s[L](),v.push((e[x]?"":"no-")+x));return e.input||K(),C(""),i=k=null,function(a,b){function g(a,b){var c=a.createElement("p"),d=a.getElementsByTagName("head")[0]||a.documentElement;return c.innerHTML="x<style>"+b+"</style>",d.insertBefore(c.lastChild,d.firstChild)}function h(){var a=k.elements;return typeof a=="string"?a.split(" "):a}function i(a){var b={},c=a.createElement,e=a.createDocumentFragment,f=e();a.createElement=function(a){var e=(b[a]||(b[a]=c(a))).cloneNode();return k.shivMethods&&e.canHaveChildren&&!d.test(a)?f.appendChild(e):e},a.createDocumentFragment=Function("h,f","return function(){var n=f.cloneNode(),c=n.createElement;h.shivMethods&&("+h().join().replace(/\w+/g,function(a){return b[a]=c(a),f.createElement(a),'c("'+a+'")'})+");return n}")(k,f)}function j(a){var b;return a.documentShived?a:(k.shivCSS&&!e&&(b=!!g(a,"article,aside,details,figcaption,figure,footer,header,hgroup,nav,section{display:block}audio{display:none}canvas,video{display:inline-block;*display:inline;*zoom:1}[hidden]{display:none}audio[controls]{display:inline-block;*display:inline;*zoom:1}mark{background:#FF0;color:#000}")),f||(b=!i(a)),b&&(a.documentShived=b),a)}var c=a.html5||{},d=/^<|^(?:button|form|map|select|textarea)$/i,e,f;(function(){var a=b.createElement("a");a.innerHTML="<xyz></xyz>",e="hidden"in a,f=a.childNodes.length==1||function(){try{b.createElement("a")}catch(a){return!0}var c=b.createDocumentFragment();return typeof c.cloneNode=="undefined"||typeof c.createDocumentFragment=="undefined"||typeof c.createElement=="undefined"}()})();var k={elements:c.elements||"abbr article aside audio bdi canvas data datalist details figcaption figure footer header hgroup mark meter nav output progress section summary time video",shivCSS:c.shivCSS!==!1,shivMethods:c.shivMethods!==!1,type:"default",shivDocument:j};a.html5=k,j(b)}(this,b),e._version=d,e._prefixes=n,e._domPrefixes=q,e._cssomPrefixes=p,e.hasEvent=z,e.testProp=function(a){return G([a])},e.testAllProps=I,e.testStyles=y,g.className=g.className.replace(/(^|\s)no-js(\s|$)/,"$1$2")+(f?" js "+v.join(" "):""),e}(this,this.document),function(a,b,c){function d(a){return o.call(a)=="[object Function]"}function e(a){return typeof a=="string"}function f(){}function g(a){return!a||a=="loaded"||a=="complete"||a=="uninitialized"}function h(){var a=p.shift();q=1,a?a.t?m(function(){(a.t=="c"?B.injectCss:B.injectJs)(a.s,0,a.a,a.x,a.e,1)},0):(a(),h()):q=0}function i(a,c,d,e,f,i,j){function k(b){if(!o&&g(l.readyState)&&(u.r=o=1,!q&&h(),l.onload=l.onreadystatechange=null,b)){a!="img"&&m(function(){t.removeChild(l)},50);for(var d in y[c])y[c].hasOwnProperty(d)&&y[c][d].onload()}}var j=j||B.errorTimeout,l={},o=0,r=0,u={t:d,s:c,e:f,a:i,x:j};y[c]===1&&(r=1,y[c]=[],l=b.createElement(a)),a=="object"?l.data=c:(l.src=c,l.type=a),l.width=l.height="0",l.onerror=l.onload=l.onreadystatechange=function(){k.call(this,r)},p.splice(e,0,u),a!="img"&&(r||y[c]===2?(t.insertBefore(l,s?null:n),m(k,j)):y[c].push(l))}function j(a,b,c,d,f){return q=0,b=b||"j",e(a)?i(b=="c"?v:u,a,b,this.i++,c,d,f):(p.splice(this.i++,0,a),p.length==1&&h()),this}function k(){var a=B;return a.loader={load:j,i:0},a}var l=b.documentElement,m=a.setTimeout,n=b.getElementsByTagName("script")[0],o={}.toString,p=[],q=0,r="MozAppearance"in l.style,s=r&&!!b.createRange().compareNode,t=s?l:n.parentNode,l=a.opera&&o.call(a.opera)=="[object Opera]",l=!!b.attachEvent&&!l,u=r?"object":l?"script":"img",v=l?"script":u,w=Array.isArray||function(a){return o.call(a)=="[object Array]"},x=[],y={},z={timeout:function(a,b){return b.length&&(a.timeout=b[0]),a}},A,B;B=function(a){function b(a){var a=a.split("!"),b=x.length,c=a.pop(),d=a.length,c={url:c,origUrl:c,prefixes:a},e,f,g;for(f=0;f<d;f++)g=a[f].split("="),(e=z[g.shift()])&&(c=e(c,g));for(f=0;f<b;f++)c=x[f](c);return c}function g(a,e,f,g,i){var j=b(a),l=j.autoCallback;j.url.split(".").pop().split("?").shift(),j.bypass||(e&&(e=d(e)?e:e[a]||e[g]||e[a.split("/").pop().split("?")[0]]||h),j.instead?j.instead(a,e,f,g,i):(y[j.url]?j.noexec=!0:y[j.url]=1,f.load(j.url,j.forceCSS||!j.forceJS&&"css"==j.url.split(".").pop().split("?").shift()?"c":c,j.noexec,j.attrs,j.timeout),(d(e)||d(l))&&f.load(function(){k(),e&&e(j.origUrl,i,g),l&&l(j.origUrl,i,g),y[j.url]=2})))}function i(a,b){function c(a,c){if(a){if(e(a))c||(j=function(){var a=[].slice.call(arguments);k.apply(this,a),l()}),g(a,j,b,0,h);else if(Object(a)===a)for(n in m=function(){var b=0,c;for(c in a)a.hasOwnProperty(c)&&b++;return b}(),a)a.hasOwnProperty(n)&&(!c&&!--m&&(d(j)?j=function(){var a=[].slice.call(arguments);k.apply(this,a),l()}:j[n]=function(a){return function(){var b=[].slice.call(arguments);a&&a.apply(this,b),l()}}(k[n])),g(a[n],j,b,n,h))}else!c&&l()}var h=!!a.test,i=a.load||a.both,j=a.callback||f,k=j,l=a.complete||f,m,n;c(h?a.yep:a.nope,!!i),i&&c(i)}var j,l,m=this.yepnope.loader;if(e(a))g(a,0,m,0);else if(w(a))for(j=0;j<a.length;j++)l=a[j],e(l)?g(l,0,m,0):w(l)?B(l):Object(l)===l&&i(l,m);else Object(a)===a&&i(a,m)},B.addPrefix=function(a,b){z[a]=b},B.addFilter=function(a){x.push(a)},B.errorTimeout=1e4,b.readyState==null&&b.addEventListener&&(b.readyState="loading",b.addEventListener("DOMContentLoaded",A=function(){b.removeEventListener("DOMContentLoaded",A,0),b.readyState="complete"},0)),a.yepnope=k(),a.yepnope.executeStack=h,a.yepnope.injectJs=function(a,c,d,e,i,j){var k=b.createElement("script"),l,o,e=e||B.errorTimeout;k.src=a;for(o in d)k.setAttribute(o,d[o]);c=j?h:c||f,k.onreadystatechange=k.onload=function(){!l&&g(k.readyState)&&(l=1,c(),k.onload=k.onreadystatechange=null)},m(function(){l||(l=1,c(1))},e),i?k.onload():n.parentNode.insertBefore(k,n)},a.yepnope.injectCss=function(a,c,d,e,g,i){var e=b.createElement("link"),j,c=i?h:c||f;e.href=a,e.rel="stylesheet",e.type="text/css";for(j in d)e.setAttribute(j,d[j]);g||(n.parentNode.insertBefore(e,n),m(c,0))}}(this,document),Modernizr.load=function(){yepnope.apply(window,[].slice.call(arguments,0))};
/*
 *  getQueryParameters.js
 *  Copyright (c) 2014 Nicholas Ortenzio
 *  The MIT License (MIT)
 *
 */


window.getQueryParameters = function(str) {
  return (str || document.location.search).replace(/(^\?)/,'').split("&").map(function(n){return n=n.split("="),this[n[0]]=n[1],this;}.bind({}))[0];
};
/*
* jQuery UI Tag-it!
*
* @version v2.0 (06/2011)
*
* Copyright 2011, Levy Carneiro Jr.
* Released under the MIT license.
* http://aehlke.github.com/tag-it/LICENSE
*
* Homepage:
*   http://aehlke.github.com/tag-it/
*
* Authors:
*   Levy Carneiro Jr.
*   Martin Rehfeld
*   Tobias Schmidt
*   Skylar Challand
*   Alex Ehlke
*
* Maintainer:
*   Alex Ehlke - Twitter: @aehlke
*
* Dependencies:
*   jQuery v1.4+
*   jQuery UI v1.8+
*/

(function($) {

    if (!$.widget) return;

    $.widget('ui.tagit', {
        options: {
            allowDuplicates   : false,
            caseSensitive     : true,
            fieldName         : 'tags',
            placeholderText   : null,   // Sets `placeholder` attr on input field.
            readOnly          : false,  // Disables editing.
            removeConfirmation: false,  // Require confirmation to remove tags.
            tagLimit          : null,   // Max number of tags allowed (null for unlimited).

            // Used for autocomplete, unless you override `autocomplete.source`.
            availableTags     : [],

            // Use to override or add any options to the autocomplete widget.
            //
            // By default, autocomplete.source will map to availableTags,
            // unless overridden.
            autocomplete: {},

            // Shows autocomplete before the user even types anything.
            showAutocompleteOnFocus: false,

            // When enabled, quotes are unneccesary for inputting multi-word tags.
            allowSpaces: false,

            // The below options are for using a single field instead of several
            // for our form values.
            //
            // When enabled, will use a single hidden field for the form,
            // rather than one per tag. It will delimit tags in the field
            // with singleFieldDelimiter.
            //
            // The easiest way to use singleField is to just instantiate tag-it
            // on an INPUT element, in which case singleField is automatically
            // set to true, and singleFieldNode is set to that element. This
            // way, you don't need to fiddle with these options.
            singleField: false,

            // This is just used when preloading data from the field, and for
            // populating the field with delimited tags as the user adds them.
            singleFieldDelimiter: ',',

            // Set this to an input DOM node to use an existing form field.
            // Any text in it will be erased on init. But it will be
            // populated with the text of tags as they are created,
            // delimited by singleFieldDelimiter.
            //
            // If this is not set, we create an input node for it,
            // with the name given in settings.fieldName.
            singleFieldNode: null,

            // Whether to animate tag removals or not.
            animate: true,

            // Optionally set a tabindex attribute on the input that gets
            // created for tag-it.
            tabIndex: null,

            // Event callbacks.
            beforeTagAdded      : null,
            afterTagAdded       : null,

            beforeTagRemoved    : null,
            afterTagRemoved     : null,

            onTagClicked        : null,
            onTagLimitExceeded  : null,


            // DEPRECATED:
            //
            // /!\ These event callbacks are deprecated and WILL BE REMOVED at some
            // point in the future. They're here for backwards-compatibility.
            // Use the above before/after event callbacks instead.
            onTagAdded  : null,
            onTagRemoved: null,
            // `autocomplete.source` is the replacement for tagSource.
            tagSource: null
            // Do not use the above deprecated options.
        },

        _create: function() {
            // for handling static scoping inside callbacks
            var that = this;

            // There are 2 kinds of DOM nodes this widget can be instantiated on:
            //     1. UL, OL, or some element containing either of these.
            //     2. INPUT, in which case 'singleField' is overridden to true,
            //        a UL is created and the INPUT is hidden.
            if (this.element.is('input')) {
                this.tagList = $('<ul></ul>').insertAfter(this.element);
                this.options.singleField = true;
                this.options.singleFieldNode = this.element;
                this.element.css('display', 'none');
                this.element.addClass("tagit-hidden-input")
            } else {
                this.tagList = this.element.find('ul, ol').andSelf().last();
            }

            this.tagInput = $('<input type="text" />').addClass('ui-widget-content input-field');

            if (this.options.readOnly) this.tagInput.attr('disabled', 'disabled');

            if (this.options.tabIndex) {
                this.tagInput.attr('tabindex', this.options.tabIndex);
            }

            if (this.options.placeholderText) {
                this.tagInput.attr('placeholder', this.options.placeholderText);
            }

            if (!this.options.autocomplete.source) {
                this.options.autocomplete.source = function(search, showChoices) {
                    var filter = search.term.toLowerCase();
                    var choices = $.grep(this.options.availableTags, function(element) {
                        // Only match autocomplete options that begin with the search term.
                        // (Case insensitive.)
                        return (element.toLowerCase().indexOf(filter) === 0);
                    });
                    showChoices(this._subtractArray(choices, this.assignedTags()));
                };
            }

            if (this.options.showAutocompleteOnFocus) {
                this.tagInput.focus(function(event, ui) {
                    that._showAutocomplete();
                });

                if (typeof this.options.autocomplete.minLength === 'undefined') {
                    this.options.autocomplete.minLength = 0;
                }
            }

            // Bind autocomplete.source callback functions to this context.
            if ($.isFunction(this.options.autocomplete.source)) {
                this.options.autocomplete.source = $.proxy(this.options.autocomplete.source, this);
            }

            // DEPRECATED.
            if ($.isFunction(this.options.tagSource)) {
                this.options.tagSource = $.proxy(this.options.tagSource, this);
            }

            this.tagList
                .addClass('tagit')
                .addClass('ui-widget ui-widget-content ui-corner-all')
                // Create the input field.
                .append($('<li class="tagit-new"></li>').append(this.tagInput))
                .click(function(e) {
                    var target = $(e.target);
                    if (target.hasClass('tagit-label')) {
                        var tag = target.closest('.tagit-choice');
                        if (!tag.hasClass('removed')) {
                            that._trigger('onTagClicked', e, {tag: tag, tagLabel: that.tagLabel(tag)});
                        }
                    } else {
                        // Sets the focus() to the input field, if the user
                        // clicks anywhere inside the UL. This is needed
                        // because the input field needs to be of a small size.
                        that.tagInput.focus();
                    }
                });

            // Single field support.
            var addedExistingFromSingleFieldNode = false;
            if (this.options.singleField) {
                if (this.options.singleFieldNode) {
                    // Add existing tags from the input field.
                    var node = $(this.options.singleFieldNode);
                    var tags = node.val().split(this.options.singleFieldDelimiter);
                    node.val('');
                    $.each(tags, function(index, tag) {
                        that.createTag(tag, null, true);
                        addedExistingFromSingleFieldNode = true;
                    });
                } else {
                    // Create our single field input after our list.
                    this.options.singleFieldNode = $('<input type="hidden" style="display:none;" value="" name="' + this.options.fieldName + '" />');
                    this.tagList.after(this.options.singleFieldNode);
                }
            }

            // Add existing tags from the list, if any.
            if (!addedExistingFromSingleFieldNode) {
                this.tagList.children('li').each(function() {
                    if (!$(this).hasClass('tagit-new')) {
                        that.createTag($(this).text(), $(this).attr('class'), true);
                        $(this).remove();
                    }
                });
            }

            // Events.
            this.tagInput
                .keydown(function(event) {
                    // Backspace is not detected within a keypress, so it must use keydown.
                    if (event.which == $.ui.keyCode.BACKSPACE && that.tagInput.val() === '') {
                        var tag = that._lastTag();
                        if (!that.options.removeConfirmation || tag.hasClass('remove')) {
                            // When backspace is pressed, the last tag is deleted.
                            that.removeTag(tag);
                        } else if (that.options.removeConfirmation) {
                            tag.addClass('remove ui-state-highlight');
                        }
                    } else if (that.options.removeConfirmation) {
                        that._lastTag().removeClass('remove ui-state-highlight');
                    }

                    // Comma/Space/Enter are all valid delimiters for new tags,
                    // except when there is an open quote or if setting allowSpaces = true.
                    // Tab will also create a tag, unless the tag input is empty,
                    // in which case it isn't caught.
                    if (
                        event.which === $.ui.keyCode.ENTER ||
                        (
                            event.which == $.ui.keyCode.TAB &&
                            that.tagInput.val() !== ''
                        ) ||
                        (
                            event.which == $.ui.keyCode.SPACE &&
                            that.options.allowSpaces !== true &&
                            (
                                $.trim(that.tagInput.val()).replace( /^s*/, '' ).charAt(0) != '"' ||
                                (
                                    $.trim(that.tagInput.val()).charAt(0) == '"' &&
                                    $.trim(that.tagInput.val()).charAt($.trim(that.tagInput.val()).length - 1) == '"' &&
                                    $.trim(that.tagInput.val()).length - 1 !== 0
                                )
                            )
                        )
                    ) {
                        // Enter submits the form if there's no text in the input.
                        if (!(event.which === $.ui.keyCode.ENTER && that.tagInput.val() === '')) {
                            event.preventDefault();
                        }

                        that.createTag(that._cleanedInput());

                        // The autocomplete doesn't close automatically when TAB is pressed.
                        // So let's ensure that it closes.
                        if(!that.options.useCoubAutocomplete) {
                          that.tagInput.autocomplete('close');
                        }
                    }
                }).blur(function(e){
                    // Create a tag when the element loses focus.
                    // If autocomplete is enabled and suggestion was clicked, don't add it.
                    if (!that.tagInput.data('autocomplete-open')) {
                        that.createTag(that._cleanedInput());
                    }
                }).keypress(function(e){
                    var create = function(){
                      that.createTag(that._cleanedInput());
                      if(!that.options.useCoubAutocomplete) {
                        that.tagInput.autocomplete('close');
                      }
                    };
                    var char = String.fromCharCode(e.charCode);
                    switch(char){
                      case ",":
                        e.preventDefault();
                        create();
                        break;

                      case "#":
                        var v = that.tagInput.val()+"#"
                        if(v.match(/\s#$/)){
                          e.preventDefault();
                          create();
                        }
                    }
              });

            // Autocomplete.
            if (this.options.availableTags || this.options.tagSource || this.options.autocomplete.source) {
                var autocompleteOptions = {
                    select: function(event, ui) {
                        that.createTag(ui.item.value);
                        // Preventing the tag input to be updated with the chosen value.
                        return false;
                    }
                };
                $.extend(autocompleteOptions, this.options.autocomplete);

                // tagSource is deprecated, but takes precedence here since autocomplete.source is set by default,
                // while tagSource is left null by default.
                autocompleteOptions.source = this.options.tagSource || autocompleteOptions.source;

                if(this.options.useCoubAutocomplete){
                  autocompleteOptions["el"]=this.tagInput;
                  new Autocomplete(autocompleteOptions);
                }else{
                  this.tagInput.autocomplete(autocompleteOptions).bind('autocompleteopen', function(event, ui) {
                      that.tagInput.data('autocomplete-open', true);
                  }).bind('autocompleteclose', function(event, ui) {
                      that.tagInput.data('autocomplete-open', false)
                  });
                }

            }
        },

        _cleanedInput: function() {
            // Returns the contents of the tag input, cleaned and ready to be passed to createTag
            return $.trim(this.tagInput.val().replace(/^"(.*)"$/, '$1'));
        },

        _lastTag: function() {
            return this.tagList.find('.tagit-choice:last:not(.removed)');
        },

        _tags: function() {
            return this.tagList.find('.tagit-choice:not(.removed)');
        },

        assignedTags: function() {
            // Returns an array of tag string values
            var that = this;
            var tags = [];
            if (this.options.singleField) {
                tags = $(this.options.singleFieldNode).val().split(this.options.singleFieldDelimiter);
                if (tags[0] === '') {
                    tags = [];
                }
            } else {
                this._tags().each(function() {
                    tags.push(that.tagLabel(this));
                });
            }
            return tags;
        },

        _updateSingleTagsField: function(tags) {
            // Takes a list of tag string values, updates this.options.singleFieldNode.val to the tags delimited by this.options.singleFieldDelimiter
            $(this.options.singleFieldNode).val(tags.join(this.options.singleFieldDelimiter)).trigger('change');
        },

        _subtractArray: function(a1, a2) {
            var result = [];
            for (var i = 0; i < a1.length; i++) {
                if ($.inArray(a1[i], a2) == -1) {
                    result.push(a1[i]);
                }
            }
            return result;
        },

        tagLabel: function(tag) {
            // Returns the tag's string label.
            if (this.options.singleField) {
                return $(tag).find('.tagit-label:first').text();
            } else {
                return $(tag).find('input:first').val();
            }
        },

        _showAutocomplete: function() {
            this.tagInput.autocomplete('search', '');
        },

        _findTagByLabel: function(name) {
            var that = this;
            var tag = null;
            this._tags().each(function(i) {
                if (that._formatStr(name) == that._formatStr(that.tagLabel(this))) {
                    tag = $(this);
                    return false;
                }
            });
            return tag;
        },

        _isNew: function(name) {
            return !this._findTagByLabel(name);
        },

        _formatStr: function(str) {
            if (this.options.caseSensitive) {
                return str;
            }
            return $.trim(str.toLowerCase());
        },

        _effectExists: function(name) {
            return Boolean($.effects && ($.effects[name] || ($.effects.effect && $.effects.effect[name])));
        },

        createTag: function(value, additionalClass, duringInitialization) {
            var that = this;

            value = $.trim(value);

            if(this.options.preprocessTag) {
                value = this.options.preprocessTag(value);
            }

            if (value === '') {
                return false;
            }

            if (!this.options.allowDuplicates && !this._isNew(value)) {
                var existingTag = this._findTagByLabel(value);
                if (this._trigger('onTagExists', null, {
                    existingTag: existingTag,
                    duringInitialization: duringInitialization
                }) !== false) {
                    if (this._effectExists('highlight')) {
                        existingTag.effect('highlight');
                    }
                }
                return false;
            }

            if (this.options.tagLimit && this._tags().length >= this.options.tagLimit) {
                this._trigger('onTagLimitExceeded', null, {duringInitialization: duringInitialization});
                return false;
            }

            var label = $(this.options.onTagClicked ? '<a class="tagit-label"></a>' : '<span class="tagit-label"></span>').text(value);

            // Create tag.
            var tag = $('<li></li>')
                .addClass('tagit-choice ui-widget-content ui-state-default ui-corner-all')
                .addClass(additionalClass)
                .append(label);

            if (this.options.readOnly){
                tag.addClass('tagit-choice-read-only');
            } else {
                tag.addClass('tagit-choice-editable');
                // Button for removing the tag.
                var removeTagIcon = $('<span></span>')
                    .addClass('ui-icon ui-icon-close');
                var removeTag = $('<a><span class="text-icon">\xd7</span></a>') // \xd7 is an X
                    .addClass('tagit-close')
                    .append(removeTagIcon)
                    .click(function(e) {
                        // Removes a tag when the little 'x' is clicked.
                        that.removeTag(tag);
                    });
                tag.append(removeTag);
            }

            // Unless options.singleField is set, each tag has a hidden input field inline.
            if (!this.options.singleField) {
                var escapedValue = label.html();
                tag.append('<input type="hidden" style="display:none;" value="' + escapedValue + '" name="' + this.options.fieldName + '" />');
            }

            if (this._trigger('beforeTagAdded', null, {
                tag: tag,
                tagLabel: this.tagLabel(tag),
                duringInitialization: duringInitialization
            }) === false) {
                return;
            }

            if (this.options.singleField) {
                var tags = this.assignedTags();
                tags.push(value);
                this._updateSingleTagsField(tags);
            }

            // DEPRECATED.
            this._trigger('onTagAdded', null, tag);

            this.tagInput.val('');

            // Insert tag.
            this.tagInput.parent().before(tag);

            this._trigger('afterTagAdded', null, {
                tag: tag,
                tagLabel: this.tagLabel(tag),
                duringInitialization: duringInitialization
            });

            if (this.options.showAutocompleteOnFocus && !duringInitialization) {
                setTimeout(function () { that._showAutocomplete(); }, 0);
            }
        },

        removeTag: function(tag, animate) {
            animate = typeof animate === 'undefined' ? this.options.animate : animate;

            tag = $(tag);

            // DEPRECATED.
            this._trigger('onTagRemoved', null, tag);

            if (this._trigger('beforeTagRemoved', null, {tag: tag, tagLabel: this.tagLabel(tag)}) === false) {
                return;
            }

            if (this.options.singleField) {
                var tags = this.assignedTags();
                var removedTagLabel = this.tagLabel(tag);
                tags = $.grep(tags, function(el){
                    return el != removedTagLabel;
                });
                this._updateSingleTagsField(tags);
            }

            if (animate) {
                tag.addClass('removed'); // Excludes this tag from _tags.
                var hide_args = this._effectExists('blind') ? ['blind', {direction: 'horizontal'}, 'fast'] : ['fast'];

                var thisTag = this;
                hide_args.push(function() {
                    tag.remove();
                    thisTag._trigger('afterTagRemoved', null, {tag: tag, tagLabel: thisTag.tagLabel(tag)});
                });

                tag.fadeOut('fast').hide.apply(tag, hide_args).dequeue();
            } else {
                tag.remove();
                this._trigger('afterTagRemoved', null, {tag: tag, tagLabel: this.tagLabel(tag)});
            }

        },

        removeTagByLabel: function(tagLabel, animate) {
            var toRemove = this._findTagByLabel(tagLabel);
            if (!toRemove) {
                throw "No such tag exists with the name '" + tagLabel + "'";
            }
            this.removeTag(toRemove, animate);
        },

        removeAll: function() {
            // Removes all tags.
            var that = this;
            this._tags().each(function(index, tag) {
                that.removeTag(tag, false);
            });
        },

        // Sync tags with hidden field value
        refresh: function() {
          var tagsOnHiddenField  = this.element.val().split(",")
          var tagsOnVisibleField = []
          this._tags().each(function(){
            tagsOnVisibleField.push($(".tagit-label",this).text())
          })

          var that = this
          tagsOnHiddenField.map(function(t){
            if(tagsOnVisibleField.indexOf(t)==-1){ that.createTag(t) }
          });
          tagsOnVisibleField.map(function(t){
            if(tagsOnHiddenField.indexOf(t)==-1){ that.removeTagByLabel(t) }
          });
        }

    });
})(jQuery);


/*
  Абстрактный класс для всех классов
 */

(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.AbstractPiece = (function(superClass) {
    extend(AbstractPiece, superClass);

    function AbstractPiece() {
      AbstractPiece.__super__.constructor.apply(this, arguments);
    }

    return AbstractPiece;

  })(abstract.Object);

}).call(this);

/*
  Main file with namespace and imports
 */

(function() {
  if (window.chms == null) {
    window.chms = {};
  }

  if (window.chms.utils === void 0) {
    window.chms.utils = {};
  }

}).call(this);

/*
  Mixins for javascript
 */

(function() {
  chms.utils.Mixin = (function() {
    function Mixin(to) {
      if (to != null) {
        chms.utils.Mixin.mix(to, this);
      }
    }

    Mixin.mix = function(cl, mixin) {
      var name, value;
      for (name in mixin) {
        value = mixin[name];
        if (name !== "constructor") {
          switch (typeof value) {
            case "function":
              cl[name] = value.bind(cl);
              break;
            default:
              cl[name] = value;
          }
        }
      }
      return void 0;
    };

    return Mixin;

  })();

}).call(this);

/*
  Система очередей для ARD
 */

(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  siteData.ArdQueuesMixin = (function(superClass) {
    extend(ArdQueuesMixin, superClass);

    function ArdQueuesMixin() {
      this._queues = {};
      ArdQueuesMixin.__super__.constructor.apply(this, arguments);
    }

    ArdQueuesMixin.prototype.createAndRunQueue = function(field, time) {
      var q;
      if (this.getQueue(field) != null) {
        this.removeQueue(field);
      }
      q = new chms.utils.IntervalQueue();
      if (time != null) {
        q.setInterval(time);
      }
      q.start();
      return this._queues[field] = q;
    };

    ArdQueuesMixin.prototype.removeQueue = function(field) {
      if (this.getQueue(field) != null) {
        this._queues[field].stop();
        return delete this._queues[field];
      }
    };

    ArdQueuesMixin.prototype.getQueue = function(field) {
      return this._queues[field];
    };

    ArdQueuesMixin.prototype.setInQueue = function(key, val, stream, flags) {
      var q;
      if (flags == null) {
        flags = {};
      }
      if ((q = this.getQueue(key))) {
        q.clear();
        return q.add((function(_this) {
          return function() {
            return _this.set(key, val, stream, flags);
          };
        })(this));
      } else {
        throw "siteData.ArdQueuesMixin: trying to use queue for field " + key + " but it is not defined";
      }
    };

    return ArdQueuesMixin;

  })(chms.utils.Mixin);

}).call(this);

/*
  Миксин для интерфейсов bacon.js
 */

(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  siteData.ArdBaconMixin = (function(superClass) {
    extend(ArdBaconMixin, superClass);

    function ArdBaconMixin(to) {
      if (typeof Bacon !== "undefined" && Bacon !== null) {
        ArdBaconMixin.__super__.constructor.apply(this, arguments);
        to._ardBaconMixinMix();
      }
    }

    ArdBaconMixin.prototype._ardBaconMixinMix = function() {
      this.sChanged = $(this).asEventStream(this.s.EVENT_DATA_CHANGED);
      this.sBeforeChanged = $(this).asEventStream(this.s.EVENT_BEFORE_DATA_CHANGED);
      this.sProcessBeforeStart = $(this).asEventStream(this.s.EVENT_PROCESS_OF_CHANGE_BEFORE_START);
      this.sProcessBeforeEnd = $(this).asEventStream(this.s.EVENT_PROCESS_OF_CHANGE_BEFORE_END);
      this.sProcessStarted = $(this).asEventStream(this.s.EVENT_PROCESS_OF_CHANGE_STARTED);
      this.sProcessEnded = $(this).asEventStream(this.s.EVENT_PROCESS_OF_CHANGE_ENDED);
      return this.sProcessTakesPlace = this.sProcessStarted.merge(this.sProcessEnded);
    };

    ArdBaconMixin.prototype.getFiltedStream = function(fields, streams) {
      var f;
      f = this.sChanged.filter((function(_this) {
        return function(e) {
          return fields.indexOf(e.key) !== -1;
        };
      })(this));
      if (streams != null) {
        f = f.filter((function(_this) {
          return function(e) {
            return streams.indexOf(e.stream) !== -1;
          };
        })(this));
      }
      return f;
    };

    return ArdBaconMixin;

  })(chms.utils.Mixin);

}).call(this);

/*
  Абстрактные реактивные данные
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  siteData.AbstractReactiveData = (function() {
    AbstractReactiveData.EVENT_BEFORE_DATA_CHANGED = "coubEditor-data-AbstractReactiveData:EVENT_BEFORE_DATA_CHANGED";

    AbstractReactiveData.EVENT_DATA_CHANGED = "coubEditor.data.AbstractReactiveData:EVENT_DATA_CHANGED";

    AbstractReactiveData.EVENT_DATA_ADDED = "coubEditor.data.AbstractReactiveData:EVENT_DATA_ADDED";

    AbstractReactiveData.EVENT_DATA_INSERTED_TO_ARRAY = "coubEditor.data.AbstractReactiveData:EVENT_DATA_INSERTED_TO_ARRAY";

    AbstractReactiveData.EVENT_DATA_DELETED_FROM_ARRAY = "coubEditor.data.AbstractReactiveData:EVENT_DATA_DELETER_FROM_ARRAY";

    AbstractReactiveData.EVENT_DATA_CONCATED_TO_ARRAY = "coubEditor-data-AbstractReactiveData:EVENT_DATA_CONCATED_TO_ARRAY";

    AbstractReactiveData.EVENT_PROCESS_OF_CHANGE_BEFORE_START = "coubEditor-data-AbstractReactiveData:EVENT_PROCESS_OF_CHANGE_BEFORE_START";

    AbstractReactiveData.EVENT_PROCESS_OF_CHANGE_BEFORE_END = "coubEditor-data-AbstractReactiveData:EVENT_PROCESS_OF_CHANGE_BEFORE_END";

    AbstractReactiveData.EVENT_PROCESS_OF_CHANGE_STARTED = "coubEditor-data-AbstractReactiveData:EVENT_PROCESS_OF_CHANGE_STARTED";

    AbstractReactiveData.EVENT_PROCESS_OF_CHANGE_ENDED = "coubEditor-data-AbstractReactiveData:EVENT_PROCESS_OF_CHANGE_ENDED";

    AbstractReactiveData.STREAM_NOTIFICATION = "notification";

    AbstractReactiveData.prototype.DEBUG_TAG = "coubEditor.data.AbstractReactiveData";

    function AbstractReactiveData(data) {
      if (data == null) {
        data = {};
      }
      this.isAllInProcessOfChange = bind(this.isAllInProcessOfChange, this);
      this.isAnyInProcessOfChange = bind(this.isAnyInProcessOfChange, this);
      this.getProcessesForKeys = bind(this.getProcessesForKeys, this);
      this.isInProcessOfChange = bind(this.isInProcessOfChange, this);
      this.endProcessOfChange = bind(this.endProcessOfChange, this);
      this.startProcessOfChange = bind(this.startProcessOfChange, this);
      this.checkType = bind(this.checkType, this);
      this.setType = bind(this.setType, this);
      this.updateModel = bind(this.updateModel, this);
      this.overwriteModel = bind(this.overwriteModel, this);
      this.notifyAboutAllFields = bind(this.notifyAboutAllFields, this);
      this.notify = bind(this.notify, this);
      this.addNum = bind(this.addNum, this);
      this.concat = bind(this.concat, this);
      this.deleteAtIndex = bind(this.deleteAtIndex, this);
      this.insertAt = bind(this.insertAt, this);
      this.deleteFirstByValue = bind(this.deleteFirstByValue, this);
      this.pushUniq = bind(this.pushUniq, this);
      this.push = bind(this.push, this);
      this.get = bind(this.get, this);
      this.toggleBool = bind(this.toggleBool, this);
      this.setIfUnequal = bind(this.setIfUnequal, this);
      this.set = bind(this.set, this);
      this.getCurrentState = bind(this.getCurrentState, this);
      this.reset = bind(this.reset, this);
      this._initModel = bind(this._initModel, this);
      this.mix = bind(this.mix, this);
      this.s = this.constructor;
      this.eh = {
        err: (function(_this) {
          return function(tag, msg) {
            return console.error(tag, msg);
          };
        })(this),
        log: (function(_this) {
          return function(tag, msg) {
            return console.log(tag, msg);
          };
        })(this),
        warn: (function(_this) {
          return function(tag, msg) {
            return console.warn(tag, msg);
          };
        })(this)
      };
      this.mix();
      this._types = {};
      this._processes = {};
      this._initModel();
    }

    AbstractReactiveData.prototype.mix = function() {
      if (siteData.ArdQueuesMixin != null) {
        new siteData.ArdQueuesMixin(this);
      }
      if (siteData.ArdBaconMixin != null) {
        return new siteData.ArdBaconMixin(this);
      }
    };

    AbstractReactiveData.prototype._initModel = function() {
      return this._data = {};
    };

    AbstractReactiveData.prototype.reset = function() {
      return this._initModel();
    };

    AbstractReactiveData.prototype.getCurrentState = function() {
      return this._data;
    };

    AbstractReactiveData.prototype.set = function(key, val, stream, flags) {
      var event, evts, existBefore, j, len, prevValue;
      if (flags == null) {
        flags = {};
      }
      if (!this.checkType(key, val)) {
        this.eh.err(this.DEBUG_TAG, "Trying to set inappropriate type to field: " + key + "!");
        return;
      }
      prevValue = this._data[key];
      existBefore = this._data[key] != null;
      $(this).trigger({
        type: this.s.EVENT_BEFORE_DATA_CHANGED,
        key: key,
        current: this._data[key],
        next: val,
        stream: stream
      });
      this._data[key] = val;
      evts = [];
      if (!existBefore) {
        evts.push(this.s.EVENT_DATA_ADDED);
      }
      evts.push(this.s.EVENT_DATA_CHANGED);
      for (j = 0, len = evts.length; j < len; j++) {
        event = evts[j];
        $(this).trigger({
          type: event,
          key: key,
          value: val,
          stream: stream,
          prevValue: prevValue,
          flags: flags
        });
      }
      return val;
    };

    AbstractReactiveData.prototype.setIfUnequal = function(key, val, stream, flags) {
      var cv;
      if (flags == null) {
        flags = {};
      }
      cv = this.get(key);
      if (cv !== val) {
        return this.set(key, val, stream, flags);
      }
    };

    AbstractReactiveData.prototype.toggleBool = function(key) {
      var cv;
      cv = this.get(key);
      if (typeof cv === "boolean") {
        return this.set(key, !cv);
      } else {
        return this.eh.err(this.DEBUG_TAG, "Trying to toggle value of " + key + " which is not a boolean!");
      }
    };

    AbstractReactiveData.prototype.get = function(key) {
      return this._data[key];
    };

    AbstractReactiveData.prototype.push = function(key, val, stream, flags) {
      var a;
      if (flags == null) {
        flags = {};
      }
      a = this._data[key];
      if (this.criticArrayCheck(a)) {
        return this.insertAt(key, a.length, val, stream, flags);
      }
    };

    AbstractReactiveData.prototype.pushUniq = function(key, val, stream, flags) {
      var a;
      if (flags == null) {
        flags = {};
      }
      a = this._data[key];
      if (this.criticArrayCheck(a)) {
        if (a.indexOf(val) === -1) {
          return this.push(key, val, stream, flags);
        }
      }
    };

    AbstractReactiveData.prototype.deleteFirstByValue = function(key, val, stream, flags) {
      var a, i;
      if (flags == null) {
        flags = {};
      }
      a = this._data[key];
      if (this.criticArrayCheck(a)) {
        if ((i = a.indexOf(val)) !== -1) {
          return this.deleteAtIndex(key, i, stream, flags);
        }
      }
    };

    AbstractReactiveData.prototype.insertAt = function(key, i, val, stream, flags) {
      var a;
      if (flags == null) {
        flags = {};
      }
      a = this._data[key];
      if (this.criticArrayCheck(a)) {
        i = Math.min(i, a.length);
        a = utils.CArray.insertAt(i, a, [val]);
        this.set(key, a, stream, flags);
        return $(this).trigger({
          type: this.s.EVENT_DATA_INSERTED_TO_ARRAY,
          key: key,
          value: a,
          pushed: val,
          index: i,
          stream: stream
        });
      }
    };

    AbstractReactiveData.prototype.deleteAtIndex = function(key, i, stream, flags) {
      var a, deleted;
      if (flags == null) {
        flags = {};
      }
      a = this._data[key];
      if (this.criticArrayCheck(a)) {
        if (a[i] != null) {
          deleted = a[i];
          a.splice(i, 1);
          this.set(key, a, stream, flags);
          return $(this).trigger({
            type: this.s.EVENT_DATA_DELETED_FROM_ARRAY,
            key: key,
            value: a,
            deletedAt: i,
            deletedValue: deleted,
            stream: stream
          });
        } else {
          return this.eh.err(this.DEBUG_TAG, "trying to remove value from array which are not exists");
        }
      }
    };

    AbstractReactiveData.prototype.concat = function(key, values, stream, flags) {
      var a, aisarray, visarray;
      if (flags == null) {
        flags = {};
      }
      a = this._data[key];
      aisarray = this.criticArrayCheck(a);
      visarray = this.criticArrayCheck(values);
      if (aisarray && visarray) {
        this.set(key, a.concat(values), stream, flags);
        return $(this).trigger({
          type: this.s.EVENT_DATA_CONCATED_TO_ARRAY,
          key: key,
          concated: values
        });
      } else {
        return this.eh.err(this.DEBUG_TAG, "Trying to add values to " + key + " but key or values (" + aisarray + ", " + visarray + ") are not array!");
      }
    };

    AbstractReactiveData.prototype.addNum = function(key, num, stream, flags) {
      var a;
      if (flags == null) {
        flags = {};
      }
      a = this._data[key];
      if (!($.isNumeric(a) && $.isNumeric(num))) {
        this.eh.err(this.DEBUG_TAG, "trying to add number to NaN");
      }
      return this.set(key, a + num, stream, flags);
    };

    AbstractReactiveData.prototype.notify = function(key, stream, flags) {
      var v;
      if (flags == null) {
        flags = {};
      }
      if ((v = this._data[key]) == null) {
        this.eh.err(this.DEBUG_TAG, "try to notify about non existing field");
      }
      if (stream == null) {
        stream = this.s.STREAM_NOTIFICATION;
      }
      return this.set(key, v, stream, flags);
    };

    AbstractReactiveData.prototype.notifyAboutAllFields = function(flags) {
      var key, ref, results, value;
      if (flags == null) {
        flags = {};
      }
      ref = this._data;
      results = [];
      for (key in ref) {
        value = ref[key];
        results.push(this.notify(key, flags));
      }
      return results;
    };

    AbstractReactiveData.prototype.overwriteModel = function(data, flags) {
      if (flags == null) {
        flags = {};
      }
      this._data = data;
      return this.notifyAboutAllFields(flags);
    };

    AbstractReactiveData.prototype.updateModel = function(data, ignore, accept, flags) {
      var j, key, len, results, val, value;
      if (ignore != null) {
        for (j = 0, len = ignore.length; j < len; j++) {
          key = ignore[j];
          delete data[key];
        }
      }
      if (accept != null) {
        for (key in data) {
          value = data[key];
          if (accept.indexOf(key) === -1) {
            delete data[key];
          }
        }
      }
      this._data = $.extend(this._data, data);
      results = [];
      for (key in data) {
        val = data[key];
        results.push(this.notify(key, void 0, flags));
      }
      return results;
    };

    AbstractReactiveData.prototype.criticArrayCheck = function(a) {
      if ($.isArray(a)) {
        return true;
      } else {
        this.eh.err(this.DEBUG_TAG, "Element is not an array!");
        return false;
      }
    };

    AbstractReactiveData.prototype.setType = function(key, type) {
      return this._types[key] = type;
    };

    AbstractReactiveData.prototype.checkType = function(key, value) {
      if (this._types[key] != null) {
        return this._types[key].test(value);
      } else {
        return true;
      }
    };

    AbstractReactiveData.prototype.startProcessOfChange = function(keys, processId) {
      var cbk, cbks, j, key, l, len, len1, results;
      for (j = 0, len = keys.length; j < len; j++) {
        key = keys[j];
        this._processes[key] = processId;
      }
      cbks = [this.s.EVENT_PROCESS_OF_CHANGE_BEFORE_START, this.s.EVENT_PROCESS_OF_CHANGE_STARTED];
      results = [];
      for (l = 0, len1 = cbks.length; l < len1; l++) {
        cbk = cbks[l];
        results.push($(this).trigger({
          type: cbk,
          keys: keys,
          process: processId
        }));
      }
      return results;
    };

    AbstractReactiveData.prototype.endProcessOfChange = function(keys, processId) {
      var cbk, cbks, j, key, l, len, len1, results;
      for (j = 0, len = keys.length; j < len; j++) {
        key = keys[j];
        if (this.isInProcessOfChange(key, processId)) {
          delete this._processes[key];
        } else {
          this.eh.warn("Trying to end process for key " + key + " but it is not in any process or does not belong to specific process " + processId + ".");
        }
      }
      cbks = [this.s.EVENT_PROCESS_OF_CHANGE_BEFORE_END, this.s.EVENT_PROCESS_OF_CHANGE_ENDED];
      results = [];
      for (l = 0, len1 = cbks.length; l < len1; l++) {
        cbk = cbks[l];
        results.push($(this).trigger({
          type: cbk,
          keys: keys,
          process: processId
        }));
      }
      return results;
    };

    AbstractReactiveData.prototype.isInProcessOfChange = function(key, processId) {
      return (this._processes[key] != null) && (!processId || this._processes[key] === processId);
    };

    AbstractReactiveData.prototype.getProcessesForKeys = function(keys) {
      return keys.map((function(_this) {
        return function(k) {
          return _this._processes[k];
        };
      })(this));
    };

    AbstractReactiveData.prototype.isAnyInProcessOfChange = function(keys, processId) {
      return keys.map((function(_this) {
        return function(key) {
          return _this.isInProcessOfChange(key, processId);
        };
      })(this)).reduce((function(_this) {
        return function(o, t) {
          return o || t;
        };
      })(this));
    };

    AbstractReactiveData.prototype.isAllInProcessOfChange = function(keys, processId) {
      return keys.map((function(_this) {
        return function(key) {
          return _this.isInProcessOfChange(key, processId);
        };
      })(this)).reduce((function(_this) {
        return function(o, t) {
          return o && t;
        };
      })(this));
    };

    return AbstractReactiveData;

  })();

}).call(this);

/*
  Данные о пользователях
 */

(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  siteData.ChannelsData = (function(superClass) {
    extend(ChannelsData, superClass);

    function ChannelsData() {
      if (siteData.ChannelsData.__instance == null) {
        ChannelsData.__super__.constructor.apply(this, arguments);
        siteData.ChannelsData.__instance = this;
      } else {
        return siteData.ChannelsData.__instance;
      }
    }

    return ChannelsData;

  })(siteData.AbstractReactiveData);

}).call(this);

/*
  Данные о регистрации
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  siteData.RegistrationData = (function(superClass) {
    extend(RegistrationData, superClass);

    RegistrationData.prototype.DT = "siteData.RegistrationData";

    function RegistrationData() {
      this.extendData = bind(this.extendData, this);
      this.fillData = bind(this.fillData, this);
      this._initModel = bind(this._initModel, this);
      if (siteData.RegistrationData.__instance == null) {
        RegistrationData.__super__.constructor.apply(this, arguments);
        siteData.RegistrationData.__instance = this;
      } else {
        return siteData.RegistrationData.__instance;
      }
    }

    RegistrationData.prototype._initModel = function() {
      RegistrationData.__super__._initModel.apply(this, arguments);
      return this.set("collectedData", {});
    };

    RegistrationData.prototype.fillData = function(data) {
      var f, i, len, ref, val;
      this._initModel();
      if (data.email != null) {
        this.get("collectedData").email = data.email;
      }
      if (data.birthday != null) {
        this.get("collectedData").birthday = data.birthday;
      }
      if (data.gender != null) {
        this.get("collectedData").gender = data.gender;
      }
      if (data.name != null) {
        this.get("collectedData").name = data.name;
      }
      if (data.password != null) {
        this.get("collectedData").password = data.password;
      }
      ref = ['provider', 'token', 'uid', 'secret', 'phone_number', 'captcha'];
      for (i = 0, len = ref.length; i < len; i++) {
        f = ref[i];
        val = data[f];
        this.get("collectedData")[f] = val;
      }
      return this.notify("collectedData");
    };

    RegistrationData.prototype.extendData = function(data) {
      $.extend(this.get("collectedData"), data);
      return this.notify("collectedData");
    };

    return RegistrationData;

  })(siteData.AbstractReactiveData);

}).call(this);

/*
  Данные интерфейса
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  siteData.UI = (function(superClass) {
    extend(UI, superClass);

    function UI() {
      this._initModel = bind(this._initModel, this);
      if (siteData.UI.__instance == null) {
        UI.__super__.constructor.apply(this, arguments);
        siteData.UI.__instance = this;
      } else {
        return siteData.UI.__instance;
      }
    }

    UI.prototype._initModel = function() {
      return this._data = {
        showedDropdowns: [],
        windowHeight: void 0,
        windowWidth: void 0
      };
    };

    return UI;

  })(siteData.AbstractReactiveData);

}).call(this);

/*
  Данные пользователя
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  siteData.UserData = (function(superClass) {
    extend(UserData, superClass);

    UserData.UNREAD_NOTIFICATION_KIND_FRIENDS = "Friends";

    UserData.UNREAD_NOTIFICATION_KIND_COMMON = "Common";

    UserData.FRIENDS_NOTIFICATIONS_TYPES = ["follow", "sn_friend_follow", "follow_back", "famous_follow", "favorite_follow", "sn_friend_registered"];

    function UserData() {
      this.getKeyForUnreadNotifications = bind(this.getKeyForUnreadNotifications, this);
      this.readUnreadNotificationsCount = bind(this.readUnreadNotificationsCount, this);
      this._initModel = bind(this._initModel, this);
      if (siteData.UserData.__instance == null) {
        UserData.__super__.constructor.apply(this, arguments);
        siteData.UserData.__instance = this;
      } else {
        return siteData.UserData.__instance;
      }
    }

    UserData.prototype._initModel = function() {
      this._data = {
        unreadFollowNotifications: 0,
        unreadCommonNotifications: 0
      };
      return this.readUnreadNotificationsCount();
    };

    UserData.prototype.readUnreadNotificationsCount = function() {
      var c, cu, i, len, ref, results, setForChannel, vf, vg;
      cu = gon.current_user;
      setForChannel = (function(_this) {
        return function(channel, kind, value) {
          var key;
          key = _this.getKeyForUnreadNotifications(channel, kind);
          if (_this.get(key) == null) {
            _this.set(key, 0);
          }
          _this.addNum(key, value);
          if (kind === _this.s.UNREAD_NOTIFICATION_KIND_FRIENDS) {
            return _this.getFiltedStream(["unreadFollowNotifications"]).filter(function(v) {
              return v.value === 0;
            }).onValue(function() {
              return _this.set(key, 0);
            });
          } else {
            return _this.getFiltedStream(["unreadCommonNotifications"]).filter(function(v) {
              return v.value === 0;
            }).onValue(function() {
              return _this.set(key, 0);
            });
          }
        };
      })(this);
      if ((cu != null) && cu.channels) {
        ref = cu.channels;
        results = [];
        for (i = 0, len = ref.length; i < len; i++) {
          c = ref[i];
          vf = c.unread_follow_notifications_count;
          if ((vf != null) && !isNaN(vf)) {
            this.addNum("unreadFollowNotifications", vf);
            setForChannel(c.id, this.s.UNREAD_NOTIFICATION_KIND_FRIENDS, vf);
          }
          vg = c.unread_coub_notifications_count;
          if ((vg != null) && !isNaN(vg)) {
            this.addNum("unreadCommonNotifications", vg);
            results.push(setForChannel(c.id, this.s.UNREAD_NOTIFICATION_KIND_COMMON, vg));
          } else {
            results.push(void 0);
          }
        }
        return results;
      }
    };

    UserData.prototype.getKeyForUnreadNotifications = function(channelId, kind) {
      return "unread" + kind + "NotificationsFor" + channelId;
    };

    return UserData;

  })(siteData.AbstractReactiveData);

}).call(this);

/*
  Наполнитель моделей из gon
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  initializers.ModelFiller = (function(superClass) {
    extend(ModelFiller, superClass);

    function ModelFiller() {
      this.fillChannelsData = bind(this.fillChannelsData, this);
      if (initializers.ModelFiller.__instance == null) {
        ModelFiller.__super__.constructor.apply(this, arguments);
        initializers.ModelFiller.__instance = this;
      } else {
        return initializers.ModelFiller.__instance;
      }
    }

    ModelFiller.prototype.fillChannelsData = function() {
      var cdata, channel, cuc, i, len, results;
      cdata = new siteData.ChannelsData();
      if ((gon.current_user != null) && (cuc = gon.current_user.channels != null)) {
        results = [];
        for (i = 0, len = cuc.length; i < len; i++) {
          channel = cuc[i];
          results.push(cdata.set(channel.id, channel));
        }
        return results;
      }
    };

    return ModelFiller;

  })(abstract.Object);

}).call(this);

/*
  Функции для работы с массивами
 */

(function() {
  utils.CArray = (function() {
    function CArray() {}

    CArray.insertAt = function(i, a, v) {
      if (i < 0) {
        throw "utils.CArray: index is out of bounds (0<)";
      }
      return a.slice(0, i).concat(v).concat(a.slice(i));
    };

    CArray.move = function(f, t, a) {
      var e, r;
      if (f === t) {
        return a;
      } else if ((f >= 0 && f < a.length) && (t >= 0 && t < a.length)) {
        e = a[f];
        r = utils.CArray.insertAt(t, a, e);
        if (f > t) {
          r = utils.CArray.insertAt(t, a, e);
          return r.filter((function(_this) {
            return function(e, i) {
              return i !== f + 1;
            };
          })(this));
        } else {
          r = utils.CArray.insertAt(t + 1, a, e);
          return r.filter((function(_this) {
            return function(e, i) {
              return i !== f;
            };
          })(this));
        }
      } else {
        throw "Some of the indices (" + f + "," + t + "," + a.length + ") is out of bound!";
      }
    };

    return CArray;

  })();

}).call(this);
(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty,
    slice = [].slice;

  utils.ObservableMixin = (function(superClass) {
    extend(ObservableMixin, superClass);

    function ObservableMixin() {
      return ObservableMixin.__super__.constructor.apply(this, arguments);
    }

    ObservableMixin.prototype.on = function(event, fn) {
      $(this).on(event, (function(_this) {
        return function() {
          var args, e;
          e = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];
          return fn.apply(_this, args);
        };
      })(this));
      return this;
    };

    ObservableMixin.prototype.one = function(event, fn) {
      $(this).one(event, (function(_this) {
        return function() {
          var args, e;
          e = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];
          return fn.apply(_this, args);
        };
      })(this));
      return this;
    };

    ObservableMixin.prototype.off = function(event, fn) {
      $(this).off(event, fn);
      return this;
    };

    ObservableMixin.prototype.trigger = function() {
      var args, event;
      event = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];
      $(this).trigger(event, args);
      return this;
    };

    ObservableMixin.prototype.single = function(event, fn, once) {
      this.off(event);
      if (once) {
        this.one(event, fn);
      } else {
        this.on(event, fn);
      }
      return this;
    };

    return ObservableMixin;

  })(chms.utils.Mixin);

}).call(this);
// Убирает теги из переданного текста
// Взял отсюда http://phpjs.org/functions/strip_tags/


// @params {string} input
// @params {string} Список разрешенных тегов, пример '<a><b>'
// @return {string} input без тегов html
window.utils.stripTags = function(input, allowed){
  allowed = (((allowed || "") + "").toLowerCase().match(/<[a-z][a-z0-9]*>/g) || []).join(''); // making sure the allowed arg is a string containing only tags in lowercase (<a><b><c>)
  var tags = /<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,
    commentsAndPhpTags = /<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;
  return input.replace(commentsAndPhpTags, '').replace(tags, function ($0, $1) {
    return allowed.indexOf('<' + $1.toLowerCase() + '>') > -1 ? $0 : '';});
};

// Эскейпит html теги
// @param {String} html HTML код
window.utils.htmlEncode = function(html){
  var r = document.createElement( 'a' ).appendChild(
    document.createTextNode( html ) ).parentNode.innerHTML;

  r = r.replace("&amp;#x27;", "&#x27;");

  return r
}

// Эскейп кавычек
// Предотвращает XSS прив вставке текста в аттрибуты через html шаблоны
window.utils.encodeQuotes = function(str, singleQuotes) {
  if (!str) {
    return '';
  } else if (singleQuotes) {
    return str.replace(/'/g, '&#39;');
  } else {
    return str.replace(/"/g, '&quot;');
  }
}
;
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/ads/google_adsense320x250"] = function anonymous(it) {
  var out='<div class="ad-unit-mobile-coub-page"> <div class="ad-unit-mobile-coub-page__inner"> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-8998313678449329" data-ad-slot="3394307895"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/ads/new_pole_mobile_script"] = function anonymous(it) {
  var out='(function() {function loadScript(a,b){var c=d.createElement("script");c.type="text/javascript",c.readyState?c.onreadystatechange=function(){"loaded"!==c.readyState&&"complete"!==c.readyState||(c.onreadystatechange=null,b())}:c.onload=function(){b()},c.charset="utf-8",c.src=a,d.getElementsByTagName("head")[0].appendChild(c)}var d=document,s=d.currentScript;loadScript("//newpole.cdnvideo.ru/js/video-player-2.min.js",function(){yumaPlayerInit({"runTimeout":0,"autoPlay":true,"ios":{"link":"//ad.mail.ru/vast/3930?puid1=90&puid2=650&puid3=10&puid4=1&puid5=14&puid6=86&puid7=5&puid8=9&puid9=2&puid10=1&puid11=1&puid12=1&puid23=6&puid32=1"},"android":{"link":"//ad.mail.ru/vast/3930?puid1=90&puid2=651&puid3=10&puid4=1&puid5=14&puid6=86&puid7=5&puid8=9&puid9=2&puid10=1&puid11=1&puid12=3&puid23=6&puid32=1"}},s);})})();';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/announcements/item"] = function anonymous(it) {
  var out=''; isProcessing = it.status_url != undefined; out+='<div class="timeline-announcements-item '+(isProcessing ? 'processing' : '')+'" announcement-item data-announce-id="'+(it.id)+'"> <div class="timeline-announcements-item__image"> <img src="'+(it.thumbnail)+'" /> </div> ';if(!isProcessing){out+=' <a embed-popup href="'+(it.source_url)+'" source="'+(it.editor_url)+'"> <div class="timeline-announcements-item__play-overlay"> <div class="icon"></div></div> </a> ';}else{out+=' <div class="timeline-announcements-item__play-overlay"> <div class="icon"></div></div> ';}out+=' ';if(it.showHideButton === true){out+=' <div class="timeline-announcements-item__controls"> <button class="sb -rn -trans delete">'+( I18n.t("announces.buttons.delete") )+'</button> </div> ';}out+=' <div class="timeline-announcements-item__progress -hidden"> <p status>'+( I18n.t("announces.uploading") )+'</p> <div class="container"> <div class="tail"></div> </div> </div> <div class="timeline-announcements-item__error -hidden"> <h5>'+( I18n.t("announces.errors.heading") )+'</h5> <p>'+( I18n.t("announces.errors.sub") )+'</p> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/announcements/remove_dropdown"] = function anonymous(it) {
  var out='<div class="-centered-text"> <h5 class="timeline-announcements-dropdown__heading">'+( I18n.t("announces.buttons.delete") )+'</h5> <div class="timeline-announcements-dropdown__buttons"> <button delete-button type="button" data-announcement-id="'+(it.id)+'" class="sb -st -rn -blue -rn -sb-beta">'+(I18n.t('announces.buttons.remove'))+'</button> <button cancel-button type="button" class="sb -st -rn -grey -sb-beta closeButton">'+(I18n.t('announces.buttons.cancel'))+'</button> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/channel_menu_dropdown/channel_changer"] = function anonymous(it) {
  var out='';  var isCurrent = Params.getBranchValue("current_channel_id")==it.channel.id; var selectedClass = isCurrent ? "active" : "" ; var h = helpers.Application; var versionAndSide = ['small', 40]; var avatar = h.specificImgVersion(it.channel, "avatar_versions", versionAndSide[0], true), avatarAttrs = isCurrent ? 'widget-avatar-change-listener auto-init' : '';out+='<li class="list__item list__item-gamma change-channel '+(selectedClass)+'"> <a href="'+(Routes.channel_path(it.channel.permalink))+'" title="'+(it.channel.title)+'"> <img '+(avatar)+' height="'+(versionAndSide[1])+'" width="'+(versionAndSide[1])+'" '+(avatarAttrs)+'/> '+(it.channel.title)+' ';if(false && it.channel.unread_notifications_count > 0){out+=' <span class="notify -color--blue-ribbon" channel-id="'+(it.channel.id)+'">'+(it.channel.unread_notifications_count)+'</span> ';}out+=' </a> ';if(it.drawChannelSelector){out+=' <span class="active-channel-selector" widget-channel-changer="true" auto-init="true" channel-id="'+(it.channel.id)+'"></span> ';}out+='</li>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/channel_menu_dropdown/channel_menu_dropdown"] = function anonymous(it) {
  var out=''; out+=''+( JST["app/site/templates/widgets/dropdown_with_handler/dropdown_with_handler"]({ handler: JST["app/site/templates/blocks/channel_menu_dropdown/handler"](), hClass: "", content: JST["app/site/templates/blocks/channel_menu_dropdown/content"](), dClass: "header-channel__menu box--vertical strict-below", attrs: "blocks-channel-menu-dropdown auto-init" }));return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/channel_menu_dropdown/content"] = function anonymous(it) {
  var out='';  var links = helpers.ChannelMenuDropdown.getEditorLinks(), channels = helpers.Channel.presentChannels(), drawChannelSelector = channels.length > 1;out+='`<div class="list-wrap channel-menu-dropdown__content" data-scroll-type=\'vertical\'> <ul class="list" data-scroll-type="vertical"> ';var arr1=channels;if(arr1){var channel,i=-1,l1=arr1.length-1;while(i<l1){channel=arr1[i+=1];out+=' '+( JST["app/site/templates/blocks/channel_menu_dropdown/channel_changer"]({channel: channel, drawChannelSelector: drawChannelSelector}) )+' ';} } out+=' <li class="list__item list__item-gamma new-channel" widget-create-channel-popup="true" auto-init="true"> '+(JST["app/site/templates/svg/new"]())+' '+(I18n.t('channels.add_new'))+' </li> <li class="list__item-hr"></li> ';var arr2=links;if(arr2){var link,index=-1,l2=arr2.length-1;while(index<l2){link=arr2[index+=1];out+=' <li class="list__item list__item-beta"> <a href="'+(link.url)+'">'+(link.text)+'</a> </li> ';} } out+=' ';if(GlobalState.USER.isAdmin()){out+=' <li class="list__item list__item-beta" id=\'toggle-locale-popup\'> <a href="#">Locale popup</a> </li> ';}out+=' <li class="list__item list__item-beta logout"> '+(JST["app/site/templates/svg/icons/24/logout"]())+' <form action="'+(Routes.signout_path())+'" method="POST"> <input type="hidden" name="_method" value="delete" /> <span>'+(I18n.t('logout'))+'</span> <button type="submit" class="sb -fill"></button> </form> </li> </ul></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/channel_menu_dropdown/handler"] = function anonymous(it) {
  var out=''; out+='<button class="sb -trans -rn -select" data-prompt="'+(I18n.t('profile.change_channel'))+'" direction="below" hideable-prompt="true" type="button"></button>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/channels_block/channels_block"] = function anonymous(it) {
  var out=''; out+='<div class="channels-block channels-block--list box--banner '+(it.classes || '')+'"> ';if(it.heading && it.channels.length){out+=' <div class="channels-block__heading"> <h3>'+(it.heading)+'</h3> </div> ';}out+=' <div class="list"> ';var arr1=it.channels;if(arr1){var channel,i=-1,l1=arr1.length-1;while(i<l1){channel=arr1[i+=1];out+=' <div class="list__item">'+(JST['app/site/templates/channel_item/simple_channel_item']({channel: channel, followCls: ''}))+'</div> ';} } out+=' </div> ';if(it.view_more && it.view_more_url){out+=' <a class="channels-block__view-more" href="'+(it.view_more_url)+'">'+(it.view_more)+'</a> ';}out+='</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/channels_in_list_dropdown/channel_in_list_dropdown"] = function anonymous(it) {
  var out='';  var channelPath = Routes.channel_path({id: it.channel.permalink}), avatar = helpers.Application.specificImgVersion(it.channel, 'avatar_versions', 'small'), curChannel = Params.get('current_channel_id');out+='<li class="list__item list__item-beta object-media"> <a href="'+(channelPath)+'" data-channel-id="'+(it.channel.id)+'" class="-fill"></a> <div class="object-media__img"> <img height="40" width="40" '+(avatar)+' class="image -rounded"/> </div> <div class="object-media__body"> ';if(false){out+=' '+( JST['app/site/templates/widgets/follow_button/follow_button_init']({ btnCls: it.isSmallFollow ? 'small' : '', classes: 'channel-follow-button', channelId: it.channel.id, iFollow: it.channel.i_follow_him, followedFrom: it.channel.follows_by_users_channels }) )+' ';}out+=' <div class="dd-channel-list__title" title="'+(it.channel.title)+'"> '+(it.channel.title)+' </div> </div></li>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/channels_in_list_dropdown/channels_in_list_dropdown"] = function anonymous(it) {
  var out=''; out+='<div class="dd-channel-list list-wrap" data-scroll-type="vertical"> <ul class="list list--selectable"></ul></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/community/community_card"] = function anonymous(it) {
  var out='';  var image_url = it.big_image_url || '/missing/missing.png', isOff = !it.i_subscribed, switcherClass = isOff ? '-off' : '', prompt = isOff && I18n.t('trends.prompts.subscribe') || I18n.t('trends.prompts.unsubscribe'), switcherAttrs = '', notifButtonClass = it.community_notifications_enabled ? '-subscribed' : ''; if (!GlobalState.USER.isLogedIn()) { switcherClass += ' toggle-registration'; switcherAttrs += 'data-action="sign_up"'; }out+='<div class=\'hot__community\' data-community-permalink='+(it.permalink)+' data-community-id='+(it.id)+'> <img src='+(image_url)+' width="180" height="180" /> <div class="description"> <div class="title"> <h2 class="hbold">'+(it.title)+'</h2> <div class="switcher switcher--big '+(switcherClass)+'" '+(switcherAttrs)+' data-prompt='+(prompt)+' hideable-prompt></div> ';if(GlobalState.USER.isLogedIn() && window.firebase && window.firebase.messaging && firebase.messaging.isSupported()){out+=' <div class="notifications__subscribe '+(notifButtonClass)+'" data-prompt="'+(I18n.t('notifications_button.enable'))+'" > <div class="on">'+(JST["app/site/templates/svg/icons/24/bell-on"]())+'</div> <div class="off">'+(JST["app/site/templates/svg/icons/24/bell-off"]())+'</div> <div class="default">'+(JST["app/site/templates/svg/icons/24/bell"]())+'</div> </div> ';}out+=' </div> <div class="subdesc"> '+(I18n.t('trends.community'))+' <span>'+(I18n.t("trends.members_count", {count: it.subscriptions_count, number: helpers.Application.roundToM(it.subscriptions_count)}))+'</span> </div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/community/community_description"] = function anonymous(it) {
  var out=''; var isEditEnabled = GlobalState.USER.isAdmin();out+='<div class="community-description"> <div class="community-description__about"> <div class="title"> <h6>'+(I18n.t('community_description.about'))+'</h6> ';if(isEditEnabled){out+=' <div class="icon community-description__settings">'+(JST['app/site/templates/svg/icons/24/settings']())+'</div> ';}out+=' </div> <div class="desc">'+(it.descriptionHtml)+'</div> </div> <div class="community-description__rules"> <div class="title"> <h6>'+(I18n.t('community_description.rules'))+'</h6> ';if(isEditEnabled){out+=' <div class="icon community-description__new-rule">'+(JST['app/site/templates/svg/icons/24/plus']())+'</div> ';}out+=' </div> <div class="rules-container"> ';var arr1=it.rulesHtml;if(arr1){var value,index=-1,l1=arr1.length-1;while(index<l1){value=arr1[index+=1];out+=' <div class="community-description__rule"> '+(value)+' ';if(isEditEnabled){out+=' '+( JST["app/site/templates/widgets/dropdown_with_handler/dropdown_with_handler"]({ handler: "<div class='icon'>" + JST['app/site/templates/svg/icons/24/more']() + "</div>", hClass: "", content: JST['app/site/templates/blocks/community/community_rule_dropdown_content'](), dClass: "community-description__rule-dropdown", attrs: "data-v-offset=8" }) )+' ';}out+=' </div> ';} } out+=' </div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/community/community_rule_dropdown_content"] = function anonymous(it) {
  var out='<ul class="list list--selectable"> <li class="list__item community-description__edit-rule"> '+(JST['app/site/templates/svg/icons/24/edit']())+' '+(I18n.t('community_description.edit'))+' </li> <li class="list__item community-description__move-up"> '+(JST['app/site/templates/svg/icons/24/arrow-up']())+' '+(I18n.t('community_description.move_up'))+' </li> <li class="list__item community-description__move-down"> '+(JST['app/site/templates/svg/icons/24/arrow-down']())+' '+(I18n.t('community_description.move_down'))+' </li></ul>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/community/community_rule_form"] = function anonymous(it) {
  var out=''; var isEditMode = !!it, header = isEditMode ? I18n.t('community_description.edit_rule'): I18n.t('community_description.new_rule'), title = isEditMode ? it.title: "", description = isEditMode ? it.description: "";out+='<div class="community-description__rule-form"> <h2>'+(header)+'</h2> <input class="input-field -sq" name="title" placeholder="'+(I18n.t('community_description.title'))+'" autocomplete="off" value="'+(title)+'" /> <textarea class="input-field -sq" name="description" placeholder="'+(I18n.t('community_description.description'))+'" autocomplete="off">'+(description)+'</textarea> <p> '+(I18n.t('community_description.markdown_hint'))+' <br> <br> '+(I18n.t('community_description.rule_info'))+' </p> <div class="buttons"> ';if(isEditMode){out+=' <button class="sb delete">'+(JST['app/site/templates/svg/icons/24/delete']())+'</button> <button class="sb -st -rn cancel" popup-close>'+(I18n.t('community_description.cancel'))+'</button> ';}out+=' <button class="sb -blue -rn save">'+(I18n.t('community_description.save'))+'</button> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/community/community_settings_form"] = function anonymous(it) {
  var out='<div class="community-description__settings-form"> <h2>'+(I18n.t('community_description.settings'))+'</h2> <textarea class="input-field -sq" name="description" placeholder="'+(I18n.t('community_description.description'))+'" autocomplete="off">'+(it.description)+'</textarea> <p>'+(I18n.t('community_description.markdown_hint'))+'</p> <div class="buttons"> <button class="sb -blue -rn save">'+(I18n.t('community_description.save'))+'</button> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/friendship_notifications/friendship_notification_body"] = function anonymous(it) {
  var out='';  var obj = helpers.Notifications.getObjectForFriendNotifications(it); var isWithObject = obj.object && obj.object.length > 0; var classes = ""; if(!isWithObject) classes += "-without-object";if(isWithObject){out+=' <div class="notification-list__object -v-centered-box '+(obj.class||'')+'"> '+(obj.object)+' </div>';}out+='<div> <div class="notification-list__text '+(classes)+'"> '+(helpers.Notifications.getTextForFriendsNotification(it))+' </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/friendship_notifications/friendship_notification_img"] = function anonymous(it) {
  var out='';  var sender = it.senders[0]; var recipient = it.recipient; var mainAvatar = helpers.Application.specificImgVersion(sender, 'avatar_versions', 'medium'); var smallAvatar = helpers.Application.specificImgVersion(it.recipient, 'avatar_versions', 'tiny');out+='<a href="'+(Routes.channel_path(sender.permalink))+'"> <img '+(mainAvatar)+' alt="'+(sender.title)+'" width="48" height="48"/> <img '+(smallAvatar)+' alt="'+(recipient.title)+'" class="image -rounded object-media__img__badge" height="20" width="20"/></a>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/friendship_notifications/friendship_notification_text"] = function anonymous(it) {
  var out='';  var sender = it.sender; var kind = it.kind; var hasinfo = (it.familiarSocNetworks || it.familiarMutualFriends || it.recoubsCount || it.likesCount || it.channels); var hasdescription = !!sender.description; var followCount = it.followCount ? it.followCount : 0;out+='<div class="friendship-notification-text__title"> '+( helpers.Notifications.getFriendNotificationTitle(it) )+'</div>';if(kind != 'follow_back'){out+=' ';if(hasinfo){out+=' ';if(it.familiarSocNetworks || it.familiarMutualFriends){out+=' <div class="friendship-notification-text__info -gray"> ';if(it.familiarSocNetworks && it.familiarSocNetworks.length > 0){out+=' '; var sn = it.familiarSocNetworks[0]; out+=' <span class="stamp__provider"> <i class="-soc-i-notifications-'+(sn.from)+'"></i>'+( helpers.Notifications.getNameForSn(sn) )+' </span> ';}out+=' </div> ';}out+=' ';if(it.channels){out+=' <div class="friendship-notification-text__info -gray"> '+( helpers.Channel.followedByKindStamp(it.channels, followCount) )+' </div> ';}out+=' ';if(it.likesCount){out+=' <div class="friendship-notification-text__info -gray"> '+( helpers.Notifications.getTextForLikesAndRecoubs(it.likesCount) )+' </div> ';}out+=' ';}}return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/friendship_notifications/who_to_follow_body"] = function anonymous(it) {
  var out=''; out+='<div class="notification-list__object notification-list__object--channel -v-centered-box"> '+( JST['app/site/templates/widgets/follow_button/follow_button_init']({ btnCls: "", channelId: it.friend_id, iFollow: it.i_follow_him, followedFrom: it.follows_by_users_channels }) )+'</div><div> <div class="notification-list__text"> <div class="friendship-notification-text__title"> <a href="'+(Routes.channel_path(it.permalink))+'" class="hbold" title="'+(it.name)+'">'+(it.title)+'</a> </div> <div class="friendship-notification-text__info -gray"> '+(helpers.Channel.friendshipKindStamp(it))+' </div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/friendship_notifications/who_to_follow_img"] = function anonymous(it) {
  var out='';  var avatar = helpers.Application.specificImgVersion(it, 'avatar_versions', 'medium', true);out+='<a href="'+(Routes.channel_path(it.permalink))+'" class="-ribbon"> <img '+(avatar)+' class="image" width="48" height="48"></a>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/friendships_block/friendship_invite_item"] = function anonymous(it) {
  var out='';  var friend = it.friend, gravatarAttr = (!friend.provider_pic && friend.email_hash && 'data-gravatar="' + helpers.Channel.getGravatarUrl(friend.email_hash, 200, true) + '"') || '', linkToProfile = ['twitter', 'facebook'].indexOf(friend.friend_from) !== -1 && helpers.Channel.friendshipProfileLink(friend);out+='<div class="channel channel--simple object-media om-gutter--beta invite-item '+(linkToProfile ? '' : 'no-link')+'" data-friendship-id="'+(friend.id)+'" '+(gravatarAttr)+'> <div class="object-media__img" style="background-image:url(\''+(friend.provider_pic||'/assets/missing/profile_pic_new-avatar.png')+'\')"> ';if(linkToProfile){out+='<a href="'+(linkToProfile)+'" class="-fill" target="_blank"></a>';}out+=' </div> <div class="object-media__body"> <h5 class="channel__title hbold"> ';if(linkToProfile){out+=' <a href="'+(linkToProfile)+'" class="hbold" target="_blank">'+(friend.name||'')+'</a> ';}else{out+=' '+(friend.name||'')+' ';}out+=' </h5> <p class="channel__stamp">'+(helpers.Channel.friendshipStamp(friend))+'</p> <div class="channel-follow-button"> <button type="button" class="sb -st -rn invite" data-friendship-id="'+(friend.id)+'" data-provider-uid="'+(friend.provider_uid)+'"> '+(I18n.t('invite_friends.timeline.buttons.invite'))+' </button> </div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/friendships_block/friendship_item"] = function anonymous(it) {
  var out='';  var friend = it.friend, avatarVersion = it.avatarVersion ? it.avatarVersion : "profile_pic_new"; avatar = helpers.Application.specificImgVersion(friend, 'avatar_versions', avatarVersion, true); classes = it.classes ? it.classes : ""; elType = it.elType ? it.elType : "div"; var stampCl = it.stampCl? it.stampCl : ""; var stampFn = it.stampFn? it.stampFn : helpers.Channel.friendshipStamp;out+='<'+(elType)+' class="channel channel--simple object-media om-gutter--alpha '+(friend.type)+' '+(friend.provider || friend.friend_from)+' '+(classes)+'" data-friendship-type="'+(friend.type)+'" data-friendship-id="'+(friend.id)+'" data-channel-id="'+(friend.friend_id)+'" widget-friendship-item auto-init> ';if(it.showClose){out+='<i class="close-small"></i>';}out+=' <div class="object-media__img"> <a href="'+(Routes.channel_path(friend.permalink))+'" class="-ribbon"> <img '+(avatar)+' width="110" height="110" class="image"> </a> </div> <div class="object-media__body"> <h5 class="channel__title"> <a href="'+(Routes.channel_path(friend.permalink))+'" class="hbold" title="'+(utils.encodeQuotes(friend.name))+'">'+(friend.name)+'</a> </h5> <p class="channel__stamp '+(stampCl)+'"> '+(stampFn(friend))+' </p> <div class="channel-follow-button"> '+( JST['app/site/templates/widgets/follow_button/follow_button_init']({ btnCls: it.followCls, channelId: friend.friend_id, iFollow: friend.i_follow_him, followedFrom: friend.follows_by_users_channels }) )+' </div> </div></'+(elType)+'>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/friendships_block/friendship_list_item"] = function anonymous(it) {
  var out='';  var friend = it, avatar = helpers.Application.specificImgVersion(friend, 'avatar_versions', 'profile_pic_new', true); stamp = helpers.Channel.friendshipKindStamp(friend);out+='<div class="channel channel--suggested channel--simple object-media '+(friend.type)+' '+(friend.provider || friend.friend_from)+'" data-friendship-type="'+(friend.type)+'" data-friendship-id="'+(friend.id)+'" data-channel-id="'+(friend.friend_id)+'" widget-friendship-item auto-init> <i class="close-small"></i> <div class="object-media__img"> <a href="'+(Routes.channel_path(friend.permalink))+'"> <img '+(avatar)+' width="80" height="80" class="image -rounded -ribbon"> </a> </div> <div class="object-media__body"> <h5 class="channel__title"> <a href="'+(Routes.channel_path(friend.permalink))+'" class="hbold" title="'+(friend.name)+'">'+(friend.name)+'</a> </h5> ';if(stamp){out+=' <p class="channel__stamp">'+(stamp)+'</p> ';}out+=' <div class="channel-follow-button"> '+( JST["app/site/templates/widgets/follow_button/follow_button_init"]({ channelId: friend.friend_id, btnCls: '', iFollow: friend.i_follow_him, fromId: friend.id, followedFrom: friend.follows_by_users_channels }) )+' </div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/friendships_block/friendship_recommended_item"] = function anonymous(it) {
  var out='';  var avatar = helpers.Application.specificImgVersion(it.friend, 'avatar_versions', 'profile_pic_new', true);out+='<div class="channel channel--simple object-media om-gutter--alpha" data-channel-id="'+(it.friend.id)+'"> <div class="object-media__img"> <a href="'+(Routes.channel_path(it.friend.permalink))+'" class="-ribbon"> <img '+(avatar)+' width="110" height="110" class="image"> </a> </div> <div class="object-media__body"> <h5 class="channel__title hbold"> <a href="'+(Routes.channel_path(it.friend.permalink))+'" class="hbold">'+(it.friend.title)+'</a> </h5> <p class="channel__stamp"> '+(helpers.Channel.friendshipKindStamp(it.friend))+' </p> <div class="channel-follow-button"> '+( JST["app/site/templates/widgets/follow_button/follow_button_init"]({ btnCls: it.followCls, channelId: it.friend.friend_id, iFollow: it.friend.i_follow_him, followedFrom: it.friend.follows_by_users_channels }) )+' </div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/friendships_block/friendships_layout"] = function anonymous(it) {
  var out='';  var friends = it.friends || [];out+='<div class="channels-block channels-block--list channels-block--suggested-list box--banner" widget-friendships-block auto-init> <div class="channels-block__heading"> <h3>'+(I18n.t('profile.timeline.friendships_block.heading'))+'</h3> </div> <div class="list"> ';var arr1=friends;if(arr1){var friend,index=-1,l1=arr1.length-1;while(index<l1){friend=arr1[index+=1];out+=' <div class="list__item"> '+( JST["app/site/templates/blocks/friendships_block/friendship_list_item"](friend) )+' </div> ';} } out+=' </div> <a class="channels-block__view-more" href="/friends/who-to-follow">'+(I18n.t('view_all'))+'</a></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/header/create_dropdown_content"] = function anonymous(it) {
  var out='<ul class="list list--selectable header__create-dropdown__content"> <li class="list__item"> <a href="'+(Routes.create_path())+'"> <i>'+(JST["app/site/templates/svg/icons/24/create-a-coub"]())+'</i> <span>'+(I18n.t("create_a_coub_ext"))+'</span> </a> </li> <li class="list__item"> <a href="'+(Routes.new_story_path())+'"> <i>'+(JST["app/site/templates/svg/icons/24/new-story"]())+'</i> <span>'+(I18n.t("stories.add_new"))+'</span> </a> </li></ul>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/notifications_dropdown/notification"] = function anonymous(it) {
  var out='';  var classNames = helpers.Notifications.notificationClassNames(it), bgLink = helpers.Notifications.getBgLink(it); if(it.classes) classNames += " " + it.classes; var friendsKind = siteData.UserData.FRIENDS_NOTIFICATIONS_TYPES; var isfollow = friendsKind.indexOf(it.kind) != -1; isfollow = Params.getBranchValue("current_user.is_admin") ? isfollow : false; if(isfollow) { var obj = helpers.Notifications.getObjectForFriendNotifications(it); } else { var obj = helpers.Notifications.getObject(it); } var type = "coub"; var avatarVersion = 'notification'; var avatarS = 32; var recipientId = it.recipient ? "recipient-id='"+it.recipient.id+"'" : ""; if(isfollow) { avatarVersion = 'medium'; avatarS = 48; classNames += " -medium-avatar"; type = "friend"; }out+='<li class="list__item list__item-beta object-media -clear '+(classNames)+'" block-notifications-group type="'+(type)+'" '+(recipientId)+'> <a href="'+(bgLink)+'"> <div class="object-media__img"> ';if(it.system_notification){out+=' <div class="notification-list__system '+(it.kind)+'"></div> ';}else{out+=' '; var sender = it.senders[0], avatar = helpers.Application.specificImgVersion(sender, 'avatar_versions', avatarVersion); out+=' <a href="'+(Routes.channel_path(sender.permalink))+'"> <img alt="'+(sender.title)+'" class="image -rounded" height="'+(avatarS)+'" width="'+(avatarS)+'" '+(avatar)+'/> ';if(isfollow){out+=' '; var recipientAva = helpers.Application.specificImgVersion(it.recipient, 'avatar_versions', 'tiny'); out+=' <img alt="'+(it.recipient.title)+'" class="image -rounded object-media__img__badge" height="20" width="20" '+(recipientAva)+'/> ';}out+=' </a> ';}out+=' </div> <div class="object-media__body"> <div class="notification-list__object '+(obj.class||'')+'"> '+(obj.object)+' </div> <div> <div class="notification-list__text"> ';if(isfollow){out+=' '+(helpers.Notifications.getTextForFriendsNotification(it))+' ';}else{out+=' '+(helpers.Notifications.getText(it))+' ';}out+=' </div> ';if(!isfollow){out+=' <div class="notification-list__date">'+(helpers.Application.smartDateTime(it, true))+'</div> ';}out+=' </div> </div> </a></li>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/notifications_dropdown/page"] = function anonymous(it) {
  var out=''; if(it.length !== 0){out+=' ';var arr1=it;if(arr1){var notification,index=-1,l1=arr1.length-1;while(index<l1){notification=arr1[index+=1];out+=' '+( JST['app/site/templates/blocks/notifications_dropdown/notification'](notification) )+' ';} } }else{out+=' <li class="notification-list__empty"> '+(I18n.t('notifications_popup.empty'))+' </li>';}return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/blocks/recoubs_in_list_dropdown/recoubs_in_list_dropdown"] = function anonymous(it) {
  var out=''; out+='<div class="dd-recoubs-list list-wrap" data-scroll-type="vertical"> <div class="list"> <div class="dd-recoubs-list__title">'+(I18n.t('tooltips.remix_button.dropdown_title'))+'</div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/channel_item/box_channel_item"] = function anonymous(it) {
  var out='';  var followers = it.channel.followers_count == 1 ? 'one' : 'more', avatar = helpers.Application.specificImgVersion(it.channel, 'avatar_versions', 'profile_pic_new', true), bannerImg = it.channel.background_image ? "background-image: url(" + it.channel.background_image + ")" : '';out+='<div class="channel channel--box-card box box-card box--banner '+(it.classNames || '')+'" data-channel-id="'+(it.channel.id)+'"> <a href="'+(Routes.channel_path(it.channel.permalink))+'"class="box-card__screen" style="'+(bannerImg)+'"></a> <div class="box-card__meta"> <div class="channel__avatar"> <a href="'+(Routes.channel_path(it.channel.permalink))+'"> <img '+(avatar)+' width="56" height="56" class="image"> </a> </div> <div class="channel-follow-button"> '+( JST["app/site/templates/widgets/follow_button/follow_button_init"]({ btnCls: it.followCls, channelId: it.channel.id, iFollow: it.channel.i_follow_him, followedFrom: it.channel.follows_by_users_channels, btnCls: '', ddCls: it.ddCls || '' }) )+' </div> <h5 class="channel__title hbold"> <a href="'+(Routes.channel_path(it.channel.permalink))+'"> '+(it.channel.title)+' </a> </h5> ';if(it.channel.description){out+=' <p class="channel__description">'+(it.channel.description)+'</p> ';}out+=' <p class="channel__counters"> ';if(!it.dontRenderCounters){out+=' '+( JST["app/site/templates/channel_item/box_channel_item_coubs_count"]({channel: it.channel}) )+' ';}else{out+=' &nbsp; ';}out+=' </p> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/channel_item/box_channel_item_coubs_count"] = function anonymous(it) {
  var out=''; var coubsCountKey = it.coubs_count_key ? it.coubs_count_key : "coubs_count"; var coubs = it.channel[coubsCountKey], recoubs = it.channel.recoubs_count;if(coubs > 0 || recoubs > 0){out+=' ';if(coubs > 0){out+=' <a class=\'-ribbon-hvr-text\' href="'+(Routes.channel_path(it.channel.permalink) + '#simples')+'"> '+(I18n.t('channel.coubs_count', {count: coubs}))+' </a> ';}out+=' ';if(coubs > 0 && recoubs > 0){out+=' <span class="middot"></span> ';}out+=' ';if(recoubs > 0){out+=' <a class=\'-ribbon-hvr-text\' href="'+(Routes.channel_path(it.channel.permalink) + '#recoubs')+'"> '+(I18n.t('channel.recoubs_count', {count: recoubs}))+' </a> ';}}else{out+=' <span> '+(I18n.t('channel.no_coubs'))+' </span>';}return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/channel_item/my_recommendations_channel"] = function anonymous(it) {
  var out=''; var avatar = helpers.Application.specificImgVersion(it.channel, 'avatar_versions', 'tiny'), classNames = it.isActive ? '-on' : '';out+='<li class="list__item list__item-alpha object-media '+(classNames)+'" data-channel-id=\''+(it.channel.id)+'\' data-channel-permalink=\''+(it.channel.permalink)+'\'> <div class="object-media__img"> <img height="32" width="32" class="image -rounded" '+(avatar)+'/> </div> <div class="object-media__body dd-channel-list__title"> '+(it.channel.title)+' </div></li>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/channel_item/my_recommendations_channels_list"] = function anonymous(it) {
  var out='';  var avatar;var arr1=it.channels;if(arr1){var channel,index=-1,l1=arr1.length-1;while(index<l1){channel=arr1[index+=1];out+=' '+( JST["app/site/templates/channel_item/my_recommendations_channel"](channel) );} } return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/channel_item/recommendation_channel"] = function anonymous(it) {
  var out=''; var avatar = helpers.Application.specificImgVersion(it, 'avatar_versions', 'profile_pic_new', true), splitted = it.title.split(' ');out+='<div class="list__item"> <div class="channel channel--simple object-media om-gutter--alpha" data-channel-id="'+(it.id)+'"> <i class="close-small" data-delete-channel></i> <div class="object-media__img"> <i data-sort-handle class="reposition"></i> <a href="'+(Routes.channel_path(it.permalink))+'"> <img '+(avatar)+' width="80" height="80" class="image -rounded -ribbon"> </a> </div> <div class="object-media__body"> <h5 class="channel__title hbold"> ';if(it.crown){out+=' '; var tooltip = it.channel_owner ? I18n.t('channel_recommendation.run_by_someone', {name: it.channel_owner}) : I18n.t('channel_recommendation.run_by_me'); splitted[splitted.length - 1] += '<i class="crown box--vertical" data-prompt="'+(utils.encodeQuotes(tooltip))+'"></i>'; out+=' ';}out+=' <a href="'+(Routes.channel_path(it.permalink))+'" title="'+(utils.encodeQuotes(it.title))+'" class="hbold"> ';var arr1=splitted;if(arr1){var char,i=-1,l1=arr1.length-1;while(i<l1){char=arr1[i+=1];out+=' <span>'+(char)+'</span> ';} } out+=' </a> </h5> ';if(it.description){out+=' <p class="channel__stamp" title="'+(utils.encodeQuotes(it.description))+'"> '+(it.description)+' </p> ';}out+=' <div class="channel-follow-button"> '+( JST["app/site/templates/widgets/follow_button/follow_button_init"]({ channelId: it.id, iFollow: it.i_follow_him, followedFrom: it.follows_by_users_channels, btnCls: '' }) )+' </div> </div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/channel_item/simple_channel_item"] = function anonymous(it) {
  var out='';  var avatar = helpers.Application.specificImgVersion(it.channel, 'avatar_versions', 'profile_pic_new', true);out+='<div class="channel channel--simple object-media om-gutter--alpha" data-channel-id="'+(it.channel.id)+'"> <div class="object-media__img"> ';if(it.channel.permalink !== null && it.channel.permalink !== undefined){out+=' <a href="'+(Routes.channel_path(it.channel.permalink))+'" class="-ribbon"> <img '+(avatar)+' width="80" height="80" class="image"> </a> ';}else{out+=' <img '+(avatar)+' width="80" height="80" class="image -rounded"> ';}out+=' </div> <div class="object-media__body"> <h5 class="channel__title hbold"> ';if(it.channel.permalink !== null && it.channel.permalink !== undefined){out+=' <a href="'+(Routes.channel_path(it.channel.permalink))+'" class="hbold">'+(it.channel.title)+'</a> ';}else{out+=' '+(it.channel.title)+' ';}out+=' </h5> ';if(it.channel.description){out+=' <p class="channel__stamp" title="'+(utils.encodeQuotes(it.channel.description))+'"> '+(it.channel.description)+' </p> ';}out+=' <div class="channel-follow-button"> ';  out+=' '+( JST["app/site/templates/widgets/follow_button/follow_button_init"]({ btnCls: it.followCls, channelId: it.channel.friend_id || it.channel.id, iFollow: it.channel.i_follow_him, followedFrom: it.channel.follows_by_users_channels }) )+' </div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/channels/channel_create_popup/attached_channel_page"] = function anonymous(it) {
  var out=''; var avatar = helpers.Application.specificImgVersion(it, 'avatar_versions', 'small', true);out+='<h1>'+(I18n.t('channels.attached_channel_popup.title'))+'</h1><img alt="'+(it.title)+'" '+(avatar)+' width="38" height="38" class="image -rounded"><p> '+(I18n.t("channels.attached_channel_popup.sub", {title: it.title}))+'</p>'+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: "-rn -push-shd -blue", attrs: "", value: I18n.t('channels.attached_channel_popup.button') }));return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/channels/channel_create_popup/create_channel_page"] = function anonymous(it) {
  var out='<div class="dialog__page" page-id="create-channel" create-channel-page auto-init '+(it.startPage)+'> <h1>'+( I18n.t('channels.create_new') )+'</h1> <form accept-charset="UTF-8" action="'+( Routes.api_v2_channels_path() )+'" method="post"> <div class="input-field-group -with-prefix" widget-transliteration-inputs auto-init> <input type="text" id="channel_title" name="channel[title]" placeholder="'+( I18n.t('channels.create_popup.title_placeholder') )+'" data-transliteration-type="changeable"> <input type="text" id="channel_permalink" name="channel[permalink]" data-transliteration-type="listener"> <div class="input-field__prefix prefix-2"> '+( I18n.t('channels.create_popup.permalink_placeholder') )+' </div> </div> <div class="-error-text" style="display:none"></div> <div class="sb-group sb-group--simple"> <button class="sb -sb-beta -st -rn -grey" type="button" close-popup>'+( I18n.t('channels.create_popup.cancel_button') )+'</button> <button class="sb -sb-beta -push-shd -rn -blue" type="submit">'+( I18n.t('channels.create_popup.create_button'))+'</button> </div> </form> <button type="button" class="sb -string" link-page-move>'+(I18n.t('channels.create_popup.link_button'))+'</button></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/channels/channel_create_popup/create_channel_popup_content"] = function anonymous(it) {
  var out='<div class="dialog"> <div class="dialog__navigation"> <div class="back" style="display:none">Back</div> </div> <div class="dialog__pages"> '+( JST["app/site/templates/channels/channel_create_popup/create_channel_page"]() )+' '+( JST["app/site/templates/channels/channel_create_popup/link_account_page"]() )+' </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/channels/channel_create_popup/link_account_page"] = function anonymous(it) {
  var out='<div class="dialog__page" page-id="link-account" style="display:none" link-account-page auto-init> <h1>'+(I18n.t('channels.link_popup.title'))+'</h1> <p>'+(I18n.t('channels.link_popup.sub'))+'</p> <form accept-charset="UTF-8" action="" method=""> <div class="input-field-group"> <input type="text" id="email" name="email" placeholder="Email"> <input type="password" id="password" name="password" placeholder="Password"> </div> <div class="-error-text" style="display:none"></div> <div class="sb-group sb-group--simple"> <button type="button" class="sb -sb-beta -st -rn -grey" close-popup>'+(I18n.t('channels.link_popup.cancel'))+'</button> <button type="submit" class="sb -sb-beta -push-shd -rn -blue">'+(I18n.t('channels.link_popup.button'))+'</button> </div> </form></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/channels/edit/channel_settings_page"] = function anonymous(it) {
  var out=''; var description = it.description == null ? '' : it.description, channelsCount = Params.getBranchValue("current_user.channels").length, key = channelsCount > 1 ? 'channel' : 'account', checked, rightcol_html = it.rightcol_custom_html == null ? '': it.rightcol_custom_html;out+='<form accept-charset="UTF-8" action="'+(Routes.update_info_api_v2_channels_path())+'" enctype="multipart/form-data" method="post" novalidate="novalidate"> <div style="margin:0;padding:0;display:inline"> <input name="utf8" type="hidden" value="✓"> <input name="_method" type="hidden" value="put"> </div> <input type="hidden" value="'+(it.id)+'" id="channel_id" name="id"> <input name="channel[password]" id="password" type="hidden" value=""> <div class="grid-container settings"> <div class="grid-col -col-one-third neq"> <label for="channel_title">'+(I18n.t('profile.edit.profile_settings.title'))+'</label> </div> <div class="grid-col -col-two-thirds"> <input class="input-field -sq" type="text" id="channel_title" name="channel[title]" value="'+(it.title)+'"> <div class=\'-error-text -hidden\'></div> </div> <div class="grid-col -col-one-third neq"> <label for="channel_permalink">'+(I18n.t('profile.edit.profile_settings.username'))+'</label> </div> <div class="grid-col -col-two-thirds"> <div class="input-field-group -with-prefix"> <input class="input-field -sq ignore" id="channel_permalink" maxlength="100" name="channel[permalink]" type="text" value="'+(it.permalink)+'" '+(it.can_change_permalink ? "" : "disabled")+'> <div class="input-field__prefix">coub.com/</div> </div> <div class="settings__permalink-description">'+( I18n.t("profile.edit.profile_settings.username_rules") )+'</div> <div class=\'-error-text -hidden\'></div> </div> <div class="grid-col -col-one-third neq"> <label for="channel_description">'+(I18n.t('profile.edit.profile_settings.description'))+'</label> </div> <div class="grid-col -col-two-thirds"> <textarea class="input-field -sq" id="channel_description" name="channel[description]" rows="20" widget-field-counter auto-init count-limit=\'140\'>'+(description)+'</textarea> <div class="settings__desc-counter -right-text"> <span class="counter" widget-field-counter-indicator>140</span> '+( I18n.t('profile.edit.profile_settings.textarea_sub') )+' </div> <label class="settings__hide-owner checkbox-field box--inline" for="channel_hide_owner"> <input type="hidden" name="channel[hide_owner]" value="false"> <input '+(it.hide_owner ? 'checked' : '')+' id="channel_hide_owner" name="channel[hide_owner]" type="checkbox" value="true"> <div class="checkbox"></div> '+( I18n.t("profile.edit.hide_owner"))+' </label> </div> <div class="grid-col -col-one-third neq"> <label>'+(I18n.t('profile.edit.profile_settings.social_networks'))+'</label> </div> <div class="grid-col -col-two-thirds"> ';var arr1=helpers.Channel.linkOrder();if(arr1){var value,index=-1,l1=arr1.length-1;while(index<l1){value=arr1[index+=1];out+=' '+( JST["app/site/templates/channels/edit/widgets/authentication_button"]({ object: it, provider: value, type: "channel", autopost: ['google', 'facebook', 'vine'].indexOf(value) === -1, unlinkable: value !== 'vine' ? false : true }) )+' ';} } out+=' ';var arr2=Params.get('channel_contacts_list');if(arr2){var value,index=-1,l2=arr2.length-1;while(index<l2){value=arr2[index+=1];out+=' <input class="input-field -sq settings__link-field '+(value)+'" id="channel_'+(value)+'" name="channel['+(value)+']" placeholder="'+(helpers.Application.capitalize(value))+'" type="text" value="'+(helpers.Channel.socialLink(it.contacts, value))+'"> ';} } out+=' </div> ';if(it.is_promo_account){out+=' <div class="grid-col -col-one-third neq"> <label for="channel_rightcol_custom_html">Custom HTML</label> </div> <div class="grid-col -col-two-thirds"> <textarea class="input-field -sq" id="channel_rightcol_custom_html" name="channel[rightcol_custom_html]" rows="20">'+(rightcol_html)+'</textarea> </div> ';}out+=' </div> <div class="settings__submit"> <div class="grid-container"> <div class="grid-col -col-one-half"> <button type="button" class="sb -string delete-channel"> '+(I18n.t('profile.edit.account_settings.delete_' + key + '_button'))+' </button> </div> <div class="grid-col -col-one-half -right-text"> <button type="submit" class="sb -rn -push-shd -blue -sb-gamma submit-settings"> '+(I18n.t('profile.edit.save_settings'))+' </button> </div> </div> </div></form>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/channels/edit/navigation"] = function anonymous(it) {
  var out=''; var avatar;out+='<ul class="list edit-account__nav"> <li class="list__item" data-entity="user" data-entity-id="'+(Params.getBranchValue('current_user.id'))+'"> <i class="box--vertical"></i> <span class="box--vertical -truncate-text"> '+( I18n.t('profile.edit.account_settings.title') )+' </span> </li> ';var arr1=Params.getBranchValue('current_user.channels');if(arr1){var channel,index=-1,l1=arr1.length-1;while(index<l1){channel=arr1[index+=1];out+=' '; avatar = helpers.Application.specificImgVersion(channel, 'avatar_versions', 'notification'); out+=' <li class="list__item" data-entity="channel" data-entity-id=\''+(channel.id)+'\' data-entity-permalink=\''+(channel.permalink)+'\'> <img height="30" width="30" class="image -rounded box--vertical" '+(avatar)+'/> <span class="box--vertical -truncate-text"> '+(channel.title)+' </span> </li> ';} } out+=' <li class="list__item" widget-create-channel-popup auto-init> <i class="box--vertical"></i> <span class="box--vertical -truncate-text"> '+( I18n.t('profile.edit.account_settings.add_new_channel') )+' </span> </li></ul>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/channels/edit/user_settings_page"] = function anonymous(it) {
  var out='<form accept-charset="UTF-8" action="'+(Routes.update_regular_info_api_v2_users_path())+'" enctype="multipart/form-data" method="post" novalidate="novalidate"> <div style="margin:0;padding:0;display:inline"> <input name="utf8" type="hidden" value="✓"> <input name="_method" type="hidden" value="put"> </div> <input name="user[password]" id="password" type="hidden" value=""> <div class="grid-container settings"> ';if(GlobalState.USER.isAdmin()){out+=' <div class="grid-col -col-one-third neq"> <label for="user_current_locale">'+( I18n.t('profile.edit.account_settings.locale') )+'</label> </div> <div class="grid-col -col-two-thirds"> <select class="input-field -sq ignore" name="user[current_locale]"> ';var arr1=[['en', 'English'], ['ru', 'Russian']];if(arr1){var lang,i1=-1,l1=arr1.length-1;while(i1<l1){lang=arr1[i1+=1];out+=' <option value="'+(lang[0])+'" ';if(it.current_locale == lang[0]){out+='selected';}out+='>'+(lang[1])+'</option> ';} } out+=' </select> </div> ';}out+=' <div class="grid-col -col-one-third neq" id="user_email_input"> '+( I18n.t('profile.edit.account_settings.email') )+' </div> <div class="grid-col -col-two-thirds"> <input class="input-field -sq ignore" id="user_email" maxlength="255" name="user[email]" type="email" value="'+(it.email||'')+'"> </div> <div class="grid-col -col-one-third neq"> '+( I18n.t('profile.edit.account_settings.gender') )+' </div> <div class="grid-col -col-two-thirds"> '+( JST["app/site/templates/channels/edit/widgets/gender_pick_buttons"]({sex: it.sex, name: 'user[sex]', id: 'user_sex'}) )+' </div> <div class="grid-col -col-one-third neq"> '+( I18n.t('profile.edit.account_settings.date_of_birth') )+' </div> <div class="grid-col -col-two-thirds"> '+( JST["app/site/templates/channels/edit/widgets/nice_date_select"]({ birthday: Params.getBranchValue("current_user.birthday"), name: 'user[birthday]', id: 'user_birthday' }) )+' </div> <div class="grid-col -col-one-third neq"> '+( I18n.t('profile.edit.account_settings.password') )+' </div> <div class="grid-col -col-two-thirds"> <button type="button" class="sb -st -sq -sb-beta change-pass"> '+( I18n.t('profile.edit.change_pass') )+' </button> </div> <div class="grid-col -col-one-third neq"> '+( I18n.t('profile.edit.account_settings.phone_number') )+' </div> <div class="grid-col -col-two-thirds change-phone-number"></div> </div> <div class="settings__email"> '+( JST["app/site/templates/channels/edit/widgets/email_settings"](it) )+' </div> <div class="-centered-text settings__submit"> <button type="submit" class="sb -rn -push-shd -blue -sb-gamma submit-settings"> '+(I18n.t('profile.edit.save_settings'))+' </button> </div></form>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/channels/edit/widgets/authentication_button"] = function anonymous(it) {
  var out=''; var connected     = helpers.Channel.hasAuthentication(it.provider, it.object.authentications), buttonClass   = connected ? 'connected' : '', providerName  = helpers.Application.capitalize(it.provider), text          = connected ? 'Unlink' : providerName, providerUserName = helpers.Channel.getProviderUserName(it.provider, it.object.authentications);out+='<div class="settings__auth '+(it.provider)+' '+(buttonClass)+'"> <div class="settings__auth-button"> <i class="-soc-i-big-'+(it.provider)+' box--inline"></i> <span class="settings__auth-user hbold">'+(providerUserName)+'</span> ';if(!connected || !it.unlinkable){out+=' <button class="sb -st -sq '+(it.provider)+'" type="button" data-connect-text="'+(it.provider)+'" data-connected="'+(connected)+'" data-disconnect-text="Unlink" data-provider="'+(it.provider)+'" data-channel-id="'+(it.object.id)+'"> <span>'+(text)+'</span> <i class="-soc-i-big-'+(it.provider)+' box--inline"></i> </button> ';}out+=' </div> ';if(it.autopost){out+=' <div class="settings__auth-autopost"> ';var arr1=['coub', 'recoub'];if(arr1){var value,index=-1,l1=arr1.length-1;while(index<l1){value=arr1[index+=1];out+=' '; var key = 'autopost_' + value + '_to_' + it.provider, checked = it.object[key] ? 'checked' : ''; out+=' <label class="checkbox-field" for="channel_'+(key)+'"> <input type="hidden" name="channel['+(key)+']" value="false"> <input '+(checked)+' id="channel_'+(key)+'" name="channel['+(key)+']" type="checkbox" value="true"> <div class="checkbox"></div> '+(I18n.t('profile.edit.profile_settings.autopost_to_social.' + value, {social: it.provider}))+' </label> ';} } out+=' </div> ';}out+='</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/channels/edit/widgets/delete_channel/delete_channel_confirm_page"] = function anonymous(it) {
  var out=''; var channels = Params.getBranchValue("current_user.channels"), key = channels.length > 1 ? 'channel' : 'account';out+='<div class="dialog__page" page-id="delete-account" start-page> <h1> '+(I18n.t("profile.edit.account_settings.delete_" + key + "_heading"))+' </h1> <p> '+(I18n.t("profile.edit.account_settings.delete_" + key + "_sub"))+' </p> <button class="sb -rn -push-shd -sb-beta -red" move-to-confirm type="button"> '+(I18n.t("profile.edit.account_settings.delete_" + key + "_button"))+' </button></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/channels/edit/widgets/email_settings"] = function anonymous(it) {
  var out=''; var checked;out+='<h5>'+(I18n.t('profile.edit.email_settings.title'))+'</h5><p>'+(I18n.t('profile.edit.email_settings.sub'))+'</p><div class="email__options"> ';var arr1=Params.get('user_mail_settings');if(arr1){var value,index=-1,l1=arr1.length-1;while(index<l1){value=arr1[index+=1];out+=' '; checked = it[value] ? 'checked' : ''; out+=' <label class="checkbox-field" for="user_'+(value)+'"> <input type="hidden" name="user['+(value)+']" value="false"> <input '+(checked)+' id="user_'+(value)+'" name="user['+(value)+']" type="checkbox" value="true"> <div class="checkbox"></div> '+( I18n.t("profile.edit.email_settings.mails." + value) )+' </label> ';} } out+='</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/channels/edit/widgets/gender_pick_buttons"] = function anonymous(it) {
  var out=''; var value = it.sex !== undefined && it.sex !== null ? it.sex : '', variants = ['male', 'female', 'unspecified'];out+='<div class="gender-pick sb-group sb-group--join -st -rn"> <input class="gender-input" id="'+(it.id)+'" name="'+(it.name)+'" type="hidden" value="'+(value)+'"> ';var arr1=variants;if(arr1){var gender,index=-1,l1=arr1.length-1;while(index<l1){gender=arr1[index+=1];out+=' <div class="sb-join__btn"> '+( JST['app/site/templates/widgets/buttons/simple_button']({ classes: "-st", attrs: "data-val=" + gender, value: I18n.t('auth_popup.signup.birthcontrol.sex.' + gender) }) )+' </div> ';} } out+='</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/channels/edit/widgets/modals/change_password_content"] = function anonymous(it) {
  var out='<h1>'+(I18n.t('profile.edit.change_pass'))+'</h1><form action="/" class="password-form"> <input type="hidden" name="reset_api_token" value="1" /> <input class="input-field -sq" id="user_password" name="user[password]" placeholder="Current password" type="password"> <div class="password-form__reset -right-text"> '+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: '-string ', attrs: 'reset-pass-button', value: I18n.t('auth_popup.signin.reset.forgot_password'), type: 'button' }) )+' </div> <div class="-error-text -hidden"></div> <div class="password-form__new-password"> <input class="input-field -sq" name="user[password_changing]" placeholder="New password" type="password"> <label class="pass-checker hbold -hidden"> <span>'+(I18n.t('profile.edit.weak_pass'))+'</span> </label> </div> '+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: '-rn -push-shd -blue -sb-beta', attrs: '', value: I18n.t('auth_popup.buttons.change'), type: 'submit' }) )+'</form><div class="reset-pass__notify box-beta -hidden"> '+(I18n.t('auth_popup.signin.reset.sent_instructions'))+'</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/channels/edit/widgets/modals/confirm_password_content"] = function anonymous(it) {
  var out='<div class="dialog__page" page-id="confirm-password"> <h1>'+(I18n.t('profile.edit.confirm_pass'))+'</h1> <form action="/" class="password-form"> <input class="input-field -sq" id="user_password" name="user[password]" placeholder="Password" type="password"> <div class="password-form__reset -right-text"> '+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: '-string', attrs: 'reset-pass-button', value: I18n.t('auth_popup.signin.reset.forgot_password'), type: 'button' }) )+' </div> <div class="-error-text -hidden"></div> '+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: '-push-shd -rn -blue -sb-beta', value: I18n.t('auth_popup.buttons.done'), type: 'submit' }) )+' </form> <div class="reset-pass__notify box-beta"> '+(I18n.t('auth_popup.signin.reset.sent_instructions'))+' </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/channels/edit/widgets/nice_date_select"] = function anonymous(it) {
  var out=''; var variants = ['month', 'day', 'year'], option;out+='<div class="date-select"> <input class="date-select__input" data-default-date="'+(it.birthday)+'" id="'+(it.id)+'" name="'+(it.name)+'" type="hidden" value="'+(it.birthday)+'"> <div> ';var arr1=variants;if(arr1){var value,index=-1,l1=arr1.length-1;while(index<l1){value=arr1[index+=1];out+=' '; option = helpers.Channel.getBirthday(value, it.birthday); out+=' '+( JST["app/site/templates/widgets/date_select/date_dropdown"]({type: value, value: option}) )+' ';} } out+=' </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/channels/edit/widgets/phone_settings"] = function anonymous(it) {
  var out='<div class="settings__auth firebase';if(it){out+=' connected';}out+='"> <div class="settings__auth-button"> <i class="-soc-i-big-phone"></i> <span class="settings__auth-user hbold">'+(it)+'</span> <button type="button" class="sb -st -sq"> ';if(it){out+=' <span>'+(I18n.t('profile.edit.account_settings.unlink_phone_number'))+'</span> ';}else{out+=' <span>'+(I18n.t('profile.edit.account_settings.link_phone_number'))+'</span> ';}out+=' <i class="-soc-i-big-phone"></i> </button> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/coub"] = function anonymous(it) {
  var out=''; var it = helpers.Coub.calculatePropertiesForViewIfNotComputed(it), originalCoub = helpers.Coub.getOriginalCoub(it), classNames = [], isCoubPage = it.computed.cardType.name === 'page', timelineBannerId = widgets.TimelineBanner.getBannerIdForCoub(it), timelineIndex = '', timelinePage = ''; it.type === "Coub::Recoub" && classNames.push('coub--recoubed'); !isCoubPage && classNames.push('coub--timeline'); it.render["editor-controls"] === "true" && classNames.push('coub--editorial'); classNames.push('coub--' + it.computed.cardClassName); (it.error || !it.is_done) && classNames.push('coub--full-width'); if (it.render["card-class"]) { classNames.push(it.render["card-class"]); } if (!isNaN(it.timelineIndex)) { timelineIndex = ' timeline-index="' + it.timelineIndex + '"'; } if (!isNaN(it.timelinePage)) { timelinePage = ' timeline-page="' + it.timelinePage + '"'; } if (it.render["promoted"]) { classNames.push("coub--promoted"); }if(it.render["editor-controls"] === "true"){out+=' <div class="editorial-container -clear"> <div class="coub__moderation--inline box--banner" editor-controls></div>';}out+='<div coub-block class="coub '+(classNames.join(' '))+'" data-type="'+(it.type)+'" data-permalink="'+(originalCoub.permalink)+'" data-id="'+(it.id)+'" card-type="'+(it.computed.cardType.name)+'" card-status="'+(it.computed.cardStatus.name)+'"'+(timelineIndex)+(timelinePage)+'> ';if((it.type == "Coub::Temp" || !it.is_done) && !it.render['no-sound-on-reload']){out+=' <audio id="coubIsDoneSound"> <source src="/audios/ding.ogg"> <source src="/audios/ding.mp3"> </audio> ';}out+=' <div class="coub__inner"> ';if(it.render["promo-hint"] === "true" && it.promo_hint){out+=' <p class="coub__hint-title">'+(it.promo_hint)+'</p> ';}out+=' <div class="coub__vd"> <div class="coub__viewer"> '+( it.computed.cardStatus.viewerBlockTemplate(it) )+' </div> ';if(!isCoubPage && timelineBannerId){out+=' <div class="coub__banner-timeline" data-channel-id='+(timelineBannerId)+'> <img/> <div class="coub__banner-timeline__close"></div> </div> ';}out+=' <div class="coub__description"> ';if(!helpers.Coub.isPrivateAndNonAuthor(it)){out+=' '+( JST["app/site/templates/coub_block/parts/description"](it) )+' ';}out+=' ';if(Params.getBranchValue("current_user.is_editor") && it.is_done && it.type !== "Coub::Temp"){out+=' <div class="open-moderation wsymreg -ribbon-hvr-text -color--tundora -hidden" data-coub-id="'+(it.permalink)+'">+</div> ';}out+=' ';if(Params.getBranchValue("current_user.is_editor") && GlobalState.PAGE.isTagPage()){out+=' <div class="coub__evict wsymreg -ribbon-hvr-text -color--tundora" title="'+(I18n.t('editor.remove_tag_from_coub.hint'))+'" widget-delete-coub-tag auto-init data-coub-permalink="'+(it.permalink)+'">-</div> ';}out+=' ';if(helpers.Coub.showEditorInfo(it)){out+=' '+(JST["app/site/templates/coub_block/editor_specific/editor_info"](helpers.Coub.getOriginalCoub(it)))+' ';}out+=' </div> </div> ';if(!it.render["no-sharing"]){out+=' '+( JST["app/site/templates/coub_block/parts/sharing"](it) )+' ';}out+=' </div> ';if(isCoubPage && !helpers.Coub.isPrivateAndNonAuthor(it)){out+=' <div class="coub__info"> '+(JST["app/site/templates/channel_item/box_channel_item"]({channel: it.channel, classNames: '', ddCls: 'dropdown--shift-left'}))+' ';if(helpers.Coub.showMedia(it) && helpers.Coub.visibleForCurrentUser(it) && it.is_done){out+=' '+(JST["app/site/templates/media_block/media_block"](it))+' ';}out+=' <div coub-channel-coubs auto-init data-coub-id="'+(it.id)+'" data-channel-permalink="'+(it.channel.permalink)+'" data-channel-title="'+(it.channel.title)+'"></div> </div> ';}out+=' <div class="dontRenderSearchableTitle">'+(it.title)+'</div> '+(JST["app/site/templates/coub_block/resources"](it))+' ';if(it.render["abuses"] === "true" && it.render["editor-controls"] === "true"){out+=' <div editor-abuses-list-placement></div> ';}out+='</div>';if(it.render["editor-controls"] === "true"){out+=' </div>';}return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/coub_like_points_dropdown"] = function anonymous(it) {
  var out='<div class="box--inline like-points-dropdown"> ';if(it.like_stats.by_source){out+=' <table> <caption class="hbold">Like Stats</caption> <tr> <th></th> <th>points</th> <th>likes</th> </tr> <tr> <td class="-italic">total world</td> <td>'+( it.like_stats.total_points )+'</td> <td>'+( it.like_stats.total_likes )+'</td> </tr> <tr> <td class="-italic">total region</td> <td>'+( it.like_stats.region_points )+'</td> <td>'+( it.like_stats.region_likes )+'</td> </tr> ';if(it.like_stats.by_source && it.like_stats.by_source.length){out+=' <tr> <td colspan="3" class="-centered-text hbold">current region by source</td> </tr> ';var arr1=it.like_stats.by_source;if(arr1){var stat,i1=-1,l1=arr1.length-1;while(i1<l1){stat=arr1[i1+=1];out+=' <tr> '; var decodedSource = decodeURIComponent(stat.source), encodedSource = decodedSource.replace(/</g, '&lt;'); out+=' <td> <div class="like-points-dropdown__source -truncate-text" title="'+( utils.encodeQuotes(decodedSource, false) )+'"> '+( encodedSource || "unknown" )+' </div> </td> <td>'+( stat.points )+'</td> <td>'+( stat.likes )+'</td> </tr> ';} } out+=' ';}out+=' ';if(it.like_stats.by_region && it.like_stats.by_region.length){out+=' <tr> <td colspan="3" class="-centered-text hbold">by region</td> </tr> ';var arr2=it.like_stats.by_region;if(arr2){var stat,i2=-1,l2=arr2.length-1;while(i2<l2){stat=arr2[i2+=1];out+=' <tr> <td> <div class="like-points-dropdown__source -truncate-text" title="'+( utils.encodeQuotes(stat.region_title, false) )+'"> '+( stat.region_title )+' </div> </td> <td>'+( stat.points )+'</td> <td>'+( stat.likes )+'</td> </tr> ';} } out+=' ';}out+=' </table> ';}else{out+=' <strong>likes points:</strong> region - '+( it.like_stats.region_points )+', total - '+( it.like_stats.total_points )+' ';}out+='</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/editor_specific/editor_coub_controls"] = function anonymous(it) {
  var out=''; var coub = it.data.coub, type = it.type, editedByOwner = !!it.data.edited_by_owner_at;out+='<div class="coub__moderation-controls"> <div class="grid-container"> ';if(type === 'dropdown'){out+=' <div class="grid-col -col-two-thirds"> ';}out+=' <section class="box-beta moderation__form"> '+( JST["app/site_admin/templates/editorial_popup/categories_and_flags"](it) )+' </section> <section class="box-alpha"> '+( JST["app/site_admin/templates/editorial_popup/editor_recouber"]({coubId: coub.id, channels: [it.data.editors_channels, it.data.taken_channels]}) )+' </section> <section class="box-alpha"> '+( JST["app/site_admin/templates/editorial_popup/editor_categories"]({coubId: coub.id, categories: [it.data.categories, it.data.coub_categories]}) )+' </section> ';if(it.best2016_controls){out+=' <section class="box-alpha"> '+( JST["app/site_admin/templates/editorial_popup/editor_best2016_controls"]({coub_id: coub.id}) )+' </section> ';}out+=' <section class="box-alpha"> '+( JST["app/site_admin/templates/editorial_popup/editor_coub_info"](it) )+' </section> ';if(type === "dropdown" && it.data.trends.length){out+=' <section class="box-alpha"> '+( JST["app/site_admin/templates/editorial_popup/editor_trends"](it) )+' </section> ';}out+=' ';if(type === 'dropdown'){out+=' <section class="box-alpha"> '+( JST["app/site_admin/templates/editorial_popup/audio_copyright_claim"](it.data.coub) )+' </section> ';}out+=' ';if(type === 'timeline' && (editedByOwner || coub.abuses.length)){out+=' <section class="box-alpha -clear"> '+( JST["app/site_admin/templates/editorial_popup/editor_abuses"]({coub: it.data.coub, editedByOwner: editedByOwner}) )+' </section> ';}out+=' ';if(type === "dropdown"){out+=' </div> ';}out+=' ';if(type === 'dropdown'){out+=' <div class="grid-col -col-one-third neq box-alpha moderation__log"> '+( JST["app/site_admin/templates/editorial_popup/moderation_log"](it) )+' </div> ';}out+=' </div> ';if(type == 'dropdown'){out+=' '+( JST["app/site_admin/templates/editorial_popup/editor_coub_stats"](it) )+' ';}out+='</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/editor_specific/editor_info"] = function anonymous(it) {
  var out=''; var editorInfo = it.editorial_info, adminName = editorInfo.last_moderated_by.name, adminLink = editorInfo.last_moderated_by.permalink, showData = []; var categories = { no_category: editorInfo.no_category, banned: editorInfo.banned, copyright_banned: editorInfo.copyright_banned, bookmarked: editorInfo.bookmarked, explore: editorInfo.visible_on_explore_root, age_restricted: editorInfo.age_restricted_by_admin, not_safe_for_work: editorInfo.not_safe_for_work }; Object.keys(categories).forEach(function(key) { if (categories[key] == true) { showData.push(key); } });out+='<div class="moderation-flags"> ';var arr1=showData;if(arr1){var value,index=-1,l1=arr1.length-1;while(index<l1){value=arr1[index+=1];out+=' <i class="moderation-flags__flag '+(value)+' box--vertical"></i> ';} } out+=' <a href="/'+(adminLink)+'" class="moderation-flags__editor -undr box--vertical">'+(adminName)+', '+(moment(editorInfo.moderated_at).format('YYYY DD MMM'))+'</a></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/editor_specific/like_points_info"] = function anonymous(it) {
  var out='<span class="-hidden" like-points-coub-handle data-id="'+(it.id)+'">&nbsp;&#183;&nbsp;Σ</span>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/mobile/coub_mobile"] = function anonymous(it) {
  var out='';  var originalCoub = helpers.Coub.getOriginalCoub(it), isAgeRestricted = helpers.Coub.ageRestrictedForCurrentUser(originalCoub), width = originalCoub.page_w_h[0], height = originalCoub.page_w_h[1], ratio = (height / width) * 100, imageUrl = isAgeRestricted ? originalCoub.image_versions.template.replace('%{version}', 'age_restricted') : originalCoub.first_frame_versions.template.replace('%{version}', 'med');out+='<div class="coub-player"> <div class="mobile-resizer" style="padding-bottom:'+(ratio.toFixed(2))+'%;height:0"> <div class="coub__viewer"> <div class="viewer '+(isAgeRestricted && 'viewer--age-restricted' || '')+'"> <img class="viewer__img" src="'+(imageUrl)+'" width="'+(width)+'" height="'+(height)+'"/> <div class="data" style="display:none"> <script id="coubJson" type="text/json">'+(JSON.stringify(originalCoub))+'</script> </div> <div class="viewer__player"> <canvas class="viewer__screen"></canvas> </div> <div class="viewer__controls__container"> <div class="viewer__age-restricted -fill"> <div class="viewer__age-restricted-title">'+(I18n_mobile.age_restricted.title)+'</div> <div class="viewer__age-restricted-header">'+(I18n_mobile.age_restricted.header)+'</div> <div class="viewer__age-restricted-button viewer__click">'+(I18n_mobile.age_restricted.button)+'</div> </div> <div class="viewer__shadow viewer__click -fill"></div> <div class="viewer__mute -hidden -fill"></div> <div class="viewer__hand viewer__click -hidden -fill"> <div class="viewer__hand-button"></div> </div> <div class="viewer__pause -hidden"> <div class="viewer__hand-button viewer__click"></div> </div> <div class="viewer__spinner -hidden"> <svg> <circle /> </svg> </div> <div class="viewer__progress -hidden"> <svg> <circle /> </svg> </div> </div> </div> </div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/mobile/coub_mobile_controls"] = function anonymous(it) {
  var out='';  var originalCoub = helpers.Coub.getOriginalCoub(it), permalink = originalCoub.permalink, coubPath = '/view/' + permalink, likesCount = originalCoub.likes_count, repostsCount = originalCoub.recoubs_count;out+='<ul class="coub-controls"> <li class="like-button" app-popup-handler app-popup-action="like"> '+(JST['app/site/templates/svg/icons/24/like']())+' ';if(likesCount > 0){out+=' <span>'+(likesCount)+'</span> ';}out+=' </li> <li class="repost-button" app-popup-handler app-popup-action="repost"> '+(JST['app/site/templates/svg/icons/24/repost']())+' ';if(repostsCount > 0){out+=' <span>'+(repostsCount)+'</span> ';}out+=' </li> <li class="share-button open-button" data-permalink='+(permalink)+' data-selector=".sharing">'+(JST['app/site/templates/svg/icons/24/share']())+'</li> <li class="options-button">'+(JST['app/site/templates/svg/icons/24/more']())+'</li></ul>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/mobile/coub_mobile_info"] = function anonymous(it) {
  var out='';  var originalCoub = helpers.Coub.getOriginalCoub(it), channel = originalCoub.channel, channelPath = '/' + channel.permalink, avatarPath = channel.avatar_versions.template.replace('%{version}', 'medium_2x'), community = originalCoub.categories[0], viewsCount = originalCoub.views_count, viewsStampText = viewsCount + ' ' + pluralize("view", viewsCount), title = helpers.Coub.getTitle(it);out+='<div class="coub-info"> <a class="channel-userpic-wrapper" href="'+(channelPath)+'"> <img class="channel-userpic" src="'+(avatarPath)+'" width="45" height="45" alt="'+(channel.title)+'"/> </a> <div class="coub-description"> <div class="coub-description-top"> <h1 class="coub-title">'+(title)+'</h1> <div class="coub-add-to-favs" app-popup-handler app-popup-action="bookmark"> '+(JST["app/site/templates/svg/icons/24/bookmark"]())+' </div> </div> <div class="coub-description-mid"> <h2 class="channel-title hbold"> <a href="'+(channelPath)+'">'+(channel.title)+'</a> </h2> <ul class="coub-stamp"> ';if(community){out+=' <li> <a href="'+('/community/' + community.permalink)+'" class="hbold coub-community">'+(community.title)+'</a> </li> ';}out+=' ';if(viewsCount > 0){out+=' <li>'+(viewsStampText)+'</li> ';}out+=' </ul> </div> <div class="coub-description-bottom"> '+(JST["app/site/templates/coub_block/mobile/coub_mobile_controls"](it))+' </div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/parts/controls"] = function anonymous(it) {
  var out=''; var canEdit = helpers.Channel.hasId(it.channel_id), handler, dClass; if ((canEdit && it.type == "Coub::Simple") || Params.getBranchValue("current_user.is_admin")) { handler = JST["app/site/templates/coub_block/static_buttons/edit_button"]({coub: it}); dClass = "editCoubDropdown "; } else { handler = JST["app/site/templates/coub_block/static_buttons/coub_info_button_handler"]({coub: it}); dClass = "editCoubDropdown coubInfoButton "; } var handlerClass = "edit " + (it.is_done ? "" : "disabled "), attrs = canEdit ? "data-prompt=" + I18n.t("coub.buttons.edit.heading") + " data-prompt-top='-3' hideable-prompt" : '', handler = JST['app/site/templates/widgets/buttons/simple_button']({ classes: "-st -rn " + handlerClass, attrs: attrs, value: '' });out+='<div class="sharing__controls box--inline"> ';if(canEdit || Params.getBranchValue("current_user.is_admin")){out+=' '+(JST["app/site/templates/widgets/dropdown_with_handler/dropdown_with_handler"]({ dClass: 'dropdown-info ' + (canEdit ? ' dropdown-info--edit' : ''), hClass: '', handler: handler, content: JST["app/site/templates/coub_block/static_buttons/edit_button_contents"]({coub: it}) }) )+' ';}out+='</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/parts/coub_stamp/coub_privacy_icon"] = function anonymous(it) {
  var out=''; var visibility = it.visibility, size = it.isSmallCard ? 24 : 16, icon = ''; switch (visibility) { case 'private': icon = JST['app/site/templates/svg/icons/' + size + '/lock'](); break; case 'friends': icon = JST['app/site/templates/svg/icons/' + size + '/members'](); break; case 'unlisted': icon = JST['app/site/templates/svg/icons/' + size + '/unlock'](); break; case 'nsfw': icon = 'NSFW'; break; }out+='<i class="description__icon '+(visibility)+'" data-prompt=\''+(I18n.t("coub.visibility_description." + visibility))+'\'>'+(icon)+'</i>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/parts/coub_stamp/coub_published_at_stamp"] = function anonymous(it) {
  var out=''; var original = helpers.Coub.getOriginalCoub(it), date = helpers.Application.smartDateTime(original, false, "published_at"), middot = "&nbsp;&#183;&nbsp;";out+='<span class="'+(it.render["no-date"] === "hover" ? "description__stamp__published-at--hover -hidden" : "")+'">'+(middot)+(date)+'</span>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/parts/coub_stamp/coub_user_stamp"] = function anonymous(it) {
  var out=''; var stamp = [], original = helpers.Coub.getOriginalCoub(it), middot = ' &#183; ', icons = helpers.Coub.coubPrivacyIcon(it), isPromoted = it.render && it.render.promoted; stamp.push(helpers.Coub.coubUserStamp(it, false, isPromoted)); if (!GlobalState.PAGE.isCoubPage()) { var externalStamp = helpers.Coub.externalDownloadStamp(original); if (externalStamp) { stamp.push(externalStamp); } } if (icons != "") { stamp.push(middot); stamp.push(icons); } if (original.published && it.render["no-date"] !== "hidden") { var dateStamp = JST["app/site/templates/coub_block/parts/coub_stamp/coub_published_at_stamp"](it); stamp.push(dateStamp); }  if (GlobalState.PAGE.isStoryPage() && original.published && it.views_count > 0) { stamp.push(middot); stamp.push(JST['app/site/templates/coub_block/parts/coub_stamp/coub_views_stamp']({coub: it})); } if (helpers.Coub.showNSFWSign(original)) { stamp.push(middot); stamp.push(JST['app/site/templates/coub_block/parts/coub_stamp/coub_privacy_icon']({visibility: 'nsfw'})); } if (Params.getBranchValue("current_user.is_editor")) { stamp.push(JST['app/site/templates/coub_block/editor_specific/like_points_info'](original)); }out+=''+(stamp.join(''));if(it.type == "Coub::Recoub"){out+=' '+(JST["app/site/templates/coub_block/parts/coub_stamp/recoub_icons"](it));}return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/parts/coub_stamp/coub_user_stamp_small"] = function anonymous(it) {
  var out=''; var stamp = [], original = helpers.Coub.getOriginalCoub(it), middot = '&nbsp;&#183;&nbsp;', cotdStamp = helpers.Coub.getCotdStamp(it, 16, "description__stamp__cotd-featured"), featuredStamp = helpers.Coub.getFeaturedStamp(it, 16, "description__stamp__cotd-featured"), communityStamp = helpers.Coub.getCommunityStamp(it, "description__stamp__community", 10), hasColoredStamp = Boolean(communityStamp || cotdStamp || featuredStamp); stamp.push(helpers.Coub.coubUserStamp(it, true)); if (hasColoredStamp) stamp.push("&nbsp;", cotdStamp, featuredStamp, communityStamp); if (original.published && it.views_count > 0) { if (hasColoredStamp) { stamp.push('&nbsp;'); } else { stamp.push(middot); } stamp.push(JST['app/site/templates/coub_block/parts/coub_stamp/coub_views_stamp']({coub: it, isSmallCard: true})); } if (Params.getBranchValue("current_user.is_editor")) { stamp.push(JST['app/site/templates/coub_block/editor_specific/like_points_info'](original)); }out+=''+(stamp.join(""));return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/parts/coub_stamp/coub_views_stamp"] = function anonymous(it) {
  var out=''; var coub = it.coub, count = it.isSmallCard ? numeral(coub.views_count).format("0a").replace('m', 'M') : numeral(coub.views_count).format("0,0"), viewsString = count + " " + I18n.t("coub.views_count", {count: count}), original = helpers.Coub.getOriginalCoub(coub), datePromptAttrs = ''; if (it.isSmallCard && original.published && coub.render["no-date"] !== "hidden") { var date = helpers.Application.smartDateTime(original, false, "published_at"); datePromptAttrs = 'data-prompt="' + date + '"hideable-prompt'; }if(it.isSmallCard){out+=' <span '+(datePromptAttrs)+'>'+(viewsString)+'</span>';}else{out+=' <span>'+(viewsString)+'</span>';}return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/parts/coub_stamp/music_icon"] = function anonymous(it) {
  var out=''; var prompt = ""; if (it.media_blocks.audio_track && it.media_blocks.audio_track.meta) { if (it.media_blocks.audio_track.meta.artist) { prompt = [it.media_blocks.audio_track.meta.artist, it.media_blocks.audio_track.title].join(I18n.t('coub.dash')).replace(/\'/g, "&rsquo;"); } else { if (it.media_blocks.audio_track.title) { prompt = it.media_blocks.audio_track.title.replace(/\'/g, "&rsquo;"); } } }out+='<i class="description__music-icon" data-prompt=\''+(prompt)+'\'></i>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/parts/coub_stamp/recoub_icons"] = function anonymous(it) {
  var out=''; var userNameLink = JST['app/site/templates/coub_block/parts/coub_stamp/user_name_link']({channel: it.channel}), isSmallCard = it.render && it.render['card-type'] == 'small';if(isSmallCard){out+=' <i class="description__icon">'+(JST['app/site/templates/svg/icons/24/repost']())+'</i>';}else{out+=' <br/> <i class="description__icon">'+(JST['app/site/templates/svg/icons/16/repost']())+'</i> '+( ' ' + I18n.t("coub.recoub_by", {name: userNameLink}) );}return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/parts/coub_stamp/user_name_link"] = function anonymous(it) {
  var out=''; var channelParam = JSON.stringify(it.channel);out+='<a href="'+(Routes.channel_path(it.channel.permalink))+'" target="_blank" widget-channel-dropdown auto-init channel="'+(utils.encodeQuotes(channelParam))+'"> '+(utils.stripTags(it.channel.title))+'</a>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/parts/description"] = function anonymous(it) {
  var out=''; if (window.env == 'staging' && !it.views_count && Math.random() > 0.5) { it.views_count = _.random(1, 1000000); } var original = helpers.Coub.getOriginalCoub(it), channelUrl = original.channel.permalink; var channelAvatar = helpers.Application.specificImgVersion(original.channel, 'avatar_versions', 'medium', true), channelParam = JSON.stringify(original.channel), imgAttrs = helpers.Coub.imgListenerAttrs(it), icons = [], isSmallCard = it.render && it.render['card-type'] == 'small', isTagsRendered = !isSmallCard && !it.render["no-tags"] && (!_.isEmpty(it.tags) || !_.isEmpty(it.categories) || original.cotd || original.featured || it.render["promoted"]), isViewsCountRendered = !isSmallCard && !it.render["no-views"] && !GlobalState.PAGE.isStoryPage() && it.published && it.views_count > 0; isDislikeRendered = GlobalState.USER.isAdmin() || GlobalState.USER.isEditor() || moment().isSame('2019-04-01', 'day'); if (isSmallCard) { icons.push(helpers.Coub.coubPrivacyIcon(it)); if (it.type == "Coub::Recoub") { icons.push(JST["app/site/templates/coub_block/parts/coub_stamp/recoub_icons"](it)); } }out+='<div class="description__body"> ';if(!isSmallCard){out+=' <div class="description__avatar"> <a target="_blank" href="/'+(channelUrl)+'" class="avatar"> <img '+(channelAvatar)+' width="50" height="50" class="image -ribbon" widget-channel-dropdown auto-init channel="'+(utils.encodeQuotes(channelParam))+'" /> </a> </div> ';}out+=' <div class="description__info"> <h5 class="description__title hbold '+(it.render['one-line-title'] ? '-one-line' : '')+'"> '+(icons.join(''))+' '+(helpers.Coub.getTitle(it))+' </h5> <div class="description__stamp"> ';if(isSmallCard){out+=' '+(JST["app/site/templates/coub_block/parts/coub_stamp/coub_user_stamp_small"](it))+' ';}else{out+=' '+(JST["app/site/templates/coub_block/parts/coub_stamp/coub_user_stamp"](it))+' ';}out+=' </div> </div> <div class="description__controls"> '+(JST["app/site/templates/coub_block/social_action_buttons/like_button"](it))+' ';if(isDislikeRendered){out+=' '+(JST["app/site/templates/coub_block/social_action_buttons/dislike_button"](it))+' ';}out+=' '+(JST["app/site/templates/coub_block/social_action_buttons/recoub_button"](it))+' ';if(!isSmallCard){out+=' '+(JST["app/site/templates/coub_block/social_action_buttons/remix_button"](it))+' ';}out+=' </div></div>';if(isViewsCountRendered || isTagsRendered){out+=' <div class="description__tags-views"> ';if(isViewsCountRendered){out+=' <div class="coub__views-count">'+(JST['app/site/templates/coub_block/parts/coub_stamp/coub_views_stamp']({coub: it, is_small_card: false}))+'</div> ';}out+=' ';if(isTagsRendered){out+=' '+(JST["app/site/templates/coub_block/parts/tags_block"](it))+' ';}out+=' </div>';}if(it.audio_copyright_claim && it.render["card-type"] === blocks.coub.CardTypes.types.page.name){out+=' <div class="description__audio-copyright-claim"> <strong class="box--vertical">&#x0021;</strong> <span calss="box-vertical">'+( I18n.t("coub.copyright_claim.audio", {holder: it.audio_copyright_claim}) )+'</span> </div>';}return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/parts/download_video_button"] = function anonymous(it) {
  var out=''; var downloadLink = it.coub.file_versions && it.coub.file_versions.share && it.coub.file_versions.share.default, permalink = it.coub.permalink, isPlayer = it.isPlayer, classes = it.classes || ""; if (isPlayer) classes += " -player"; if (downloadLink) downloadLink += "?dl=1";out+='<a class="'+(classes)+'" href="'+(downloadLink || "#download")+'" download data-permalink='+(permalink)+' ';if(!downloadLink){out+='widget-download-coub-video auto-init';}out+='> ';if(isPlayer){out+=' <i>'+(JST['app/site/templates/svg/icons/html5_player_specific/share_download']())+'</i> <span>'+(I18n.embed.sharing.download)+'</span> ';}else{out+=' <i>'+(JST['app/site/templates/svg/icons/24/download']())+'</i> <span>'+(I18n.t('coub.buttons.download'))+'</span> ';}out+='</a>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/parts/more_from_channel_block"] = function anonymous(it) {
  var out=''; var style, type, path, last, permalink, len = it.coubs.length;out+='<div class="channel-coubs -clear"> <p class="hbold -truncate-text">More from '+(it.channelData.channelTitle)+'</p> ';var arr1=it.coubs;if(arr1){var coub,index=-1,l1=arr1.length-1;while(index<l1){coub=arr1[index+=1];out+=' '; style = "background-image: url(" + coub.image_versions.template.replace('%{version}', 'tiny') + ")"; type = coub.type === 'Coub::Simple' ? 'simple' : 'recoub'; last = index + 1 === len; permalink = coub.recoub_to && coub.recoub_to.permalink || coub.permalink; out+=' ';if(last && it.showMore){out+=' <a href="'+(Routes.channel_path(coub.channel.permalink))+'" class="channel-coubs__item channel-coubs__item--last box--inline -ribbon -centered-text" style="'+(style)+'"></a> ';}else{out+=' <a href="'+(Routes.view_coub_by_permalink_path(permalink))+'" data-permalink="'+(permalink)+'" type="coubSuggest" class="channel-coubs__item channel-coubs__item--'+(type)+' box--inline -ribbon" style="'+(style)+'"></a> ';}out+=' ';} } out+='</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/parts/sharing"] = function anonymous(it) {
  var out=''; var isSharingActive = helpers.Coub.isSharingButtonsActive(it), originalCoub = helpers.Coub.getOriginalCoub(it), checkTwitter, checkFacebook; if (GlobalState.COUNTRY.isExUssr()) { checkTwitter = false; checkFacebook = true; } else { checkTwitter = true; checkFacebook = true; } var btnOrder = helpers.Coub.getBigSocialButtonsOrder();out+='<div class="coub__sharing"> <div class="coub__sharing__list box--inline"> ';var arr1=btnOrder.visible;if(arr1){var value,index=-1,l1=arr1.length-1;while(index<l1){value=arr1[index+=1];out+=' ';if(value == "twitter" || value == "vkontakte"){out+=' '; var classes = "sb -sq -ribbon share-coub-video__button"; if (!isSharingActive) classes += " disabled"; out+=' '+( JST["app/site/templates/coub_block/social_action_buttons/share_video_button"]({ coub: originalCoub, provider: value, classes: classes }) )+' ';}else{out+=' '+(JST["app/site/templates/coub_block/social_action_buttons/custom_sharing_button"]( { provider: value, coub: it, active: isSharingActive, showTooltip: false, checkFacebook: checkFacebook, hideText: ((value == 'twitter' && !checkTwitter) || value == 'watsapp' || value == 'reddit' || value == 'odnoklassniki') ? true : false }) )+' ';}out+=' ';} } out+=' '+( JST['app/site/templates/coub_block/parts/download_video_button']({ coub: originalCoub, classes: "sb -st -rn coub__download" + (isSharingActive ? "" : " disabled") }) )+' </div> '+(JST["app/site/templates/widgets/dropdown_with_handler/dropdown_with_handler"]({ dClass: "coub__sharing__dropdown", hClass: "", attrs: "", handler: "<button class='sb -st -rn'><i>" + JST['app/site/templates/svg/icons/24/more']() + "</i></button>", content: JST["app/site/templates/coub_block/social_action_buttons/hidden_social_providers"]({coub: it, active: isSharingActive}) }) )+' ';if(false){out+=' '+(JST["app/site/templates/coub_block/parts/controls"](it))+' ';}out+=' ';if(originalCoub.promoted_id){out+=' <a class="sb -st coub__promote -details" type="promoteCoub" data-promoted-id="'+(originalCoub.promoted_id)+'"> '+(JST['app/site/templates/svg/icons/24/promote']())+' '+(I18n.t('promoted_coubs.info'))+' </a> ';}else if(helpers.PromotedCoubsHelper.coubCanToBePromoted(originalCoub) || !GlobalState.USER.isLogedIn()){out+=' '; var addClass = "", addAttrs = ""; if (!GlobalState.USER.isLogedIn()) { addClass += ' toggle-registration'; addAttrs += 'data-action="sign_up"'; } out+=' <a class="sb -blue coub__promote '+(addClass)+'" '+(addAttrs)+' type="promoteCoub" data-coub-permalink="'+(originalCoub.permalink)+'"> '+(JST['app/site/templates/svg/icons/24/promote']())+' '+(I18n.t('promoted_coubs.buttons.promote'))+' </a> ';}out+='</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/parts/tags_block"] = function anonymous(it) {
  var out=''; var withCropper = !it.render["tags-open"], isPromoted = it.render["promoted"];out+='<div class="coub__tags '+( withCropper ? "-with-cropper" : "" )+'"> <div class="tags-wrap"> ';if(isPromoted){out+=' '+(helpers.Coub.getPromotedStamp())+' ';}else{out+=' '+(helpers.Coub.getCotdStamp(it, 24, "coub__tags-tag tags-cotd-featured"))+' '+(helpers.Coub.getFeaturedStamp(it, 24, "coub__tags-tag tags-cotd-featured"))+' '+(helpers.Coub.getCommunityStamp(it, "coub__tags-tag tags-community hbold"))+' ';}out+=' ';var arr1=it.tags;if(arr1){var tag,index=-1,l1=arr1.length-1;while(index<l1){tag=arr1[index+=1];out+=' <a href="'+(Routes.tag_path({id: tag.value}))+'" class="coub__tags-tag -truncate-text">'+(tag.title)+'</a> ';} } out+=' </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/popups/share_coub_popup"] = function anonymous(it) {
  var out=''; var dims = it.dimensions.med, original = it.dimensions.big, sizes = [0.5, 0.75, 1], sizeClasses = '';out+='<div class="share-popup__content" data-coub-url="'+(Routes.embed_coub_url(it.permalink))+'"> <div class="grid-container gutter-beta"> <div class="grid-col -col-two-thirds"> <div class="share-popup__preview" style="padding-top:'+(helpers.Coub.aspectRatio(it.site_w_h[0], it.site_w_h[1]).percent)+'"> </div> </div> <div class="grid-col -col-one-third neq share-popup__options"> <div class="share-popup__option"> <label class="hbold">'+(I18n.t('coub.embed_dropdown.get_coub_link'))+'</label> <input class="input-field -sq url" value="'+(Routes.view_coub_by_permalink_url(it.permalink))+'"> </div> <div class="share-popup__option"> <label class="hbold">'+(I18n.t('coub.embed_dropdown.get_embed_code'))+'</label> <textarea class="input-field -sq iframeCode" rows=\'3\'></textarea> </div> <div class="share-popup__option -clear"> <label class="hbold">'+(I18n.t('coub.embed_dropdown.size.header'))+'</label> ';var arr1=sizes;if(arr1){var value,index=-1,l1=arr1.length-1;while(index<l1){value=arr1[index+=1];out+=' '; if (value == 1) sizeClasses += "active"; out+=' <div class="option__size"> <div class="frame '+(sizeClasses)+'" data-width="'+(dims[0]*value)+'" data-height="'+(dims[1]*value)+'"> <span class="-centered-box">'+(dims[0]*value + "px")+'</span> </div> </div> ';} } out+=' ';if(!(original[0] == dims[0]) && !(original[1] == dims[1])){out+=' <div class="option__size "> <div class="frame original" data-width="'+(original[0]*value)+'" data-height="'+(original[1]*value)+'"> <span class="-centered-box"> '+(I18n.t('coub.embed_dropdown.size.given_size.original_size') + original[0] + 'x' + original[1] + 'px')+' </span> </div> </div> ';}out+=' </div> <div class="share-popup__option -clear"> <label class="hbold">'+(I18n.t('coub.embed_dropdown.size.custom_size.header'))+'</label> <div class="option__custom-size -centered-text"> <input class="input-field -sq width" type="text" value="'+(dims[0])+'"> <p>'+(I18n.t('coub.embed_dropdown.size.custom_size.width'))+'</p> </div> <div class="cross -centered-text">x</div> <div class="option__custom-size -centered-text"> <input class="input-field -sq height" type="text" value="'+(dims[1])+'"> <p>'+(I18n.t('coub.embed_dropdown.size.custom_size.height'))+'</p> </div> </div> <div class="share-popup__option share-popup__checks -clear"> <div class="share-popup__checks-container -clear"> <label class="checkbox-field box--inline box--inline" for="autostart"> <input id="autostart" name="autostart" type="checkbox" value="true" data-option="autostart"> <div class="checkbox"></div> '+(I18n.t('coub.embed_dropdown.autostart.header'))+' </label> ';if(it.has_sound || it.audio_file_url){out+=' <label class="checkbox-field box--inline box--inline" for="mute" style="display:none"> <input id="mute" name="mute" type="checkbox" value="true" data-option="muted"> <div class="checkbox"></div> '+(I18n.t('coub.embed_dropdown.mute.header'))+' </label> ';}out+=' <label class="checkbox-field box--inline box--inline" for="startwithhd"> <input id="startwithhd" name="startwithhd" type="checkbox" value="true" data-option="startWithHD"> <div class="checkbox"></div> '+(I18n.t('coub.embed_dropdown.startwithhd.header'))+' </label> <label class="checkbox-field box--inline box--inline originalSize" for="startwithhd" style="visibility:hidden"> <input id="startwithhd" name="startwithhd" type="checkbox" value="true" data-option="startWithHD"> <div class="checkbox"></div> '+(I18n.t('coub.embed_dropdown.startwithhd.header'))+' </label> </div> </div> </div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/resources"] = function anonymous(it) {
  var out=''; var asJson = {}; out+='<resources> '; asJson.cardTypes = {}; for(var type in blocks.coub.CardTypes.types){ var ct = blocks.coub.CardTypes.types[type]; var sizes = it[ct.sizeProp] || [640, 360]; asJson.cardTypes[type] = ct; asJson.cardTypes[type].sizes = {width: sizes[0], height: sizes[1]}; } out+=' <json value=\''+(JSON.stringify(asJson))+'\'></json></resources>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/social_action_buttons/custom_sharing_button"] = function anonymous(it) {
  var out='';  var classes = it.provider; if (!it.active) {     classes += " disabled";   } if (it.classes) { classes += " " + it.classes; } var attrs = CustomSharingButton.getAttributesForCoub(it.provider, it.coub); var socialName = I18n.t("social_names."+it.provider); var providerText; var checkFacebook = it.checkFacebook; if(it.provider == "vkontakte") { providerText = I18n.t("sharing.share_vk_short"); } else if(it.provider == "facebook" && checkFacebook == false) { providerText = I18n.sharing.share + " " + socialName; } else if (it.provider == "facebook" && checkFacebook == true) { providerText = I18n.t("sharing.share_fb_short"); } else if (it.provider == "twitter") { providerText = I18n.sharing.share_tweeter_short; } var prompt = it.active && it.showTooltip ? "data-prompt="+socialName : "";out+='<button data-prompt-left="" data-prompt-top="+3" class="sb -sq  '+(classes)+' social box--inline -ribbon '+(it.hideText ? '-hide-text' : '')+'" '+(prompt)+' '+(attrs)+'> ';if(!it.hideText){out+=' '+(providerText)+' ';}out+='</button>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/social_action_buttons/dislike_button"] = function anonymous(it) {
  var out=''; var promptStr = it.dislike ? I18n.t('tooltips.dislike_button.undislike') : I18n.t('tooltips.dislike_button.dislike'), prompt = "data-prompt='" + promptStr + "' data-prompt-top='2'" + " data-prompt-left='-2'", originalCoub = helpers.Coub.getOriginalCoub(it), icon = JST["app/site/templates/svg/icons/24/dislike"]();if(!Params.get("is_logged_in")){out+=' <div widget-dislike-button auto-init="true" class="coub__dislike-button lock toggle-registration" data-action="sign_up"> <i handler '+(prompt)+'>'+(icon)+'</i>  '+( JST["app/site/templates/widgets/like_recoub_counter/like_recoub_counter"]( { type: "Dislike", id: it.type === "Coub::Recoub" ? it.recoub_to.id : it.id, cardType: it.render["card-type"], attrs: "", value: it.dislikes_count } ) )+' </div>';}else{out+=' '; var isOn = it.dislike ? "-on" : "", buttonState = helpers.Coub.isCoubCanPlaying(it) && !helpers.Coub.disabledSocialAction(it, 'like') ? '' : 'disabled'; out+=' <div widget-dislike-button widget-listener-dislike data-listener-id="'+(originalCoub.id)+'" data-listener-type="coubs" auto-init="true" class="coub__dislike-button '+(isOn)+'"   ';if(it.type === "Coub::Recoub"){out+=' data-coub-id="'+(it.id)+'" data-recoub-to-id="'+(it.recoub_to.id)+'" ';}else{out+=' data-coub-id="'+(it.id)+'" ';}out+='> <i class="'+(buttonState)+'" handler '+(prompt)+'>'+(icon)+'</i>  '+( JST["app/site/templates/widgets/like_recoub_counter/like_recoub_counter"]( { type: "Dislike", id: it.type === "Coub::Recoub" ? it.recoub_to.id : it.id, cardType: it.render["card-type"], attrs: "", value: it.dislikes_count } ) )+' </div>';}return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/social_action_buttons/favourites_button"] = function anonymous(it) {
  var out='';  var tooltipVars = 'data-prompt-top="-3" data-prompt-left="-1" data-fs-prompt-top="-27" direction="left" data-prompt=', tooltipAdd = tooltipVars + I18n.embed.tooltips.favourites_add, tooltipRemove = tooltipVars + I18n.embed.tooltips.favourites_remove;if(GlobalState.PAGE.isEmbed()){out+=' <div class="viewer__favourites -hidden" '+(tooltipAdd)+'> <i>'+(JST["app/site/templates/svg/icons/24/favs_add"]())+'</i> <i class="-hidden">'+(JST["app/site/templates/svg/icons/24/favs_remove"]())+'</i></div>';}else if(GlobalState.USER.isLogedIn()){out+=' '; var isInFavourites = it.favourite, tooltip = isInFavourites ? tooltipRemove : tooltipAdd; out+=' <div class="viewer__favourites -hidden '+(isInFavourites ? '-added' : '')+'" data-coub-id='+(it.id)+' '+(tooltip)+'> <i>'+(JST["app/site/templates/svg/icons/24/favs_add"]())+'</i> <i class="-hidden">'+(JST["app/site/templates/svg/icons/24/favs_remove"]())+'</i></div>';}else{out+=' '; var unlogged = {selector: ".viewer__favourites[data-coub-id="+it.id+"]", action: "favourites"}, unloggedAction = 'data-unloged-action-selector='+(unlogged.selector)+' data-unloged-action='+(unlogged.action); out+=' <div class="viewer__favourites -hidden toggle-registration" data-action="sign_in" '+(unloggedAction)+' '+(tooltipAdd)+'> <i>'+(JST["app/site/templates/svg/icons/24/favs_add"]())+'</i> <i class="-hidden">'+(JST["app/site/templates/svg/icons/24/favs_remove"]())+'</i></div>';}return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/social_action_buttons/hidden_social_providers"] = function anonymous(it) {
  var out=''; var originalCoub = helpers.Coub.getOriginalCoub(it.coub), classNames = it.active ? "" : " disabled ", mailtoAttrs = "mailto:?subject=" + I18n.t('sharing.share_subject') + "&body=" + it.coub.title + " " + Routes.view_coub_by_permalink_url(it.coub.permalink), canEdit = helpers.Channel.hasId(it.coub.channel_id), originalId = originalCoub.channel_id, flagHighlight = it.coub.flag ? '-highlight' : '';out+='<ul class="list list--selectable"> ';var arr1=helpers.Coub.getBigSocialButtonsOrder().hidden;if(arr1){var value,index=-1,l1=arr1.length-1;while(index<l1){value=arr1[index+=1];out+=' <li class="list__item '+(classNames)+'"> ';if(value == "twitter"){out+=' '; var classes = "sharing__dropdown__item social "; out+=' '+( JST["app/site/templates/coub_block/social_action_buttons/share_video_button"]({ coub: originalCoub, provider: value, classes: classes }) )+' ';}else{out+=' <div class="sharing__dropdown__item social '+(value)+'" '+(CustomSharingButton.getAttributesForCoub(value, it.coub))+'> <i>'+(JST["app/site/templates/svg/icons/24/" + value]())+'</i> <span>'+(I18n.t("social_names."+value))+'</span> </div> ';}out+=' </li> ';} } out+=' <li class="list__item sharing__dropdown__item -sharing-mail social mail '+(classNames)+'"> <a href="'+(utils.encodeQuotes(mailtoAttrs))+'" class="-fill"></a> <i>'+(JST["app/site/templates/svg/icons/24/mail"]())+'</i> <span>'+(I18n.t("social_names.mail"))+'</span> </li> <li class="list__item sharing__dropdown__item embed '+(classNames)+'" data-coub-id="'+(it.coub.permalink)+'" coub-embed-popup> <i>'+(JST["app/site/templates/svg/icons/24/embed"]())+'</i> <span>'+(I18n.t('coub.buttons.embed'))+'</span> </li> <li class="list__item sharing__dropdown__item social link" auto-init widget-copy-link data-clipboard-text="'+(Routes.view_coub_by_permalink_url(helpers.Coub.getOriginalCoub(it.coub).permalink))+'"> <i>'+(JST["app/site/templates/svg/icons/24/copy_link"]())+'</i> <span>'+(I18n.t('coub.buttons.edit.copy_link'))+'</span> </li> ';if(((!canEdit && originalId != Params.get('current_channel_id')) && Params.get('is_logged_in')) && it.coub.type != "Coub::Recoub"){out+=' <li class="list__item sharing__dropdown__item social flag '+(flagHighlight)+'" flag-coub-handle> <i>'+(JST["app/site/templates/svg/icons/24/flag"]())+'</i> <span>'+(I18n.t("coub.abuse.title"))+'</span> <div class="-hidden" flag-coub-content> '+(JST["app/site/templates/coub_block/static_buttons/flag_button"](it.coub))+' </div> </li> ';}out+='</ul>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/social_action_buttons/like_button"] = function anonymous(it) {
  var out='';  var promptStr = it.like ? I18n.t('tooltips.like_button.unlike') : I18n.t('tooltips.like_button.like'), prompt = "data-prompt=" + promptStr + " data-prompt-top='2'" + " data-prompt-left='-2'", originalCoub = helpers.Coub.getOriginalCoub(it), isClassicButton = document.cookie.indexOf("classic_like") !== -1, icon = JST[isClassicButton ? "app/site/templates/svg/classic_like" : "app/site/templates/svg/icons/24/like"]();if(!Params.get("is_logged_in")){out+=' '; var unlogged = {selector: ".coub__like-button[data-coub-id="+it.id+"]", action: "like"}, unloggedAction = 'data-unloged-action-selector='+(unlogged.selector)+' data-unloged-action='+(unlogged.action); out+=' <div widget-like-button auto-init="true" class="coub__like-button '+(isClassicButton ? "coub__like-button--rock" : "")+' lock toggle-registration" data-action="sign_up" '+(unloggedAction)+'> <i handler '+(prompt)+'>'+(icon)+'</i>  '+( JST["app/site/templates/widgets/like_recoub_counter/like_recoub_counter"]( { type: "Like", id: it.type === "Coub::Recoub" ? it.recoub_to.id : it.id, cardType: it.render["card-type"], attrs: it.likes_count >= 1000 ?  "title="+it.likes_count : "", value: it.likes_count } ) )+' </div>';}else{out+=' '; var isOn = it.like ? "-on" : "", buttonState = helpers.Coub.isCoubCanPlaying(it) && !helpers.Coub.disabledSocialAction(it, 'like') ? '' : 'disabled'; out+=' <div widget-like-button widget-listener-like data-listener-id="'+(originalCoub.id)+'" data-listener-type="coubs" auto-init="true" class="coub__like-button '+(isClassicButton ? "coub__like-button--rock" : "")+' '+(isOn)+'"   ';if(it.type === "Coub::Recoub"){out+=' data-coub-id="'+(it.id)+'" data-recoub-to-id="'+(it.recoub_to.id)+'" ';}else{out+=' data-coub-id="'+(it.id)+'" ';}out+='> <i class="'+(buttonState)+'" handler '+(prompt)+'>'+(icon)+'</i>  '+( JST["app/site/templates/widgets/like_recoub_counter/like_recoub_counter"]( { type: "Like", id: it.type === "Coub::Recoub" ? it.recoub_to.id : it.id, cardType: it.render["card-type"], attrs: it.likes_count >= 1000 ?  "title="+it.likes_count : "", value: it.likes_count } ) )+' </div>';}return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/social_action_buttons/recoub_button"] = function anonymous(it) {
  var out='';  var prompt = "data-prompt=" + I18n.t('tooltips.recoub_button.recoub') + " data-prompt-left=-2" + " hideable-prompt", recoubsCount = it.type === "Coub::Recoub" ? it.recoub_to.recoubs_count : it.recoubs_count, icon = JST["app/site/templates/svg/icons/24/repost"]();if(Params.get("is_logged_in")){out+=' '; var originalCoub = helpers.Coub.getOriginalCoub(it), currentChannelCoub = originalCoub.channel_id == Params.get("current_channel_id"), userChannels = helpers.Channel.presentChannels(), buttonState = it.recoub ? "-on" : "", buttonData =  "data-coub-id=" + (it.type === "Coub::Recoub" ? it.recoub_to.id : it.id), disabledAction = !helpers.Coub.isCoubCanPlaying(it) || helpers.Coub.disabledSocialAction(originalCoub, 'repost'), handlerClass = disabledAction || (userChannels.length === 1 && currentChannelCoub) ? 'disabled' : '', button = '<i handler class="'+(handlerClass)+'" '+(prompt)+'>'+(icon)+'</i>'; out+=' ';if(userChannels.length === 1 || disabledAction){out+=' <div widget-recoub-button auto-init="true" data-coub-id="'+(originalCoub.id)+'" class="coub__recoub-button '+(buttonState)+'" '+(buttonData)+'> '+(button)+'  '+( JST["app/site/templates/widgets/like_recoub_counter/like_recoub_counter"]( { type: "Recoub", id: it.type === 'Coub::Recoub'? it.recoub_to.id : it.id, cardType: it.render["card-type"], attrs: recoubsCount >= 1000 ? ("title=" + recoubsCount) : "", value: recoubsCount } ) )+' </div> ';}else{out+=' <div data-coub-id="'+(originalCoub.id)+'" class="coub__recoub-button '+(buttonState)+'" '+(buttonData)+' '+(handlerClass)+' widget-listener-recoub data-listener-id="'+(originalCoub.id)+'" data-listener-type="coubs" auto-init="true"> '+( JST["app/site/templates/widgets/dropdown_with_handler/dropdown_with_handler"]({ dClass: "dropdown--to-modal coub__repost-dropdown", handler: button, content: JST["app/site/templates/coub_block/social_action_buttons/social_action_dropdown"]({ toAction: false, attrs: "data-coub-id='" + originalCoub.id + "' widget-recoub-button auto-init='true' container-selector='.coub__recoub-button'", channels: userChannels, coub: it }), attrs: 'data-timeout-hide' }) )+'  '+( JST["app/site/templates/widgets/like_recoub_counter/like_recoub_counter"]( { type: "Recoub", id: it.type === 'Coub::Recoub'? it.recoub_to.id : it.id, cardType: it.render["card-type"], attrs: recoubsCount >= 1000 ? ("title=" + recoubsCount) : "", value: recoubsCount } ) )+' </div> ';}}else{out+=' '; var unlogged = {selector: ".coub__recoub-button[data-coub-id="+it.id+"]", action: "recoub"}, unloggedAction = 'data-unloged-action-selector='+(unlogged.selector)+' data-unloged-action='+(unlogged.action); out+=' <div widget-recoub-button auto-init="true" class="coub__recoub-button lock toggle-registration" data-action="sign_up" data-coub-id="'+(it.id)+'" '+(unloggedAction)+'> <i handler '+(prompt)+'>'+(icon)+'</i>  '+( JST["app/site/templates/widgets/like_recoub_counter/like_recoub_counter"]( { type: "Recoub", id: it.type === 'Coub::Recoub'? it.recoub_to.id : it.id, cardType: it.render["card-type"], attrs: recoubsCount >= 1000 ? ("title=" + recoubsCount) : "", value: recoubsCount } ) )+' </div>';}return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/social_action_buttons/remix_button"] = function anonymous(it) {
  var out='';  var buttonDisabled = !helpers.Coub.isCoubCanPlaying(it), buttonState = buttonDisabled ? 'disabled' : '', originalCoub = helpers.Coub.getOriginalCoub(it), linkAttrs = '', icon = JST["app/site/templates/svg/icons/24/recoub"](); if (!Params.get("is_logged_in")) { linkAttrs = 'class="toggle-registration" data-action="sign_up"'; } else if (!buttonDisabled) { linkAttrs = 'href=' + Routes.remix_coub_path(originalCoub.permalink); }out+='<div class="coub__remix-button"> <a '+(linkAttrs)+' target="_blank"> <i handler data-prompt='+(I18n.t('tooltips.remix_button.remix'))+' data-prompt-left="-1" class='+(buttonState)+'>'+(icon)+'</i> </a>  '+( JST["app/site/templates/widgets/like_recoub_counter/like_recoub_counter"]( { type: "Remix", id: originalCoub.id, cardType: it.render["card-type"], attrs: "", value: it.remixes_count } ) )+'</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/social_action_buttons/share_video_button"] = function anonymous(it) {
  var out='';  var attrs = widgets.ShareCoubVideoButton.getAttrs(it.provider, it.coub), text = helpers.Application.capitalize(it.provider), iconKey = "app/site/templates/svg/icons/24/" + it.provider, icon = ""; if (JST[iconKey]) { icon = JST[iconKey](); } switch (it.provider) { case "twitter": text = I18n.t("sharing.share_tweeter_short"); break; case "vkontakte": text = I18n.t("sharing.share_vk_short"); break; }out+='<div class="-'+(it.provider)+' '+(it.classes)+'" '+(attrs)+'> <i>'+(icon)+'</i> '+(text)+'</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/social_action_buttons/share_video_popup"] = function anonymous(it) {
  var out=''; out+='<div> <div class="share-coub-video__popup__body"> <textarea class="input-field -sq share-coub-video__popup__textarea">'+(it.defaultText)+'</textarea> <div class="share-coub-video__popup__image-container"> <img src="'+(it.image)+'"> '+(JST["app/site/templates/svg/icons/32/play"]())+' </div> </div> <div class="share-coub-video__popup__error-msg -error-text -hidden">'+(I18n.t("sharing.text_too_long_error"))+'</div> <button class="sb -st -rn -blue share-coub-video__popup__submit">'+(I18n.t("sharing.post_to_" + it.provider))+'</button></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/social_action_buttons/social_action_dropdown"] = function anonymous(it) {
  var out=''; out+='<div class="list-wrap niceScroller" data-scroll-type="vertical"> <ul class="list list--selectable js-touch-enabled" widgets-list-key-navigation="true" auto-init="true"> ';var arr1=it.channels;if(arr1){var channel,index=-1,l1=arr1.length-1;while(index<l1){channel=arr1[index+=1];out+=' '; var isOn = it.coub.recoubs_by_users_channels != null && it.coub.recoubs_by_users_channels.indexOf(channel.id) != -1 ? "-on" : "", disabled = helpers.Coub.getOriginalCoub(it.coub).channel_id == channel.id ? 'disabled' : '', classes = []; classes.push(disabled, isOn); out+=' <li data-channel-id=\''+(channel.id)+'\' '+(it.attrs)+' '+(disabled)+' class="list__item list__item-alpha '+(classes.join(' '))+'" title="'+(channel.title)+'"> <img '+(helpers.Application.specificImgVersion(channel, 'avatar_versions', 'small'))+' width="40" height="40" class="image -rounded"> ';if(it.toAction){out+=' <span>to</span> ';}out+=' <div>'+(channel.title)+'</div> </li> ';} } out+=' </ul></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/static_buttons/coub_info_button_handler"] = function anonymous(it) {
  var out=''; var classNames = it.coub.is_done ? "" : "disabled"; out+=''+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: "-st -sq info box--inline " + classNames, attrs: "", value: "" }));return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/static_buttons/edit_button"] = function anonymous(it) {
  var out=''; var classNames = it.coub.is_done ? "" : "disabled", attrs = "data-prompt=" + I18n.t("coub.buttons.edit.heading") + " data-prompt-top='-3' hideable-prompt";out+=''+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: "-st -sq " + classNames, attrs: attrs, value: '' }));return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/static_buttons/edit_button_contents"] = function anonymous(it) {
  var out=''; var videoUrl = it.coub.file_versions.web ? it.coub.file_versions.web.template.replace(/%{type}/g, 'mp4').replace(/%{version}/g, 'big') : null, audioUrl = it.coub.audio_versions.template ? it.coub.audio_versions.template.replace(/%{version}/g, 'high') : null, canEdit = helpers.Channel.hasId(it.coub.channel_id), originalId = it.coub.type == "Coub::Recoub" ? it.coub.recoub_to.channel_id : it.coub.channel_id, originalCoubId = it.coub.type == "Coub::Recoub" ? it.coub.recoub_to.id : it.coub.id;out+='<div class="list-wrap niceScroller" data-scroll-type="vertical"> <ul class="list list--selectable"> ';if(!canEdit && !Params.getBranchValue("current_user.is_admin") && it.coub.type == "Coub::Simple" && it.coub.from_web_editor){out+=' <li class="list__item list__item-beta editor"> <a href="'+(Routes.remix_coub_path(it.coub.permalink))+'"> '+( I18n.t('coub.buttons.edit.open_in_editor'))+' </a> </li> ';}out+=' ';if((canEdit || Params.getBranchValue("current_user.is_admin")) && it.coub.type == "Coub::Simple"){out+=' ';if(it.coub.from_web_editor){out+=' <li class="list__item list__item-beta editor"> <a href="'+(Routes.edit_coub_path(it.coub.permalink))+'"> '+( I18n.t('coub.buttons.edit.heading'))+' </a> </li> ';}out+=' ';if((canEdit || Params.getBranchValue("current_user.is_admin")) && it.coub.type == "Coub::Simple"){out+=' <li class="list__item list__item-beta info" open-edit-popup> '+( I18n.t('coub.buttons.edit.info'))+' </li> ';if(!it.coub.categories.length || it.coub.allow_category_change){out+=' <li class="list__item list__item-beta categories" open-categories-popup> '+( I18n.t(!it.coub.categories.length ? 'coub.buttons.edit.add_category' : 'coub.buttons.edit.change_category') )+' </li> ';}out+=' ';}out+=' <li class="list__item list__item-beta delete" data-permalink='+(it.coub.permalink)+' widget-delete-coub-button auto-init> '+( I18n.t('coub.buttons.edit.delete'))+' </li> ';if(Params.getBranchValue("current_user.is_admin")){out+=' <li class="list__item list__item-beta sharing-picture -no-icon" data-status="'+(it.coub.sharing_picture ? 'del' : 'add')+'"> <form action="'+(Routes.og_image_api_v2_coub_path(it.coub.permalink))+'" class="-hidden" method="POST"> <input type="file" /> </form> <span class="sharing-picture__status"> ';if(!it.coub.sharing_picture){out+=' '+( I18n.t('coub.buttons.edit.add_sharing_picture') )+' ';}else{out+=' '+( I18n.t('coub.buttons.edit.remove_sharing_picture') )+' ';}out+=' </span> </li> <li class="list__item list__item-beta copyCoub -no-icon"> '+( I18n.t('coub.buttons.edit.copy') )+' </li> ';}out+=' ';}out+=' ';if(Params.getBranchValue("current_user.is_editor")){out+=' <li class="list__item list__item-beta download -no-icon" video auto-init widget-download-file url="'+(videoUrl)+'"> '+( I18n.t('coub.buttons.edit.download_video'))+' </li> ';if(audioUrl){out+=' <li class="list__item list__item-beta download -no-icon" audio auto-init widget-download-file url="'+(audioUrl)+'"> '+( I18n.t('coub.buttons.edit.download_audio'))+' </li> ';}out+=' ';}out+=' ';if(Params.getBranchValue("current_user.is_admin")){out+=' '; var mediaBlockChanged = (it.coub.media_blocks && it.coub.media_blocks.external_video_manual) ? true : false; var externalMediaBlockId = mediaBlockChanged ? it.coub.media_blocks.external_video_manual.id : ""; var externalMediaBlockUrl = mediaBlockChanged ? it.coub.media_blocks.external_video_manual.url : ""; out+=' <li class="list__item list__item-beta download -no-icon" widget-set-external-video-source-for-coub coub-id="'+(originalCoubId)+'" changed="'+(mediaBlockChanged)+'" media-block-id="'+(externalMediaBlockId)+'" media-block-url="'+(externalMediaBlockUrl)+'"> ';if(mediaBlockChanged){out+=' '+( I18n.t('admin.source') + externalMediaBlockUrl )+' ';}else{out+=' '+( I18n.t('admin.set_external_video_source') )+' ';}out+=' </li> ';}out+=' </ul></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/static_buttons/flag_button"] = function anonymous(it) {
  var out='<div coub-abuses data-for-coub-id="'+(it.id)+'" data-for-coub-type="'+(it.type)+'"> <div class="flag__header"> <p class="hbold">'+( I18n.t('coub.abuse.header') )+'</p> <p>'+( I18n.t('coub.abuse.sub') )+'</p> </div> <ul class="list list--selectable"> ';var arr1=Params.get('abuse_reasons');if(arr1){var value,index=-1,l1=arr1.length-1;while(index<l1){value=arr1[index+=1];out+=' '; var abuseId = helpers.Coub.getAbuseIdForReason(it, value), checkedClass = abuseId == '' ? "" : "-on";  if (value == "sex" || value == "spam") continue; checkedClass += value == 'other' ? ' other' : ''; out+=' <li class="list__item list__item-alpha '+( checkedClass )+'" data-reason="'+(value)+'" data-abuse-id="'+( abuseId )+'"> '+(helpers.Coub.capitalize(I18n.t('coub.abuse.reasons.' + value)))+' </li> ';} } out+=' </ul> <div class="flag__form sb-group sb-group--simple -fill" style="display:none;"> <p class="hbold">'+(I18n.t('coub.abuse.header'))+'</p> <textarea class="input-field -sq"></textarea> '+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: "-sb-beta -st -rn -grey close-other", attrs: "", value: I18n.t('coub.abuse.popup.close_popup') }) )+' '+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: "-sb-beta -push-shd -rn -blue send-claim", attrs: "", value: I18n.t('coub.abuse.popup.submit') }) )+' </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/stubs/age_restricted_card"] = function anonymous(it) {
  var out=''; it = helpers.Coub.calculatePropertiesForViewIfNotComputed(it); var img = it.image_versions.template.replace('%{version}', 'med'), aspectRatio = it.computed.aspectRatio, dims = it.computed.dims;out+='<div class="coub__stub age-restricted" style="width:'+(dims[0])+';height:'+(dims[1])+';"> <div style="padding-top:'+(aspectRatio.percent)+'"> <svg class="-fill"> <defs> <filter id="age-restricted-blur"> <feGaussianBlur stdDeviation="10" /> </filter> </defs> <image xlink:href="'+(img)+'" width="100%" height="100%" filter="url(#age-restricted-blur)"></image> </svg> <div class="stub__content -centered-box"> <i class="hbold">NSFW</i> <p>'+(I18n.t('coub.stubs.age_restricted.header'))+'</p> <button class="sb -push-shd -rn -blue" age-confirm-btn> '+(I18n.t('coub.stubs.age_restricted.button'))+' </button> </div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/stubs/in_process_card"] = function anonymous(it) {
  var out=''; it = helpers.Coub.calculatePropertiesForViewIfNotComputed(it); var aspectRatio = it.computed.aspectRatio, dims = it.computed.dims;out+='<div class="coub__stub processing" style="width:100%;height:'+(dims[1])+';"> <div style="padding-top:'+(aspectRatio.percent)+'"> <div class="stub__content -centered-box"> <i></i> <h2 class="hthin">'+(I18n.t('coub.stubs_new.processing.header'))+'</h2> <p>'+(I18n.t('coub.stubs_new.processing.sub'))+'</p> </div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/stubs/no_permission_card"] = function anonymous(it) {
  var out=''; it = helpers.Coub.calculatePropertiesForViewIfNotComputed(it); var aspectRatio = it.computed.aspectRatio, dims = it.computed.dims;out+='<div class="coub__stub permission" style="width:100%;height:'+(dims[1])+';"> <div style="padding-top:'+(aspectRatio.percent)+'"> <div class="stub__content -centered-box"> <i></i> <h2 class="hthin">'+(I18n.t('coub.stubs_new.no_permission.header'))+'</h2> <p>'+(I18n.t('coub.stubs_new.no_permission.sub'))+'</p> </div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/stubs/temp_coub_card"] = function anonymous(it) {
  var out=''; it = helpers.Coub.calculatePropertiesForViewIfNotComputed(it); var aspectRatio = it.computed.aspectRatio, dims = it.computed.dims;out+='<div class="coub__stub processing" style="width:100%;height:'+(dims[1])+';"> <div style="padding-top:'+(aspectRatio.percent)+'"> <div class="stub__content -centered-box"> <i></i> <h2 class="hthin">'+(I18n.t('coub.stubs_new.temp_coub.header'))+'</h2> <p>'+(I18n.t('coub.stubs_new.temp_coub.sub'))+'</p> </div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/coub_block/viewer_block"] = function anonymous(it) {
  var out='';  var isEmbed = GlobalState.PAGE.isEmbed(), isSharingActive = true; if (!isEmbed) { it = helpers.Coub.calculatePropertiesForViewIfNotComputed(it); isSharingActive = helpers.Coub.isSharingButtonsActive(it); } var originalCoub = helpers.Coub.getOriginalCoub(it), sharingProviders = ['facebook', 'twitter', 'vkontakte'], coubPath = '/view/' + originalCoub.permalink, coubUrl = 'https://coub.com' + coubPath, suggestsPath = '/api/v2/coubs/' + originalCoub.permalink + '/category_suggestions', viewsCount = it.views_count, createdBy = I18n.embed.by({link: "<a target='_blank' class='hbold' href='/" + originalCoub.channel.permalink + "'>" + originalCoub.channel.title + "</a>"}), aspectRatio = it.computed.aspectRatio, dims = it.computed.dims, promotedClickLink = it.render && it.render.promoted && it.render.promoted.click_link, promotedClickLinkText = it.render && it.render.promoted && it.render.promoted.click_link_text, canEdit = !isEmbed && !GlobalState.PAGE.isChatPage() && (helpers.Channel.hasId(it.channel_id) || GlobalState.USER.isAdmin()) && it.type == "Coub::Simple", isPromoteButtonShowed = !isEmbed && !GlobalState.PAGE.isChatPage() && !originalCoub.promoted_id && helpers.PromotedCoubsHelper.coubCanToBePromoted(originalCoub) && GlobalState.USER.isLogedIn(); if (GlobalState.PAGE.isChatPage() && it.render && it.render['max-height'] && it.render['max-width']) { var maxHeight = it.render['max-height']; var maxWidth = it.render['max-width']; var ratio = null; var dimsVal = dims.map(function(d) { return parseInt(d); }); if (dimsVal[1] > maxHeight) { ratio = maxHeight / dimsVal[1]; } else if (dimsVal[0] > maxWidth) { ratio = maxWidth / dimsVal[0]; } if (ratio) { dimsVal[0] *= ratio; dimsVal[1] *= ratio; dims = dimsVal.map(function(d) { return Math.ceil(d) + "px" }); } } var best2019LikeActionIndex = ["1qovxj", "24lt6f", "2386gf", "2333s6", "228xb7", "21s12z"].indexOf(originalCoub.permalink);out+='<div class="viewer '+(isEmbed ? '-embed' : '')+'" data-permalink="'+(it.permalink)+'" style="width:'+(dims[0])+';height:'+(dims[1])+';" tabindex="-1"> <div class="viewer__hand -hidden -fill"></div> <div class="contents"> <img src="'+(it.computed.firstFrameUrl)+'" class="viewer__img" /> <div class="data" style="display:none"> <script type="text/json"> '+( JSON.stringify(originalCoub) )+' </script> </div> <div class="viewer__player -no-select" style="padding-top:'+(aspectRatio.percent)+'" data-aspect-ratio="'+(aspectRatio.val)+'"> <div class="viewer__black-screen -fill -hidden"></div> <canvas class="viewer__screen -hidden"></canvas> </div> <div class="viewer__controls__container -no-select"> ';if(promotedClickLink){out+=' <a class="viewer__click viewer__promoted-link -fill" href="'+(promotedClickLink)+'" target="_blank" rel="noopener noreferrer"> '+(promotedClickLinkText)+' </a> ';}else{out+=' <div class="viewer__shadow viewer__click -fill"></div> ';}out+=' <div class="viewer__progress"> <div class="images -hidden"></div> </div> <div class="viewer__hand viewer__click -hand -fill -hidden"> <i>'+(JST["app/site/templates/svg/icons/html5_player_specific/hand"]())+'</i> </div> <!-- mobile --> ';if(isEmbed){out+=' <div class="viewer__share__mobile -hidden"></div> ';}out+=' <div class="viewer__pause -fill -hidden"> <div class="viewer__click -fill"></div> <div class="viewer__pause__content"> <div class="viewer__click -fill"></div> <div class="viewer__pause__share"> ';var arr1=['facebook', 'twitter', 'messenger', 'watsapp'];if(arr1){var value,index=-1,l1=arr1.length-1;while(index<l1){value=arr1[index+=1];out+=' <div '+(CustomSharingButton.getAttributesForCoub(value, it))+' class="viewer__share__social box--inline '+(value)+'"> <button class="-ribbon"></button> <span>'+(I18n.embed.social_names[value])+'</span> </div> ';} } out+=' <div class="viewer__share__social copy box--inline"> <button class="-ribbon"></button> <span>'+(I18n.embed.social_names.link)+'</span> </div> </div> ';if(helpers.Coub.showWIAButton()){out+=' <a target="_top" class="viewer__pause__open-in-app -ribbon" app-link data-coub-permalink="'+(originalCoub.permalink)+'">'+(helpers.Coub.getWIAText())+'</a> ';}out+=' </div> </div> <div class="viewer__copy -fill viewer__click -hidden"> <div class="viewer__copy__content"> <input class="viewer__copy__input" value="'+(coubUrl)+'" /> </div> </div> <div class="viewer__play__mobile viewer__click"></div> ';if(isEmbed){out+=' <div class="viewer__stamp -truncate-text -hidden"> ';if(viewsCount > 0){out+=' <span>'+(I18n.embed.views_count({count: viewsCount}))+'</span> &#183; '+(createdBy)+' ';}out+=' </div> <a class="viewer__get-app -hidden" app-link target="_blank">'+(I18n.embed.get_app)+'</a> <a class="viewer__open-in-app -hidden" app-link target="_blank" data-coub-permalink="'+(it.permalink)+'">'+(I18n.embed.open_in_app)+'</a> <a class="viewer__coub-link -hidden" app-link target="_blank" data-coub-permalink="'+(it.permalink)+'" href="'+(coubUrl)+'">'+(I18n.embed.site_name)+'</a> ';}out+=' <!-- //mobile --> <!-- html5 --> <div class="viewer__spinner -hidden"> <div class="viewer__spinner-container"> <div class="viewer__spinner-rotator"> <div class="viewer__spinner-left"> <div class="viewer__spinner-circle"></div> </div> <div class="viewer__spinner-right"> <div class="viewer__spinner-circle"></div> </div> </div> </div> </div> <div class="viewer__coubs-changer" data-channel='+(it.channel.permalink)+' data-coub-id='+(it.id)+'> ';var arr2=["-prev", "-next"];if(arr2){var value,i2=-1,l2=arr2.length-1;while(i2<l2){value=arr2[i2+=1];out+=' <div class="button-prev-next -disabled '+(value)+'"> <span> <i>'+(JST["app/site/templates/svg/icons/html5_player_specific/prev"]())+'</i> <i class="-hidden">'+(JST["app/site/templates/svg/icons/html5_player_specific/prev_hover"]())+'</i> </span> </div> ';} } out+=' </div> <div class="viewer__sharing -fill -hidden"> <div class="-fill viewer__click"></div> <input class="viewer__sharing__coub-url" readonly value="'+(coubUrl)+'"></input> <div class="viewer__sharing__items"> <div class="viewer__sharing__item"> <button class="-ribbon -hidden copy" type="button"> <i>'+(JST["app/site/templates/svg/icons/html5_player_specific/share_copy"]())+'</i> <i class="-hidden">'+(JST["app/site/templates/svg/icons/html5_player_specific/share_copy_done"]())+'</i> <span>'+(I18n.embed.copy_link.copy)+'</span> </button> </div> <div class="viewer__sharing__item"> '+( JST['app/site/templates/coub_block/parts/download_video_button']({ coub: originalCoub, classes: "-ribbon download", isPlayer: true }) )+' </div> ';var arr3=sharingProviders;if(arr3){var value,index=-1,l3=arr3.length-1;while(index<l3){value=arr3[index+=1];out+=' <div class="viewer__sharing__item"> ';if(!isEmbed && value == "twitter"){out+=' <button class="-ribbon -'+(value)+'" '+(widgets.ShareCoubVideoButton.getAttrs(value, originalCoub))+' type="button"> <i>'+(JST["app/site/templates/svg/icons/html5_player_specific/share_" + value]())+'</i> <span>'+(I18n.embed.sharing[value])+'</span> </button> ';}else{out+=' <button '+(CustomSharingButton.getAttributesForCoub(value, it))+' data-url='+(coubUrl)+' class="-ribbon '+(value)+'" type="button"> <i>'+(JST["app/site/templates/svg/icons/html5_player_specific/share_" + value]())+'</i> <span>'+(I18n.embed.sharing[value])+'</span> </button> ';}out+=' </div> ';} } out+=' <div class="viewer__sharing__item"> <a class="-ribbon other" href='+(coubPath + '#openSharingPopup')+' target="_blank"> <i>'+(JST["app/site/templates/svg/icons/html5_player_specific/share_other"]())+'</i> <span>'+(I18n.embed.sharing.more)+'</span> </a> </div> </div> </div> <div class="viewer__suggests -fill -hidden" data-suggests-path="'+(suggestsPath)+'"> <div class="-fill viewer__click"></div> <div class="viewer__suggests-stub"> <div class="-fill viewer__click"></div> </div> <div class="viewer__suggests-controls"> <div class="viewer__suggests-list-btn disabled -prev"> <i>'+(JST["app/site/templates/svg/icons/html5_player_specific/prev"]())+'</i> <i class="-hidden">'+(JST["app/site/templates/svg/icons/html5_player_specific/prev_hover"]())+'</i> </div> <div class="viewer__replay" data-prompt="'+(I18n.embed.restart)+'" direction="above" data-prompt-top="8" data-fs-prompt-top="-2"> <i>'+(JST["app/site/templates/svg/icons/html5_player_specific/replay"]())+'</i> <i class="-hidden">'+(JST["app/site/templates/svg/icons/html5_player_specific/replay_hover"]())+'</i> </div> <div class="viewer__suggests-list-btn disabled -next"> <i>'+(JST["app/site/templates/svg/icons/html5_player_specific/prev"]())+'</i> <i class="-hidden">'+(JST["app/site/templates/svg/icons/html5_player_specific/prev_hover"]())+'</i> </div> </div> </div> <div class="viewer__mute -fill -hidden"> <span> <i>'+(JST["app/site/templates/svg/icons/24/sound-off"]())+'</i> <p>'+(I18n.embed.unmute)+'</p> </span> </div> <div class="viewer__controls -hidden"> ';if(isEmbed){out+=' <div class="viewer__controls-top"> <a class="viewer__site-logo" target="_blank" data-prompt="'+(I18n.embed.tooltips.logo)+'" data-coub-permalink="'+(it.permalink)+'" data-prompt-top="-3" data-fs-prompt-top="-23" direction="below" constraint="left" href="'+(coubPath)+'" app-link> <i>'+(JST["app/site/templates/svg/icons/html5_player_specific/logo"]())+'</i> <i class="-hidden">'+(JST["app/site/templates/svg/icons/html5_player_specific/logo_hover"]())+'</i> </a> <div class="viewer__coub-info -hidden"> <div class="viewer__coub-info__body -allow-select"> <a class="viewer__coub-info__title -truncate-text" target="_blank" href="'+(coubPath)+'">'+(it.title)+'</a> </div> </div> </div> ';}out+=' ';if(best2019LikeActionIndex != -1 && !isEmbed && GlobalState.PAGE.isBestCoubs2019()){out+=' <div class="viewer__best2019__like-action -action'+(best2019LikeActionIndex)+'"></div> ';}out+=' <div class="viewer__controls__play -hidden"> <div class="viewer__sound__hover__area"> <div class="viewer__sound__bar"> <div class="sound-bar sound-bar-slider"></div> <div class="sound-bar sound-bar-bg"></div> </div> <div class="viewer__settings"> <div class="viewer__settings-handler" data-prompt="'+(I18n.embed.tooltips.settings)+'" direction="above" data-prompt-top="8" data-fs-prompt-top="-2"> <i>'+(JST["app/site/templates/svg/icons/24/settings-hd"]())+'</i> <i class="-hidden">'+(JST["app/site/templates/svg/icons/24/settings"]())+'</i> </div> <div class="viewer__settings-content -hidden" data-scroll-type="vertical"> <ul> <li class="viewer__settings-hd">'+(I18n.embed.hd)+'</li> <li class="viewer__settings-replay" dropdown-close> '+(I18n.embed.restart)+' <i>'+(JST["app/site/templates/svg/icons/24/replay"]())+'</i> </li> <li class="viewer__settings-copy"> <span>'+(I18n.embed.copy_link.copy)+'</span> <i>'+(JST["app/site/templates/svg/icons/24/copy_link"]())+'</i> <i class="-hidden">'+(JST["app/site/templates/svg/icons/24/copy_link_done"]())+'</i> </li> ';if(!GlobalState.PAGE.isCoubPage()){out+=' <li class="viewer__settings-open" dropdown-close> <a href="'+(coubPath)+'" target="_blank"> <div class="-fill"></div> </a> <i>'+(JST["app/site/templates/svg/icons/24/open-on-coub"]())+'</i> '+(I18n.embed.open_on_coub)+' </li> ';}out+=' ';if(isPromoteButtonShowed){out+=' <li class="viewer__settings-promote" dropdown-close> <a type="promoteCoub" data-coub-permalink="'+(originalCoub.permalink)+'"> <div class="-fill"></div> </a> <i>'+(JST["app/site/templates/svg/icons/24/promote"]())+'</i> '+(I18n.embed.promote_coub)+' </li> ';}out+=' ';if(canEdit){out+=' <li class="viewer__settings-edit" dropdown-close> <a href="'+(Routes.edit_coub_path(it.permalink))+'"> <div class="-fill"></div> </a> <i>'+(JST["app/site/templates/svg/icons/24/edit-coub"]())+'</i> '+(I18n.embed.edit_coub)+' </li> <li class="viewer__settings-info" open-edit-popup dropdown-close> '+(I18n.embed.edit_info)+' <i>'+(JST["app/site/templates/svg/icons/24/doc"]())+'</i> </li> ';if(!it.categories.length || it.allow_category_change){out+=' <li class="viewer__settings-communities" open-categories-popup dropdown-close> '+(I18n.embed[!it.categories.length ? 'add_community' : 'change_community'])+' <i>'+(JST["app/site/templates/svg/icons/24/add-category"]())+'</i> </li> ';}out+=' <li class="viewer__settings-delete" data-permalink='+(it.permalink)+' widget-delete-coub-button auto-init dropdown-close> '+(I18n.embed.delete_coub)+' <i>'+(JST["app/site/templates/svg/icons/24/delete"]())+'</i> </li> ';if(GlobalState.USER.isAdmin()){out+=' <li class="viewer__settings-download" data-permalink='+(it.permalink)+' widget-download-coub-loops auto-init> '+(I18n.embed.download_loops)+' </li> ';}out+=' ';}out+=' </ul> <div class="viewer__settings-footer"> ';if(viewsCount > 0){out+=' <div class="viewer__settings-views-count">'+(I18n.embed.views_count({count: viewsCount}))+'</div> ';}out+=' <div class="viewer__settings-author" dropdown-close>'+(createdBy)+'</div> </div> </div> </div> ';if(isSharingActive){out+=' <div class="viewer__share -hidden" data-prompt="'+(I18n.embed.tooltips.share)+'" direction="above" data-prompt-top="8" data-fs-prompt-top="-2"> <i>'+(JST["app/site/templates/svg/icons/24/share"]())+'</i> </div> ';}out+=' </div> </div> <div class="viewer__das -hidden"> <div class="viewer__das__banner"> <div class="viewer__das__close -hidden"> <div></div> </div> <div class="adman-ad-overlay"></div> <div class="custom-ad-overlay"></div> <div class="banner-fold close-small close-small--round -hidden"></div> </div> </div> <div class="viewer__controls__right-top"> <div class="viewer__fullscreen -hidden" data-prompt="'+(I18n.embed.tooltips.fullscreen_on)+'" data-prompt-top="-3" data-prompt-left="-5" data-fs-prompt-top="-27" direction="left"> <i>'+(JST["app/site/templates/svg/icons/24/fullscreen"]())+'</i> <i class="-hidden">'+(JST["app/site/templates/svg/icons/24/fullscreen-off"]())+'</i> </div> <div class="viewer__copylink -hidden" data-prompt="'+(I18n.embed.copy_link.copy)+'" data-text="'+(coubUrl)+'" data-prompt-top="-3" data-prompt-left="-1" data-fs-prompt-top="-27" direction="left"> <i>'+(JST["app/site/templates/svg/icons/24/copy_link"]())+'</i> <i class="-hidden">'+(JST["app/site/templates/svg/icons/24/copy_link_done"]())+'</i> </div> '+( JST["app/site/templates/coub_block/social_action_buttons/favourites_button"](originalCoub) )+' </div> </div> <div class="viewer__sound -hidden"> <i>'+(JST["app/site/templates/svg/icons/24/sound-off"]())+'</i> <i class="-hidden">'+(JST["app/site/templates/svg/icons/24/sound-on"]())+'</i> </div> <div class="viewer__fullscreen-logo -hidden"> <i>'+(JST["app/site/templates/svg/icons/html5_player_specific/logo"]())+'</i> </div> <div class="viewer__filter__hack viewer__click -hidden"></div> <!-- //html5 --> </div> ';if(isEmbed){out+=' <div class="viewer__das__preroll -fill -hidden"> <div class="adman-ad-preroll -hidden -fill"> <video></video> </div> <div class="vast-ad-preroll -hidden -fill"></div> <div class="preroll__controls"> <div class="preroll__controls--skip-button -disabled"></div> <div class="preroll__controls--timer"></div> <div class="preroll__controls--bar"></div> </div> </div> ';}out+=' ';if(GlobalState.PAGE.isOldSpicePromo2016()){out+=' ';if(GlobalState.USER.isLogedIn()){out+=' <div class=\'coub__oldspice-vote_btn tablet-mobile-hidden\' data-permalink='+(originalCoub.permalink)+'></div> ';}else{out+=' <div class=\'coub__oldspice-vote_btn toggle-registration tablet-mobile-hidden\' data-action=\'sign_up\'></div> ';}out+=' <div class="coub__oldspice-counter tablet-mobile-hidden"></div> ';}out+=' </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/edit_coub_popup/categories_popup"] = function anonymous(it) {
  var out=''; var visibleCategories = _.filter(it.all, function(category) { return category.visible; }), selectedIds = _.pluck(it.selected, 'id');out+='<h1></h1><form class="communities__content" method="POST" novalidate="novalidate"> <input name="id" type="hidden" value="'+(it.permalink)+'"> <div class="communities__content__wrapper"> <div class="communities__container" data-scroll-type="vertical"> ';var arr1=visibleCategories;if(arr1){var category,i=-1,l1=arr1.length-1;while(i<l1){category=arr1[i+=1];out+=' '; var active = selectedIds.indexOf(category.id) !== -1; out+=' <div class="community__item '+( active ? '-active' : '' )+'" data-community="'+(category.permalink)+'" data-community-id="'+(category.id)+'"> <img src="'+(category.med_image_url)+'" width="40" height="40" class="community__avatar" /> <div class="community__title">'+(category.title)+'</div> <div class="community__selector"></div> </div> ';} } out+=' </div> </div> <div class="communities__footer -clear"> '+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: "-push-shd -blue -rn -sb-dialog", value: I18n.t('customize_popup.simple_edit.buttons.publish'), type: 'submit' }) )+' </div></form>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/edit_coub_popup/edit_popup_body"] = function anonymous(it) {
  var out='<h1>'+(I18n.t('customize_popup.simple_edit.heading'))+'</h1><form accept-charset="UTF-8" method="POST" novalidate="novalidate"> <input name="id" type="hidden" value="'+(it.permalink)+'"> '+(JST["app/site/templates/shared/channel_select"](it))+' <div class="input-field-group" widget-transliteration-inputs auto-init> <input name="coub[title]" placeholder="'+(I18n.t('create.options.description_placeholder'))+'" type="text" value="'+(utils.encodeQuotes(it.title))+'" /> <input class="tags" name="coub[tags]" type="text" value="'+(helpers.Coub.coubTags(it, 'edit'))+'" /> <button type="button" class="sb -string edit-popup__clear-tags">'+(I18n.t('customize_popup.after_create.buttons.clear_tags'))+'</button> </div> <div class="-error-text" style="display:none"></div> '+(JST["app/site/templates/edit_coub_popup/options"](it))+' <div class="edit-popup__footer"> '+(JST["app/site/templates/edit_coub_popup/edit_popup_footer"](it))+' </div></form>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/edit_coub_popup/edit_popup_footer"] = function anonymous(it) {
  var out=''+(JST["app/site/templates/shared/visibility_select"](it))+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: "-push-shd -blue -rn -sb-dialog", value: I18n.t('customize_popup.simple_edit.buttons.publish'), type: 'submit' }));return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/edit_coub_popup/options"] = function anonymous(it) {
  var out='';if(it.from_editor_v2 == true){out+=' ';if(!it.published){out+=' <div class="publish-at -left-text -clear"> <div class="date-select"> '; var publishDate = it.published_at; if (!publishDate) { publishDate = new Date(); publishDate.setMinutes(Math.min(Math.floor(publishDate.getMinutes() / 5 + 1) * 5, 55)); } var dates = moment(publishDate).format('DD MMMM HH mm').split(' '), isoDate = moment(publishDate).toISOString(), vals = _.object(['day', 'month', 'hour', 'minute'], dates); out+=' <input class="date-select__input" data-default-date="'+(isoDate)+'" value="'+(isoDate)+'" type="hidden" name="coub[published_at]" /> <div> ';var arr1=['day', 'month'];if(arr1){var value,i1=-1,l1=arr1.length-1;while(i1<l1){value=arr1[i1+=1];out+=' '+( JST["app/site/templates/widgets/date_select/date_dropdown"]({type: value, value: vals[value]}) )+' ';} } out+=' '+( JST["app/site/templates/widgets/date_select/time_input"](vals) )+' </div> </div> <label class="checkbox-field box--inline"> <input type="checkbox" name="publish-at[active]" '+(it.published_at ? 'checked' : '')+' /> <div class="checkbox"></div> <span>'+( I18n.t('customize_popup.after_create.share_opts.publish_on.label') )+'</span> <input type="hidden" name="coub[published]" value="0" /> <input type="checkbox" name="coub[published]" value="1" class="-hidden" /> </label> </div> ';}out+=' <div class="media-flags"> <label class="checkbox-field '+(it.normalize_change_allowed ? "" : "disabled")+'"> <input name="coub[normalize_sound]" type="hidden" value="0" /> <input '+(it.normalize_sound ? 'checked' : '')+' name="coub[normalize_sound]" type="checkbox" value="1" /> <div class="checkbox"></div> '+( I18n.t('customize_popup.after_create.share_opts.normalize_sound.label') )+' </label> <label class="checkbox-field"> <input name="coub[dont_crop]" type="hidden" value="0" /> <input '+(it.dont_crop ? 'checked' : '')+' name="coub[dont_crop]" type="checkbox" value="1" /> <div class="checkbox"></div> '+( I18n.t('customize_popup.after_create.share_opts.dont_crop.label') )+' </label> </div>';}return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/add_segment_stub/add_segment_stub"] = function anonymous(it) {
  var out=''; out+='<div class="cb-edtr__add-source__stub static" widget-coubed-add-segment-stub> '+(JST["app/site/templates/svg/icons/24/plus"]())+' '+( JST["app/site/templates/widgets/dropdown_with_handler/dropdown_with_handler"] ({ dClass: "-select", hClass: "", attrs: "coubed-add-segment-stub-dropdown", handler: JST["app/site/templates/editor/add_segment_stub/add_segment_stub_body"](), content: JST["app/site/templates/editor/controls/dropdowns/additional_source_dropdown"]() }) )+'</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/add_segment_stub/add_segment_stub_body"] = function anonymous(it) {
  var out='<div class="segment__delete-control" coubed-add-segment-stub-remove-upload auto-init> '+(JST['app/site/templates/svg/icons/24/delete']())+'</div><div class="cb-edtr__process cb-edtr__process--segment"> <div class="cb-edtr__process__upload" widget-coubed-fake-progress-bar></div> <div class="cb-edtr__process__progress" widget-coubed-fake-progress-bar> <div class="cb-edtr__process__bg"></div> </div> <p class="cb-edtr__process-text hbold -centered-text" coubed-add-segment-stub-uploading-msg>Uploading</p></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/audio_editor/audio_editor_menu"] = function anonymous(it) {
  var out=''; out+=''+( JST['app/site/templates/widgets/dropdown_with_handler/dropdown_with_handler']({ handler: JST['app/site/templates/editor/audio_editor/audio_editor_menu_handler'](), content: JST['app/site/templates/editor/audio_editor/audio_editor_menu_content'](), dClass: "cb-edtr-audio__menu", hClass: "cb-edtr-audio__menu__handler", cClass: "cb-edtr-audio__menu__content", attrs: "audio-menu='true'" }));return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/audio_editor/audio_editor_menu_content"] = function anonymous(it) {
  var out='<ul class="list list--selectable"> <li auto-init="true" class="list__item list__item-beta -delete" widget-coubed-remove-external-music="true"> '+( JST["app/site/templates/svg/icons/24/delete"]() )+' <span>Delete</span> </li></ul>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/audio_editor/audio_editor_menu_handler"] = function anonymous(it) {
  var out='<button class="sb -st -rn"> <div class="cb-edtr-audio__menu__handler__down-icon"> '+(JST["app/site/templates/svg/icons/16/down"]())+' </div> <div class="cb-edtr-audio__menu__handler__sound-icon"> '+(JST["app/site/templates/svg/icons/16/sound-half"]())+' </div></button>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/audio_editor/audio_editor_timeline"] = function anonymous(it) {
  var out=''; out+='<div class="cb-edtr-audio__full-timeline -short" widget-audio-timeline="true" widget-coubed-timings-control-position-calc="true"> <div class="cb-edtr-audio__film-na-container -left" zone-film-left-container="true"> <div class="cb-edtr-audio__film-na-container__inner -left" zone-film-left-container-inner="true"> <div class="cb-edtr-audio__full-timeline__film-na -bg -left" zone-film-left="true"></div> <div class="cb-edtr-audio__full-timeline__film-na -active -left" zone-film-left="true" active="true" focusable="true"></div> </div> </div> <div class="cb-edtr-audio__film-na-container -right" zone-film-right-container="true"> <div class="cb-edtr-audio__film-na-container__inner -right" zone-film-right-container-inner="true"> <div class="cb-edtr-audio__full-timeline__film-na -bg -right" zone-film-right="true"></div> <div class="cb-edtr-audio__full-timeline__film-na -active -right" zone-film-right="true" active="true" focusable="true"></div> </div> </div> <div class="cb-edtr-audio__full-timeline__film-middle -bg -left" film-middle="true" left="true"></div> <div class="cb-edtr-audio__full-timeline__film-middle -bg -right" film-middle="true" right="true"></div> <div class="cb-edtr-audio__full-timeline__film-middle -bg -middle" film-middle="true" middle="true"></div> <div active="true" class="cb-edtr-audio__full-timeline__film-middle -active -left" film-middle="true" focusable="true" left="true"> <div class="cb-edtr-audio__full-timeline__cutter -left" cutter-left="true" data-prompt="Audio is loading" data-prompt-class="-white" data-prompt-top="-2" focusable="true"> <div class="cb-edtr-audio__full-timeline__cutter__dragger"></div> <div class="cutter__frames-shifter -left" lock="false" model-value="start" mouse-stream-pass-mousedown="true" timing-position="left" widget-coubed-timings-control="true"></div> </div> <div class="cb-edtr-audio__full-timeline__cut">'+(JST["app/site/templates/svg/icons/editor_specific/audio-editor-cut"]())+'</div> </div> <div active="true" class="cb-edtr-audio__full-timeline__film-middle -active -middle" film-middle="true" focusable="true" middle="true"> <div class="cb-edtr-audio__full-timeline__cut">'+(JST["app/site/templates/svg/icons/editor_specific/audio-editor-cut"]())+'</div> </div> <div active="true" class="cb-edtr-audio__full-timeline__film-middle -active -right" film-middle="true" focusable="true" right="true"> <div class="cb-edtr-audio__full-timeline__cutter -right" cutter-right="true" data-prompt="Audio is loading" data-prompt-class="-white" data-prompt-top="-2" focusable="true"> <div class="cb-edtr-audio__full-timeline__cutter__dragger"></div> <div class="cutter__frames-shifter -right" lock="false" model-value="end" mouse-stream-pass-mousedown="true" style="left: -60px;" timing-position="right" widget-coubed-timings-control="true"></div> </div> </div> <div class="cb-edtr-audio__full-timeline__overall-time-container" focusable="true" overall-time-container="true"> <div class="cutter__frames-shifter cutter__frames-shifter--part cb-edtr-audio__full-timeline__overall-time" model-value="end" mouse-stream-pass-mousedown="true" timing-position="middle" widget-coubed-overall-timings-control="true"></div> </div> <div class="cb-edtr-audio__full-timeline__yellow-mark" yellow-mark="true"></div> <div class="cb-edtr-audio__full-timeline__cutter-bg -left" cutter-bg-left="true"></div> <div class="cb-edtr-audio__full-timeline__cutter-bg -right" cutter-bg-right="true"></div> <div chart-left="true" class="cb-edtr-audio__full-timeline__part -left" loops-container="left" widget-coubed-audio-editor-graph="true"> <div canvas-container="true" class="cb-edtr-audio__full-timeline__canvas-container"></div> </div> <div chart-middle="true" class="cb-edtr-audio__full-timeline__part -middle" loops-container="middle" widget-coubed-audio-editor-graph="true"> <div canvas-container="true" class="cb-edtr-audio__full-timeline__canvas-container"></div> </div> <div chart-right="true" class="cb-edtr-audio__full-timeline__part -right" loops-container="right" widget-coubed-audio-editor-graph="true"> <div canvas-container="true" class="cb-edtr-audio__full-timeline__canvas-container"></div> </div> <div available-zone="true" class="cb-edtr-audio__full-timeline__short -bg"></div> <div available-zone="true" class="cb-edtr-audio__full-timeline__short -active" data-prompt="Edit audio" data-prompt-class="-white" data-prompt-top="-3" focusable="true" switch-to-full-timeline="true"> <div class="cb-edtr-audio__full-timeline__short__note"></div> <div class="cb-edtr-audio__timeline__dots"> &middot;&middot;&middot; </div> </div> <div class="cb-edtr-audio__full-timeline__focus-border" cutter-zone="true"></div> '+(JST["app/site/templates/editor/audio_editor/audio_editor_menu"]())+'</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/controls/dropdowns/additional_source_dropdown"] = function anonymous(it) {
  var out='<div widget-coubed-add-segment-popup> <div class="cb-edtr__add-source__list" add-segment-popup-menu-piece> <ul class="list list--selectable"> <li class="list__item list__item-beta duplicate submenu -triangle-left" widget-duplicate-segment-menu auto-init> '+( JST["app/site/templates/svg/icons/24/duplicate"]() )+' '+( coubEditor.utils.I18n.add_segment.duplicate_video )+' <ul class="submenu__menu list list--selectable dropdown__content" submenu-menu widget-duplicate-segment-submenu auto-init> </ul> </li> <li class="list__item list__item-beta coub-link" add-segment-popup-button-add-from-coub> '+( JST["app/site/templates/svg/icons/24/create"]() )+' '+( coubEditor.utils.I18n.add_segment.coub_link )+' </li> <li class="list__item list__item-beta video-link" add-segment-popup-button-add-from-yv> '+( JST["app/site/templates/svg/icons/24/video"]() )+' '+( coubEditor.utils.I18n.add_segment.video_link )+' </li> <li class="list__item list__item-beta upload-file" add-segment-popup-button-upload widget-coubed-add-segment-local> '+( JST["app/site/templates/svg/icons/24/arrow-up"]() )+' '+( coubEditor.utils.I18n.add_segment.upload_video )+' </li> </ul> </div> <div class="cb-edtr__add-source__paste" style="display:none" add-segment-popup-yv-piece widget-coubed-add-external-video> <div class="back start" add-segment-popup-back>'+( I18n.t("auth_popup.buttons.back"))+'</div> <input type="text" placeholder="'+( coubEditor.utils.I18n.add_segment.video_link_placeholder )+'" class="input-field -sq" add-coub-segment-coub-url coubed-abstract-pastable-input autocomplete="off"> <div class="-error-text -hidden" error-container></div> </div> <div class="cb-edtr__add-source__paste" style="display:none" add-segment-popup-coub-piece widget-coubed-add-coub-segment> <div class="back start" add-segment-popup-back>'+( I18n.t("auth_popup.buttons.back"))+'</div> <input type="text" placeholder="'+( coubEditor.utils.I18n.add_segment.coub_link_placeholder )+'" class="input-field -sq" coubed-abstract-pastable-input> <div class="-error-text -hidden" error-container></div> <ul class="list list--selectable cb-edtr__add-source__sugg -hidden" widget-coubed-coub-segment-suggestions> </ul> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/controls/dropdowns/black_stripes_tip"] = function anonymous(it) {
  var out='';  var image = helpers.Application.retinizeImg(it.raw_video.image_uncropped, it.raw_video.image_uncropped_retina); var offset = it.raw_video.image_crop_offset, imgHeight = offset[1] + offset[3] * 2; var croppedStyles = ['height:' + offset[1] + 'px;margin:' + offset[3] + 'px 0 ' + offset[3] + 'px', 'margin-top:' + offset[3] * -1 + 'px']; var eh = new coubEditor.helpers.Helper(); var href = it.isEditing ? Routes.edit_coub_path(it.coubPermalink) : Routes.source_path(it.raw_video_id); href = it.reverse ? eh.getCroppedUrl(href) : eh.getUncroppedUrl(href); var handlerText = I18n.t('create.stripes.text.' + (it.reverse ? 'returned' : 'removed')); var handler = '<span>'+(I18n.t('create.stripes.text_button'))+'</span>', content = '<div class="compare"> <div class="compare__ex compare__before"> <div class="compare__ex-img"> <img '+(image)+' width="'+(offset[0])+'" height="'+(imgHeight)+'"> </div> <span>'+(I18n.t('create.stripes.content.before'))+'</span> </div> <div class="compare__ex compare__after"> <div class="compare__ex-img" style="'+(croppedStyles[0])+'"> <img '+(image)+' width="'+(offset[0])+'" height="'+(imgHeight)+'" style="'+(croppedStyles[1])+'"> </div> <span>'+(I18n.t('create.stripes.content.after'))+'</span> </div> </div> <div class="buttons"> <button class="sb -string dropdown__cancel"> '+(I18n.t('create.stripes.content.cancel'))+' </button> <a href="'+(href)+'" class="sb -rn -push-shd -blue"> '+(I18n.t('create.stripes.content.' + (it.reverse ? 'remove_stripes' : 'return_stripes')))+' </a> </div>';out+='<div class="black-stripes-tip"> '+( JST["app/site/templates/widgets/dropdown_with_handler/dropdown_with_handler"]({ dClass: 'strict-above', hClass: "", handler: '<p>' + handlerText + '</p>', content: content }) )+'</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/controls/player/mouse_position_highlighter"] = function anonymous(it) {
  var out=''; out+='<div class="mouseHighlight no-animation" mouse-highlight></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/controls/player/progressbar"] = function anonymous(it) {
  var out='<div class="player-controls__progress"> <div class="player-controls__progress-loading"> <div class="-fill" style="width:0" auto-init widget-coubed-segment-player-progress></div> </div> <div class="player-controls__progress-segment" auto-init widget-coubed-segment-player-position> <div class="progress-segment__con"> <div class="progress-segment__con-vis"></div> </div> <div class="progress-segment__con-cur" auto-init widget-coubed-segment-player-current-position></div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/coub_changed_popup/coub_changed_popup"] = function anonymous(it) {
  var out='';  var h = new coubEditor.helpers.Helper();out+='<div class="coub-changed-popup"> <h1>'+(coubEditor.utils.I18n.edit.heavily_modified_popup.title)+'</h1> <div class="coub-changed-popup__reasons"> <ul> ';var arr1=it.reasons;if(arr1){var reason,index=-1,l1=arr1.length-1;while(index<l1){reason=arr1[index+=1];out+=' <li class="hbold"> ';if(reason == h.DIFF_AUDIO){out+=' '+(coubEditor.utils.I18n.edit.heavily_modified_popup.reasons.audio)+' ';}else if(reason == h.DIFF_SEGMENT_ADDED){out+=' '+(coubEditor.utils.I18n.edit.heavily_modified_popup.reasons.segment_added)+' ';}else if(reason == h.DIFF_SEGMENT_REMOVED){out+=' '+(coubEditor.utils.I18n.edit.heavily_modified_popup.reasons.segment_removed)+' ';}else if(reason == h.DIFF_SEGMENT_CHANGED_TOO_MUCH){out+=' '+(coubEditor.utils.I18n.edit.heavily_modified_popup.reasons.segment_changed_too_much)+' ';}else if(reason == h.DIFF_PLAYBACK_TYPE_CHANGED){out+=' '+(coubEditor.utils.I18n.edit.heavily_modified_popup.reasons.playback)+' ';}out+=' </li> ';} } out+=' </ul> </div> <div class="coub-changed-popup__buttons"> <div class="coub-changed-popup__button"> <button type="button" class="sb -rn -blue box--vertical" post>'+(coubEditor.utils.I18n.edit.heavily_modified_popup.post_as_new)+'</button> </div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/coub_segment_suggest/coub_segment_suggest"] = function anonymous(it) {
  var out='';  var imageAttrs = helpers.Application.retinizeImg(it.image, it.image_retina);out+='<li class="list__item object-media" data-src="'+(it.url)+'" coubed-coub-segment-suggestions-handler> <div class="object-media__img"> <img '+(imageAttrs)+' class="image box--inline"/> </div> <div class="object-media__body"> <p class="hbold box--inline">'+(it.title)+'</p> </div></li>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/debug/debug_interface"] = function anonymous(it) {
  var out=''; out+='<div widget-coubed-debug-interface auto-init class="coubedDebugInterface"> <div class="editorControls"> <button type="button" widget-coubed-debug-interface-add-segment>Добавить видео сегмент</button> <button type="button" coubed-debug-interface-add-segment-stub>Добавить заглушку сегмента</button> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/debug/debug_segments"] = function anonymous(it) {
  var out=''; out+='<div widget-coubed-debug-video-segment class="videoSegment"> <h2>Видео сегмент</h2> <div> <!--<button type="button" widget-coubed-debug-video-segment-type="single">Single</button>--> <!--<button type="button" widget-coubed-debug-video-segment-type="begginning">Beggining</button>--> <!--<button type="button" widget-coubed-debug-video-segment-type="middle">Middle</button>--> <!--<button type="button" widget-coubed-debug-video-segment-type="ending">Ending</button>--> </div> <div class="fields"> </div> <button type="button" widget-coubed-debug-video-segment-update>Обновить</button></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/debug/debug_single_segment"] = function anonymous(it) {
  var out=''; out+='<div> <label>'+(it.key)+'</label> <input type="text" name="'+(it.key)+'"></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/segment_to_add/segment_to_add"] = function anonymous(it) {
  var out='';  var screenshots = !it.screens ? [] : it.screens, second = 72, segmentWidth = second * it.duration + "px", dataString = JSON.stringify(it); console.log(second / it.duration);out+='<div class="segment__screenshots box--inline -ribbon" auto-init widget-coubed-segment-to-add length="'+(it.duration)+'" json='+(dataString)+' segment-id="'+(it.id)+'" source-width="'+(it.source_width)+'" source-height="'+(it.source_height)+'"> <ul segment-to-add-screenshots style="width:'+(segmentWidth)+'"> ';var arr1=screenshots;if(arr1){var screenshot,index=-1,l1=arr1.length-1;while(index<l1){screenshot=arr1[index+=1];out+=' <li> <img src="'+(screenshot)+'"> </li> ';} } out+=' </ul></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/segments_popup/segments_popup"] = function anonymous(it) {
  var out='';  var coub = it.coub, channel = it.channel; var avatar = helpers.Application.specificImgVersion(channel, 'avatar_versions', 'small');out+='<div> <h1>Select a coub part you want to insert</h1> <div class="add-segment__segments"> ';var arr1=it.segments;if(arr1){var segment,index=-1,l1=arr1.length-1;while(index<l1){segment=arr1[index+=1];out+=' '+( JST['app/site/templates/editor/segment_to_add/segment_to_add'](segment) )+' ';} } out+=' </div> <div class="object-media"> <div class="object-media__img"> <a href="'+(Routes.user_path({'id': channel.permalink}))+'"> <img width="38" height="38" '+(avatar)+' class="image -rounded -ribbon"> </a> </div> <div class="object-media__body"> <h5 class="hbold">'+(helpers.Coub.getTitle(coub))+'</h5> <div class="-sub"> '+(channel.title)+' <span>'+(helpers.Application.smartDateTime(coub,true))+'</span> </div> </div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/timeline/current_position"] = function anonymous(it) {
  var out='<div  class="cb-edtr__timeline-ind" widget-current-position-indicator auto-init></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/timeline/dnd/dnd_zone"] = function anonymous(it) {
  var out=''; out+='<div class="timeline__drop-zone" timeline-block zone-index="'+(it.i)+'" drop-zone="true"></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/timeline/frame-controls/frame-controls"] = function anonymous(it) {
  var out='';  var inputsWidgetName = it.inputsWidgetName ? it.inputsWidgetName : "widget-coubed-time-inputs", renderArrows = typeof(it.renderArrows) != "undefined" ? it.renderArrows : true, attrs = it.isAudioCutter ? "widget-coubed-auto-width-input" : "widget-coubed-auto-width-input auto-init";out+='<div class="frames-shifter__container" '+(inputsWidgetName)+' frames-shifter-container> ';if(renderArrows){out+=' <div class="frames-shifter__back -ribbon-bg-hvr" data-delayed-prompt="Prev frame" decrement> <div class="frames-shifter__back__left-icon">'+(JST["app/site/templates/svg/icons/24/left"]())+'</div> <div class="frames-shifter__back__bwd-icon -hidden">'+(JST["app/site/templates/svg/icons/24/backward"]())+'</div> </div> ';}out+=' <div class="cb-edtr__time-stamp" time> '+( JST["app/site/templates/editor/timeline/frame-controls/time"]({ pat: it.pat, isInput: true, adClass: "time", attrsForEach: {minutes: attrs} }) )+' </div> ';if(renderArrows){out+=' <div class="frames-shifter__back -ribbon-bg-hvr" data-delayed-prompt="Next frame" increment> <div class="frames-shifter__back__left-icon">'+(JST["app/site/templates/svg/icons/24/left"]())+'</div> <div class="frames-shifter__back__bwd-icon -hidden">'+(JST["app/site/templates/svg/icons/24/backward"]())+'</div> </div> ';}out+='</div><div class="frames-shifter__dropdown-arrow"></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/timeline/frame-controls/time"] = function anonymous(it) {
  var out='';  var pat = it && it.pat && it.pat.length==3 ? it.pat : [true,true,true]; var isInput = it ? it.isInput : false; var attrs = it && it.attrs ? it.attrs : ""; var adClass = it && it.adClass ? it.adClass : ""; var attrsForEach = it.attrsForEach ? it.attrsForEach : {}; var lib = [ {name: "minutes", separator: null, val: "0"}, {name: "seconds", separator: ":", val: "00"}, {name: "decimal", separator: ".", val: "00"} ]; for(var i in pat){ out+=' ';if(pat[i]==true){out+=' '; var val = lib[i]; out+=' ';if(val.separator!=null && pat[i-1]==true){out+=' <span>'+(val.separator)+'</span> ';}out+=' '; if(attrsForEach[val.name]){ var attrForThis = attrsForEach[val.name]; }else{ var attrForThis = ""; } out+=' ';if(isInput){out+=' <input '+(attrForThis)+' class="'+(val.name)+' timecode-input '+(adClass)+'" '+(val.name)+' value="'+(val.val)+'" '+(attrs)+' weight="'+(val.name)+'"></input> ';}else{out+=' <time '+(attrForThis)+' class="'+(val.name)+' '+(adClass)+'" '+(val.name)+' weight="'+(val.name)+'" '+(attrs)+'>'+(val.val)+'</time> ';}out+=' ';} } return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/timeline/grayness"] = function anonymous(it) {
  var out=''; out+='<div class="cb-edtr__timeline__limiter" widget-coubed-grayness auto-init></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/timeline/overall_timestamp"] = function anonymous(it) {
  var out=''; out+='<div class="cb-edtr__timeline__stamp hnormal" widget-coubed-overall-timestamp-line auto-init> <div class="timeline__triangle left"></div> <div class="timeline__triangle right"></div> <div class="timeline__stamp-inner box--vertical"> <div class="cb-edtr__time-stamp box--vertical" time> '+( JST["app/site/templates/editor/timeline/frame-controls/time"]({ pat: [false, true, true] }) )+' </div> <div class="timeline__stamp-max box--vertical">(10 max)</div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/timeline/screenshots"] = function anonymous(it) {
  var out='';  if(!it){ it = {}; } if(!it.data){ it.data = []; }var arr1=it.data;if(arr1){var value,index=-1,l1=arr1.length-1;while(index<l1){value=arr1[index+=1];out+=' <li style="height: 62px;"> <img src="'+(value)+'" height="62"> </li>';} } return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/timeline/segment"] = function anonymous(it) {
  var out='';  var it = it ? it : {}; if(!it.screenshots){ it.screenshots = []; }out+='<div class="cb-edtr__timeline__segment" widget-coubed-video-segment auto-init timeline-block> '; var transPlacements = ["left", "right"]; out+=' '; for(var i in transPlacements){ out+=' <div class="segment__na segment__na--'+(transPlacements[i])+'" widget-coubed-video-segment-not-active-film="'+(transPlacements[i])+'"> ';if(transPlacements[i] == 'left'){out+=' <div class="corner tl"></div> <div class="corner bl"></div> ';}else{out+=' <div class="corner tr"></div> <div class="corner br"></div> ';}out+=' </div> '; } out+=' <div class="segment__visible" widget-coubed-video-segment-cutter> '; var corners = ['tl', 'tr', 'bl', 'br']; out+=' '; for (var corner in corners) { out+=' <div class="corner '+(corners[corner])+'"></div> '; } out+=' <div class="segment__reverse-indicator"></div> <div class="segment__indicators"> <div class="segment__icon segment__mute-indicator"> '+(JST['app/site/templates/svg/icons/16/sound-off']())+' </div> <div class="segment__icon segment__reaction-indicator"> '+(JST['app/site/templates/svg/icons/16/emoji']())+' </div> <div class="segment__icon segment__splice-indicator"> '+(JST['app/site/templates/svg/icons/16/splices']())+' </div> </div> <div class="sb-group--segment"> '+( JST["app/site/templates/editor/timeline/segment_popup/segment_popup"]() )+' </div> <div class="segment__cutter -fill" widget-coubed-video-segment-frame-controls auto-init> <div class="cutter__handle cutter__handle--left"> <div class="cutter__handle-dragger" widget-coubed-video-segment-cutter-bound="min"></div> <div class="cutter__frames-shifter -only-hvr" widget-video-segment-frame-control model-value="currentStart"> '+( JST["app/site/templates/editor/timeline/frame-controls/frame-controls"]({modelValue: "currentStart"}) )+' </div> </div> <div class="cutter__handle cutter__handle--right"> <div class="cutter__handle-dragger" widget-coubed-video-segment-cutter-bound="max"></div> <div class="cutter__frames-shifter -only-hvr" widget-video-segment-frame-control model-value="currentEnd"> '+( JST["app/site/templates/editor/timeline/frame-controls/frame-controls"]({modelValue: "currentEnd"}) )+' </div> </div> <div auto-init widget-coubed-video-segment-overall-time class="cutter__frames-shifter cutter__frames-shifter--part" model-value="currentEnd"> '+( JST["app/site/templates/editor/timeline/frame-controls/frame-controls"]({ modelValue: "currentStart", pat: [false, true, true], inputsWidgetName: coubEditor.widgets.OverallTimeInputs.ATTR_NAME, renderArrows: false }) )+' </div> </div> <div class="segment__dnd-handler" auto-init widget-coubed-video-segment-dnd-handler> <span /> <span /> <span /> </div> </div> <div class="segment__screenshots" widget-coubed-video-segment-film> <ul widget-coubed-video-segment-screenshots> '+(JST["app/site/templates/editor/timeline/screenshots"]({data: it.screenshots}))+' </ul> <div class="limiter"></div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/timeline/segment_popup/segment_popup"] = function anonymous(it) {
  var out=''; out+='<div class="segment__dropdown sb-join__btn" widget-coubed-segment-dropdown auto-init> '+( JST["app/site/templates/editor/timeline/segment_popup/segment_popup_handler"]() )+'</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/timeline/segment_popup/segment_popup_content"] = function anonymous(it) {
  var out=''; out+='<ul class="list list--selectable segment__dropdown__content -no-select"> <li class="list__item list__item-beta -duplicate" widget-coubed-video-segment-duplicate auto-init> '+( JST["app/site/templates/svg/icons/24/duplicate"]() )+' '+( coubEditor.utils.I18n.segment_popup.duplicate )+' </li> <li class="list__item list__item-beta -reverse" widget-coubed-video-segment-toggle-button data-field="reverse" auto-init> '+( JST["app/site/templates/svg/icons/24/arrow-left"]() )+' '+( coubEditor.utils.I18n.segment_popup.time_reverse )+' </li> <li class="list__item list__item-beta -mute" widget-coubed-video-segment-toggle-button data-field="mute" auto-init> '+( JST["app/site/templates/svg/icons/24/sound-off"]() )+' '+( coubEditor.utils.I18n.segment_popup.mute )+' </li> <li class="list__item list__item-beta -delete" widget-coubed-delete-video-segment auto-init> '+( JST["app/site/templates/svg/icons/24/delete"]() )+' '+( coubEditor.utils.I18n.segment_popup.delete )+' </li></ul>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/editor/timeline/segment_popup/segment_popup_handler"] = function anonymous(it) {
  var out=''; out+='<button type="button" class="sb -st -sq segment__dropdown__handler"> '+(JST["app/site/templates/svg/icons/16/down"]())+'</button>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/media_block/media_block"] = function anonymous(it) {
  var out='';  var media_blocks = it.media_blocks, recoubed = _.filter(media_blocks.remixed_from_coubs, function(o) { o.type = 'recoub'; return o.coub_channel_permalink !== "random.reactions" }), external = _.map(media_blocks.external_raw_videos, function(o) { o.type = 'external'; return o }), uploaded = _.map(media_blocks.uploaded_raw_videos, function(o) { o.type = 'uploaded'; return o }), queue = _.union(recoubed, external, uploaded), showMoreButton = queue.length > 1;out+='<div class="coub__media-block -hidden"> ';var arr1=queue;if(arr1){var item,i1=-1,l1=arr1.length-1;while(i1<l1){item=arr1[i1+=1];out+=' ';if(item.type == 'recoub'){out+=' '+(JST["app/site/templates/media_block/recoub_block"]({ json: item, is_media_block: true }))+' ';}else{out+=' '+(JST["app/site/templates/media_block/video_block"]({json: item, coub:it, is_external_video: item.type == 'external' }))+' ';}out+=' ';} } out+=' ';if(showMoreButton){out+=' '+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: "-st -rn media-block__show-more-less", value: '' }) )+' ';}out+='</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/media_block/recoub_block"] = function anonymous(it) {
  var out='';  var json = it.json, is_media_block = it.is_media_block, classes = is_media_block ? 'from-media-block' : '', coub_permalink = is_media_block ? json.coub_permalink : json.permalink, url = Routes.view_coub_by_permalink_path(coub_permalink), image_url = is_media_block ? json.image_retina : helpers.Coub.getFileVersion(json.image_versions, 'med'), title = json.title, channel_title = is_media_block ? json.coub_channel_title : json.channel.title, views_count = is_media_block ? json.coub_views_count : json.views_count, count = numeral(views_count).format("0,0");out+='<div class="media-block__item coub__recoub-block '+(classes)+'"> <a href='+(url)+' class="-fill" target="_blank" type="coub-url"/> <div class="media-block__preview-image box--inline" style="background-image:url('+(image_url)+');"> ';if(is_media_block){out+=' <div class="-fill"></div> ';}out+=' </div> <div class="media-block__description box--inline"> ';if(is_media_block){out+=' <div class="media-block__type">'+(I18n.t('coub.media_block.recoubed_from'))+'</div> ';}out+=' <h5 class="media-block__title hbold">'+(title)+'</h5> <div class="recoub__username">'+(channel_title)+'</div> ';if(views_count > 0){out+=' <div class="recoub__views-count">'+(count)+' '+(I18n.t("coub.views_count", {count: count}))+'</div> ';}out+=' </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/media_block/video_block"] = function anonymous(it) {
  var out='';  var json = it.json, coub = it.coub, is_external_video = it.is_external_video, attrs = '', image_url = json.image_retina, title = json.title, duration = helpers.Application.formatSecondsToString(json.duration), url = json.url, source_url = helpers.Application.getSourceUrlForMediaBlock(json, coub), type = is_external_video ? I18n.t('coub.media_block.original_video') : I18n.t('coub.media_block.source'); if (is_external_video) { if (json.has_embed) { attrs = "type=embedPopup" + " source=" + source_url + " href=" + url + " target=_blank"; } else { attrs = "href=" + url + " target=_blank"; } } else { attrs = "href=" + source_url + " target=_blank"; }out+='<div class="media-block__item coub__video-block '+( json.has_embed ? 'has-embed' : '')+'"> <a '+(attrs)+'> <div class="media-block__preview-image box--inline -ribbon" style="background-image:url('+(image_url)+');"> <div class="-fill"></div> <div class="media-block__duration hbold">'+(duration)+'</div> </div> </a> <div class="media-block__description box--inline"> <div class="media-block__type">'+(type)+'</div> <h5 class="hbold"> <a '+(attrs)+' class="media-block__title -ribbon-hvr-text">'+(title)+'</a> </h5> '+( JST["app/site/templates/widgets/make_another_coub_button/make_another_coub_button"]({url: source_url}) )+' </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/modal_popup/modal_popup"] = function anonymous(it) {
  var out='<div class="modal '+(it.classes)+'"> <div class="modal__background"></div> <div class="modal__inner"> <div class="modal__content"> <div class="modal__close close-small"></div> <div class="modal__body">'+(it.content)+'</div> <div class="modal__footer">'+(it.footer)+'</div> </div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/object_media/object_media_notification_list/object_media_notification_list"] = function anonymous(it) {
  var out='';  var attrs = it.attrs || ''; var classes = it.classes || ''; var bgLink = it.bgLink || ''; var isimportant = it.important ? it.important : false; var img = it.img || ''; var body = it.body || ''; if(isimportant) classes += " important";out+='<li class="list__item list__item-beta object-media -clear '+(classes)+'" '+(attrs)+'> <a href="'+(bgLink)+'"> <div class="object-media__img"> '+(img)+' </div> <div class="object-media__body"> '+(body)+' </div> </a></li>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/profile/cover_error_popup"] = function anonymous(it) {
  var out='<div class="box box--banner -centered-box cover-error"> <p>'+(I18n.t('profile.cover.popups.error'))+'</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/profile/delete_cover_popup"] = function anonymous(it) {
  var out='<div class="box box--banner -centered-box -centered-text"> <div class="box__close">'+(JST["app/site/templates/svg/icons/16/close"]())+'</div> <h3 class="hthin">'+(it.heading)+'</h3> <div class="sb-group sb-group--simple"> '+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: "-st -rn -grey remove", attrs: "", value: I18n.t('profile.cover.popups.remove') }) )+' '+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: "-st -rn -grey cancel", attrs: "", value: "Cancel" }) )+' </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/profile/reposition_cover_control"] = function anonymous(it) {
  var out='<div class="hero-cover__reposition -centered-box"> <p> '+(I18n.t('profile.cover.popups.cover_positioner'))+' </p> '+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: "-string", attrs: "action='cancelReposition'", value: "Cancel" }) )+' '+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: "-string", attrs: "action='resetCoverToPrevious'", value: "Cancel" }) )+' '+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: "-st -rn -grey -sb-beta save-cover", attrs: "action='saveCover'", value: I18n.t('profile.save') }) )+'</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/profile/settings_button"] = function anonymous(it) {
  var out='<div class="channel__hoverable icon"> <a href='+(it.url)+'> '+(JST['app/site/templates/svg/icons/24/settings']())+' </a></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/profile/upload_coub_popup"] = function anonymous(it) {
  var out='<div class="box box--banner -centered-box"> <div class="box__close">'+(JST["app/site/templates/svg/icons/16/close"]())+'</div> <div class="permalink"> <input type="text" id="permalink" name="permalink" placeholder="'+(I18n.t('profile.cover.popups.placeholder'))+'" class="input-field -sq" /> <div class="hd">'+(I18n.t('profile.cover.popups.hd_mark'))+'</div> <div class="-error-text -hidden"></div> </div> <p>'+(I18n.t('profile.cover.popups.tip'))+'</p></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/promoted_coubs/campaign_details"] = function anonymous(it) {
  var out='';  var details = helpers.PromotedCoubsHelper.calcDetails(it.promotedCoub), countries = it.promotedCoub.country_codes.map(function(c) { return I18n.t("countries." + c); }).join(', '), platforms = it.promotedCoub.platforms.map(function(p) { return I18n.t("promoted_coubs.platforms." + p) }).join(', '), startDate = moment(it.promotedCoub.started_at).format('D MMMM'), isActive = it.promotedCoub.is_active, status = it.promotedCoub.status, pauseButtonText = isActive ? I18n.t('promoted_coubs.details.pause') : I18n.t('promoted_coubs.details.start'), statusText = I18n.t('promoted_coubs.statuses.' + status), isPauseButtonShowed = status != 'finished', isEditButtonShowed = status != 'finished'; if (status == 'approved' && !isActive) { statusText = I18n.t('promoted_coubs.statuses.paused'); } if (!it.promotedCoub.country_codes.length) { countries = I18n.t('promoted_coubs.all_countries'); } if (!it.promotedCoub.platforms.length) { platforms = I18n.t('promoted_coubs.platforms.all'); }out+='<div class="campaign-details"> <div class="campaign-details__left"> <div class="campaign-details__coub"> ';if(it.coub){out+=' '+(JST["app/site/templates/coub_block/coub"](it.coub))+' ';}out+=' </div> <div class="campaign-details__info"> <h3>'+(I18n.t('promoted_coubs.details.title'))+'</h3> <ul> <li><span>'+(I18n.t('promoted_coubs.details.views'))+'</span>'+(details.targetViews)+'</li> <li><span>'+(I18n.t('promoted_coubs.details.location'))+'</span>'+(countries)+'</li> <li><span>'+(I18n.t('promoted_coubs.details.platforms'))+'</span>'+(platforms)+'</li> <li><span>'+(I18n.t('promoted_coubs.details.start_date'))+'</span>'+(startDate)+'</li> ';if(it.promotedCoub.web_link){out+=' <li> <span>'+(I18n.t("promoted_coubs.details.web"))+'</span> '+(it.promotedCoub.web_link)+' </li> ';}out+=' ';if(it.promotedCoub.ios_link){out+=' <li> <span>'+(I18n.t("promoted_coubs.details.ios"))+'</span> '+(it.promotedCoub.ios_link)+' </li> ';}out+=' ';if(it.promotedCoub.android_link){out+=' <li> <span>'+(I18n.t("promoted_coubs.details.android"))+'</span> '+(it.promotedCoub.android_link)+' </li> ';}out+=' ';if(GlobalState.USER.isAdmin()){out+=' <li> <span>Label: </span> '+(it.promotedCoub.label || "")+' </li> ';}out+=' </ul> </div> ';if(isEditButtonShowed){out+=' <a class="sb -st -rn campaign-details__edit-button" href="'+(Routes.edit_promoted_coub_path(it.promotedCoub.id))+'">'+(I18n.t("promoted_coubs.buttons.edit"))+'</a> ';}out+=' </div> <div class="campaign-details__right"> <div class="campaign-details__top-line"> <div class="campaign-details__status">'+(I18n.t('promoted_coubs.details.status'))+'<span>'+(statusText)+'</span></div> ';if(isPauseButtonShowed){out+=' <button class="sb -st -rn campaign-details__pause-button">'+(pauseButtonText)+'</button> ';}out+=' </div> <ul class="campaign-details__stats"> <li> <div>'+(I18n.t("promoted_coubs.values.total_views"))+'</div> <div>'+(details.totalViews)+'</div> </li> <li> <div>'+(I18n.t("promoted_coubs.values.paid_views"))+'</div> <div>'+(details.paidViewsNow)+'</div> </li> <li> <div>'+(I18n.t("promoted_coubs.values.cpv"))+'</div> <div>'+(details.costPerView)+'</div> </li> <li> <div>'+(I18n.t("promoted_coubs.values.engagement"))+'</div> <div>'+(details.engagement)+'</div> </li> <li> <div>'+(I18n.t("promoted_coubs.values.cpe"))+'</div> <div>'+(details.costPerEngagement)+'</div> </li> <li> <div> '+(I18n.t("promoted_coubs.values.total_clicks"))+' <div class="campaign-details__clicks-dropdown-handler">'+(JST['app/site/templates/svg/icons/24/help']())+'</div> <div class="campaign-details__clicks-dropdown-content -hidden"> <ul> <li> <div>'+(I18n.t("promoted_coubs.details.web"))+'</div> <div>'+(details.webClicks)+'</div> </li> <li> <div>'+(I18n.t("promoted_coubs.details.ios"))+'</div> <div>'+(details.iosClicks)+'</div> </li> <li> <div>'+(I18n.t("promoted_coubs.details.android"))+'</div> <div>'+(details.androidClicks)+'</div> </li> </ul> </div> </div> <div>'+(details.totalClicks)+'</div> </li> <li> <div>'+(I18n.t("promoted_coubs.values.cpc"))+'</div> <div>'+(details.costPerClick)+'</div> </li> <li> <div>'+(I18n.t("promoted_coubs.values.spend"))+'</div> <div>'+(details.spendNow)+'</div> </li> <li> <div>'+(I18n.t("promoted_coubs.values.budget"))+'</div> <div>'+(details.budget)+'</div> </li> </ul> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/promoted_coubs/promoted_coub_form"] = function anonymous(it) {
  var out=''; var isEditMode = !!it, startDate = isEditMode ? new Date(it.started_at) : new Date(), inputsClass = isEditMode ? 'disabled' : '', title = isEditMode ? I18n.t('promoted_coubs.form.edit') : I18n.t('promoted_coubs.form.promote'), submitText = isEditMode ? I18n.t('promoted_coubs.form.update') : I18n.t('promoted_coubs.form.pay_and_launch'); formMethod = isEditMode ? 'PUT' : 'POST', formUrl = isEditMode ? Routes.api_v2_promoted_coub_path(it.id) : Routes.api_v2_promoted_coubs_path();out+='<form action="'+(formUrl)+'" method="'+(formMethod)+'" class="promoted-coub__form"> <input type="hidden" name="is_active" value="true"/> <h2>'+(title)+'</h2> <div class="promoted-coub__form-content"> <div class="promoted-coub__form-inner"> <div class="promoted-coub__form__coub-input-container"> <h3>'+(I18n.t('promoted_coubs.form.select_coub'))+'</h3> <input class="input-field -sq" name="coub_id" placeholder="http://" autocomplete="off" /> <div class="promoted-coub__tip">'+(I18n.t('promoted_coubs.form.coub_tip'))+'</div> </div> <div class="promoted-coub__form__coub-container -hidden"> <button class="sb -st -sq -hidden" type="button">'+(I18n.t('promoted_coubs.buttons.replace_coub'))+'</button> </div> </div> <div class="promoted-coub__form-inner"> <h3>'+(I18n.t('promoted_coubs.form.views'))+'</h3> <input class="input-field -sq '+(inputsClass)+'" name="target_views" value="3000" autocomplete="off" /> <div class="promoted-coub__tip">'+(I18n.t('promoted_coubs.form.views_tip'))+'</div> <h3>'+(I18n.t('promoted_coubs.form.locations'))+'</h3> <div class="promoted-coub__form__countries-selector '+(inputsClass)+'"> <div class="placeholder">'+(I18n.t('promoted_coubs.all_countries'))+'</div> <input /> </div> <div class="promoted-coub__form__platforms"> <h3>'+(I18n.t('promoted_coubs.form.platforms'))+'</h3> <div class="promoted-coub__form__platform-selectors -no-select"> <div class="promoted-coub__form__platform-selector"> <input type="checkbox" name="platforms[]" value="web" id="promoted-coub-platform-web-input" class="-hidden" checked /> <label for="promoted-coub-platform-web-input">'+(I18n.t('promoted_coubs.platforms.web'))+'</label> </div> <div class="promoted-coub__form__platform-selector"> <input type="checkbox" name="platforms[]" value="ios" id="promoted-coub-platform-ios-input" class="-hidden" checked /> <label for="promoted-coub-platform-ios-input">'+(I18n.t('promoted_coubs.platforms.ios'))+'</label> </div> <div class="promoted-coub__form__platform-selector"> <input type="checkbox" name="platforms[]" value="android" id="promoted-coub-platform-android-input" class="-hidden" checked /> <label for="promoted-coub-platform-android-input">'+(I18n.t('promoted_coubs.platforms.android'))+'</label> </div> </div> <input class="input-field -sq" name="web_link" placeholder="'+(I18n.t('promoted_coubs.form.web_link'))+'" autocomplete="off" /> <input class="input-field -sq" name="ios_link" placeholder="'+(I18n.t('promoted_coubs.form.ios_link'))+'" autocomplete="off" /> <input class="input-field -sq" name="android_link" placeholder="'+(I18n.t('promoted_coubs.form.android_link'))+'" autocomplete="off" /> </div> <h3>'+(I18n.t('promoted_coubs.form.starts'))+'</h3> <div class="date-select '+(inputsClass)+'"> '; startDate.setMinutes(Math.floor(startDate.getMinutes() / 5 + 1) * 5); var dates = moment(startDate).format('DD MMMM HH mm').split(' '), isoDate = moment(startDate).toISOString(), vals = _.object(['day', 'month', 'hour', 'minute'], dates); out+=' <input class="date-select__input" data-default-date="'+(isoDate)+'" value="'+(isoDate)+'" type="hidden" name="started_at" /> <div> ';var arr1=['day', 'month'];if(arr1){var value,i1=-1,l1=arr1.length-1;while(i1<l1){value=arr1[i1+=1];out+=' '+( JST["app/site/templates/widgets/date_select/date_dropdown"]({type: value, value: vals[value], cls: "strict-above"}) )+' ';} } out+=' '+( JST["app/site/templates/widgets/date_select/time_input"](vals) )+' </div> </div> <div class="promoted-coub__tip">'+(I18n.t('promoted_coubs.form.starts_tip'))+'</div> <div class="promoted-coub__form-total"> <div>'+(I18n.t('promoted_coubs.form.total_budget'))+'</div> <div> <span class="budget hbold">-</span> <span>₽</span> </div> </div> ';if(GlobalState.USER.isAdmin()){out+=' <div class="promoted-coub__form__label"> <h3>Label</h3> <input class="input-field -sq" name="label" value="'+((it && it.label) || "")+'" /> </div> ';}out+=' </div> </div> <button class="sb -blue -rn submit disabled" type="submit">'+(submitText)+'</button></form>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/promoted_coubs/promoted_coub_name_inputs"] = function anonymous(it) {
  var out=''; var first = it.first || "", last = it.last || "", buttonDisabledClass = first && last ? "": "disabled";out+='<form class="promoted-coub__name-form -hidden"> <div class="promoted-coub__name-form__back back">'+(I18n.t('promoted_coubs.buttons.back'))+'</div> <h2>'+(I18n.t('promoted_coubs.form.enter_name'))+'</h2> <input class="input-field -sq" name="first" value="'+(first)+'" autocomplete="given-name" placeholder="'+(I18n.t('promoted_coubs.form.first_name'))+'"> <input class="input-field -sq" name="last" value="'+(last)+'" autocomplete="family-name" placeholder="'+(I18n.t('promoted_coubs.form.last_name'))+'"> <button type="submit" class="sb -blue -rn promoted-coub__name-form__next '+(buttonDisabledClass)+'">'+(I18n.t('promoted_coubs.buttons.next'))+'</button></form>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/promoted_coubs/promoted_coub_table_item"] = function anonymous(it) {
  var out=''; var details = helpers.PromotedCoubsHelper.calcDetails(it), statusText = I18n.t('promoted_coubs.statuses.' + it.status), isStatusShowed = false, isEditShowed = true, isPayShowed = false; switch (it.status) { case 'created': isStatusShowed = true; isPayShowed = true; break; case 'paid': case 'waiting_for_review': isStatusShowed = true; break; case 'finished': isEditShowed = false; isStatusShowed = true; break; case 'rejected': isStatusShowed = true; break; case 'approved': default: break; }out+='<tr data-id="'+(it.id)+'"> <td class="promoted-coubs__coub-title '+(it.coub ? "-truncate-text" : "")+'"> ';if(it.coub){out+=' <a class="-fill promoted-coubs__table-item" href="'+( Routes.promoted_coub_path(it.id) )+'"></a> <img src="'+(it.coub.explore_suggest)+'" /> <span>'+(it.coub.title)+'</span> ';}else if(it.status === "finished"){out+=' '+(I18n.t('promoted_coubs.deleted_coub'))+' ';}else{out+=' <a class="promoted-coubs__coub-title__replace promoted-coubs__table-item" href="'+(Routes.edit_promoted_coub_path(it.id))+'"> '+(I18n.t('promoted_coubs.deleted_coub_replace'))+'</span> </a> ';}out+=' </td> ';if(isStatusShowed){out+=' <td colspan="9" class="hbold -status -'+(it.status)+' -centered-text"> <a class="-fill promoted-coubs__table-item" href="'+( Routes.promoted_coub_path(it.id) )+'"></a> <div class="promoted-coubs__additional-links"> ';if(isEditShowed){out+=' <a href="'+(Routes.edit_promoted_coub_path(it.id))+'" class="promoted-coubs__edit hnormal">'+(I18n.t('promoted_coubs.buttons.edit'))+'</a> ';}out+=' ';if(isPayShowed){out+=' <div class="promoted-coubs__pay hnormal">'+(I18n.t('promoted_coubs.buttons.pay'))+'</div> ';}out+=' </div> '+(statusText)+' </td> ';}else{out+=' ';var arr1=['totalViews', 'paidViewsNow', 'costPerView', 'engagement', 'costPerEngagement', 'totalClicks', 'costPerClick', 'budget', 'spendNow'];if(arr1){var key,i1=-1,l1=arr1.length-1;while(i1<l1){key=arr1[i1+=1];out+=' <td class="-right-text"> <a class="-fill promoted-coubs__table-item" href="'+( Routes.promoted_coub_path(it.id) )+'"></a> <span class="-nowrap">'+(details[key])+'</span> </td> ';} } out+=' ';}out+='</tr>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/promoted_coubs/promoted_coubs_stub"] = function anonymous(it) {
  var out=''; out+='<div class="promoted-coubs__stub"> <h2>'+(I18n.t('promoted_coubs.stub.title'))+'</h2> <a class="promoted-coubs__new-campaign hbold" href="'+(Routes.new_promoted_coub_path())+'">'+(I18n.t('promoted_coubs.stub.title'))+'</a></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/registration/pages/email_page"] = function anonymous(it) {
  var out=''; out+='<form class="dialog__page -w475" page-id="emailPage" widget-authpopup-handlers-emailform> <h2>'+( I18n.t("registration_email_page.title") )+'</h2> <div class="input-field-group"> <input type="text" id="email" name="email" data-transliteration-type="changeable" placeholder="Email"> </div> <div class="-error-text -hidden"></div> '+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: '-push-shd -blue -flat -sq -sb-gamma -w100p', attrs: 'submit', value: "Let's go!", type: 'button' }) )+'</form>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/registration/pages/follow_channels_page"] = function anonymous(it) {
  var out='<div class="dialog__page" page-id="follow-channels-page" data-number-to-follow="3" data-following="0" data-no-back="true" '+(it.startPage)+'> <div class="-padding-push"> <div class="grid-container follow-channels__head"> <div class="grid-col -col-one-half"> <h1> '+( I18n.t("auth_popup.channels_registration.whotofollow-title") )+' </h1> <p> '+( I18n.t("auth_popup.channels_registration.whotofollow-description") )+' </p> </div> <div class="grid-col -col-one-half follow-channels__submit"> <p class="box--inline"> '+( I18n.t("auth_popup.channels_registration.whotofollow-step-3") )+' </p> <button class="sb -push-shd -grey -rn submit disabled" disabled type=\'button\'> <span></span> '+( I18n.t('auth_popup.buttons.done') )+' </button> </div> </div> </div> <div class="-padding-push"> <div class="niceScroller" data-scroll-type="vertical"> <div class="channels-list"> <div class="grid-container gutter-gamma follow-channels__body"></div> </div> </div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/registration/pages/pass_recover_page"] = function anonymous(it) {
  var out='<div class="dialog__page" page-id="pass-recover-page" '+(it.startPage)+'> <h1>'+(I18n.t('auth_popup.signin.reset.password_recovery'))+'</h1> <form action="/"> <input type="password" id="password" name="password" placeholder="Enter your new password" class="input-field -sq"> <label class="pass-checker hbold -hidden"> <span>Weak</span> </label> <div class="-error-text -hidden"></div> '+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: '-push-shd -rn -blue -sb-beta', value: I18n.t('auth_popup.buttons.done'), type: 'submit' }) )+' </form></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/registration/pages/reset_pass_page"] = function anonymous(it) {
  var out='<div class="dialog__page" page-id="reset-pass-page" '+(it.startPage)+'> <h1>'+(I18n.t('auth_popup.signin.reset.reset_password'))+'</h1> <form action="'+( Routes.reset_password_path() )+'" method="POST"> <input type="email" name="email" placeholder="Enter your email" class="input-field -sq"> <div class="-error-text -hidden"></div> '+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: '-push-shd -rn -blue -sb-beta', value: I18n.t('auth_popup.signin.reset.reset_password_button'), type: 'submit' }) )+' </form> <div class="reset-pass__notify box-beta"> '+(I18n.t('auth_popup.signin.reset.sent_instructions'))+' </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/registration/pages/sign_in_page"] = function anonymous(it) {
  var out='<div class="dialog__page -w475" page-id="sign-in-page" '+(it.startPage)+'> <div class="registration-form"> <h1>'+( I18n.t('auth_popup.signin.popup.login') )+'</h1> '+( JST['app/site/templates/registration/shared/social_buttons']({ key: 'signin' }) )+' <form action="'+( Routes.signin_path() )+'" mehtod="POST" class="login-pass"> <div class="input-field-group"> <input type="email" name="email" placeholder="Email"> <input type="password" name="password" placeholder="Password"> </div> <div class="registration-form__captcha"></div> <div class="-error-text -hidden"></div> <div class="sb-group"> '+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: '-string login-pass__reset', attrs: 'reset-pass-button', value: I18n.t('auth_popup.signin.reset.forgot_password'), type: 'button' }) )+' '+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: '-push-shd -sq -blue -sb-gamma login-pass__submit', attrs: '', value: I18n.t('auth_popup.buttons.sign_in'), type: 'submit' }) )+' </div> </form> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/registration/pages/sign_up_page"] = function anonymous(it) {
  var out='<div class="dialog__page -w475" page-id="sign-up-page" '+(it.startPage)+'> '+( JST['app/site/templates/widgets/registration_form/registration_form']() )+'</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/registration/pages/username_page"] = function anonymous(it) {
  var out='<form class="dialog__page -w475" page-id="usernamePage" widget-authpopup-handlers-usernameform> <h2>'+( I18n.t("registration_email_page.title") )+'</h2> <div class="input-field-group"> <input type="text" name="name" data-transliteration-type="changeable" placeholder="Username"> </div> <div class="-error-text -hidden"></div> '+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: '-push-shd -blue -flat -sq -sb-gamma -w100p', attrs: 'submit', value: "Let's go!", type: 'button' }) )+'</form>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/registration/shared/social_buttons"] = function anonymous(it) {
  var out='<div class="registration__soc-buttons toggler__container -less"> ';var arr1=helpers.Channel.authOrder();if(arr1){var provider,index=-1,l1=arr1.length-1;while(index<l1){provider=arr1[index+=1];out+=' '; var providerKey = provider === "firebase" ? "phone" : provider; out+=' '+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: "-trans -sq -sb-gamma -social " + providerKey, attrs: "data-auth-button=" + provider, value: I18n.t("auth_popup." + it.key + ".login_with_" + providerKey) }) )+' ';} } out+='</div><div class="toggler__handler -less"> '+( JST['app/site/templates/widgets/buttons/simple_button'] ({ classes: "-sb -rn -trans -no-hover", attrs: "", value: AuthPopupI18n.VIEW_SOCIALS.MORE }) )+'</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/shared/channel_select"] = function anonymous(it) {
  var out='';  var channels   = it.channels ? it.channels : helpers.Channel.presentChannels(), canEdit    = helpers.Channel.hasId(it.channel.id), currentId  = Params.get('current_channel_id'), isAdmin    = Params.getBranchValue("current_user.is_admin"), inputName  = it.inputName ? it.inputName : "coub[channel_id]", disabled   = (isAdmin && !canEdit || it.type == 'Coub::Recoub') ? 'disabled' : ''; var list = channels.map(function(channel) { return '<li class="list__item list__item-gamma" data-val="'+(channel.id)+'"><img class="image -rounded" '+(helpers.Application.specificImgVersion(channel, 'avatar_versions', 'small'))+' width="40" height="40">'+(channel.title)+'<span class="checkAction"></span></li>'; }); var channelIdInput = '<input id="coub_simple_channel_id" name="'+(inputName)+'" type="hidden" value="'+(it.channel.id)+'">', handler = '<button class="sb -st -sq -sb-beta -grey -toggle channel--select '+(disabled)+'" type="button"><span>'+(it.channel.title)+'</span><img '+(helpers.Application.specificImgVersion(it.channel, 'avatar_versions', 'small'))+' width="38" height="38" alt=""></button>', content = ''+(channelIdInput)+'<div class="list-wrap niceScroller" data-scroll-type="vertical"><ul class="list list--selectable">'+(list.join(''))+'</ul></div>';if(channels.length > 1){out+=' '+( JST["app/site/templates/widgets/dropdown_with_handler/dropdown_with_handler"] ({ dClass: "dropdown--select strict-below channel--select", hClass: "", handler: handler, content: content, attrs: "img-replace" }) );}else{out+=' '+( channelIdInput )+' '+( handler );}return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/shared/visibility_select"] = function anonymous(it) {
  var out=''; var visibility = it.original_visibility_type, vTypes = Params.get('coub_visibility_types'); if (!it.published) { vTypes = vTypes.concat(['draft']); visibility = 'draft'; } var list = vTypes.map(function(v) { return '<li class="list__item list__item-beta '+(v)+'" data-val="'+(v)+'">'+(helpers.Application.capitalize(v))+'</li>'; }); var handler = '<button class="sb -st -sq -sb-dialog -toggle" type="button"><span>'+(helpers.Application.capitalize(visibility))+'</span></button>', input = '<input name="coub[original_visibility_type]" type="hidden" value="'+(visibility)+'" />', content = ''+(input)+'<ul class="list list--selectable">'+(list.join(''))+'</ul>';out+=''+( JST["app/site/templates/widgets/dropdown_with_handler/dropdown_with_handler"] ({ dClass: "dropdown--select dropdown--visibility strict-above", hClass: visibility, handler: handler, content: content }));return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/sign_popup/no_channels"] = function anonymous(it) {
  var out='<h1 class="-centered-box"> '+(I18n.t('auth_popup.channels_registration.whotofollow-no-channels'))+'</h1>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/sign_popup/who_to_follow_search"] = function anonymous(it) {
  var out='<div class="follow-channels__search"> <input type="text" class="input-field -rn" placeholder="Find channels" autocomplete="off"/></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/site_editor/channels_queue/item"] = function anonymous(it) {
  var out='<li data-recoub-id="'+(it.coub.id)+'" data-permalink="'+(it.coub.permalink)+'" class="recoubs-queue__item -bg-color--white m-bottom-10"> <a href="'+(Routes.view_coub_by_permalink_path({'id': it.coub.permalink}))+'" target="_blank" class="box--vertical"> <img src="'+(it.coub.small_picture)+'" width="100px" height="auto"> </a> <div class="recoubs__queue__item-desc box--vertical large m-left-10 w-55"> <a class="-color--blue-ribbon box--vertical" href="'+(Routes.view_coub_by_permalink_path({'id': it.coub.permalink}))+'" target="_blank"> '+(it.coub.title)+' </a> - by <a class="-color--blue-ribbon box--vertical" href="'+(Routes.channel_path(it.coub.channel.permalink))+'" target="_blank"> '+(it.coub.channel.title)+' </a> - at <strong>'+(moment(it.created_at).format('MMMM Do YYYY'))+'</strong> ';if(it.params.will_be_published){out+=' <p> Will be published approximately at '+(it.params.will_be_published)+' </p> ';}out+=' ';if(it.params.position){out+=' <p>Position: '+(it.params.position)+'</p> ';}out+=' </div> <div class=\'recoubs__queue__item-buttons box--vertical large\'> ';if(it.params.publish_now){out+=' <button type="button" class="sb -st -sq -grey box--vertical" publish-now>Publish now</button> ';}out+=' <button type="button" class="sb -st -sq -grey box--vertical" put-on-top>Put on top</button> <button type="button" class="sb -st -rn -grey -select em-toggler box--vertical" show-editorial></button> </div></li>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/site_editor/weekly_digest/channel_item"] = function anonymous(it) {
  var out=''; var avatar = helpers.Application.specificImgVersion(it.item, 'avatar_versions', 'profile_pic_new');out+='<div class="object-media wkly-digest__item box--banner m-bottom-15 p-10" entity-id="'+(it.item.id)+'" entity-type="Channel" weekly-digest-data-item> <h2 class="wkly-digest__item__position">#'+(it.position)+'</h2> <div class="object-media__img"> <a href="/'+(it.item.permalink)+'" class="-ribbon"><img '+(avatar)+' width="100" class="image"/></a> </div> <div class="object-media__body"> <h5 class="m-bottom-5"><a href="/'+(it.item.permalink)+'">'+(it.item.title)+'</a></h5> <button class="sb -st -sq -grey" weekly-digest-remove-item-control> Remove </button> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/site_editor/weekly_digest/coub_item"] = function anonymous(it) {
  var out='<div class="object-media wkly-digest__item box--banner m-bottom-15 p-10" entity-id="'+(it.item.id)+'" entity-type="Coub" weekly-digest-data-item> <h2 class="wkly-digest__item__position">#'+(it.position)+'</h2> <div class="object-media__img"> <a href="'+(Routes.view_coub_by_permalink_path(it.item.permalink))+'" target="_blank"><img src="'+(it.item.picture)+'" width="100" class="image -rounded"/></a> </div> <div class="object-media__body"> <h5 class="m-bottom-5"><a href="'+(Routes.view_coub_by_permalink_path(it.item.permalink))+'" target="_blank">'+(it.item.title)+'</a></h5> <div class="small m-bottom-10"> <a href="'+(Routes.channel_path(it.item.channel.permalink))+'" target="_blank">'+(it.item.channel.title)+'</a>, likes: <span>'+(it.item.likes_count)+'</span> </div> <button class="sb -st -sq -grey" weekly-digest-remove-item-control> Remove </button> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/story/story_card"] = function anonymous(it) {
  var out='';  var story_url = "/stories/" + it.permalink,  previewParams = helpers.StoryHelper.getPreviewParams(it);out+='<div class="story-card -ribbon" widget-story-card auto-init ';if(previewParams.thumbnailRatio){out+='data-thumbnail-ratio="'+(previewParams.thumbnailRatio)+'"';}out+='> <div class="story-card__preview -fill"> ';if(it.thumbnail_coub){out+=' <video src="'+(previewParams.videoUrl)+'" poster="'+(previewParams.thumbnailUrl)+'" loop preload="none" class="story-card__video" data-size="'+(previewParams.videoSize)+'"></video> <img src="'+(previewParams.thumbnailUrl)+'" class="story-card__img" /> ';}out+=' </div> <div class="story-card__gradient"></div> <div class="story-card__description -top"> '+(helpers.StoryHelper.getStampTop(it))+' </div> <div class="story-card__description -bottom"> ';if(it.is_repost){out+=' <div class="story-card__recoub"> '+(JST["app/site/templates/svg/icons/24/repost"]())+' by <span class="hbold">'+( it.post_channel.title)+'</span> </div> ';}out+=' <h2 class="hbold">'+(it.title)+'</h2> <div>'+(helpers.StoryHelper.getStampBottom(it))+'</div> </div> <a href='+(story_url)+' class="-fill"></a></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/story/story_card_small"] = function anonymous(it) {
  var out='';  var storyUrl = "/stories/" + it.permalink, previewParams = helpers.StoryHelper.getPreviewParams(it);out+='<div class="story-card -small" widget-story-card auto-init ';if(previewParams.thumbnailRatio){out+='data-thumbnail-ratio="'+(previewParams.thumbnailRatio)+'"';}out+='> <a href='+(storyUrl)+' class="story-card__preview -ribbon"> ';if(it.thumbnail_coub){out+=' <video src="'+(previewParams.videoUrl)+'" poster="'+(previewParams.thumbnailUrl)+'" loop preload="none" class="story-card__video" data-size="'+(previewParams.videoSize)+'"></video> <img src="'+(previewParams.thumbnailUrl)+'" class="story-card__img" /> ';}out+=' </a> <a href='+(storyUrl)+' class="story-card__description"> <h2 class="hbold"> ';if(it.is_repost){out+=''+(JST["app/site/templates/svg/icons/16/repost"]());}out+=' '+(it.title)+' </h2> <div>'+(helpers.StoryHelper.getStampSmall(it))+'</div> </a></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/suggestions/promo_suggest"] = function anonymous(it) {
  var out=''; out+='<li class="suggest__item -ribbon"> <a href="'+(it.url)+'" class="-fill" target="_blank"> <a href="'+(it.url)+'" target="_blank"> <img class="image img-placeholder" src="'+(it.thumb)+'" width="226" height="172" /> </a> <div class="suggest__item-stamp"> <a href="'+(it.url)+'" data-permalink="'+(it.permalink)+'" title="'+(utils.encodeQuotes(it.title))+'" class="hbold"> '+(it.title)+' </a> <div class="suggest__desc">'+(I18n.t("banners.announcement.promoted"))+'</div> </div></li>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/suggestions/suggest"] = function anonymous(it) {
  var out='';  var aspectRatio = (it.image_height / it.image_width * 100).toFixed(2), imageBoxStyle = 'padding-top:' + aspectRatio + '%', coubUrl = window.Routes ? Routes.view_coub_by_permalink_path(it.permalink) : ('/view/' + it.permalink), viewsCount = ''; viewsCount += window.numeral ? numeral(it.views_count).format("0,0") : it.views_count; viewsCount += ' '; viewsCount += window.I18n ? I18n.t("coub.views_count", {count: it.views_count}) : 'views';out+='<div class="suggest__item" data-permalink="'+(it.permalink)+'"> <div class="suggest__item__image-box"> <div class="suggest__item__image-box__inner" style="'+(imageBoxStyle)+'"> <img class="img-placeholder -fill" src="'+(it.image_url)+'" alt="'+(it.title)+'" /> ';if(!GlobalState.PLATFORM.isMobile()){out+=' <video class="-fill" src="'+(it.video_url)+'" poster="'+(it.image_url)+'" loop preload="none" /> ';}out+=' </div> </div> <div class="suggest__item-stamp"> <div class="hbold -crop">'+(it.title)+'</div> ';if(it.views_count > 0){out+=' <div class="suggest__desc">'+(viewsCount)+'</div> ';}out+=' </div> <a href="'+(coubUrl)+'" data-permalink="'+(it.permalink)+'" type="coubSuggest" class="-fill"></a></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/classic_like"] = function anonymous(it) {
  var out='<svg width="11" height="18" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.034 2.081c-.317 0-.624.32-.764.796l-.654 2.606c-.147.494-.398.896-.562 1.381l-.078.232c-.073.036-.11-.044-.127-.131 0 0-.123-1.287-.927-1.332l-.034-.001c-.465 0-.668.437-.827.922-.007.022-.053.047-.074.046-.068-.003-.082-.06-.086-.094-.068-.587-.437-1.073-.938-1.073H4.93c-.51.022-.95.531-.98 1.135l-.003.07-.217-.501c-.201-.465-.565-1.23-.71-1.718L2.286 1.68c-.132-.444-.44-.743-.766-.743a.545.545 0 00-.275.075C.87 1.231.69 1.858.837 2.441l.622 2.816c.126.501.429 1.285.576 1.784l.38 1.283c-.065.055-.386.567-.647 1.138-.184.403-.411.69-.173 1.5.08.278.186.577.401 1.08.5 1.174 1.2 1.067 1.605 2.764 0 0-.092 2.5-.061 2.879h4.802c0 1.081.14-1.192.016-1.812-.09-.455-.016-1.103-.016-1.103.177-.493.68-2.356.767-2.877.15-.909.615-3.629.615-3.629.12-.507.294-1.337.39-1.848l.538-2.925c.11-.593-.073-1.19-.414-1.361a.456.456 0 00-.204-.049z" fill="#000"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/16/close"] = function anonymous(it) {
  var out='<svg width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.229 10.828a.667.667 0 10.943.943L8 8.943l2.828 2.828a.667.667 0 10.943-.943L8.943 8l2.828-2.828a.667.667 0 00-.943-.943L8 7.057 5.172 4.23a.667.667 0 10-.943.943L7.057 8 4.23 10.828z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/16/cotd"] = function anonymous(it) {
  var out='<svg width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M9.106 3.315a1.35 1.35 0 00-2.211 0L5.37 5.492l-1.187-.924c-1.037-.808-2.5.193-2.123 1.452l.954 3.185a2.75 2.75 0 002.635 1.96h4.703a2.75 2.75 0 002.635-1.96l.954-3.185c.377-1.26-1.086-2.26-2.123-1.452l-1.187.924-1.525-2.177zM6.508 6.482L8 4.35l1.493 2.132a1.35 1.35 0 001.935.29l.94-.732-.818 2.734a1.25 1.25 0 01-1.198.892H5.65a1.25 1.25 0 01-1.198-.892L3.632 6.04l.94.733a1.35 1.35 0 001.936-.291zM4.588 13.5a.75.75 0 010-1.5h6.822a.75.75 0 010 1.5H4.59z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/16/down"] = function anonymous(it) {
  var out='<svg width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M3.268 5.278a.75.75 0 011.06.02L8 9.101l3.67-3.805a.75.75 0 111.08 1.042l-4.21 4.363a.75.75 0 01-1.08 0L3.25 6.34a.75.75 0 01.018-1.06z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/16/emoji"] = function anonymous(it) {
  var out='<svg width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 1.25a6.75 6.75 0 100 13.5 6.75 6.75 0 000-13.5zM2.75 8a5.25 5.25 0 1110.5 0 5.25 5.25 0 01-10.5 0zm4.583-1.667a1 1 0 11-2 0 1 1 0 012 0zm3.334 0a1 1 0 11-2 0 1 1 0 012 0zm.468 2.415a.75.75 0 01.117 1.054c-.614.768-1.26 1.188-1.866 1.404-.59.21-1.096.21-1.375.21H7.99c-.28 0-.786 0-1.375-.21-.606-.216-1.252-.636-1.867-1.404a.75.75 0 011.17-.938c.453.566.874.813 1.201.93.336.12.624.123.881.123s.545-.003.881-.123c.328-.117.748-.364 1.2-.93a.75.75 0 011.054-.116z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/16/featured"] = function anonymous(it) {
  var out='<svg width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.612 3.39c.509-1.243 2.267-1.243 2.776 0l.287.7a2 2 0 001.657 1.233l.838.082c1.29.125 1.824 1.716.872 2.595l-.755.697a2 2 0 00-.598 1.888l.204.953c.278 1.296-1.137 2.289-2.26 1.587l-.574-.358a2 2 0 00-2.118 0l-.573.358c-1.124.702-2.539-.291-2.261-1.587l.204-.953a2 2 0 00-.598-1.888L2.958 8c-.952-.88-.417-2.47.872-2.595l.838-.082A2 2 0 006.325 4.09l.287-.7z" stroke="#fff" stroke-width="1.5"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/16/lock"] = function anonymous(it) {
  var out='<svg width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.195 5.302a3.802 3.802 0 117.605 0v1.145a2.75 2.75 0 011.696 2.54v2.768a2.75 2.75 0 01-2.75 2.75H5.249a2.75 2.75 0 01-2.75-2.75V8.987c0-1.145.7-2.127 1.696-2.54V5.301zm6.56 2.435H5.24A1.25 1.25 0 004 8.987v2.768c0 .69.559 1.25 1.25 1.25h5.496c.69 0 1.25-.56 1.25-1.25V8.987a1.25 1.25 0 00-1.24-1.25zM10.3 5.302v.935H5.695v-.935a2.302 2.302 0 114.605 0zm-2.302 6.423c.749 0 1.356-.606 1.356-1.354 0-.747-.607-1.353-1.356-1.353-.75 0-1.357.606-1.357 1.353 0 .748.607 1.354 1.357 1.354z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/16/members"] = function anonymous(it) {
  var out='<svg width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5.643 2.3a2.777 2.777 0 100 5.555 2.777 2.777 0 000-5.555zM4.366 5.077a1.277 1.277 0 112.554 0 1.277 1.277 0 01-2.554 0zm1.266 2.967c-1.372 0-2.506.237-3.374.75-.892.527-1.447 1.312-1.692 2.274-.137.537-.077 1.192.35 1.721.435.538 1.136.81 2.004.81H8.343c.821 0 1.512-.207 1.96-.68a.761.761 0 00.07.004h3.091c.677 0 1.29-.155 1.685-.582.427-.463.422-1.043.277-1.472-.494-1.466-1.96-2.15-4.048-2.15-.805 0-1.51.092-2.103.29a4.073 4.073 0 00-.299-.198c-.864-.517-1.985-.767-3.344-.767zm4.754 2.241c.126.239.227.492.305.757.035.12.062.248.078.38H13.464c.314 0 .471-.047.54-.077-.189-.553-.796-1.125-2.626-1.125-.379 0-.708.023-.992.065zM2.02 11.438c.152-.596.47-1.04 1.001-1.353.554-.327 1.392-.541 2.611-.541 1.19 0 2.017.221 2.574.555.54.322.873.778 1.045 1.364.069.237.02.356-.02.406-.042.053-.235.23-.887.23H2.92c-.568 0-.772-.17-.837-.252-.073-.09-.109-.233-.064-.41zM8.947 6.09a2.44 2.44 0 114.879 0 2.44 2.44 0 01-4.879 0zm2.44-.94a.94.94 0 100 1.88.94.94 0 000-1.88z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/16/repost"] = function anonymous(it) {
  var out='<svg width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8.202 4.084a8.573 8.573 0 012.22.255c.38.096.78.388 1.093.827.312.437.485.947.485 1.384v1.78l-1.002-.89a.75.75 0 00-.996 1.12l2.25 2a.75.75 0 00.996 0l2.25-2a.75.75 0 00-.996-1.12l-1.002.89V6.55c0-.8-.303-1.608-.764-2.255-.46-.646-1.134-1.204-1.944-1.41-.41-.104-1.306-.31-2.596-.301-.643-.004-1.415.07-2.008.141a30.323 30.323 0 00-.975.134l-.061.01-.016.002H5.13l.12.741-.12-.74a.75.75 0 00.24 1.48h.005l.013-.003.055-.008a23.272 23.272 0 01.924-.127c.58-.07 1.279-.134 1.824-.13h.01zm.096 7.5a8.571 8.571 0 01-2.22-.256c-.38-.097-.78-.388-1.093-.827-.312-.438-.485-.947-.485-1.384V7.67l1.002.89a.75.75 0 00.996-1.12l-2.25-2a.75.75 0 00-.996 0l-2.25 2a.75.75 0 00.996 1.12L3 7.67v1.447c0 .8.303 1.608.764 2.255.46.645 1.134 1.204 1.944 1.41.41.104 1.306.31 2.596.301.643.004 1.415-.07 2.008-.141a30.5 30.5 0 00.975-.134l.061-.01.016-.002h.006v-.001l-.12-.74.12.74a.75.75 0 00-.24-1.48h-.004l-.014.002-.055.009-.208.031c-.179.026-.43.061-.716.095-.58.07-1.279.135-1.824.131h-.01z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/16/sound-half"] = function anonymous(it) {
  var out='<svg width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M9.167 4.414c0-1.559-1.885-2.34-2.988-1.237l-2 2a.25.25 0 01-.177.073H2.75A1.75 1.75 0 001 7v2c0 .967.784 1.75 1.75 1.75h1.252a.25.25 0 01.177.073l2 2c1.103 1.103 2.988.322 2.988-1.237V4.414zM7.24 4.238a.25.25 0 01.427.176v7.172a.25.25 0 01-.427.177l-2-2a1.75 1.75 0 00-1.238-.513H2.75A.25.25 0 012.5 9V7a.25.25 0 01.25-.25h1.252c.465 0 .91-.184 1.238-.513l2-2zm4.354.467a.75.75 0 00-1.022 1.098c.6.559.967 1.338.967 2.197 0 .86-.367 1.639-.967 2.197a.75.75 0 001.023 1.098A4.492 4.492 0 0013.038 8c0-1.3-.558-2.47-1.444-3.295z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/16/sound-off"] = function anonymous(it) {
  var out='<svg width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0)"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.43 3.177c1.102-1.103 2.987-.322 2.987 1.237v7.172c0 1.559-1.885 2.34-2.988 1.237l-2-2a.25.25 0 00-.177-.073H3A1.75 1.75 0 011.25 9V7c0-.966.784-1.75 1.75-1.75h1.252a.25.25 0 00.177-.073l2-2zm1.487 1.237a.25.25 0 00-.427-.176l-2 2a1.75 1.75 0 01-1.238.512H3a.25.25 0 00-.25.25v2c0 .138.112.25.25.25h1.252c.465 0 .91.184 1.238.513l2 2a.25.25 0 00.427-.177V4.414zm6.945 5.943a.667.667 0 00.943-.943L14.39 8l1.414-1.414a.667.667 0 10-.943-.943l-1.414 1.414-1.415-1.414a.667.667 0 10-.942.943L12.505 8 11.09 9.414a.667.667 0 00.943.943l1.414-1.414 1.414 1.414z" fill="#999"/></g><defs><clipPath id="clip0"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/16/splices"] = function anonymous(it) {
  var out='<svg width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M.583 5.333a2.75 2.75 0 015.5 0v5.334a2.75 2.75 0 11-5.5 0V5.333zm2.75-1.25c-.69 0-1.25.56-1.25 1.25v5.334a1.25 1.25 0 102.5 0V5.333c0-.69-.56-1.25-1.25-1.25zm6.584 1.25a2.75 2.75 0 115.5 0v5.334a2.75 2.75 0 11-5.5 0V5.333zm2.75-1.25c-.69 0-1.25.56-1.25 1.25v5.334a1.25 1.25 0 002.5 0V5.333c0-.69-.56-1.25-1.25-1.25zM8.083 2.667a.75.75 0 00-.75.75v9.166a.75.75 0 001.5 0V3.417a.75.75 0 00-.75-.75z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/16/unlock"] = function anonymous(it) {
  var out='<svg width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.046 6.319a3.802 3.802 0 016.587-3.803l.842 1.46a.75.75 0 01-1.3.75l-.841-1.46A2.302 2.302 0 105.346 5.57l.379.656.006.012h5.015a2.75 2.75 0 012.75 2.75v2.768a2.75 2.75 0 01-2.75 2.75H5.249a2.75 2.75 0 01-2.75-2.75V8.987a2.75 2.75 0 011.636-2.515l-.088-.153zM5.25 7.737c-.69 0-1.25.56-1.25 1.25v2.768c0 .69.56 1.25 1.25 1.25h5.497c.69 0 1.25-.56 1.25-1.25V8.987c0-.69-.56-1.25-1.25-1.25H5.249zm2.749 3.988c.749 0 1.356-.606 1.356-1.354 0-.747-.607-1.353-1.356-1.353-.75 0-1.357.606-1.357 1.353 0 .748.607 1.354 1.357 1.354z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/add-category"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8.801 7.309a6.032 6.032 0 00-1.267 0c-.648.062-1.399.207-2.094.457-.671.243-1.41.626-1.901 1.238-.257.32-.453.711-.517 1.17-.063.45.01.903.19 1.34.11.298.335.614.519.858.226.3.521.655.857 1.04.21.239.44.494.683.76l-1.468 4.212-.661 1.898 1.9-.606 4.34-1.385c.132.122.262.24.39.356.822.744 1.598 1.394 2.12 1.71a1 1 0 00.12.063c.442.19.9.269 1.356.204a2.342 2.342 0 001.16-.521c.605-.496.984-1.243 1.224-1.921.248-.702.392-1.46.452-2.115.04-.423.05-.88.001-1.279a18.31 18.31 0 001.694-1.507c2.283-2.306 2.621-5.341 2.574-7.23-.041-1.687-1.348-3.005-3.017-3.047-1.871-.048-4.883.292-7.163 2.594A18.335 18.335 0 008.8 7.308zm-1.38 2.037c-.434.06-.897.164-1.311.313-.534.193-.871.418-1.026.61a.377.377 0 00-.091.186c-.006.042-.008.134.06.297.012.025.021.051.03.078-.006-.02-.006-.019.01.006.025.04.088.141.221.319.181.24.432.544.742.898a21.87 21.87 0 011.365-2.708zm4.123 8.2c.575.505 1.029.867 1.311 1.05a.488.488 0 00.236.038.371.371 0 00.183-.093c.19-.156.414-.496.604-1.035a6.78 6.78 0 00.31-1.323 21.507 21.507 0 01-2.644 1.363zm-4.728-1.753a78.88 78.88 0 00.915.917l-1.39.443.475-1.36zm5.278-9.138a6.138 6.138 0 00-.394.365c-1.525 1.54-2.581 3.263-3.257 4.61a18.525 18.525 0 00-.73 1.643l-.019.05 2.557 2.583.05-.02c.394-.154.96-.395 1.624-.734 1.332-.681 3.037-1.747 4.567-3.292.128-.13.248-.263.361-.399l-4.759-4.806zm1.726-1.04l4.065 4.106c.51-1.263.625-2.577.599-3.62-.015-.614-.468-1.072-1.078-1.088-1.034-.026-2.337.09-3.586.602z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/arrow-down"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7.707 12.793a1 1 0 00-1.414 1.414l5 5a1 1 0 001.414 0l5-5a1 1 0 00-1.414-1.414L13 16.086V5.5a1 1 0 10-2 0v10.586l-3.293-3.293z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/arrow-left"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.707 7.707a1 1 0 00-1.414-1.414l-5 5a1 1 0 000 1.414l5 5a1 1 0 001.414-1.414L7.414 13H19a1 1 0 000-2H7.414l3.293-3.293z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/arrow-up"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7.707 11.207a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0l5 5a1 1 0 01-1.414 1.414L13 7.914V18.5a1 1 0 11-2 0V7.914l-3.293 3.293z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/backward"] = function anonymous(it) {
  var out='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 5C6.44772 5 6 5.44772 6 6V8C6 8.55228 6.44772 9 7 9C7.55228 9 8 8.55228 8 8V6C8 5.44772 7.55228 5 7 5ZM7 10C6.44772 10 6 10.4477 6 11V13C6 13.5523 6.44772 14 7 14C7.55228 14 8 13.5523 8 13V11C8 10.4477 7.55228 10 7 10ZM6 16C6 15.4477 6.44772 15 7 15C7.55228 15 8 15.4477 8 16V18C8 18.5523 7.55228 19 7 19C6.44772 19 6 18.5523 6 18V16ZM17.7071 6.79289C18.0976 7.18342 18.0976 7.81658 17.7071 8.20711L13.9142 12L17.7071 15.7929C18.0976 16.1834 18.0976 16.8166 17.7071 17.2071C17.3166 17.5976 16.6834 17.5976 16.2929 17.2071L11.7929 12.7071C11.4024 12.3166 11.4024 11.6834 11.7929 11.2929L16.2929 6.79289C16.6834 6.40237 17.3166 6.40237 17.7071 6.79289Z" fill="#999999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/bell-off"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 1a1.5 1.5 0 00-1.5 1.5V3c0 .039.002.077.004.115-1.23.201-2.232.658-3.03 1.317-1.091.899-1.709 2.097-2.058 3.286-.562 1.91-.479 4.038-.433 5.196.01.24.017.44.017.586 0 .386-.201 1.07-.594 1.953-.373.839-.857 1.723-1.285 2.454C2.347 19.228 3.257 21 4.869 21h4.713a7.951 7.951 0 01-.52-2H4.865l-.003-.003a.084.084 0 01-.023-.055c0-.004 0-.007.002-.012a27.894 27.894 0 001.393-2.664C6.63 15.373 7 14.348 7 13.5c0-.23-.01-.498-.02-.796v-.01c-.043-1.194-.102-2.861.354-4.412.276-.936.72-1.738 1.412-2.307C9.426 5.415 10.437 5 12 5s2.575.414 3.254.975c.691.57 1.136 1.37 1.412 2.307.166.567.264 1.149.32 1.718H17c.694 0 1.367.088 2.009.254-.056-.82-.178-1.7-.425-2.536-.35-1.189-.967-2.387-2.057-3.286-.8-.66-1.802-1.116-3.031-1.317.003-.038.004-.076.004-.115v-.5A1.5 1.5 0 0012 1z" fill="#999"/><path fill-rule="evenodd" clip-rule="evenodd" d="M23 18a6 6 0 11-12 0 6 6 0 0112 0zm-2.793-3.207a1 1 0 010 1.414L18.414 18l1.793 1.793a1 1 0 01-1.414 1.414L17 19.414l-1.793 1.793a1 1 0 01-1.414-1.414L15.586 18l-1.793-1.793a1 1 0 011.414-1.414L17 16.586l1.793-1.793a1 1 0 011.414 0z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/bell-on"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 1a1.5 1.5 0 00-1.5 1.5V3c0 .039.002.077.004.115-1.23.201-2.232.658-3.03 1.317-1.091.899-1.709 2.097-2.058 3.286-.562 1.91-.479 4.038-.433 5.196.01.24.017.44.017.586 0 .386-.201 1.07-.594 1.953-.373.839-.857 1.723-1.285 2.454C2.347 19.228 3.257 21 4.869 21h4.713a7.951 7.951 0 01-.52-2H4.865a.084.084 0 01-.026-.058c0-.006 0-.013.007-.024.447-.762.971-1.717 1.387-2.652.398-.893.767-1.918.767-2.766 0-.23-.01-.498-.02-.796v-.01c-.043-1.194-.102-2.861.354-4.412.276-.936.72-1.738 1.412-2.307C9.426 5.415 10.437 5 12 5s2.575.414 3.254.975c.691.57 1.136 1.37 1.412 2.307.166.567.264 1.149.32 1.718H17c.694 0 1.367.088 2.009.254-.056-.82-.178-1.7-.425-2.536-.35-1.189-.967-2.387-2.057-3.286-.8-.66-1.802-1.116-3.031-1.317.003-.038.004-.076.004-.115v-.5A1.5 1.5 0 0012 1z" fill="#999"/><path fill-rule="evenodd" clip-rule="evenodd" d="M17 24a6 6 0 100-12 6 6 0 000 12zm3.723-7.31a1 1 0 10-1.446-1.38l-3.095 3.242-1.459-1.528a1 1 0 10-1.446 1.38l2.182 2.286a1 1 0 001.446 0l3.818-4z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/bell"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5 2.5a1.5 1.5 0 113 0V3c0 .039-.001.077-.004.116 1.23.2 2.232.657 3.03 1.316 1.091.899 1.709 2.097 2.058 3.286.562 1.91.479 4.038.433 5.196-.01.24-.017.44-.017.586 0 .386.201 1.07.594 1.953.373.839.857 1.723 1.286 2.454.773 1.321-.137 3.093-1.748 3.093H14a2 2 0 11-4 0H4.869c-1.612 0-2.522-1.772-1.748-3.093.428-.731.912-1.615 1.285-2.454C4.8 14.57 5 13.886 5 13.5c0-.146-.008-.345-.017-.586-.046-1.158-.13-3.286.433-5.196.35-1.189.967-2.387 2.057-3.286.8-.66 1.802-1.116 3.031-1.316A1.523 1.523 0 0110.5 3v-.5zM12 19h7.135a.085.085 0 00.026-.058c0-.006 0-.013-.007-.024a27.903 27.903 0 01-1.387-2.652C17.37 15.373 17 14.348 17 13.5c0-.232.01-.503.02-.805.043-1.195.102-2.862-.354-4.413-.276-.936-.72-1.738-1.412-2.307C14.575 5.415 13.563 5 12 5s-2.575.414-3.254.975c-.691.57-1.136 1.37-1.412 2.307-.456 1.55-.397 3.218-.354 4.413.01.302.02.573.02.805 0 .848-.37 1.873-.767 2.766-.416.935-.94 1.89-1.387 2.652a.042.042 0 00-.007.024.085.085 0 00.026.058H12z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/bookmark"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M16 4H8a2 2 0 00-2 2v13.603l4.054-3.535a3 3 0 013.951.006L18 19.582V6a2 2 0 00-2-2zM8 2a4 4 0 00-4 4v14.328c0 1.434 1.687 2.2 2.768 1.259l4.6-4.012a1 1 0 011.318.002l4.542 3.99c1.08.947 2.772.18 2.772-1.256V6a4 4 0 00-4-4H8z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/copy_link"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M9.879 8.464a1 1 0 010-1.414l2.828-2.828a4 4 0 015.657 0l1.414 1.414a4 4 0 010 5.657L16.95 14.12a1 1 0 01-1.414-1.414l2.828-2.828a2 2 0 000-2.829L16.95 5.636a2 2 0 00-2.829 0l-2.828 2.828a1 1 0 01-1.414 0zM8.464 9.88a1 1 0 00-1.414 0l-2.828 2.828a4 4 0 000 5.657l1.414 1.414a4 4 0 005.657 0l2.828-2.828a1 1 0 00-1.414-1.414l-2.828 2.828a2 2 0 01-2.829 0L5.636 16.95a2 2 0 010-2.829l2.828-2.828a1 1 0 000-1.414zm-.353 4.596a1 1 0 001.414 1.414l6.364-6.364a1 1 0 00-1.414-1.414L8.11 14.475z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/copy_link_done"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M9.879 8.464a1 1 0 010-1.414l2.828-2.828a4 4 0 015.657 0l1.414 1.414a4.002 4.002 0 01.682 4.75 7.983 7.983 0 00-2.22-.382l.124-.125a2 2 0 000-2.829L16.95 5.636a2 2 0 00-2.829 0l-2.828 2.828a1 1 0 01-1.414 0zm.506 11.996a7.983 7.983 0 01-.381-2.22l-.125.124a2 2 0 01-2.829 0L5.636 16.95a2 2 0 010-2.829l2.828-2.828A1 1 0 007.05 9.879l-2.828 2.828a4 4 0 000 5.657l1.414 1.414a4.002 4.002 0 004.75.682zm.322-5.753a8.03 8.03 0 014-4l1.182-1.182a1 1 0 00-1.414-1.414L8.11 14.475a1 1 0 001.414 1.414l1.182-1.181zM24 18a6 6 0 11-12 0 6 6 0 0112 0zm-2.31-2.723a1 1 0 01.033 1.413l-3.818 4a1.002 1.002 0 01-1.447 0l-2.181-2.285a1 1 0 111.446-1.381l1.459 1.528 3.095-3.242a1 1 0 011.413-.033z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/cotd"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M13.31 4.626a1.6 1.6 0 00-2.62 0l-2.763 3.94-2.83-2.202c-1.23-.957-2.963.23-2.515 1.723l2.033 6.775A3 3 0 007.488 17h9.024a3 3 0 002.873-2.138l2.033-6.775c.448-1.493-1.285-2.68-2.515-1.723l-2.83 2.202-2.763-3.94zm-3.986 5.432L12 6.242l2.676 3.816a1.6 1.6 0 002.293.344l2.173-1.69-1.672 5.575a1 1 0 01-.958.713H7.488a1 1 0 01-.958-.713L4.858 8.712l2.173 1.69a1.6 1.6 0 002.293-.344zM6.5 20a1 1 0 010-2h11a1 1 0 010 2h-11z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/create-a-coub"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M17 9.5a1 1 0 102 0V8h1.5a1 1 0 100-2H19V4.5a1 1 0 10-2 0V6h-1.5a1 1 0 100 2H17v1.5zM6 8a1 1 0 00-1 1v7a1 1 0 001 1h10a1 1 0 001-1v-3a1 1 0 112 0v3a3 3 0 01-3 3H6a3 3 0 01-3-3V9a3 3 0 013-3h6a1 1 0 110 2H6z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/create"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 5c-.664 0-1.322.008-1.963.023-3.566.082-4.505.18-5.42.858-.269.2-.69.631-.884.905C3.073 7.722 3 8.603 3 12c0 3.397.072 4.278.733 5.214.194.274.615.705.884.905.915.678 1.854.776 5.42.858a85.328 85.328 0 003.926 0c3.566-.082 4.505-.18 5.42-.858.269-.2.69-.631.884-.905.66-.936.733-1.817.733-5.214 0-3.397-.072-4.278-.733-5.214a5.055 5.055 0 00-.884-.905c-.915-.678-1.854-.776-5.42-.858C13.322 5.008 12.665 5 12 5zm-9.9.632C1 7.188 1 8.792 1 12s0 4.811 1.1 6.368c.316.447.886 1.03 1.326 1.357 1.53 1.135 3.208 1.174 6.564 1.251a87.446 87.446 0 004.02 0c3.356-.077 5.034-.116 6.564-1.251.44-.326 1.01-.91 1.326-1.357C23 16.812 23 15.208 23 12s0-4.812-1.1-6.368a6.962 6.962 0 00-1.326-1.357c-1.53-1.135-3.209-1.174-6.564-1.251a87.383 87.383 0 00-4.02 0c-3.356.077-5.034.116-6.564 1.251-.44.326-1.01.91-1.326 1.357zM11 8a1 1 0 112 0v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H8a1 1 0 110-2h3V8z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/delete"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M13.392 3.5c.19.148.324.321.42.5H9.188c.096-.179.23-.352.42-.5.313-.246.873-.5 1.892-.5s1.579.254 1.892.5zm2.488.31c.018.064.032.127.043.19H19.5a1 1 0 010 2h-.069c0 .044-.001.088-.004.133L18.622 18.2A3 3 0 0115.63 21H7.37a3 3 0 01-2.993-2.8L3.573 6.133A2.033 2.033 0 013.57 6H3.5a1 1 0 010-2h3.577c.01-.063.025-.126.043-.19a3.64 3.64 0 011.255-1.886C9.113 1.347 10.135 1 11.5 1c1.364 0 2.387.347 3.124.924A3.64 3.64 0 0115.88 3.81zM14.107 6h3.323l-.804 12.067a1 1 0 01-.998.933H7.37a1 1 0 01-.998-.933L5.57 6h8.539zm-5.11 2.438a1 1 0 10-1.996.124l.5 8a1 1 0 101.996-.124l-.5-8zm6.064-.936a1 1 0 00-1.06.936l-.5 8a1 1 0 101.996.124l.5-8a1 1 0 00-.936-1.06zM10.5 8.5a1 1 0 012 0v8a1 1 0 01-2 0v-8z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/dislike"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.892 3.212c-.52.117-.926.473-1.209.783a7.13 7.13 0 00-.856 1.209c-.53.91-1.03 2.066-1.436 3.225-.405 1.16-.73 2.367-.887 3.386a7.318 7.318 0 00-.099 1.435c.02.387.095.925.431 1.338.418.515.991.804 1.536.973.548.169 1.14.238 1.694.26.17.008.34.01.51.01a6.259 6.259 0 00-.268.613c-.369.985-.398 2.259-.09 3.311C6.519 20.778 7.297 22 8.806 22c.637 0 1.203-.174 1.643-.57.418-.376.608-.854.712-1.233.078-.284.129-.605.167-.848l.028-.174c.053-.307.096-.438.129-.497.133-.238.39-.514.792-.839.398-.32.87-.633 1.387-.972l.068-.045c.48-.316 1.001-.657 1.454-1.014.396-.312.803-.682 1.104-1.12h2.854c.861 0 1.675-.562 1.903-1.46.58-2.281.74-5.082.36-6.96-.188-.938-1.018-1.468-1.824-1.489l-3.506-.09a1.005 1.005 0 00-.188.012 4.329 4.329 0 00-.528-.25 10.572 10.572 0 00-1.039-.348 26.726 26.726 0 00-2.604-.582 29.158 29.158 0 00-2.7-.355c-.786-.061-1.58-.077-2.125.046zm10.154 3.502c.015.079.029.158.042.238.123.77.172 1.699.163 2.624-.01.928-.078 1.886-.202 2.72-.019.13-.04.262-.063.392h2.134c.503-2.01.623-4.4.348-5.911l-2.422-.063zM4.403 13.152a1.3 1.3 0 00.026.22c.092.09.255.192.533.278.321.099.726.155 1.186.174.761.03 1.536-.04 2.168-.097.144-.013.28-.026.408-.036.028-.002.123-.01.24.007h.003c.051.008.527.074.76.563.244.516-.04.94-.072.987l-.001.002c-.069.103-.142.17-.163.19-.05.046-.1.083-.115.094l-.002.001-.05.037-.013.01a2.733 2.733 0 00-.293.241c-.237.226-.578.632-.837 1.322-.207.553-.238 1.381-.043 2.048.204.695.494.807.667.807a.817.817 0 00.256-.031c.034-.012.045-.021.048-.024.011-.01.064-.066.123-.278.046-.167.072-.333.107-.55.013-.084.027-.175.045-.277.052-.305.136-.75.357-1.143.318-.564.802-1.03 1.281-1.416.486-.39 1.039-.755 1.543-1.086l.036-.024c.507-.333.963-.632 1.347-.934.4-.315.635-.569.748-.77.113-.2.26-.694.375-1.464.108-.73.172-1.595.18-2.447.009-.855-.038-1.664-.138-2.287a4.07 4.07 0 00-.168-.714 1.124 1.124 0 00-.05-.118 2.74 2.74 0 00-.285-.133 8.63 8.63 0 00-.838-.278 24.772 24.772 0 00-2.402-.535 27.18 27.18 0 00-2.509-.33c-.751-.06-1.26-.049-1.496-.005-.019.013-.088.06-.205.188-.174.19-.38.48-.605.866-.446.767-.898 1.798-1.276 2.878-.377 1.08-.664 2.165-.798 3.032-.067.436-.09.783-.078 1.032z" fill="#000"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/doc"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6 5h12a1 1 0 011 1v12a1 1 0 01-1 1H6a1 1 0 01-1-1V6a1 1 0 011-1zM3 6a3 3 0 013-3h12a3 3 0 013 3v12a3 3 0 01-3 3H6a3 3 0 01-3-3V6zm5 1a1 1 0 000 2h8a1 1 0 000-2H8zm-1 4a1 1 0 011-1h8a1 1 0 010 2H8a1 1 0 01-1-1zm1 2a1 1 0 000 2h4a1 1 0 000-2H8z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/download"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 19a1 1 0 100 2h10a1 1 0 100-2H7zm-.707-8.207a1 1 0 011.414 0L11 14.086V4a1 1 0 112 0v10.086l3.293-3.293a1 1 0 111.414 1.414l-5 5a1 1 0 01-1.414 0l-5-5a1 1 0 010-1.414z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/duplicate"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10 5h9a1 1 0 011 1v8a1 1 0 01-1 1h-1v-5a3 3 0 00-3-3H9V6a1 1 0 011-1zM7 7V6a3 3 0 013-3h9a3 3 0 013 3v8a3 3 0 01-3 3h-1v1a3 3 0 01-3 3H6a3 3 0 01-3-3v-8a3 3 0 013-3h1zm9 10v-7a1 1 0 00-1-1H6a1 1 0 00-1 1v8a1 1 0 001 1h9a1 1 0 001-1v-1zm-5.5-6.5a1 1 0 00-1 1V13H8a1 1 0 100 2h1.5v1.5a1 1 0 102 0V15H13a1 1 0 100-2h-1.5v-1.5a1 1 0 00-1-1z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/edit-coub"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6 5a1 1 0 012 0v2h8V5a1 1 0 012 0v2h1a3 3 0 013 3v4a3 3 0 01-3 3h-1v2a1 1 0 01-2 0v-2H8v2a1 1 0 01-2 0v-2H5a3 3 0 01-3-3v-4a3 3 0 013-3h1V5zm12 10h1a1 1 0 001-1v-4a1 1 0 00-1-1h-1v6zm-2-6v6H8V9h8zM5 9h1v6H5a1 1 0 01-1-1v-4a1 1 0 011-1z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/edit"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5.868 18.155l.569-1.983 8.891-8.891 1.414 1.414-8.89 8.89-1.984.57zM18.156 7.281l.643-.643-1.414-1.414-.643.642 1.415 1.415zm-13.57 8.09a1 1 0 01.254-.43L15.97 3.808a2 2 0 012.83 0l1.413 1.415a2 2 0 010 2.828L9.083 19.183a1 1 0 01-.432.254l-3.966 1.138a1 1 0 01-1.237-1.237l1.138-3.966z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/embed"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.793 17.207a1 1 0 010-1.414L18.586 12l-3.793-3.793a1 1 0 011.414-1.414l4.5 4.5a1 1 0 010 1.414l-4.5 4.5a1 1 0 01-1.414 0zM9.207 6.793a1 1 0 010 1.414L5.414 12l3.793 3.793a1 1 0 11-1.414 1.414l-4.5-4.5a1 1 0 010-1.414l4.5-4.5a1 1 0 011.414 0z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/facebook"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M.5 12C.5 5.649 5.649.5 12 .5S23.5 5.649 23.5 12 18.351 23.5 12 23.5.5 18.351.5 12zm12.542 11.453a11.647 11.647 0 01-3.073-.132v-8.203H7.93v-2.674h2.039V10.42c0-1.887 1.138-3.783 4.043-3.783.89 0 1.533.063 1.848.093.101.01.168.016.198.016l.054 2.788s-.887-.008-1.855-.008c-1.048 0-1.215.467-1.215 1.242v1.677h3.016v2.674h-3.016v8.335z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/favs_add"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 4h8a2 2 0 012 2v13.582l-3.995-3.508a3 3 0 00-3.95-.006L6 19.603V6a2 2 0 012-2zM4 6a4 4 0 014-4h8a4 4 0 014 4v14.311c0 1.436-1.693 2.203-2.772 1.255l-4.543-3.989a1 1 0 00-1.317-.002l-4.6 4.012C5.688 22.529 4 21.762 4 20.328V6z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/favs_remove"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M16 4H8a2 2 0 00-2 2v13.603l4.054-3.535c.074-.065.15-.125.228-.18a8.007 8.007 0 00-.248 2.851l-3.266 2.848C5.688 22.529 4 21.762 4 20.328V6a4 4 0 014-4h8a4 4 0 014 4v4.252A8.012 8.012 0 0018 10V6a2 2 0 00-2-2zm8 14a6 6 0 11-12 0 6 6 0 0112 0zm-2.31-2.723a1 1 0 01.033 1.413l-3.818 4a1 1 0 01-1.447 0l-2.181-2.285a1 1 0 111.446-1.381l1.459 1.528 3.095-3.242a1 1 0 011.413-.033z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/featured"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.755 4.57c-1.04-2.418-4.47-2.418-5.51 0l-.938 2.178a1 1 0 01-.826.6l-2.362.22c-2.62.242-3.68 3.503-1.703 5.24l1.782 1.565a1 1 0 01.316.971l-.522 2.314c-.579 2.568 2.195 4.583 4.458 3.239l2.04-1.21a1 1 0 011.02 0l2.04 1.21c2.263 1.344 5.037-.671 4.458-3.24l-.521-2.313a1 1 0 01.315-.97l1.782-1.566c1.977-1.737.918-4.998-1.703-5.24l-2.362-.22a1 1 0 01-.826-.6l-.938-2.178zm-3.674.791c.348-.806 1.49-.806 1.838 0l.937 2.178a3 3 0 002.479 1.8l2.36.22c.875.08 1.228 1.167.569 1.747l-1.782 1.565a3 3 0 00-.947 2.913l.522 2.313c.193.856-.732 1.528-1.486 1.08l-2.04-1.21a3 3 0 00-3.063 0l-2.039 1.21c-.754.448-1.679-.224-1.486-1.08l.522-2.313a3 3 0 00-.947-2.913l-1.782-1.566c-.659-.579-.306-1.665.568-1.746l2.361-.22a3 3 0 002.479-1.8l.938-2.178z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/flag"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.7 6.217l1.194 5.18c1.169-.306 2.019-.434 2.693-.437.902-.005 1.443.216 1.881.395l.02.008c.362.148.652.265 1.246.268.569.003 1.432-.1 2.84-.452l.7-4.41c-1.066.223-1.964.296-2.764.268-1.15-.04-2.046-.288-2.846-.517l-.09-.026c-.764-.22-1.434-.412-2.282-.474-.685-.05-1.512-.015-2.593.197zm1.643 7.13l1.251 5.428a1 1 0 11-1.948.45L6.18 12.87 4.526 5.69a1 1 0 01.724-1.193c1.735-.448 3.06-.554 4.188-.471 1.06.077 1.907.32 2.653.536l.125.036c.78.223 1.475.41 2.363.44.89.031 2.025-.094 3.637-.572a1 1 0 011.272 1.115l-1.04 6.558a1 1 0 01-.727.808c-1.854.503-3.087.69-3.998.684-.965-.005-1.53-.228-1.99-.416l-.016-.007c-.37-.15-.616-.251-1.12-.248-.458.002-1.144.093-2.254.387z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/fullscreen-off"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M21 10a1 1 0 00-1-1h-3.586l4.293-4.293a1 1 0 00-1.414-1.414L15 7.586V4a1 1 0 00-2 0v6a1 1 0 001 1h6a1 1 0 001-1zM3 14a1 1 0 001 1h3.586l-4.293 4.293a1 1 0 001.414 1.414L9 16.414V20a1 1 0 002 0v-6a1 1 0 00-1-1H4a1 1 0 00-1 1z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/fullscreen"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M13 4a1 1 0 001 1h3.586l-4.293 4.293a1 1 0 001.414 1.414L19 6.414V10a1 1 0 002 0V4a1 1 0 00-1-1h-6a1 1 0 00-1 1zm-2 16a1 1 0 00-1-1H6.414l4.293-4.293a1 1 0 00-1.414-1.414L5 17.586V14a1 1 0 00-2 0v6a1 1 0 001 1h6a1 1 0 001-1z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/help"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M20 12a8 8 0 11-16 0 8 8 0 0116 0zm-8 10c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zm-1.105-6.25c0-.552.448-1 1.001-1h.039a1.001 1.001 0 010 2.002h-.039a1.001 1.001 0 01-1.001-1.001zm-1.129-5.29c-.53 0-.972-.442-.837-.954a3.199 3.199 0 01.744-1.347c.277-.286.607-.507.988-.663a3.31 3.31 0 011.3-.247c.615 0 1.127.086 1.534.26.416.164.75.372 1.001.624.251.25.429.524.533.819.113.286.169.554.169.806 0 .416-.056.758-.169 1.027a2.327 2.327 0 01-.403.688c-.156.191-.334.356-.533.494a8.9 8.9 0 00-.546.403c-.173.13-.33.282-.468.456-.13.173-.212.39-.247.65a.494.494 0 01-.494.493h-.676a.585.585 0 01-.585-.585c.026-.372.095-.684.208-.936a2.7 2.7 0 01.416-.636c.156-.182.32-.338.494-.468.173-.13.334-.26.481-.39.147-.13.264-.274.351-.43.095-.155.139-.35.13-.584 0-.4-.1-.694-.299-.884-.19-.191-.46-.286-.806-.286-.234 0-.438.047-.611.143a1.195 1.195 0 00-.416.364 1.579 1.579 0 00-.234.533c-.091.35-.372.65-.734.65h-.29z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/left"] = function anonymous(it) {
  var out='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M15.7071 6.70711C16.0976 6.31658 16.0976 5.68342 15.7071 5.29289C15.3166 4.90237 14.6834 4.90237 14.2929 5.29289L8.29289 11.2929C7.90237 11.6834 7.90237 12.3166 8.29289 12.7071L14.2929 18.7071C14.6834 19.0976 15.3166 19.0976 15.7071 18.7071C16.0976 18.3166 16.0976 17.6834 15.7071 17.2929L10.4142 12L15.7071 6.70711Z" fill="#999999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/like"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M3.932 5.23C4.818 4.443 6.017 4 7.5 4c1.591 0 2.902.596 3.791 1.161.27.173.507.345.706.503a8.29 8.29 0 01.702-.502C13.588 4.595 14.899 4 16.5 4c1.438 0 2.62.42 3.512 1.172.883.744 1.407 1.752 1.651 2.808.48 2.072-.075 4.51-1.382 6.144-1.223 1.53-3.217 2.978-4.826 4.012a42.33 42.33 0 01-2.932 1.718l-.048.026-.013.006-.004.002h-.001v.001L11.998 19l-.48.878-.001-.001-.004-.002-.013-.008-.05-.027a45.798 45.798 0 01-.85-.486 52.394 52.394 0 01-2.152-1.332c-1.623-1.062-3.623-2.513-4.73-3.898-1.191-1.49-1.777-3.918-1.362-6.004.212-1.066.7-2.11 1.575-2.89zM11.999 19l-.48.878.466.254.471-.243L12 19zm.012-1.14c.104-.058.224-.124.356-.199.517-.29 1.228-.707 2.006-1.207 1.585-1.019 3.34-2.32 4.346-3.578.922-1.153 1.338-2.965.996-4.446-.167-.72-.502-1.316-.992-1.73-.483-.406-1.19-.7-2.223-.7-1.1 0-2.039.41-2.725.848a6.197 6.197 0 00-.984.78l-.043.045-.007.007-.739.825-.742-.82v-.001l-.008-.008a4.627 4.627 0 00-.243-.232c-.18-.16-.45-.378-.792-.595C9.527 6.409 8.588 6 7.5 6c-1.07 0-1.772.31-2.239.725-.477.425-.794 1.039-.943 1.785-.306 1.542.162 3.363.963 4.366.886 1.108 2.635 2.407 4.263 3.472a50.439 50.439 0 002.467 1.511z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/lock"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.5 7.5a5.5 5.5 0 1111 0v1.541A3 3 0 0120 12v6a3 3 0 01-3 3H7a3 3 0 01-3-3v-6a3 3 0 012.5-2.959V7.5zm10 3.5h.5a1 1 0 011 1v6a1 1 0 01-1 1H7a1 1 0 01-1-1v-6a1 1 0 011-1h9.5zm-1-3.5V9h-7V7.5a3.5 3.5 0 017 0zM12 17a2 2 0 100-4 2 2 0 000 4z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/logout"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M13 7a3 3 0 00-3-3H6a3 3 0 00-3 3v10a3 3 0 003 3h4a3 3 0 003-3v-1a1 1 0 00-2 0v1a1 1 0 01-1 1H6a1 1 0 01-1-1V7a1 1 0 011-1h4a1 1 0 011 1v1a1 1 0 002 0V7zm4.586 4l-2.293-2.293a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L17.586 13H8a1 1 0 010-2h9.586z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/mail"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5 4a3 3 0 00-3 3v10a3 3 0 003 3h14a3 3 0 003-3V7a3 3 0 00-3-3H5zM4 7.288V17a1 1 0 001 1h14a1 1 0 001-1V7.288l-7.37 5.988a1 1 0 01-1.26 0L4 7.288zM18.414 6H5.586L12 11.211 18.414 6z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/members"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8.5 3a4 4 0 100 8 4 4 0 000-8zm-2 4a2 2 0 114 0 2 2 0 01-4 0zm1.984 4.5c-2.02 0-3.675.35-4.937 1.095-1.294.764-2.097 1.901-2.453 3.297-.196.77-.11 1.7.497 2.452.616.762 1.617 1.156 2.88 1.156H12.497c1.222 0 2.223-.313 2.858-1.01.047.006.096.01.145.01h4.575c.989 0 1.858-.226 2.412-.826.597-.647.593-1.46.387-2.068-.71-2.102-2.815-3.106-5.886-3.106-1.21 0-2.257.14-3.133.44a5.85 5.85 0 00-.479-.32c-1.256-.751-2.893-1.12-4.892-1.12zm6.864 3.123c.217.385.389.798.516 1.235.06.202.103.418.123.642h4.087c.364 0 .606-.043.757-.092a.721.721 0 00.15-.064l.018-.012v-.005a.41.41 0 00-.02-.081c-.3-.888-1.26-1.746-3.991-1.746-.635 0-1.179.044-1.64.123zM3.031 16.386c.232-.908.72-1.59 1.532-2.07.844-.498 2.104-.816 3.92-.816 1.773 0 3.018.33 3.865.837.824.493 1.335 1.19 1.596 2.083.108.371.04.588-.049.699-.092.115-.416.381-1.4.381H4.472c-.862 0-1.2-.259-1.324-.413-.133-.165-.188-.414-.115-.701zM13.5 8.5a3.5 3.5 0 117 0 3.5 3.5 0 01-7 0zM17 7a1.5 1.5 0 100 3 1.5 1.5 0 000-3z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/more"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5 14a2 2 0 100-4 2 2 0 000 4zm7 0a2 2 0 100-4 2 2 0 000 4zm9-2a2 2 0 11-4 0 2 2 0 014 0z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/new-story"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M18 8.5a1 1 0 102 0V7h1.5a1 1 0 100-2H20V3.5a1 1 0 10-2 0V5h-1.5a1 1 0 100 2H18v1.5zM4 6a1 1 0 011-1h8a1 1 0 110 2H5a1 1 0 01-1-1zm0 6a1 1 0 011-1h14a1 1 0 110 2H5a1 1 0 01-1-1zm1 5a1 1 0 100 2h14a1 1 0 100-2H5z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/odnoklassniki"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.947 7.046c-.016 2.769 2.25 5.06 5.014 5.07 2.792.009 5.074-2.23 5.088-4.993.014-2.828-2.23-5.115-5.027-5.123a5.066 5.066 0 00-5.075 5.046zM12 4.583a2.463 2.463 0 012.472 2.47 2.458 2.458 0 01-2.459 2.48 2.463 2.463 0 01-2.49-2.45 2.467 2.467 0 012.477-2.5zM6.874 14.598c1.196.935 2.593 1.317 4.142 1.478l-.111.12c-.053.058-.097.107-.143.153l-.663.665c-.915.917-1.83 1.835-2.748 2.752-.235.235-.404.497-.42.84-.025.507.29 1.011.784 1.251.465.226.942.155 1.343-.24.893-.881 1.781-1.767 2.655-2.666.218-.225.337-.274.585-.015.572.599 1.16 1.183 1.746 1.766.287.285.573.57.858.856.226.228.482.391.809.414.516.035 1.043-.295 1.278-.798.215-.46.133-.95-.257-1.344a651.55 651.55 0 00-2.195-2.205c-.42-.42-.84-.841-1.259-1.263a5.97 5.97 0 01-.182-.194l-.086-.094c.848-.101 1.704-.254 2.486-.557.826-.32 1.57-.78 2.189-1.415.403-.414.408-.935.08-1.468-.286-.467-.784-.663-1.318-.526-.275.07-.512.209-.733.379-2.238 1.505-5.3 1.463-7.528-.069a2.417 2.417 0 00-.343-.203c-.619-.291-1.213-.155-1.568.352-.414.594-.361 1.17.162 1.672.108.104.228.197.348.29l.09.069z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/open-on-coub"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M9.556 8.545a1 1 0 01.07-2l6.14.213h.011a.998.998 0 01.965.965l.212 6.152a1 1 0 01-1.999.069l-.132-3.852-.279.278-.158.158-.043.043-.01.011-.004.003-.708-.706-.707-.707.001-.001.003-.003.01-.011.044-.043.158-.158.278-.278-3.852-.133zm-3.006 6.99l6.364-6.363.707.707.707.707-6.364 6.364a1 1 0 01-1.414-1.414z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/pinterest"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 1C5.925 1 1 5.924 1 12c0 4.66 2.9 8.64 6.991 10.243-.096-.87-.183-2.205.039-3.154.2-.86 1.29-5.468 1.29-5.468s-.33-.66-.33-1.634c0-1.529.887-2.671 1.99-2.671.938 0 1.392.705 1.392 1.55 0 .942-.6 2.353-.911 3.661-.26 1.095.55 1.989 1.629 1.989 1.955 0 3.458-2.062 3.458-5.038 0-2.633-1.892-4.475-4.595-4.475-3.13 0-4.966 2.348-4.966 4.773 0 .945.364 1.96.818 2.51a.33.33 0 01.076.316l-.305 1.247c-.048.202-.16.245-.368.148-1.374-.64-2.233-2.649-2.233-4.262 0-3.47 2.52-6.657 7.268-6.657 3.816 0 6.781 2.72 6.781 6.354 0 3.791-2.39 6.842-5.708 6.842-1.114 0-2.162-.579-2.52-1.264l-.686 2.616c-.249.956-.919 2.154-1.368 2.884 1.03.318 2.124.49 3.258.49 6.075 0 11-4.925 11-11 0-6.076-4.925-11-11-11z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/plus"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 5a1 1 0 00-1 1v5H6a1 1 0 000 2h5v5a1 1 0 002 0v-5h5a1 1 0 000-2h-5V6a1 1 0 00-1-1z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/promote"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8.908 8.716c-.21-.086-.52-.035-.765.28l-3.485 4.505a2 2 0 00.167 2.638l3.067 3.066a2 2 0 002.648.16l4.471-3.504c.312-.245.362-.554.278-.762-.376-.922-1.135-2.36-2.581-3.806-1.443-1.44-2.877-2.2-3.8-2.577zm-2.347-.943c.685-.886 1.908-1.398 3.105-.908 1.117.457 2.79 1.35 4.455 3.013 1.671 1.67 2.564 3.348 3.02 4.467.484 1.189-.02 2.404-.896 3.09l-4.472 3.504a4 4 0 01-5.296-.32l-3.066-3.066a4 4 0 01-.335-5.276l3.485-4.504zm4.025 7.763a1.5 1.5 0 10-2.121-2.122 1.5 1.5 0 002.12 2.122zm.112-10.57a1 1 0 011.265-.632l-.316.948.316-.948h.002l.004.002.009.003.027.01.09.032c.075.029.18.07.31.126.26.111.622.28 1.053.52.86.478 2 1.238 3.138 2.377a14.273 14.273 0 012.377 3.138c.24.43.409.793.52 1.053a7.733 7.733 0 01.159.4l.01.027.002.01.001.003v.001h.001l-.948.318.948-.317a1 1 0 01-1.896.635l-.003-.008a5.765 5.765 0 00-.112-.28 9.569 9.569 0 00-.43-.87 12.276 12.276 0 00-2.043-2.696 12.276 12.276 0 00-2.695-2.043 9.585 9.585 0 00-.87-.43 5.71 5.71 0 00-.28-.112l-.01-.003h.002a1 1 0 01-.631-1.264zm.63 1.264h-.001zm3.313-3.162a1 1 0 011.342-.448l-.447.895.447-.895.001.001.003.001.005.003.018.01a4.948 4.948 0 01.265.144c.172.099.413.243.7.434.57.38 1.332.952 2.096 1.716a13.816 13.816 0 012.164 2.828 8.477 8.477 0 01.146.27l.01.017.002.006.001.003h.001L20.5 8.5l.895-.446a1 1 0 01-1.79.893l-.003-.007-.02-.036a10.332 10.332 0 00-.454-.753 11.82 11.82 0 00-1.471-1.808 11.893 11.893 0 00-2.374-1.827 6.237 6.237 0 00-.19-.104l-.005-.003a1 1 0 01-.447-1.341zm.446 1.34l.001.001h-.001zm0 0z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/recoub"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 5c-.664 0-1.322.008-1.963.023-3.566.082-4.505.18-5.42.858-.269.2-.69.631-.884.905C3.073 7.722 3 8.603 3 12c0 3.397.072 4.278.733 5.214.194.274.615.705.884.905.915.678 1.854.776 5.42.858a85.328 85.328 0 003.926 0c3.566-.082 4.505-.18 5.42-.858.269-.2.69-.631.884-.905.66-.936.733-1.817.733-5.214 0-3.397-.072-4.278-.733-5.214a5.055 5.055 0 00-.884-.905c-.915-.678-1.854-.776-5.42-.858C13.322 5.008 12.665 5 12 5zm-9.9.632C1 7.188 1 8.792 1 12s0 4.811 1.1 6.368c.316.447.886 1.03 1.326 1.357 1.53 1.135 3.208 1.174 6.564 1.251a87.446 87.446 0 004.02 0c3.356-.077 5.034-.116 6.564-1.251.44-.326 1.01-.91 1.326-1.357C23 16.812 23 15.208 23 12s0-4.812-1.1-6.368a6.962 6.962 0 00-1.326-1.357c-1.53-1.135-3.209-1.174-6.564-1.251a87.383 87.383 0 00-4.02 0c-3.356.077-5.034.116-6.564 1.251-.44.326-1.01.91-1.326 1.357zM11 8a1 1 0 112 0v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H8a1 1 0 110-2h3V8z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/reddit"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M23 11.801c0-1.313-1.093-2.38-2.436-2.38-.655 0-1.249.257-1.686.671-1.66-1.072-3.904-1.754-6.39-1.841l1.36-4.202 3.68.846-.005.053c0 1.073.894 1.946 1.993 1.946 1.098 0 1.99-.873 1.99-1.946 0-1.074-.893-1.948-1.99-1.948-.844 0-1.562.517-1.853 1.241l-3.968-.913a.34.34 0 00-.403.224l-1.517 4.686c-2.601.03-4.958.718-6.691 1.822a2.447 2.447 0 00-1.65-.64C2.093 9.42 1 10.488 1 11.8c0 .873.489 1.63 1.207 2.044a4.17 4.17 0 00-.079.771c0 3.52 4.408 6.384 9.826 6.384 5.419 0 9.827-2.864 9.827-6.384 0-.246-.027-.49-.069-.729.763-.402 1.288-1.18 1.288-2.086zM7.211 13.435c0-.78.651-1.417 1.45-1.417.8 0 1.45.636 1.45 1.417 0 .782-.65 1.417-1.45 1.417-.799 0-1.45-.635-1.45-1.417zm8.306 4.203c-.73.713-1.877 1.06-3.505 1.06L12 18.697l-.012.003c-1.629 0-2.776-.348-3.505-1.061a.328.328 0 010-.471c.133-.13.349-.13.482 0 .596.582 1.585.865 3.023.865l.012.003.012-.003c1.438 0 2.427-.284 3.023-.866.133-.13.35-.13.482 0a.329.329 0 010 .472zm-.173-2.786c-.8 0-1.45-.635-1.45-1.417 0-.78.65-1.417 1.45-1.417.8 0 1.45.636 1.45 1.417 0 .782-.65 1.417-1.45 1.417z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/replay"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M11.707 4.707a1 1 0 10-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 101.414-1.414L10.414 8H12a5.5 5.5 0 11-5.5 5.5 1 1 0 10-2 0A7.5 7.5 0 1012 6h-1.586l1.293-1.293z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/repost"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M9.5 6c1.888 0 3.236.001 4.29.096 1.039.095 1.691.274 2.21.574a5 5 0 011.83 1.83c.3.519.48 1.171.574 2.21.074.82.091 1.82.095 3.115L16.65 12.24a1 1 0 00-1.302 1.518l3.5 3a1 1 0 001.302 0l3.5-3a1 1 0 00-1.302-1.518l-1.85 1.586c-.004-1.308-.021-2.39-.104-3.297-.106-1.178-.328-2.156-.833-3.03A7 7 0 0017 4.938c-.874-.505-1.852-.727-3.03-.833C12.816 4 11.377 4 9.55 4H7.5a1 1 0 000 2h2zm-5.997 4.172L1.65 11.759a1 1 0 01-1.302-1.518l3.5-3a1 1 0 011.302 0l3.5 3a1 1 0 01-1.302 1.518l-1.846-1.582c.007 1.29.032 2.307.118 3.151.119 1.164.344 1.885.722 2.45a5 5 0 001.38 1.38c.564.377 1.286.602 2.449.72 1.18.12 2.7.122 4.828.122h1.5a1 1 0 110 2h-1.556c-2.06 0-3.681 0-4.974-.131-1.322-.135-2.41-.415-3.359-1.049A7 7 0 014.68 16.89c-.634-.948-.914-2.037-1.048-3.359-.096-.934-.122-2.04-.13-3.358z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/right"] = function anonymous(it) {
  var out='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8.29289 6.70711C7.90237 6.31658 7.90237 5.68342 8.29289 5.29289C8.68342 4.90237 9.31658 4.90237 9.70711 5.29289L15.7071 11.2929C16.0976 11.6834 16.0976 12.3166 15.7071 12.7071L9.70711 18.7071C9.31658 19.0976 8.68342 19.0976 8.29289 18.7071C7.90237 18.3166 7.90237 17.6834 8.29289 17.2929L13.5858 12L8.29289 6.70711Z" fill="#999999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/settings-hd"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 2a1 1 0 011 1v1.062c1.46.182 2.8.758 3.906 1.618l.75-.751a1 1 0 111.415 1.414l-.751.751A7.96 7.96 0 0119.938 11H21a1 1 0 010 2h-3.083A6 6 0 1010 17.659v2.089a7.97 7.97 0 01-2.906-1.428l-.75.751a1 1 0 01-1.415-1.414l.751-.751A7.962 7.962 0 014.062 13H3a1 1 0 010-2h1.062c.182-1.46.758-2.8 1.618-3.906l-.751-.75a1 1 0 011.414-1.415l.751.751A7.962 7.962 0 0111 4.062V3a1 1 0 011-1zm-1 14a2 2 0 012-2h7.2a2 2 0 012 2v4a2 2 0 01-2 2H13a2 2 0 01-2-2v-4zm5.626 4v-4H15.61v1.569h-1.594V16H13v4h1.017v-1.61h1.594V20h1.015zm.61-4v4h1.632c1.206 0 1.916-.746 1.916-2.024 0-1.275-.71-1.976-1.916-1.976h-1.632zm1.017.82h.48c.643 0 1.017.408 1.017 1.16 0 .798-.355 1.2-1.017 1.2h-.48v-2.36z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/settings"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 2a1 1 0 011 1v1.062c1.46.182 2.8.758 3.906 1.618l.75-.751a1 1 0 011.415 1.414l-.751.751A7.962 7.962 0 0119.938 11H21a1 1 0 010 2h-1.062a7.961 7.961 0 01-1.618 3.906l.751.75a1 1 0 11-1.414 1.415l-.751-.751A7.962 7.962 0 0113 19.938V21a1 1 0 01-2 0v-1.062a7.962 7.962 0 01-3.906-1.618l-.75.751a1 1 0 01-1.415-1.414l.751-.751A7.961 7.961 0 014.062 13H3a1 1 0 010-2h1.062c.182-1.46.758-2.8 1.618-3.906l-.751-.75a1 1 0 111.414-1.415l.751.751A7.962 7.962 0 0111 4.062V3a1 1 0 011-1zM6 12a6 6 0 1012 0 6 6 0 00-12 0z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/share"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M11 6.414V15a1 1 0 002 0V6.414l2.293 2.293a1 1 0 001.414-1.414l-4-4a.997.997 0 00-1.414 0l-4 4a1 1 0 001.414 1.414L11 6.414zM19 13a1 1 0 011 1V18.001A3 3 0 0117 21H7a3 3 0 01-3-3V14a1 1 0 012 0V18.001A1 1 0 007 19h10a1 1 0 001-1V14a1 1 0 011-1z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/sound-half"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14 5.414C14 3.632 11.846 2.74 10.586 4l-4 4H4a2 2 0 00-2 2v4a2 2 0 002 2h2.586l4 4c1.26 1.26 3.414.368 3.414-1.414V5.414zm-6 4l4-4v13.172l-4-4A2 2 0 006.586 14H4v-4h2.586A2 2 0 008 9.414zm9.681-2.265a1 1 0 10-1.363 1.464A4.613 4.613 0 0117.808 12a4.613 4.613 0 01-1.49 3.387 1 1 0 001.363 1.464A6.612 6.612 0 0019.81 12a6.612 6.612 0 00-2.128-4.85z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/sound-off"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.586 4C11.846 2.74 14 3.632 14 5.414v13.172c0 1.782-2.154 2.674-3.414 1.414l-4-4H4a2 2 0 01-2-2v-4a2 2 0 012-2h2.586l4-4zM12 5.414l-4 4A2 2 0 016.586 10H4v4h2.586A2 2 0 018 14.586l4 4V5.414zm10.293 10.122a1 1 0 001.414-1.415L21.586 12l2.121-2.121a1 1 0 00-1.414-1.414l-2.121 2.12-2.122-2.12a1 1 0 10-1.414 1.414L18.757 12l-2.12 2.121a1 1 0 101.413 1.415l2.122-2.122 2.12 2.122z" fill="#999"/></g><defs><clipPath id="clip0"><path fill="#fff" d="M0 0h24v24H0z"/></clipPath></defs></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/sound-on"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0)"><path fill-rule="evenodd" clip-rule="evenodd" d="M14 5.414C14 3.632 11.846 2.74 10.586 4l-4 4H4a2 2 0 00-2 2v4a2 2 0 002 2h2.586l4 4c1.26 1.26 3.414.368 3.414-1.414V5.414zm-6 4l4-4v13.172l-4-4A2 2 0 006.586 14H4v-4h2.586A2 2 0 008 9.414zm12.652-5.14a1 1 0 10-1.376 1.452C20.962 7.324 22 9.546 22 12s-1.038 4.676-2.724 6.274a1 1 0 101.376 1.452C22.712 17.772 24 15.034 24 12s-1.288-5.772-3.348-7.726zm-2.97 2.875a1 1 0 10-1.363 1.464A4.613 4.613 0 0117.808 12a4.613 4.613 0 01-1.49 3.387 1 1 0 101.363 1.464A6.612 6.612 0 0019.808 12a6.612 6.612 0 00-2.128-4.852z" fill="#999"/></g><defs><clipPath id="clip0"><path fill="#fff" d="M0 0h24v24H0z"/></clipPath></defs></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/telegram"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.586 16.26l4.136 3.036c.761.417 1.31.2 1.5-.703L18.939 5.88c.278-1.107-.425-1.61-1.153-1.28L1.84 10.707c-1.088.433-1.082 1.037-.198 1.306l4.092 1.268 9.472-5.937c.448-.27.858-.125.521.172L8.052 14.4 7.77 18.59c.402 0 .586-.178.809-.393l.019-.018 1.988-1.92z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/tumblr"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 11.992C1 5.93 5.927 1 12.017 1A10.979 10.979 0 0123 11.992C23 18.054 18.073 23 12.017 23 5.927 23 1 18.054 1 11.992zm13.156 3.78c-.84 0-1.369-.333-1.369-1.295v-3.21h2.463v-2.32h-2.463V5.784h-2.11c-.098 1.393-.949 3.003-2.981 3.488v1.996h1.846v3.686c0 2.302 1.515 3.264 3.549 3.264h2.257v-2.445h-1.192z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/twitter"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M22.5 6.035a8.566 8.566 0 01-2.474.684 4.35 4.35 0 001.894-2.402 8.584 8.584 0 01-2.736 1.054A4.288 4.288 0 0016.039 4c-2.38 0-4.308 1.943-4.308 4.34 0 .34.038.672.111.99-3.58-.182-6.755-1.91-8.88-4.535a4.344 4.344 0 00-.583 2.182c0 1.505.76 2.834 1.916 3.612a4.268 4.268 0 01-1.951-.543v.055A4.335 4.335 0 005.8 14.357a4.288 4.288 0 01-1.946.074 4.317 4.317 0 004.025 3.014A8.604 8.604 0 011.5 19.243a12.13 12.13 0 006.604 1.95c7.925 0 12.259-6.614 12.259-12.35 0-.188-.005-.375-.013-.56a8.79 8.79 0 002.15-2.248z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/unlock"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 11h10a1 1 0 011 1v6a1 1 0 01-1 1H7a1 1 0 01-1-1v-6a1 1 0 011-1zm10-2H9.006l-.073-.099a3.195 3.195 0 115.385-3.41l.802 1.484a1 1 0 001.76-.95l-.802-1.485a5.195 5.195 0 00-9.365 4.474A3 3 0 004 12v6a3 3 0 003 3h10a3 3 0 003-3v-6a3 3 0 00-3-3zm-5 8a2 2 0 100-4 2 2 0 000 4z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/video"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 6h10a2 2 0 012 2v8a2 2 0 01-2 2H7a2 2 0 01-2-2V8a2 2 0 012-2zM3 8a4 4 0 014-4h10a4 4 0 014 4v8a4 4 0 01-4 4H7a4 4 0 01-4-4V8zm6.5 6.277a1 1 0 001.496.868l3.985-2.277a1 1 0 000-1.736l-3.985-2.277a1 1 0 00-1.496.868v4.554z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/24/vkontakte"] = function anonymous(it) {
  var out='<svg width="24" height="24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M21.742 6.813c.14-.469 0-.813-.668-.813h-2.21c-.563 0-.822.297-.963.625 0 0-1.124 2.74-2.716 4.52-.515.515-.75.68-1.03.68-.141 0-.352-.165-.38-.633v-4.38c0-.562-.128-.812-.596-.812H9.705c-.351 0-.562.26-.562.508 0 .533.796.656.882 2.155v3.255c-.004.714-.133.843-.414.843-.75 0-2.572-2.752-3.653-5.902C5.746 6.247 5.533 6 4.968 6h-2.21C2.126 6 2 6.297 2 6.625c0 .586.75 3.49 3.49 7.33C7.315 16.578 9.89 18 12.231 18c1.405 0 1.579-.316 1.543-.86v-1.982c.035-.632.169-.758.614-.758.328 0 .89.164 2.201 1.429C18.089 17.328 18.336 18 19.179 18h2.21c.632 0 .948-.316.766-.939-.2-.621-.915-1.522-1.865-2.59-.515-.61-1.288-1.265-1.522-1.593-.328-.421-.234-.609 0-.984 0 0 2.693-3.793 2.974-5.081z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/32/play"] = function anonymous(it) {
  var out='<svg width="32" height="32" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M24.467 13.768c1.83.925 1.83 3.539 0 4.463l-11.174 5.645c-1.662.84-3.627-.369-3.627-2.232V10.356c0-1.863 1.964-3.071 3.627-2.231l11.174 5.644zm-.902 2.678a.5.5 0 000-.892L12.39 9.909a.5.5 0 00-.725.446v11.29a.5.5 0 00.726.446l11.173-5.645z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/68/bookmark"] = function anonymous(it) {
  var out='<svg width="68" height="68" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19.333 7.667h29.334a6 6 0 016 6v46.955c0 1.153-1.359 1.768-2.224 1.007L36.714 47.82a4 4 0 00-5.268-.01L15.554 61.666c-.867.756-2.22.14-2.22-1.01v-46.99a6 6 0 016-6z" stroke="#999" stroke-width="4"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/68/chat"] = function anonymous(it) {
  var out='<svg width="68" height="68" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M13.884 14.315c5.337-4.205 12.526-6.398 20.117-6.398 7.58 0 14.767 2.138 20.106 6.293 5.385 4.19 8.81 10.379 8.81 18.18 0 7.802-3.425 13.992-8.81 18.181-5.34 4.154-12.526 6.293-20.106 6.293-3.8 0-7.49-.524-10.897-1.559L8.659 60.071c-1.956.645-3.81-1.22-3.153-3.172l3.712-11.022c-2.626-3.645-4.135-8.117-4.135-13.292 0-7.799 3.423-14.033 8.801-18.27zm2.476 3.141c-4.467 3.52-7.277 8.62-7.277 15.13 0 4.713 1.472 8.604 3.93 11.676l.683.852-.349 1.036-3.092 9.182 12.208-4.028.622-.205.624.203c3.149 1.026 6.64 1.562 10.292 1.562 6.872 0 13.144-1.944 17.65-5.45 4.46-3.47 7.267-8.517 7.267-15.024 0-6.506-2.807-11.553-7.267-15.023-4.506-3.506-10.778-5.45-17.65-5.45-6.862 0-13.132 1.987-17.641 5.54zM7.406 56.272h.002z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/68/like"] = function anonymous(it) {
  var out='<svg width="68" height="68" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.428 20.91c1.806-6.385 6.9-11.574 15.147-11.574 5.181 0 8.716 1.318 11.183 2.677 1.016.56 1.85 1.129 2.467 1.548l.314.214c.193.13.342.227.461.3.12-.073.268-.17.46-.3l.315-.214c.616-.42 1.451-.988 2.468-1.548 2.466-1.36 6.001-2.677 11.182-2.677 8.247 0 13.341 5.189 15.148 11.574 1.771 6.263.458 13.83-3.989 19.22-4.18 5.066-9.965 9.642-14.85 12.932-2.454 1.652-4.715 3.003-6.485 3.949-.882.472-1.664.855-2.3 1.126-.316.135-.622.253-.902.341-.227.072-.623.186-1.047.186-.424 0-.82-.114-1.047-.186-.28-.088-.586-.206-.902-.341a30.169 30.169 0 01-2.3-1.126c-1.77-.946-4.031-2.297-6.485-3.95-4.885-3.289-10.67-7.865-14.85-12.932-4.447-5.39-5.76-12.956-3.988-19.22zM33.7 14.238zm.586-.005zm-26.01 7.765c-1.433 5.069-.342 11.262 3.225 15.586 3.834 4.647 9.268 8.974 14 12.16 2.354 1.585 4.5 2.865 6.136 3.74.821.439 1.492.764 1.983.973.154.066.28.116.38.153.1-.037.226-.087.38-.153.491-.21 1.162-.534 1.983-.973 1.636-.875 3.782-2.155 6.137-3.74 4.731-3.186 10.165-7.513 14-12.16 3.566-4.324 4.657-10.517 3.224-15.586-1.4-4.947-5.121-8.662-11.299-8.662-4.435 0-7.311 1.11-9.252 2.18-.837.461-1.501.913-2.117 1.332l-.361.245c-.338.227-.72.479-1.1.672-.356.182-.921.428-1.595.428-.674 0-1.239-.246-1.596-.428a10.998 10.998 0 01-1.099-.672c-.12-.08-.24-.162-.361-.245-.616-.419-1.28-.87-2.116-1.332-1.941-1.07-4.817-2.18-9.253-2.18-6.178 0-9.899 3.715-11.298 8.662zm25.487 32.688zm.46-.003z" fill="#979797"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/68/members"] = function anonymous(it) {
  var out='<svg width="68" height="68" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M24.084 12.167c-5.8 0-10.5 4.701-10.5 10.5 0 5.8 4.7 10.5 10.5 10.5s10.5-4.7 10.5-10.5c0-5.799-4.7-10.5-10.5-10.5zm-6.5 10.5a6.5 6.5 0 1113 0 6.5 6.5 0 01-13 0zm6.453 13.585c-5.636 0-10.164.977-13.565 2.986-3.464 2.046-5.61 5.08-6.566 8.831-.504 1.979-.271 4.333 1.25 6.217 1.539 1.907 4.099 2.967 7.51 2.967H35.408c3.529 0 6.189-.955 7.74-2.894l.056-.071c.222.085.463.131.715.131H56.879c2.707 0 4.884-.622 6.222-2.072 1.424-1.543 1.437-3.495.92-5.027-1.838-5.451-7.329-8.234-15.889-8.234-3.569 0-6.579.438-9.021 1.349a15.69 15.69 0 00-1.64-1.127c-3.389-2.028-7.865-3.056-13.434-3.056zm18.11 7.437a15.359 15.359 0 012.002 4.313c.222.76.355 1.582.35 2.417H56.878c2.248 0 3.055-.538 3.282-.785.142-.153.275-.43.07-1.035-1.019-3.02-4.216-5.513-12.099-5.513-2.395 0-4.373.217-5.984.603zM7.782 49.057c.708-2.776 2.225-4.899 4.725-6.376 2.563-1.514 6.3-2.43 11.53-2.43 5.117 0 8.81.951 11.38 2.49 2.524 1.51 4.097 3.663 4.892 6.383.355 1.215.19 2.14-.286 2.736-.483.605-1.703 1.393-4.616 1.393H12.667c-2.61 0-3.842-.79-4.4-1.48-.575-.712-.743-1.702-.485-2.716zm31.302-22.14a9.084 9.084 0 1118.167 0 9.084 9.084 0 11-18.167 0zm9.083-5.083a5.084 5.084 0 100 10.167 5.084 5.084 0 000-10.167z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/68/repost"] = function anonymous(it) {
  var out='<svg width="68" height="68" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M29.317 17.585c5.713 0 9.797.005 12.9.422 3.047.41 4.847 1.183 6.17 2.507 1.325 1.324 2.099 3.125 2.508 6.17.417 3.104.422 7.188.422 12.901v.529l-5.697-4.988a2 2 0 00-2.635 3.01l9.014 7.892a2 2 0 002.635 0l9.015-7.892a2 2 0 10-2.635-3.01l-5.697 4.988v-.68c0-5.528 0-9.881-.457-13.282-.47-3.49-1.453-6.275-3.644-8.466-2.19-2.191-4.976-3.174-8.465-3.643-3.401-.458-7.754-.458-13.282-.458H22.41a2 2 0 000 4h6.907zM12.683 27.887l-5.697 4.987a2 2 0 11-2.635-3.01l9.015-7.891a2 2 0 012.635 0l9.014 7.892a2 2 0 11-2.635 3.01l-5.697-4.988v.528c0 5.713.004 9.797.422 12.9.41 3.046 1.183 4.847 2.507 6.17 1.324 1.325 3.124 2.099 6.17 2.508 3.104.417 7.188.422 12.901.422h6.907a2 2 0 010 4h-7.059c-5.528 0-9.88 0-13.282-.458-3.49-.469-6.274-1.452-8.465-3.643-2.191-2.19-3.174-4.976-3.644-8.466-.457-3.4-.457-7.753-.457-13.281v-.68z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/68/switcher"] = function anonymous(it) {
  var out='<svg width="76" height="48" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0)"><path fill-rule="evenodd" clip-rule="evenodd" d="M0 24C0 10.745 10.745 0 24 0h27.79c13.254 0 24 10.745 24 24s-10.746 24-24 24H24C10.745 48 0 37.255 0 24z" fill="#F8E71C"/><g filter="url(#filter0_d)"><path fill-rule="evenodd" clip-rule="evenodd" d="M51.79 42.947c10.464 0 18.947-8.483 18.947-18.947 0-10.464-8.483-18.947-18.948-18.947-10.464 0-18.947 8.483-18.947 18.947 0 10.464 8.483 18.947 18.947 18.947z" fill="#fff"/></g></g><defs><clipPath id="clip0"><path fill="#fff" d="M0 0h75.79v48H0z"/></clipPath><filter id="filter0_d" x="30.842" y="4.053" width="41.895" height="41.895" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB"><feFlood flood-opacity="0" result="BackgroundImageFix"/><feColorMatrix in="SourceAlpha" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"/><feOffset dy="1"/><feGaussianBlur stdDeviation="1"/><feColorMatrix values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.4 0"/><feBlend in2="BackgroundImageFix" result="effect1_dropShadow"/><feBlend in="SourceGraphic" in2="effect1_dropShadow" result="shape"/></filter></defs></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/editor_specific/audio-editor-cut"] = function anonymous(it) {
  var out='<svg width="21" height="26" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10 0h9L9 26H0L10 0z" fill="#E5E5E5"/><path fill-rule="evenodd" clip-rule="evenodd" d="M12 0h9L11 26H2L12 0z" fill="#E5E5E5"/><path fill-rule="evenodd" clip-rule="evenodd" d="M11 0h9L10 26H1L11 0z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/editor_specific/frame-shifter-triangle"] = function anonymous(it) {
  var out='<svg width="8" height="4" xmlns="http://www.w3.org/2000/svg"><path fill="#FFF" d="M4 4l4-4H0z" fill-rule="evenodd"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/html5_player_specific/hand"] = function anonymous(it) {
  var out='<svg width="36" height="49" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M19.72 4.123c.11-1.237-.23-2.302-.932-3.055-.695-.745-1.665-1.099-2.644-1.066C14.14.07 12.232 1.69 11.758 4.58c-.76 4.634-.581 12.421.178 20.094a10.56 10.56 0 00-2.7-1.338c-1.673-.561-3.858-.835-5.67-.489-.91.174-1.813.521-2.495 1.157C.357 24.67-.036 25.586.003 26.7c.029.844.583 1.398 1.08 1.733.501.338 1.135.588 1.732.79.384.13.81.259 1.215.381l.004.002.007.002.623.19c.603.19 1.106.368 1.48.562.618.32 1.248.931 1.912 1.8.659.862 1.287 1.888 1.94 2.965l.08.132v.001c.616 1.017 1.257 2.075 1.931 2.978.445.597.936 1.171 1.484 1.638a.996.996 0 00-.089.412v5.391c0 .95.673 1.792 1.642 1.956 4.742.805 10.791.83 14.354.029.926-.209 1.504-1.037 1.504-1.91v-5.37-.023c.288-.175.554-.389.757-.654.484-.633.99-1.746 1.455-2.991.479-1.282.957-2.818 1.36-4.38.402-1.562.734-3.169.915-4.591.176-1.383.228-2.724-.023-3.678-.18-.69-.644-1.252-1.16-1.7-.525-.455-1.186-.862-1.903-1.225-1.436-.729-3.24-1.355-5.001-1.87-2.848-.83-5.697-1.4-6.959-1.634-.342-1.792-1.195-7.144-.624-13.513zm9.182 36.988c-.18.043-.364.084-.552.122-1.405.284-3.127.441-4.87.484-1.747.043-3.548-.028-5.117-.213-1.085-.128-2.12-.316-2.96-.585v4.747c4.538.767 10.258.771 13.5.057v-4.612zM13.732 4.904c.35-2.14 1.61-2.874 2.48-2.903.457-.015.85.148 1.113.43.256.275.47.75.402 1.513-.692 7.714.622 13.981.782 14.71a1.087 1.087 0 00.879.842c.483.083 3.93.696 7.353 1.695 1.716.5 3.383 1.086 4.657 1.732.638.324 1.142.645 1.498.953.365.317.499.555.536.697.145.553.145 1.56-.027 2.917-.167 1.317-.48 2.839-.868 4.344a42.804 42.804 0 01-1.297 4.18c-.464 1.243-.884 2.103-1.17 2.476-.032.042-.183.18-.59.35-.384.158-.898.306-1.526.433-1.255.253-2.853.404-4.523.445-1.667.04-3.372-.028-4.834-.2-1.499-.177-2.623-.45-3.208-.752-.552-.286-1.137-.864-1.779-1.725-.614-.825-1.21-1.809-1.845-2.855l-.002-.003-.057-.095c-.643-1.061-1.326-2.181-2.06-3.142-.73-.953-1.575-1.84-2.582-2.362-.542-.28-1.19-.502-1.801-.694-.24-.075-.472-.145-.697-.213l-.006-.002a33.796 33.796 0 01-1.103-.346c-.568-.193-.988-.373-1.256-.554a.79.79 0 01-.2-.172c-.013-.543.165-.885.435-1.137.308-.287.809-.521 1.505-.654 1.4-.268 3.231-.059 4.659.42 1.55.52 2.508 1.258 3.067 1.805.28.274.468.508.59.664l.016.021c.043.056.13.17.201.241.023.023.096.097.204.164l.003.001c.05.032.485.301.994.038.482-.25.532-.73.538-.784v-.003c.014-.12.003-.22-.001-.253-.99-8.455-1.282-17.335-.48-22.222zM1.991 26.586l.004.01-.005-.01z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/html5_player_specific/logo"] = function anonymous(it) {
  var out='<svg width="38" height="38" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M38 19c0 10.493-8.507 19-19 19-.503 0-1.003-.02-1.496-.058l1.869-5.135c.308-.848 1.336-1.983 2.245-2.986l.007-.007c.52-.573.97-1.07 1.142-1.361a1635.64 1635.64 0 013.329-5.605l.047-.08a74.289 74.289 0 001.864-2.846l2.803-4.553c.513-.833.552-1.877.087-2.328a.803.803 0 00-.285-.178c-.514-.186-1.196.117-1.7.755l-2.816 3.929c-.326.413-.69.753-1.043 1.081-.294.274-.597.558-.868.873l-.288.337a.197.197 0 01-.137.068.363.363 0 01-.15-.02c-.1-.036-.262-.15-.218-.508l.001-.004c.024-.107.48-2.122-.806-2.665l-.057-.022c-.707-.258-1.27.184-1.895.928-.094.112-.286.122-.383.087a.37.37 0 01-.232-.447c.223-.997-.188-1.93-.978-2.217l-.06-.02c-.688-.221-1.517.061-2.014.688a.2.2 0 01-.065.054c-.099.094-.268.225-.453.158-.197-.072-.244-.312-.262-.487l-.022-.217c-.021-.215-.05-.463-.08-.729l-.001-.008c-.1-.869-.222-1.947-.202-2.664l.303-5.112c.021-.747-.322-1.383-.854-1.577a.995.995 0 00-.47-.051c-.752.096-1.398.949-1.47 1.94l-.559 5.17c-.038.523-.026 1.254-.014 1.96v.001c.009.524.017 1.02.005 1.42l-.049 1.648c-.017.555-.194.953-.528 1.183-.183.13-.801.573-1.47 1.197-.063.059-.127.116-.19.171l-.03.027c-.494.437-.92.815-.96 2.069-.022.589.005 1.187.09 2.067.089.923.362 1.502.651 2.115.047.1.099.204.154.314.425.857 1.006 2.028.523 3.356l-1.989 5.464C3.61 31.828 0 25.835 0 19 0 8.507 8.507 0 19 0s19 8.507 19 19z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/html5_player_specific/logo_hover"] = function anonymous(it) {
  var out='<svg width="38" height="38" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h38v38H0z"/><path fill-rule="evenodd" clip-rule="evenodd" d="M38 19c0 10.493-8.507 19-19 19-.504 0-1.003-.02-1.496-.058l1.869-5.135c.308-.848 1.336-1.983 2.245-2.986l.007-.007c.52-.573.97-1.07 1.142-1.361.827-1.41 3.35-5.642 3.376-5.685a74.289 74.289 0 001.864-2.846l2.803-4.553c.513-.833.552-1.877.087-2.328a.803.803 0 00-.285-.178c-.514-.186-1.196.117-1.7.755l-2.816 3.929c-.326.414-.69.753-1.044 1.082-.293.273-.596.556-.867.872l-.288.337a.2.2 0 01-.137.068.363.363 0 01-.15-.02c-.1-.036-.262-.15-.218-.508l.001-.004c.024-.107.48-2.122-.806-2.665l-.057-.022c-.707-.258-1.27.184-1.895.928-.094.112-.286.122-.383.087a.37.37 0 01-.232-.447c.223-.997-.188-1.93-.978-2.217l-.06-.02c-.688-.221-1.517.061-2.014.688a.2.2 0 01-.065.054c-.099.094-.268.225-.453.158-.197-.072-.244-.312-.262-.487l-.022-.217c-.021-.215-.05-.463-.08-.729l-.001-.008c-.099-.868-.222-1.947-.202-2.664l.303-5.112c.021-.747-.322-1.383-.854-1.577a.995.995 0 00-.47-.051c-.752.096-1.398.949-1.47 1.94l-.559 5.17c-.038.523-.026 1.254-.014 1.96v.001c.009.524.017 1.02.005 1.42l-.049 1.648c-.017.555-.194.953-.528 1.183-.183.13-.801.573-1.47 1.197-.073.068-.147.134-.22.198-.494.437-.92.815-.96 2.069-.022.589.005 1.187.09 2.067.089.923.362 1.502.651 2.115.047.1.099.204.154.314.425.857 1.006 2.028.523 3.356l-1.989 5.464C3.61 31.828 0 25.835 0 19 0 8.507 8.507 0 19 0s19 8.507 19 19z" fill="#0332FF"/><path fill-rule="evenodd" clip-rule="evenodd" d="M17.504 37.942l1.869-5.135c.308-.848 1.336-1.983 2.245-2.986l.007-.007c.52-.573.97-1.07 1.142-1.361.827-1.41 3.35-5.642 3.376-5.685a74.132 74.132 0 001.864-2.846l2.803-4.553c.513-.832.552-1.877.087-2.328a.802.802 0 00-.285-.177c-.514-.188-1.196.116-1.7.754l-2.816 3.929c-.326.414-.69.753-1.044 1.082-.293.273-.596.557-.867.872l-.288.337a.196.196 0 01-.137.069.365.365 0 01-.15-.02c-.1-.037-.262-.152-.218-.51l.001-.003c.024-.107.48-2.122-.806-2.665l-.057-.022c-.707-.258-1.27.184-1.895.928-.094.112-.286.122-.383.087a.37.37 0 01-.232-.447c.223-.997-.188-1.93-.978-2.217l-.06-.02c-.688-.221-1.517.061-2.014.688a.2.2 0 01-.065.054c-.099.094-.268.225-.453.158-.197-.072-.244-.312-.262-.487l-.022-.217c-.021-.215-.05-.463-.08-.729l-.001-.008c-.099-.868-.222-1.947-.202-2.664l.303-5.112c.021-.747-.322-1.383-.854-1.577a.995.995 0 00-.47-.051c-.752.096-1.398.949-1.47 1.94l-.559 5.17c-.038.523-.026 1.254-.014 1.96v.001c.009.524.017 1.02.005 1.42l-.049 1.648c-.017.555-.194.953-.528 1.183-.183.13-.801.573-1.47 1.197-.073.068-.147.134-.22.198-.494.437-.92.815-.96 2.069-.022.589.005 1.187.09 2.067.089.923.362 1.502.651 2.115.047.1.099.204.154.314.425.857 1.006 2.028.523 3.356l-1.989 5.464a18.886 18.886 0 008.478 2.767z" fill="#fff"/><path fill-rule="evenodd" clip-rule="evenodd" d="M38 19c0 10.493-8.507 19-19 19-.504 0-1.003-.02-1.496-.058l1.869-5.135c.308-.848 1.336-1.983 2.245-2.986l.007-.007c.52-.573.97-1.07 1.142-1.361.827-1.41 3.35-5.642 3.376-5.685a74.289 74.289 0 001.864-2.846l2.803-4.553c.513-.833.552-1.877.087-2.328a.803.803 0 00-.285-.178c-.514-.186-1.196.117-1.7.755l-2.816 3.929c-.326.414-.69.753-1.044 1.082-.293.273-.596.556-.867.872l-.288.337a.2.2 0 01-.137.068.363.363 0 01-.15-.02c-.1-.036-.262-.15-.218-.508l.001-.004c.024-.107.48-2.122-.806-2.665l-.057-.022c-.707-.258-1.27.184-1.895.928-.094.112-.286.122-.383.087a.37.37 0 01-.232-.447c.223-.997-.188-1.93-.978-2.217l-.06-.02c-.688-.221-1.517.061-2.014.688a.2.2 0 01-.065.054c-.099.094-.268.225-.453.158-.197-.072-.244-.312-.262-.487l-.022-.217c-.021-.215-.05-.463-.08-.729l-.001-.008c-.099-.868-.222-1.947-.202-2.664l.303-5.112c.021-.747-.322-1.383-.854-1.577a.995.995 0 00-.47-.051c-.752.096-1.398.949-1.47 1.94l-.559 5.17c-.038.523-.026 1.254-.014 1.96v.001c.009.524.017 1.02.005 1.42l-.049 1.648c-.017.555-.194.953-.528 1.183-.183.13-.801.573-1.47 1.197-.073.068-.147.134-.22.198-.494.437-.92.815-.96 2.069-.022.589.005 1.187.09 2.067.089.923.362 1.502.651 2.115.047.1.099.204.154.314.425.857 1.006 2.028.523 3.356l-1.989 5.464C3.61 31.828 0 25.835 0 19 0 8.507 8.507 0 19 0s19 8.507 19 19z" fill="#0332FF"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/html5_player_specific/prev"] = function anonymous(it) {
  var out='<svg width="32" height="32" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.707 11.707a1 1 0 00-1.414-1.414l-5 5a1 1 0 000 1.414l5 5a1 1 0 001.414-1.414L11.414 17H23a1 1 0 100-2H11.414l3.293-3.293z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/html5_player_specific/prev_hover"] = function anonymous(it) {
  var out='<svg width="32" height="32" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M16 32C7.163 32 0 24.837 0 16S7.163 0 16 0s16 7.163 16 16-7.163 16-16 16zm-1.293-21.707a1 1 0 010 1.414L11.414 15H23a1 1 0 110 2H11.414l3.293 3.293a1 1 0 11-1.414 1.414l-5-5a1 1 0 010-1.414l5-5a1 1 0 011.414 0z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/html5_player_specific/replay"] = function anonymous(it) {
  var out='<svg width="32" height="32" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M15.707 8.707a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L14.414 12H16a5.5 5.5 0 11-5.5 5.5 1 1 0 10-2 0A7.5 7.5 0 1016 10h-1.586l1.293-1.293z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/html5_player_specific/replay_hover"] = function anonymous(it) {
  var out='<svg width="32" height="32" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M16 32C7.163 32 0 24.837 0 16S7.163 0 16 0s16 7.163 16 16-7.163 16-16 16zm-.293-24.707a1 1 0 010 1.414L14.414 10H16a7.5 7.5 0 11-7.5 7.5 1 1 0 112 0A5.5 5.5 0 1016 12h-1.586l1.293 1.293a1 1 0 01-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/html5_player_specific/share_copy"] = function anonymous(it) {
  var out='<svg width="44" height="44" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M22 44c12.15 0 22-9.85 22-22S34.15 0 22 0 0 9.85 0 22s9.85 22 22 22zm-2.121-26.95a1 1 0 001.414 1.414l2.828-2.828a2 2 0 012.829 0l1.414 1.414a2 2 0 010 2.829l-2.829 2.828a1 1 0 001.415 1.414l2.828-2.828a4 4 0 000-5.657l-1.414-1.414a4 4 0 00-5.657 0L19.88 17.05zM17.05 19.88a1 1 0 011.415 1.414l-2.829 2.828a2 2 0 000 2.829l1.414 1.414a2 2 0 002.829 0l2.828-2.829a1 1 0 011.414 1.415l-2.828 2.828a4 4 0 01-5.657 0l-1.414-1.414a4 4 0 010-5.657l2.828-2.828zm1.06 6.01a1 1 0 010-1.414l6.365-6.364a1 1 0 111.414 1.414l-6.364 6.364a1 1 0 01-1.414 0z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/html5_player_specific/share_copy_done"] = function anonymous(it) {
  var out='<svg width="44" height="44" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M22 44c12.15 0 22-9.85 22-22S34.15 0 22 0 0 9.85 0 22s9.85 22 22 22zm-2.121-26.95a1 1 0 001.414 1.414l2.828-2.828a2 2 0 012.829 0l1.414 1.414a2 2 0 010 2.829l-.125.124a7.979 7.979 0 012.22.382 4.002 4.002 0 00-.68-4.749l-1.415-1.414a4 4 0 00-5.657 0L19.88 17.05zm.124 11.189c.023.773.155 1.518.382 2.22a4.002 4.002 0 01-4.749-.68l-1.414-1.415a4 4 0 010-5.657l2.828-2.828a1 1 0 011.415 1.414l-2.829 2.828a2 2 0 000 2.829l1.414 1.414a2 2 0 002.829 0l.124-.125zm4.704-7.532a8.031 8.031 0 00-4 4l-1.182 1.182a1 1 0 01-1.414-1.414l6.364-6.364a1 1 0 111.414 1.414l-1.182 1.182zM28 34a6 6 0 100-12 6 6 0 000 12zm3.723-7.31a1 1 0 00-1.446-1.38l-3.095 3.242-1.459-1.528a1 1 0 10-1.446 1.38l2.181 2.287a1 1 0 001.447 0l3.818-4z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/html5_player_specific/share_download"] = function anonymous(it) {
  var out='<svg width="44" height="44" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M22 44c12.15 0 22-9.85 22-22S34.15 0 22 0 0 9.85 0 22s9.85 22 22 22zm-6-14a1 1 0 011-1h10a1 1 0 110 2H17a1 1 0 01-1-1zm1.707-9.207a1 1 0 10-1.414 1.414l5 5a1 1 0 001.414 0l5-5a1 1 0 10-1.414-1.414L23 24.086V14a1 1 0 10-2 0v10.086l-3.293-3.293z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/html5_player_specific/share_facebook"] = function anonymous(it) {
  var out='<svg width="44" height="44" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M22 44c12.15 0 22-9.85 22-22S34.15 0 22 0 0 9.85 0 22s9.85 22 22 22zm0-33.5c-6.351 0-11.5 5.149-11.5 11.5 0 5.706 4.156 10.442 9.606 11.345a12.302 12.302 0 01-.137-.024v-8.203H17.93v-2.674h2.039V20.42c0-1.887 1.138-3.783 4.043-3.783.89 0 1.533.063 1.848.093.101.01.168.016.198.016l.054 2.788s-.887-.008-1.855-.008c-1.048 0-1.215.467-1.215 1.242v1.677h3.016v2.674h-3.016v8.335C28.905 32.927 33.5 28 33.5 22c0-6.351-5.149-11.5-11.5-11.5z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/html5_player_specific/share_other"] = function anonymous(it) {
  var out='<svg width="44" height="44" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M22 44c12.15 0 22-9.85 22-22S34.15 0 22 0 0 9.85 0 22s9.85 22 22 22zm-4.5-22a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm6.75 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm4.5 2.25a2.25 2.25 0 100-4.5 2.25 2.25 0 000 4.5z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/html5_player_specific/share_twitter"] = function anonymous(it) {
  var out='<svg width="44" height="44" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M22 44c12.15 0 22-9.85 22-22S34.15 0 22 0 0 9.85 0 22s9.85 22 22 22zm8.026-27.281a8.567 8.567 0 002.474-.684 8.788 8.788 0 01-2.15 2.247c.008.186.013.373.013.562 0 5.735-4.334 12.35-12.259 12.35-2.433 0-4.697-.72-6.604-1.951.337.04.68.06 1.028.06a8.603 8.603 0 005.35-1.858 4.317 4.317 0 01-4.024-3.014 4.279 4.279 0 001.946-.074 4.335 4.335 0 01-3.457-4.256v-.055c.582.325 1.246.52 1.952.543a4.347 4.347 0 01-1.916-3.612c0-.796.212-1.542.583-2.183 2.125 2.627 5.3 4.354 8.88 4.535a4.387 4.387 0 01-.111-.989c0-2.397 1.929-4.34 4.308-4.34 1.24 0 2.36.527 3.145 1.37a8.586 8.586 0 002.736-1.053 4.35 4.35 0 01-1.894 2.402z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/icons/html5_player_specific/share_vkontakte"] = function anonymous(it) {
  var out='<svg width="44" height="44" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M22 44c12.15 0 22-9.85 22-22S34.15 0 22 0 0 9.85 0 22s9.85 22 22 22zm8.574-27c.668 0 .809.344.668.813-.28 1.288-2.974 5.081-2.974 5.081-.234.375-.328.563 0 .984.115.162.362.403.644.68.29.283.617.604.878.913.95 1.068 1.665 1.969 1.865 2.59.182.623-.134.939-.765.939h-2.211c-.592 0-.89-.332-1.534-1.048-.274-.304-.609-.677-1.055-1.123-1.311-1.265-1.873-1.429-2.201-1.429-.445 0-.578.126-.614.758v1.982c.036.544-.138.86-1.543.86-2.342 0-4.916-1.422-6.743-4.045-2.74-3.84-3.489-6.744-3.489-7.33 0-.328.126-.625.758-.625h2.21c.565 0 .778.247.99.86 1.08 3.149 2.904 5.901 3.653 5.901.281 0 .41-.13.414-.843v-3.255c-.053-.926-.377-1.327-.617-1.624-.149-.184-.265-.327-.265-.53 0-.248.211-.509.562-.509h3.474c.468 0 .596.25.596.813v4.379c.028.468.239.632.38.632.28 0 .515-.164 1.03-.679 1.592-1.78 2.716-4.52 2.716-4.52.141-.328.4-.625.962-.625h2.21z" fill="#fff"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/svg/new"] = function anonymous(it) {
  var out='<svg width="40" height="40" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M20 2c9.941 0 18 8.059 18 18s-8.059 18-18 18S2 29.941 2 20 10.059 2 20 2zm0-2C8.954 0 0 8.954 0 20s8.954 20 20 20 20-8.954 20-20S31.046 0 20 0zm0 13a1 1 0 00-1 1v5h-5a1 1 0 100 2h5v5a1 1 0 102 0v-5h5a1 1 0 100-2h-5v-5a1 1 0 00-1-1z" fill="#999"/></svg>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/timeline/list"] = function anonymous(it) {
  var out='';  var attrsObj = _.extend({'clientside-timeline': true}, it), attrs = _.map(attrsObj, function(v, k) { return v === true && k || (k + '="' + v + '"'); }).join(' ');out+='<div class="coubs-list" '+(attrs)+'> <div class="coubs-list__inner"> <div class="initial-load-indicator"></div> </div> <div class="next-page-load-indicator"></div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/timeline/list_nav_tooltip"] = function anonymous(it) {
  var out='<div class="nav-tooltip -centered-text"> <div tooltip-next-coub class="nav-tooltip__control nav-tooltip__control--next -ribbon"></div> <div tooltip-prev-coub class="nav-tooltip__control nav-tooltip__control--prev -ribbon"></div> <div tooltip-next-coub class="nav-tooltip__control nav-tooltip__control--space -ribbon">Space</div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/timeline/no_coubs_stub"] = function anonymous(it) {
  var out='';  var text = undefined; if(it.text){ text = it.text; }else{ text = I18n.t("profile.no_coubs_available", {user: it.username}); }out+='<h1 class="hthin -centered-text no-coubs-stub">'+(text)+'</h1>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/timeline/page"] = function anonymous(it) {
  var out=''; out+='<div class=\'page\' data-page-id=\''+(it.pageNum)+'\'> ';if(it.timeline === 'best2014_tags'){out+=' <h5 class=\'best-2014__tag fbold page-'+(it.pageNum)+'\'> <a href=\'/tags/'+(it.extra.tag_title)+'?from_best_2014_page\'>'+(it.extra.tag_title)+'</a> </h5> ';}else if(it.timeline === 'best2015_memes'){out+=' <h5 class=\'best-2015__meme greg page-'+(it.pageNum)+' -color--black\'>'+(it.extra.meme_title)+'</h5> ';}else if(it.timeline === 'best2016_memes'){out+=' <h5 class=\'best-2016__meme page-'+(it.pageNum)+' -color--black\'>'+(it.extra.meme_title)+'</h5> ';}out+='</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/absolute_dropdown/absolute_dropdown"] = function anonymous(it) {
  var out=''; out+='<div class="dropdown '+(it.classes||'')+' -hidden"> <div class=\'dropdown__content\'>'+(it.content||'')+'</div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/absolute_dropdown_with_handler/absolute_dropdown_with_handler"] = function anonymous(it) {
  var out=''; out+='<div class="'+(it.dClass||'')+'" '+(it.attrs||'')+'> <div class="dropdown__handler '+(it.hClass||'')+'"> '+( it.handler||'')+' </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/after_action_panel/after_action_panel"] = function anonymous(it) {
  var out='<div class="coub__like-banner"> <img '+(it.userpic)+' width="26" height="26" class="image -rounded"> '+(I18n.t('coub.liked_by'))+'<strong>'+(it.name)+'</strong></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/black_drop/black_drop"] = function anonymous(it) {
  var out='<div class="blackdrop "> <div class="blackdrop__overlay"></div> ';var arr1=it.els;if(arr1){var el,i=-1,l1=arr1.length-1;while(i<l1){el=arr1[i+=1];out+=' <div class="blackdrop__helper '+(el.classes || '')+'"> ';if(el.title){out+=' <h1 class="blackdrop__title">'+(el.title)+'</h1> ';}out+=' </div> ';} } out+='</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/buttons/simple_button"] = function anonymous(it) {
  var out=''; if(typeof it === "undefined"){ it={}; } var type = it.type !== undefined && it.type !== null ? it.type : 'button'; if(it.value === undefined){ it.value = ""; }; if(it.attrs === undefined){ it.attrs = ""; };out+='<button type="'+(type)+'" class="sb '+(it.classes)+'" '+(it.attrs)+'> '+(it.value)+'</button>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/date_select/date_dropdown"] = function anonymous(it) {
  var out='<div class="dropdown '+(it.type)+'-select box--inline '+(it.cls || "")+'"> <div class="dropdown__handler"> <input class="sb -sq date-select__input '+(it.type)+'-input" type="text" value="'+(it.value)+'"> <i></i> </div> <div class="dropdown__inner " style="display: none"> <div class="dropdown__content"> ';if(it.type != 'day'){out+=' <div class="niceScroller" data-scroll-type="vertical"> <ul class="list list--selectable '+(it.type)+'s-list"> </ul> </div> ';}else{out+=' <div class="matrix '+(it.type)+'s-list"></div> ';}out+=' </div> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/date_select/time_input"] = function anonymous(it) {
  var out='<div class="date-select__time sb -sq hbold date-select__input time-select box--inline"> <input class="hour-input box--vertical" type="text" value="'+(it.hour)+'" maxlength="2" pattern="\\d{2}" />'; out+='<span className="box--vertical">:</span>'; out+='<input class="minute-input box--vertical" type="text" value="'+(it.minute)+'" maxlength="2" pattern="\\d{2}" /></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/dropdown/list"] = function anonymous(it) {
  var out='<div class="list-wrap '+(it.classes || '')+'" '+(it.attrs || '')+'> <ul class="list list--selectable '+(it.type)+'" data-scroll-type="vertical"> ';var arr1=it.choices;if(arr1){var value,index=-1,l1=arr1.length-1;while(index<l1){value=arr1[index+=1];out+=' ';if(typeof value == 'string'){out+=' <li class="list__item list__item-beta">'+(value)+'</li> ';}else{out+=' <li class="list__item list__item-beta" data-attr="'+(value.attr)+'">'+(value.value)+'</li> ';}out+=' ';} } out+=' </ul></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/dropdown_with_handler/dropdown_with_handler"] = function anonymous(it) {
  var out=''; out+='<div class="dropdown '+(it.dClass||'')+'" '+(it.attrs||'')+'> <div class="dropdown__handler '+(it.hClass||'')+'"> '+(it.handler||'')+' </div> ';if(it.content){out+=' <div class="dropdown__inner -hidden '+(it.cClass||'')+'"> <div class="dropdown__content"> '+(it.content)+' </div> </div> ';}out+='</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/follow_button/follow_button_init"] = function anonymous(it) {
  var out='';  var it = it || {}, followedFrom = it.followedFrom ? 'data-followed-from="' + it.followedFrom + '"' : '', btnCls = it.btnCls ? 'data-btn-cls="'+it.btnCls+'"' : '', ddCls = it.ddCls ? 'data-dd-cls="'+it.ddCls+'"' : '';out+='<div class="follow-btn '+(it.classes||'')+'" data-channel-id="'+(it.channelId)+'" data-following="'+((it.followedFrom && it.followedFrom.length > 0) || it.iFollow || false)+'" '+(followedFrom)+' '+(btnCls)+' '+(ddCls)+' auto-init widget-follow-button-init></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/follow_button/follow_button_multi"] = function anonymous(it) {
  var out='';  var classes = '', text = it.following ? I18n.t('profile.following') : I18n.t('profile.follow'), followedFrom = typeof(it.followedFrom) !== 'undefined' ? 'data-followed-from="' + it.followedFrom + '"' : '', ddClasses = it.ddClasses ? 'data-dd-cls="' + it.ddClasses + '"' : '', longestText = helpers.Application.getLongestFollowButtonText(); if (it.classes) classes += it.classes; if (it.following) classes += ' following -on';out+='<div class="follow-button__container '+(it.following ? 'following' : '')+'"> <div class="follow-button__left"> <button type="button" class="sb -follow '+(classes)+'" auto-init widget-follow-button handler data-channel-id="'+(it.channelId)+'" '+(followedFrom)+' '+(ddClasses)+'> <span class="text">'+(text)+'</span> <div class="text-dummy">'+(longestText)+'</div> </button> </div> <div class="follow-button__right"> <button type="button" class="sb dropdown__handler '+(classes)+'"> '+(JST['app/site/templates/svg/icons/16/down']())+' </button> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/follow_button/follow_button_single"] = function anonymous(it) {
  var out='';  var classes = '', text = it.following ? I18n.t('profile.following') : I18n.t('profile.follow'), longestText = helpers.Application.getLongestFollowButtonText(); if (it.classes) classes += it.classes; if (it.following) classes += ' following -on';out+='<div class="follow-button__container '+(it.following ? 'following' : '')+'"> <button type="button" data-channel-id="'+(it.channelId)+'" auto-init widget-follow-button class="sb -follow '+(classes)+'"> <span class="text">'+(text)+'</span> <div class="text-dummy">'+(longestText)+'</div> </button></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/follow_button/followers_absolute_dropdown"] = function anonymous(it) {
  var out='<div class="dd-follower-list list-wrap" data-scroll-type="vertical"></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/follow_button/followers_list_dropdown"] = function anonymous(it) {
  var out=''; out+='<ul class="list list--selectable"> ';var arr1=it.channels;if(arr1){var channel,index=-1,l1=arr1.length-1;while(index<l1){channel=arr1[index+=1];out+=' '; var classes = ['list__item', 'list__item-gamma']; if (it.followedFrom.indexOf(channel.id) !== -1) classes.push('following -on'); out+=' <li auto-init widget-follow-button data-channel-id="'+(it.channelId)+'" class="'+(classes.join(' '))+'" data-from-id="'+(channel.id)+'" data-sort="'+(index)+'"> <img '+(helpers.Application.specificImgVersion(channel, 'avatar_versions', 'small'))+' class="image -rounded" width="40" height="40" /> <div class="-truncate-text"> <span class="actionTo">by</span> '+(channel.title)+' </div> </li> ';} } out+='</ul>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/follow_popup/follow_popup"] = function anonymous(it) {
  var out='';  if(typeof(it) == "undefined"){ it={}; } if(!it.channel){throw "follow_popup.jst.djs: Channel is undefined!"}; if(!it.user){throw "follow_popup.jst.djs: User is undefined!"}; var c = it.channel, u = it.user; var avatar = helpers.Application.specificImgVersion(c, "avatar_versions", "medium");out+='<h3 class="hthin">'+(I18n.follow_confirmation.confirm)+'</h3><div class="object-media om-gutter--beta"> <div class="object-media__img"> <img width="48px" height="48px" '+(avatar)+' class="image -rounded"> </div> <div class="object-media__body"> '+( JST["app/site/templates/widgets/follow_button/follow_button_init"]({ channelId: c.id, iFollow: false, btnCls: '' }) )+' <h5 class="hbold -truncate-text">'+(c.title)+'</h5> <p>'+(c.followers_count)+' followers</p> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/like_recoub_counter/counter"] = function anonymous(it) {
  var out=''; out+='<div counter-value data-val="'+(it.value)+'"> '+(it.value)+'</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/like_recoub_counter/like_recoub_counter"] = function anonymous(it) {
  var out='';  switch (it.type) { case "Like": dropdownWidgetAttr = "block-likes-list-dropdown data-small-follow='true'"; break; case "Dislike": dropdownWidgetAttr = ""; break; case "Recoub": dropdownWidgetAttr = "block-recoubs-list-dropdown data-small-follow='true'"; break; case "Remix": dropdownWidgetAttr = "block-remixes-list-dropdown"; break; default: throw("like_recoub_counter.djs: can't find values for type", it.type); } var attrs = dropdownWidgetAttr + ' auto-init="true" data-id="'+it.id+'"' + it.attrs;out+='<div widget-counter auto-init="true" class="counter" '+(attrs)+' type="'+(it.cardType)+'"> <div class="dropdown__handler"> '+(JST["app/site/templates/widgets/like_recoub_counter/counter"](it))+' </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/make_another_coub_button/make_another_coub_button"] = function anonymous(it) {
  var out=''; out+='<a class="sb -st -rn make-coub '+(it.classes || '')+'" href="'+(it.url)+'" rel="nofollow" target="_blank"> '+( I18n.t('coub.make_another') )+' <i></i></a>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/multipage_dialog/multipage_dialog"] = function anonymous(it) {
  var out='<div class="dialog '+(it.dClass)+'"> <div class="dialog__navigation"> <div class="back" style="display:none">Back</div> </div> <div class="dialog__pages"> ';var arr1=it.data;if(arr1){var page,index=-1,l1=arr1.length-1;while(index<l1){page=arr1[index+=1];out+=' '+( JST[page.route]({ startPage: it.startId == page.id ? 'start-page=true' : '' }) )+' ';} } out+=' </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/registration_form/registration_form"] = function anonymous(it) {
  var out=''; var buttons = GlobalState.COUNTRY.isExUssr() ? ["facebook","vkontakte"] : ["facebook","twitter"];out+='<div class="registration-form"> <h2> ';if(window.location.pathname == '/vine'){out+=' '+( I18n.t("vine_import.signup_title") )+' ';}else{out+=' '+( I18n.t("mail_registration_form.popup_title") )+' ';}out+=' </h2> <div class="registration-form__social"> <button class="phone -bg-color--phone sb -sq box--inline -ribbon -social -fs16" data-auth-button="firebase">'+(I18n.t("auth_popup.signup.with_phone"))+'</button> ';var arr1=buttons;if(arr1){var p,index=-1,l1=arr1.length-1;while(index<l1){p=arr1[index+=1];out+=' <button class="'+(p)+' -bg-color--'+(p)+' sb -sq box--inline -ribbon -social -fs16 -centered-icon" data-auth-button="'+(p)+'"></button> ';} } out+=' </div> <hr/> <form class="email-registration-form" widget-email-registration-form> <div class="registration-form__form" > <div class="input-field-group"> <input id="email" name="email" placeholder="Email" type="email" autocomplete="off"/> <input id="name" name="name" placeholder="Username" autocomplete="off"/> <input id="password" name="password" placeholder="Password" type="password" autocomplete="off"/> </div> <div class="registration-form__captcha"></div> <div class="registration-form__error -error-text"></div> </div> <div class="registration-form__submit"> <button class="sb -st -blue -flat -sq -sb-gamma -w100p" submit type="button">'+( I18n.t("mail_registration_form.sign_up_btn") )+'</button> </div> </form> <p class="registration-form__text"> '+( I18n.t("mail_registration_form.have_an_account") )+' </p> <div class="registration-form__note"> <p> '+( I18n.t("mail_registration_form.legal_note_1", {tos_url: "/tos", privacy_policy_url: "/privacy"}) )+' </p> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/search_popup/recent_search"] = function anonymous(it) {
  var out='<div dropdown-search class="search-popup__recent"> <div class="search-popup__recent__head -clear"> <div class="search-popup__recent__clear-all" data-clear-recent>'+( I18n.t('search_popup.recent_search.clear_all') )+'</div> <div>'+( I18n.t('search_popup.recent_search.title') )+'</div> </div> <ul class="search-popup__recent__list"> ';var arr1=it;if(arr1){var value,index=-1,l1=arr1.length-1;while(index<l1){value=arr1[index+=1];out+=' '+(JST["app/site/templates/widgets/search_popup/recent_search_item"](value))+' ';} } out+=' </ul></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/search_popup/recent_search_item"] = function anonymous(it) {
  var out=''; var urlPath; var itemTitle; if (it.log_type == 'channel') { urlPath = '/' + it.value; itemTitle = it.title; } else if (it.log_type == 'tag') { urlPath = '/tags/' + it.value; itemTitle = '#'+it.value; }out+='<li data-item-id="'+(it.id)+'" data-log-type="search"> ';if(it.query){out+=' <a href="'+(Routes.search_path({q: it.query}))+'" class="-truncate-text">'+(it.query)+'</a> ';}else{out+=' <a href="'+(urlPath)+'" class="-truncate-text">'+(itemTitle)+'</a> ';}out+=' <span class="search-popup__recent__delete" data-item-id="'+(it.id)+'" data-delete-item> '+(JST["app/site/templates/svg/icons/16/close"]())+' </span></li>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/search_popup/search_channel"] = function anonymous(it) {
  var out='';var arr1=it;if(arr1){var value,index=-1,l1=arr1.length-1;while(index<l1){value=arr1[index+=1];out+=' '; var followers_count = value.followers_count, followers_count_text =  followers_count + ' follower' + (followers_count === 1 ? '' : 's'); out+=' <li class="search-popup__channel list__item object-media" data-log-value="'+(value.permalink)+'" data-log-type="channel"> <a href="/'+(value.permalink)+'" class="box"> <div class="object-media__img"> <img src="'+(value.avatar_retina)+'" alt="'+(value.title)+'" class="image -rounded" width="32" height="32"/> </div> <div class="object-media__body"> <div class="search-popup__channel__title -truncate-text" title="'+(value.title)+'">'+(value.title)+'</div> ';if(followers_count !== 0){out+=' <div class="search-popup__channel__followers -truncate-text">'+(followers_count_text)+'</div> ';}out+=' </div> </a> </li>';} } return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/search_popup/search_results"] = function anonymous(it) {
  var out='<div dropdown-search class="search-popup__results"> <ul class="search-popup__result__list list list--selectable"></ul> <ul> <li data-log-type="search"> <a data-more-results href="" class="search-popup__results__more -truncate-text">'+( I18n.t('search_popup.search_results.title') )+'<strong></strong></a> </li> <li data-log-type="search"> <a data-goto-coub href="" class="search-popup__results__more -truncate-text -hidden">'+( I18n.t('search_popup.search_results.view_coub_title') )+'<strong></strong></a> </li> </ul></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/search_popup/search_tag"] = function anonymous(it) {
  var out='';var arr1=it;if(arr1){var value,index=-1,l1=arr1.length-1;while(index<l1){value=arr1[index+=1];out+='<li class="search-popup__tag" data-log-value="'+(value.title)+'" data-log-type="tag"> <a href="/tags/'+(value.title)+'" class="-truncate-text">#'+(value.title)+'</a></span></li>';} } return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/sharing/custom_sharing_button"] = function anonymous(it) {
  var out='';  if(it.provider===undefined){ throw("custom_sharing_button.jst: it requires a provider") } var classes = it.provider.name + " "; if(!it.active){ classes+="disabled"; }out+='<button custom-sharing-button class="sb -st -sq sharing-block__button '+(classes)+'" data-custom-sharing="'+(it.provider.name)+'" data-url="'+(it.url)+'" data-encoded-title="'+(encodeURIComponent(it.message))+'" data-img="'+(it.imgUrl)+'" type="button"></button>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/sharing/sharing_block"] = function anonymous(it) {
  var out='';  if(it===undefined){ throw("sharing.jst.djs: It require params in order to work"); } if(it.active===undefined){ it.active=true; } if(it.providers===undefined){ it.providers=SocialSharingDataProvider.getDefaultProvidersOrder(); }out+='<div class="sharing-block" widget-sharing> ';var arr1=it.providers;if(arr1){var value,index=-1,l1=arr1.length-1;while(index<l1){value=arr1[index+=1];out+=' '+(JST["app/site/templates/widgets/sharing/custom_sharing_button"]( {provider: value, url: it.url, message: it.message, imgUrl: it.imgUrl, active: it.active}) )+' ';} } out+='</div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/tooltip/growl"] = function anonymous(it) {
  var out='<div class="tooltip tooltip--growl '+(it.className)+'"> <div class="tooltip__inner"> <h5 class="hbold">'+(it.heading)+'</h5> <p>'+(it.description)+'</p> <i class="growl__icon"></i> </div></div>';return out;
  };
}).call(this);
(function() { this.JST || (this.JST = {}); this.JST["app/site/templates/widgets/tooltip/tooltip"] = function anonymous(it) {
  var out='<div class="tooltip tooltip--simple '+(it.type)+'"> <div class="tooltip__inner"> '+(it.content)+' </div></div>';return out;
  };
}).call(this);
(function() {
  helpers.Ads = {
    trackStatsPixel: function(src) {
      src += (src.indexOf('?') === -1 && '?' || '&') + "_=" + (Math.random());
      return $("<img src='" + src + "' style='position:absolute;left:-10000px;top:-1000px;' />").appendTo('body').load(function() {
        return $(this).remove();
      });
    },
    getUniqId: function() {
      var t, uid;
      uid = $.cookie('coub_uid');
      if (!uid) {
        t = new Date().getTime();
        uid = t.toString() + _.random(999999999) + _.random(999999999);
        $.cookie('coub_uid', uid, {
          expires: 365 * 5,
          path: '/'
        });
      }
      return uid;
    }
  };

}).call(this);
(function() {
  helpers.Application = (function() {
    function Application() {}

    Application.capitalize = function(str) {
      return str.charAt(0).toUpperCase() + str.substring(1).toLowerCase();
    };

    Application.getSecondLevelDomain = function(url) {
      var a, elements, host;
      a = document.createElement('a');
      a.href = url;
      host = a.hostname;
      elements = host.split('.');
      return elements[elements.length - 2];
    };

    Application.retinizeImg = function(lowDpi, highDpi) {
      var res;
      res = [];
      if (lowDpi) {
        res.push(lowDpi + " 1x");
      }
      if (highDpi) {
        res.push(highDpi + " 2x");
      }
      return "src='" + (lowDpi || highDpi || '') + "' srcset='" + (res.join(',')) + "'";
    };

    Application.specificImgVersion = function(object, key, version, missing) {
      var replace, src, template;
      if (missing == null) {
        missing = void 0;
      }
      if ((object != null) && (object[key] != null)) {
        template = object[key].template;
        replace = function(v) {
          return template.replace('%{version}', v);
        };
        if (template != null) {
          src = this.retinizeImg(replace(version), replace(version + "_2x"));
        } else {
          src = "src=\"" + (Params.get('missing_userpic')) + "\"";
        }
        return src;
      } else {
        return "";
      }
    };

    Application.setAvatarAttrs = function(el, template, version) {
      var missing, replace;
      missing = Params.get('missing_userpic');
      replace = function(v) {
        return template.replace('%{version}', v);
      };
      if (template != null) {
        return el.attr({
          src: replace(version),
          srcset: (replace(version)) + " 1x, " + (replace(version + '_2x')) + " 2x"
        });
      } else {
        return el.attr({
          src: missing,
          srcset: ''
        });
      }
    };

    Application.formatSecondsToString = function(value) {
      var mins, secs;
      value = Math.floor(value);
      mins = Math.floor(value / 60);
      secs = value - mins * 60;
      if (secs < 10) {
        secs = "0" + secs;
      }
      return mins + ":" + secs;
    };

    Application.smartDateTime = function(object, ago, dateProperty) {
      var c, d, getDiff, m, n, stamp;
      if (dateProperty == null) {
        dateProperty = 'created_at';
      }
      c = moment(object[dateProperty]);
      n = moment(new Date());
      getDiff = function(ti) {
        return Math.abs(c.diff(n, ti));
      };
      if ((d = getDiff("years")) >= 1) {
        m = I18n.t("smart_datetime_new.month_names")[c.month()];
        stamp = I18n.t("smart_datetime_new.year_ago", {
          day: c.date(),
          month: m,
          year: c.year()
        });
        ago = false;
      } else if ((d = getDiff("hours")) >= 72) {
        m = I18n.t("smart_datetime_new.month_names")[c.month()];
        stamp = I18n.t("smart_datetime_new.current_year", {
          day: c.date(),
          month: m
        });
        ago = false;
      } else if (d >= 24 && d < 72) {
        stamp = I18n.t("smart_datetime_new.days", {
          days: getDiff("days")
        });
      } else if (d >= 1) {
        stamp = I18n.t("smart_datetime_new.hours", {
          hours: d
        });
      } else if ((d = getDiff("minutes")) >= 1) {
        stamp = I18n.t("smart_datetime_new.minutes", {
          minutes: d
        });
      } else {
        stamp = I18n.t("smart_datetime_new.seconds", {
          seconds: getDiff("seconds")
        });
      }
      if (ago) {
        stamp = stamp + (" " + (I18n.t('smart_datetime.ago')));
      }
      return stamp;
    };

    Application.getCoubPermalinkFromUrl = function(url) {
      var oUrl, p, v;
      oUrl = new URLRepresent(url);
      if ((oUrl.getDomain() != null) && (oUrl.getDomain().match(/(coub|localhost)/gi) != null)) {
        if ((p = oUrl.getPath()) != null) {
          if ((v = p.match(/view\/([\w\d]+)$/i)) != null) {
            if (v[1] != null) {
              return v[1];
            }
          }
        }
      }
      return void 0;
    };

    Application.getSourceUrlForMediaBlock = function(media_block, coub) {
      var rawVideoId;
      rawVideoId = media_block.raw_video_id || coub.raw_video_id;
      return Routes.source_path(rawVideoId, {
        from_id: coub.id
      });
    };

    Application.isMissing = function(url) {
      if (url != null) {
        return url.match(/missing\.png$/i) != null;
      } else {
        return true;
      }
    };

    Application.roundToK = function(v) {
      if (v >= 1000) {
        return (v / 1000).toFixed(1).replace(/\.0$/, "") + "k";
      } else {
        return v;
      }
    };

    Application.roundToM = function(v) {
      if (v >= 1000000) {
        return (v / 1000000).toFixed(1).replace(/\.0$/, "") + "M";
      } else {
        return helpers.Application.roundToK(v);
      }
    };

    Application.number_with_delimiter = function(number, delimiter) {
      if (delimiter == null) {
        delimiter = ',';
      }
      return number.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, '$1' + delimiter);
    };

    Application.handle429StatusError = function(xhr, action) {
      if (xhr.status === 429) {
        Growl.msg(I18n.ERRORS.too_fast[action], I18n.ERRORS.too_fast.slow_down);
        return true;
      }
      return false;
    };

    Application.getRandomExcept = function(min, max, except) {
      var r;
      r = _.random(min, max);
      if (r === except) {
        return helpers.Application.getRandomExcept(min, max, except);
      } else {
        return r;
      }
    };

    Application.setFocusNoScroll = function(el) {
      var $el, ref, x, y;
      if (GlobalState.PLATFORM.isMobile()) {
        return;
      }
      $el = $(el);
      if (!$el.length) {
        return;
      }
      ref = [window.scrollX, window.scrollY], x = ref[0], y = ref[1];
      $el.get(0).focus();
      return window.scrollTo(x, y);
    };

    Application.getLongestFollowButtonText = function() {
      var possibleTexts;
      possibleTexts = [I18n.t('profile.following'), I18n.t('profile.follow'), I18n.t('profile.unfollow')];
      return possibleTexts.reduce(function(a, b) {
        if (a.length > b.length) {
          return a;
        } else {
          return b;
        }
      });
    };

    return Application;

  })();

}).call(this);

/*
  Хелпер для системы авторизации
 */

(function() {
  helpers.Auth = {
    errorMailAlreadyUsed: function(msg, action, inPopup) {
      var trigger;
      if (inPopup == null) {
        inPopup = false;
      }
      if (inPopup) {
        trigger = " <span data-dialog-change=" + action + ">" + (I18n.t("auth_popup." + action)) + "</span>";
      } else {
        trigger = " <span data-action=" + action + " class='toggle-registration'>" + (I18n.t("auth_popup." + action)) + "</span>";
      }
      return msg + trigger;
    }
  };

}).call(this);
(function() {
  helpers.Channel = (function() {
    function Channel() {}

    Channel.getBirthday = function(type, birthday) {
      switch (type) {
        case 'month':
          return moment(birthday).format('MMM');
        case 'day':
          return moment(birthday).format('D');
        default:
          return moment(birthday).format('YYYY');
      }
    };

    Channel.getProviderUserName = function(provider, authentications) {
      return $.map(authentications, function(e, i) {
        if (e.provider === provider) {
          return e.username_from_provider;
        } else {
          return '';
        }
      }).join('');
    };

    Channel.getSpecificParam = function(opts, gp) {
      var channel, j, key, len, ref, value;
      key = _.keys(opts).join();
      value = _.values(opts).join();
      if (GlobalState.USER.isLogedIn()) {
        ref = Params.getBranchValue("current_user.channels");
        for (j = 0, len = ref.length; j < len; j++) {
          channel = ref[j];
          if (channel[key] === value) {
            return channel[gp];
          }
        }
        return void 0;
      } else {
        return void 0;
      }
    };

    Channel.presentChannels = function() {
      var channels, curentId, current;
      curentId = parseInt(Params.get("current_channel_id"));
      channels = Params.getBranchValue("current_user.channels");
      current = void 0;
      channels = _.reject(channels, function(channel) {
        var isCurrent;
        isCurrent = channel.id === curentId;
        if (isCurrent) {
          current = channel;
        }
        return isCurrent;
      });
      channels.unshift(current);
      return _.compact(channels);
    };

    Channel.findByParam = function(key, value) {
      return _.find(Params.getBranchValue("current_user.channels"), function(channel) {
        return channel[key] === value;
      });
    };

    Channel.hasId = function(id) {
      return _.include(helpers.Channel.mapIds(), id);
    };

    Channel.hasAuthentication = function(provider, authentications) {
      return _.contains($.map(authentications, function(e, i) {
        return e.provider;
      }), provider);
    };

    Channel.socialLink = function(contacts, provider) {
      return _.pluck([contacts], provider).join();
    };

    Channel.mapPermalinks = function(channels) {
      if (channels == null) {
        channels = Params.getBranchValue("current_user.channels");
      }
      if (channels != null) {
        return channels.map(function(channel, i) {
          return channel.permalink;
        });
      } else {
        return [];
      }
    };

    Channel.mapIds = function(channels) {
      if (channels == null) {
        channels = Params.getBranchValue("current_user.channels");
      }
      if (channels != null) {
        return channels.map(function(channel, i) {
          return channel.id;
        });
      } else {
        return [];
      }
    };

    Channel.getOtherUserChannels = function(id) {
      var channels;
      if (id == null) {
        id = Params.get('current_channel_id');
      }
      channels = Params.getBranchValue("current_user.channels");
      return _.reject(channels, function(channel) {
        return channel.id === id;
      });
    };

    Channel.channelsToRecoub = function(id) {
      var channels;
      if (helpers.Channel.hasId(id)) {
        channels = helpers.Channel.getOtherUserChannels(id);
      } else {
        channels = Params.getBranchValue("current_user.channels");
      }
      return channels;
    };

    Channel.authOrder = function() {
      if (Params.get('ussr_ip')) {
        return ['firebase', 'facebook', 'vkontakte', 'twitter', 'google'];
      } else {
        return ['firebase', 'facebook', 'twitter', 'google', 'vkontakte'];
      }
    };

    Channel.linkOrder = function() {
      if (Params.get('ussr_ip')) {
        return ['vkontakte', 'facebook', 'twitter', 'google', 'vine'];
      } else {
        return ['facebook', 'twitter', 'google', 'vkontakte', 'vine'];
      }
    };

    Channel.friendshipStamp = function(friend, dontShowfollowers) {
      var followersCount, stamp;
      if (dontShowfollowers == null) {
        dontShowfollowers = false;
      }
      switch (friend.type) {
        case 'editorial':
        case 'suggested':
          if (!dontShowfollowers) {
            followersCount = friend.followers_count === 1 ? 'one' : 'more';
            stamp = friend.followers_count + I18n.t("profile.timeline.friendships_block.followers_title_" + followersCount);
          } else {
            stamp = '';
          }
          break;
        default:
          stamp = helpers.Channel.friendhipSocStamp(friend);
      }
      return stamp;
    };

    Channel.friendhipSocStamp = function(friend, socClass) {
      var provider, stamp, withIcon;
      if (socClass == null) {
        socClass = "-soc-i-sml-";
      }
      provider = friend.provider || friend.friend_from;
      withIcon = function(stamp) {
        return "<span class='stamp__provider'><i class='" + socClass + provider + "'></i>" + stamp + "</span>";
      };
      if (provider === 'twitter' && (friend.screen_name != null)) {
        stamp = withIcon("<a href='//twitter.com/" + friend.screen_name + "' target='_blank'>@" + friend.screen_name + "</a>");
      } else if (provider === 'google' && (friend.email != null)) {
        stamp = withIcon("<a class='-undr' href='mailto:" + friend.email + "'>" + friend.email + "</a>");
      } else if (provider === 'facebook' && (friend.name_from_provider != null)) {
        stamp = withIcon("<a href='//facebook.com/" + (friend.screen_name || friend.provider_uid) + "' target='_blank'>" + friend.name_from_provider + "</a>");
      } else if ((provider != null) && (friend.name_from_provider != null)) {
        stamp = withIcon(friend.name_from_provider);
      } else {
        stamp = '';
      }
      return stamp;
    };

    Channel.followedByKindStamp = function(channels, overallFollowCount) {
      var c, channelsHtml, count, first, j, last, len, ref, sChannelsHtml;
      if (overallFollowCount == null) {
        overallFollowCount = 0;
      }
      if (channels.length <= 0) {
        return '';
      } else {
        channelsHtml = [];
        sChannelsHtml = "";
        ref = channels.slice(0, 2);
        for (j = 0, len = ref.length; j < len; j++) {
          c = ref[j];
          channelsHtml.push(c.title);
        }
        if (channels.length === 1) {
          sChannelsHtml = channelsHtml.join("");
        } else {
          if (channels.length === 2 || (overallFollowCount == null) || overallFollowCount === 0) {
            first = channelsHtml.slice(0, 1);
            last = channelsHtml[channelsHtml.length - 1];
          } else {
            first = channelsHtml.slice(0, 2);
            count = overallFollowCount + 1;
            last = count + "&nbsp;" + pluralize("other", count);
          }
          sChannelsHtml = first.join(", ") + " and " + last;
        }
      }
      return I18n.t('who_to_follow.kinds.followed', {
        channels: sChannelsHtml
      });
    };

    Channel.friendshipKindStamp = function(friend) {
      var k, m, s;
      k = friend.kind;
      m = friend.meta;
      if (m != null) {
        if (k === "followed" && (m.channels != null)) {
          return helpers.Channel.followedByKindStamp(m.channels, m.follows_count);
        } else if (k === "liked" && (m.likes_count != null)) {
          s = m.likes_count + " " + pluralize("coub", m.likes_count);
          return I18n.t("who_to_follow.kinds.liked", {
            count: s
          });
        } else if (k === "friends" && (m.channel != null)) {
          s = $("<a>", {
            href: Routes.channel_path(m.channel.permalink),
            text: m.channel.title
          })[0].outerHTML;
          return I18n.t("who_to_follow.kinds.friends", {
            friend: s
          });
        }
      }
      if ((s = helpers.Channel.friendhipSocStamp(friend, "-soc-i-notifications-")).length > 0) {
        return s;
      } else {
        return friend.description || '';
      }
    };

    Channel.friendshipProfileLink = function(friend) {
      switch (friend.friend_from) {
        case 'facebook':
          if (friend.screen_name || friend.provider_uid) {
            return "https://facebook.com/" + (friend.screen_name || friend.provider_uid);
          }
          break;
        case 'twitter':
          if (friend.screen_name) {
            return "https://twitter.com/" + friend.screen_name;
          }
      }
    };

    Channel.getGravatarUrl = function(email_hash, size, d404) {
      return "http://gravatar.com/avatar/" + email_hash + "?s=" + size + (d404 && '&d=404' || '');
    };

    Channel.isMyChannel = function(channel) {
      var channels, ids;
      channels = Params.getBranchValue("current_user.channels");
      if (channels != null) {
        ids = channels.map(function(c) {
          return c.id;
        });
        return ids.indexOf(channel.id) !== -1;
      } else {
        return false;
      }
    };

    return Channel;

  })();

}).call(this);

/*
  Хелпер для дропдауна пользователя в шапке
 */

(function() {
  helpers.ChannelMenuDropdown = (function() {
    function ChannelMenuDropdown() {}

    ChannelMenuDropdown.getEditorLinks = function() {
      var add, links;
      links = [];
      add = function(u, t, p) {
        if (Params.getBranchValue(p)) {
          return links.push({
            url: u,
            text: t
          });
        }
      };
      add(Routes.editor_coubs_path(), I18n.editor.pane, "permissions.can_index_editor_coubs");
      add(Routes.editor_tags_path(), I18n.editor.search_tags_pane, "permissions.can_index_search_tags");
      add(Routes.stats_path(), I18n.stats.pane, "permissions.can_index_stats");
      add(Routes.admin_path(), I18n.admin.pane, "current_user.is_admin");
      add(Routes.ads_overlays_path(), 'Ads Pane', "current_user.is_admin");
      add(Routes.editor_saved_channels_path(), I18n.editor.saved_users, "permissions.can_index_editor_saved_channels");
      add(Routes.channels_stats_editor_channels_path(), I18n.t('editor.channels_stats'), "permissions.can_channels_stats_channel_stats");
      add(Routes.explore_editor_delay_publishes_path(), I18n.editor.explore_queue, "permissions.can_index_explore_editor_delay_publishes");
      add(Routes.editors_stats_editor_coubs_path(), I18n.editor.editors_stats, "permissions.can_index_editors_stats_editor_coubs");
      add(Routes.avatar_moderation_editor_channels_path(), I18n.editor.avatar_moderation, "permissions.can_index_editor_avatar_moderation");
      add(Routes.editor_backgrounds_path(), I18n.editor.background_moderation, "permissions.can_index_editor_background_moderations");
      add(Routes.channel_lists_editor_channels_path(), I18n.t('editor.featured_channels'), "permissions.can_index_editor_channels_featured_channels");
      add(Routes.editor_weekly_digests_path(), I18n.editor.weekly_digests, "permissions.can_index_editor_weekly_digest");
      return links;
    };

    return ChannelMenuDropdown;

  })();

}).call(this);
(function() {
  window.helpers.Coub = {
    getOriginalCoub: function(coub) {
      if (coub.type != null) {
        if (coub.type === 'Coub::Recoub') {
          return coub.recoub_to;
        } else {
          return coub;
        }
      } else {
        return coub;
      }
    },
    isRecoub: function(coub) {
      return coub.type === "Coub::Recoub";
    },

    /*
     Стемп это различные подписи под кобом: когда сделан, кем сделан и тд
     */
    externalDownloadStamp: function(coub) {
      var domain, link, mb, out, sourcePath;
      out = '';
      if (coub.media_blocks.external_raw_videos.length && !coub.media_blocks.remixed_from_coubs.length) {
        mb = coub.media_blocks.external_raw_videos[0];
        if (mb.has_embed) {
          sourcePath = Routes.source_path({
            id: coub.raw_video_id
          }) + ("?from_id=" + coub.id);
          link = $("<a>", {
            text: coub.external_download.service_name,
            href: coub.external_download.url,
            target: "_blank",
            "class": "description__stamp__source",
            type: 'embedPopup',
            source: sourcePath
          })[0].outerHTML;
          out = " from " + link;
        } else {
          domain = helpers.Application.getSecondLevelDomain(coub.external_download.url);
          domain = helpers.Application.capitalize(domain);
          out = I18n.t("coub.external_download.link", {
            url: coub.external_download.url,
            type: domain
          });
        }
      } else if (helpers.Coub.fromMobileApp(coub)) {
        out = helpers.Coub.mobileAppStamp(coub, "_blank");
      } else if (helpers.Coub.fromApplication(coub)) {
        out = I18n.t("coub.external_download.link", {
          url: coub.application.url,
          type: coub.application.name
        });
      }
      return out;
    },
    fromMobileApp: function(coub) {
      return coub.uploaded_by_ios_app || coub.uploaded_by_android_app;
    },
    fromApplication: function(coub) {
      return coub.application != null;
    },
    applicationStamp: function(coub) {
      return I18n.t("coub.external_download.link", {
        url: coub.application.url,
        type: coub.application.name
      });
    },
    mobileAppStamp: function(coub, target) {
      var getStamp, out;
      out = '';
      getStamp = function(os) {
        return I18n.t("coub.from_mobile_app", {
          url: Routes.app_promo_path(),
          target: target,
          os: os
        });
      };
      if (coub.uploaded_by_ios_app) {
        out = getStamp('iPhone');
      } else if (coub.uploaded_by_android_app) {
        out = getStamp('Android');
      }
      return out;
    },
    coubUserStamp: function(coub, smallCardType, isPromoted) {
      var original, p, userLink;
      if (smallCardType == null) {
        smallCardType = false;
      }
      if (isPromoted == null) {
        isPromoted = false;
      }
      original = helpers.Coub.getOriginalCoub(coub);
      userLink = $("<a>", {
        text: original.channel.title,
        href: Routes.channel_path(original.channel.permalink),
        target: "_blank",
        "class": "hbold description__stamp__user",
        title: original.channel.title,
        "widget-channel-dropdown": true,
        "auto-init": true,
        channel: JSON.stringify(original.channel)
      })[0].outerHTML;
      if (isPromoted) {
        return I18n.t('promoted_coubs.coub_by', {
          name: userLink
        });
      } else if ((p = helpers.Coub.getCoubRecoubPermalink(coub))) {
        if (smallCardType) {
          return I18n.t("coub.original_by_small_card", {
            original: userLink
          });
        } else {
          return I18n.t("coub.original_by", {
            original: userLink,
            source: Routes.view_coub_by_permalink_path(p)
          });
        }
      } else {
        if (smallCardType) {
          return I18n.t('coub.by_small_card', {
            name: userLink
          });
        } else {
          return I18n.t('coub.by', {
            name: userLink
          });
        }
      }
    },
    getCoubRecoubPermalink: function(coub) {
      if (coub.media_blocks.remixed_from_coubs.length) {
        return coub.media_blocks.remixed_from_coubs[0].coub_permalink;
      } else {
        return void 0;
      }
    },
    cotdDate: function(coub) {
      coub = helpers.Coub.getOriginalCoub(coub);
      return moment(coub.cotd_at).format('D MMMM YYYY');
    },
    coubPrivacyIcon: function(coub) {
      var isSmallCard, types, visibility;
      visibility = coub.is_done ? coub.visibility_type : coub.original_visibility_type;
      types = ["private", "friends", "unlisted"];
      if (helpers.Coub.isPrivateAndNonAuthor(coub) || !_.contains(types, visibility)) {
        return "";
      }
      isSmallCard = coub.render && coub.render['card-type'] === 'small';
      return JST['app/site/templates/coub_block/parts/coub_stamp/coub_privacy_icon']({
        visibility: visibility,
        isSmallCard: isSmallCard
      });
    },
    coubAudioTrack: function(coub) {
      return (coub.media_blocks != null) && coub.media_blocks.audio_track;
    },
    showNoteSign: function(coub) {
      var media;
      media = coub.media_blocks.audio_track;
      return !_.isEmpty(media);
    },
    showNSFWSign: function(coub) {
      return !helpers.Channel.isMyChannel(coub.channel) && helpers.Coub.isAdult(coub);
    },
    isAdult: function(coub) {
      return coub.age_restricted_by_admin || coub.age_restricted || coub.not_safe_for_work;
    },
    hasAudioAndDetectedByEchonest: function(coub) {
      return helpers.Coub.coubAudioTrack(coub) && coub.media_blocks.audio_track.title !== "Unknown";
    },
    ageRestrictedForCurrentUser: function(coub) {
      var isAdult, isAuthor, isLoggedIn, legalAge, notConfirmedAgeInThisSession;
      coub = helpers.Coub.getOriginalCoub(coub);
      if (!helpers.Coub.isAdult(coub)) {
        return false;
      }
      legalAge = 18;
      isLoggedIn = Params.get("is_logged_in");
      isAdult = isLoggedIn && Params.getBranchValue("current_user.age") >= legalAge;
      if (isAdult) {
        return false;
      }
      isAuthor = isLoggedIn && _.pluck(Params.getBranchValue("current_user.channels"), 'id').indexOf(coub.channel_id) !== -1;
      if (isAuthor) {
        return false;
      }
      notConfirmedAgeInThisSession = !$.cookie('confirmed_age');
      return notConfirmedAgeInThisSession;
    },
    visibleForCurrentUser: function(coub) {
      return (coub.error == null) && !helpers.Coub.isPrivateAndNonAuthor(coub) && !helpers.Coub.isBannedAndNonAuthor(coub);
    },
    isPrivateAndNonAuthor: function(coub) {
      return coub.visibility_type === 'private' && !helpers.Coub.isCurrentUserAuthorOf(coub);
    },
    isBannedAndNonAuthor: function(coub) {
      return coub.banned && !helpers.Coub.isCurrentUserAuthorOf(coub);
    },
    isCoubCanPlaying: function(coub) {
      return coub.is_done && helpers.Coub.visibleForCurrentUser(coub) && !helpers.Coub.ageRestrictedForCurrentUser(coub);
    },
    disabledSocialAction: function(coub, action) {
      var restrictedVisibilityTypes;
      if (!coub.published) {
        return true;
      }
      restrictedVisibilityTypes = (function() {
        switch (action) {
          case 'like':
            return ['private'];
          case 'repost':
            return ['private', 'friends', 'unlisted'];
          default:
            throw 'Unknown action in disabledSocialAction';
        }
      })();
      return restrictedVisibilityTypes.indexOf(coub.visibility_type) !== -1;
    },
    getDraftTitlePrefix: function(coub) {
      var title;
      title = coub.published_at ? "[" + (moment(coub.published_at).format('DD MMM HH:mm')) + "]" : typeof I18n !== "undefined" && I18n !== null ? (I18n.t("coub.visibility.draft")) + ":" : "Draft:";
      return "<span class='-draft'>" + title + "</span> ";
    },
    getTitle: function(coub) {
      var $titleEl, emojis, originalPermalink, title, titleHtml;
      title = utils.stripTags(coub.title);
      titleHtml = title.replace(new RegExp(Params.get("coub_hash_tag_regexp"), "gi"), function(str) {
        var tag, tagPath;
        tag = encodeURIComponent(str.toLowerCase().slice(1));
        tagPath = typeof Routes !== "undefined" && Routes !== null ? Routes.tag_path(tag) : "/tags/" + tag;
        return $("<a/>", {
          text: str,
          href: tagPath,
          "class": "-undr tag-title",
          target: "_blank"
        }).prop("outerHTML");
      });
      $titleEl = $('<div/>').html(titleHtml);
      originalPermalink = helpers.Coub.getOriginalCoub(coub).permalink;
      emojis = ['c3p0', 'r2d2', 'bb8', 'chewbacca', 'resistance', 'stormtrooper', 'captainphasma', 'kyloren', 'firstorder', 'resistancepilot'];
      $titleEl.contents().each(function(i, v) {
        var $node, coubUrl, newText, params, text;
        $node = $(v);
        text = $node.text();
        if ($node.hasClass('tag-title') || text.trim() === '') {
          return;
        }
        newText = text.replace(/\[([a-z0-9]+)\]/g, function(m1, m2) {
          if (emojis.indexOf(m2) !== -1) {
            return "<img src='/images/promo/starwars/bb_" + m2 + ".svg' width='16' height='16' class='emoji-title box--inline' />";
          } else {
            return m1;
          }
        });
        newText = newText.replace(/(\ud83d.|.\ufe0f)/g, '<span class="emoji-font box--inline">$1</span>');
        if (!helpers.Coub.isCurrentPageCoubPage(coub)) {
          coubUrl = typeof Routes !== "undefined" && Routes !== null ? Routes.view_coub_by_permalink_path({
            id: originalPermalink
          }) : "/view/" + originalPermalink;
          params = {
            href: coubUrl,
            html: newText,
            title: text
          };
          if (!GlobalState.PLATFORM.isMobile()) {
            params.target = "_blank";
          }
          return $node.replaceWith($("<a/>", params));
        } else {
          return $node.replaceWith(newText);
        }
      });
      if (!coub.published && helpers.Coub.isCurrentUserAuthorOf(coub)) {
        $titleEl.prepend(this.getDraftTitlePrefix(coub));
      }
      return $titleEl.html();
    },
    isEditable: function(coub) {
      return _.isNumber(coub.raw_video_id);
    },
    isDone: function(coub) {
      return coub.type !== "Coub::Temp" && coub.is_done;
    },
    coubTags: function(coub, type) {
      var tags;
      tags = $.map(coub.tags, function(n) {
        return n.title;
      });
      if (type === 'edit') {
        return tags.join(",");
      } else {
        return tags;
      }
    },
    albumCover: function(coub, link) {
      var cover, coverClass, out, src;
      src = helpers.Application.retinizeImg(coub.media_blocks.audio_track.image, coub.media_blocks.audio_track.image_retina);
      coverClass = link != null ? '-ribbon -rounded' : '';
      cover = "<img " + src + " class='image " + coverClass + "' width='112' height='112'>";
      if (link != null) {
        out = ("<a href='" + link + "' class='-ribbon itunes_link' target='_blank'>") + cover + "</a>";
        return out;
      } else {
        return cover;
      }
    },
    musicStamp: function(coub, link) {
      var artist, out, stamp, title;
      if (coub.media_blocks.audio_track.meta != null) {
        artist = coub.media_blocks.audio_track.meta.artist;
      } else {
        artist = "";
      }
      title = "<span class='hbold -truncate-text'>" + coub.media_blocks.audio_track.title + "</span>";
      stamp = [title, artist].join("");
      if (link != null) {
        out = "<a href='" + link + "' target='_blank' class='itunes_link -ribbon-hvr-text'>" + stamp + "</a>";
        return out;
      } else {
        return stamp;
      }
    },
    mediaThumbnail: function(thumbnail, hdpiThumbnail) {
      var src;
      if (thumbnail != null) {
        src = helpers.Application.retinizeImg(thumbnail, hdpiThumbnail);
        return "<img " + src + " class='image img-placeholder' width='112' height='70'>";
      } else {
        return "<div class='blank'></div>";
      }
    },
    hasAbusesOn: function(coub, reason) {
      var abuses, cuId, reasons;
      coub = helpers.Coub.getOriginalCoub(coub);
      cuId = Params.getBranchValue("current_user.id");
      abuses = $.map(coub.abuses, function(a) {
        return a.channel_id;
      });
      reasons = $.map(coub.abuses, function(a) {
        return a.reason;
      });
      return _.contains(abuses, cuId) && _.contains(reasons, reason);
    },
    showMedia: function(coub) {
      var mb;
      return (mb = coub.media_blocks) && (mb.remixed_from_coubs.length || mb.external_raw_videos.length || mb.uploaded_raw_videos.length);
    },
    imgListenerAttrs: function(coub) {
      var attrs;
      coub = helpers.Coub.getOriginalCoub(coub);
      if (Params.getBranchValue("profile_channel.id") === coub.channel_id) {
        attrs = 'auto-init widget-avatar-change-listener';
      } else {
        attrs = '';
      }
      return attrs;
    },
    getWIAText: function(device) {
      var lang, platform;
      if (device == null) {
        device = void 0;
      }
      lang = GlobalState.COUNTRY.isExUssr() && '_ru' || '';
      platform = device || GlobalState.PLATFORM.hasApp();
      if (platform === 'android' && (navigator.userAgent.indexOf('FB_IAB') !== -1 || navigator.userAgent.indexOf('Twitter') !== -1)) {
        return I18n.embed["get_app" + lang];
      } else {
        return I18n.embed["open_in_app" + lang];
      }
    },
    showWIAButton: function() {
      var device, devices, isPinterest, ref;
      device = GlobalState.PLATFORM;
      devices = (device.isIos() || device.isWindophone() || device.isAndroidNative()) && device.isMobile();
      ref = document.referrer;
      isPinterest = ref && ref.indexOf('pinterest') !== -1;
      return devices && !isPinterest;
    },
    isCurrentPageCoubPage: function(coub) {
      var coubPath;
      coubPath = typeof Routes !== "undefined" && Routes !== null ? Routes.view_coub_by_permalink_path(coub.permalink) : "/view/" + coub.permalink;
      return document.location.pathname.match(coubPath) != null;
    },
    capitalize: function(str) {
      return str.charAt(0).toUpperCase() + str.substring(1).toLowerCase();
    },
    getFileVersion: (function(_this) {
      return function(versions, versionName) {
        if (versions && versions.template) {
          return versions.template.replace(/%{version}/g, versionName);
        } else {
          return "";
        }
      };
    })(this),
    getBigSocialButtonsOrder: (function(_this) {
      return function() {
        var order;
        order = GlobalState.COUNTRY.isExUssr() ? {
          visible: ["vkontakte", "facebook"],
          hidden: ["odnoklassniki", "twitter", "tumblr", "reddit", "pinterest"]
        } : {
          visible: ["facebook", "twitter"],
          hidden: ["tumblr", "reddit", "pinterest"]
        };
        return order;
      };
    })(this),
    isSharingButtonsActive: (function(_this) {
      return function(coub) {
        var ovt;
        ovt = coub.original_visibility_type;
        return !coub.banned && (ovt === "public" || ovt === "unlisted") && coub.is_done && coub.published;
      };
    })(this),
    getAbuseIdForReason: (function(_this) {
      return function(coub, reason) {
        var curAbuse;
        if (!_.isArray(coub.abuses)) {
          return "";
        }
        curAbuse = _.detect(coub.abuses, (function(ab) {
          return ab.reason === reason;
        }));
        if (curAbuse) {
          return curAbuse.id;
        } else {
          return "";
        }
      };
    })(this),
    isCurrentUserAuthorOf: function(coub) {
      return helpers.Channel.hasId(coub.channel_id);
    },
    calculatePropertiesForViewIfNotComputed: function(coub) {
      var aspectRatio;
      if (!coub.computed) {
        coub.computed = {};
        if (!coub.render) {
          coub.render = {};
        }
        if (coub.render["card-type"] != null) {
          coub.computed.cardType = blocks.coub.CardTypes.types[coub.render["card-type"]];
        } else {
          coub.computed.cardType = blocks.coub.CardTypes.getDefaultCardType();
        }
        coub.computed.showSharing = coub.render["no-sharing"] !== "true" && helpers.Coub.visibleForCurrentUser(coub);
        coub.computed.cardClassName = blocks.coub.CardTypes.getClassName(coub.computed.cardType);
        coub.computed.cardStatus = blocks.coub.CardStatuses.getCardStatusByCoub(coub);
        if ((coub.first_frame_versions != null) && (coub.first_frame_versions.template != null)) {
          coub.computed.firstFrameUrl = coub.first_frame_versions.template.replace("%{version}", "med");
        } else {
          coub.computed.firstFrameUrl = "";
        }
        aspectRatio = this.aspectRatio(coub.size[0], coub.size[1]);
        coub.computed.aspectRatio = aspectRatio;
        coub.computed.dims = this.scaleToRect(coub.size, blocks.coub.CardTypes.getSize(coub.computed.cardType)).map((function(_this) {
          return function(v) {
            return v + "px";
          };
        })(this));
      }
      return coub;
    },
    scaleToRect: function(original_size, target_size) {
      var original_ratio, target_ratio;
      original_ratio = original_size[0] / original_size[1];
      target_ratio = target_size[0] / target_size[1];
      if (original_ratio < target_ratio) {
        return [Math.ceil(target_size[1] * original_ratio), target_size[1]];
      } else {
        return [target_size[0], Math.floor(target_size[0] / original_ratio)];
      }
    },
    aspectRatio: function(width, height) {
      var ratio;
      ratio = height / width;
      return {
        percent: (ratio * 100).toFixed(2) + '%',
        val: ratio.toFixed(4)
      };
    },
    isPromoPage: function() {
      return $('body').hasClass('promo-page');
    },
    rightCoubTitle: function(count) {
      if (count === 1) {
        return "1 coub";
      } else {
        return count + " coubs";
      }
    },
    showEditorInfo: function(coub) {
      return Params.getBranchValue("current_user.is_editor") && coub.is_done && coub.type !== "Coub::Temp" && typeof coub.editorial_info.last_moderated_by !== "undefined";
    },
    getCommunityStamp: function(coub, classes, limitTitle) {
      var community, title;
      if (classes == null) {
        classes = '';
      }
      if (limitTitle == null) {
        limitTitle = 0;
      }
      community = coub.categories[0];
      if (!community || ((coub.feed_source != null) && coub.feed_source !== "community")) {
        return '';
      }
      title = community.title;
      if (limitTitle > 0 && title.length > limitTitle) {
        title = title.substr(0, limitTitle) + '...';
      }
      return "<a href=\"" + (Routes.category_hot_path(community.permalink)) + "\" class=\"" + classes + "\" data-prompt=\"" + (I18n.t('trends.community')) + "\" hideable-prompt>" + title + "</a>";
    },
    getCotdStamp: function(coub, iconSize, classes) {
      if (iconSize == null) {
        iconSize = 16;
      }
      if (classes == null) {
        classes = '';
      }
      coub = helpers.Coub.getOriginalCoub(coub);
      if (!coub.cotd || ((coub.feed_source != null) && coub.feed_source !== "cotd")) {
        return '';
      }
      return "<a href=\"/oftheday\" class=\"coub__cotd-badge " + classes + "\" data-prompt=\"" + (I18n.t('coub.cotd')) + " &#183; " + (helpers.Coub.cotdDate(coub)) + "\" hideable-prompt data-prompt-class=\"-full-width\">\n  " + (JST["app/site/templates/svg/icons/" + iconSize + "/cotd"]()) + "\n</a>";
    },
    getFeaturedStamp: function(coub, iconSize, classes) {
      if (iconSize == null) {
        iconSize = 16;
      }
      if (classes == null) {
        classes = '';
      }
      coub = helpers.Coub.getOriginalCoub(coub);
      if (!coub.featured || ((coub.feed_source != null) && coub.feed_source !== "featured")) {
        return '';
      }
      return "<a href=\"/featured\" class=\"coub__featured-badge " + classes + "\" data-prompt=\"" + (I18n.t('coub.featured_badge')) + "\" hideable-prompt>\n  " + (JST["app/site/templates/svg/icons/" + iconSize + "/featured"]()) + "\n</a>";
    },
    getPromotedStamp: function() {
      return "<a href=\"/promote\" class=\"coub__promoted-badge coub__tags-tag\" data-prompt=\"" + (I18n.t('promoted_coubs.promoted')) + "\" hideable-prompt>\n  " + (JST["app/site/templates/svg/icons/24/promote"]()) + "\n</a>";
    }
  };

}).call(this);
(function() {
  helpers.Editor = {
    getAvailableEditorChannels: function(editorsChannels, takenChannels) {
      var available;
      available = _.omit(editorsChannels, function(value, key) {
        return key in takenChannels;
      });
      return JSON.stringify(available);
    },
    getAuditStamp: function(audit) {
      var audits, getTemp, print_categories, removed_tag_titles, removed_trend_titles, stamp;
      stamp = [];
      removed_trend_titles = _.map(audit.removed_trends, function(trend) {
        return "Unhot " + ([trend.region_title, trend.kind, trend.category_title].join(':'));
      });
      removed_tag_titles = _.map(audit.removed_tags, function(tag) {
        return "#" + tag;
      });
      audits = [[removed_trend_titles, ''], [removed_tag_titles, 'removed'], [audit.added_flags, ''], [audit.deleted_flags, 'removed'], [audit.added_editor_recoubs, ''], [audit.deleted_editor_recoubs, 'removed']];
      if (audit.previous_categories.length || audit.current_categories.length) {
        print_categories = function(array) {
          return !array.length && "[]" || array.join(', ');
        };
        audits.push([["categories: " + (print_categories(audit.previous_categories)) + " &rarr; " + (print_categories(audit.current_categories))], '']);
      }
      getTemp = function(flags, cl) {
        var parts;
        parts = _.map(flags, function(val, i) {
          return "<span class='" + cl + "'>" + (helpers.Application.capitalize(val.replace(/_/g, ' '))) + "</span>";
        });
        return stamp.push.apply(stamp, parts);
      };
      _.each(audits, function(audit_tuple) {
        return getTemp(audit_tuple[0], audit_tuple[1]);
      });
      return stamp.join('\u30fb');
    },
    editorialCoubStamp: function(createdAt) {
      return moment(createdAt).format('MMM Do YY, h:mm:ssa');
    }
  };

}).call(this);

/*
  Хелперы для формы
 */

(function() {
  helpers.Form = {
    DT: "helpers.Form",
    bindPseudoSubmit: function(container) {
      var find, form;
      if (container.is("form")) {
        form = container;
      } else {
        find = container.parents("form");
        if (find.size() > 0) {
          console.warn(helpers.Form.DT, "Cannot find form for the given container.");
          return;
        } else {
          form = find.first();
        }
      }
      return form.find("[form-submit]").on("click", (function(_this) {
        return function() {
          return form.submit();
        };
      })(this));
    }
  };

}).call(this);

/*
  Функции для определения текущего положения и тд
 */

(function() {
  helpers.Location = {
    isVkontakteWebEmbed: function() {
      var refParam;
      refParam = GlobalState.PAGE.getUrlParam('referrer') || '';
      return GlobalState.PAGE.isEmbed() && !this.isVkontakteApp() && (refParam.indexOf('vk.com') !== -1 || document.referrer.indexOf('vk.com/') !== -1);
    },
    isVkontakteApp: function() {
      var rc;
      rc = window.request_client || '';
      return this._isVkApp || (this._isVkApp = rc.indexOf('com.vkontakte.') !== -1 || rc.indexOf('com.vk.') !== -1 || GlobalState.PLATFORM.isVkIosApp() || GlobalState.PLATFORM.isVkAndroidApp());
    },
    isVkontakteEmbed: function() {
      return this.isVkontakteApp() || this.isVkontakteWebEmbed();
    },
    isRedditEmbed: function() {
      return decodeURIComponent(window.location.search).indexOf("redditmedia.com") !== -1;
    },
    isTwitterEmbed: function() {
      return navigator.userAgent.toLowerCase().indexOf('twitter') !== -1;
    },
    isForcedNoAutoplay: function() {
      return document.referrer && document.referrer.indexOf('marakon.ru') !== -1;
    },
    isFullScreen: function() {
      return !!$(document).fullScreen();
    },
    isIfunnyEmbed: function() {
      return decodeURIComponent(window.location.search).indexOf("ifunny.co") !== -1;
    },
    isAdsDisabled: function() {
      var blackList, i, item, len, referrer;
      referrer = GlobalState.PAGE.getReferrer();
      if (!referrer) {
        return false;
      }
      blackList = ['the-village.ru', 'meduza.io', 'vc.ru', 'lenta.ru', 'cosmo.ru', 'wonderzine.com', 'tjournal.ru', '2x2tv.ru', 'kanobu.ru', 'warthunder.com', 'worldoftanks.ru', 'warthunder.ru', 'store.gaijin.net', 'wargag.ru', 'echo.msk.ru', 'worldofwarships.ru', 'afisha.ru', 'coub.com', 'coub.local', 'staging.coub.com', 'halfand.co', 'crossout.net', 'crossout.ru'];
      for (i = 0, len = blackList.length; i < len; i++) {
        item = blackList[i];
        if (referrer.indexOf(item) !== -1) {
          return true;
        }
      }
      return false;
    }
  };

}).call(this);

/*
  Хелперы для нотификейшнов.
 */

(function() {
  window.helpers.Notifications = {
    getText: function(n) {
      var notificationKind, opts;
      opts = {
        recipient: $('<a>', {
          'class': 'hbold -undr',
          text: n.recipient.title,
          href: Routes.channel_path(n.recipient.permalink)
        })[0].outerHTML
      };
      if (n.system_notification && (n.categories != null) && n.categories.length > 0) {
        false;
        $.extend(opts, {
          count: 1
        });
      }
      if (n.entity_type === "Coub") {
        $.extend(opts, {
          coub_name: n.object.title,
          someone: $('<a>', {
            'class': 'hbold -undr',
            text: n.object.channel.title,
            href: Routes.channel_path(n.object.channel.permalink)
          })[0].outerHTML
        });
      }
      if (n.kind === "cotd") {
        $.extend(opts, {
          cotd_link: $('<a>', {
            'class': 'hbold -undr',
            text: I18n.t("coub.cotd"),
            href: Routes.category_hot_path("coub-of-the-day")
          })[0].outerHTML
        });
      }
      if (!n.system_notification && n.senders.length > 0) {
        $.extend(opts, {
          sender: helpers.Notifications.pluralizeObjectNamesForNotification(n.senders, "title", {
            kind: n.kind,
            notification: n
          }),
          count: n.senders.length
        });
      }
      if (n.kind === "follow" && n.directed_to_channel) {
        $.extend(opts, {
          recipient: $('<a>', {
            'class': 'hbold -undr',
            text: n.object.title,
            href: Routes.channel_path(n.object.permalink)
          })[0].outerHTML
        });
      }
      if (n.kind === "like" && helpers.Coub.isRecoub(n.object)) {
        notificationKind = "like_recoub";
      } else {
        notificationKind = n.kind;
      }
      if (n.directed_to_channel) {
        return I18n.t("notifications." + notificationKind + ".mine", opts);
      } else {
        return I18n.t("notifications." + notificationKind + ".foreign", opts);
      }
    },
    getTextForFriendsNotification: (function(_this) {
      return function(n) {
        var channels, famSocNetwork, followCount, likesCount, recoubsCount, sender, t;
        if ((n.senders != null) && n.senders.length > 0) {
          sender = n.senders[0];
          t = JST["app/site/templates/blocks/friendship_notifications/friendship_notification_text"];
          if (n.meta != null) {
            if (n.meta.friendships != null) {
              famSocNetwork = helpers.Notifications.sortSocialNetworks(n.meta.friendships);
            }
            likesCount = n.meta.likes_count;
            recoubsCount = n.meta.recoubs_count;
            channels = n.meta.channels;
            followCount = n.meta.follows_count;
          }
          return t({
            sender: sender,
            familiarSocNetworks: famSocNetwork,
            likesCount: likesCount,
            recoubsCount: recoubsCount,
            channels: channels,
            kind: n.kind,
            followCount: followCount
          });
        } else {
          return "";
        }
      };
    })(this),
    getFriendNotificationTitle: (function(_this) {
      return function(n) {
        var channelLink, f, isNamesEqual, k, snLink, t;
        channelLink = $("<a>", {
          "class": "hbold",
          href: Routes.channel_path(n.sender.permalink),
          text: n.sender.title
        });
        channelLink = channelLink[0].outerHTML;
        k = n.kind;
        if (k === "follow_back") {
          return channelLink + "&nbsp;" + I18n.notifications.follow.follow_back_suffix;
        } else if ((k === "sn_friend_follow" || k === "sn_friend_registered") && (n.familiarSocNetworks != null) && n.familiarSocNetworks[0]) {
          f = n.familiarSocNetworks[0];
          if (f.url != null) {
            snLink = $("<a>", {
              "class": "hbold",
              href: f.url,
              text: helpers.Notifications.getNameForSn(f)
            })[0].outerHTML;
          } else {
            snLink = $("<span>", {
              "class": "hbold",
              text: helpers.Notifications.getNameForSn(f)
            })[0].outerHTML;
          }
          isNamesEqual = n.sender.title.toLowerCase().trim() === helpers.Notifications.getNameForSn(f).toLowerCase().trim();
          if (k === "sn_friend_follow") {
            if (isNamesEqual) {
              t = I18n.site_notifications.kinds.sn_friend_follow_equal_name;
            } else {
              t = I18n.site_notifications.kinds.sn_friend_follow;
            }
          } else {
            if (isNamesEqual) {
              t = I18n.site_notifications.kinds.sn_friend_registered_equal_name;
            } else {
              t = I18n.site_notifications.kinds.sn_friend_registered;
            }
          }
          return t.replace("%{sn}", f.from).replace("%{nickname}", snLink).replace("%{channel}", channelLink).replace("vkontakte", "VK");
        } else {
          return channelLink + "&nbsp;" + I18n.notifications.follow.is_now_following_suffix;
        }
      };
    })(this),
    getNameForSn: (function(_this) {
      return function(sn) {
        if (sn.name != null) {
          return sn.name;
        } else {
          return sn.nickname;
        }
      };
    })(this),
    getTextForLikesAndRecoubs: (function(_this) {
      return function(likes, recoubs) {
        var s, total;
        if (likes && recoubs) {
          total = likes + recoubs;
          return I18n.notifications.likes_recoubs.likes_recoubs.replace("%{count}", total);
        } else if (likes) {
          s = likes + " " + pluralize("coub", likes);
          return I18n.notifications.likes_recoubs.likes.replace("%{count}", s);
        } else if (recoubs) {
          s = recoubs + " " + pluralize("coub", recoubs);
          return I18n.notifications.likes_recoubs.recoubs.replace("%{count}", s);
        } else {
          return "";
        }
      };
    })(this),
    isTypeChannel: function(n) {
      return n.entity_type === "Channel";
    },
    pluralizeObjectNamesForNotification: function(objects, attr, opts) {
      var dropdown, f, i, ids, j, kind, l, len, n, object, ref, strings, widget;
      kind = opts.kind;
      n = opts.notification;
      f = function(ind) {
        var obj, url;
        obj = objects[ind];
        if (helpers.Notifications.isSenderChannel(obj, kind)) {
          url = Routes.channel_path(obj.permalink);
        } else if (helpers.Notifications.isSenderCategory(obj, kind)) {
          url = Routes.explore_category_path(obj.permalink);
        } else {
          url = Routes.view_coub_by_permalink_path(obj.permalink);
        }
        return $('<a>', {
          'class': 'hbold -undr',
          href: url,
          text: obj.title,
          title: obj.title
        })[0].outerHTML;
      };
      if (objects.length === 1) {
        return f(0);
      } else if (objects.length === 2) {
        return I18n.t("objects_group_pluralizer.two", {
          first: f(0),
          second: f(1)
        });
      } else if (objects.length > 2) {
        if (kind === "new_category") {
          strings = [];
          for (i = j = 0, ref = objects.length - 2; 0 <= ref ? j <= ref : j >= ref; i = 0 <= ref ? ++j : --j) {
            strings.push(f(i));
          }
          return [strings.join(", "), I18n.t("objects_group_pluralizer.and"), f(objects.size - 1)].join(' ');
        } else {
          ids = [];
          for (l = 0, len = objects.length; l < len; l++) {
            object = objects[l];
            ids.push(object.id);
          }
          ids.shift();
          widget = blocks.NotificationGroupDropdown.ATTR_NAME + "='true' auto-init='true' ";
          switch (kind) {
            case "like":
              widget += "kind='" + blocks.NotificationGroupDropdown.KIND.LIKE + "'";
              break;
            case "recoub":
              widget += "kind='" + blocks.NotificationGroupDropdown.KIND.RECOUB + "'";
              break;
            default:
              widget += "kind='" + blocks.NotificationGroupDropdown.KIND.FOLLOW + "'";
          }
          dropdown = JST["app/site/templates/widgets/absolute_dropdown_with_handler/absolute_dropdown_with_handler"]({
            attrs: "data-id='" + n.object.id + "' data-ids='" + (ids.join(",")) + "' " + widget,
            handler: "<span class='-color--coub -undr'>" + (I18n.t('objects_group_pluralizer.others_text', {
              count: objects.length - 1
            })) + "</span>",
            dClass: 'box--inline',
            hClass: 'box--inline'
          });
          return I18n.t('objects_group_pluralizer.many_with_dropdown', {
            first: f(0),
            dropdown: dropdown
          });
        }
      }
    },
    getBgLink: function(n) {
      var link;
      if (n.entity_type === 'Coub') {
        link = Routes.view_coub_by_permalink_path(n.object.permalink);
      } else {
        if (n.kind === 'follow' && n.directed_to_channel) {
          link = Routes.channel_path(n.senders[0].permalink);
        } else {
          link = Routes.channel_path(n.object.permalink);
        }
      }
      return link;
    },
    getObjectForFriendNotifications: function(n) {
      var channel, classes, object, showFollowButtonFor;
      showFollowButtonFor = _.without(siteData.UserData.FRIENDS_NOTIFICATIONS_TYPES, "follow_back");
      object = '';
      classes = '';
      channel = n.senders != null ? n.senders[0] : void 0;
      if (showFollowButtonFor.indexOf(n.kind) !== -1 && channel) {
        if (!channel.i_follow_him || Params.getBranchValue("current_user.channels").length > 1) {
          object = JST['app/site/templates/widgets/follow_button/follow_button_init']({
            channelId: channel.id,
            followedFrom: channel.follows_by_users_channels,
            btnCls: "",
            iFollow: channel.i_follow_him
          });
          classes = 'notification-list__object--channel';
        }
      }
      return {
        object: object,
        "class": classes
      };
    },
    getObject: function(n) {
      var getChannelImg, getCoubImg, getFollowButton, getImgTemp, object, opts;
      opts = {};
      getImgTemp = (function(_this) {
        return function(opts) {
          return " <a href='" + opts.url + "'>\n  <img alt='" + opts.alt + "' " + opts.src + " class='" + opts["class"] + "' width='" + opts.size[0] + "' height='" + opts.size[1] + "'>\n</a>";
        };
      })(this);
      getFollowButton = (function(_this) {
        return function(channel) {
          return JST['app/site/templates/widgets/follow_button/follow_button_init']({
            channelId: channel.id,
            followedFrom: channel.follows_by_users_channels,
            btnCls: ""
          });
        };
      })(this);
      getCoubImg = (function(_this) {
        return function(coub) {
          return getImgTemp({
            url: Routes.view_coub_by_permalink_path(coub.permalink),
            src: helpers.Application.specificImgVersion(coub, 'image_versions', 'micro'),
            size: [70, 46],
            alt: coub.title,
            'class': 'image -rounded--small'
          });
        };
      })(this);
      getChannelImg = (function(_this) {
        return function(channel) {
          return getImgTemp({
            url: Routes.channel_path(channel.permalink),
            src: helpers.Application.specificImgVersion(channel, 'avatar_versions', 'notification'),
            size: [32, 32],
            alt: channel.title,
            'class': 'image -rounded'
          });
        };
      })(this);
      if (n.entity_type === 'Channel' && Params.getBranchValue("current_user.is_admin")) {
        opts = {
          "class": 'notification-list__object--channel'
        };
      } else if (n.entity_type === 'Channel') {
        opts = {
          "class": 'notification-list__object--channel -hidden'
        };
      } else {
        opts = {
          "class": 'notification-list__object--coub'
        };
      }
      if (n.kind === 'follow') {
        if (n.directed_to_channel) {
          object = n.senders[0].i_follow_him ? '' : getFollowButton(n.senders[0]);
        } else {
          object = getChannelImg(n.object);
        }
      } else {
        if (n.entity_type === 'Coub') {
          object = getCoubImg(n.object);
        } else {
          object = '';
        }
      }
      return $.extend(opts, {
        object: object
      });
    },
    notificationClassNames: function(n) {
      var classes;
      classes = [];
      classes.push(n.kind);
      if (n.important) {
        classes.push('important');
      }
      if (n.directed_to_channel && n.kind === 'follow') {
        classes.push('mine');
      }
      return classes.join(' ');
    },
    isSenderChannel: function(s, k) {
      return k === "follow" || k === "like" || k === "recoub";
    },
    isSenderCategory: function(s, k) {
      return k === "new_category";
    },
    sortSocialNetworks: function(sns) {
      return sns.sort((function(_this) {
        return function(f, s) {
          if (f.from === "twitter") {
            return -1;
          } else if (s.from === "twitter") {
            return +1;
          } else {
            return 0;
          }
        };
      })(this));
    }
  };

}).call(this);
(function() {
  window.OEmbedPopupHelper = {
    show: function(url, title, source, buttonTitle) {
      var popup;
      popup = EmbedPopup.show({
        content: '',
        title: title || "",
        buttonTitle: buttonTitle,
        type: 'simple'
      }, source);
      popup.setLoading(true);
      return $.put(Routes.oembed_service_path(), {
        oembed: {
          maxwidth: 640,
          autoplay: true
        },
        url: url
      }).fail(function() {
        return Growl.msg("Embed", "Query failed");
      }).done(function(data) {
        if (data.html) {
          popup.setLoading(false);
          popup.setFooter(data.title || '');
          popup.setContent(data.html);
          return popup.animateExpand();
        } else {
          popup.setLoading(false);
          return popup.setContent("<div class='-centered-text'><h2 class='hthin'>" + (I18n.t('video_popup.novideo')) + "</h2><a target='_blank' href='" + url + "'>" + (I18n.t('video_popup.sub')) + "<strong>" + url + "</strong></a></div>");
        }
      });
    }
  };

}).call(this);
(function() {
  helpers.PromotedCoubsHelper = {
    formatFloat: function(value) {
      return parseFloat(numeral(value).format('0.00'));
    },
    formatInt: function(value) {
      return numeral(value).format('0,0').replace(new RegExp(/,/g), ' ');
    },
    calcDetails: function(pc) {
      var budget, costPerClick, costPerEngagement, costPerView, engagement, paidViewsNow, spendNow, targetViews, totalClicks, totalViews;
      targetViews = pc.target_views;
      paidViewsNow = pc.views_count;
      spendNow = paidViewsNow / 10;
      budget = targetViews / 10;
      totalClicks = pc.total_clicks;
      costPerClick = spendNow / totalClicks;
      if (pc.coub) {
        totalViews = pc.coub.views_count;
        engagement = pc.coub.likes_count + pc.coub.recoubs_count + pc.coub.remixes_count + pc.coub.favourite_coubs_count;
      } else {
        totalViews = 0;
        engagement = 0;
      }
      if (spendNow > budget) {
        spendNow = budget;
      }
      costPerEngagement = spendNow / engagement;
      costPerView = spendNow / totalViews;
      costPerView = this.checkNumber(costPerView);
      costPerEngagement = this.checkNumber(costPerEngagement);
      costPerClick = this.checkNumber(costPerClick);
      return {
        targetViews: this.formatInt(targetViews),
        totalViews: this.formatInt(totalViews),
        paidViewsNow: this.formatInt(paidViewsNow),
        costPerView: this.formatFloat(costPerView) + ' ₽',
        engagement: this.formatInt(engagement),
        costPerEngagement: this.formatFloat(costPerEngagement) + ' ₽',
        budget: this.formatInt(budget) + ' ₽',
        spendNow: this.formatInt(spendNow) + ' ₽',
        totalClicks: this.formatInt(totalClicks),
        webClicks: this.formatInt(pc.web_clicks),
        iosClicks: this.formatInt(pc.ios_clicks),
        androidClicks: this.formatInt(pc.android_clicks),
        costPerClick: this.formatFloat(costPerClick) + ' ₽'
      };
    },
    coubCanToBePromoted: function(coub) {
      return coub.published && ['public', 'unlisted'].indexOf(coub.visibility_type) !== -1 && !coub.banned && !helpers.Coub.isAdult(coub);
    },
    checkNumber: function(num) {
      if (isNaN(num) || !isFinite(num)) {
        return 0;
      } else if (num > 0 && num < 0.01) {
        return 0.01;
      } else {
        return num;
      }
    }
  };

}).call(this);
(function() {
  helpers.Scrollers = (function() {
    function Scrollers() {}

    Scrollers.ATTACH_VAL = {
      COVER: 125,
      DEFAULT: 6
    };

    Scrollers.FIRE_VAL = {
      COVER: 350,
      DEFAULT: 500
    };

    Scrollers.changeUI = function(value, attachFn, detachFn, frame) {
      if (frame == null) {
        frame = false;
      }
      if ($(window).scrollTop() > value) {
        if (frame) {
          return requestAnimationFrame(attachFn);
        } else {
          return attachFn();
        }
      } else {
        if (frame) {
          return requestAnimationFrame(detachFn);
        } else {
          return detachFn();
        }
      }
    };

    Scrollers.isProfile = function() {
      return GlobalState.PAGE.isProfile();
    };

    Scrollers.withTransHeader = function() {
      return GlobalState.UI.hasTransHeader();
    };

    Scrollers.notVerified = function() {
      return GlobalState.USER.notVerified();
    };

    Scrollers.getAttachValue = function(type) {
      return helpers.Scrollers.ATTACH_VAL[type.toUpperCase()];
    };

    Scrollers.getFireValue = function(type) {
      return helpers.Scrollers.FIRE_VAL[type.toUpperCase()];
    };

    return Scrollers;

  })();

}).call(this);
(function() {
  helpers.StoryHelper = {
    getStampTop: function(story) {
      var coubs_text, items, title;
      title = story.published ? (typeof I18n !== "undefined" && I18n !== null) && I18n.t('stories.types.story') || 'STORY' : (typeof I18n !== "undefined" && I18n !== null) && I18n.t('stories.types.draft') || 'DRAFT';
      coubs_text = (typeof I18n !== "undefined" && I18n !== null) && I18n.t("stories.coubs_count", {
        count: story.coubs_count
      }) || pluralize('coub', story.coubs_count);
      items = ["<span class='hbold'>" + title + "</span>", story.coubs_count + " " + coubs_text];
      return items.join('&nbsp;&nbsp;|&nbsp;&nbsp;');
    },
    getStampBottom: function(story) {
      var items, views, views_text;
      items = [((typeof I18n !== "undefined" && I18n !== null) && I18n.t('stories.by') || 'by') + " <span class='hbold'>" + story.channel.title + "</span>"];
      if ((views = story.views_count) > 0) {
        views_text = (typeof I18n !== "undefined" && I18n !== null) && I18n.t("coub.views_count", {
          count: story.views_count
        }) || pluralize("view", views);
        items.push(views + " " + views_text);
      }
      return items.join('&nbsp;·&nbsp;');
    },
    getStampSmall: function(story) {
      var bottomText, coubsText, items, type, views, viewsText;
      type = story.published ? (typeof I18n !== "undefined" && I18n !== null) && I18n.t('stories.types.story') || 'STORY' : (typeof I18n !== "undefined" && I18n !== null) && I18n.t('stories.types.draft') || 'DRAFT';
      coubsText = (typeof I18n !== "undefined" && I18n !== null) && I18n.t("stories.coubs_count", {
        count: story.coubs_count
      }) || pluralize('coub', story.coubs_count);
      bottomText = story.coubs_count + " " + coubsText;
      if ((views = story.views_count) > 0) {
        viewsText = (typeof I18n !== "undefined" && I18n !== null) && I18n.t("coub.views_count", {
          count: story.views_count
        }) || pluralize('view', views);
        bottomText += " · " + views + " " + viewsText;
      }
      items = ["<span class='hbold'>" + type + "</span> " + ((typeof I18n !== "undefined" && I18n !== null) && I18n.t('stories.by') || 'by') + " <span class='hbold'>" + story.channel.title + "</span>", "" + bottomText];
      return items.join('<br/>');
    },
    getPreviewParams: function(story) {
      var dimensions, params, previewCoub, videoData, videoVersions;
      params = {};
      if ((previewCoub = story.thumbnail_coub)) {
        videoVersions = previewCoub.file_versions.html5.video;
        videoData = videoVersions.high || videoVersions.med;
        dimensions = previewCoub.site_w_h;
        params = {
          videoUrl: videoData.url,
          videoSize: videoData.size,
          thumbnailUrl: helpers.Coub.getFileVersion(story.thumbnail, 'big'),
          thumbnailRatio: (dimensions[0] / dimensions[1]).toFixed(4)
        };
      }
      return params;
    }
  };

}).call(this);

/*
  Провайдер данных для АПИ Версия 2
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  dataProviders.ApiV2 = (function() {
    function ApiV2() {
      this.getNotifications = bind(this.getNotifications, this);
      this.unfollow = bind(this.unfollow, this);
      this.follow = bind(this.follow, this);
      this.setPreviousCover = bind(this.setPreviousCover, this);
      this.saveCoverPosition = bind(this.saveCoverPosition, this);
      this.deleteCover = bind(this.deleteCover, this);
      this.changeCoverToCoub = bind(this.changeCoverToCoub, this);
      this.changeCoverToImage = bind(this.changeCoverToImage, this);
      this.changeCover = bind(this.changeCover, this);
      if (dataProviders.ApiV2.__instance == null) {
        dataProviders.ApiV2.__instance = this;
      } else {
        return dataProviders.ApiV2.__instance;
      }
    }

    ApiV2.prototype.createCoub = function(coubData, xhrParams) {
      return $.ajax($.extend({
        url: Routes.api_v2_coubs_path(),
        type: "POST",
        contentType: "application/json",
        dataType: "json",
        data: JSON.stringify(coubData)
      }, xhrParams));
    };

    ApiV2.prototype.editCoub = function(coubId, data, xhrParams) {
      return $.ajax($.extend({
        url: Routes.update_from_new_editor_api_v2_coub_path(coubId),
        type: "PUT",
        contentType: "application/json",
        dataType: "json",
        data: JSON.stringify(data)
      }, xhrParams));
    };

    ApiV2.prototype.likeCoub = function(id, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_likes_path(),
        type: "POST",
        data: {
          id: id,
          type: 'coub',
          channel_id: Params.get("current_channel_id")
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.unlikeCoub = function(id, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_likes_path(),
        type: "DELETE",
        data: {
          id: id,
          type: 'coub',
          channel_id: Params.get("current_channel_id")
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.dislikeCoub = function(id, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_dislikes_path(),
        type: "POST",
        data: {
          coub_id: id,
          channel_id: Params.get("current_channel_id")
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.undislikeCoub = function(id, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_dislikes_path(),
        type: "DELETE",
        data: {
          coub_id: id,
          channel_id: Params.get("current_channel_id")
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.recoub = function(id, xhrParams) {
      return this.recoubToChannel(id, Params.get("current_channel_id"), xhrParams);
    };

    ApiV2.prototype.recoubToChannel = function(id, channelId, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_recoubs_path(),
        type: "POST",
        data: {
          recoub_to_id: id,
          channel_id: channelId
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.undoRecoub = function(id, xhrParams) {
      return this.undoRecoubFromChannel(id, Params.get("current_channel_id"), xhrParams);
    };

    ApiV2.prototype.undoRecoubFromChannel = function(id, channelId, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_recoubs_path(),
        type: "DELETE",
        data: {
          id: id,
          channel_id: channelId
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.getLikesForCoub = function(id, page, xhrParams) {
      var params;
      params = {
        url: Routes.coub_likes_list_api_v2_action_subjects_data_path(),
        data: {
          id: id,
          page: page
        },
        type: "GET"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.getRecoubsForCoub = function(id, page, xhrParams) {
      var params;
      params = {
        url: Routes.recoubs_list_api_v2_action_subjects_data_path(),
        data: {
          id: id,
          page: page
        },
        type: "GET"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.getRemixesForCoub = function(id, page, xhrParams) {
      var params;
      params = {
        url: Routes.remixes_list_api_v2_action_subjects_data_path(),
        data: {
          id: id,
          page: page
        },
        type: "GET"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.likeStory = function(id, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_likes_path(),
        type: "POST",
        data: {
          id: id,
          type: 'story',
          channel_id: Params.get("current_channel_id")
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.unlikeStory = function(id, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_likes_path(),
        type: "DELETE",
        data: {
          id: id,
          type: 'story',
          channel_id: Params.get("current_channel_id")
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.repostStory = function(id, xhrParams) {
      return this.repostStoryToChannel(id, Params.get("current_channel_id"), xhrParams);
    };

    ApiV2.prototype.repostStoryToChannel = function(id, channelId, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_reposts_path(),
        type: "POST",
        data: {
          type: 'story',
          id: id,
          channel_id: channelId
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.undoRepostStory = function(id, xhrParams) {
      return this.undoRepostStoryFromChannel(id, Params.get("current_channel_id"), xhrParams);
    };

    ApiV2.prototype.undoRepostStoryFromChannel = function(id, channelId, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_reposts_path(),
        type: "DELETE",
        data: {
          type: 'story',
          id: id,
          channel_id: channelId
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.getLikesForStory = function(id, page, xhrParams) {
      var params;
      params = {
        url: '/api/v2/likes/channels',
        type: "GET",
        data: {
          type: 'story',
          id: id,
          page: page
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.getRepostsForStory = function(id, page, xhrParams) {
      var params;
      params = {
        url: '/api/v2/reposts/channels',
        type: "GET",
        data: {
          type: 'story',
          id: id,
          page: page
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.sendAbuseClaim = function(data, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_abuses_path(),
        data: data,
        type: "POST"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.deleteAbuseClaim = function(id, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_abuses_path() + ("/" + id),
        type: "DELETE"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.deleteAllAbuses = function(coubId, xhrParams) {
      var params;
      params = {
        url: Routes.mass_destroy_api_v2_abuses_path(coubId),
        type: 'DELETE'
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.getEmbedShareData = function(id, xhrParams) {
      var params;
      params = {
        url: Routes.share_coub_api_v2_action_subjects_datum_path({
          id: id
        }),
        type: "GET"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.getEditorControlsData = function(id, type, xhrParams) {
      var params;
      params = {
        url: Routes.editorial_api_v2_action_subjects_datum_path({
          id: id
        }),
        type: "GET",
        data: {
          type: type
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.getUserForEdit = function(id, xhrParams) {
      var params;
      params = {
        url: Routes.edit_api_v2_profile_path({
          id: id
        }),
        type: "GET",
        dataType: "json"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.getChannel = function(id, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_channel_path({
          id: id
        }),
        type: "GET",
        dataType: "json"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.getChannelForEdit = function(id, xhrParams) {
      var params;
      params = {
        url: Routes.edit_api_v2_channel_path({
          id: id
        }),
        type: "GET",
        dataType: "json"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.changeChannel = function(data, xhrParams) {
      var params;
      params = {
        url: Routes.change_channel_api_v2_users_path(),
        data: data,
        type: "PUT"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.createChannel = function(title, perm, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_channels_path(),
        type: "POST",
        data: {
          channel: {
            title: title,
            permalink: perm
          }
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.updateUserSettings = function(data, xhrParams) {
      var params;
      params = {
        url: Routes.update_regular_info_api_v2_users_path(),
        type: "PUT",
        data: data
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.updateUserPrivateSettings = function(data, xhrParams) {
      var params;
      params = {
        url: Routes.update_private_info_api_v2_users_path(),
        type: "PUT",
        data: data
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.updateChannelSettings = function(data, xhrParams) {
      var params;
      params = {
        url: Routes.update_info_api_v2_channels_path(),
        type: "PUT",
        data: data
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.changeCover = function(channel_id, data, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_channel_backgrounds_path(channel_id),
        type: "POST",
        dataType: "json",
        data: data
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.changeCoverToImage = function(image, cid, xhrParams) {
      return this.changeCover($.param(cid, {
        background: {
          image: image,
          offset_y: 0
        }
      }), xhrParams);
    };

    ApiV2.prototype.changeCoverToCoub = function(perm, cid, xhrParams) {
      return this.changeCover(cid, {
        background: {
          coub: perm,
          offset_y: 0
        }
      }, xhrParams);
    };

    ApiV2.prototype.deleteCover = function(cid, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_channel_backgrounds_path(cid),
        type: "DELETE"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.saveCoverPosition = function(y, cid, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_channel_backgrounds_path(cid),
        data: {
          offset_y: y
        },
        type: "PUT"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.setPreviousCover = function(cid, xhrParams) {
      var params;
      params = {
        url: Routes.set_previous_api_v2_channel_backgrounds_path(cid),
        type: "PUT"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.follow = function(from, channel, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_follows_path(),
        type: "POST",
        data: {
          id: channel,
          channel_id: from
        },
        dataType: "json"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.unfollow = function(from, channel, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_follows_path(),
        type: "DELETE",
        data: {
          id: channel,
          channel_id: from
        },
        dataType: "json"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.getFollowingList = function(id, page, xhrParams) {
      var params;
      params = {
        url: Routes.followings_list_api_v2_action_subjects_data_path(),
        dataType: "json",
        data: {
          id: id,
          page: page
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.getFollowersList = function(id, page, xhrParams) {
      var params;
      params = {
        url: Routes.followers_list_api_v2_action_subjects_data_path(),
        dataType: "json",
        data: {
          id: id,
          page: page
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.getFriendshipsByType = function(ids, type, count, xhrParams) {
      var params;
      params = {
        url: Routes.friends_to_follow_api_v2_friends_path(),
        type: "GET",
        dataType: 'json',
        data: {
          ids: ids,
          type: type,
          count: count
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.ignorePossibleFriend = function(id, type, xhrParams) {
      var params;
      params = {
        url: Routes.ignore_possible_friend_api_v2_friends_path(),
        type: "PUT",
        data: {
          friend_id: id,
          type: type
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.updateCoub = function(perm, data, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_coub_path({
          id: perm
        }),
        type: "PUT",
        data: data,
        dataType: "json"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.getCoub = function(perm, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_coub_path({
          id: perm
        }),
        type: "GET"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.NOTIFICATION_TYPE_FOLLOW = "follow";

    ApiV2.prototype.NOTIFICATION_TYPE_COUB = "coub";

    ApiV2.prototype.getNotifications = function(page, type, channel_id, from, xhrParams) {
      var data, params;
      data = {
        page: page
      };
      if (type != null) {
        data.type = type;
      }
      if (from != null) {
        data.from = from;
      }
      if (channel_id != null) {
        data.channel_id = channel_id;
      }
      params = {
        url: Routes.api_v2_notifications_path(),
        type: "GET",
        data: data
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.getNotificationsLikeDropdown = function(coubId, userIds, page, xhrParams) {
      var params;
      if (userIds == null) {
        userIds = [];
      }
      params = {
        url: Routes.coub_likes_list_api_v2_action_subjects_data_path(),
        type: "GET",
        traditional: true,
        data: {
          id: coubId,
          ids: userIds
        }
      };
      if (page != null) {
        params.data.page = page;
      }
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.getNotificationsRecoubDropdown = function(coubId, userIds, page, xhrParams) {
      var params;
      if (userIds == null) {
        userIds = [];
      }
      params = {
        url: Routes.recoubs_list_api_v2_action_subjects_data_path(),
        type: "GET",
        traditional: true,
        data: {
          id: coubId,
          ids: userIds
        }
      };
      if (page != null) {
        params.data.page = page;
      }
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.getNotificationsFollowDropdown = function(coubId, userIds, page, xhrParams) {
      var params;
      if (userIds == null) {
        userIds = [];
      }
      params = {
        url: Routes.followers_list_api_v2_action_subjects_data_path(),
        type: "GET",
        traditional: true,
        data: {
          id: coubId,
          ids: userIds
        }
      };
      if (page != null) {
        params.data.page = page;
      }
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.createRawVideoAnnouncement = function(url, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_raw_video_announcements_path(),
        type: "POST",
        data: $.param({
          announcement: {
            url: url
          }
        })
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.getRawVideoAnnoucements = function(userPermalink, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_raw_video_announcements_path(),
        type: "GET",
        data: $.param({
          permalink: userPermalink
        })
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.deleteRawVideoAnnouncement = function(id, xhrParams) {
      var params;
      params = {
        url: Routes.api_v2_raw_video_announcements_path() + ("/" + id),
        type: "DELETE"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2.prototype.deleteCoub = function(coubPermalink, xhrParams) {
      var params;
      params = {
        url: Routes.coub_path(coubPermalink),
        type: "DELETE"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    return ApiV2;

  })();

}).call(this);

/*
  Редакторский дата провайдер АПИ в2
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  dataProviders.ApiV2Editor = (function() {
    function ApiV2Editor() {
      this.changeCoversBanStatus = bind(this.changeCoversBanStatus, this);
      this.changeAvatarBanStatus = bind(this.changeAvatarBanStatus, this);
      this.removeFromFeatured = bind(this.removeFromFeatured, this);
      this.getUsersForAvatarModeration = bind(this.getUsersForAvatarModeration, this);
      this.avatarModerationSaveStatus = bind(this.avatarModerationSaveStatus, this);
      if (dataProviders.ApiV2Editor.__instance == null) {
        dataProviders.ApiV2Editor.__instance = this;
        this.s = this.constructor;
      } else {
        return dataProviders.ApiV2Editor.__instance;
      }
    }

    ApiV2Editor.prototype.avatarModerationSaveStatus = function(data, xhrParams) {
      var params;
      if (xhrParams == null) {
        xhrParams = {};
      }
      params = {
        url: Routes.api_v2_avatar_moderations_path() + "/save_status",
        type: "POST",
        data: data,
        contentType: "application/json"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2Editor.prototype.getUsersForAvatarModeration = function(xhrParams) {
      var params;
      if (xhrParams == null) {
        xhrParams = {};
      }
      params = {
        url: Routes.api_v2_avatar_moderations_path(),
        type: "GET"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2Editor.prototype.removeFromFeatured = function(id, xhrParams) {
      var params;
      if (xhrParams == null) {
        xhrParams = {};
      }
      params = {
        url: Routes.api_v2_editor_channel_list_path({
          id: id
        }),
        type: "DELETE"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2Editor.AVATAR_MODERATION_STATUS_BAN = "banned";

    ApiV2Editor.prototype.changeAvatarBanStatus = function(channelId, status, xhrParams) {
      var params;
      if (xhrParams == null) {
        xhrParams = {};
      }
      params = {
        url: Routes.save_status_api_v2_avatar_moderations_path(),
        type: "POST",
        dataType: "json",
        contentType: "application/json",
        data: $.toJSON({
          channels_data: [
            {
              id: channelId,
              status: status
            }
          ]
        })
      };
      return $.ajax($.extend(params, xhrParams));
    };

    ApiV2Editor.prototype.changeCoversBanStatus = function(channelIds, bannedIds, xhrParams) {
      var params;
      if (xhrParams == null) {
        xhrParams = {};
      }
      params = {
        url: Routes.apply_moderation_editor_backgrounds_path(),
        type: "put",
        data: {
          _method: "put",
          ids: channelIds,
          banned: bannedIds
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    return ApiV2Editor;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.AuthDataProvider = (function() {
    AuthDataProvider.KIND = {
      FACEBOOK: {
        URL: "/auth/facebook"
      },
      TWITTER: {
        URL: "/auth/twitter"
      },
      VKONTAKTE: {
        URL: "/auth/vkontakte"
      },
      TUMBLR: {
        URL: "/auth/tumblr"
      },
      GOOGLE: {
        URL: "/auth/google_oauth2"
      },
      VINE: {
        URL: "/vine",
        TYPE: "redirect"
      },
      FIREBASE: {
        URL: "/auth/firebase"
      }
    };

    function AuthDataProvider() {
      this.addAuthFullCycle = bind(this.addAuthFullCycle, this);
      this.addOrUpdateAuthFullCycle = bind(this.addOrUpdateAuthFullCycle, this);
      this.addOrUpdateAuth = bind(this.addOrUpdateAuth, this);
      this.authorizeInProvider = bind(this.authorizeInProvider, this);
      this.KIND = AuthDataProvider.KIND;
    }

    AuthDataProvider.prototype.authorizeInProvider = function(kind, success, error) {
      var left, messageHandler, top;
      if (kind.TYPE === 'redirect') {
        window.location = kind.URL;
        return;
      }
      messageHandler = function(e) {
        var eventData;
        eventData = e.originalEvent.data;
        if (!eventData || eventData.cmd !== "oauthCallback") {
          return;
        }
        $(window).off("message.authDataProvider");
        if (eventData.result) {
          if (success != null) {
            return success(eventData.result);
          }
        } else if (error != null) {
          return error();
        }
      };
      $(window).off("message.authDataProvider").on("message.authDataProvider", messageHandler);
      left = $(window).width() / 2 - 320;
      top = $(window).height() / 2 - 215;
      return window.open(kind.URL, 'Login', "menubar=no,toolbar=no,status=no,width=640,height=430,toolbar=no,left=" + left + ",top=" + top);
    };

    AuthDataProvider.prototype.AUTH_ACTIONS = {
      ADD: {
        CHANNEL: {
          URL: Routes.add_auth_api_v2_channels_path()
        },
        METHOD: "POST"
      },
      DELETE: {
        CHANNEL: {
          URL: Routes.remove_auth_api_v2_channels_path()
        }
      }
    };

    AuthDataProvider.prototype.addOrUpdateAuth = function(data, action, success, error) {
      if (action == null) {
        action = this.AUTH_ACTIONS.ADD;
      }
      return $.ajax({
        url: action.CHANNEL.URL,
        type: action.METHOD,
        data: data,
        success: success,
        error: error
      });
    };

    AuthDataProvider.prototype.addOrUpdateAuthFullCycle = function(kind, action, channelId, success, error) {
      var providerSuccess;
      providerSuccess = (function(_this) {
        return function(data) {
          var resData;
          console.log('provider success', data);
          resData = {
            id: channelId,
            session: {
              uid: data.uid,
              token: data.token,
              provider: data.provider,
              secret: data.secret,
              phone_number: data.phone_number
            }
          };
          return _this.addOrUpdateAuth($.param(resData), action, success, error);
        };
      })(this);
      return this.authorizeInProvider(kind, providerSuccess, error);
    };

    AuthDataProvider.prototype.addAuthFullCycle = function(kind, channelId, success, error) {
      return this.addOrUpdateAuthFullCycle(kind, this.AUTH_ACTIONS.ADD, channelId, success, error);
    };

    AuthDataProvider.prototype.removeAuth = function(provider, channelId, success, error) {
      var data;
      data = {
        id: channelId,
        session: {
          provider: provider.toLowerCase()
        }
      };
      return $.ajax({
        url: this.AUTH_ACTIONS.DELETE.CHANNEL.URL,
        type: "DELETE",
        data: data,
        success: success,
        error: error
      });
    };

    return AuthDataProvider;

  })();

}).call(this);
(function() {
  window.Best2015DataProvider = (function() {
    function Best2015DataProvider() {
      if (window.Best2015DataProvider.__instance == null) {
        Best2015DataProvider.__instance = this;
      } else {
        return Best2015DataProvider.__instance;
      }
    }

    Best2015DataProvider.prototype.addToBest = function(channel_id, permalink, success, error) {
      return $.ajax({
        url: "/api/v2/promo/best2015/collections/" + channel_id + "/add_coub?coub_id=" + permalink,
        type: "POST",
        dataType: "json",
        success: success,
        error: error
      });
    };

    Best2015DataProvider.prototype.removeFromBest = function(channel_id, permalink, success, error) {
      return $.ajax({
        url: "/api/v2/promo/best2015/collections/" + channel_id + "/remove_coub?coub_id=" + permalink,
        type: "DELETE",
        dataType: "json",
        success: success,
        error: error
      });
    };

    Best2015DataProvider.prototype.vote = function(collection_id, success, error) {
      return $.ajax({
        url: "/api/v2/promo/best2015/collections/" + collection_id + "/vote",
        type: "POST",
        dataType: "json",
        success: success,
        error: error
      });
    };

    Best2015DataProvider.prototype.unvote = function(collection_id, success, error) {
      return $.ajax({
        url: "/api/v2/promo/best2015/collections/" + collection_id + "/vote",
        type: "DELETE",
        dataType: "json",
        success: success,
        error: error
      });
    };

    return Best2015DataProvider;

  })();

}).call(this);
(function() {
  window.ChannelsDataProvider = {
    findInParamsById: (function(_this) {
      return function(channelId) {
        return _.find(Params.getBranchValue("current_user.channels"), function(c) {
          return c.id === channelId;
        });
      };
    })(this),
    updateProperty: (function(_this) {
      return function(id, prop, value) {
        var channel;
        channel = _this.findInParamsById(parseInt(id));
        if (channel == null) {
          return;
        }
        return channel[prop] = value;
      };
    })(this)
  };

}).call(this);

/*
  Провайдер данных для загрузки видео
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  dataProviders.CoubEditorUpload = (function() {
    function CoubEditorUpload() {
      this.rtmpRecorded = bind(this.rtmpRecorded, this);
      this.rtmpGetLink = bind(this.rtmpGetLink, this);
      this.reactRawVideoIdKnown = bind(this.reactRawVideoIdKnown, this);
      this.reactProcessingExpectedTime = bind(this.reactProcessingExpectedTime, this);
      this.checkProcessingStatus = bind(this.checkProcessingStatus, this);
      this.startProcessCheckField = bind(this.startProcessCheckField, this);
      this.startProcessGetUncroppedVideoSource = bind(this.startProcessGetUncroppedVideoSource, this);
      this.startProcessGetCoubScreenshots = bind(this.startProcessGetCoubScreenshots, this);
      this.startProcessSegmentConverting = bind(this.startProcessSegmentConverting, this);
      this.startProcess = bind(this.startProcess, this);
      this.handleError = bind(this.handleError, this);
      this.getDispatcher = bind(this.getDispatcher, this);
      this.startTakeMusicFromOtherCoubProcess = bind(this.startTakeMusicFromOtherCoubProcess, this);
      this.startUploadLocalAudioProcess = bind(this.startUploadLocalAudioProcess, this);
      this.startUploadLocalVideoProcess = bind(this.startUploadLocalVideoProcess, this);
      this.startUploadExternalAudioProcess = bind(this.startUploadExternalAudioProcess, this);
      this.startUploadExternalVideoProcess = bind(this.startUploadExternalVideoProcess, this);
      this.listenProcessingStatusUrl = bind(this.listenProcessingStatusUrl, this);
      this.listenTempUploadStatusUrl = bind(this.listenTempUploadStatusUrl, this);
      this.listenUploadingStatusUrl = bind(this.listenUploadingStatusUrl, this);
      this.listenRawVideoStatusUrl = bind(this.listenRawVideoStatusUrl, this);
      this.listenUrl = bind(this.listenUrl, this);
      this.exitDuringConversion = bind(this.exitDuringConversion, this);
      this.exitDuringDownload = bind(this.exitDuringDownload, this);
      this.createExternalAudioDownload = bind(this.createExternalAudioDownload, this);
      this.createExternalVideoDownload = bind(this.createExternalVideoDownload, this);
      this.createExternalDownload = bind(this.createExternalDownload, this);
      this.getAudioFromCoub = bind(this.getAudioFromCoub, this);
      if (dataProviders.CoubEditorUpload.__instance == null) {
        dataProviders.CoubEditorUpload.__instance = this;
        this.s = dataProviders.CoubEditorUpload;
      } else {
        return dataProviders.CoubEditorUpload.__instance;
      }
    }

    CoubEditorUpload.prototype.EXTERNAL_DOWNLOAD_KIND = {
      RAW_VIDEO: "raw_video",
      AUDIO: "audio_track"
    };

    CoubEditorUpload.prototype.getAudioFromCoub = function(permalink, xhrParams) {
      var data;
      data = {
        type: "GET",
        url: Routes.audio_track_api_v2_coub_path(permalink, {
          force_m4a: !!window.CB_EDTR_HTML5_PLAYER_ENABLED
        }),
        dataType: "json"
      };
      return $.ajax($.extend(data, xhrParams));
    };

    CoubEditorUpload.prototype.createExternalDownload = function(url, kind, xhrParams) {
      var data;
      data = {
        type: "POST",
        url: Routes.api_v2_external_downloads_path(),
        data: {
          target: kind,
          url: url,
          user_id: Params.getBranchValue("current_user.id")
        }
      };
      return $.ajax($.extend(data, xhrParams));
    };

    CoubEditorUpload.prototype.createExternalVideoDownload = function(url, xhrParams) {
      return this.createExternalDownload(url, this.EXTERNAL_DOWNLOAD_KIND.RAW_VIDEO, xhrParams);
    };

    CoubEditorUpload.prototype.createExternalAudioDownload = function(url, xhrParams) {
      return this.createExternalDownload(url, this.EXTERNAL_DOWNLOAD_KIND.AUDIO, xhrParams);
    };

    CoubEditorUpload.prototype.exitDuringDownload = function(id, xhrParams) {
      var data;
      data = {
        type: "POST",
        url: Routes.exit_during_download_api_v2_external_download_path({
          id: id
        })
      };
      return $.ajax($.extend(data, xhrParams));
    };

    CoubEditorUpload.prototype.exitDuringConversion = function(rawVideoId, xhrParams) {
      var data;
      data = {
        type: "POST",
        url: Routes.exit_during_conversion_api_v2_raw_video_path({
          id: rawVideoId
        })
      };
      return $.ajax($.extend(data, xhrParams));
    };

    CoubEditorUpload.prototype.LISTEN_INTERVAL = 1000;

    CoubEditorUpload.prototype.listenUrl = function(url, dispatcher, state, onSuccess, onError) {
      var errorHandler, interval;
      errorHandler = (function(_this) {
        return function(e) {
          if (onError != null) {
            onError(e);
          }
          _this.handleError(e, dispatcher);
          return clearInterval(interval);
        };
      })(this);
      interval = setInterval((function(_this) {
        return function() {
          return $.ajax({
            type: "GET",
            url: url,
            success: function(e) {
              if (e.status !== "failed" && e.status !== "fail") {
                dispatcher.trigger({
                  type: _this.s.EVENT_PERCENT_UPDATE,
                  value: e.percent,
                  state: state
                });
                return onSuccess(e, interval);
              } else {
                return errorHandler(e);
              }
            },
            error: errorHandler
          });
        };
      })(this), this.LISTEN_INTERVAL);
      return dispatcher.on(this.s.ACTION_CANCEL, (function(_this) {
        return function() {
          return clearInterval(interval);
        };
      })(this));
    };

    CoubEditorUpload.prototype.listenRawVideoStatusUrl = function(url, dispatcher, event) {
      return this.listenUrl(url, dispatcher, this.s.STATE_UPLOADING, (function(_this) {
        return function(e, i) {
          if (e.expected_time != null) {
            dispatcher.trigger({
              type: _this.s.EVENT_EXPECTED_TIME_KNOWN,
              time: e.expected_time
            });
          }
          if ((e.raw_video != null) || (e.url != null) || (e.attrs != null)) {
            dispatcher.trigger({
              type: event,
              respData: e
            });
            return clearInterval(i);
          }
        };
      })(this));
    };

    CoubEditorUpload.prototype.listenUploadingStatusUrl = function(url, dispatcher) {
      return this.listenRawVideoStatusUrl(url, dispatcher, this.s.EVENT_UPLOADING_COMPLETE);
    };

    CoubEditorUpload.prototype.listenTempUploadStatusUrl = function(url, dispatcher) {
      return this.listenRawVideoStatusUrl(url, dispatcher, this.s.EVENT_TEMP_UPLOAD_COMPLETE);
    };

    CoubEditorUpload.prototype.listenProcessingStatusUrl = function(url, dispatcher) {
      console.log('listenProcessingStatusUrl', url, dispatcher);
      return this.listenUrl(url, dispatcher, this.s.STATE_PROCESSING, (function(_this) {
        return function(e, i) {
          var isReady, res;
          if (e.expected_time != null) {
            dispatcher.trigger({
              type: _this.s.EVENT_EXPECTED_TIME_KNOWN,
              time: e.expected_time
            });
          }
          if (e.raw_video_id != null) {
            _this.reactRawVideoIdKnown(dispatcher, e.raw_video_id);
          }
          isReady = window.CB_EDTR_HTML5_PLAYER_ENABLED && e.data.ready_state.cutter_mp4_dashed === 100 ? true : !window.CB_EDTR_HTML5_PLAYER_ENABLED && e.data.ready_state.cutter === 100 ? true : false;
          console.log('checkProcessingState', e, isReady);
          if (isReady) {
            res = e;
            res.url = Routes.source_path(res.data.id);
            dispatcher.trigger({
              type: _this.s.EVENT_PROCESSING_COMPLETE,
              respData: e
            });
            return clearInterval(i);
          }
        };
      })(this));
    };

    CoubEditorUpload.EVENT_EXTERNAL_DOWNLOAD_CREATED = "dataProviders-CoubEditorUpload:EventExternalDownloadCreated";

    CoubEditorUpload.EVENT_UPLOADING_START = "dataProviders-CoubEditorUpload:EventUploadingStart";

    CoubEditorUpload.EVENT_UPLOADING_COMPLETE = "dataProviders-CoubEditorUpload:EventUploadingComplete";

    CoubEditorUpload.EVENT_PROCESSING_START = "dataProviders-CoubEditorUpload:EventProcessingStart";

    CoubEditorUpload.EVENT_PROCESSING_COMPLETE = "dataProviders-CoubEditorUpload:EventProcessingComplete";

    CoubEditorUpload.EVENT_TEMP_UPLOAD_START = "dataProviders-CoubEditorUpload:EventTempUploadStart";

    CoubEditorUpload.EVENT_TEMP_UPLOAD_COMPLETE = "dataProviders-CoubEditorUpload:EventTempUploadEnd";

    CoubEditorUpload.EVENT_PERCENT_UPDATE = "dataProviders-CoubEditorUpload:EventPercentUpdate";

    CoubEditorUpload.EVENT_ALL_DONE_SUCCESSFULLY = "dataProviders-CoubEditorUpload:EventAllDone";

    CoubEditorUpload.EVENT_ERROR_ON_UPLOADING_OR_PROCESSING = "dataProviders-CoubEditorUpload:EventError";

    CoubEditorUpload.EVENT_ERROR_CREATING_EXTERNAL_DOWNLOAD = "dataProviders-CoubEditorUpload:EventCreatingExternalUploadError";

    CoubEditorUpload.EVENT_VIDEO_TITLE_KNOWN = "dataProviders-coubEditorUpload:EventVideoTitleKnown";

    CoubEditorUpload.EVENT_EXPECTED_TIME_KNOWN = "dataProviders-CoubEditorUpload:EventExpectedTimeKnown";

    CoubEditorUpload.EVENT_PROCESS_STARTED = "dataProviders-coubEditorUpload:EventProcessStarted";

    CoubEditorUpload.EVENT_PROCESS_CANCELED = "dataProviders-coubEditorUpload:EventProcessCanceled";

    CoubEditorUpload.EVENT_PROCESS_COMPLETED = "dataProviders-coubEditorUpload:EventProcessCompleted";

    CoubEditorUpload.EVENT_PROCESSING_EXPECTED_TIME_KNOWN = "dataProviders-coubEditorUpload:EventProcessingExpectedTimeKnown";

    CoubEditorUpload.EVENT_RAW_VIDEO_ID_KNOWN = "dataProviders-coubEditorUpload:EventRawVideoIdKnown";

    CoubEditorUpload.STATE_UPLOADING = "uploading";

    CoubEditorUpload.STATE_TEMP_UPLOAD = "temp upload";

    CoubEditorUpload.STATE_PROCESSING = "processing";

    CoubEditorUpload.STATE_COMPLETED = "completed";

    CoubEditorUpload.STATE_ERROR = "error";

    CoubEditorUpload.STATE_CANCELED = "canceled";

    CoubEditorUpload.ACTION_CANCEL = "dataProviders-coubEditorUpload:Actions:Cancel";

    CoubEditorUpload.prototype.startUploadExternalVideoProcess = function(videoUrl, dispatcher) {
      if (dispatcher == null) {
        dispatcher = this.getDispatcher();
      }
      this.startProcess(dispatcher);
      this.createExternalVideoDownload(videoUrl, {
        success: (function(_this) {
          return function(e) {
            var finish;
            dispatcher.trigger({
              type: _this.s.EVENT_EXTERNAL_DOWNLOAD_CREATED,
              downloadId: e.download_id
            });
            dispatcher.trigger({
              type: _this.s.EVENT_VIDEO_TITLE_KNOWN,
              title: e.title
            });
            finish = function(rv) {
              return dispatcher.trigger({
                type: _this.s.EVENT_ALL_DONE_SUCCESSFULLY,
                respData: rv
              });
            };
            if (e.raw_video != null) {
              return finish(e.raw_video);
            } else {
              dispatcher.trigger(_this.s.EVENT_UPLOADING_START);
              _this.listenUploadingStatusUrl(e.status_url, dispatcher);
              return dispatcher.one(_this.s.EVENT_UPLOADING_COMPLETE, function(e) {
                _this.reactProcessingExpectedTime(dispatcher, e.respData.expected_time);
                dispatcher.trigger(_this.s.EVENT_PROCESSING_START);
                _this.listenProcessingStatusUrl(e.respData.raw_video, dispatcher);
                return dispatcher.one(_this.s.EVENT_PROCESSING_COMPLETE, function(e) {
                  return finish(e.respData);
                });
              });
            }
          };
        })(this),
        error: (function(_this) {
          return function(e) {
            var m, r;
            try {
              r = JSON.parse(e.responseText);
              m = r.error;
            } catch (error1) {
              e = error1;
              m = I18n.t("unknown_error");
            }
            return dispatcher.trigger({
              type: _this.s.EVENT_ERROR_CREATING_EXTERNAL_DOWNLOAD,
              message: m
            });
          };
        })(this)
      });
      return dispatcher;
    };

    CoubEditorUpload.prototype.startUploadExternalAudioProcess = function(audioUrl, dispatcher) {
      if (dispatcher == null) {
        dispatcher = this.getDispatcher();
      }
      this.startProcess(dispatcher);
      this.createExternalAudioDownload(audioUrl, {
        success: (function(_this) {
          return function(e) {
            var listenSuccessHandle;
            dispatcher.trigger({
              type: _this.s.EVENT_EXTERNAL_DOWNLOAD_CREATED,
              downloadId: e.download_id
            });
            dispatcher.trigger(_this.s.EVENT_UPLOADING_START);
            listenSuccessHandle = function(e, i) {
              if (e.attrs != null) {
                clearInterval(i);
                return dispatcher.trigger({
                  type: _this.s.EVENT_UPLOADING_COMPLETE,
                  respData: e
                });
              }
            };
            _this.listenUrl(e.status_url, dispatcher, _this.s.STATE_UPLOADING, listenSuccessHandle);
            return dispatcher.one(_this.s.EVENT_UPLOADING_COMPLETE, function(e) {
              return dispatcher.trigger({
                type: _this.s.EVENT_ALL_DONE_SUCCESSFULLY,
                respData: e.respData
              });
            });
          };
        })(this),
        error: (function(_this) {
          return function(e) {
            return _this.handleError(e, dispatcher, _this.s.EVENT_ERROR_CREATING_EXTERNAL_DOWNLOAD);
          };
        })(this)
      });
      return dispatcher;
    };

    CoubEditorUpload.prototype.startUploadLocalVideoProcess = function(processingUrl, dispatcher) {
      if (dispatcher == null) {
        dispatcher = this.getDispatcher();
      }
      this.startProcess(dispatcher);
      dispatcher.trigger(this.s.EVENT_TEMP_UPLOAD_START);
      this.listenTempUploadStatusUrl(processingUrl, dispatcher);
      dispatcher.one(this.s.EVENT_TEMP_UPLOAD_COMPLETE, (function(_this) {
        return function(e) {
          _this.reactProcessingExpectedTime(dispatcher, e.respData.expected_time);
          dispatcher.trigger(_this.s.EVENT_PROCESSING_START);
          _this.listenProcessingStatusUrl(e.respData.url, dispatcher);
          return dispatcher.one(_this.s.EVENT_PROCESSING_COMPLETE, function(e) {
            return dispatcher.trigger({
              type: _this.s.EVENT_ALL_DONE_SUCCESSFULLY,
              respData: e.respData
            });
          });
        };
      })(this));
      return dispatcher;
    };

    CoubEditorUpload.prototype.startUploadLocalAudioProcess = function(processingUrl, dispatcher) {
      if (dispatcher == null) {
        dispatcher = this.getDispatcher();
      }
      this.startProcess(dispatcher);
      dispatcher.trigger(this.s.EVENT_TEMP_UPLOAD_START);
      dispatcher.on(this.s.EVENT_TEMP_UPLOAD_COMPLETE, (function(_this) {
        return function(e) {
          return dispatcher.trigger({
            type: _this.s.EVENT_ALL_DONE_SUCCESSFULLY,
            respData: e.respData
          });
        };
      })(this));
      this.listenTempUploadStatusUrl(processingUrl, dispatcher);
      return dispatcher;
    };

    CoubEditorUpload.prototype.startTakeMusicFromOtherCoubProcess = function(permalink, dispatcher) {
      var error, success;
      if (dispatcher == null) {
        dispatcher = this.getDispatcher();
      }
      this.startProcess(dispatcher);
      success = (function(_this) {
        return function(e) {
          return dispatcher.trigger({
            type: _this.s.EVENT_ALL_DONE_SUCCESSFULLY,
            respData: e
          });
        };
      })(this);
      error = (function(_this) {
        return function(e) {
          return _this.handleError(e, dispatcher);
        };
      })(this);
      dispatcher.trigger(this.s.EVENT_UPLOADING_START);
      this.getAudioFromCoub(permalink, {
        success: success,
        error: error
      });
      return dispatcher;
    };

    CoubEditorUpload.prototype.getDispatcher = function() {
      return $("<dispatcher>");
    };

    CoubEditorUpload.prototype.handleError = function(e, dispatcher, event) {
      var message, r;
      if (e.message != null) {
        message = e.message;
      } else {
        try {
          r = JSON.parse(e.responseText);
          if (r.message != null) {
            message = r.message;
          } else if (r.error != null) {
            message = r.error;
          }
        } catch (error1) {
          e = error1;
          message = I18n.t("unknown_error");
        }
      }
      if (event == null) {
        event = this.s.EVENT_ERROR_ON_UPLOADING_OR_PROCESSING;
      }
      if (message == null) {
        message = I18n.t("unknown_error");
      }
      return dispatcher.trigger({
        type: event,
        message: message,
        originalEvent: e
      });
    };

    CoubEditorUpload.prototype.startProcess = function(dispatcher) {
      var events, onComplete;
      dispatcher.trigger(this.s.EVENT_PROCESS_STARTED);
      events = [this.s.EVENT_ALL_DONE_SUCCESSFULLY, this.s.EVENT_ERROR_CREATING_EXTERNAL_DOWNLOAD, this.s.EVENT_ERROR_ON_UPLOADING_OR_PROCESSING, this.s.ACTION_CANCEL].join(" ");
      onComplete = (function(_this) {
        return function(e) {
          dispatcher.unbind(events, onComplete);
          return dispatcher.trigger({
            type: _this.s.EVENT_PROCESS_COMPLETED,
            previous: e.type
          });
        };
      })(this);
      dispatcher.on(events, onComplete);
      return dispatcher.on(this.s.ACTION_CANCEL, (function(_this) {
        return function() {
          return dispatcher.trigger(_this.s.EVENT_PROCESS_CANCELED);
        };
      })(this));
    };

    CoubEditorUpload.prototype.startProcessSegmentConverting = function(url, dispatcher) {
      if (dispatcher == null) {
        dispatcher = this.getDispatcher();
      }
      this.startProcess(dispatcher);
      dispatcher.trigger(this.s.EVENT_PROCESSING_START);
      this.listenUrl(url, dispatcher, this.s.STATE_PROCESSING, (function(_this) {
        return function(e, interval) {
          var evt, j, len, ref;
          if (coubEditor.helpers.Reconvert.segmentReconverted(e)) {
            ref = [_this.s.EVENT_PROCESSING_COMPLETE, _this.s.EVENT_ALL_DONE_SUCCESSFULLY];
            for (j = 0, len = ref.length; j < len; j++) {
              evt = ref[j];
              dispatcher.trigger({
                type: evt,
                respData: e
              });
            }
            return clearInterval(interval);
          }
        };
      })(this));
      return dispatcher;
    };

    CoubEditorUpload.prototype.startProcessGetCoubScreenshots = function(rawVideoId, dispatcher) {
      var url;
      if (!dispatcher) {
        dispatcher = this.getDispatcher();
      }
      url = Routes.api_v2_raw_video_path(rawVideoId) + "/processing_status";
      this.startProcess(dispatcher);
      dispatcher.trigger(this.s.EVENT_PROCESSING_START);
      this.checkProcessingStatus(url, ((function(_this) {
        return function(e, i) {
          if (e.data.screens != null) {
            dispatcher.trigger({
              type: _this.s.EVENT_ALL_DONE_SUCCESSFULLY,
              respData: e
            });
            return clearInterval(i);
          }
        };
      })(this)), dispatcher);
      return dispatcher;
    };

    CoubEditorUpload.prototype.startProcessGetUncroppedVideoSource = function(rawVideoId, dispatcher) {
      return this.startProcessCheckField(rawVideoId, ((function(_this) {
        return function(e, i) {
          var vu;
          return (e.data.uncropped != null) && ((vu = e.data.uncropped.video_uncropped) != null) && !(vu.match("missing"));
        };
      })(this)), dispatcher);
    };

    CoubEditorUpload.prototype.startProcessCheckField = function(rawVideoId, check, dispatcher, exactUrl) {
      var url;
      if (dispatcher == null) {
        dispatcher = this.getDispatcher();
      }
      if (exactUrl != null) {
        url = exactUrl;
      } else {
        url = Routes.processing_status_api_v2_raw_video_path(rawVideoId);
      }
      this.startProcess(dispatcher);
      dispatcher.trigger(this.s.EVENT_PROCESSING_START);
      this.checkProcessingStatus(url, ((function(_this) {
        return function(e, i) {
          if (check(e, i) === true) {
            dispatcher.trigger({
              type: _this.s.EVENT_ALL_DONE_SUCCESSFULLY,
              respData: e
            });
            return clearInterval(i);
          }
        };
      })(this)), dispatcher);
      return dispatcher;
    };

    CoubEditorUpload.prototype.checkProcessingStatus = function(url, intervalHandler, dispatcher) {
      if (dispatcher == null) {
        dispatcher = this.getDispatcher();
      }
      this.listenUrl(url, dispatcher, this.s.STATE_PROCESSING, (function(_this) {
        return function(e, i) {
          if (e.expected_time != null) {
            dispatcher.trigger({
              type: _this.s.EVENT_EXPECTED_TIME_KNOWN,
              time: e.expected_time
            });
          }
          if (intervalHandler != null) {
            return intervalHandler(e, i);
          }
        };
      })(this));
      return dispatcher;
    };

    CoubEditorUpload.prototype.reactProcessingExpectedTime = function(dispatcher, time) {
      return dispatcher.trigger({
        type: this.s.EVENT_PROCESSING_EXPECTED_TIME_KNOWN,
        time: time
      });
    };

    CoubEditorUpload.prototype.reactRawVideoIdKnown = function(dispatcher, rwid) {
      return dispatcher.trigger({
        type: this.s.EVENT_RAW_VIDEO_ID_KNOWN,
        raw_video_id: rwid
      });
    };

    CoubEditorUpload.prototype.rtmpGetLink = function(xhrParams) {
      var data;
      if (xhrParams == null) {
        xhrParams = {};
      }
      data = {
        type: "POST",
        url: Routes.api_v2_rtmp_uploads_path()
      };
      return $.ajax($.extend(data, xhrParams));
    };

    CoubEditorUpload.prototype.rtmpRecorded = function(fileName, xhrParams) {
      var data;
      if (xhrParams == null) {
        xhrParams = {};
      }
      data = {
        type: "POST",
        url: Routes.uploaded_api_v2_rtmp_uploads_path(),
        data: {
          path: fileName
        }
      };
      return $.ajax($.extend(data, xhrParams));
    };

    return CoubEditorUpload;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.CoubsChangerDataProvider = (function() {
    function CoubsChangerDataProvider() {
      this.getPage = bind(this.getPage, this);
      this.getInitialPage = bind(this.getInitialPage, this);
    }

    CoubsChangerDataProvider.prototype.getInitialPage = function(channel_id, coub_id, success, error) {
      return $.ajax({
        url: "/api/v2/timeline/changer/" + channel_id + ".json?page_of=" + coub_id + "&per_page=1",
        type: "GET",
        success: success,
        error: error
      });
    };

    CoubsChangerDataProvider.prototype.getPage = function(channel_id, page, per_page, success, error) {
      return $.ajax({
        url: "/api/v2/timeline/changer/" + channel_id + ".json?page=" + page + "&per_page=" + per_page,
        type: "GET",
        success: success,
        error: error
      });
    };

    CoubsChangerDataProvider.prototype.getCoubsBetween = function(channel_id, coub_id, limit, success, error) {
      return $.ajax({
        url: "/api/v2/timeline/changer/" + channel_id + ".json?between=" + coub_id + "&limit=" + limit,
        type: "GET",
        success: success,
        error: error
      });
    };

    CoubsChangerDataProvider.prototype.getCoubsAfter = function(channel_id, coub_id, limit, success, error) {
      return $.ajax({
        url: "/api/v2/timeline/changer/" + channel_id + ".json?after=" + coub_id + "&limit=" + limit,
        type: "GET",
        success: success,
        error: error
      });
    };

    CoubsChangerDataProvider.prototype.getCoubsBefore = function(channel_id, coub_id, limit, success, error) {
      return $.ajax({
        url: "/api/v2/timeline/changer/" + channel_id + ".json?before=" + coub_id + "&limit=" + limit,
        type: "GET",
        success: success,
        error: error
      });
    };

    return CoubsChangerDataProvider;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.EditorCoubCatFlagDataProvider = (function() {
    function EditorCoubCatFlagDataProvider() {
      this.deleteAllAbuses = bind(this.deleteAllAbuses, this);
      this.deleteAbuse = bind(this.deleteAbuse, this);
      this.publishEditorExploreDelayedQueue = bind(this.publishEditorExploreDelayedQueue, this);
      this.reorderEditorExploreDelayedQueue = bind(this.reorderEditorExploreDelayedQueue, this);
      this.getEditorExploreDelayedQueue = bind(this.getEditorExploreDelayedQueue, this);
      this.reorderChannelRecoubsQueue = bind(this.reorderChannelRecoubsQueue, this);
      this.getEditorChannelRecoubsQueue = bind(this.getEditorChannelRecoubsQueue, this);
      this.publishEditorChannelDelayedRecoub = bind(this.publishEditorChannelDelayedRecoub, this);
      this.getCheckboxes = bind(this.getCheckboxes, this);
      this.popCoub = bind(this.popCoub, this);
      this.updateFlagsOrCategories = bind(this.updateFlagsOrCategories, this);
    }

    EditorCoubCatFlagDataProvider.prototype.updateFlagsOrCategories = function(coubId, flags, success, error) {
      if (coubId == null) {
        ({
          "throw": "EditorCoubCatFlagDataProvider: updateFlagsOrCategories require coubId"
        });
      }
      return $.ajax({
        url: Routes.update_flags_or_categories_editor_coub_path(coubId),
        type: "PUT",
        dataType: "json",
        data: {
          "flags": flags
        },
        success: success,
        error: error
      });
    };

    EditorCoubCatFlagDataProvider.prototype.popCoub = function(coubId, success, error) {
      return $.ajax({
        url: "/editor/coubs/" + coubId + "/pop",
        type: "PUT",
        dataType: "json",
        success: success,
        error: error
      });
    };

    EditorCoubCatFlagDataProvider.prototype.getCheckboxes = function(permalink, success, error, complete) {
      return $.ajax({
        url: Routes.checkboxes_editor_coubs_path(permalink),
        type: "GET",
        success: success,
        error: error,
        complete: complete
      });
    };

    EditorCoubCatFlagDataProvider.prototype.publishEditorChannelDelayedRecoub = function(recoubId, success, error) {
      return $.ajax({
        url: Routes.publish_now_editor_coub_path({
          id: recoubId
        }),
        type: 'POST',
        dataType: 'json',
        success: success,
        error: error
      });
    };

    EditorCoubCatFlagDataProvider.prototype.getEditorChannelRecoubsQueue = function(channelId, success, error) {
      return $.ajax({
        url: Routes.api_v2_unified_admin_coubs_path(),
        type: 'GET',
        dataType: 'json',
        data: {
          published: false,
          reorder_by: {
            field_name: 'position',
            direction: 'asc'
          },
          by_channel: channelId,
          coub_types: ['recoub'],
          api_template: 'v2',
          per_page: 'all'
        },
        success: success,
        error: error
      });
    };

    EditorCoubCatFlagDataProvider.prototype.reorderChannelRecoubsQueue = function(data, success, error) {
      return $.ajax({
        url: Routes.reorder_api_v2_unified_admin_coub_path({
          id: data.id
        }),
        type: 'PUT',
        dataType: 'json',
        data: data,
        success: success,
        error: error
      });
    };

    EditorCoubCatFlagDataProvider.prototype.getEditorExploreDelayedQueue = function(params, success, error) {
      if (params == null) {
        params = {};
      }
      return $.ajax({
        url: Routes.api_v2_editor_explore_index_path(),
        type: 'GET',
        data: {
          per_page: 'all',
          api_template: 'v2'
        },
        dataType: 'json',
        success: success,
        error: error
      });
    };

    EditorCoubCatFlagDataProvider.prototype.reorderEditorExploreDelayedQueue = function(data, success, error) {
      return $.ajax({
        url: Routes.batch_update_api_v2_editor_explore_index_path(),
        type: 'POST',
        dataType: 'json',
        data: {
          ids: data.ids
        },
        success: success,
        error: error
      });
    };

    EditorCoubCatFlagDataProvider.prototype.publishEditorExploreDelayedQueue = function(id, success, error) {
      return $.ajax({
        url: Routes.publish_now_api_v2_editor_explore_index_path({
          id: id
        }),
        type: 'POST',
        dataType: 'json',
        success: success,
        error: error
      });
    };

    EditorCoubCatFlagDataProvider.prototype.deleteAbuse = function(id, success, error) {
      return $.ajax({
        url: Routes.abuses_path() + ("/" + id),
        type: 'DELETE',
        success: success,
        error: error
      });
    };

    EditorCoubCatFlagDataProvider.prototype.deleteAllAbuses = function(coubId, success, error) {
      return $.ajax({
        url: Routes.mass_destroy_api_v2_abuses_path(coubId),
        type: 'DELETE',
        success: success,
        error: error
      });
    };

    return EditorCoubCatFlagDataProvider;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  dataProviders.EditorWeeklyDataProvider = (function() {
    function EditorWeeklyDataProvider() {
      this.removeItem = bind(this.removeItem, this);
      this.addItemViaPermalink = bind(this.addItemViaPermalink, this);
      this.addItemViaId = bind(this.addItemViaId, this);
      this.repositionItemInDigest = bind(this.repositionItemInDigest, this);
      this.sendTestMail = bind(this.sendTestMail, this);
      this.didgestReady = bind(this.didgestReady, this);
      if (dataProviders.EditorWeeklyDataProvider.__instance == null) {
        dataProviders.EditorWeeklyDataProvider.__instance = this;
      } else {
        return dataProviders.EditorWeeklyDataProvider.__instance;
      }
    }

    EditorWeeklyDataProvider.prototype.didgestReady = function(id, xhrParams) {
      var params;
      if (xhrParams == null) {
        xhrParams = {};
      }
      params = {
        url: Routes.api_v2_editor_weekly_digest_path(id),
        type: "PUT",
        data: {
          weekly_digest: {
            is_done: true
          }
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    EditorWeeklyDataProvider.prototype.sendTestMail = function(id, xhrParams) {
      var params;
      if (xhrParams == null) {
        xhrParams = {};
      }
      params = {
        url: Routes.send_test_mail_editor_weekly_digest_path(id),
        type: "POST"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    EditorWeeklyDataProvider.prototype.repositionItemInDigest = function(id, itemId, type, position, xhrParams) {
      var params;
      if (xhrParams == null) {
        xhrParams = {};
      }
      params = {
        url: Routes.api_v2_editor_weekly_digest_items_path() + ("/" + itemId),
        type: "PUT",
        data: {
          weekly_digest_id: id,
          entity_type: type,
          position: position
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    EditorWeeklyDataProvider.prototype.addItemViaId = function(id, itemId, type, xhrParams) {
      var params;
      if (xhrParams == null) {
        xhrParams = {};
      }
      params = {
        url: Routes.api_v2_editor_weekly_digest_items_path(),
        type: "POST",
        data: {
          weekly_digest_item: {
            weekly_digest_id: id,
            entity_type: type,
            entity_id: itemId
          }
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    EditorWeeklyDataProvider.prototype.addItemViaPermalink = function(id, permalink, type, xhrParams) {
      var params;
      if (xhrParams == null) {
        xhrParams = {};
      }
      params = {
        url: Routes.api_v2_editor_weekly_digest_items_path(),
        type: "POST",
        data: {
          weekly_digest_item: {
            weekly_digest_id: id,
            entity_type: type,
            entity_permalink: permalink
          }
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    EditorWeeklyDataProvider.prototype.removeItem = function(id, itemId, type, xhrParams) {
      var params;
      if (xhrParams == null) {
        xhrParams = {};
      }
      params = {
        url: Routes.api_v2_editor_weekly_digest_items_path() + ("/" + itemId),
        type: "DELETE",
        data: {
          weekly_digest_id: id,
          entity_type: type,
          id: itemId
        }
      };
      return $.ajax($.extend(params, xhrParams));
    };

    return EditorWeeklyDataProvider;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.LoginDataProvider = (function() {
    function LoginDataProvider() {
      this.signupOAuthLogic = bind(this.signupOAuthLogic, this);
      this.signupLogic = bind(this.signupLogic, this);
      this.setPreviousCover = bind(this.setPreviousCover, this);
      this.saveCoverPosition = bind(this.saveCoverPosition, this);
      this.deleteCover = bind(this.deleteCover, this);
      this.changeCoverToCoub = bind(this.changeCoverToCoub, this);
      this.changeCoverToImage = bind(this.changeCoverToImage, this);
      this.changeCover = bind(this.changeCover, this);
      this.confirmDeletion = bind(this.confirmDeletion, this);
      this.confirmPassword = bind(this.confirmPassword, this);
      this.validateChannelPermalink = bind(this.validateChannelPermalink, this);
      this.validateAndCheckUniqEmailAndPermalink = bind(this.validateAndCheckUniqEmailAndPermalink, this);
      this.deleteAvatar = bind(this.deleteAvatar, this);
      this.changePassword = bind(this.changePassword, this);
      this.checkEmailUniq = bind(this.checkEmailUniq, this);
      this.signup = bind(this.signup, this);
      this.signin = bind(this.signin, this);
      this.resendEmailVerification = bind(this.resendEmailVerification, this);
      this.recoverPasswordRequest = bind(this.recoverPasswordRequest, this);
      this.recoveryPassword = bind(this.recoveryPassword, this);
      if (!LoginDataProvider.__instance) {
        LoginDataProvider.__instance = this;
      } else {
        return LoginDataProvider.__instance;
      }
    }

    LoginDataProvider.prototype.recoveryPassword = function(data, success, error) {
      return $.ajax({
        url: "/reset_password",
        type: "PUT",
        data: data,
        success: success,
        error: error
      });
    };

    LoginDataProvider.prototype.recoverPasswordRequest = function(data, success, error) {
      return $.ajax({
        url: "/recover_password",
        type: "PUT",
        data: data,
        success: success,
        error: error
      });
    };

    LoginDataProvider.prototype.resendEmailVerification = function(success, error) {
      return $.ajax({
        url: "/users/resend_email_verification",
        type: "PUT",
        data: {},
        success: success,
        error: error
      });
    };

    LoginDataProvider.prototype.signin = function(data, success, error) {
      var url;
      url = window.env === 'production' ? "https://coub.com/signin" : "/signin";
      return $.ajax({
        url: url,
        xhrFields: {
          withCredentials: true
        },
        type: "PUT",
        data: data,
        success: success,
        error: error
      });
    };

    LoginDataProvider.prototype.signup = function(data, success, error) {
      var url;
      url = window.env === 'production' ? "https://coub.com/signup.json" : "/signup.json";
      return $.ajax({
        url: url,
        xhrFields: {
          withCredentials: true
        },
        type: "POST",
        data: data,
        success: success,
        error: error
      });
    };

    LoginDataProvider.prototype.checkEmailUniq = function(data, success, error) {
      return $.ajax({
        url: "/check_email",
        type: "GET",
        data: data,
        dataType: 'json',
        success: success,
        error: error
      });
    };

    LoginDataProvider.prototype.changePassword = function(data, success, error) {
      return $.ajax({
        url: "/profile/update_private_info",
        type: "PUT",
        data: data,
        success: success,
        error: error
      });
    };

    LoginDataProvider.prototype.deleteAvatar = function(success, error, complete) {
      return $.ajax({
        url: "/profile/delete_avatar",
        type: "PUT",
        success: success,
        error: error,
        complete: complete
      });
    };

    LoginDataProvider.prototype.validateAndCheckUniqEmailAndPermalink = function(email, permalink, success, error, complete) {
      return $.ajax({
        url: "/users/check_uniqueness_and_validate",
        type: "GET",
        data: {
          "user[email]": email,
          "user[permalink]": permalink
        },
        success: success,
        error: error,
        complete: complete
      });
    };

    LoginDataProvider.prototype.validateChannelPermalink = function(permalink, channelId, success, error, complete) {
      var data;
      data = {
        "channel[permalink]": permalink
      };
      if (channelId != null) {
        data = $.extend({
          id: channelId
        }, data);
      }
      return $.ajax({
        url: "/api/v2/channels/validate_permalink",
        type: "GET",
        data: data,
        success: success,
        error: error,
        complete: complete
      });
    };

    LoginDataProvider.prototype.confirmPassword = function(password, success, error) {
      return $.ajax({
        url: "/users/validate_password",
        type: "PUT",
        data: {
          password: password
        },
        success: success,
        error: error
      });
    };

    LoginDataProvider.prototype.confirmDeletion = function(password, success, error) {
      return $.ajax({
        url: "/users/delete_account",
        type: "DELETE",
        data: {
          password: password
        },
        success: success,
        error: error
      });
    };

    LoginDataProvider.prototype.changeCover = function(data, success, error) {
      return $.ajax({
        url: "/profile/background/create",
        type: "POST",
        dataType: "json",
        data: data,
        success: success,
        error: error
      });
    };

    LoginDataProvider.prototype.changeCoverToImage = function(image, success, error) {
      return this.changeCover($.param({
        background: {
          image: image,
          y: 0
        }
      }), success, error);
    };

    LoginDataProvider.prototype.changeCoverToCoub = function(permalink, success, error) {
      return this.changeCover($.param({
        background: {
          coub: permalink,
          y: 0
        }
      }), success, error);
    };

    LoginDataProvider.prototype.deleteCover = function(success, error) {
      return $.ajax({
        url: "/profile/background/destroy",
        type: "DELETE",
        success: success,
        error: error
      });
    };

    LoginDataProvider.prototype.saveCoverPosition = function(y, success, error) {
      return $.ajax({
        url: "/profile/background/update",
        data: {
          offset_y: y
        },
        type: "PUT",
        success: success,
        error: error
      });
    };

    LoginDataProvider.prototype.setPreviousCover = function(success, error) {
      return $.ajax({
        url: "/profile/background/set_previous",
        type: "PUT",
        success: success,
        error: error
      });
    };

    LoginDataProvider.prototype.shareCoubByEmail = function(data, address, xhrParams) {
      var params;
      params = {
        url: address,
        data: data,
        type: "POST",
        dataType: "json"
      };
      return $.ajax($.extend(params, xhrParams));
    };

    LoginDataProvider.prototype.signupLogic = function(data, redirect, error, isOauth, callbacks) {
      var success;
      if (redirect == null) {
        redirect = false;
      }
      if (error == null) {
        error = void 0;
      }
      if (isOauth == null) {
        isOauth = false;
      }
      if (callbacks.beforeSignup != null) {
        callbacks.beforeSignup();
      }
      success = (function(_this) {
        return function(resp) {
          var props, root, url;
          props = {};
          if (GlobalState.TIMELINE.type() === "mainpage") {
            url = $("[clientside-timeline]").attr("url");
            props.timeline_source_url = url;
          }
          Stats.track("signup_success", props);
          if (redirect) {
            if (_this.isOauth) {
              root = resp.oauth_redirect;
            } else if (resp.redirect != null) {
              root = resp.redirect;
            } else {
              root = Routes.root_path();
            }
            return $.handleRedirect(root);
          } else {
            $.extend(true, window.gon, {
              is_logged_in: true,
              current_user: resp.user,
              current_channel_id: resp.user.current_channel.id
            });
            if (callbacks.afterSignup != null) {
              callbacks.afterSignup(resp);
            }
            return Stats.track('user_created', {
              signupProvider: _this.signupProvider
            });
          }
        };
      })(this);
      error = (function(_this) {
        return function(resp) {
          if (callbacks.error != null) {
            return callbacks.error(resp);
          }
        };
      })(this);
      return this.signup({
        session: data
      }, success, error);
    };

    LoginDataProvider.prototype.signupOAuthLogic = function(data, callbacks) {
      var error, params, success;
      if (callbacks == null) {
        callbacks = {};
      }
      success = (function(_this) {
        return function(resp) {
          var rd, regData;
          if (callbacks.authChecked != null) {
            callbacks.authChecked();
          }
          rd = new siteData.RegistrationData();
          rd.fillData(data);
          regData = _this.serializeOAuthData(data);
          if (resp.result.oauth === 'taken' || resp.result.phone_number === 'taken') {
            if (callbacks.signin != null) {
              return callbacks.signin(resp, regData);
            }
          } else if ((resp.result.email != null) && ['google', 'facebook'].indexOf(regData.provider) !== -1) {
            if (callbacks.signup != null) {
              return callbacks.signup(resp, rd.get("collectedData"), true);
            }
          } else if (rd.get("collectedData").email != null) {
            if (callbacks.signup != null) {
              return callbacks.signup(resp, rd.get("collectedData"), false);
            }
          } else if (regData.provider === 'firebase_auth') {
            if (callbacks.collectUsername != null) {
              return callbacks.collectUsername(resp, regData);
            }
          } else {
            if (callbacks.collectMail != null) {
              return callbacks.collectMail(resp, regData);
            }
          }
        };
      })(this);
      error = (function(_this) {
        return function(resp) {
          if (callbacks.error != null) {
            return callbacks.error(resp);
          }
        };
      })(this);
      params = {
        provider: data.provider,
        uid: data.uid,
        email: data.email,
        phone_number: data.phone_number
      };
      return $.get(Routes.check_uniqueness_api_v2_sessions_path(), {
        session: params
      }).done(success).fail(error);
    };

    LoginDataProvider.prototype.serializeOAuthData = function(data) {
      return {
        provider: data.provider,
        uid: data.uid,
        token: data.token,
        secret: data.secret,
        phone_number: data.phone_number
      };
    };

    return LoginDataProvider;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.PossibleFriendsDataProvider = (function() {
    function PossibleFriendsDataProvider() {
      this.inviteFriendsViaProvider = bind(this.inviteFriendsViaProvider, this);
    }

    PossibleFriendsDataProvider.prototype.findPossibleFriends = function(providers, success, failure) {
      return $.ajax({
        url: "/api/v2/friends/find",
        type: "GET",
        data: {
          providers: providers
        },
        success: success,
        failure: failure
      });
    };

    PossibleFriendsDataProvider.prototype.loadFriendsToFollow = function(page_num, custom, success, failure) {
      return $.ajax({
        url: "/api/v2/friends?page=" + page_num,
        type: "GET",
        data: custom,
        success: success,
        failure: failure
      });
    };

    PossibleFriendsDataProvider.prototype.massFollow = function(ids, success, failure) {
      return $.ajax({
        url: "/api/v2/follows/mass_follow",
        type: "POST",
        data: {
          ids_list: {
            following: ids
          }
        },
        success: success,
        failure: failure
      });
    };

    PossibleFriendsDataProvider.prototype.loadFriendsToInvite = function(page, custom, success, failure) {
      return $.ajax({
        url: "/api/v2/friends/show_unregistered_friends?page=" + page,
        type: "GET",
        data: custom,
        success: success,
        failure: failure
      });
    };

    PossibleFriendsDataProvider.prototype.followAllFriendsFromProvider = function(provider, q) {
      return $.post('/api/v2/follows/follow_all_friends_from_provider', {
        provider: provider,
        q: q
      });
    };

    PossibleFriendsDataProvider.prototype.inviteAllFriends = function(success, failure) {
      return this.inviteFriends([], success, failure);
    };

    PossibleFriendsDataProvider.prototype.inviteFriends = function(ids, success, failure) {
      var data;
      if (ids.length === 0) {
        data = {
          invite_type: "all"
        };
      } else {
        data = {
          invite_type: "scope",
          invites_list: ids
        };
      }
      return $.ajax({
        url: "/api/v2/invites/invite_friends_scope",
        type: "POST",
        data: data,
        success: success,
        failure: failure
      });
    };

    PossibleFriendsDataProvider.prototype.inviteFriendsViaProvider = function(data, success, error) {
      return $.ajax({
        url: "/api/v2/invites/invite_friends_via_provider",
        type: "POST",
        data: data,
        success: success,
        error: error
      });
    };

    PossibleFriendsDataProvider.prototype.inviteAllFriendsFromProvider = function(provider, custom) {
      return $.post('/api/v2/invites/invite_all_friends_from_provider', $.extend({
        provider: provider
      }, custom));
    };

    PossibleFriendsDataProvider.prototype.markFriendsAsInvited = function(friends_ids) {
      return $.post('/api/v2/invites/mark_as_invited', $.param({
        ids: friends_ids
      }, true));
    };

    PossibleFriendsDataProvider.prototype.showRegisteredFriends = function(page_num, custom, success, failure) {
      return $.ajax({
        url: "/api/v2/friends?page=" + page_num,
        type: "GET",
        data: custom,
        success: success,
        failure: failure
      });
    };

    PossibleFriendsDataProvider.prototype.showUnregisteredFriends = function(page_num, custom, success, failure) {
      return $.ajax({
        url: "/api/v2/friends/show_unregistered_friends?page=" + page_num,
        type: "GET",
        data: custom,
        success: success,
        failure: failure
      });
    };

    return PossibleFriendsDataProvider;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.RawVideoAnnouncementDataProvider = (function() {
    function RawVideoAnnouncementDataProvider() {
      this.processing = bind(this.processing, this);
      if (RawVideoAnnouncementDataProvider.__instance == null) {
        RawVideoAnnouncementDataProvider.__instance = this;
      } else {
        return RawVideoAnnouncementDataProvider.__instance;
      }
    }

    RawVideoAnnouncementDataProvider.prototype.PROCESSING_TIMEOUT = 3000;

    RawVideoAnnouncementDataProvider.prototype.PROCESSING_EVENTS = {
      STAGE_CHANGED: "RawVideoAnnouncementDataProvider:ProcessingEvents:StateChanged",
      COMPLETE: "RawVideoAnnouncementDataProvider:ProcessingEvents:Complete",
      UPDATE: "RawVideoAnnouncementDataProvider:ProcessingEvents:Update"
    };

    RawVideoAnnouncementDataProvider.prototype.processing = function(url) {
      var checkStatus, currentStage, dispatcher, procUrl;
      procUrl = url.substring(0, url.length);
      dispatcher = $({});
      currentStage = void 0;
      checkStatus = (function(_this) {
        return function() {
          return $.get(procUrl, function(d) {
            if (currentStage !== d.stage) {
              currentStage = d.stage;
              dispatcher.trigger({
                type: _this.PROCESSING_EVENTS.STAGE_CHANGED,
                resp: d
              });
            }
            if (d.stage === "processing" && d.percent === 100) {
              return dispatcher.trigger({
                type: _this.PROCESSING_EVENTS.COMPLETE,
                resp: d
              });
            } else {
              dispatcher.trigger({
                type: _this.PROCESSING_EVENTS.UPDATE,
                resp: d
              });
              return setTimeout(checkStatus, _this.PROCESSING_TIMEOUT);
            }
          });
        };
      })(this);
      return {
        dispather: dispatcher,
        start: checkStatus
      };
    };

    return RawVideoAnnouncementDataProvider;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.SearchPopupDataProvider = (function() {
    function SearchPopupDataProvider() {
      this.deleteAllRecentItems = bind(this.deleteAllRecentItems, this);
      this.addRecentItem = bind(this.addRecentItem, this);
      this.deleteRecentItem = bind(this.deleteRecentItem, this);
      this.getSearchLog = bind(this.getSearchLog, this);
      this.getResults = bind(this.getResults, this);
      this.errorMessage = bind(this.errorMessage, this);
    }

    SearchPopupDataProvider.prototype.errorMessage = function() {
      return ErrorMessages.internalServerError();
    };

    SearchPopupDataProvider.prototype.getResults = function(key, success, error) {
      return $.ajax({
        url: "/api/v2/search/autocomplete?q=" + key,
        type: "GET",
        success: success,
        error: error
      });
    };

    SearchPopupDataProvider.prototype.getSearchLog = function(success, data) {
      if (data == null) {
        data = {};
      }
      return $.ajax({
        url: "/api/v2/search_logs",
        data: data,
        type: "GET",
        success: success,
        error: (function(_this) {
          return function() {
            return _this.errorMessage();
          };
        })(this)
      });
    };

    SearchPopupDataProvider.prototype.deleteRecentItem = function(id, success, data, error) {
      if (data == null) {
        data = {};
      }
      return $.ajax({
        url: "/api/v2/search_logs/" + id,
        data: data,
        type: "DELETE",
        success: success,
        error: error
      });
    };

    SearchPopupDataProvider.prototype.addRecentItem = function(data) {
      if (data == null) {
        data = {};
      }
      return $.ajax({
        url: "/api/v2/search_logs",
        data: data,
        type: "POST",
        error: (function(_this) {
          return function() {
            return _this.errorMessage();
          };
        })(this)
      });
    };

    SearchPopupDataProvider.prototype.deleteAllRecentItems = function(success, data) {
      if (data == null) {
        data = {};
      }
      return $.ajax({
        url: "/api/v2/search_logs/destroy_all",
        data: data,
        type: "DELETE",
        success: success,
        error: (function(_this) {
          return function() {
            return _this.errorMessage();
          };
        })(this)
      });
    };

    return SearchPopupDataProvider;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.SocialSharingDataProvider = (function() {
    SocialSharingDataProvider.TYPES = {
      FACEBOOK: {
        name: "facebook",
        getPopupUrl: function(encoded_title, url) {
          return "https://www.facebook.com/sharer/sharer.php?u=" + (encodeURIComponent(url)) + "&title=" + encoded_title;
        }
      },
      TWITTER: {
        name: "twitter",
        getPopupUrl: function(encoded_title, url) {
          return "https://twitter.com/intent/tweet?text=" + encoded_title + "%20" + (encodeURIComponent(url)) + "%20@coub";
        },
        popupH: 450
      },
      TUMBLR: {
        name: "tumblr",
        getPopupUrl: function(encoded_title, url) {
          return "http://www.tumblr.com/share/video?embed=" + (encodeURIComponent(url)) + "&caption=" + encoded_title;
        }
      },
      STUMBLEUPON: {
        name: "stumbleupon",
        getPopupUrl: function(encoded_title, url) {
          return "http://www.stumbleupon.com/submit?url=" + (encodeURIComponent(url)) + "&title=" + encoded_title;
        },
        popupW: 800,
        popupH: 590
      },
      GOOGLEPLUS: {
        name: "google_plus",
        getPopupUrl: function(encoded_title, url) {
          return "https://plus.google.com/share?url=" + (encodeURIComponent(url));
        },
        popupW: 500
      },
      VKONTAKTE: {
        name: "vkontakte",
        getPopupUrl: function(encoded_title, url) {
          return "http://vk.com/share.php?url=" + (encodeURIComponent(url)) + "&title=" + encoded_title;
        }
      },
      SURFINGBIRD: {
        name: "surfingbird",
        getPopupUrl: function(encoded_title, url) {
          return "http://surfingbird.ru/share?url=" + (encodeURIComponent(url));
        }
      },
      PINTEREST: {
        name: "pinterest",
        getPopupUrl: function(encoded_title, url, img) {
          return "http://www.pinterest.com/pin/create/button/?url=" + (encodeURIComponent(url)) + "&description=" + encoded_title + "&media=" + (encodeURIComponent(img));
        }
      },
      ODNOKLASSNIKI: {
        name: "odnoklassniki",
        getPopupUrl: function(encoded_title, url, img) {
          return "http://www.odnoklassniki.ru/dk?st.cmd=addShare&st._surl=" + (encodeURIComponent(url)) + "&st.comments=" + encoded_title;
        }
      },
      LINKEDIN: {
        name: "linkedin",
        getPopupUrl: function(encoded_title, url, img) {
          return "http://www.linkedin.com/shareArticle?mini=true&url=" + (encodeURIComponent(url)) + "&summary=" + encoded_title + "&source=Coub";
        }
      },
      REDDIT: {
        name: "reddit",
        getPopupUrl: function(encoded_title, url, img) {
          return "http://reddit.com/submit?url=" + (encodeURIComponent(url)) + "&title=" + encoded_title;
        }
      },
      KANOBU: {
        name: "kanobu",
        getPopupUrl: function(encoded_title, url, img) {
          return "http://kanobu.ru/pub/share/?url=" + (encodeURIComponent(url)) + "&title=" + encoded_title;
        }
      },
      WATSAPP: {
        name: "watsapp",
        onClick: function(e, w) {
          var url;
          if (!w.isDisabled()) {
            url = "whatsapp://send?text=" + w.title + "%20" + (encodeURIComponent(w.url || Routes.view_coub_by_permalink_url(w.permalink)));
            window.top.location = url;
            return w.track();
          }
        }
      },
      MESSENGER: {
        name: "messenger",
        onClick: function(e, w) {
          var url;
          if (w.isDisabled()) {
            return;
          }
          url = "fb-messenger://share?link=" + (encodeURIComponent(w.url || Routes.view_coub_by_permalink_url(w.permalink)));
          window.top.location = url;
          return w.track();
        }
      },
      TELEGRAM: {
        name: "telegram",
        getPopupUrl: function(encoded_title, url) {
          return "https://telegram.me/share/url?url=" + url;
        }
      }
    };

    function SocialSharingDataProvider() {
      this.getProviderByName = bind(this.getProviderByName, this);
      if (SocialSharingDataProvider.__instance == null) {
        SocialSharingDataProvider.__instance = this;
        this.TYPES = SocialSharingDataProvider.TYPES;
      } else {
        return SocialSharingDataProvider.__instance;
      }
    }

    SocialSharingDataProvider.prototype.getProviderByName = function(name) {
      var k, ref, v;
      ref = this.TYPES;
      for (k in ref) {
        v = ref[k];
        if (v.name === name) {
          return v;
        }
      }
      return void 0;
    };

    SocialSharingDataProvider.getDefaultProvidersOrder = function() {
      var p;
      p = SocialSharingDataProvider.TYPES;
      if (GlobalState.COUNTRY.isRussia()) {
        return [p.FACEBOOK, p.TWITTER, p.VKONTAKTE, p.SURFINGBIRD, p.GOOGLEPLUS, p.TUMBLR, p.PINTEREST];
      } else {
        return [p.FACEBOOK, p.TWITTER, p.TUMBLR, p.STUMBLEUPON, p.GOOGLEPLUS, p.PINTEREST];
      }
    };

    return SocialSharingDataProvider;

  })();

}).call(this);
(function() {
  window.StatsDataProvider = {
    coubIncrementViews: function(permalink, player, isEmbed) {
      var embed_origin, params, platform, referrer, type, url;
      type = isEmbed ? GlobalState.PLATFORM.isVkIosApp() || GlobalState.PLATFORM.isVkAndroidApp() ? 'app_embed' : 'embed' : 'site';
      platform = GlobalState.PLATFORM.isMobile() ? GlobalState.PLATFORM.isAndroid() ? 'android' : GlobalState.PLATFORM.isIos() ? 'ios' : 'mobile' : 'desktop';
      params = {
        player: player,
        type: type,
        platform: platform
      };
      if (isEmbed) {
        referrer = GlobalState.PAGE.getReferrer();
        embed_origin = new URLRepresent(referrer).getDomain();
        if (!embed_origin && helpers.Location.isVkontakteEmbed()) {
          embed_origin = 'vk.com';
        }
        if (embed_origin != null) {
          params.embed_origin = embed_origin;
        }
      }
      url = "/coubs/" + permalink + "/increment_views?" + ($.param(params));
      $.post(url);
      return console.log("[INCREMENT_VIEW]", url);
    }
  };

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.TimelineDataProvider = (function() {
    function TimelineDataProvider() {
      this.bookmarkedParams = bind(this.bookmarkedParams, this);
      this.oldCatsParams = bind(this.oldCatsParams, this);
      this.setEditorTimelineType = bind(this.setEditorTimelineType, this);
      this.getByUrl = bind(this.getByUrl, this);
    }

    TimelineDataProvider.prototype.getByUrl = function(url, data, xhrParams) {
      var params;
      if (data == null) {
        data = {};
      }
      params = {
        url: url,
        type: "GET",
        dataType: "json",
        data: data
      };
      return $.ajax($.extend(params, xhrParams));
    };

    TimelineDataProvider.COUBS_TYPE = {
      ALL: "",
      SIMPLE: "simples",
      RECOUBS: "recoubs",
      LIKES: "likes"
    };

    TimelineDataProvider.FILTER = {
      COUBS_TYPE: "type",
      ORDER_BY: "order_by",
      SCOPE: "scope"
    };

    TimelineDataProvider.EDITOR_FILTER = {
      REORDER_BY: {
        FIELD_NAME: 'field_name',
        DIRECTION: 'desc'
      }
    };

    TimelineDataProvider.UNIFIED_ADMIN_FILTER = {
      BOOKMARKED: 'bookmarked',
      OLD_CATEGORIES: 'old_categories'
    };

    TimelineDataProvider.prototype.setEditorTimelineType = function(type) {
      switch (type) {
        case 'bookmarked':
          return this.bookmarkedParams();
        case 'old_categories':
          return this.oldCatsParams();
      }
    };

    TimelineDataProvider.prototype.oldCatsParams = function() {
      return {
        reorder_by: {
          field_name: 'created_at',
          direction: 'desc'
        },
        by_period: {
          field_name: 'created_at',
          from: null,
          to: null
        },
        visible_on_explore: true,
        visible_for_public: true,
        visible: true,
        without_editor_channels: true,
        by_category: 'all'
      };
    };

    TimelineDataProvider.prototype.bookmarkedParams = function() {
      return {
        reorder_by: {
          field_name: 'bookmarked_at',
          direction: 'desc'
        },
        by_period: {
          from: null,
          to: null,
          field_name: 'bookmarked_at'
        },
        bookmarked: true
      };
    };

    return TimelineDataProvider;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.TimelineViewDataProvider = (function() {
    TimelineViewDataProvider.prototype.KEY = "profile_layout";

    TimelineViewDataProvider.prototype.LIST = "list";

    TimelineViewDataProvider.prototype.MOSAIC = "mosaic";

    TimelineViewDataProvider.VIEW_CHANGED_EVENT = "TimelineViewDataProvider:ViewChanged";

    TimelineViewDataProvider.prototype.DT = "TimelineViewDataProvider";

    function TimelineViewDataProvider() {
      this.setDefaultView = bind(this.setDefaultView, this);
      this.set = bind(this.set, this);
      this.get = bind(this.get, this);
      if (TimelineViewDataProvider.__instance == null) {
        TimelineViewDataProvider.__instance = this;
        this.VIEW_CHANGED_EVENT = TimelineViewDataProvider.VIEW_CHANGED_EVENT;
      } else {
        return TimelineViewDataProvider.__instance;
      }
    }

    TimelineViewDataProvider.prototype.get = function(key) {
      if (this.currentView != null) {
        return this.currentView;
      } else if (GlobalState.PLATFORM.isMobile() && !GlobalState.SCREEN.isTablet()) {
        return this.currentView = this.LIST;
      } else {
        if (key != null) {
          return this.currentView = this.getUserViewSetting(key) || this.LIST;
        } else {
          return this.currentView = this.getUserViewSettingProfile() || this.LIST;
        }
      }
    };

    TimelineViewDataProvider.prototype.set = function(view) {
      this.setDefaultView(view);
      $(document).trigger({
        type: this.VIEW_CHANGED_EVENT,
        view: view
      });
      return view;
    };

    TimelineViewDataProvider.prototype.setDefaultView = function(view) {
      return this.currentView = view;
    };

    TimelineViewDataProvider.prototype.saveUserViewSettingProfile = function(view) {
      if (GlobalState.PAGE.isProfile() || GlobalState.PAGE.isPromoProfile()) {
        return this.saveUserViewSetting(view, 'profile_timeline_view');
      }
    };

    TimelineViewDataProvider.prototype.getUserViewSettingProfile = function() {
      if (GlobalState.PAGE.isProfile() || GlobalState.PAGE.isPromoProfile()) {
        return this.getUserViewSetting("profile_timeline_view");
      }
    };

    TimelineViewDataProvider.prototype.saveUserViewSetting = function(view, key) {
      if (view in blocks.clientsideTimeline.TimelineViews.views) {
        return $.cookie("timeline_view_" + key, view, {
          path: '/',
          expires: 365
        });
      } else {
        return console.warn(this.DT, "Unknown view: " + view + ".");
      }
    };

    TimelineViewDataProvider.prototype.getUserViewSetting = function(key) {
      var storedView;
      storedView = $.cookie("timeline_view_" + key);
      if ((storedView != null) && storedView in blocks.clientsideTimeline.TimelineViews.views) {
        return storedView;
      }
    };

    return TimelineViewDataProvider;

  })();

}).call(this);
(function() {
  window.AbTest = {
    finished: function(testName) {
      return $.ajax({
        url: "/api/v2/ab_mobile_tests/" + testName + "/finish",
        timeout: 500,
        type: "PUT"
      });
    }
  };

}).call(this);

/*
  Initialize class on a dom elements.

  Search for a dom element with Class.ATTR_NAME attribute and pass it to
  the class constructor.

  Class must contains a static variable ATTR_NAME in order this to work.

  If class contains static variable ATTR_VALUE it would be used in a
  search selector.

  Also dom node must have a chms.utils.Autoinit.ATTR_NAME attribute
  This attribute indicated that dom element can be autoinited

  @example How to use autoinit
    chms.utils.Autoinit.init(someNs.MyClass);
    chms.utils.Autoinit.init(someNs.MyClass, $(".someElement"));
 */

(function() {
  chms.utils.Autoinit = (function() {
    function Autoinit() {}

    Autoinit.ATTR_NAME = "auto-init";

    Autoinit.init = function(cl, container, initFn) {
      var inited, selector;
      if (!cl.ATTR_NAME) {
        throw "chms.utils.Autoinit: ATTR_NAME in class missing!";
      }
      if (container == null) {
        container = $("body");
      }
      if (cl.ATTR_VALUE != null) {
        selector = "[" + cl.ATTR_NAME + "='" + cl.ATTR_VALUE + "'][" + chms.utils.Autoinit.ATTR_NAME + "]";
      } else {
        selector = "[" + cl.ATTR_NAME + "][" + chms.utils.Autoinit.ATTR_NAME + "]";
      }
      inited = [];
      $(selector, container).each(function() {
        var inst;
        if (initFn != null) {
          inst = initFn($(this), cl);
        } else {
          inst = new cl($(this));
        }
        return inited.push(inst);
      });
      return inited;
    };

    Autoinit.initAfterDom = function(cl, container, initFn) {
      return $(function() {
        return chms.utils.Autoinit.init(cl, container);
      });
    };

    return Autoinit;

  })();

}).call(this);

/*
  Queue
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  chms.utils.Queue = (function() {
    function Queue() {
      this.clear = bind(this.clear, this);
      this.overwrite = bind(this.overwrite, this);
      this.shiftAndExecute = bind(this.shiftAndExecute, this);
      this.popAndExecute = bind(this.popAndExecute, this);
      this.executeAll = bind(this.executeAll, this);
      this.add = bind(this.add, this);
      this.clear();
    }

    Queue.prototype.add = function(task) {
      return this._queue.push(task);
    };

    Queue.prototype.executeAll = function() {
      var i, len, ref, task;
      ref = this._queue;
      for (i = 0, len = ref.length; i < len; i++) {
        task = ref[i];
        task();
      }
      return this.clear();
    };

    Queue.prototype.popAndExecute = function() {
      var task;
      task = this._queue.pop();
      if (task != null) {
        return task();
      }
    };

    Queue.prototype.shiftAndExecute = function() {
      var task;
      task = this._queue.shift();
      if (task != null) {
        return task();
      }
    };

    Queue.prototype.overwrite = function(queue) {
      return this._queue = queue;
    };

    Queue.prototype.clear = function() {
      return this._queue = [];
    };

    return Queue;

  })();

}).call(this);

/*
  Queue where tasks executed in a time interval
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  chms.utils.IntervalQueue = (function(superClass) {
    extend(IntervalQueue, superClass);

    IntervalQueue.prototype.DEFAULT_INTERVAL_TIME = 1000;

    function IntervalQueue() {
      this.stop = bind(this.stop, this);
      this.start = bind(this.start, this);
      this.getInterval = bind(this.getInterval, this);
      this.setInterval = bind(this.setInterval, this);
      IntervalQueue.__super__.constructor.apply(this, arguments);
      this.setInterval(this.DEFAULT_INTERVAL_TIME);
    }

    IntervalQueue.prototype.setInterval = function(time) {
      return this.intervalTime = time;
    };

    IntervalQueue.prototype.getInterval = function() {
      return this.intervalTime;
    };

    IntervalQueue.prototype.start = function() {
      return this.executioner = setInterval(this.shiftAndExecute, this.getInterval());
    };

    IntervalQueue.prototype.stop = function() {
      return clearInterval(this.executioner);
    };

    return IntervalQueue;

  })(chms.utils.Queue);

}).call(this);

/*
  It is just a flag what you can lock and unlock.

  For example: you can use it on animation to block UI
  so user can't do anything to break it.

  Also you can pass a element to constructor and locker
  will change chms.utils.Locker.ATTR arttribute on it
  to true of false, depend on lock state.

  @example Usage
    // use a lock method to set lock:
    locker.lock();

    // use a unlock method to unlock it:
    locker.unlock();

    // use a safeExec function to exec givan fucntion only if locker is unlocked:
    locker.safeExec(function(){ console.log("i'm unlocked") });

    // use a isLocked method to check locker locked or unlocked
    locker.isLocked();

    // locker also spawns a chms.utils.Locker.EVENT_LOCK_CHANGED on itself
    // so you can bind and listen it
    $(locker).bind(chms.utils.Locker.EVENT_LOCK_CHANGED, function(){console.log("lock changed");});

  @example Example of use
    var locker = new chms.utils.Locker()

    function setVal(val){
      locker.safeExec(function(){window.val = val});
    }

    function getVal(){return window.val;}

    setVal(0);
    console.log("val is: ", getVal());
    // val is 0

    locker.lock();
    setVal(1);
    console.log("val is: ", getVal());
    // val is 0

    locker.unlock();
    setVal(1);
    console.log("val is: ", getVal());
    // val is 1
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  chms.utils.Locker = (function() {
    Locker.EVENT_LOCK_CHANGED = "chms.utils.Locker:ChangeLock";

    Locker.ATTR = "lock";

    function Locker(el) {
      this.executeAfterUnlock = bind(this.executeAfterUnlock, this);
      this.safeExec = bind(this.safeExec, this);
      this.isLocked = bind(this.isLocked, this);
      this.updateLock = bind(this.updateLock, this);
      this.unlock = bind(this.unlock, this);
      this.lock = bind(this.lock, this);
      this.ATTR = chms.utils.Locker.ATTR;
      this.s = this.constructor;
      if (el != null) {
        this.el = el;
      }
      this.queue = [];
      this.updateLock(false);
    }

    Locker.prototype.lock = function() {
      return this.updateLock(true);
    };

    Locker.prototype.unlock = function() {
      var fn, i, len, ref;
      this.updateLock(false);
      ref = this.queue;
      for (i = 0, len = ref.length; i < len; i++) {
        fn = ref[i];
        fn();
      }
      return this.queue = [];
    };

    Locker.prototype.updateLock = function(value) {
      var spawner;
      this.locked = value;
      spawner = $(this);
      if (this.el != null) {
        this.el.attr(this.ATTR, value);
        spawner.add(this.el);
      }
      spawner.trigger({
        type: chms.utils.Locker.EVENT_LOCK_CHANGED,
        lock: this.locked
      });
      return this.locked;
    };

    Locker.prototype.isLocked = function() {
      return this.locked;
    };

    Locker.prototype.safeExec = function(fn) {
      if (!this.isLocked()) {
        fn();
        return true;
      } else {
        return false;
      }
    };

    Locker.prototype.executeAfterUnlock = function(fn) {
      if (this.isLocked()) {
        this.queue.push(fn);
        return false;
      } else {
        fn();
        return true;
      }
    };

    return Locker;

  })();

}).call(this);

/*
  Дата сторедж с глобальной точкой доступа
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  chms.utils.Singletonizer = (function() {
    function Singletonizer() {
      this.touch = bind(this.touch, this);
      this.get = bind(this.get, this);
      this.add = bind(this.add, this);
      if (!chms.utils.Singletonizer.__instance) {
        chms.utils.Singletonizer.__instance = this;
        this._data = {};
      } else {
        return chms.utils.Singletonizer.__instance;
      }
    }

    Singletonizer.prototype.add = function(key, value) {
      return this._data[key] = value;
    };

    Singletonizer.prototype.get = function(key) {
      return this._data[key];
    };

    Singletonizer.prototype.touch = function(key, value) {
      if (this._data[key] == null) {
        this._data[key] = value;
      }
      return this.get(key);
    };

    return Singletonizer;

  })();

}).call(this);

/*
  Generates a uniq number.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  chms.utils.Uniq = (function() {
    function Uniq() {
      this.gen = bind(this.gen, this);
      if (chms.utils.Uniq.__instance == null) {
        chms.utils.Uniq.__instance = this;
        this.flows = {
          "default": 0
        };
      } else {
        return chms.utils.Uniq.__instance;
      }
    }

    Uniq.prototype.gen = function(flow) {
      if (flow == null) {
        flow = "default";
      }
      if (this.flows[flow] == null) {
        this.flows[flow] = 0;
      }
      this.flows[flow]++;
      return this.flows[flow];
    };

    return Uniq;

  })();

}).call(this);
(function() {
  if (!window.Utils) {
    window.Utils = {};
  }

  window.Utils.KEY_CODES = {
    UP: 38,
    DOWN: 40,
    LEFT: 37,
    RIGHT: 39,
    ENTER: 13,
    ESC: 27,
    BACKSPACE: 8,
    DELETE: 46,
    TAB: 9,
    SPACE: 32,
    ALT: 18,
    0: 48,
    1: 49,
    2: 50,
    3: 51,
    4: 52,
    5: 53,
    6: 54,
    7: 55,
    8: 56,
    9: 57,
    k: 75,
    j: 74,
    isCypher: function(keyCode) {
      var sub;
      sub = keyCode - Utils.KEY_CODES["0"];
      return sub >= 0 && sub <= 9;
    },
    getCypherByKeyCode: function(keyCode) {
      var s;
      s = keyCode - Utils.KEY_CODES["0"];
      if (s >= 0 && s <= 9) {
        return s;
      } else {
        return void 0;
      }
    }
  };

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.RemoteValidator = (function() {
    RemoteValidator.prototype.KEY_UP_TIMEOUT_DEFAULT = 1000;

    function RemoteValidator(input, remValFunct, options) {
      if (options == null) {
        options = void 0;
      }
      this.validateRemote = bind(this.validateRemote, this);
      this.inputKeyup = bind(this.inputKeyup, this);
      if (input == null) {
        throw "RemoteValidator: it requires a input";
      }
      if (!remValFunct) {
        throw "RemoteValiator: it requires a remote validation function";
      }
      this.input = input;
      this.remValFunct = remValFunct;
      this.keyUpTimeout = this.KEY_UP_TIMEOUT_DEFAULT;
      this.successClbk = ((function(_this) {
        return function() {
          return null;
        };
      })(this));
      this.errorClbk = ((function(_this) {
        return function() {
          return null;
        };
      })(this));
      this.beforeCheckClbk = ((function(_this) {
        return function() {
          return true;
        };
      })(this));
      this.previousCheck = this.input.val();
      if (options) {
        if (options.keyUpTimeout) {
          this.keyUpTimeout = options.keyUpTimeout;
        }
        if (options.success) {
          this.successClbk = options.success;
        }
        if (options.error) {
          this.errorClbk = options.error;
        }
        if (options.beforeCheck) {
          this.beforeCheckClbk = options.beforeCheck;
        }
        if (options.immediateCheck) {
          this.immediateCheck = options.immediateCheck;
        }
      }
      this.input.on("change blur", this.validateRemote);
      this.input.on("keyup", this.inputKeyup);
    }

    RemoteValidator.prototype.inputKeyup = function() {
      if (this.immediateCheck != null) {
        this.immediateCheck(this.input.val());
      }
      if (this.validateTimeout != null) {
        clearTimeout(this.validateTimeout);
      }
      if (this.beforeCheckClbk(this.input.val())) {
        return this.validateTimeout = setTimeout(((function(_this) {
          return function() {
            _this.validateTimeout = void 0;
            return _this.validateRemote();
          };
        })(this)), this.keyUpTimeout);
      } else {
        return this.validateTimeout = void 0;
      }
    };

    RemoteValidator.prototype.validateRemote = function() {
      var currentValue;
      if (this.previousCheck !== (currentValue = this.input.val())) {
        this.previousCheck = currentValue;
        if (this.currentQuery != null) {
          this.currentQuery.abort();
        }
        if (!this.beforeCheckClbk(currentValue)) {
          return;
        }
        return this.currentQuery = this.remValFunct(currentValue, this.successClbk, this.errorClbk);
      }
    };

    return RemoteValidator;

  })();

}).call(this);

/*
  Функция requestAnimationFrame доступно
 */

(function() {
  if (window.requestAnimationFrame == null) {
    window.requestAnimationFrame = function(fn) {
      return fn();
    };
  }

  if (window.cancelAnimationFrame == null) {
    window.cancelAnimationFrame = $.noop;
  }

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.ScrollEventOptimizer = (function() {
    ScrollEventOptimizer.EVENTS = {
      SCROLL: "ScrollEventOptimizer:Scroll"
    };

    function ScrollEventOptimizer(event, interval) {
      if (event == null) {
        event = void 0;
      }
      if (interval == null) {
        interval = 500;
      }
      this.intervalHandler = bind(this.intervalHandler, this);
      this.scrollHandler = bind(this.scrollHandler, this);
      if (event != null) {
        this.event = event;
      } else {
        this.event = (function(_this) {
          return function(offset) {
            return $(_this).trigger({
              type: ScrollEventOptimizer.EVENTS.SCROLL({
                offset: offset
              })
            });
          };
        })(this);
      }
      this.interval = interval;
      this.activate();
    }

    ScrollEventOptimizer.prototype.scrollHandler = function() {
      return this.isScrolled = true;
    };

    ScrollEventOptimizer.prototype.intervalHandler = function() {
      if (!this.isScrolled) {
        return;
      }
      this.isScrolled = false;
      return this.event($(document).scrollTop());
    };

    ScrollEventOptimizer.prototype.disactivate = function() {
      this.isScrolled = false;
      $(window).off("scroll", this.scrollHandler);
      return window.clearInterval(this.intervalId);
    };

    ScrollEventOptimizer.prototype.activate = function() {
      this.isScrolled = false;
      $(window).on("scroll", this.scrollHandler);
      return this.intervalId = setInterval(this.intervalHandler, this.interval);
    };

    return ScrollEventOptimizer;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.URLRepresent = (function() {
    URLRepresent.URL_PATTERN = /(https?:\/\/)(w{3}\.)?([\w\d\-_\.]+\.[\w]{2,5})(:\d+)?(\/[\/\w\d%\-~\.]*)?(\?[;&\w\d%_\.~+=-]*)?(\#[\-\w\d_]*)?/i;

    URLRepresent.URL_PATTERN_INDEXES = {
      PROTOCOL: 1,
      WWW: 2,
      DOMAIN: 3,
      PORT: 4,
      PATH: 5,
      QUERY: 6,
      FRAGMENT: 7
    };

    function URLRepresent(urlString) {
      this.getClearPath = bind(this.getClearPath, this);
      this.getFragment = bind(this.getFragment, this);
      this.getQuery = bind(this.getQuery, this);
      this.getPath = bind(this.getPath, this);
      this.getDomain = bind(this.getDomain, this);
      this.hasWWW = bind(this.hasWWW, this);
      this.getProtocol = bind(this.getProtocol, this);
      this.get = bind(this.get, this);
      var parsed;
      this.url = urlString;
      parsed = urlString.match(URLRepresent.URL_PATTERN);
      if (parsed != null) {
        this.protocol = parsed[URLRepresent.URL_PATTERN_INDEXES.PROTOCOL];
        this.www = parsed[URLRepresent.URL_PATTERN_INDEXES.WWW];
        this.domain = parsed[URLRepresent.URL_PATTERN_INDEXES.DOMAIN];
        this.path = parsed[URLRepresent.URL_PATTERN_INDEXES.PATH];
        this.query = parsed[URLRepresent.URL_PATTERN_INDEXES.QUERY];
        this.fragment = parsed[URLRepresent.URL_PATTERN_INDEXES.FRAGMENT];
      }
    }

    URLRepresent.prototype.get = function() {
      return this.url;
    };

    URLRepresent.prototype.getProtocol = function() {
      return this.protocol;
    };

    URLRepresent.prototype.hasWWW = function() {
      return typeof x !== "undefined" && x.length > 0;
    };

    URLRepresent.prototype.getDomain = function() {
      return this.domain;
    };

    URLRepresent.prototype.getPath = function() {
      return this.path;
    };

    URLRepresent.prototype.getQuery = function() {
      return this.query;
    };

    URLRepresent.prototype.getFragment = function() {
      return this.fragment;
    };

    URLRepresent.prototype.getClearPath = function() {
      if (this.path != null) {
        return this.path.replace(/\/$/, "").toString();
      } else {
        return "";
      }
    };

    return URLRepresent;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.AbsoluteDropdown = (function() {
    AbsoluteDropdown.prototype.ARROW_HEIGHT = 10;

    AbsoluteDropdown.prototype.DELAY_TIMER = 250;

    AbsoluteDropdown.prototype.DEFAULT_EVENT = 'click';

    AbsoluteDropdown.prototype.ANIMATION_DURATION = 400;

    AbsoluteDropdown.ACTIONS = {
      HIDE: 'AbsoluteDropdown:Actions:Hide',
      DESTROY: 'AbsoluteDropdown:Actions:Destroy'
    };

    AbsoluteDropdown.ACTION_PREVENT_HIDING = "AbsoluteDropdown:Actions:PreventHiding";

    AbsoluteDropdown.ACTION_ALLOW_HIDING = "AbsoluteDropdown:Actions:AllowHiding";

    AbsoluteDropdown.POSITION_TYPE = {
      ABSOLUTE_BOTTOM: 1,
      ABSOLUTE_TOP_LEFT_RELATIVE_TO_HANDLE: 2,
      ABSOLUTE_TOP: 3,
      ABSOLUTE_TOP_OR_BOTTOM: 4,
      ABSOLUTE_TOP_OR_BOTTOM_CLOSE: 5
    };

    AbsoluteDropdown.EVENT_BEFORE_SHOWED = "AbsoluteDropdown:beforeShowed";

    function AbsoluteDropdown(opts) {
      this.calculateZIndexByParent = bind(this.calculateZIndexByParent, this);
      this.getParentDropdownsRecursively = bind(this.getParentDropdownsRecursively, this);
      this.getParentDropdown = bind(this.getParentDropdown, this);
      this.positionShiftLeftFromScreenBounds = bind(this.positionShiftLeftFromScreenBounds, this);
      this.positionFixed = bind(this.positionFixed, this);
      this.getContent = bind(this.getContent, this);
      this.resetContent = bind(this.resetContent, this);
      this.setContent = bind(this.setContent, this);
      this.destroy = bind(this.destroy, this);
      this.hideAnotherIfVisible = bind(this.hideAnotherIfVisible, this);
      this.hide = bind(this.hide, this);
      this.show = bind(this.show, this);
      this.toggle = bind(this.toggle, this);
      this.isDisabled = bind(this.isDisabled, this);
      this.isVisible = bind(this.isVisible, this);
      this.appendDropdown = bind(this.appendDropdown, this);
      this.initHandle = bind(this.initHandle, this);
      this.getHandle = bind(this.getHandle, this);
      var base, dropdownPosition;
      this.opts = opts;
      if ((base = this.opts).defaultContent == null) {
        base.defaultContent = '';
      }
      this.s = window.AbsoluteDropdown;
      this.el = $(this.opts.el);
      this.hideLocker = new chms.utils.Locker();
      this.offsetTop = parseInt(this.el.attr("top"));
      if (isNaN(this.offsetTop)) {
        this.offsetTop = void 0;
      }
      this.offsetLeft = parseInt(this.el.attr("left"));
      if (isNaN(this.offsetLeft)) {
        this.offsetLeft = void 0;
      }
      dropdownPosition = this.opts.dropdownPosition || AbsoluteDropdown.POSITION_TYPE.ABSOLUTE_BOTTOM;
      this.position = (function() {
        switch (dropdownPosition) {
          case AbsoluteDropdown.POSITION_TYPE.ABSOLUTE_BOTTOM:
            return this.positionAbsoluteBottom.bind(this);
          case AbsoluteDropdown.POSITION_TYPE.ABSOLUTE_TOP_LEFT_RELATIVE_TO_HANDLE:
            return this.positionAbsoluteTop.bind(this);
          case AbsoluteDropdown.POSITION_TYPE.ABSOLUTE_TOP:
            return this.positionAbsoluteTopNormal.bind(this);
          case AbsoluteDropdown.POSITION_TYPE.ABSOLUTE_TOP_OR_BOTTOM_CLOSE:
            return this.positionAbsoluteTopOrBottom.bind(this, true);
          case AbsoluteDropdown.POSITION_TYPE.ABSOLUTE_TOP_OR_BOTTOM:
            return this.positionAbsoluteTopOrBottom.bind(this);
          default:
            throw "AbsoluteDropdown: unknown position type";
        }
      }).call(this);
      this.el.on("position", this.position).on(this.s.ACTION_PREVENT_HIDING, this.hideLocker.lock).on(this.s.ACTION_ALLOW_HIDING, this.hideLocker.unlock);
      this.initHandle();
      this.el.on("dom_remove", (function(_this) {
        return function() {
          if (_this.t) {
            _this.t.remove();
          }
          if (_this.content instanceof jQuery) {
            _this.content.remove();
          }
          if (_this.opts.defaultContent instanceof jQuery) {
            return _this.opts.defaultContent.remove();
          }
        };
      })(this));
    }

    AbsoluteDropdown.prototype.getHandle = function() {
      if (!this.opts.handle) {
        throw "AbsoluteDropdown require handler to work properly";
      }
      this.handle || (this.handle = this.opts.handle);
      return this.handle;
    };

    AbsoluteDropdown.prototype.initHandle = function() {
      var event, i, len, ref, results, toggleHandler;
      toggleHandler = (function(_this) {
        return function(event) {
          event.preventDefault();
          return _.delay(_this.toggle.bind(_this), _this.DELAY_TIMER);
        };
      })(this);
      if ($.isArray(this.opts.handlerEvents)) {
        ref = this.opts.handlerEvents;
        results = [];
        for (i = 0, len = ref.length; i < len; i++) {
          event = ref[i];
          results.push(this.getHandle().on(event, toggleHandler));
        }
        return results;
      } else if ((typeof this.opts.handlerEventOpen === "string") && (typeof this.opts.handlerEventClose === "string")) {
        return this.getHandle().on(this.opts.handlerEventOpen, this.show).on(this.opts.handlerEventClose, this.hide);
      } else {
        return this.getHandle().on(this.DEFAULT_EVENT, toggleHandler);
      }
    };

    AbsoluteDropdown.prototype.appendDropdown = function() {
      this.handle.trigger(HoverableClickableAbsoluteDropdown.EVENTS.APPENDED);
      this.t = $(JST['app/site/templates/widgets/absolute_dropdown/absolute_dropdown']({
        content: '',
        classes: this.opts.classNames
      }));
      this.handle.trigger('before:append');
      if (this.content != null) {
        this.setContent(this.content);
      } else if (this.opts.defaultContent) {
        this.setContent(this.opts.defaultContent);
      }
      return this.t.on(AbsoluteDropdown.ACTIONS.HIDE, this.hide).on(AbsoluteDropdown.ACTIONS.DESTROY, this.destroy).data('handle', this.handle).addClass('-absolute').appendTo('body');
    };

    AbsoluteDropdown.prototype.isVisible = function() {
      return this.t != null;
    };

    AbsoluteDropdown.prototype.isDisabled = function() {
      return this.el.hasClass("disabled") || (this.handle.attr("prevent-dropdown-open") != null);
    };

    AbsoluteDropdown.prototype.toggle = function() {
      if (this.isVisible()) {
        return this.hide();
      } else {
        return this.show();
      }
    };

    AbsoluteDropdown.prototype.show = function() {
      var pd;
      if (!this.isVisible() && !this.isDisabled()) {
        this.appendDropdown();
        if ((pd = this.getParentDropdown()) != null) {
          this.calculateZIndexByParent(pd);
        }
        this.hideAnotherIfVisible();
        this.t.show();
        this.position();
        this.t.find('.close-small, .close').on('click', this.hide);
        this.el.trigger(this.s.EVENT_BEFORE_SHOWED);
        this.el.trigger('beforeShow');
        this.t.animate({
          opacity: 1
        }, this.ANIMATION_DURATION, this.reactShowed.bind(this));
        if (this.withPrompt()) {
          this.handle.attr('inactive', true);
          return this.handle.trigger('hidePrompt');
        }
      }
    };

    AbsoluteDropdown.prototype.hide = function() {
      return this.hideLocker.safeExec((function(_this) {
        return function() {
          if (_this.isDisabled() || !_this.isVisible()) {
            return;
          }
          _this.el.trigger("beforeHide");
          _this.hideLocker.lock();
          _this.t.find('.close-small, .close').off("click", _this.hide);
          _this.t.fadeOut(_this.ANIMATION_DURATION, function() {
            if (_this.content instanceof jQuery) {
              _this.content.detach();
            }
            _this.t.remove();
            _this.t = null;
            _this.el.trigger('hided');
            return _this.hideLocker.unlock();
          });
          if (_this.withPrompt()) {
            return _this.handle.removeAttr('inactive');
          }
        };
      })(this));
    };

    AbsoluteDropdown.prototype.hideAnotherIfVisible = function() {
      var $pds, els;
      els = $(".dropdown.-absolute:visible").not(this.t);
      if ($pds = this.getParentDropdownsRecursively()) {
        els = els.not($pds);
      }
      return els.trigger(AbsoluteDropdown.ACTIONS.HIDE);
    };

    AbsoluteDropdown.prototype.destroy = function() {
      return this.hide();
    };

    AbsoluteDropdown.prototype.setContent = function(content) {
      this.content = content;
      if (this.t != null) {
        return this.t.find('.dropdown__content').html(this.content);
      }
    };

    AbsoluteDropdown.prototype.resetContent = function() {
      if (this.opts.defaultContent != null) {
        return this.setContent(this.opts.defaultContent);
      } else {
        return this.setContent($());
      }
    };

    AbsoluteDropdown.prototype.getContent = function() {
      return this.content;
    };

    AbsoluteDropdown.prototype.positionAbsoluteTop = function() {
      var bottom, hHeight, hOffset, hWidth, left;
      hOffset = this.getHandle().offset();
      hHeight = this.getHandle().outerHeight();
      hWidth = this.getHandle().outerWidth();
      this.t.addClass('-above');
      bottom = $(window).height() + hHeight + this.ARROW_HEIGHT;
      bottom -= hOffset.top;
      left = (hOffset.left - (this.t.width() / 2)) + hWidth / 2;
      return this.t.css({
        left: left,
        bottom: bottom
      });
    };

    AbsoluteDropdown.prototype.positionAbsoluteBottom = function() {
      var hOffset, handleWidth, left, padding, top;
      handleWidth = this.getHandle().outerWidth();
      hOffset = this.getHandle().offset();
      this.t.addClass('-below');
      padding = 4;
      top = hOffset.top + this.getHandle().height() + padding;
      left = (hOffset.left - (this.t.width() / 2)) + handleWidth / 2;
      if (left + this.t.width() + 20 > window.innerWidth) {
        left = window.innerWidth - (this.t.width() + 20);
      }
      top = this.injectOffsetTop(top);
      return this.t.css({
        left: left,
        top: top
      });
    };

    AbsoluteDropdown.prototype.positionAbsoluteTopNormal = function() {
      var hOffset, handleWidth, left, padding, top;
      hOffset = this.getHandle().offset();
      handleWidth = this.getHandle().outerWidth();
      this.t.addClass('-above');
      padding = 2;
      top = hOffset.top - this.t.height() - this.ARROW_HEIGHT - padding;
      top = this.injectOffsetTop(top);
      left = (hOffset.left - (this.t.width() / 2)) + handleWidth / 2;
      left = this.injectOffsetLeft(left);
      return this.t.css({
        left: Math.round(left),
        top: Math.round(top)
      });
    };

    AbsoluteDropdown.prototype.positionAbsoluteTopOrBottom = function(closeTop) {
      var handleVPOffset, padding, spaceUnderHandle, viewportH;
      if (closeTop == null) {
        closeTop = false;
      }
      viewportH = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
      handleVPOffset = this.getHandle()[0].getBoundingClientRect().top;
      padding = 4;
      spaceUnderHandle = viewportH - (handleVPOffset + this.ARROW_HEIGHT + this.getHandle().height() + padding);
      if (spaceUnderHandle >= 250) {
        this.positionAbsoluteBottom();
      } else {
        if (closeTop) {
          this.positionAbsoluteTopNormal();
        } else {
          this.positionAbsoluteTop();
        }
      }
      return this.positionShiftLeftFromScreenBounds();
    };

    AbsoluteDropdown.prototype.positionFixed = function() {
      var bottomLimit, hHeight, hOffset, hWidth, left, leftBound, top, topLimit, triangleMinPadding, verticalCenter;
      hWidth = this.getHandle().outerWidth();
      hHeight = this.getHandle().outerHeight();
      hOffset = this.getHandle().offset();
      hOffset.bottom = hOffset.top + hHeight;
      hOffset.right = hOffset.left + hWidth;
      hOffset.middle = hOffset.left + hWidth / 2;
      this.t.removeClass('-left -abole -right -below');
      left = ($(window).width() / 2) - (this.t.width() / 2);
      top = $(window).scrollTop() + $(window).height() / 2 - (this.t.height() / 2);
      topLimit = $(window).scrollTop() + 250;
      bottomLimit = $(window).height() + $(window).scrollTop() - 250;
      verticalCenter = $(window).width() / 2;
      triangleMinPadding = 40;
      if (hOffset.top < topLimit || hOffset.top > bottomLimit) {
        if (hOffset.top < topLimit) {
          top = hOffset.bottom + this.ARROW_HEIGHT;
          this.t.addClass('-below');
        } else {
          top = hOffset.top - this.t.height() - this.ARROW_HEIGHT;
          this.t.addClass('-above');
        }
        if (hOffset.left - triangleMinPadding < left) {
          leftBound = hOffset.middle - triangleMinPadding;
          while (leftBound < left) {
            left -= 1;
          }
        } else if (hOffset.right > left + this.t.width() - triangleMinPadding) {
          while (hOffset.right > left + this.t.width() - triangleMinPadding) {
            left += 1;
          }
        }
      } else {
        if (hOffset.left < verticalCenter) {
          left = hOffset.right + this.ARROW_HEIGHT;
          this.t.addClass('-right');
        } else {
          left = hOffset.left - this.t.width() - this.ARROW_HEIGHT;
          this.t.addClass('-left');
        }
        if (hOffset.top < top + triangleMinPadding / 2) {
          while (hOffset.top < top + triangleMinPadding / 2) {
            top -= 1;
          }
        } else if (hOffset.top > top + this.t.height() - triangleMinPadding) {
          while (hOffset.top > top + this.t.height() - triangleMinPadding) {
            top += 1;
          }
        } else {

        }
      }
      return this.t.css({
        left: left - $(window).scrollLeft(),
        top: top - $(window).scrollTop()
      });
    };

    AbsoluteDropdown.prototype.positionShiftLeftFromScreenBounds = function() {
      var dleft;
      if (this.t == null) {
        return;
      }
      dleft = this.t.offset().left;
      if (dleft < 0) {
        return this.t.css({
          left: "+=" + (Math.abs(dleft) + 5)
        });
      }
    };

    AbsoluteDropdown.prototype.withPrompt = function() {
      return this.handle.attr('hideable-prompt') != null;
    };

    AbsoluteDropdown.prototype.getParentDropdown = function() {
      var pd;
      pd = this.el.closest('.dropdown.-absolute');
      if (pd.length) {
        return pd;
      } else {
        return void 0;
      }
    };

    AbsoluteDropdown.prototype.getParentDropdownsRecursively = function() {
      var $dd, $handle, $pds;
      $pds = $();
      $handle = this.handle;
      while (($dd = $handle.closest('.dropdown.-absolute')).length) {
        $pds = $pds.add($dd);
        $handle = $dd.data('handle') || $();
      }
      if ($pds.length) {
        return $pds;
      } else {
        return void 0;
      }
    };

    AbsoluteDropdown.prototype.calculateZIndexByParent = function(parent) {
      var c;
      if ((parent != null) && (this.t != null)) {
        c = parseInt(parent.css('z-index'));
        if (!isNaN(c)) {
          return this.t.css('z-index', c + 1);
        }
      }
    };

    AbsoluteDropdown.prototype.injectOffsetTop = function(offset) {
      if (this.offsetTop) {
        return offset + this.offsetTop;
      } else {
        return offset;
      }
    };

    AbsoluteDropdown.prototype.injectOffsetLeft = function(offset) {
      if (this.offsetLeft != null) {
        return offset + this.offsetLeft;
      } else {
        return offset;
      }
    };

    AbsoluteDropdown.prototype.reactShowed = function() {
      return this.el.trigger('showed');
    };

    return AbsoluteDropdown;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.ControlableAbsoluteDropdown = (function(superClass) {
    extend(ControlableAbsoluteDropdown, superClass);

    function ControlableAbsoluteDropdown() {
      this.outsideClick = bind(this.outsideClick, this);
      this.escHandler = bind(this.escHandler, this);
      this.hideDropdown = bind(this.hideDropdown, this);
      this.hide = bind(this.hide, this);
      this.show = bind(this.show, this);
      return ControlableAbsoluteDropdown.__super__.constructor.apply(this, arguments);
    }

    ControlableAbsoluteDropdown.prototype.show = function() {
      ControlableAbsoluteDropdown.__super__.show.apply(this, arguments);
      return $(document).bind('mousedown touchstart keydown', this.hideDropdown);
    };

    ControlableAbsoluteDropdown.prototype.hide = function() {
      ControlableAbsoluteDropdown.__super__.hide.apply(this, arguments);
      return $(document).unbind("mousedown touchstart keydown", this.hideDropdown);
    };

    ControlableAbsoluteDropdown.prototype.hideDropdown = function(e) {
      if (e.type === 'keydown') {
        if (e.which === 27) {
          return this.escHandler();
        } else {
          return true;
        }
      } else {
        return this.outsideClick(e);
      }
    };

    ControlableAbsoluteDropdown.prototype.escHandler = function() {
      this.hide();
      return false;
    };

    ControlableAbsoluteDropdown.prototype.outsideClick = function(e) {
      var clickedDropdown, t;
      t = $(e.target);
      if (t.is('.dropdown.-absolute') || t.parents(".dropdown.-absolute").size() > 0) {
        clickedDropdown = t.is('.dropdown.-absolute') ? t : t.parents('.dropdown.-absolute');
      } else {
        clickedDropdown = void 0;
      }
      if (clickedDropdown === void 0) {
        this.hide();
        return false;
      } else if (clickedDropdown.get(0) !== this.t.get(0) && !clickedDropdown.is('.dropdown.-absolute')) {
        this.hide();
        return false;
      } else {
        return true;
      }
    };

    return ControlableAbsoluteDropdown;

  })(window.AbsoluteDropdown);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.HoverableAbsoluteDropdown = (function(superClass) {
    extend(HoverableAbsoluteDropdown, superClass);

    HoverableAbsoluteDropdown.prototype.HIDE_TIMEOUT = 1000;

    HoverableAbsoluteDropdown.EVENTS = {
      MOUSEOUT_TIMEOUT: "HoverableAbsoluteDropdown:MouseoutTimeout",
      CLOSE: "HoverableAbsoluteDropdown:Close"
    };

    HoverableAbsoluteDropdown.prototype.ANIMATION_DURATION = 200;

    HoverableAbsoluteDropdown.prototype.MOUSE_STATE = {
      OUT: 0,
      IN: 1
    };

    function HoverableAbsoluteDropdown(opts) {
      this.hide = bind(this.hide, this);
      this.show = bind(this.show, this);
      this.timerHandle = bind(this.timerHandle, this);
      this.invalidateTimer = bind(this.invalidateTimer, this);
      this.startTimer = bind(this.startTimer, this);
      this.outHandle = bind(this.outHandle, this);
      this.inHanlde = bind(this.inHanlde, this);
      HoverableAbsoluteDropdown.__super__.constructor.apply(this, arguments);
      this.animationDuration = opts.animationDuration || this.ANIMATION_DURATION;
      this.handle.bind("mouseenter", this.inHanlde);
      this.handle.bind("mouseleave", this.outHandle);
      $(this.el).on(this.s.EVENT_BEFORE_SHOWED, (function(_this) {
        return function() {
          _this.t.on("mouseenter", _this.invalidateTimer);
          return _this.t.on("mouseleave", _this.startTimer);
        };
      })(this));
      this.HIDE_TIMEOUT = opts.hideTimeout || this.HIDE_TIMEOUT;
    }

    HoverableAbsoluteDropdown.prototype.inHanlde = function() {
      this.invalidateTimer();
      return this.mouseState = this.MOUSE_STATE.IN;
    };

    HoverableAbsoluteDropdown.prototype.outHandle = function() {
      this.startTimer();
      return this.mouseState = this.MOUSE_STATE.OUT;
    };

    HoverableAbsoluteDropdown.prototype.startTimer = function() {
      return this.timer = setTimeout(this.timerHandle, this.HIDE_TIMEOUT);
    };

    HoverableAbsoluteDropdown.prototype.invalidateTimer = function() {
      return window.clearTimeout(this.timer);
    };

    HoverableAbsoluteDropdown.prototype.timerHandle = function() {
      $(document).trigger(HoverableAbsoluteDropdown.EVENTS.CLOSE);
      return this.handle.trigger(HoverableAbsoluteDropdown.EVENTS.MOUSEOUT_TIMEOUT);
    };

    HoverableAbsoluteDropdown.prototype.show = function() {
      return setTimeout((function(_this) {
        return function() {
          if (_this.mouseState !== _this.MOUSE_STATE.IN) {
            return;
          }
          return HoverableAbsoluteDropdown.__super__.show.apply(_this, arguments);
        };
      })(this), this.animationDuration + 10);
    };

    HoverableAbsoluteDropdown.prototype.hide = function() {
      if ($('.dd-follower-list').length) {
        return;
      }
      return HoverableAbsoluteDropdown.__super__.hide.apply(this, arguments);
    };

    return HoverableAbsoluteDropdown;

  })(window.ControlableAbsoluteDropdown);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.HoverableClickableAbsoluteDropdown = (function(superClass) {
    extend(HoverableClickableAbsoluteDropdown, superClass);

    HoverableClickableAbsoluteDropdown.EVENTS = {
      APPENDED: "HoverableClickableAbsoluteDropdown:Appended",
      OPEN: "HoverableClickableAbsoluteDropdown:Open"
    };

    function HoverableClickableAbsoluteDropdown(opts) {
      this.hide = bind(this.hide, this);
      this.outHandle = bind(this.outHandle, this);
      HoverableClickableAbsoluteDropdown.__super__.constructor.apply(this, arguments);
      $(this.el).bind("showed", (function(_this) {
        return function() {
          return _this.showed = true;
        };
      })(this));
      $(this.el).bind("hided", (function(_this) {
        return function() {
          return _this.showed = false;
        };
      })(this));
      this.handle.on(HoverableClickableAbsoluteDropdown.EVENTS.APPENDED, (function(_this) {
        return function() {
          return _this.appended = true;
        };
      })(this));
      this.handle.bind('click', (function(_this) {
        return function() {
          if (_this.showed) {
            return _this.timerHandle();
          } else {
            return _this.handle.trigger(HoverableClickableAbsoluteDropdown.EVENTS.OPEN);
          }
        };
      })(this));
    }

    HoverableClickableAbsoluteDropdown.prototype.outHandle = function() {
      if (this.appended) {
        return HoverableClickableAbsoluteDropdown.__super__.outHandle.apply(this, arguments);
      }
    };

    HoverableClickableAbsoluteDropdown.prototype.hide = function() {
      HoverableClickableAbsoluteDropdown.__super__.hide.apply(this, arguments);
      return this.appended = false;
    };

    return HoverableClickableAbsoluteDropdown;

  })(HoverableAbsoluteDropdown);

}).call(this);
(function() {
  window.PreloadableAbsDropdown = (function() {
    PreloadableAbsDropdown.prototype.dropdown_class_names = "";

    function PreloadableAbsDropdown(opts) {
      var dropdownClass;
      this.el = $(opts.el);
      dropdownClass = opts.dropdownClass || ControlableAbsoluteDropdown;
      this.dropdown = new dropdownClass({
        el: this.el,
        classNames: "preloadable -absolute " + this.dropdown_class_names,
        handle: opts.handle || this.el.find('.dropdown__handler'),
        defaultContent: "<div class='loader'><div class='loadRotator " + (opts.spinnerSize || 'small') + "'></div></div>",
        handlerEvents: opts.handlerEvents || null,
        handlerEventOpen: opts.handleEventOpen || null,
        handlerEventClose: opts.handleEventClose || null,
        hideTimeout: opts.hideTimeout || null,
        dropdownPosition: opts.dropdownPosition || AbsoluteDropdown.POSITION_TYPE.ABSOLUTE_BOTTOM
      });
      _.defer((function(_this) {
        return function() {
          _this.el.on("showed", function() {
            _this.setLoader();
            return _this.preloadData();
          });
          return _this.afterInitialize && _this.afterInitialize();
        };
      })(this));
    }

    PreloadableAbsDropdown.prototype.preloadData = function() {
      return console.log('Override this method please!');
    };

    PreloadableAbsDropdown.prototype.setLoader = function() {
      if (!this.dropdown.t) {
        return;
      }
      this.loader = this.dropdown.t.find(".loadRotator");
      return this.loader.makeLoader();
    };

    return PreloadableAbsDropdown;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  if (!window.CoubAnimators) {
    window.CoubAnimators = {};
  }

  CoubAnimators.AbstractAnimator = (function() {
    AbstractAnimator.EVENTS = {
      ANIMATION_COMPLETE: "coubAnimator:animationComplete"
    };

    AbstractAnimator.prototype.sendAnimationComplete = function() {
      return $(this).trigger({
        type: CoubAnimators.AbstractAnimator.EVENTS.ANIMATION_COMPLETE,
        action: this.action
      });
    };

    function AbstractAnimator(element) {
      this.cleanCss = bind(this.cleanCss, this);
      this.sendAnimationComplete = bind(this.sendAnimationComplete, this);
      this.element = element;
    }

    AbstractAnimator.prototype.cleanCss = function(els, props) {
      var el, i, len, prop, results;
      results = [];
      for (i = 0, len = props.length; i < len; i++) {
        prop = props[i];
        results.push((function() {
          var j, len1, results1;
          results1 = [];
          for (j = 0, len1 = els.length; j < len1; j++) {
            el = els[j];
            results1.push(el.css(prop, ""));
          }
          return results1;
        })());
      }
      return results;
    };

    return AbstractAnimator;

  })();

  CoubAnimators.EmbedPopupAnimator = (function(superClass) {
    extend(EmbedPopupAnimator, superClass);

    EmbedPopupAnimator.ACTIONS = {
      EXPAND: 0
    };

    EmbedPopupAnimator.prototype.CONST = {
      FADE_TIME: 500,
      EXPAND_TIME: 500,
      INITIAL_WIDTH: 390,
      INITIAL_HEIGHT: 390
    };

    function EmbedPopupAnimator(popup) {
      this.animate = bind(this.animate, this);
      this.popup = popup;
    }

    EmbedPopupAnimator.prototype.animate = function(action) {
      var contentContainer, elementToFade, finalHeight, finalWidth;
      if (typeof action === "undefined") {
        action = CoubAnimators.EmbedPopupAnimator.ACTIONS.EXPAND;
      }
      contentContainer = this.popup.getContentContainer();
      finalWidth = contentContainer.width();
      finalHeight = contentContainer.height();
      elementToFade = contentContainer.find(".popup-embed, share-popup");
      contentContainer.css("width", this.CONST.INITIAL_WIDTH).css("height", this.CONST.INITIAL_HEIGHT);
      elementToFade.hide();
      return contentContainer.animate({
        width: finalWidth,
        height: finalHeight
      }, this.CONST.EXPAND_TIME, (function(_this) {
        return function() {
          elementToFade.fadeIn(_this.CONST.FADE_TIME);
          return contentContainer.css("width", "").css("height", "");
        };
      })(this));
    };

    return EmbedPopupAnimator;

  })(CoubAnimators.AbstractAnimator);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.CoubAnimators.CoubPageAjaxReloadAnimator = (function(superClass) {
    extend(CoubPageAjaxReloadAnimator, superClass);

    CoubPageAjaxReloadAnimator.prototype.TIME = {
      UNLOAD: {
        SCROLL_TO_TOP: 150 * 1,
        DESCRIPTION_BLOCK: {
          AVATAR_TO_GRAY: 200 * 1,
          DESCRIPTION_TO_WHITE: 200 * 1,
          COUNTERS_TO_WHITE: 200 * 1
        },
        FADE_TAGS: 200 * 1,
        FADE_MEDIA: 200 * 1,
        TRANSPARENT_LIKE_RECOUB_COMMENT: 200 * 1,
        SUGGEST_TRANSPARENT: 200 * 1
      },
      LOAD: {
        FADE_TAGS: 200 * 1,
        FADE_MEDIA: 200 * 1,
        FADE_COUNTERS: 200 * 1,
        SOCIAL_CONTROLS_ACTIVE: 200 * 1,
        SHOW_AVATAR_FROM_GRAY: 200 * 1,
        FADE_DESCRIPTION: 200 * 1,
        SUGGESTS: {
          OLD_FADE: 30 * 2 * 1,
          NEW_SHOW: 75 * 2 * 1
        }
      }
    };

    CoubPageAjaxReloadAnimator.prototype.SUGGEST_NEW_CLASS = "SUGGEST_NEW";

    CoubPageAjaxReloadAnimator.prototype.SUGGEST_OLD_CLASS = "SUGGEST_OLD";

    function CoubPageAjaxReloadAnimator() {
      this.load = bind(this.load, this);
      this.preloadState = bind(this.preloadState, this);
      this.suggestReload = bind(this.suggestReload, this);
      this.getDescriptionElements = bind(this.getDescriptionElements, this);
      this.getSocialControls = bind(this.getSocialControls, this);
      this.removeStubFromUserpic = bind(this.removeStubFromUserpic, this);
      this.addStubToUserpic = bind(this.addStubToUserpic, this);
      this.removeGrayBorderFromDescription = bind(this.removeGrayBorderFromDescription, this);
      this.getCoubBlock = bind(this.getCoubBlock, this);
      this.removeCurtain = bind(this.removeCurtain, this);
      this.addCurtain = bind(this.addCurtain, this);
      NProgress.configure({
        showSpinner: false,
        minimum: 0.3,
        trickleRate: 0.12,
        speed: 100
      });
      CoubPageAjaxReloadAnimator.__super__.constructor.apply(this, arguments);
    }

    CoubPageAjaxReloadAnimator.prototype.addCurtain = function() {
      return $(".coub-page").append("<div class='curtain -fill'></div>");
    };

    CoubPageAjaxReloadAnimator.prototype.removeCurtain = function() {
      return $(".coub-page .curtain").detach();
    };

    CoubPageAjaxReloadAnimator.prototype.getCoubBlock = function() {
      return $(".coub", this.element);
    };

    CoubPageAjaxReloadAnimator.prototype.removeGrayBorderFromDescription = function(block) {
      return block.removeClass("grayTopBorder");
    };

    CoubPageAjaxReloadAnimator.prototype.addStubToUserpic = function(block) {
      return block.append("<div class='stub'></div>");
    };

    CoubPageAjaxReloadAnimator.prototype.removeStubFromUserpic = function(block) {
      return block.find(".stub").detach();
    };

    CoubPageAjaxReloadAnimator.prototype.getSocialControls = function(block) {
      return $(".coub__like-button i", block).add($(".coub__recoub-button i", block));
    };

    CoubPageAjaxReloadAnimator.prototype.getDescriptionElements = function(block) {
      return $(".description__title", block).add($(".description__stamp", block));
    };

    CoubPageAjaxReloadAnimator.prototype.suggestReload = function() {
      var TOP, coubBlock, descriptionBlock, disableCoubSocialControls, fadeOutDescription, foldSharingBlock, hideCounters, hideMedia, hideTags, muteCoub, stateComplete, stateCompleteCounter, states, suggestTransparent, turnAvatarToGray;
      this.finishLoadAnimation();
      NProgress.start();
      coubBlock = this.getCoubBlock();
      descriptionBlock = $(".coub__description", coubBlock);
      muteCoub = (function(_this) {
        return function() {
          coubBlock.find(".viewer").trigger("mute");
          return stateComplete("fade coub to white");
        };
      })(this);
      turnAvatarToGray = (function(_this) {
        return function() {
          var userPicBlock;
          userPicBlock = $(".pic.userpic", descriptionBlock);
          _this.addStubToUserpic(userPicBlock);
          return $("img", userPicBlock).fadeOut(_this.TIME.UNLOAD.DESCRIPTION_BLOCK.AVATAR_TO_GRAY).promise().done(function() {
            return stateComplete("turn avatar to gray");
          });
        };
      })(this);
      fadeOutDescription = (function(_this) {
        return function() {
          return _this.getDescriptionElements(coubBlock).animate({
            opacity: 0
          }, _this.TIME.UNLOAD.DESCRIPTION_TO_WHITE).promise().done(function() {
            return stateComplete("fade out description");
          });
        };
      })(this);
      hideCounters = (function(_this) {
        return function() {
          return $(".counter", coubBlock).animate({
            opacity: 0
          }, _this.TIME.UNLOAD.DESCRIPTION_BLOCK.COUNTERS_TO_WHITE).promise().done(function() {
            return stateComplete("hide counters");
          });
        };
      })(this);
      disableCoubSocialControls = (function(_this) {
        return function() {
          return _this.getSocialControls(coubBlock).animate({
            opacity: 0.4
          }, _this.TIME.UNLOAD.TRANSPARENT_LIKE_RECOUB_COMMENT).promise().done(function() {
            return stateComplete("disable coub soc controls");
          });
        };
      })(this);
      foldSharingBlock = function() {
        return $(".coub__sharing", coubBlock).fadeOut(function() {
          return stateComplete("fold sharing block");
        });
      };
      suggestTransparent = (function(_this) {
        return function() {
          return $(".suggests .suggest__item", _this.element).addClass('disabled').not('.clicked').animate({
            opacity: 0.4
          }, _this.TIME.UNLOAD.SUGGEST_TRANSPARENT).promise().done(function() {
            return stateComplete("suggest transparent");
          });
        };
      })(this);
      hideTags = (function(_this) {
        return function() {
          return $(".coub__tags", _this.el).fadeOut(_this.TIME.UNLOAD.FADE_TAGS).promise().done(function() {
            return stateComplete("hide tags");
          });
        };
      })(this);
      hideMedia = (function(_this) {
        return function() {
          return $(".coub__media-block", _this.el).fadeOut(_this.TIME.UNLOAD.FADE_MEDIA).promise().done(function() {
            return stateComplete("hide media");
          });
        };
      })(this);
      states = [muteCoub, turnAvatarToGray, fadeOutDescription, hideCounters, disableCoubSocialControls, hideTags, hideMedia, foldSharingBlock, suggestTransparent];
      stateCompleteCounter = 0;
      stateComplete = (function(_this) {
        return function(from) {
          if (++stateCompleteCounter === states.length) {
            return _this.sendAnimationComplete();
          }
        };
      })(this);
      this.addCurtain();
      return $.scrollTo((TOP = 0), this.TIME.UNLOAD.SCROLL_TO_TOP, function() {
        var i, len, results, state;
        results = [];
        for (i = 0, len = states.length; i < len; i++) {
          state = states[i];
          results.push(state());
        }
        return results;
      });
    };

    CoubPageAjaxReloadAnimator.prototype.preloadState = function(page) {
      var coubBlock, newSuggest, oldSuggest, userpic;
      coubBlock = $(".coub", page);
      this.getDescriptionElements(coubBlock).css("opacity", 0);
      this.addStubToUserpic((userpic = $(".avatar", coubBlock)));
      userpic.find("img").hide();
      $(".counter", coubBlock).css("opacity", 0);
      newSuggest = $(".suggests", page).addClass(this.SUGGEST_NEW_CLASS);
      oldSuggest = $(".suggests", this.element).addClass(this.SUGGEST_OLD_CLASS);
      oldSuggest.find(".title script").detach();
      newSuggest.parent().append(oldSuggest);
      this.getSocialControls(coubBlock).css("opacity", 0.4);
      return $(".coub__tags, .coub__media-block", page).css('opacity', 0.4).addClass('-hidden');
    };

    CoubPageAjaxReloadAnimator.prototype.finishLoadAnimation = function() {
      if (!this.newSuggests) {
        return;
      }
      clearTimeout(this.nextSuggestTimeout);
      this.scrollOptimizer.disactivate();
      this.sendAnimationComplete();
      this.oldSuggests.detach();
      this.newSuggests.removeClass(this.SUGGEST_NEW_CLASS);
      return this.newSuggests.parent().height('');
    };

    CoubPageAjaxReloadAnimator.prototype.load = function() {
      var coubBlock, fadeDescription, makeSocialControlsActive, showAvatarFromGray, showCounters, showSuggestions, showTagsAndMedia, stateComplete, stateCompleteCounter, states;
      this.newSuggests = $("." + this.SUGGEST_NEW_CLASS, this.element);
      this.oldSuggests = $("." + this.SUGGEST_OLD_CLASS, this.element);
      coubBlock = this.getCoubBlock();
      showCounters = (function(_this) {
        return function() {
          return $(".counter", coubBlock).animate({
            opacity: 1
          }, _this.TIME.LOAD.FADE_COUNTERS).promise().done(function() {
            return stateComplete("showCounters");
          });
        };
      })(this);
      makeSocialControlsActive = (function(_this) {
        return function() {
          return _this.getSocialControls(coubBlock).not(".disabled").animate({
            opacity: 1
          }, _this.TIME.LOAD.SOCIAL_CONTROLS_ACTIVE).promise().done(function() {
            return stateComplete("makeSocialControlsActive");
          });
        };
      })(this);
      showAvatarFromGray = (function(_this) {
        return function() {
          return $(".avatar img", coubBlock).fadeIn(_this.TIME.LOAD.SHOW_AVATAR_FROM_GRAY).promise().done(function() {
            _this.removeStubFromUserpic($(".avatar", coubBlock));
            return stateComplete("showAvatarFromGray");
          });
        };
      })(this);
      fadeDescription = (function(_this) {
        return function() {
          return _this.getDescriptionElements(coubBlock).animate({
            opacity: 1
          }, _this.TIME.LOAD.FADE_DESCRIPTION).promise().done(function() {
            return stateComplete("fadeDescription");
          });
        };
      })(this);
      showTagsAndMedia = (function(_this) {
        return function() {
          var e;
          if ((e = $(".coub__tags, .coub__media-block", _this.element)).length > 0) {
            return e.removeClass('-hidden').animate({
              opacity: 1
            }, _this.TIME.LOAD.FADE_TAGS, function() {
              return stateComplete("showTagsAndMedia");
            });
          } else {
            return stateComplete("showTagsAndMedia");
          }
        };
      })(this);
      showSuggestions = (function(_this) {
        return function() {
          var animateRow, newSuggestItems, oldSuggestItems, queueAnimation, selectAll, suggestOffsets;
          NProgress.done();
          selectAll = function(container) {
            return container.find(".suggest__item");
          };
          animateRow = function(suggests, index, opacity, time) {
            if (index >= suggests.length) {
              return;
            }
            return suggests.eq(index).animate({
              opacity: opacity
            }, time).addClass('suggest-animated');
          };
          newSuggestItems = selectAll(_this.newSuggests);
          oldSuggestItems = selectAll(_this.oldSuggests);
          queueAnimation = function(index) {
            var opacity;
            if (index >= newSuggestItems.length) {
              _this.scrollOptimizer.disactivate();
              return stateComplete("showSuggestions");
            } else {
              animateRow(oldSuggestItems, index, (opacity = 0), _this.TIME.LOAD.SUGGESTS.OLD_FADE);
              return _this.nextSuggestTimeout = setTimeout(function() {
                animateRow(newSuggestItems, index, (opacity = 1), _this.TIME.LOAD.SUGGESTS.NEW_SHOW);
                return queueAnimation(index + 1);
              }, _this.TIME.LOAD.SUGGESTS.OLD_FADE);
            }
          };
          suggestOffsets = _.map(newSuggestItems, function(el) {
            return $(el).offset().top + $(el).outerHeight();
          });
          _this.scrollOptimizer = new ScrollEventOptimizer(function() {
            var firstOffset, index, scrollTop;
            scrollTop = $(window).scrollTop();
            firstOffset = _.find(suggestOffsets, function(v) {
              return v > scrollTop;
            });
            if (!firstOffset) {
              return;
            }
            index = suggestOffsets.indexOf(firstOffset);
            if (index < 4 || newSuggestItems.eq(index).hasClass('suggest-animated')) {
              return;
            }
            clearTimeout(_this.nextSuggestTimeout);
            queueAnimation(index);
            newSuggestItems.slice(0, index).css('opacity', '1').addClass('suggest-animated');
            return oldSuggestItems.slice(0, index).css('opacity', '0');
          }, 300);
          _this.newSuggests.parent().height(Math.max(_this.newSuggests.height(), _this.oldSuggests.height()));
          return queueAnimation(0);
        };
      })(this);
      states = [showSuggestions, showTagsAndMedia, showCounters, makeSocialControlsActive, showAvatarFromGray, fadeDescription];
      stateCompleteCounter = 0;
      stateComplete = (function(_this) {
        return function(from) {
          if (++stateCompleteCounter !== states.length) {
            return;
          }
          return _this.finishLoadAnimation();
        };
      })(this);
      return $(".coub__viewer").imagesLoaded((function(_this) {
        return function() {
          var i, len, player, results, state;
          player = $(".coub__viewer", coubBlock);
          _this.removeGrayBorderFromDescription($(".coub__description", coubBlock));
          player.css({
            opacity: 1
          });
          _this.removeCurtain();
          results = [];
          for (i = 0, len = states.length; i < len; i++) {
            state = states[i];
            results.push(state());
          }
          return results;
        };
      })(this));
    };

    return CoubPageAjaxReloadAnimator;

  })(CoubAnimators.AbstractAnimator);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.CoubAnimators.MultipageDialogStandartAnimator = (function(superClass) {
    extend(MultipageDialogStandartAnimator, superClass);

    function MultipageDialogStandartAnimator() {
      this.transition = bind(this.transition, this);
      this.constructFakeBack = bind(this.constructFakeBack, this);
      this.setArrowToPage = bind(this.setArrowToPage, this);
      this.setPageToSide = bind(this.setPageToSide, this);
      return MultipageDialogStandartAnimator.__super__.constructor.apply(this, arguments);
    }

    MultipageDialogStandartAnimator.prototype.SIDE = {
      LEFT: 0,
      RIGHT: 1
    };

    MultipageDialogStandartAnimator.prototype.TIME = {
      TRANSITION: 400,
      EASING: 200
    };

    MultipageDialogStandartAnimator.prototype.EASING_AMOUNT = 10;

    MultipageDialogStandartAnimator.prototype.setPageToSide = function(page, side) {
      var offset;
      if (side === this.SIDE.LEFT) {
        offset = 0 - page.outerWidth();
      } else {
        offset = page.outerWidth();
      }
      return page.css("left", offset);
    };

    MultipageDialogStandartAnimator.prototype.setArrowToPage = function(arrow, page) {
      return arrow.css("left", page.css("left"));
    };

    MultipageDialogStandartAnimator.prototype.constructFakeBack = function() {
      return " <div class=\"fake back\">Back</div> ";
    };

    MultipageDialogStandartAnimator.prototype.transition = function(from, to, direction, moveBackArrow, changeWidth) {
      var backArrowTransition, completeCount, fromAnimation, fromHeight, fromTransition, heightTransition, i, len, newHeight, newWidth, oldHeight, oldWidth, results, step, stepComplete, steps, toAnimation, toHeight, toTransition;
      if (moveBackArrow == null) {
        moveBackArrow = false;
      }
      oldHeight = this.element.height();
      oldWidth = this.element.width();
      from.hide();
      to.show();
      newHeight = this.element.height();
      if (changeWidth) {
        newWidth = changeWidth;
      } else {
        newWidth = this.element.width();
      }
      from.show();
      to.hide();
      this.element.css("height", oldHeight);
      this.element.css("width", oldWidth);
      from.css({
        position: "absolute"
      }).show();
      to.css({
        position: "absolute"
      }).show();
      fromAnimation = {};
      toAnimation = {};
      if (direction === MultipageDialog.TRANSITION_DIRECTION.FORWARD) {
        this.setPageToSide(to, this.SIDE.RIGHT);
        fromAnimation.left = 0 - from.outerWidth();
        toAnimation.left = 0 - this.EASING_AMOUNT;
      } else {
        this.setPageToSide(to, this.SIDE.LEFT);
        fromAnimation.left = from.outerWidth();
        toAnimation.left = this.EASING_AMOUNT;
      }
      if ((fromHeight = from.height()) < (toHeight = to.height())) {
        to.css({
          "margin-top": 0 - toHeight / 2 + fromHeight / 2
        });
        fromAnimation["margin-top"] = toHeight / 2 - fromHeight / 2;
        toAnimation["margin-top"] = 0;
      } else if (fromHeight > toHeight) {
        from.css({
          "margin-top": 0
        });
        to.css({
          "margin-top": fromHeight / 2 - toHeight / 2
        });
        fromAnimation["margin-top"] = 0 - fromHeight / 2 + toHeight / 2;
        toAnimation["margin-top"] = 0;
      }
      fromTransition = (function(_this) {
        return function() {
          return from.animate(fromAnimation, _this.TIME.TRANSITION, (function() {
            from.hide();
            return stepComplete();
          }));
        };
      })(this);
      toTransition = (function(_this) {
        return function() {
          return to.animate(toAnimation, _this.TIME.TRANSITION, function() {
            return to.animate({
              left: 0
            }, _this.TIME.EASING, stepComplete);
          });
        };
      })(this);
      heightTransition = (function(_this) {
        return function() {
          return _this.element.animate({
            height: newHeight,
            width: newWidth
          }, _this.TIME.TRANSITION, stepComplete);
        };
      })(this);
      backArrowTransition = (function(_this) {
        return function() {
          var backArrow, complete, fakeBackArrow;
          if (moveBackArrow) {
            backArrow = $(".dialog__navigation .back", _this.element);
            if (direction === MultipageDialog.TRANSITION_DIRECTION.FORWARD) {
              fakeBackArrow = to.prepend(_this.constructFakeBack()).find(".fake.back");
              complete = function() {
                return backArrow.show();
              };
            } else {
              fakeBackArrow = from.prepend(_this.constructFakeBack()).find(".fake.back");
              backArrow.hide();
              complete = function() {
                return null;
              };
            }
            return setTimeout((function() {
              fakeBackArrow.detach();
              complete();
              return stepComplete();
            }), _this.TIME.TRANSITION + _this.TIME.EASING);
          } else {
            return stepComplete();
          }
        };
      })(this);
      completeCount = 0;
      stepComplete = (function(_this) {
        return function() {
          completeCount++;
          if (completeCount === steps.length) {
            _this.element.css({
              height: ""
            });
            from.css({
              position: "",
              "margin-top": "",
              left: ""
            });
            to.css({
              position: "",
              "margin-top": "",
              left: ""
            });
            return _this.sendAnimationComplete();
          }
        };
      })(this);
      steps = [fromTransition, toTransition, heightTransition, backArrowTransition];
      results = [];
      for (i = 0, len = steps.length; i < len; i++) {
        step = steps[i];
        results.push(step());
      }
      return results;
    };

    return MultipageDialogStandartAnimator;

  })(CoubAnimators.AbstractAnimator);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.AuthPopup = {};

  window.AuthPopup.Handlers = {};

  window.AuthPopup.Base = (function() {
    Base.ACTIONS = {
      SHOW_OVERLAY_LOADER: "AuthPopup:Base:Actions:ShowOverlayLoader",
      HIDE_OVERLAY_LOADER: "AuthPopup:Base:Actions:HideOverlayLoader",
      TOGGLE_DIALOG: "AuthPopup:Base:Actions:ToggleDialog",
      CLOSE_DIALOG: "AuthPopup:Base:Actions:CloseDialog"
    };

    Base.EVENTS = {
      TO_DIALOG: {
        SHOWED: "AuthPopup:Base:Showed"
      },
      POPUP_CLOSED: "AuthPopup:Base:Closed",
      POPUP_SHOWED: "AuthPopup:Base:Showed"
    };

    Base.EVENT_POPUP_WORKFLOW_COMPLETED = "AuthPopup-Base:PopupWorkflowCompleted";

    Base.EVENT_USER_SIGNED = "AuthPopup-Base:UserSigned";

    Base.ACTION_FORBID_REDIRECT = "AuthPopup-Base:ForbidRedirect";

    Base.ACTION_ALLOW_REDIRECT = "AuthPopup-Base:AllowRedirect";

    Base.prototype.DT = "AuthPopup.Base";

    Base.DIALOG_PAGES = {
      sign_up: 'app/site/templates/registration/pages/sign_up_page',
      sign_in: 'app/site/templates/registration/pages/sign_in_page',
      follow: 'app/site/templates/registration/pages/follow_channels_page',
      reset: 'app/site/templates/registration/pages/reset_pass_page',
      pass_recover: 'app/site/templates/registration/pages/pass_recover_page',
      email_page: 'app/site/templates/registration/pages/email_page',
      username_page: 'app/site/templates/registration/pages/username_page'
    };

    Base.TIMING = {
      TOGGLE_TIME: 500
    };

    function Base(opts) {
      if (opts == null) {
        opts = {};
      }
      this.getSocButtonsToggler = bind(this.getSocButtonsToggler, this);
      this.getSocButtonsCont = bind(this.getSocButtonsCont, this);
      this.escClose = bind(this.escClose, this);
      this.hideCloseButton = bind(this.hideCloseButton, this);
      this.beforeToggle = bind(this.beforeToggle, this);
      this.toggleDialog = bind(this.toggleDialog, this);
      this.reactWorkflowCompleted = bind(this.reactWorkflowCompleted, this);
      this.reactSigned = bind(this.reactSigned, this);
      this._unbind = bind(this._unbind, this);
      this._bind = bind(this._bind, this);
      this._init = bind(this._init, this);
      this.s = this.constructor;
      this.el = opts.el;
      this.dialog = opts.dialog;
      this.userData = {};
      this.redirectLocker = new chms.utils.Locker();
      this._init(opts.action, opts.is_coub_oauth);
      this._bind();
    }

    Base.prototype._init = function(action, is_coub_oauth) {
      var cls, i, len, ref, results;
      switch (action) {
        case 'sign_in':
        case 'pass_recover':
        case 'reset':
          this.signinForm = new AuthPopup.Handlers.SigninForm({
            parent: this,
            is_coub_oauth: is_coub_oauth,
            action: action
          });
          break;
        case 'sign_up':
          this.signupForm = new AuthPopup.Handlers.SignupForm({
            parent: this
          });
      }
      $(document).trigger({
        type: AuthPopup.Base.EVENTS.POPUP_SHOWED,
        action: action
      });
      new Toggler(this.getSocButtonsToggler(), this.getSocButtonsCont(), {
        animator: new TogglerAnimators().cssMoreLess,
        beforeToggle: this.beforeToggle
      });
      ref = [AuthPopup.Handlers.EmailForm, AuthPopup.Handlers.UsernameForm, widgets.EmailRegistrationForm];
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        cls = ref[i];
        results.push(new cls(this.el.find("[" + cls.ATTR_NAME + "]"), this));
      }
      return results;
    };

    Base.prototype._bind = function() {
      $(document).on(this.s.ACTION_FORBID_REDIRECT, this.redirectLocker.lock).on(this.s.ACTION_ALLOW_REDIRECT, this.redirectLocker.unlock).on(AuthPopup.Base.ACTIONS.TOGGLE_DIALOG, this.toggleDialog).on('keyup', this.escClose);
      this.el.on('click', '[data-dialog-change]', (function(_this) {
        return function(e) {
          $(document).trigger({
            type: AuthPopup.Base.ACTIONS.TOGGLE_DIALOG,
            action: $(e.currentTarget).attr('data-dialog-change')
          });
          if (_this.redirectLocker.isLocked()) {
            return setTimeout(function() {
              return _.defer(function() {
                return $(document).trigger(_this.s.ACTION_FORBID_REDIRECT);
              });
            }, _this.s.TIMING.TOGGLE_TIME);
          }
        };
      })(this));
      $(".modal__close", this.el).on('click', this._unbind);
      this.el.one(Popup.EVENT_HIDED, function() {
        return $(document).trigger(AuthPopup.Base.EVENTS.POPUP_CLOSED);
      });
      return $(document).on(this.s.ACTIONS.CLOSE_DIALOG, (function(_this) {
        return function() {
          return _this.el.trigger(Popup.ACTION_CLOSE);
        };
      })(this));
    };

    Base.prototype._unbind = function() {
      return $(document).off(this.s.ACTION_FORBID_REDIRECT).off(this.s.ACTION_ALLOW_REDIRECT).off(AuthPopup.Base.ACTIONS.TOGGLE_DIALOG).off('keyup', this.escClose);
    };

    Base.prototype.reactSigned = function(userData) {
      if (userData == null) {
        userData = {};
      }
      console.log(this.DT, "React signed.", userData);
      this.userData = userData;
      return $(document).trigger({
        type: this.s.EVENT_USER_SIGNED,
        userData: this.userData
      });
    };

    Base.prototype.reactWorkflowCompleted = function() {
      console.log(this.DT, "React workflow completed.");
      return $(document).trigger({
        type: this.s.EVENT_POPUP_WORKFLOW_COMPLETED,
        userData: this.userData
      });
    };

    Base.prototype.toggleDialog = function(e) {
      this._unbind();
      this.el.trigger(Popup.ACTION_CLOSE);
      return setTimeout(function() {
        return AuthPopup.Base.constructAuthDialog(e.action);
      }, AuthPopup.Base.TIMING.TOGGLE_TIME);
    };

    Base.prototype.beforeToggle = function() {
      var btn, text;
      btn = this.getSocButtonsToggler().find('.sb');
      text = btn.text().trim();
      return btn.text(text === AuthPopupI18n.VIEW_SOCIALS.MORE ? AuthPopupI18n.VIEW_SOCIALS.LESS : AuthPopupI18n.VIEW_SOCIALS.MORE);
    };

    Base.prototype.hideCloseButton = function() {
      return this.el.find('.modal__close').hide();
    };

    Base.prototype.escClose = function(e) {};

    Base.prototype.getSocButtonsCont = function() {
      return this.el.find('.toggler__container');
    };

    Base.prototype.getSocButtonsToggler = function() {
      return this.el.find('.toggler__handler');
    };

    Base.constructAuthDialog = function(action, is_coub_oauth) {
      var actions, pages;
      pages = AuthPopup.Base.DIALOG_PAGES;
      actions = _.keys(pages);
      if (_.contains(actions, action)) {
        switch (action) {
          case 'sign_in':
            pages = _.omit(pages, 'sign_up');
            break;
          case 'sign_up':
            pages = _.omit(pages, 'sign_in');
        }
        return MultipageDialog.constructClientDialog({
          pages: pages,
          dClass: "registration registration--" + action,
          mClass: "modal--auth",
          startId: action,
          constructed: function(cont, dialog) {
            return new AuthPopup.Base({
              el: cont,
              dialog: dialog,
              action: action,
              is_coub_oauth: is_coub_oauth
            });
          }
        });
      } else {
        throw "There is no such action as " + action + ".\nAvailable actions: " + (actions.join(', '));
      }
    };

    return Base;

  })();

}).call(this);
(function() {
  window.AuthPopupI18n = {
    FORM_VALIDATION: {
      ERROR_MSGS: {
        WEAK_PASSWORD: "The password is too weak",
        INCORRECT_EMAIL: "Incorrect email",
        ALREADY_REGISTERED_EMAIL: "This e-mail is already registered. ",
        NOT_REGISTERED: "This e-mail is not registered. ",
        UNKNOWN_ERROR: "Unknown error"
      }
    },
    VIEW_SOCIALS: {
      MORE: "View more",
      LESS: "View less"
    }
  };

}).call(this);

/*
  Форма заполнения мейла в попапе регистрации
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  AuthPopup.Handlers.EmailForm = (function(superClass) {
    extend(EmailForm, superClass);

    EmailForm.ATTR_NAME = "widget-authpopup-handlers-emailform";

    EmailForm.prototype.DT = "AuthPopup.Handlers.EmailForm";

    function EmailForm(el, parent) {
      this.el = el;
      this.parent = parent;
      this.getErrorMsgContainer = bind(this.getErrorMsgContainer, this);
      this.hideErrorMsg = bind(this.hideErrorMsg, this);
      this.showErrorMsg = bind(this.showErrorMsg, this);
      this.validationInit = bind(this.validationInit, this);
      this.submitBtnClicked = bind(this.submitBtnClicked, this);
      EmailForm.__super__.constructor.apply(this, arguments);
      console.log(this.DT, "Init.", this.el, this.parent);
      this.submitbtn = $("[submit]", this.el);
      this.input = $("[name=email]", this.el);
      this.submitbtn.on("click", this.submitBtnClicked);
      this.el.on("submit", function(e) {
        e.preventDefault();
        return e.stopPropagation();
      });
      this.validationInit();
    }

    EmailForm.prototype.submitBtnClicked = function() {
      var rd;
      console.log(this.DT, "Submit btn clicked.");
      if (!this.el.valid()) {
        return;
      }
      rd = new siteData.RegistrationData();
      rd.extendData({
        email: this.input.val()
      });
      if (this.parent.signupForm != null) {
        return this.parent.signupForm.signup(rd.get("collectedData"));
      } else {
        return this.parent.signinForm.signup(rd.get("collectedData"));
      }
    };

    EmailForm.prototype.validationInit = function() {
      return this.el.validate({
        rules: {
          email: {
            required: true,
            clearance_0_16_email: true,
            remote: function() {
              return {
                async: false,
                url: "/check_email",
                type: "GET",
                data: {}
              };
            }
          }
        },
        onkeyup: false,
        onsubmit: false,
        errorPlacement: (function(_this) {
          return function(error, element) {
            return _this.showErrorMsg(error[0].innerHTML);
          };
        })(this),
        success: (function(_this) {
          return function() {
            return _this.hideErrorMsg();
          };
        })(this),
        messages: {
          email: {
            remote: helpers.Auth.errorMailAlreadyUsed(AuthPopupI18n.FORM_VALIDATION.ERROR_MSGS.ALREADY_REGISTERED_EMAIL, "sign_in", true)
          }
        }
      });
    };

    EmailForm.prototype.showErrorMsg = function(msg) {
      return this.getErrorMsgContainer().show().html(msg);
    };

    EmailForm.prototype.hideErrorMsg = function() {
      return this.getErrorMsgContainer().hide().html('');
    };

    EmailForm.prototype.getErrorMsgContainer = function() {
      return $(".-error-text", this.el);
    };

    return EmailForm;

  })(abstract.Object);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.AuthPopup.Handlers.ForgotPasswordForm = (function() {
    function ForgotPasswordForm(opts) {
      this.showSignup = bind(this.showSignup, this);
      this.submit = bind(this.submit, this);
      this.hideError = bind(this.hideError, this);
      this.showError = bind(this.showError, this);
      this.reset = bind(this.reset, this);
      this.el = $(opts.el);
      this.provider = new LoginDataProvider();
      this.owner = opts.owner;
      this.resetNotificationBlock = $('.reset-pass__notify', this.el);
      this.forgotPasswordForm = $("form", this.el);
      this.forgotPassMailInput = $('input.input-field', this.forgotPasswordForm);
      this.forgotPasswordForm.on('submit', this.submit);
      this.forgotPasswordForm.validate({
        rules: {
          email: {
            required: true,
            email: true
          }
        },
        onkeyup: false,
        errorPlacement: this.showError,
        success: this.hideError,
        messages: {
          email: {
            email: AuthPopupI18n.FORM_VALIDATION.ERROR_MSGS.INCORRECT_EMAIL
          }
        }
      });
      $(this.el).bind(MultipageDialog.EVENTS.TO_PAGES.AFTER_CLOSING, this.reset);
    }

    ForgotPasswordForm.prototype.reset = function() {
      this.forgotPasswordForm.show();
      this.resetNotificationBlock.hide();
      this.forgotPassMailInput.val('').removeClass("error");
      return this.hideError();
    };

    ForgotPasswordForm.prototype.showError = function(message) {
      return $(".-error-text", this.forgotPasswordForm).html(message).show();
    };

    ForgotPasswordForm.prototype.hideError = function() {
      return $(".-error-text", this.forgotPasswordForm).html('').hide();
    };

    ForgotPasswordForm.prototype.submit = function(e) {
      var emailInput, errorCbk, successCbk;
      if (e) {
        e.preventDefault();
        e.stopPropagation();
      }
      if (this.forgotPasswordForm.valid()) {
        (emailInput = this.forgotPassMailInput).removeClass('error');
        this.owner.showLoader();
        errorCbk = (function(_this) {
          return function(response) {
            _this.owner.hideLoader();
            if (response.status === 404) {
              emailInput.addClass('error');
              return _this.showError(_this.owner.transitionError(AuthPopupI18n.FORM_VALIDATION.ERROR_MSGS.NOT_REGISTERED, 'sign_up'));
            } else {
              return Growl.msg(I18n.ERRORS.INTERNAL_SERVER_ERROR.SUB, I18n.ERRORS.INTERNAL_SERVER_ERROR.TRY_AGAIN);
            }
          };
        })(this);
        successCbk = (function(_this) {
          return function() {
            _this.owner.hideLoader();
            _this.resetNotificationBlock.find('strong').text(emailInput.val());
            _this.forgotPasswordForm.hide();
            return _this.resetNotificationBlock.show();
          };
        })(this);
        return this.provider.recoverPasswordRequest({
          session: {
            email: emailInput.val()
          }
        }, successCbk, errorCbk);
      } else {

      }
    };

    ForgotPasswordForm.prototype.showSignup = function() {
      return $(".multipageDialog.signin").fadeOut(200, (function(_this) {
        return function() {
          return new AuthPopup.Base().showSignup();
        };
      })(this));
    };

    return ForgotPasswordForm;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.AuthPopup.Handlers.SigninEmailForm = (function() {
    function SigninEmailForm(opts) {
      this.hideError = bind(this.hideError, this);
      this.showError = bind(this.showError, this);
      this.signinError = bind(this.signinError, this);
      this.submitHandler = bind(this.submitHandler, this);
      this.el = $(opts.el);
      this.inputs = $('.input-field-group > input', this.el);
      this.owner = opts.owner;
      this.el.on("submit", this.submitHandler);
      this.reCaptchaInit();
    }

    SigninEmailForm.prototype.submitHandler = function(e) {
      this.hideError();
      e.preventDefault();
      e.stopPropagation();
      if (this.hasReCaptcha) {
        if (this.reCaptchaId == null) {
          return this.showError("reCAPTCHA failed");
        }
        grecaptcha.reset(this.reCaptchaId);
        return grecaptcha.execute(this.reCaptchaId);
      } else {
        return this.submit();
      }
    };

    SigninEmailForm.prototype.submit = function(captchaToken) {
      var signInData;
      signInData = this.el.serializeObject();
      signInData.captcha = captchaToken;
      return this.owner.signin(signInData, this.signinError);
    };

    SigninEmailForm.prototype.signinError = function(resp) {
      var error, json, msg;
      try {
        json = JSON.parse(resp.responseText);
        msg = json.message;
      } catch (error1) {
        error = error1;
        this.showError(AuthPopupI18n.FORM_VALIDATION.ERROR_MSGS.UNKNOWN_ERROR);
        msg = "Unknown error";
      }
      return this.showError(msg);
    };

    SigninEmailForm.prototype.showError = function(message) {
      $(".-error-text", this.el).html(message).show();
      return this.inputs.addClass('error');
    };

    SigninEmailForm.prototype.hideError = function() {
      $(".-error-text", this.el).html("").hide();
      return this.inputs.removeClass('error');
    };

    SigninEmailForm.prototype.reCaptchaInit = function() {
      var reCaptchaEl;
      reCaptchaEl = this.el.find(".registration-form__captcha").get(0);
      this.hasReCaptcha = reCaptchaEl != null;
      if (!this.hasReCaptcha) {
        return;
      }
      window.EmailLoginFormCaptchaOnLoad = (function(_this) {
        return function() {
          return _this.reCaptchaId = grecaptcha.render(reCaptchaEl, {
            sitekey: "6Ld-QzEUAAAAABCqiSmZhIkoDnp3OjL2Ipb__2Fe",
            size: "invisible",
            callback: _this.submit.bind(_this)
          }, false);
        };
      })(this);
      return $.getScript("https://www.google.com/recaptcha/api.js?onload=EmailLoginFormCaptchaOnLoad&render=explicit");
    };

    return SigninEmailForm;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  AuthPopup.Handlers.UsernameForm = (function(superClass) {
    extend(UsernameForm, superClass);

    UsernameForm.ATTR_NAME = "widget-authpopup-handlers-usernameform";

    UsernameForm.prototype.DT = "AuthPopup.Handlers.EmailForm";

    function UsernameForm(el, parent) {
      this.el = el;
      this.parent = parent;
      this.getErrorMsgContainer = bind(this.getErrorMsgContainer, this);
      this.hideErrorMsg = bind(this.hideErrorMsg, this);
      this.showErrorMsg = bind(this.showErrorMsg, this);
      this.submitBtnClicked = bind(this.submitBtnClicked, this);
      UsernameForm.__super__.constructor.apply(this, arguments);
      console.log(this.DT, "Init.", this.el, this.parent);
      this.submitbtn = $("[submit]", this.el);
      this.input = $("[name=name]", this.el);
      this.submitbtn.on("click", this.submitBtnClicked);
      this.el.on("submit", function(e) {
        e.preventDefault();
        return e.stopPropagation();
      });
      this.validationInit();
    }

    UsernameForm.prototype.submitBtnClicked = function() {
      var rd;
      console.log(this.DT, "Submit btn clicked.");
      if (!this.el.valid()) {
        return;
      }
      rd = new siteData.RegistrationData();
      rd.extendData({
        name: this.input.val()
      });
      if (this.parent.signupForm != null) {
        return this.parent.signupForm.signup(rd.get("collectedData"));
      } else {
        return this.parent.signinForm.signup(rd.get("collectedData"));
      }
    };

    UsernameForm.prototype.validationInit = function() {
      return this.el.validate({
        rules: {
          name: {
            required: true
          }
        },
        onkeyup: false,
        onsubmit: false,
        errorPlacement: (function(_this) {
          return function(error, element) {
            return _this.showErrorMsg(error[0].innerHTML);
          };
        })(this),
        success: (function(_this) {
          return function() {
            return _this.hideErrorMsg();
          };
        })(this)
      });
    };

    UsernameForm.prototype.showErrorMsg = function(msg) {
      return this.getErrorMsgContainer().show().html(msg);
    };

    UsernameForm.prototype.hideErrorMsg = function() {
      return this.getErrorMsgContainer().hide().html('');
    };

    UsernameForm.prototype.getErrorMsgContainer = function() {
      return $(".-error-text", this.el);
    };

    return UsernameForm;

  })(abstract.Object);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.AuthPopup.Handlers.FollowChannels = (function() {
    function FollowChannels(opts) {
      this.submit = bind(this.submit, this);
      this.recountCounters = bind(this.recountCounters, this);
      this.showOverlayLoader = bind(this.showOverlayLoader, this);
      this.hideLoader = bind(this.hideLoader, this);
      this.showLoader = bind(this.showLoader, this);
      this.loadNextPage = bind(this.loadNextPage, this);
      this.processPreloadMore = bind(this.processPreloadMore, this);
      this.getInputValue = bind(this.getInputValue, this);
      this.addSearchControl = bind(this.addSearchControl, this);
      this.renderChannels = bind(this.renderChannels, this);
      this.loadPage = bind(this.loadPage, this);
      this.el = $(opts.el);
      this.parent = opts.parent;
      this.opts = opts;
      this.retryCounter = new functions.RetryCounter();
      this.nextButton = $('.sb.submit', this.el);
      this.numberToFollow = parseInt($(this.el).attr('data-number-to-follow'));
      this.locker = new chms.utils.Locker();
      this.scroller = $('.niceScroller', this.el);
      this.channelsContainer = $('.follow-channels__body', this.el);
      this.channelsDescription = $('.follow-channels__submit > p', this.el);
      this.searchContainerLoader = $('.changeLoader', this.el);
      this.totalFollowedCount = parseInt($(this.el).attr('data-following'));
      this.currentPage = 1;
      this.type = 'list';
      this.nextButton.click(this.submit);
      $(this.el).one(MultipageDialog.EVENTS.TO_PAGES.AFTER_OPENING, (function(_this) {
        return function() {
          opts.base.hideCloseButton();
          Stats.track('sp_wtf_showed');
          _this.scroller.nice_scroller();
          _this.addSearchControl();
          _this.showOverlayLoader();
          _this.loadPage(_this.currentPage);
          _this.processPreloadMore();
          _this.noChannels = JST["app/site/templates/sign_popup/no_channels"]();
          _this.channelsContainer.one('Channels:added', function() {
            var channelsIdStat, i, id;
            channelsIdStat = [];
            i = 0;
            while (i < 6) {
              id = _this.channelsContainer.find('.channel--simple').eq(i).attr('data-channel-id');
              channelsIdStat.push(parseFloat(id));
              i++;
            }
            Stats.track('sp_wtf_channels_showed', {
              channel_id: channelsIdStat
            });
            return _.each(_this.channelsContainer.find('.channel__title.hbold a'), function(title) {
              return $(title).text_shortener({
                linesCount: 2
              });
            });
          });
          _this.input.on('input', function() {
            _this.currentPage = 1;
            return _this.getInputValue(_this.input.val());
          });
          $(document).bind(widgets.FollowButton.EVENTS.FOLLOWED, function(e) {
            _this.totalFollowedCount += 1;
            _this.recountCounters(_this.totalFollowedCount);
            return Stats.track('sp_wtf_follow_occured', {
              channel_id: e.targetId
            });
          });
          $(document).bind(widgets.FollowButton.EVENTS.UNFOLLOWED, function() {
            _this.totalFollowedCount -= 1;
            return _this.recountCounters(_this.totalFollowedCount);
          });
          return _this.recountCounters(_this.totalFollowedCount);
        };
      })(this));
    }

    FollowChannels.prototype.loadPage = function(page) {
      this.locker.lock();
      return $.get(Routes.recommended_api_v2_friends_path({
        page: page
      })).fail(ErrorMessages.internalServerError).done((function(_this) {
        return function(resp) {
          _this.totalPages = resp.total_pages;
          _this.renderChannels(resp.channels);
          return _this.channelsContainer.trigger('Channels:added');
        };
      })(this)).always((function(_this) {
        return function() {
          _this.locker.unlock();
          _this.hideLoader();
          return _this.hideOverlayLoader();
        };
      })(this));
    };

    FollowChannels.prototype.renderChannels = function(channels) {
      var block, channel, j, len, results;
      results = [];
      for (j = 0, len = channels.length; j < len; j++) {
        channel = channels[j];
        block = $(JST['app/site/templates/channel_item/simple_channel_item']({
          channel: channel,
          followCls: ''
        })).wrap("<div class='grid-col -col-one-half'></div>").parent().appendTo(this.channelsContainer);
        results.push(chms.utils.Autoinit.init(widgets.WidgetFollowButtonInit, block));
      }
      return results;
    };

    FollowChannels.prototype.addSearchControl = function() {
      this.inputContainer = $(JST["app/site/templates/sign_popup/who_to_follow_search"]());
      this.inputContainer.appendTo($(this.el).parents('.modal__body'));
      return this.input = $('input', this.inputContainer);
    };

    FollowChannels.prototype.getInputValue = function(val) {
      if (this.loadPageQuery != null) {
        this.loadPageQuery.abort();
        this.loadPageQuery = void 0;
      }
      clearTimeout(this.multiQueuePrevent);
      this.channelsContainer.html('').css({
        height: ''
      });
      if (!val.length) {
        return this.loadPage(this.currentPage);
      } else {
        return this.multiQueuePrevent = setTimeout(this.makeSearchReq.bind(this), 300, val);
      }
    };

    FollowChannels.prototype.makeSearchReq = function(val) {
      this.showOverlayLoader();
      return this.loadPageQuery = $.get(Routes.recommended_api_v2_friends_path({
        q: val
      })).done((function(_this) {
        return function(resp) {
          _this.currentPage = 1;
          if (_this.loadPageQuery != null) {
            _this.loadPageQuery.abort();
          }
          if (resp.channels.length) {
            return _this.renderChannels(resp.channels);
          } else {
            return _this.channelsContainer.css({
              height: 'inherit'
            }).append(_this.noChannels);
          }
        };
      })(this)).always(this.hideOverlayLoader.bind(this));
    };

    FollowChannels.prototype.processPreloadMore = function() {
      return this.scroller.on('nice_scroll:at_the_end', (function(_this) {
        return function() {
          return _this.loadNextPage();
        };
      })(this));
    };

    FollowChannels.prototype.loadNextPage = function() {
      return this.locker.safeExec((function(_this) {
        return function() {
          if ((_this.currentPage + 1) <= _this.totalPages && _this.type === 'list') {
            _this.showLoader();
            return _this.loadPage(_this.currentPage += 1);
          }
        };
      })(this));
    };

    FollowChannels.prototype.showLoader = function() {
      return LoadRotator.appendToContainterAndStart(this.channelsContainer, 'small');
    };

    FollowChannels.prototype.hideLoader = function() {
      return LoadRotator.removeFromContainer(this.channelsContainer);
    };

    FollowChannels.prototype.showOverlayLoader = function() {
      return LoadRotator.appendWithOverlayAndStart(this.scroller);
    };

    FollowChannels.prototype.hideOverlayLoader = function() {
      return LoadRotator.removeWithOverlay(this.scroller);
    };

    FollowChannels.prototype.recountCounters = function(total) {
      var percent;
      percent = parseInt((total / this.numberToFollow) * 100);
      this.nextButton.find('span').css({
        'width': percent + "%"
      });
      if (total >= 3) {
        this.nextButton.removeClass('-grey disabled').addClass('-blue').removeAttr('disabled');
        return this.channelsDescription.html(I18n.t("auth_popup.channels_registration.whotofollow_step_other"));
      } else {
        this.nextButton.removeClass('-blue').addClass('-grey disabled').attr('disabled', true);
        return this.channelsDescription.html(I18n.t("auth_popup.channels_registration.whotofollow_step_" + total));
      }
    };

    FollowChannels.prototype.submit = function(e) {
      e.preventDefault();
      e.stopPropagation();
      if ($(e.currentTarget).is(':disabled')) {
        return false;
      }
      Stats.track('sp_wtf_submitted');
      return this.markAsCompletedAndGoForward();
    };

    FollowChannels.prototype.markAsCompletedAndGoForward = function() {
      return $.post(Routes.mark_channels_guide_as_seen_api_v2_users_path()).done((function(_this) {
        return function() {
          _this.opts.onSubmit();
          return _this.inputContainer.remove();
        };
      })(this)).fail(ErrorMessages.internalServerError);
    };

    return FollowChannels;

  })();

}).call(this);
(function() {
  window.AuthPopup.Handlers.OAuthButton = (function() {
    OAuthButton.ATTR_NAME = "data-auth-button";

    function OAuthButton(opts) {
      this.opts = opts;
      this.kind = opts.kind;
      this.provider = new AuthDataProvider();
      $(opts.el).on("click", this.openPopup.bind(this));
    }

    OAuthButton.prototype.openPopup = function(e) {
      var kind;
      e.preventDefault();
      kind = this.provider.KIND[this.kind.toUpperCase()];
      return this.provider.authorizeInProvider(kind, this.oauthSuccess.bind(this), this.oauthFailure.bind(this));
    };

    OAuthButton.prototype.oauthFailure = function() {
      return this.opts.onFailure();
    };

    OAuthButton.prototype.oauthSuccess = function(data) {
      return this.opts.onSuccess(data);
    };

    return OAuthButton;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.AuthPopup.Handlers.PassRecovery = (function() {
    function PassRecovery(opts) {
      this.formError = bind(this.formError, this);
      this.ajaxError = bind(this.ajaxError, this);
      this.ajaxSuccess = bind(this.ajaxSuccess, this);
      this.submit = bind(this.submit, this);
      this.el = $(opts.el);
      this.form = $('form', this.el);
      new AuthPopup.Handlers.PasswordStrengthChecker({
        el: this.form
      });
      this.form.validate({
        rules: {
          password: {
            required: true,
            normalOrStrongPassword: true
          }
        },
        onkeyup: false,
        errorPlacement: (function(_this) {
          return function(error, element) {
            return $('.input-field', _this.form).addClass('error');
          };
        })(this),
        success: (function(_this) {
          return function(label) {
            return $('.input-field', _this.form).removeClass('error');
          };
        })(this)
      });
      this.el.on('submit', 'form', this.submit);
    }

    PassRecovery.prototype.submit = function(e) {
      var data;
      e.preventDefault();
      e.stopPropagation();
      if (this.form.valid()) {
        data = this.form.serializeObject();
        data.email = window.user_email;
        data.confirmation_token = window.confirmation_token;
        return new LoginDataProvider().recoveryPassword(data, this.ajaxSuccess, this.ajaxError);
      } else {
        return this.formError();
      }
    };

    PassRecovery.prototype.ajaxSuccess = function(data) {
      if (data.redirect_url === window.location.href) {
        return window.location.reload();
      } else {
        return window.location.href = data.redirect_url;
      }
    };

    PassRecovery.prototype.ajaxError = function(response) {
      if (response.status === 422) {
        return this.formError();
      } else {
        return Growl.msg(I18n.ERRORS.INTERNAL_SERVER_ERROR.SUB, I18n.ERRORS.INTERNAL_SERVER_ERROR.TRY_AGAIN);
      }
    };

    PassRecovery.prototype.formError = function() {
      return this.form.find('input[type=password]').focus();
    };

    return PassRecovery;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.AuthPopup.Handlers.SignForm = (function() {
    SignForm.ACTION_ALLOW_REDIRECT = "AutoPopup-Handlers-Actions:AllowRedirect";

    function SignForm(opts) {
      this.hideLoader = bind(this.hideLoader, this);
      this.showLoader = bind(this.showLoader, this);
      this.oauthFailure = bind(this.oauthFailure, this);
      this.oauthSuccess = bind(this.oauthSuccess, this);
      this.signInSuccess = bind(this.signInSuccess, this);
      this.signin = bind(this.signin, this);
      this.ajaxError = bind(this.ajaxError, this);
      this.signup = bind(this.signup, this);
      var i, len, provider, ref, selector;
      this.is_coub_oauth = opts.is_coub_oauth;
      this.s = this.constructor;
      this.provider = new LoginDataProvider();
      this.parent = opts.parent;
      this.el = this.parent.el;
      this.dialog = this.parent.dialog;
      opts = {
        onSuccess: this.oauthSuccess,
        onFailure: this.oauthFailure
      };
      ref = ['firebase', 'facebook', 'twitter', 'vkontakte', 'google'];
      for (i = 0, len = ref.length; i < len; i++) {
        provider = ref[i];
        selector = "[data-auth-button=" + provider + "]";
        new window.AuthPopup.Handlers.OAuthButton(_.extend(opts, {
          el: $(selector, this.el),
          kind: provider
        }));
      }
      this.invitesWereSent = false;
      this.dontShowFindFriendsAgain = false;
      this.signupProvider = 'password';
      this.friendsData = {
        totalRegistered: 0,
        totalUnregistered: 0
      };
      this.pages = {
        signupPage: ".dialog__pages [page-id=sign-up-page]",
        followChannels: ".dialog__pages [page-id=follow-channels-page]",
        emailPage: ".dialog__pages [page-id=emailPage]",
        usernamePage: ".dialog__pages [page-id=usernamePage]"
      };
      this.followChannels = new AuthPopup.Handlers.FollowChannels({
        el: $(this.pages.followChannels, this.el),
        parent: this,
        base: this.parent,
        onSubmit: (function(_this) {
          return function(e) {
            _this.showLoader();
            Stats.track('sp_signup_complete_screen_clicked');
            _this.parent.redirectLocker.safeExec(function() {
              return $.handleRedirect('/');
            });
            return _this.parent.reactWorkflowCompleted();
          };
        })(this)
      });
      if ($('[page-id=sign-up-page]', this.el).is(":visible")) {
        this.sendOpeningToStats();
      }
    }

    SignForm.prototype.sendOpeningToStats = function() {
      var e_name, page;
      if (this.stats_was_tracked) {
        return;
      }
      page = $('[page-id=sign-up-page]', this.el);
      e_name = page.parents('.closedPage').size() > 0 ? "sp_closed_site_screen_showed" : "sp_signup_page_screen_showed";
      Stats.track(e_name);
      return this.stats_was_tracked = true;
    };

    SignForm.prototype.signup = function(data, redirect, error) {
      if (redirect == null) {
        redirect = false;
      }
      if (error == null) {
        error = void 0;
      }
      return this.provider.signupLogic(data, redirect, error, this.is_coub_oauth, {
        beforeSignup: this.showLoader,
        afterSignup: (function(_this) {
          return function(resp) {
            _this.hideLoader();
            _this.moveToPage('followChannels');
            return _this.parent.reactSigned(resp.user);
          };
        })(this),
        error: (function(_this) {
          return function() {
            _this.hideLoader();
            return _this.ajaxError();
          };
        })(this)
      });
    };

    SignForm.prototype.ajaxError = function(response) {
      return Growl.msg(I18n.ERRORS.INTERNAL_SERVER_ERROR.SUB, I18n.ERRORS.INTERNAL_SERVER_ERROR.TRY_AGAIN);
    };

    SignForm.prototype.signin = function(data, errorCallback) {
      var d;
      this.showLoader();
      d = {
        session: data
      };
      return this.provider.signin($.param(d), (function(_this) {
        return function(data) {
          _this.hideLoader();
          return _this.signInSuccess(data);
        };
      })(this), (function(_this) {
        return function(resp) {
          _this.hideLoader();
          if (errorCallback != null) {
            return errorCallback(resp);
          }
        };
      })(this));
    };

    SignForm.prototype.signInSuccess = function(data) {
      this.parent.redirectLocker.safeExec((function(_this) {
        return function() {
          if (data.redirect) {
            $.handleRedirect(_this.is_coub_oauth && data.oauth_redirect || data.redirect);
            return _.defer(function() {
              return $(document).trigger(AuthPopup.Base.ACTIONS.SHOW_OVERLAY_LOADER);
            });
          }
        };
      })(this));
      this.parent.reactSigned(data.user);
      return this.parent.reactWorkflowCompleted();
    };

    SignForm.prototype.oauthSuccess = function(data) {
      return this.provider.signupOAuthLogic(data, {
        authChecked: this.hideLoader,
        error: (function(_this) {
          return function() {
            _this.hideLoader();
            return ErrorMessages.internalServerError();
          };
        })(this),
        signin: (function(_this) {
          return function(resp, regData) {
            return _this.signin(regData);
          };
        })(this),
        signup: (function(_this) {
          return function(resp, regData, redirect) {
            if (redirect == null) {
              redirect = false;
            }
            return _this.signup(regData, redirect);
          };
        })(this),
        collectMail: (function(_this) {
          return function() {
            return _this.moveToPage("emailPage");
          };
        })(this),
        collectUsername: (function(_this) {
          return function() {
            return _this.moveToPage("usernamePage");
          };
        })(this)
      });
    };

    SignForm.prototype.oauthFailure = function() {
      return Growl.msg(I18n.ERRORS.AUTH_FAILED.HEADER, I18n.ERRORS.AUTH_FAILED.SUB);
    };

    SignForm.prototype.moveToPage = function(pname) {
      var newPage;
      newPage = this.pages[pname];
      return this.dialog.moveToPage($(newPage, this.el));
    };

    SignForm.prototype.transitionError = function(msg, action) {
      var trigger;
      trigger = " <span data-dialog-change=" + action + ">" + (I18n.t("auth_popup." + action)) + "</span>";
      return msg + trigger;
    };

    SignForm.prototype.showLoader = function() {
      return LoadRotator.appendWithOverlayAndStart(this.el.find('.dialog'));
    };

    SignForm.prototype.hideLoader = function() {
      return LoadRotator.removeWithOverlay(this.el.find('.dialog'));
    };

    return SignForm;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.AuthPopup.Handlers.SigninForm = (function(superClass) {
    extend(SigninForm, superClass);

    function SigninForm(opts) {
      this.goToForgotPassword = bind(this.goToForgotPassword, this);
      SigninForm.__super__.constructor.apply(this, arguments);
      this.loginPasswordForm = $('.login-pass', opts.el);
      this.forgotPasswordForm = new AuthPopup.Handlers.ForgotPasswordForm({
        el: $("[page-id=reset-pass-page]", opts.el),
        owner: this
      });
      this.signinEmailForm = new AuthPopup.Handlers.SigninEmailForm({
        el: $(".login-pass", opts.el),
        owner: this
      });
      $("[reset-pass-button]", opts.el).click(this.goToForgotPassword);
      if (opts.action === 'pass_recover') {
        new AuthPopup.Handlers.PassRecovery({
          el: $('[page-id="pass-recover-page"]', opts.el)
        });
      }
    }

    SigninForm.prototype.goToForgotPassword = function() {
      this.forgotPasswordForm.forgotPassMailInput.val(this.signinEmailForm.inputs.filter('[name=email]').val());
      return this.dialog.moveToPageById(["reset-pass-page"]);
    };

    return SigninForm;

  })(AuthPopup.Handlers.SignForm);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.AuthPopup.Handlers.SignupForm = (function(superClass) {
    extend(SignupForm, superClass);

    function SignupForm(opts) {
      this.oauthFailure = bind(this.oauthFailure, this);
      this.ajaxError = bind(this.ajaxError, this);
      SignupForm.__super__.constructor.apply(this, arguments);
      this.amplitudeEnabled = opts.action === 'sign_up';
      if (this.amplitudeEnabled) {
        this.appendix = '_fromPopup';
        AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.SHOWED + this.appendix);
        $('[data-auth-button="vkontakte"]').click((function(_this) {
          return function() {
            return AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.VK_BUTTON_CLICKED + _this.appendix);
          };
        })(this));
        $('[data-auth-button="facebook"]').click((function(_this) {
          return function() {
            return AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.FB_BUTTON_CLICKED + _this.appendix);
          };
        })(this));
        $('[data-auth-button="twitter"]').click((function(_this) {
          return function() {
            return AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.TW_BUTTON_CLICKED + _this.appendix);
          };
        })(this));
        $('[submit]').click((function(_this) {
          return function() {
            return AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.SUBMIT_BUTTON_CLICKED + _this.appendix);
          };
        })(this));
        $(document).on(window.AuthPopup.Base.EVENT_USER_SIGNED, (function(_this) {
          return function() {
            return AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.SUCCESS + _this.appendix);
          };
        })(this));
      }
    }

    SignupForm.prototype.ajaxError = function(response) {
      SignupForm.__super__.ajaxError.apply(this, arguments);
      if (this.amplitudeEnabled) {
        return AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.SERVER_ERROR + this.appendix);
      }
    };

    SignupForm.prototype.oauthFailure = function() {
      SignupForm.__super__.oauthFailure.apply(this, arguments);
      if (this.amplitudeEnabled) {
        return AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.OAUTH_ERROR + this.appendix);
      }
    };

    return SignupForm;

  })(AuthPopup.Handlers.SignForm);

}).call(this);
(function() {
  window.AuthPopup.Handlers.PasswordStrengthChecker = (function() {
    function PasswordStrengthChecker(opts) {
      var input, label, passwordLabel;
      this.el = opts.el;
      $.validator.addMethod("normalOrStrongPassword", (function(value, element) {
        return !$(element).parent().find("label.pass-checker").hasClass("-weak");
      }), AuthPopupI18n.FORM_VALIDATION.ERROR_MSGS.WEAK_PASSWORD);
      if ((label = $('label.pass-checker', this.el)).size() > 0) {
        passwordLabel = label;
      } else {
        passwordLabel = $(this.getCheckerTemplate());
        $(this.el).append(passwordLabel);
      }
      input = $('input[type=password]', this.el);
      input.password_strength({
        container: passwordLabel.find('span'),
        minLength: 6,
        texts: {
          1: I18n.t('profile.edit.weak_pass'),
          2: I18n.t('profile.edit.strong_pass')
        },
        onCheck: (function(_this) {
          return function(v) {
            if (input.is(":visible")) {
              passwordLabel.removeClass('-weak').removeClass('-strong').show();
              if (v === 1) {
                return passwordLabel.addClass('-weak');
              } else {
                return passwordLabel.addClass('-strong');
              }
            }
          };
        })(this)
      });
      input.bind("keyup blur", (function(_this) {
        return function() {
          if (input.val() === '') {
            return passwordLabel.hide();
          }
        };
      })(this));
    }

    PasswordStrengthChecker.prototype.getCheckerTemplate = function() {
      return "<label class=\"pass-checker hbold -hidden \">\n <span></span>\n </label>";
    };

    return PasswordStrengthChecker;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.AddAuthenticationButton = (function() {
    function AddAuthenticationButton(el) {
      this.getAuthError = bind(this.getAuthError, this);
      this.oauthFailure = bind(this.oauthFailure, this);
      this.hideAuthError = bind(this.hideAuthError, this);
      this.showAuthError = bind(this.showAuthError, this);
      this.buttonClicked = bind(this.buttonClicked, this);
      this.el = $(el);
      this.button = this.el.find('.sb');
      this.provider = this.button.attr('data-provider');
      this.channelId = this.button.attr('data-channel-id');
      this.authDataProvider = new AuthDataProvider();
      this.shareBlock = this.el.find('.settings__auth-autopost');
      this.shareBlockCheckboxes = this.shareBlock.find("input[type='checkbox']");
      this.text = {
        connect: this.button.attr('data-connect-text'),
        disconnect: this.button.attr('data-disconnect-text')
      };
      this.button.on("click", this.buttonClicked);
    }

    AddAuthenticationButton.prototype.buttonClicked = function(e) {
      var error, success;
      e.preventDefault();
      success = (function(_this) {
        return function(resp) {
          _this.successfullyConnected(resp.channel);
          _this.hideAuthError();
          return _this.el.trigger("success");
        };
      })(this);
      error = (function(_this) {
        return function(resp) {
          var status;
          status = resp != null ? resp.status : 0;
          switch (status) {
            case 422:
              _this.showAuthError(I18n.t('profile.errors.auth_taken'));
              break;
            default:
              _this.oauthFailure();
          }
          return _this.el.trigger("error");
        };
      })(this);
      if (this.button.attr('data-connected') === 'true') {
        return this.removeAuthentication();
      } else {
        return this.authDataProvider.addAuthFullCycle(AuthDataProvider.KIND[this.provider.toUpperCase()], this.channelId, success, error);
      }
    };

    AddAuthenticationButton.prototype.successfullyConnected = function(channel) {
      var i, key, kind, len, ref, userNameFromProvider;
      userNameFromProvider = helpers.Channel.getProviderUserName(this.provider, channel.authentications);
      this.button.find('span').text(this.text.disconnect).end().attr('data-connected', 'true');
      this.el.find('.settings__auth-user').html(userNameFromProvider);
      ref = ['coub', 'recoub'];
      for (i = 0, len = ref.length; i < len; i++) {
        kind = ref[i];
        key = "autopost_" + kind + "_to_" + this.provider;
        $("#channel_" + key, this.el).prop({
          checked: !!channel[key],
          disabled: false
        });
      }
      return this.checkIfConnected();
    };

    AddAuthenticationButton.prototype.removeAuthentication = function() {
      var error, success;
      success = (function(_this) {
        return function(resp) {
          return _this.successfullyRemoved();
        };
      })(this);
      error = (function(_this) {
        return function(resp) {
          return Growl.msg('Remove authentication', 'Error occured');
        };
      })(this);
      return this.authDataProvider.removeAuth(this.provider.toUpperCase(), this.channelId, success, error);
    };

    AddAuthenticationButton.prototype.successfullyRemoved = function() {
      this.button.find('span').text(helpers.Application.capitalize(this.text.connect)).end().attr('data-connected', 'false');
      $("input[type=checkbox]", this.el).prop("disabled", true);
      return this.checkIfConnected();
    };

    AddAuthenticationButton.prototype.showAuthError = function(msg) {
      var label;
      label = " <label class='m-label-error " + this.provider + "'>" + msg + "</label>";
      if (!this.getAuthError().length) {
        return this.el.after(label);
      }
    };

    AddAuthenticationButton.prototype.hideAuthError = function() {
      if (this.getAuthError().length) {
        return this.getAuthError().detach();
      }
    };

    AddAuthenticationButton.prototype.oauthFailure = function() {
      return Growl.msg("Authentication", 'Error occured');
    };

    AddAuthenticationButton.prototype.checkIfConnected = function() {
      if (this.button.attr('data-connected') === 'true') {
        return this.el.addClass('connected');
      } else {
        return this.el.removeClass('connected');
      }
    };

    AddAuthenticationButton.prototype.getAuthError = function() {
      return this.el.parent().find(".m-label-error." + this.provider);
    };

    AddAuthenticationButton.construct = function() {
      return $('.settings__auth').each(function() {
        return new AddAuthenticationButton(this);
      });
    };

    return AddAuthenticationButton;

  })();

}).call(this);
(function() {
  window.ToggleRegistration = (function() {
    function ToggleRegistration() {}

    ToggleRegistration.construct = function(container) {
      if (container == null) {
        container = void 0;
      }
      if (!container) {
        throw "ToggleSignUpButton: it require container in order to work";
      }
      return $('.toggle-registration', container).on("click", function(e) {
        var action;
        action = $(e.currentTarget).attr('data-action');
        AuthPopup.Base.constructAuthDialog(action);
        return false;
      });
    };

    return ToggleRegistration;

  })();

}).call(this);
(function() {
  window.ToggleSignInButton = (function() {
    function ToggleSignInButton(opts) {
      if (opts == null) {
        opts = {};
      }
      $(this.el).bind("click", function() {
        return false;
      });
    }

    ToggleSignInButton.construct = function(container) {
      if (container == null) {
        container = void 0;
      }
      if (!container) {
        throw "ToggleSignInButton: it require container in order to work";
      }
      return $('.show-signin', container).each(function() {
        return new ToggleSignInButton({
          el: this,
          action: 'sign-in'
        });
      });
    };

    return ToggleSignInButton;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.AvatarModerationBlock = (function() {
    function AvatarModerationBlock(opts) {
      this.saveAndGoNext = bind(this.saveAndGoNext, this);
      this.el = $(opts.el);
      this.container = $('.avatar-moderation__channels', this.el);
      this.button = $('.avatar-moderation__save', this.el);
      this.provider = new dataProviders.ApiV2Editor();
      this.el.on('click', '.avatar-moderation__channel', this.markAsBanned);
      this.el.on('click', '.avatar-moderation__channel a', this.linkClicked);
      this.button.click(this.saveAndGoNext);
      this.fetchUsers();
    }

    AvatarModerationBlock.prototype.linkClicked = function(e) {
      return e.stopPropagation();
    };

    AvatarModerationBlock.prototype.markAsBanned = function(e) {
      var ban, block;
      block = $(e.currentTarget);
      ban = !block.hasClass('banned');
      if (ban) {
        block.addClass('banned');
      } else {
        block.removeClass('banned');
      }
      return false;
    };

    AvatarModerationBlock.prototype.fetchUsers = function() {
      LoadRotator.appendToContainterAndStart(this.container, '-abs');
      return this.provider.getUsersForAvatarModeration({
        success: (function(_this) {
          return function(data) {
            return _this.renderUsers(data);
          };
        })(this),
        error: ErrorMessages.internalServerError,
        complete: (function(_this) {
          return function() {
            return LoadRotator.removeFromContainer(_this.container);
          };
        })(this)
      });
    };

    AvatarModerationBlock.prototype.renderUsers = function(data) {
      return _.each(data.channels, (function(_this) {
        return function(channel) {
          var avatar, html;
          avatar = helpers.Application.specificImgVersion(channel, 'avatar_versions', 'profile_pic_new', true);
          html = "<div class='grid-col -col-one-fifth -centered-text avatar-moderation__channel' data-id='" + channel.id + "'>\n  <img " + avatar + " class=\"image -rounded\" width='110' height='110' />\n  <a href='/" + channel.permalink + "' class=\"small -color--blue-ribbon -undr\" target='_blank'>" + channel.title + "</a>\n</div>";
          return _this.container.append(html);
        };
      })(this));
    };

    AvatarModerationBlock.prototype.saveAndGoNext = function(e) {
      var bannedCount, data;
      data = [];
      bannedCount = 0;
      $(".avatar-moderation__channel", this.container).each((function(_this) {
        return function(ind, user) {
          var us;
          us = $(user);
          if (us.hasClass('banned')) {
            bannedCount += 1;
          }
          return data.push({
            id: us.attr('data-id'),
            status: us.hasClass('banned') ? 'banned' : "ok"
          });
        };
      })(this));
      this.button.val('Saving...');
      return this.provider.avatarModerationSaveStatus(JSON.stringify({
        channels_data: data
      }), {
        success: (function(_this) {
          return function(resp) {
            Growl.msg('All saved', bannedCount + " userpics were banned");
            _this.container.html('');
            _this.button.val('Loading next...');
            return _this.fetchUsers();
          };
        })(this),
        error: (function(_this) {
          return function() {
            return Growl.msg('Error occured while saving');
          };
        })(this)
      });
    };

    return AvatarModerationBlock;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.TimelineBanner = (function() {
    TimelineBanner.BANNERS = {};

    function TimelineBanner(el, vb) {
      this.el = el;
      this.vb = vb;
      this.hide = bind(this.hide, this);
      this.show = bind(this.show, this);
      this.onCloseClick = bind(this.onCloseClick, this);
      this.onBannerClick = bind(this.onBannerClick, this);
      this.onPlayerStarted = bind(this.onPlayerStarted, this);
      this.data = widgets.TimelineBanner.BANNERS[this.el.attr('data-channel-id')];
      if (GlobalState.PAGE.isStoryPage() || GlobalState.PAGE.isChatPage()) {
        return;
      }
      if (this.data.height > this.vb.height()) {
        return;
      }
      this.data.click_url = this.data.click_url.replace("[RANDOM]", Math.random());
      this.data.pixel_view = this.data.pixel_view.replace("[RANDOM]", Math.random());
      this.vb.one(Player.EVENT_PLAYING, this.onPlayerStarted);
      $('img', this.el).on('click', this.onBannerClick);
      $('.coub__banner-timeline__close', this.el).on('click', this.onCloseClick);
    }

    TimelineBanner.prototype.onPlayerStarted = function() {
      $('img', this.el).attr({
        src: this.data.image,
        height: this.data.height
      });
      helpers.Ads.trackStatsPixel(this.data.pixel_view);
      if (this.data.pixel_view2) {
        helpers.Ads.trackStatsPixel(this.data.pixel_view2);
      }
      this.el.addClass('-showed');
      return this.show();
    };

    TimelineBanner.prototype.onBannerClick = function() {
      return window.open(this.data.click_url, '_blank');
    };

    TimelineBanner.prototype.onCloseClick = function() {
      clearTimeout(this.timeout_id);
      this.el.removeClass('-showed -finished');
      return setTimeout(this.hide, 800);
    };

    TimelineBanner.prototype.show = function() {
      this.el.addClass('-visible');
      return this.timeout_id = setTimeout(((function(_this) {
        return function() {
          return _this.el.addClass('-finished');
        };
      })(this)), 800);
    };

    TimelineBanner.prototype.hide = function() {
      return this.el.removeClass('-visible');
    };

    TimelineBanner.getBannerIdForCoub = function(coub) {
      var bannerChannelIds, currentProfileId, recoubedChannelIds;
      if (!GlobalState.COUNTRY.isExUssr() || GlobalState.PAGE.isOldSpicePromo2016() || !coub.promo_winner) {
        return;
      }
      currentProfileId = (Params.getBranchValue('profile_channel.id') || 0).toString();
      if (currentProfileId in widgets.TimelineBanner.BANNERS) {
        return;
      }
      bannerChannelIds = _.keys(widgets.TimelineBanner.BANNERS);
      recoubedChannelIds = _.map(coub.promo_winner_recoubers, function(m) {
        return m[0].toString();
      });
      return _.find(bannerChannelIds, function(bannerId) {
        return recoubedChannelIds.indexOf(bannerId) !== -1;
      });
    };

    return TimelineBanner;

  })();

}).call(this);
(function() {
  channels.AttachedChannelPopup = (function() {
    function AttachedChannelPopup() {}

    AttachedChannelPopup.ATTACHED_CHANNEL_KEY = "attached_channel";

    AttachedChannelPopup.show = function() {
      var channel, cont, key, modal, template;
      key = channels.AttachedChannelPopup.ATTACHED_CHANNEL_KEY;
      channel = ChannelsDataProvider.findInParamsById($.storage.get(key).channelId);
      template = JST["app/site/templates/channels/channel_create_popup/attached_channel_page"](channel);
      modal = ModalPopup.show({
        content: template,
        type: 'simple',
        classes: 'modal--attached-channel'
      });
      cont = modal.get();
      $('.sb.-blue', cont).on('click', modal.popup.close);
      return $.storage.del(key);
    };

    return AttachedChannelPopup;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  channels.CreateChannelPopup = (function() {
    CreateChannelPopup.ATTR_NAME = "widget-create-channel-popup";

    CreateChannelPopup.PAGES_ID = {
      CREATE: 'create-channel',
      LINK: 'link-account'
    };

    CreateChannelPopup.DIALOG_PAGES = {
      create: "app/site/templates/channels/channel_create_popup/create_channel_page",
      link: "app/site/templates/channels/channel_create_popup/link_account_page"
    };

    function CreateChannelPopup(el) {
      this.el = el;
      this.resetForm = bind(this.resetForm, this);
      this.placeError = bind(this.placeError, this);
      this.hideLoader = bind(this.hideLoader, this);
      this.showLoader = bind(this.showLoader, this);
      this.initAndShow = bind(this.initAndShow, this);
      this.el.on('click', (function(_this) {
        return function() {
          _this.el.parents('.dropdown').trigger('hide');
          return MultipageDialog.constructClientDialog({
            pages: channels.CreateChannelPopup.DIALOG_PAGES,
            mClass: 'modal--create-channel',
            constructed: function(cont, dialog) {
              return _this.initAndShow(cont, dialog);
            }
          });
        };
      })(this));
    }

    CreateChannelPopup.prototype.initAndShow = function(cont, dialog) {
      var handler, i, inputs, len, ref;
      inputs = $('.input-field-group', cont);
      cont.find('#channel_title').focus();
      ref = [channels.CreateChannelHandler, channels.LinkAccountHandler];
      for (i = 0, len = ref.length; i < len; i++) {
        handler = ref[i];
        chms.utils.Autoinit.init(handler, cont);
      }
      $('[close-popup]', cont).on('click', function() {
        return cont.trigger(Popup.ACTION_CLOSE);
      });
      return $('[link-page-move]', cont).on('click', (function(_this) {
        return function() {
          _this.resetForm(inputs);
          return dialog.moveToPageById(channels.CreateChannelPopup.PAGES_ID.LINK);
        };
      })(this));
    };

    CreateChannelPopup.prototype.showLoader = function(cont) {
      return LoadRotator.appendWithOverlayAndStart(cont);
    };

    CreateChannelPopup.prototype.hideLoader = function(cont) {
      return LoadRotator.removeWithOverlay(cont);
    };

    CreateChannelPopup.prototype.placeError = function(inputs, element, msg) {
      var getLabel, name;
      name = $(element).attr('name') != null ? $(element).attr('name') : '';
      getLabel = (function(_this) {
        return function(msg) {
          return " <label for='" + name + "'>" + msg + "</label> ";
        };
      })(this);
      this.resetForm(inputs);
      $(element).addClass('error');
      return inputs.next().show().html(getLabel(msg));
    };

    CreateChannelPopup.prototype.resetForm = function(inputs) {
      return inputs.each(function() {
        return $(this).removeClass('error').find('input[type=text], input[type=password]').removeClass('error').end().next().hide().html('');
      });
    };

    return CreateChannelPopup;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  channels.CreateChannelHandler = (function(superClass) {
    extend(CreateChannelHandler, superClass);

    CreateChannelHandler.ATTR_NAME = 'create-channel-page';

    CreateChannelHandler.prototype.GUIDE_STORAGE_KEY = "profile_tooltips";

    function CreateChannelHandler(el) {
      this.el = el;
      this.getPermalinkInput = bind(this.getPermalinkInput, this);
      this.getTitleInput = bind(this.getTitleInput, this);
      this.createChannel = bind(this.createChannel, this);
      this.provider = new dataProviders.ApiV2;
      this.form = $('form', this.el);
      this.inputs = $('.input-field-group', this.el);
      chms.utils.Autoinit.init(widgets.transliteration.DependentInputs, this.form);
      $.validator.addMethod("permalink_regexp", function(value, element) {
        var structureRegexp;
        structureRegexp = /^[a-zA-Z\-0-9\.]*$/;
        if (value.match(structureRegexp)) {
          return true;
        } else {
          return false;
        }
      }, I18n.PROFILE.ERRORS.PERMALINK_INVALID);
      $.validator.addMethod("forbidden_permalink", function(value, element) {
        var forbiddenRegexp;
        forbiddenRegexp = /^(?:test\b\.*)|(?:coubs\.(?:html|json))$/;
        if (value.match(forbiddenRegexp)) {
          return false;
        } else {
          return true;
        }
      }, I18n.PROFILE.ERRORS.PERMALINK_UNAVAILABLE);
      $.validator.addMethod("ends_with_dot", function(value, element) {
        var forbiddenDotRegexp;
        forbiddenDotRegexp = /\.$/;
        if (value.match(forbiddenDotRegexp)) {
          return false;
        } else {
          return true;
        }
      }, I18n.PROFILE.ERRORS.PERMALINK_ENDS_WITH_DOT);
      this.form.validate({
        success: "valid",
        rules: {
          "channel[title]": {
            required: true
          },
          "channel[permalink]": {
            required: true,
            permalink_regexp: true,
            forbidden_permalink: true,
            ends_with_dot: true,
            minlength: 8,
            remote: {
              url: "/api/v2/channels/validate_permalink",
              type: "GET",
              data: {},
              dataFilter: (function(_this) {
                return function(r) {
                  var resp;
                  resp = JSON.parse(r);
                  switch (resp.result) {
                    case 'taken':
                      return JSON.stringify(false);
                    case 'free':
                      return JSON.stringify(true);
                  }
                };
              })(this)
            }
          }
        },
        submitHandler: (function(_this) {
          return function(form) {
            return _this.createChannel(form);
          };
        })(this),
        showErrors: (function(_this) {
          return function(map, list) {
            if (list.length > 1) {
              return _this.placeError(_this.inputs, _this.inputs, I18n.t('profile.errors.empty_fields'));
            } else if (list.length === 1) {
              return _this.placeError(_this.inputs, list[0].element, list[0].message);
            } else {
              return _this.resetForm(_this.inputs);
            }
          };
        })(this),
        onkeyup: false,
        onfocusout: false,
        messages: {
          "channel[title]": {
            required: I18n.t('profile.errors.title_is_required')
          },
          "channel[permalink]": {
            required: I18n.t('profile.errors.permalink_is_required'),
            minlength: I18n.t('profile.errors.permalink_too_short'),
            remote: I18n.t('profile.errors.permalink_unavailable')
          }
        }
      });
    }

    CreateChannelHandler.prototype.createChannel = function(form) {
      this.showLoader(this.el);
      return this.provider.createChannel(this.getTitleInput().val(), this.getPermalinkInput().val(), {
        success: (function(_this) {
          return function(r) {
            window.location.replace(r.redirect_url);
            return $.storage.del(_this.GUIDE_STORAGE_KEY);
          };
        })(this),
        error: (function(_this) {
          return function() {
            _this.hideLoader(_this.el);
            return ErrorMessages.internalServerError();
          };
        })(this)
      });
    };

    CreateChannelHandler.prototype.getTitleInput = function() {
      return $("input[name='channel[title]']", this.el);
    };

    CreateChannelHandler.prototype.getPermalinkInput = function() {
      return $("input[name='channel[permalink]']", this.el);
    };

    return CreateChannelHandler;

  })(channels.CreateChannelPopup);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  channels.LinkAccountHandler = (function(superClass) {
    extend(LinkAccountHandler, superClass);

    LinkAccountHandler.ATTR_NAME = 'link-account-page';

    LinkAccountHandler.prototype.ATTACHED_CHANNEL_KEY = "attached_channel";

    function LinkAccountHandler(el) {
      this.el = el;
      this.getPasswordInput = bind(this.getPasswordInput, this);
      this.getEmailInput = bind(this.getEmailInput, this);
      this.linkAccount = bind(this.linkAccount, this);
      this.provider = new dataProviders.ApiV2();
      this.form = $('form', this.el);
      this.inputs = $('.input-field-group', this.form);
      $.validator.addMethod("email_regexp", function(value, element) {
        var structureRegexp;
        structureRegexp = CoubEnvironment.USER.EMAIL_REGEXP;
        if (value.match(structureRegexp)) {
          return true;
        } else {
          return false;
        }
      }, I18n.t('profile.errors.email_is_invalid'));
      this.form.validate({
        sussess: 'valid',
        rules: {
          password: {
            required: true
          },
          email: {
            required: true,
            email_regexp: true
          }
        },
        errorLabelContainer: $('.input-field-group'),
        showErrors: (function(_this) {
          return function(map, list) {
            if (list.length > 1) {
              return _this.placeError(_this.inputs, _this.inputs, I18n.t('profile.errors.empty_fields'));
            } else if (list.length === 1) {
              return _this.placeError(_this.inputs, list[0].element, list[0].message);
            } else {
              return _this.resetForm(_this.inputs);
            }
          };
        })(this),
        submitHandler: (function(_this) {
          return function(form) {
            return _this.linkAccount(form);
          };
        })(this),
        onkeyup: false,
        onfocusout: false,
        messages: {
          email: I18n.t('profile.errors.email_is_invalid'),
          password: I18n.t('profile.errors.password_incorrect')
        }
      });
      this.form.on('submit', (function(_this) {
        return function(e) {
          e.stopPropagation();
          return e.preventDefault();
        };
      })(this));
    }

    LinkAccountHandler.prototype.linkAccount = function(form) {
      var data;
      this.showLoader(this.el);
      data = {
        email: this.getEmailInput().val(),
        password: this.getPasswordInput().val()
      };
      return $.put(Routes.reattach_channels_api_v2_users_path(), data).done((function(_this) {
        return function(resp) {
          var channelId, userId;
          channelId = resp.channel.id;
          userId = Params.getBranchValue("current_user.id");
          $.storage.set(_this.ATTACHED_CHANNEL_KEY, {
            channelId: channelId,
            userId: userId
          });
          return window.location.replace(resp.redirect);
        };
      })(this)).fail((function(_this) {
        return function(resp) {
          switch (resp.status) {
            case 401:
              _this.placeError(_this.inputs, _this.inputs, I18n.t('profile.errors.auth_error'));
              break;
            case 404:
              _this.placeError(_this.inputs, _this.inputs, I18n.t('profile.errors.not_found'));
              break;
            default:
              _this.resetForm(_this.inputs);
              ErrorMessages.internalServerError();
          }
          return _this.hideLoader(_this.el);
        };
      })(this));
    };

    LinkAccountHandler.prototype.getEmailInput = function() {
      return $('input[name=email]', this.el);
    };

    LinkAccountHandler.prototype.getPasswordInput = function() {
      return $('input[name=password]', this.el);
    };

    return LinkAccountHandler;

  })(channels.CreateChannelPopup);

}).call(this);

/*
  Виджет для копирования текста в буфер
  На элементе должен быть атрибут data-clipboard-text с текстом, который мы хотим скопировать
 */

(function() {
  widgets.CopyLinkToClipboard = (function() {
    CopyLinkToClipboard.ATTR_NAME = "widget-copy-link";

    CopyLinkToClipboard.ACTION = "link:copied";

    function CopyLinkToClipboard(el) {
      this.el = el;
      this.original_text = this.el.find('span').text();
      this.initClipboard();
    }

    CopyLinkToClipboard.prototype.initClipboard = function() {
      if (!this.isCopySupported()) {
        this.el.addClass('-hidden');
        return;
      }
      return this.el.click((function(_this) {
        return function() {
          var $input;
          $input = $('<input type="text" />');
          $input.appendTo(_this.el).val(_this.el.attr('data-clipboard-text')).select();
          if (document.execCommand('copy')) {
            _this.copied();
          } else {
            _this.failed();
          }
          return $input.remove();
        };
      })(this));
    };

    CopyLinkToClipboard.prototype.copied = function() {
      this.el.addClass('copy-link--success');
      return this.changeText(I18n.embed.copy_link.copied);
    };

    CopyLinkToClipboard.prototype.failed = function() {
      this.el.addClass('copy-link--failed');
      return this.changeText(I18n.embed.copy_link.failed_to_copy);
    };

    CopyLinkToClipboard.prototype.changeText = function(val) {
      var $indicator, setOriginalText;
      clearTimeout(this.changeTimeout);
      $indicator = this.el.find('span');
      $indicator.text(val);
      this.el.trigger(widgets.CopyLinkToClipboard.ACTION);
      setOriginalText = (function(_this) {
        return function() {
          _this.el.removeClass('copy-link--failed copy-link--success');
          return $indicator.text(_this.original_text);
        };
      })(this);
      return this.changeTimeout = setTimeout(setOriginalText, 1000);
    };

    CopyLinkToClipboard.prototype.isCopySupported = function() {
      if (this._cacheCopySupported != null) {
        return this._cacheCopySupported;
      } else {
        return widgets.CopyLinkToClipboard.prototype._cacheCopySupported = document.queryCommandSupported && document.queryCommandSupported('copy');
      }
    };

    return CopyLinkToClipboard;

  })();

}).call(this);
(function() {
  $.Controller("CoubAbuseDropdown", {
    "li.list__item click": function(e) {
      if (!(e.hasClass("disabled"))) {
        return this.prepareAbuseClaim(e);
      }
    },
    init: function() {
      this.abuseDropdownHandle = $('.dropdown__handler', this.element);
      this.abuseReasons = $('[coub-abuses]', this.element);
      this.abuseTextForm = $('.flag__form', this.element);
      this.textField = $("textarea", this.element);
      this.closeButton = $('.sb.close-other', this.abuseTextForm);
      this.reason = $("li.list__item", this.element);
      this.provider = new dataProviders.ApiV2();
      this.closeButton.bind("click", (function(_this) {
        return function() {
          return _this.hideAbuseTextForm();
        };
      })(this));
      this.element.bind("abuse_form:is_shown", (function(_this) {
        return function() {
          return _this.textField.bind("keydown", function() {
            return _this.textField.removeClass("error");
          });
        };
      })(this));
      return this.element.bind("abuse_form:is_hidden", (function(_this) {
        return function() {
          return _this.textField.unbind("keydown");
        };
      })(this));
    },
    prepareAbuseClaim: function(e) {
      var data;
      this.reason.addClass("disabled");
      data = {
        reason: e.attr('data-reason'),
        entity_id: this.abuseReasons.attr('data-for-coub-id'),
        entity_type: "Coub"
      };
      if (e.hasClass("-on")) {
        return this.deleteAbuseClaim(data, e);
      } else if (e.hasClass("other")) {
        return this.showAbuseTextForm(data, e);
      } else {
        return this.sendAbuseClaim(data, e);
      }
    },
    showAbuseTextForm: function(data, e) {
      this.abuseTextForm.show();
      this.element.trigger("abuse_form:is_shown");
      this.textField.val("");
      this.textField.focus();
      return $(".send-claim", this.abuseTextForm).bind("click", (function(_this) {
        return function() {
          var abuseText;
          abuseText = _this.textField.val();
          if ($.trim(abuseText) !== '') {
            data.claim_text = $("textarea", _this.element).val();
            return _this.sendAbuseClaim(data, e);
          } else {
            _this.textField.addClass("error");
            return Growl.msg("Flag", "Your complaint is empty. Please describe the reason that reflects your concern about this coub.");
          }
        };
      })(this));
    },
    hideAbuseTextForm: function() {
      this.abuseTextForm.hide();
      this.textField.removeClass("error");
      this.reason.removeClass("disabled");
      $(".send-claim", this.abuseTextForm).unbind("click");
      return this.element.trigger("abuse_form:is_hidden");
    },
    sendAbuseClaim: function(data, e) {
      var reason;
      reason = $(e);
      reason.addClass("-on");
      return this.provider.sendAbuseClaim(data, {
        success: (function(_this) {
          return function(d) {
            _this.reason.removeClass("disabled");
            if (reason.hasClass("other")) {
              _this.hideAbuseTextForm();
            }
            reason.attr('data-abuse-id', d.abuse_id);
            return _this.toggleAbuseHighlight();
          };
        })(this),
        error: (function(_this) {
          return function() {
            reason.removeClass("-on");
            _this.reason.removeClass("disabled");
            return Growl.msg("Flag", "Error occured while sending your complaint. Please try again later.");
          };
        })(this)
      });
    },
    deleteAbuseClaim: function(data, e) {
      var abuseId, reason;
      reason = $(e);
      abuseId = reason.attr('data-abuse-id');
      reason.removeClass("-on");
      return this.provider.deleteAbuseClaim(abuseId, {
        success: (function(_this) {
          return function() {
            _this.reason.removeClass("disabled");
            return _this.toggleAbuseHighlight();
          };
        })(this),
        error: (function(_this) {
          return function() {
            reason.addClass("-on");
            _this.reason.removeClass("disabled");
            return Growl.msg("Flag", "Error occured while deleting your complaint. Please try again later.");
          };
        })(this)
      });
    },
    toggleAbuseHighlight: function() {
      if (!this.reason.hasClass("-on")) {
        return this.abuseDropdownHandle.removeClass("-highlight");
      } else if (this.reason.hasClass("-on") && !this.abuseDropdownHandle.hasClass("-highlight")) {
        return this.abuseDropdownHandle.addClass("-highlight");
      }
    }
  });

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.AbstractControlable = (function() {
    AbstractControlable.ACTION_UNLISTEN = "AbstractControlable:Actions:Unlisten";

    AbstractControlable.ACTION_LISTEN = "AbstractControlable:Actions:Listen";

    function AbstractControlable(opts) {
      if (opts == null) {
        opts = {};
      }
      this.onKeydown = bind(this.onKeydown, this);
      this.unlisten = bind(this.unlisten, this);
      this.listen = bind(this.listen, this);
      this.getListenEl = bind(this.getListenEl, this);
      this.el = this.$el = $(opts.el);
      $(this.el).on(AbstractControlable.ACTION_LISTEN, this.listen);
      $(this.el).on(AbstractControlable.ACTION_UNLISTEN, this.unlisten);
      this.isListening = false;
    }

    AbstractControlable.prototype.getListenEl = function() {
      if (this.listenOn != null) {
        return this.listenOn;
      } else {
        return $(document);
      }
    };

    AbstractControlable.prototype.listen = function() {
      if (!this.isListening) {
        this.getListenEl().on("keydown", this.onKeydown);
        return this.isListening = true;
      }
    };

    AbstractControlable.prototype.unlisten = function() {
      if (this.isListening) {
        this.getListenEl().off("keydown", this.onKeydown);
        return this.isListening = false;
      }
    };

    AbstractControlable.prototype.onKeydown = function(e) {
      return e.preventDefault();
    };

    return AbstractControlable;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.Popup = (function(superClass) {
    extend(Popup, superClass);

    Popup.EVENT_SHOWED = "AbstractModalPopup:Showed";

    Popup.EVENT_HIDED = "AbstractModalPopup:Hided";

    Popup.ACTION_CLOSE = "AbstractModalPopup:CLOSE";

    function Popup(opts) {
      if (opts == null) {
        opts = {};
      }
      this.setContent = bind(this.setContent, this);
      this.onFullScreenChange = bind(this.onFullScreenChange, this);
      this.isVisible = bind(this.isVisible, this);
      this.onKeydown = bind(this.onKeydown, this);
      this.afterClose = bind(this.afterClose, this);
      this.close = bind(this.close, this);
      this.afterShow = bind(this.afterShow, this);
      this.show = bind(this.show, this);
      Popup.__super__.constructor.apply(this, arguments);
      this.removeOnClose = opts.removeOnClose;
      $(this.el).find(".modal__close, [popup-close]").bind("click", this.close);
      $(this.el).find(".modal__background").bind("click", (function(_this) {
        return function() {
          if (!$(_this.el).hasClass('modal--disabled')) {
            return _this.close();
          }
        };
      })(this));
      $(this.el).on(Popup.ACTION_CLOSE, this.close);
    }

    Popup.prototype.SHOW_TIME = 300;

    Popup.prototype.show = function() {
      this.savedTop = $(window).scrollTop();
      $(document).on('fullscreenchange', this.onFullScreenChange);
      $("body").addClass("disable-scroll");
      return $(this.el).addClass("-visible").fadeIn(this.SHOW_TIME, this.afterShow);
    };

    Popup.prototype.afterShow = function() {
      this.listen();
      return $(this.el).trigger(Popup.EVENT_SHOWED);
    };

    Popup.prototype.CLOSE_TIME = 300;

    Popup.prototype.close = function() {
      $(document).off('fullscreenchange', this.onFullScreenChange);
      $("body").removeClass("disable-scroll");
      return $(this.el).fadeOut(this.CLOSE_TIME, this.afterClose);
    };

    Popup.prototype.afterClose = function() {
      $(this.el).removeClass("-visible");
      this.unlisten();
      $(this.el).trigger(Popup.EVENT_HIDED);
      if (this.removeOnClose) {
        return $(this.el).remove();
      }
    };

    Popup.prototype.onKeydown = function(e) {
      if (e.keyCode === Utils.KEY_CODES.ESC && !$(this.el).hasClass('modal--disabled')) {
        return this.close();
      }
    };

    Popup.prototype.isVisible = function() {
      return $(this.el).is(":visible");
    };

    Popup.prototype.onFullScreenChange = function() {
      if (helpers.Location.isFullScreen()) {
        return;
      }
      return $(window).scrollTop(this.savedTop);
    };

    Popup.prototype.setContent = function(html) {
      return $('.modal__body', this.el).html(html);
    };

    Popup.initOnBody = function() {
      return $("body .modalPopup").each(function() {
        return new AbstractModalPopup({
          el: $(this)
        });
      });
    };

    return Popup;

  })(AbstractControlable);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.CategoriesPopup = (function(superClass) {
    extend(CategoriesPopup, superClass);

    function CategoriesPopup(el, coubId) {
      this.el = el;
      this.coubId = coubId;
      this.afterClose = bind(this.afterClose, this);
      this.afterShow = bind(this.afterShow, this);
      this.categoriesSelector = new widgets.CategoriesSelector(this.el);
      this.categoriesSelector.on('selected', this.setHeading.bind(this));
      $('form', this.el).submit(this.submit.bind(this));
      this.setHeading();
    }

    CategoriesPopup.prototype.setHeading = function() {
      var title;
      title = I18n.t('customize_popup.select_categories', {
        count: this.categoriesSelector.getSelected().length
      });
      return $('h1', this.el).text(title);
    };

    CategoriesPopup.prototype.submit = function(e) {
      e.preventDefault();
      return $.post(Routes.set_categories_coub_path(this.coubId), {
        categories: this.categoriesSelector.getSelected()
      }).done((function(_this) {
        return function() {
          _this.close();
          return Growl.succ(I18n.CUSTOMIZE_POPUP.SIMPLE_EDIT.MESSAGE_AFTER_SAVE.HEADER, I18n.CUSTOMIZE_POPUP.SIMPLE_EDIT.MESSAGE_AFTER_SAVE.MESSAGE);
        };
      })(this)).fail((function(_this) {
        return function() {
          ErrorMessages.internalServerError();
          return _this.close();
        };
      })(this));
    };

    CategoriesPopup.prototype.cancel = function() {
      return this.close();
    };

    CategoriesPopup.prototype.afterShow = function() {
      CategoriesPopup.__super__.afterShow.apply(this, arguments);
      return $(document).trigger("flash_player:mute");
    };

    CategoriesPopup.prototype.afterClose = function() {
      CategoriesPopup.__super__.afterClose.apply(this, arguments);
      return $(document).trigger("flash_player:unmute");
    };

    return CategoriesPopup;

  })(Popup);

}).call(this);
(function() {
  window.CoubSharingControlsBlock = {
    init: function($el) {
      CustomSharingButton.constructIn($el);
      return $("[coub-embed-popup]", $el).on("click", this.showEmbedPopup);
    },
    showEmbedPopup: function(e) {
      var $button, id;
      $button = $(e.currentTarget);
      id = $button.attr("data-coub-id");
      return ModalPopup.constructPopup({
        classes: 'modal--share-popup',
        constructed: function(cont, modal) {
          cont.addClass('modal--loading');
          LoadRotator.appendToContainterAndStart(modal.getContentContainer());
          return new dataProviders.ApiV2().getEmbedShareData(id, {
            success: function(coub) {
              var $viewer, temp;
              $viewer = $button.closest('.coub').find('.viewer');
              $viewer.trigger('suspend');
              $(document).one(Popup.EVENT_HIDED, function() {
                return $viewer.trigger('play');
              });
              temp = JST["app/site/templates/coub_block/popups/share_coub_popup"](coub);
              modal.setContent(temp);
              return cont.share_popup_contents();
            },
            error: function() {
              modal.close();
              return ErrorMessages.internalServerError();
            },
            complete: function() {
              return cont.removeClass('modal--loading');
            }
          });
        }
      });
    },
    construct: function(coubBlock) {
      if (!coubBlock || !coubBlock.length) {
        throw "CoubSharingControlsBlock: please pass coubBlock as an argument";
      }
      return $(".coub__sharing", coubBlock).each(function() {
        return CoubSharingControlsBlock.init($(this));
      });
    }
  };

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.CoubBlockClientside = (function() {
    CoubBlockClientside.ACTION_AUTOLIKE = "CoubBlock:Actions:Like";

    CoubBlockClientside.ACTION_AUTORECOUB = "CoubBlock:Actions:Recoub";

    CoubBlockClientside.ACTION_RELOAD = "CoubBlock:Actions:Reload";

    CoubBlockClientside.ACTION_UPDATE_CARD_TYPE = "CoubBlockClientside:Actions:UpdateCardType";

    CoubBlockClientside.ACTION_DELETE = "CoubBlock:Actions:Delete";

    CoubBlockClientside.ACTION_SHOW_LIKE_PANEL = "CoubBlockClientside:Actions:ShowLikePanel";

    CoubBlockClientside.EVENT_RELOAD_COMPLETE = "CoubBlock:Reloaded";

    CoubBlockClientside.ATTR_PLAY_STATE = "play-state";

    CoubBlockClientside.PLAY_STATE_PLAYING = "playing";

    CoubBlockClientside.PLAY_STATE_PAUSED = "paused";

    CoubBlockClientside.ACTION_HIDE_DROPDOWN = "CoubBlockClientside:Actions:HideDropdown";

    CoubBlockClientside.EVENT_CARD_STATUS_UPDATED = "CoubBlockClientside:CardStatusUpdated";

    CoubBlockClientside.prototype.DT = "CoubBlockClientside";

    function CoubBlockClientside(opts) {
      this.initializeEditorWidgets = bind(this.initializeEditorWidgets, this);
      this.initializeWidgets = bind(this.initializeWidgets, this);
      this.showLikePanel = bind(this.showLikePanel, this);
      this.showEditCoubPopup = bind(this.showEditCoubPopup, this);
      this.showCategoriesPopup = bind(this.showCategoriesPopup, this);
      this.showEditorialPopup = bind(this.showEditorialPopup, this);
      this.getRecoubButton = bind(this.getRecoubButton, this);
      this.getLikeButton = bind(this.getLikeButton, this);
      this.getViewerBlock = bind(this.getViewerBlock, this);
      this.execSocialAction = bind(this.execSocialAction, this);
      this.getCurrentCardStatus = bind(this.getCurrentCardStatus, this);
      this.setCurrentCardStatus = bind(this.setCurrentCardStatus, this);
      this.renderCardTypeView = bind(this.renderCardTypeView, this);
      this.reload = bind(this.reload, this);
      this.onPlayStateChanged = bind(this.onPlayStateChanged, this);
      this.initChannelDropdown = bind(this.initChannelDropdown, this);
      this.initTimelineBanner = bind(this.initTimelineBanner, this);
      this.initFullscreenChanger = bind(this.initFullscreenChanger, this);
      this.actionDeleteHandler = bind(this.actionDeleteHandler, this);
      this.suspendOnLinkOpen = bind(this.suspendOnLinkOpen, this);
      var json, jsonString;
      this.s = this.constructor;
      this.playerOpts = opts.playerOpts || {};
      this.CARD_TYPES = blocks.coub.CardTypes.types;
      this.changerOpts = opts.changerOpts;
      this.el = $(opts.el);
      this.permalink = this.el.attr("data-permalink");
      this.resources = JSON.parse($("resources json", this.el).attr("value"));
      this.provider = new dataProviders.ApiV2();
      jsonString = $('.data.-hidden', this.el).text();
      if (jsonString.length) {
        json = JSON.parse(jsonString);
        this.initialRenderProps = json.render;
      }
      this.initializeWidgets();
      this.initializeEditorWidgets(this.el.closest('.editorial-container'));
      this.getCurrentCardType();
      this.el.on(CoubBlockClientside.ACTION_AUTOLIKE, (function(_this) {
        return function() {
          return _this.execSocialAction(CoubBlockClientside.ACTION_AUTOLIKE);
        };
      })(this)).on(CoubBlockClientside.ACTION_AUTORECOUB, (function(_this) {
        return function() {
          return _this.execSocialAction(CoubBlockClientside.ACTION_AUTORECOUB);
        };
      })(this)).on(CoubBlockClientside.ACTION_RELOAD, this.reload).on(CoubBlockClientside.ACTION_UPDATE_CARD_TYPE, (function(_this) {
        return function(e) {
          return _this.renderCardTypeView(e.cardType);
        };
      })(this)).on(CoubBlockClientside.ACTION_SHOW_LIKE_PANEL, this.showLikePanel);
      $(document).on(CoubBlockClientside.ACTION_DELETE, this.actionDeleteHandler);
      $(document).on("click", "a[target='_blank']:not([type='embedPopup'])", this.suspendOnLinkOpen);
      $('[widget-copy-link]', this.el).on(widgets.CopyLinkToClipboard.ACTION, (function(_this) {
        return function() {
          return Stats.track("copy_link_clicked");
        };
      })(this));
      this.initChannelDropdown();
      this.initTimelineBanner();
      this.initFullscreenChanger();
      this.getViewerBlock().on([Player.EVENT_PLAYING, Player.EVENT_PAUSED].join(' '), this.onPlayStateChanged).on("keyup", this.onKeyUp.bind(this));
      this.el.on('dom_remove', (function(_this) {
        return function() {
          $(document).off(CoubBlockClientside.ACTION_DELETE, _this.actionDeleteHandler);
          return $(document).off("click", "a[target='_blank']:not([type='embedPopup'])", _this.suspendOnLinkOpen);
        };
      })(this));
    }

    CoubBlockClientside.prototype.suspendOnLinkOpen = function(e) {
      if (!e.metaKey) {
        return this.getViewerBlock().trigger("suspend");
      }
    };

    CoubBlockClientside.prototype.actionDeleteHandler = function(e, p) {
      if (this.permalink !== p) {
        return;
      }
      this.getViewerBlock().trigger("unembed");
      return this.el.removeAttr('coub-block').slideUp(function() {
        return $(this).remove();
      });
    };

    CoubBlockClientside.prototype.initFullscreenChanger = function() {
      if (!GlobalState.PAGE.isCoubPage()) {
        return this.changer = new TimelineFullscreenChanger(this.el, this.changerOpts);
      }
    };

    CoubBlockClientside.prototype.initTimelineBanner = function() {
      var b;
      if (this.getCurrentCardType() === this.CARD_TYPES.normal) {
        b = $('.coub__banner-timeline', this.el);
        if (b.length > 0) {
          return this.timeline_banner = new widgets.TimelineBanner(b, this.getViewerBlock());
        }
      }
    };

    CoubBlockClientside.prototype.initChannelDropdown = function() {
      return chms.utils.Autoinit.init(widgets.ChannelDropdown, this.el);
    };

    CoubBlockClientside.prototype.onKeyUp = function(e) {
      if (e.which !== 76) {
        return;
      }
      return this.getLikeButton().triggerHandler(widgets.LikeButton.ACTIONS.TOGGLE_LIKE);
    };

    CoubBlockClientside.prototype.onPlayStateChanged = function(e) {
      if (e.type === Player.EVENT_PLAYING) {
        this.el.attr(this.s.ATTR_PLAY_STATE, this.s.PLAY_STATE_PLAYING);
      } else {
        this.el.attr(this.s.ATTR_PLAY_STATE, this.s.PLAY_STATE_PAUSED);
      }
      return $('.dropdown-info', this.el).trigger('hide');
    };

    CoubBlockClientside.prototype.reload = function(e, json) {
      var complete, render;
      if (json == null) {
        json = null;
      }
      if (!this.provider) {
        this.provider = new dataProviders.ApiV2();
      }
      complete = (function(_this) {
        return function(cb, preventAutoplay) {
          $(document).trigger({
            type: CoubBlockClientside.EVENT_RELOAD_COMPLETE,
            cb: cb
          });
          if (!preventAutoplay) {
            return cb.getViewerBlock().trigger('play');
          }
        };
      })(this);
      render = (function(_this) {
        return function(r) {
          var el, preventAutoplay, rendered;
          if (GlobalState.PAGE.isCoubPage()) {
            r.render = {
              'card-type': 'page'
            };
          } else {
            r.render = {
              'card-type': _this.getCurrentCardType().name
            };
          }
          if (_this.initialRenderProps) {
            r.render = $.extend(r.render, _this.initialRenderProps);
          }
          rendered = $(JST["app/site/templates/coub_block/coub"](r));
          _this.el.replaceWith(rendered);
          if (rendered.attr("coub-block") != null) {
            el = rendered;
          } else {
            el = rendered.find("[coub-block]");
          }
          preventAutoplay = r.render['prevent-autoplay-on-reload'];
          return complete(new CoubBlockClientside({
            el: el
          }), preventAutoplay);
        };
      })(this);
      if (json != null) {
        return render(json);
      } else {
        return this.provider.getCoub(this.permalink, {
          success: (function(_this) {
            return function(r) {
              return render(r);
            };
          })(this),
          error: (function(_this) {
            return function() {
              return window.location.reload();
            };
          })(this)
        });
      }
    };

    CoubBlockClientside.prototype.renderCardTypeView = function(view) {
      var classes;
      if (this.getCurrentCardType() === view) {
        return;
      }
      switch (view) {
        case this.CARD_TYPES.normal:
          if (this.timeline_banner != null) {
            this.timeline_banner.show();
          }
          break;
        case this.CARD_TYPES.small:
          if (this.timeline_banner != null) {
            this.timeline_banner.hide();
          }
          break;
        default:
          throw "CoubBlockClientside: unknown card type " + view;
      }
      classes = this.el.attr("class");
      this.el.attr("class", classes.replace(/\w+-card/g, blocks.coub.CardTypes.getClassName(view)));
      this.setCurrentCardType(view);
      this.el.trigger(TagsBlock.ACTION_UPDATE_LAYOUT);
      return this.getViewerBlock().triggerHandler('resize');
    };

    CoubBlockClientside.prototype.setCurrentCardType = function(cardType) {
      this.currentCardType = cardType;
      return this.el.attr("card-type", cardType.name);
    };

    CoubBlockClientside.prototype.getCurrentCardType = function() {
      var ct;
      if (this.currentCardType == null) {
        if ((ct = this.el.attr("card-type")) != null) {
          this.currentCardType = blocks.coub.CardTypes.types[ct];
        } else {
          this.setCurrentCardType(blocks.coub.CardTypes.getDefaultCardType());
        }
      }
      return this.currentCardType;
    };

    CoubBlockClientside.prototype.setCurrentCardStatus = function(cardStatus) {
      var oldStatus;
      oldStatus = this.getCurrentCardStatus();
      this.currentCardStatus = cardStatus;
      this.el.attr("card-status", cardStatus.name);
      return this.el.trigger({
        type: CoubBlockClientside.EVENT_CARD_STATUS_UPDATED,
        from: oldStatus,
        to: this.currentCardStatus,
        block: this
      });
    };

    CoubBlockClientside.prototype.getCurrentCardStatus = function() {
      var v;
      if (this.currentCardStatus == null) {
        if ((v = this.el.attr("card-status"))) {
          this.currentCardStatus = blocks.coub.CardStatuses.statuses[v];
        } else {
          this.currentCardStatus = blocks.coub.CardStatuses.normal;
        }
      }
      return this.currentCardStatus;
    };

    CoubBlockClientside.prototype.execSocialAction = function(action) {
      var button, buttonAction;
      switch (action) {
        case CoubBlockClientside.ACTION_AUTOLIKE:
          button = this.getLikeButton();
          buttonAction = widgets.LikeButton.ACTIONS.AUTOLIKE;
          break;
        case CoubBlockClientside.ACTION_AUTORECOUB:
          button = this.getRecoubButton();
          buttonAction = widgets.RecoubButton.ACTIONS.AUTORECOUB;
          break;
        default:
          return false;
      }
      return button.trigger(buttonAction);
    };

    CoubBlockClientside.prototype.getViewerBlock = function() {
      return $('.viewer', this.el);
    };

    CoubBlockClientside.prototype.getLikeButton = function() {
      return $(".coub__like-button", this.el);
    };

    CoubBlockClientside.prototype.getRecoubButton = function() {
      return $(".coub__recoub-button", this.el);
    };

    CoubBlockClientside.prototype.showEditorialPopup = function(e) {
      return EditorialPopup.show(this.permalink);
    };

    CoubBlockClientside.prototype.showCategoriesPopup = function(e) {
      var modal;
      if ($(e.currentTarget).is('.disabled, [disabled]')) {
        return;
      }
      modal = ModalPopup.show({
        content: '',
        type: 'simple',
        classes: 'modal--edit-popup categories-screen'
      });
      if (!modal) {
        return;
      }
      LoadRotator.appendToContainterAndStart(modal.getContentContainer());
      return $.when(this.provider.getCoub(this.permalink), $.get(Routes.api_v2_categories_path())).done((function(_this) {
        return function(coub, categories) {
          var template;
          template = JST["app/site/templates/edit_coub_popup/categories_popup"]({
            all: categories[0].categories,
            selected: coub[0].categories
          });
          modal.setContent(template);
          return new CategoriesPopup(modal.get(), _this.permalink);
        };
      })(this)).fail(function() {
        modal.close();
        return ErrorMessages.internalServerError();
      });
    };

    CoubBlockClientside.prototype.showEditCoubPopup = function(e) {
      var modal;
      if ($(e.currentTarget).is('.disabled, [disabled]')) {
        return;
      }
      modal = ModalPopup.show({
        content: '',
        type: 'simple',
        classes: 'modal--edit-popup'
      });
      if (!modal) {
        return;
      }
      LoadRotator.appendToContainterAndStart(modal.getContentContainer());
      return this.provider.getCoub(this.permalink).done((function(_this) {
        return function(data) {
          var template;
          template = JST["app/site/templates/edit_coub_popup/edit_popup_body"](data);
          modal.setContent(template);
          return new EditCoubPopup({
            el: modal.get(),
            coubBlock: _this
          });
        };
      })(this)).fail(function() {
        modal.close();
        return ErrorMessages.internalServerError();
      });
    };

    CoubBlockClientside.prototype.showLikePanel = function() {
      var avatar, badge, cc, id, panel;
      if ($(".coub__like-banner", this.el).length) {
        return;
      }
      id = parseInt(Params.get("current_channel_id"));
      cc = ChannelsDataProvider.findInParamsById(id);
      avatar = helpers.Application.specificImgVersion(cc, 'avatar_versions', 'header');
      panel = $(JST["app/site/templates/widgets/after_action_panel/after_action_panel"]({
        userpic: avatar,
        name: cc.title
      }));
      this.getViewerBlock().append(panel);
      panel.find("img").on("load", function() {
        return setTimeout(function() {
          panel.addClass("-showed");
          return setTimeout(function() {
            panel.removeClass("-showed");
            return setTimeout((function() {
              return panel.remove();
            }), 300);
          }, 2000);
        }, 100);
      });
      badge = $(".viewer__best2019__like-action", this.el);
      badge.addClass("-showed");
      return setTimeout(function() {
        return badge.removeClass("-showed");
      }, 2000);
    };

    CoubBlockClientside.prototype.initializeWidgets = function() {
      var flagHandle, h, playerOpts;
      CoubSocialControlsBlock.construct(this.el);
      TagsBlock.construct(this.el);
      CoubSharingControlsBlock.construct(this.el);
      chms.utils.Autoinit.init(widgets.AvatarChangeListener, this.el);
      chms.utils.Autoinit.init(widgets.ListKeyNavigation, this.el);
      chms.utils.Autoinit.init(widgets.DownloadFile, this.el);
      chms.utils.Autoinit.init(widgets.CopyLinkToClipboard, this.el);
      chms.utils.Autoinit.init(widgets.DeleteCoubButton, this.el);
      chms.utils.Autoinit.init(widgets.WidgetListenerRecoub, this.el);
      chms.utils.Autoinit.init(widgets.DownloadCoubVideoButton, this.el);
      chms.utils.Autoinit.init(widgets.ShareCoubVideoButton, this.el);
      chms.utils.Autoinit.init(widgets.DownloadCoubLoopsButton, this.el);
      if ((flagHandle = $('[flag-coub-handle]', this.el)).length) {
        new FlagCoubDropdown({
          el: this.el,
          handle: flagHandle
        });
      }
      $('[like-points-coub-handle]', this.el).each((function(_this) {
        return function(i, el) {
          var $el;
          $el = $(el);
          return new CoubLikePointsDropdown({
            el: $el,
            handle: $el
          });
        };
      })(this));
      this.permalink = this.el.attr("data-permalink");
      $('[flag-coub-content]', this.el).coub_abuse_dropdown();
      if (this.getCurrentCardStatus().getHandler != null) {
        h = this.getCurrentCardStatus().getHandler();
        new h(this);
      }
      $(".dropdown, .m-dropdown", this.el).dropdown();
      $(".niceScroller", this.el).nice_scroller();
      playerOpts = $.extend({
        cardType: this.getCurrentCardType().name
      }, this.playerOpts);
      this.getViewerBlock().player(playerOpts);
      if (!GlobalState.PLATFORM.isMobile()) {
        $("[data-prompt]", this.el).prompt();
      }
      $("[open-edit-popup]", this.el).on("click", this.showEditCoubPopup);
      $("[open-categories-popup]", this.el).on("click", this.showCategoriesPopup);
      $('.open-moderation', this.el).on('click', this.showEditorialPopup);
      $('.sharing-picture', this.el).click((function(_this) {
        return function(e) {
          var $el, status;
          $el = $(e.currentTarget);
          status = $el.attr('data-status');
          if (status === 'add') {
            return $el.find('input').click();
          } else if (status === 'del') {
            return $.post(Routes.og_image_api_v2_coub_path(_this.permalink)).done(function() {
              $el.attr('data-status', 'add').find('.sharing-picture__status').html(I18n.t('coub.buttons.edit.add_sharing_picture'));
              return Growl.succ('Picture succesfully removed');
            }).fail(function() {
              return ErrorMessages.internalServerError();
            });
          }
        };
      })(this)).find('input').fileupload({
        add: (function(_this) {
          return function(e, data) {
            data.submit();
            return $('.sharing-picture', _this.el).attr('data-status', 'progress').find('.sharing-picture__status').html(I18n.t('coub.buttons.edit.in_progress_sharing_picture'));
          };
        })(this),
        done: (function(_this) {
          return function(e, data) {
            if (data.result.status === 'ok') {
              $('.sharing-picture', _this.el).attr('data-status', 'del').find('.sharing-picture__status').html(I18n.t('coub.buttons.edit.remove_sharing_picture'));
              return Growl.succ('Picture succesfully uploaded!');
            } else {
              $('.sharing-picture', _this.el).attr('data-status', 'add').find('.sharing-picture__status').html(I18n.t('coub.buttons.edit.add_sharing_picture'));
              return ErrorMessages.internalServerError();
            }
          };
        })(this),
        fail: (function(_this) {
          return function() {
            $('.sharing-picture', _this.el).attr('data-status', 'add').find('.sharing-picture__status').html(I18n.t('coub.buttons.edit.add_sharing_picture'));
            return ErrorMessages.internalServerError();
          };
        })(this)
      }).click(function(e) {
        return e.stopPropagation();
      });
      $('.copyCoub', this.el).click((function(_this) {
        return function() {
          if (_this.xhrCopyCoub) {
            _this.xhrCopyCoub.abort();
          }
          if (!confirm('Are you sure?')) {
            return;
          }
          _this.xhrCopyCoub = $.post(Routes.copy_api_v2_coub_path(_this.permalink));
          return _this.xhrCopyCoub.done(function() {
            return Growl.succ('Coub will be copied!');
          }).fail(function() {
            return ErrorMessages.internalServerError();
          });
        };
      })(this));
      if (!GlobalState.USER.isLogedIn()) {
        ToggleRegistration.construct($(this.el));
        return UnlogedActionHandler.construct($(this.el));
      }
    };

    CoubBlockClientside.prototype.initializeEditorWidgets = function(container) {
      var constructAbusesList, emc, type;
      if (Params.getBranchValue("current_user.is_editor") && GlobalState.PAGE.isTagPage()) {
        chms.utils.Autoinit.init(siteAdmin.moderation.DeleteCoubTagButton, this.el);
      }
      if ((emc = $("[editor-controls]", container)).length !== 0) {
        LoadRotator.appendToContainterAndStart(emc);
        constructAbusesList = (function(_this) {
          return function() {
            var abuses, placement;
            abuses = container.find($('[editor-abuses-list]'));
            if (abuses.length) {
              placement = container.find('[editor-abuses-list-placement]');
              placement.replaceWith(abuses.clone());
              return AbusesList.construct(container);
            }
          };
        })(this);
        return new dataProviders.ApiV2().getEditorControlsData(this.permalink, type = 'timeline', {
          success: (function(_this) {
            return function(resp) {
              var data, render_best2016_controls;
              render_best2016_controls = /type=best2016/.test(location.href);
              data = JST["app/site/templates/coub_block/editor_specific/editor_coub_controls"]({
                data: resp,
                type: type,
                best2016_controls: render_best2016_controls
              });
              emc.html(data);
              EditorCoubCatsAndFlagsMenu.construct(emc, _this.permalink);
              GlobalEditorButtons.construct(container);
              EditorTrendList.construct(container);
              constructAbusesList();
              chms.utils.Autoinit.init(EditorRecouber, container);
              chms.utils.Autoinit.init(EditorCategories, container);
              chms.utils.Autoinit.init(EditorBest2016Moderation, container);
              chms.utils.Autoinit.init(EditorCopyrightClaim, container);
              $(".dropdown, .m-dropdown", emc).dropdown();
              return $('.moderatedButton', emc).moderated_button();
            };
          })(this),
          error: (function(_this) {
            return function() {
              ErrorMessages.internalServerError;
              return LoadRotator.removeFromContainer(emc);
            };
          })(this)
        });
      }
    };

    CoubBlockClientside.constructFromContainer = function(container, opts, changerOpts) {
      return $('[coub-block]', container).each(function() {
        return new CoubBlockClientside({
          el: this,
          playerOpts: opts,
          changerOpts: changerOpts
        });
      });
    };

    CoubBlockClientside.isPlaying = function(block) {
      var v;
      if ((v = block.attr(CoubBlockClientside.ATTR_PLAY_STATE)) != null) {
        return v === CoubBlockClientside.PLAY_STATE_PLAYING;
      } else {
        return false;
      }
    };

    return CoubBlockClientside;

  })();

}).call(this);
(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.CoubLikePointsDropdown = (function(superClass) {
    extend(CoubLikePointsDropdown, superClass);

    CoubLikePointsDropdown.prototype.dropdown_class_names = "dropdown--like-points";

    function CoubLikePointsDropdown(opts) {
      $.extend(opts, {
        spinnerSize: "tiny",
        handleEventOpen: "mouseenter",
        handleEventClose: HoverableAbsoluteDropdown.EVENTS.MOUSEOUT_TIMEOUT,
        dropdownPosition: AbsoluteDropdown.POSITION_TYPE.ABSOLUTE_TOP
      });
      CoubLikePointsDropdown.__super__.constructor.apply(this, arguments);
    }

    CoubLikePointsDropdown.prototype.preloadData = function() {
      if (this.preloadStarted) {
        return;
      }
      this.preloadStarted = true;
      return $.get(Routes.like_points_api_v2_editor_coub_path(this.dropdown.getHandle().attr("data-id"))).done((function(_this) {
        return function(data) {
          _this.dropdown.setContent(_this.getContent(data));
          return _this.dropdown.position();
        };
      })(this));
    };

    CoubLikePointsDropdown.prototype.getContent = function(like_stats) {
      return this.content = JST["app/site/templates/coub_block/coub_like_points_dropdown"]({
        like_stats: like_stats
      });
    };

    return CoubLikePointsDropdown;

  })(PreloadableAbsDropdown);

}).call(this);
(function() {
  window.CoubMediaBlock = (function() {
    function CoubMediaBlock(el) {
      this.el = el;
      if (!this.el.length) {
        return;
      }
      this.button = $('.media-block__show-more-less', this.el);
      this.items = $('.media-block__item', this.el);
      this.collapse(true);
      this.el.removeClass('-hidden');
      $('.media-block__title', this.el).hide().show(0);
      this.button.click((function(_this) {
        return function() {
          return _this.collapse(!_this.isCollapsed);
        };
      })(this));
    }

    CoubMediaBlock.prototype.collapse = function(value) {
      this.isCollapsed = value;
      this.items.not(':first').toggleClass('-hidden', value);
      return this.button.text(value ? I18n.t('coub.media_block.show_more') : I18n.t('coub.media_block.show_less'));
    };

    return CoubMediaBlock;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.CoubMoreFromChannel = (function() {
    CoubMoreFromChannel.ATTR_NAME = 'coub-channel-coubs';

    CoubMoreFromChannel.MORE_COUBS_LOADING = false;

    CoubMoreFromChannel.prototype.SETTINGS = {
      ROW_HEIGHT: 96,
      MAX: 3,
      PER_LINE: 3
    };

    function CoubMoreFromChannel(el) {
      var cbH, coubsCount, space, top;
      this.el = el;
      this.destroy = bind(this.destroy, this);
      this.provider = new dataProviders.ApiV2();
      this.data = this.getData();
      top = this.el.position().top;
      cbH = $('[coub-block]:first').height();
      space = cbH - top;
      coubsCount = this.calculateCoubsCount(space);
      console.log("[ADV] CoubMoreFromChannel.init", coubsCount);
      if (coubsCount > 0) {
        this.loadCoubs(coubsCount);
      }
      History.Adapter.bind(window, "statechange", this.destroy);
    }

    CoubMoreFromChannel.prototype.destroy = function() {
      $(window).off("statechange", this.destroy);
      this.xhr && this.xhr.abort();
      return this.getBlock().fadeOut(200);
    };

    CoubMoreFromChannel.prototype.calculateCoubsCount = function(availableHeight) {
      var rows;
      rows = Math.floor(availableHeight / this.SETTINGS.ROW_HEIGHT);
      return Math.min(rows, this.SETTINGS.MAX) * this.SETTINGS.PER_LINE;
    };

    CoubMoreFromChannel.prototype.loadCoubs = function(limit) {
      window.CoubMoreFromChannel.MORE_COUBS_LOADING = true;
      this.xhr && this.xhr.abort();
      return this.xhr = $.get(Routes.channel_api_v2_timeline_index_path(this.data.channelPermalink), {
        page: 1,
        per_page: limit + 1
      }).error(ErrorMessages.ajaxCallServerError).done((function(_this) {
        return function(resp) {
          var coubs, uniq;
          uniq = resp.coubs.filter(function(coub) {
            return coub.id !== _this.data.coubId && coub.is_done;
          });
          coubs = uniq.splice(0, limit);
          if (coubs.length === 0) {
            return;
          }
          return _this.el.html(_this.getTemplate(coubs, resp.total_pages > 1));
        };
      })(this));
    };

    CoubMoreFromChannel.prototype.getTemplate = function(coubs, showMore) {
      return $(JST["app/site/templates/coub_block/parts/more_from_channel_block"]({
        coubs: coubs,
        channelData: this.data,
        showMore: showMore
      }));
    };

    CoubMoreFromChannel.prototype.getBlock = function() {
      return $('.channel-coubs').first();
    };

    CoubMoreFromChannel.prototype.getData = function() {
      return {
        coubId: parseInt(this.el.attr("data-coub-id")),
        channelPermalink: this.el.attr("data-channel-permalink"),
        channelTitle: this.el.attr("data-channel-title")
      };
    };

    return CoubMoreFromChannel;

  })();

}).call(this);
(function() {
  window.CoubSocialControlsBlock = {
    init: function($el) {
      var button, dropdown, i, j, len, len1, ref, ref1, results;
      ref = [widgets.LikeButton, widgets.RecoubButton, widgets.DislikeButton];
      for (i = 0, len = ref.length; i < len; i++) {
        button = ref[i];
        chms.utils.Autoinit.init(button, $el);
      }
      $el.find("[widget-counter]").each(function() {
        return new widgets.Counter($(this), helpers.Application.roundToK);
      });
      ref1 = [blocks.LikesListDropdown, blocks.RecoubsListDropdown, blocks.RemixesListDropdown];
      results = [];
      for (j = 0, len1 = ref1.length; j < len1; j++) {
        dropdown = ref1[j];
        results.push(blocks.UserListDropdownAbstract.constructIn(dropdown, $el, true));
      }
      return results;
    },
    construct: function(coubBlock) {
      if (!coubBlock || coubBlock.length === 0) {
        throw "CoubSocialControlsBlock: to construct block please pass coubClock as a argument";
      }
      return $(".description__controls", coubBlock).each(function() {
        return CoubSocialControlsBlock.init($(this));
      });
    }
  };

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.ModalPopup = (function(superClass) {
    extend(ModalPopup, superClass);

    function ModalPopup() {
      this.animateExpand = bind(this.animateExpand, this);
      this.setFooter = bind(this.setFooter, this);
      this.setContent = bind(this.setContent, this);
      this.appendToBody = bind(this.appendToBody, this);
      this.afterClose = bind(this.afterClose, this);
      this.render = bind(this.render, this);
      this.getContentContainer = bind(this.getContentContainer, this);
      this.getLayout = bind(this.getLayout, this);
      this.get = bind(this.get, this);
      return ModalPopup.__super__.constructor.apply(this, arguments);
    }

    ModalPopup.prototype.get = function() {
      return this.rendered;
    };

    ModalPopup.prototype.getLayout = function() {
      return this.rendered.find(".modal__content");
    };

    ModalPopup.prototype.getContentContainer = function() {
      return this.rendered.find(".modal__body");
    };

    ModalPopup.prototype.render = function(data) {
      var classes;
      classes = '';
      if (data.footer === void 0) {
        data.footer = "";
      }
      if (data.classes != null) {
        classes += data.classes;
      }
      if (data.type != null) {
        classes += " modal--" + data.type;
      }
      data.classes = classes;
      return $(JST["app/site/templates/modal_popup/modal_popup"](data));
    };

    ModalPopup.prototype.afterClose = function() {
      return this.rendered.remove();
    };

    ModalPopup.prototype.appendToBody = function(rendered) {
      if (!$(".modal").length) {
        this.rendered = rendered.hide();
        $("body").append(this.rendered);
        this.popup = new Popup({
          el: this.rendered
        });
        this.popup.show();
        $(this.popup.el).one(Popup.EVENT_HIDED, this.afterClose);
        return true;
      } else {
        return false;
      }
    };

    ModalPopup.prototype.setContent = function(content) {
      return this.rendered.find(".modal__body").html(content);
    };

    ModalPopup.prototype.setFooter = function(content) {
      return this.rendered.find(".modal__footer").html(content);
    };

    ModalPopup.prototype.animateExpand = function() {
      if (!this.animator) {
        this.animator = new CoubAnimators.EmbedPopupAnimator(this);
      }
      return this.animator.animate(CoubAnimators.EmbedPopupAnimator.ACTIONS.EXPAND);
    };

    ModalPopup.show = function(data) {
      var popup;
      if (data == null) {
        data = {};
      }
      popup = new ModalPopup();
      if (!data.type) {
        data.type = 'simple';
      }
      if (popup.appendToBody(popup.render(data))) {
        return popup;
      }
    };

    ModalPopup.constructPopup = function(opts) {
      var classes, cont, content, modal, type;
      if (opts == null) {
        opts = {};
      }
      content = opts.content || '';
      classes = opts.classes || '';
      type = opts.type || 'simple';
      modal = ModalPopup.show({
        content: content,
        type: type,
        classes: classes
      });
      cont = modal.get();
      return opts.constructed(cont, modal);
    };

    return ModalPopup;

  })(window.Popup);

}).call(this);
(function() {
  window.EditorialPopup = {
    show: function(coubId) {
      var cont, modal, type;
      modal = ModalPopup.show({
        content: '',
        type: 'simple',
        classes: 'modal--moderation-popup'
      });
      if (!modal) {
        return;
      }
      cont = modal.get();
      LoadRotator.appendToContainterAndStart(modal.getContentContainer());
      return new dataProviders.ApiV2().getEditorControlsData(coubId, type = 'dropdown', {
        success: (function(_this) {
          return function(resp) {
            modal.setContent(JST["app/site/templates/coub_block/editor_specific/editor_coub_controls"]({
              data: resp,
              type: type
            }));
            EditorCoubCatsAndFlagsMenu.construct(cont);
            EditorTrendList.construct(cont);
            chms.utils.Autoinit.init(EditorRecouber, cont);
            chms.utils.Autoinit.init(EditorCategories, cont);
            chms.utils.Autoinit.init(EditorCopyrightClaim, cont);
            GlobalEditorButtons.construct(cont);
            return cont.find("a[data-remote='true']").on("click", function(e) {
              var el;
              if (e != null) {
                e.preventDefault();
                e.stopPropagation();
              }
              el = $(e.currentTarget);
              if ($.rails.allowAction(el)) {
                return $.rails.handleRemote(el);
              }
            });
          };
        })(this),
        error: function() {
          ErrorMessages.internalServerError();
          return modal.close();
        },
        complete: (function(_this) {
          return function() {
            return LoadRotator.removeFromContainer(modal.getContentContainer());
          };
        })(this)
      });
    }
  };

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.FlagCoubDropdown = (function(superClass) {
    extend(FlagCoubDropdown, superClass);

    function FlagCoubDropdown(opts) {
      this.appendDropdown = bind(this.appendDropdown, this);
      this.content = opts.el.find('[flag-coub-content]');
      opts.defaultContent = this.content[0].outerHTML;
      opts.classNames = 'dropdown--flag';
      opts.dropdownPosition = AbsoluteDropdown.POSITION_TYPE.ABSOLUTE_BOTTOM;
      FlagCoubDropdown.__super__.constructor.apply(this, arguments);
    }

    FlagCoubDropdown.prototype.appendDropdown = function() {
      FlagCoubDropdown.__super__.appendDropdown.apply(this, arguments);
      return this.content.removeClass('-hidden');
    };

    return FlagCoubDropdown;

  })(ControlableAbsoluteDropdown);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.ShareCoubPopup = (function(superClass) {
    extend(ShareCoubPopup, superClass);

    function ShareCoubPopup() {
      this.afterClose = bind(this.afterClose, this);
      this.render = bind(this.render, this);
      return ShareCoubPopup.__super__.constructor.apply(this, arguments);
    }

    ShareCoubPopup.prototype.render = function() {
      return ShareCoubPopup.__super__.render.apply(this, arguments).addClass('share-popup');
    };

    ShareCoubPopup.prototype.afterClose = function() {
      ShareCoubPopup.__super__.afterClose.apply(this, arguments);
      return $(document).trigger("flash_player:unmute");
    };

    ShareCoubPopup.show = function(coubId) {
      var popup;
      popup = new ShareCoubPopup();
      if (popup.appendToBody(popup.render({
        content: "",
        footer: ""
      }))) {
        $(document).trigger("flash_player:mute");
        new dataProviders.ApiV2().getEmbedShareData(coubId, {
          success: function(coub) {
            var data, layout;
            LoadRotator.removeFromContainer(popup.getLayout());
            layout = popup.getLayout().find('.layout-content');
            data = $(JST["app/site/templates/coub_block/popups/share_coub_popup"](helpers.Coub.getOriginalCoub(coub)));
            layout.append(data);
            data.share_popup_contents();
            popup.animateExpand();
            return data.delay(500).queue(function() {
              data.addClass('showed');
              return data.dequeue();
            });
          },
          error: function() {
            ErrorMessages.internalServerError();
            LoadRotator.removeFromContainer(popup.getLayout());
            return popup.close();
          }
        });
        return LoadRotator.appendToContainterAndStart(popup.getLayout());
      }
    };

    return ShareCoubPopup;

  })(window.ModalPopup);

}).call(this);
(function() {
  $.Controller("SharePopupContents", {
    ".option__custom-size input keyup": function(el, e) {
      this.onlyNumbers(e);
      this.updateDependentSizeInput(el);
      this.toggleOriginalSize();
      return this.buildEmbedCode();
    },
    ".option__custom-size input keydown": function(el, e) {
      var KEY_CODE_DOWN_ARROW, KEY_CODE_UP_ARROW;
      KEY_CODE_UP_ARROW = 38;
      KEY_CODE_DOWN_ARROW = 40;
      if (e.keyCode === KEY_CODE_UP_ARROW || e.keyCode === KEY_CODE_DOWN_ARROW) {
        if (e.keyCode === KEY_CODE_UP_ARROW) {
          if (e.shiftKey) {
            this.strongIncrement(el);
          } else {
            this.increment(el);
          }
        } else {
          if (e.shiftKey) {
            this.strongDecrement(el);
          } else {
            this.decrement(el);
          }
        }
        this.onlyNumbers(e);
        this.updateDependentSizeInput(el);
        this.toggleOriginalSize();
        return this.buildEmbedCode();
      }
    },
    strongIncrement: function(el) {
      var value;
      value = parseInt(el.val());
      value += 10;
      return el.val(value);
    },
    strongDecrement: function(el) {
      var value;
      value = parseInt(el.val());
      value -= 10;
      if (value < 0) {
        return el.val(0);
      } else {
        return el.val(value);
      }
    },
    increment: function(el) {
      var value;
      value = parseInt(el.val());
      value++;
      return el.val(value);
    },
    decrement: function(el) {
      var value;
      value = parseInt(el.val());
      if (!(value <= 0)) {
        value--;
        return el.val(value);
      }
    },
    "input[type=checkbox] change": function() {
      return this.buildEmbedCode();
    },
    ".option__size .frame click": function(e) {
      return this.pickSize(e);
    },
    ".option__custom-size input[type=text] click": function() {
      return this.focusCustomSize();
    },
    ".frame.original click": function() {
      this.originalSizeInput.trigger('click');
      return this.buildEmbedCode();
    },
    "input[name='autostart'] click": function() {
      var autostart, isAutostart, muted;
      autostart = $("input[name='autostart']", this.element);
      muted = $("label[for='mute']", this.element);
      isAutostart = autostart.is(':checked');
      muted.toggle(isAutostart);
      $('input[type=checkbox]', muted).attr('checked', isAutostart);
      return this.buildEmbedCode();
    },
    ".share-popup__checks input[type=checkbox] click": function() {
      return this.reloadIframe();
    },
    init: function() {
      this.widthInput = $('input[type=text].width', this.element);
      this.heightInput = $('input[type=text].height', this.element);
      this.originalSizeInput = $('.originalSize input[type=checkbox]', this.element);
      this.defaultWidth = this.widthInput.val();
      this.defaultHeight = this.heightInput.val();
      this.coubURL = $('.share-popup__content', this.element).attr('data-coub-url').replace(/^https?:/, '');
      this.embedContainer = $('.share-popup__preview', this.element);
      this.popupContent = $('.modal__content', this.element);
      $("input.url, textarea", this.element).on('focus', function() {
        return this.select();
      });
      this.buildEmbedCode();
      return this.reloadIframe();
    },
    buildEmbedCode: function() {
      var height, opts, out, runner_url, url, width;
      opts = this.serializeOpts();
      url = this.coubURL + "?" + ($.param($.extend({}, opts, {
        autostart: false
      })));
      runner_url = '//c-cdn.coub.com/embed-runner.js';
      if (this.customSizeDefined()) {
        width = $('input.width', this.element).val();
        height = $('input.height', this.element).val();
      } else {
        width = this.defaultWidth;
        height = this.defaultHeight;
      }
      out = "<iframe src=\"" + url + "\" allowfullscreen frameborder=\"0\" width=\"" + width + "\" height=\"" + height + "\" allow=\"autoplay\"></iframe>";
      if (opts.autostart) {
        out += "<script async src=\"" + runner_url + "\"></script>";
      }
      return $('textarea.iframeCode', this.element).val(out.replace(/(\r\n|\n|\r)/gm, ""));
    },
    serializeOpts: function() {
      return {
        muted: $("input[name='mute']", this.element).is(":checked"),
        autostart: $("input[name='autostart']", this.element).is(':checked'),
        originalSize: $('.originalSize input[type=checkbox]', this.element).is(":checked"),
        startWithHD: $("input[name='startwithhd']", this.element).is(":checked")
      };
    },
    customSizeDefined: function() {
      return parseInt($("input.width", this.element).val()) > 0 && parseInt($("input.height", this.element).val()) > 0;
    },
    pickSize: function(e) {
      $('.option__size .frame', this.element).removeClass("active");
      e.addClass("active");
      this.widthInput.val(e.attr('data-width'));
      this.heightInput.val(e.attr('data-height'));
      this.toggleOriginalSize();
      return this.buildEmbedCode();
    },
    focusCustomSize: function() {
      return $('.option__size .frame.active', this.element).removeClass("active");
    },
    setOriginalSize: function() {
      $('input.height', this.element).val(this.originalSizeInput.attr('data-height'));
      $('input.width', this.element).val(this.originalSizeInput.attr('data-width'));
      return $('.option__size .frame.active', this.element).removeClass('active');
    },
    unsetOriginalSize: function() {
      return $('.option__size .frame:last', this.element).trigger('click');
    },
    toggleOriginalSize: function() {
      if (this.widthInput.val() === this.originalSizeInput.attr('data-width') && this.heightInput.val() === this.originalSizeInput.attr('data-height')) {
        return this.originalSizeInput.attr('checked', 'checked');
      } else {
        return this.originalSizeInput.removeAttr('checked', 'checked');
      }
    },
    onlyNumbers: function(e) {
      return e.target.value === e.target.value.replace(/[^0-9]/g, '');
    },
    updateDependentSizeInput: function(el) {
      var newHeight, newWidth, ratio;
      ratio = this.defaultWidth / this.defaultHeight;
      if (el.is('.width')) {
        newHeight = parseInt(el.val()) / ratio;
        if (newHeight + '' !== 'NaN') {
          return $('input.height', this.element).val(parseInt(newHeight));
        }
      } else {
        newWidth = parseInt(el.val()) * ratio;
        if (newWidth + '' !== 'NaN') {
          return $('input.width', this.element).val(parseInt(newWidth));
        }
      }
    },
    reloadIframe: function() {
      var controlsHeight, controlsWidth, d, height, iframeHeight, iframeWidth, newControlsWidth, newIframeHeight, newIframeWidth, newPaddingTop, newPopupWidth, paddingHeight, paddingTop, paddingWidth, params, popupWidth, updatedIframe, url, width;
      height = '100%';
      width = '100%';
      params = {};
      $('.share-popup__checks input[type=checkbox]:checked', this.element).each(function() {
        return params[$(this).attr('data-option')] = true;
      });
      url = this.coubURL + "?" + ($.param(params));
      updatedIframe = '<iframe src=' + url + ' allowfullscreen frameborder="0" height=' + height + ' width=' + width + ' allow="autoplay"></iframe>';
      this.embedContainer.html(updatedIframe);
      if (window.innerWidth >= 1024) {
        iframeWidth = 610;
        iframeHeight = this.defaultHeight * iframeWidth / this.defaultWidth;
        paddingHeight = 2 * 20;
        paddingWidth = 3 * 20;
        popupWidth = 970;
        controlsWidth = popupWidth - iframeWidth - paddingWidth;
        if (iframeHeight + paddingHeight > window.innerHeight) {
          newIframeHeight = window.innerHeight - paddingHeight;
          d = newIframeHeight / iframeHeight;
          newIframeWidth = iframeWidth * d;
          newControlsWidth = controlsWidth * d;
          newPopupWidth = Math.ceil(newIframeWidth + newControlsWidth + paddingWidth);
          return this.popupContent.css('width', newPopupWidth + 'px');
        }
      } else {
        iframeWidth = 600;
        iframeHeight = this.defaultHeight * iframeWidth / this.defaultWidth;
        controlsHeight = 380;
        paddingHeight = 2 * 20 + 20;
        if (iframeHeight + paddingHeight + controlsHeight > window.innerHeight) {
          newIframeHeight = window.innerHeight - paddingHeight - controlsHeight;
          d = newIframeHeight / iframeHeight;
          paddingTop = parseInt(this.embedContainer[0].style['padding-top']);
          newPaddingTop = paddingTop * d;
          return this.embedContainer.css('padding-top', newPaddingTop + '%');
        }
      }
    }
  });

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.ChangeConfirmPasswordAbstractDialog = (function() {
    function ChangeConfirmPasswordAbstractDialog(opts) {
      this.hideLoader = bind(this.hideLoader, this);
      this.showLoader = bind(this.showLoader, this);
      this.hideError = bind(this.hideError, this);
      this.showError = bind(this.showError, this);
      this.resetPass = bind(this.resetPass, this);
      this.hided = bind(this.hided, this);
      this.showed = bind(this.showed, this);
      this.el = $(opts.el);
      $("[reset-pass-button]", this.el).bind("click", this.resetPass);
      this.errorMsgContainter = $(".-error-text", this.el);
      this.el.on(Popup.EVENT_SHOWED, this.showed);
      this.el.on(Popup.EVENT_HIDED, this.hided);
    }

    ChangeConfirmPasswordAbstractDialog.prototype.showed = function() {
      return $(document).on("ajaxStart", this.showLoader).on("ajaxStop", this.hideLoader);
    };

    ChangeConfirmPasswordAbstractDialog.prototype.hided = function() {
      return $(document).off("ajaxStart", this.showLoader).off("ajaxStop", this.hideLoader);
    };

    ChangeConfirmPasswordAbstractDialog.prototype.resetPass = function() {
      return $.put(Routes.reset_password_users_path()).fail(function(jqXhr) {
        if (jqXhr.status === 423) {
          return Growl.msg(I18n.t("auth_popup.signin.reset.no_email_error"), "");
        } else {
          return ErrorMessages.internalServerError();
        }
      }).done((function(_this) {
        return function(resp) {
          return _this.el.find("form").hide().end().find(".reset-pass__notify").show().find('strong').text(Params.getBranchValue('current_user.email'));
        };
      })(this));
    };

    ChangeConfirmPasswordAbstractDialog.prototype.showError = function(message) {
      return $(".-error-text", this.el).text(message).show();
    };

    ChangeConfirmPasswordAbstractDialog.prototype.hideError = function() {
      $("input[type='text']", this.el).removeClass('error');
      return $(".-error-text", this.el).hide().text('');
    };

    ChangeConfirmPasswordAbstractDialog.prototype.showLoader = function() {
      return LoadRotator.appendWithOverlayAndStart(this.el.find('.modal__content'));
    };

    ChangeConfirmPasswordAbstractDialog.prototype.hideLoader = function() {
      return LoadRotator.removeWithOverlay(this.el.find('.modal__content'));
    };

    return ChangeConfirmPasswordAbstractDialog;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.ConfirmPasswordDialog = (function(superClass) {
    extend(ConfirmPasswordDialog, superClass);

    ConfirmPasswordDialog.EVENTS = {
      DONE: "ConfirmPasswordDialog:Done",
      DELETED: "ConfirmPasswordDialog:Deleted"
    };

    function ConfirmPasswordDialog(opts) {
      this.hided = bind(this.hided, this);
      this.confirmationForDeleteion = bind(this.confirmationForDeleteion, this);
      this.confirmationForUpdate = bind(this.confirmationForUpdate, this);
      this.submit = bind(this.submit, this);
      this.isValid = bind(this.isValid, this);
      ConfirmPasswordDialog.__super__.constructor.apply(this, arguments);
      this.type = opts.type;
      this.channelId = opts.id != null ? opts.id : '';
      this.passInput = $("input[name='user[password]']", this.el);
      this.redirectTo = opts.redirect != null ? opts.redirect : '';
      this.el.find('form').on('submit', (function(_this) {
        return function(e) {
          e.preventDefault();
          return _this.submit(e);
        };
      })(this));
    }

    ConfirmPasswordDialog.prototype.isValid = function() {
      if (this.passInput.val() === "") {
        this.showError();
        return false;
      } else {
        this.hideError();
        return true;
      }
    };

    ConfirmPasswordDialog.prototype.submit = function(e) {
      if (this.isValid()) {
        switch (this.type) {
          case 'private':
            return this.confirmationForUpdate({
              provider: new LoginDataProvider(),
              value: this.passInput.val()
            });
          case 'deletion':
            return this.confirmationForDeleteion({
              provider: new dataProviders.ApiV2(),
              value: this.passInput.val(),
              id: this.channelId
            });
        }
      }
    };

    ConfirmPasswordDialog.prototype.confirmationForUpdate = function(opts) {
      var error, success;
      success = (function(_this) {
        return function(resp) {
          switch (resp.result) {
            case "valid":
              _this.el.trigger(Popup.ACTION_CLOSE);
              $(document).trigger({
                type: ConfirmPasswordDialog.EVENTS.DONE,
                password: opts.value
              });
              if (_this.redirectTo.length) {
                return $.handleRedirect(_this.redirectTo);
              }
              break;
            case "invalid":
              return _this.showError(I18n.PROFILE.ERRORS.PASSWORD_INCORECT);
            default:
              return ErrorMessages.internalServerError();
          }
        };
      })(this);
      error = (function(_this) {
        return function(resp) {
          return ErrorMessages.internalServerError();
        };
      })(this);
      return opts.provider.confirmPassword(opts.value, success, error);
    };

    ConfirmPasswordDialog.prototype.confirmationForDeleteion = function(opts) {
      return $.del(Routes.api_v2_channel_path(opts.id), {
        password: opts.value
      }).done(function(resp) {
        return $(document).trigger({
          type: ConfirmPasswordDialog.EVENTS.DELETED,
          link: resp.redirect_url
        });
      }).fail((function(_this) {
        return function(resp) {
          if (resp.status === 422) {
            return _this.showError(I18n.PROFILE.ERRORS.PASSWORD_INCORECT);
          } else {
            return ErrorMessages.internalServerError();
          }
        };
      })(this));
    };

    ConfirmPasswordDialog.prototype.showError = function(msg) {
      if (msg != null) {
        ConfirmPasswordDialog.__super__.showError.apply(this, arguments);
      }
      return this.passInput.addClass("error");
    };

    ConfirmPasswordDialog.prototype.hided = function() {
      ConfirmPasswordDialog.__super__.hided.apply(this, arguments);
      return this.el.remove();
    };

    ConfirmPasswordDialog.construct = function(type, redirectUrl) {
      var temp;
      if (redirectUrl == null) {
        redirectUrl = '';
      }
      if (type != null) {
        temp = JST["app/site/templates/channels/edit/widgets/modals/confirm_password_content"]();
        return ModalPopup.constructPopup({
          content: temp,
          constructed: (function(_this) {
            return function(cont) {
              return new ConfirmPasswordDialog({
                el: cont,
                type: type,
                redirect: redirectUrl
              });
            };
          })(this)
        });
      } else {
        throw "ConfirmPasswordDialog.construct requires @param {String} type";
      }
    };

    ConfirmPasswordDialog.constructInside = function(opts) {
      if (opts == null) {
        opts = {};
      }
      if (opts.type != null) {
        return new ConfirmPasswordDialog(opts);
      } else {
        throw "ConfirmPasswordDialog.construct requires @param {String} type";
      }
    };

    return ConfirmPasswordDialog;

  })(ChangeConfirmPasswordAbstractDialog);

}).call(this);

/*
  Виджет для скачивания файлов
  На элемент, на котором инитится виджет, надо добавить аттрибут url с урлом файла
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.DownloadFile = (function() {
    DownloadFile.ATTR_NAME = "widget-download-file";

    DownloadFile.ACTION = "download:file";

    function DownloadFile(el) {
      this.el = el;
      this.downloadFile = bind(this.downloadFile, this);
      this.el.on('click', (function(_this) {
        return function() {
          _this.downloadFile();
          return _this.el.trigger(widgets.DownloadFile.ACTION);
        };
      })(this));
    }

    DownloadFile.prototype.downloadFile = function() {
      var e, fileName, link, url;
      url = this.el.attr('url');
      if (GlobalState.PLATFORM.isIos()) {
        alert("Your device does not support files downloading.");
        return false;
      }
      if (GlobalState.BROWSER.isChrome() || GlobalState.BROWSER.isSafari()) {
        link = document.createElement("a");
        link.href = url;
        if (link.download !== void 0) {
          fileName = url.substring(url.lastIndexOf("/") + 1, url.length);
          link.download = fileName;
        }
        if (document.createEvent) {
          e = document.createEvent("MouseEvents");
          e.initEvent("click", true, true);
          link.dispatchEvent(e);
          return true;
        }
      }
      if (url.indexOf("?") === -1) {
        url += "?download";
      }
      window.open(url, "_self");
      return true;
    };

    return DownloadFile;

  })();

}).call(this);
(function() {
  $.Controller('Dropdown', {
    '.dropdown__handler click': function(e) {
      if (!this.isHandlerFree) {
        if (this.content.is(':visible')) {
          this.hide();
        } else if (!this.isDisabled() && (this.element.attr("prevent-dropdown-open") == null)) {
          this.show();
        }
      }
      return false;
    },
    '.close-small click': function(e) {
      if (this.content.is(':visible')) {
        this.hide();
      }
      return false;
    },
    ".dropdown__cancel click": function(e) {
      return this.hide();
    },
    ANIMATION_DURATION: 200,
    init: function() {
      this.s = Dropdown;
      this.uidata = new siteData.UI();
      this.isHandlerFree = this.element.is('[data-handler-free]');
      this.isTimeoutHide = this.element.is('[data-timeout-hide]') && !GlobalState.PLATFORM.isMobile();
      this.hideTimeout = false;
      this.handle = $('.dropdown__handler:first', this.element);
      this.content = $('.dropdown__inner:first', this.element);
      this.prompt = this.handle.find('[data-prompt]');
      this.hideLocker = new chms.utils.Locker();
      this.element.on('show', (function(_this) {
        return function() {
          return _this.show();
        };
      })(this)).on('hide', (function(_this) {
        return function(e) {
          e.stopPropagation();
          return _this.hide();
        };
      })(this)).on('position', (function(_this) {
        return function() {
          return _this.position();
        };
      })(this)).on(this.s.ACTION_PREVENT_HIDING, this.hideLocker.lock).on(this.s.ACTION_ALLOW_HIDING, this.hideLocker.unlock).on(this.s.ACTION_PRESERVE_POSITION, (function(_this) {
        return function() {
          return _this.preservePosition();
        };
      })(this));
      this.content.on('selectstart', (function(_this) {
        return function() {
          if (!_this.element.hasClass('-select')) {
            return _this.disableTextSelection();
          }
        };
      })(this));
      if (this.isTimeoutHide) {
        this.content.on('mouseenter', (function(_this) {
          return function() {
            return _this.onEnter();
          };
        })(this)).on('mouseleave', (function(_this) {
          return function() {
            return _this.onLeave();
          };
        })(this));
      }
      return this.bindedHideHandler = this.hideHandler.bind(this);
    },
    preservePosition: function() {
      var nw, offset;
      if (this._hwidth != null) {
        nw = this.handle.width();
        offset = nw - this._hwidth;
        if (offset !== 0) {
          this.content.css({
            left: "+=" + offset
          });
          return this._hwidth = this.handle.width();
        }
      }
    },
    destroy: function() {
      $(document).off('mousedown touchstart', this.bindedHideHandler);
      clearTimeout(this.hideTimeout);
      return this._super();
    },
    show: function() {
      this._hwidth = this.handle.width();
      this.hideTimeout && clearTimeout(this.hideTimeout);
      this.content.css({
        top: 'auto',
        left: 'auto'
      }).show();
      this.position();
      this.uidata.pushUniq("showedDropdowns", this);
      this.element.trigger('beforeShowed');
      this.content.addClass('-showed');
      this.showed();
      if (!this.isHandlerFree) {
        $(document).on('mousedown touchstart', this.bindedHideHandler);
      }
      if (this.withPrompt()) {
        this.prompt.attr('inactive', true);
        return this.prompt.trigger('hidePrompt');
      }
    },
    showed: function() {
      this.element.trigger('showed');
      widgets.ListKeyNavigation.focusInEl(this.element);
      this.onEnter();
      if (this.isTimeoutHide) {
        return this.onLeave();
      }
    },
    hide: function() {
      if (this.hideLocker.isLocked()) {
        return;
      }
      this._hwidth = void 0;
      this.uidata.deleteFirstByValue("showedDropdowns", this);
      this.element.trigger('beforeHided');
      $(document).off('mousedown touchstart', this.bindedHideHandler);
      this.content.removeClass('-showed');
      this.hideTimeout = setTimeout((function(_this) {
        return function() {
          _this.content.hide();
          return _this.hided();
        };
      })(this), this.ANIMATION_DURATION);
      if (this.withPrompt()) {
        return this.prompt.removeAttr('inactive');
      }
    },
    hided: function() {
      this.element.trigger('hided');
      return widgets.ListKeyNavigation.blurInEl(this.element);
    },
    onEnter: function() {
      return clearTimeout(this.onLeaveTimer);
    },
    onLeave: function() {
      return this.onLeaveTimer = setTimeout((function(_this) {
        return function() {
          return _this.hide();
        };
      })(this), 2000);
    },
    hideHandler: function(e) {
      var t;
      t = $(e.target);
      if (t.closest('.dropdown').get(0) === this.element.get(0)) {
        return;
      }
      if (t.is('.dropdown__handler.flag') || t.closest('.dropdown.dropdown--flag, .dropdown__content').length !== 0) {
        return;
      }
      return this.hide();
    },
    position: function() {
      this.arrowOffset = 4;
      this.element.removeClass('-below -above -right');
      if (this.element.hasClass('strict-above')) {
        return this.positionDropdownAbove();
      } else if (this.element.hasClass('strict-below')) {
        return this.positionDropdownBelow();
      } else if (this.element.hasClass('str-right')) {
        return this.positionDropdownRight();
      } else {
        if (this.content.offset().top + this.content.height() > $(window).scrollTop() + $(window).height() && this.content.offset().top - $('header.header').height() > this.content.height()) {
          return this.positionDropdownAbove();
        } else {
          return this.positionDropdownBelow();
        }
      }
    },
    positionDropdownAbove: function() {
      var newLeft, newTop, topShift, vOffset;
      topShift = 3;
      newLeft = (this.handle.width() - this.content.width()) / 2;
      newTop = -1 * (this.content.height() + this.arrowOffset) - topShift;
      if ((vOffset = this.element.attr('data-v-offset'))) {
        newTop += parseInt(vOffset);
      }
      this.content.css({
        left: newLeft + 'px',
        top: newTop + 'px'
      });
      return this.element.addClass('-above');
    },
    positionDropdownBelow: function() {
      var d, newLeft, newTop, topShift, vOffset;
      topShift = 3;
      newLeft = (this.handle.width() - this.content.width()) / 2;
      if (this.element.attr('data-align-left') != null) {
        newLeft = 0;
      } else if (this.element.attr('data-align-right') != null) {
        newLeft = this.handle.width() - this.content.width();
      }
      newTop = this.arrowOffset + this.handle.height() + topShift;
      if ((vOffset = this.element.attr('data-v-offset'))) {
        newTop -= parseInt(vOffset);
      }
      this.content.css({
        left: newLeft + 'px',
        top: newTop + 'px'
      });
      this.element.addClass('-below');
      if ((d = window.innerWidth - (this.content.offset().left + this.content.width() + 20)) < 0) {
        newLeft += d;
        return this.content.css({
          left: newLeft + 'px'
        });
      }
    },
    positionDropdownRight: function() {
      var newLeft, newTop;
      newLeft = this.handle.width() + this.arrowOffset;
      newTop = -this.content.height() / 2;
      this.content.css({
        left: newLeft + 'px',
        top: newTop + 'px'
      });
      return this.element.addClass('-right');
    },
    withPrompt: function() {
      return this.prompt.length && (this.prompt.attr('hideable-prompt') != null);
    },
    isDisabled: function() {
      var handler;
      handler = this.handle.children() != null ? $(this.handle.children()[0]) : this.handle;
      return this.element.hasClass('disabled') || handler.hasClass('disabled');
    },
    disableTextSelection: function() {
      return false;
    }
  });

  window.Dropdown.ACTION_PREVENT_HIDING = "Dropdown:Actions:PreventHiding";

  window.Dropdown.ACTION_ALLOW_HIDING = "Dropdown:Actions:AllowHiding";

  window.Dropdown.ACTION_PRESERVE_POSITION = "Dropdown:Actions:PreservePosition";

}).call(this);
(function() {
  window.CoubEnvironment = {
    FACEBOOK_APP_ID: "175407152526434",
    USER: {
      PERMALINK_REGEXP: new RegExp(/^[a-zA-Z\-0-9\.]{8,100}$/),
      EMAIL_REGEXP: new RegExp(/^[a-z0-9!#\$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#\$%&'*+\/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$/)
    }
  };

}).call(this);
(function() {
  window.ExplorePage = (function() {
    function ExplorePage(el) {
      this.el = $(el);
      this.timeline = $('[widget-clientside-timeline-channels]', this.el);
      blocks.ViewerBlock.constructFromContainer(this.el, {
        muted: true,
        startWithHD: true,
        noControls: true
      });
      $('.slideshow.explore', this.el).explore_page_slideshow();
      if (!this.timeline.length) {
        return;
      }
      this.timeline.on(clientsideTimeline.ClientsideTimelineChannels.ACTION_LOAD_PAGE, this.fetchIds.bind(this));
    }

    ExplorePage.prototype.fetchIds = function() {
      var bannerIds, channelIds;
      bannerIds = JSON.parse(this.timeline.attr('big-list-ids'));
      channelIds = _.map($('.channel--simple', this.el), function(e) {
        return $(e).attr('data-channel-id');
      });
      return this.timeline.triggerHandler(clientsideTimeline.ClientsideTimelineChannels.ACTION_UPDATE_PROPERTIES, [
        {
          exclude: bannerIds.concat(channelIds)
        }, false
      ]);
    };

    return ExplorePage;

  })();

}).call(this);
(function() {
  $.Controller("FeaturedChannels", {
    init: function() {
      this.deleteBtn = this.element.find('.close-small');
      this.id = this.deleteBtn.attr('data-channel-id');
      this.provider = new dataProviders.ApiV2Editor();
      return this.deleteBtn.bind("click", (function(_this) {
        return function() {
          return _this.removeFromEdited();
        };
      })(this));
    },
    removeFromEdited: function() {
      return this.provider.removeFromFeatured(this.id, {
        success: (function(_this) {
          return function() {
            _this.element.remove();
            return Growl.succ('Hurray!', 'Channel was successfully removed from Featured');
          };
        })(this),
        error: (function(_this) {
          return function() {
            return Growl.msg('Error', 'Something went wrong, call the doctor');
          };
        })(this)
      });
    }
  });

}).call(this);
(function() {
  pages.findFriends.EmailInvites = (function() {
    function EmailInvites(el) {
      var $block, $form, $input, $sendBtn, $status, locked;
      $block = $(el);
      $sendBtn = $('button', $block);
      $input = $('input', $block);
      $form = $('.form', $block);
      $status = $('.status', $block);
      locked = false;
      $form.on('submit', (function(_this) {
        return function(e) {
          var emails;
          $status.add($status.children()).hide();
          $input.removeClass('error');
          emails = _.uniq($input.val().match(/[A-Za-z0-9_.-]+@[A-Za-z0-9-]+\.\w+/g) || []);
          if (emails.length) {
            $sendBtn.addClass('disabled').prop('disabled', true);
            new PossibleFriendsDataProvider().inviteFriendsViaProvider({
              provider: 'email',
              data: emails
            }).fail(function() {
              return Growl.msg(I18n.ERRORS.INTERNAL_SERVER_ERROR.SUB, I18n.ERRORS.INTERNAL_SERVER_ERROR.TRY_AGAIN);
            }).always(function() {
              locked = false;
              return $sendBtn.removeClass('disabled').prop('disabled', false);
            }).done(function(data) {
              var sent;
              if (data.duplicate.length || data.invalid.length) {
                $status.show();
                if (data.duplicate.length) {
                  $status.children('.duplicate').show().children('span').html(data.duplicate.join(', '));
                }
                if (data.invalid.length) {
                  $status.children('.invalid').show().children('span').html(data.invalid.join(', '));
                }
                if (data.duplicate.length + data.invalid.length < emails.length) {
                  sent = _.difference(emails, data.duplicate, data.invalid).join(', ');
                  return $status.children('.success').show().children('span').html(sent);
                }
              } else {
                $('.sent span', $block).html(I18n.t("find_friends.page.invintation" + (emails.length > 1 ? 's' : '') + "_sent"));
                $('.sent', $block).show();
                return $form.hide();
              }
            });
          } else {
            $input.addClass('error');
          }
          $('.sent a', $block).on('click', function() {
            $input.val('');
            $form.show();
            $('.sent', $block).hide();
            return false;
          });
          return false;
        };
      })(this));
      $input.on('keyup', function(e) {
        if (!locked && e.which === 13) {
          return $form.submit();
        }
      });
      $sendBtn.on('click', function() {
        if (!locked) {
          return $form.submit();
        }
      });
    }

    return EmailInvites;

  })();

}).call(this);
(function() {
  pages.findFriends.Page = (function() {
    Page.BASE_PATH = '/friends';

    function Page(el) {
      this.$el = $(el);
      this.$friends = $('.friends', this.$el);
      this.initNav();
      this.initBlocks();
      this.initRouter();
      new pages.findFriends.EmailInvites($('.friends-from-email', el));
    }

    Page.prototype.initRouter = function() {
      page('/who-to-follow', (function(_this) {
        return function() {
          _this.toggleLoader(true);
          _this.setNavSelection('who-to-follow');
          _this.resetBlocks();
          return _this.recommendedFriendsBlock.single('loaded:first', function() {
            return _this.toggleLoader(false);
          }).load();
        };
      })(this));
      page('/find', (function(_this) {
        return function() {
          var $sel;
          $sel = _this.$navItems.filter('.has-friends:first');
          if ($sel.length === 0) {
            $sel = _this.$navItems.filter('.-connected:first');
          }
          if ($sel.length !== 0) {
            return page.redirect("/" + ($sel.attr('data-nav')));
          } else {
            _this.resetBlocks();
            return $('.friends__not-connected', _this.$el).removeClass('-hidden');
          }
        };
      })(this));
      page('/:provider', (function(_this) {
        return function(ctx) {
          var provider;
          provider = ctx.params.provider;
          _this.toggleLoader(true);
          _this.setNavSelection(provider);
          _this.resetBlocks();
          return _this.regFriendsBlock.single('follow', function() {
            _this.changeNavFriendsIndicator(provider, -1);
            return _this.refreshNavFriendsIndicators();
          }).single('unfollow', function() {
            _this.changeNavFriendsIndicator(provider, 1);
            return _this.refreshNavFriendsIndicators();
          }).single('loaded:all', function(friends_total) {
            return _this.unregFriendsBlock.setProvider(provider);
          }).single('loaded:first', function(friends_total) {
            _this.toggleLoader(false);
            return _this.setNavFriendsIndicator(provider, friends_total);
          }).setProvider(provider);
        };
      })(this));
      page.base(pages.findFriends.Page.BASE_PATH);
      return page();
    };

    Page.prototype.initNav = function() {
      this.$navItems = $('.friends-source-panel .list__item, .who-to-follow .list__item', this.$el);
      this.$navItems.click((function(_this) {
        return function(e) {
          var $item, provider, success;
          $item = _this.$navItems.filter(e.currentTarget);
          provider = $item.attr('data-nav');
          if ($item.hasClass('provider') && !$item.hasClass('-connected')) {
            success = function() {
              $item.addClass('-connected');
              page("/" + provider);
              return Stats.track('find_friends_oa_connected', {
                provider: provider
              });
            };
            return new AuthDataProvider().addAuthFullCycle(AuthDataProvider.KIND[provider.toUpperCase()], Params.get('current_channel_id'), success, $.noop);
          } else {
            return page("/" + provider);
          }
        };
      })(this));
      this.navIndicators = _.reduce(this.$navItems.filter('.provider'), function(hash, el) {
        var $el;
        $el = $(el);
        hash[$el.attr('data-nav')] = parseInt($el.attr('data-friends-count'));
        return hash;
      }, {});
      return console.log(this.navIndicators);
    };

    Page.prototype.initBlocks = function() {
      this.regFriendsBlock = new pages.findFriends.RegisteredFriendsBlock($('.friends__registered', this.$el));
      this.unregFriendsBlock = new pages.findFriends.UnregisteredFriendsBlock($('.friends__unregistered', this.$el));
      return this.recommendedFriendsBlock = new pages.findFriends.RecommendedFriendsBlock($('.friends__recommened', this.$el));
    };

    Page.prototype.resetBlocks = function() {
      $('.friends__not-connected', this.$el).addClass('-hidden');
      this.regFriendsBlock.reset();
      this.unregFriendsBlock.reset();
      return this.recommendedFriendsBlock.reset();
    };

    Page.prototype.setNavFriendsIndicator = function(provider, count) {
      this.navIndicators[provider] = count;
      return this.$navItems.filter("[data-nav=" + provider + "]").toggleClass('has-friends', count > 0).children('.ind').html(count);
    };

    Page.prototype.refreshNavFriendsIndicators = function(followed) {
      clearTimeout(this.refreshNavTimeout);
      return this.refreshNavTimeout = setTimeout((function(_this) {
        return function() {
          return $.get(Routes.friends_per_provider_friends_path(), function(data) {
            var provider, results;
            results = [];
            for (provider in data) {
              results.push(_this.setNavFriendsIndicator(provider, data[provider]));
            }
            return results;
          });
        };
      })(this), 500);
    };

    Page.prototype.changeNavFriendsIndicator = function(provider, step) {
      var count;
      count = Math.max(this.navIndicators[provider] + step, 0);
      return this.setNavFriendsIndicator(provider, count);
    };

    Page.prototype.setNavSelection = function(provider) {
      return this.$navItems.removeClass('active').filter("[data-nav=" + provider + "]").addClass('active');
    };

    Page.prototype.toggleLoader = function(val) {
      if (val) {
        LoadRotator.removeFromContainer(this.$friends);
        return LoadRotator.appendToContainer(this.$friends);
      } else {
        return LoadRotator.removeFromContainer(this.$friends);
      }
    };

    return Page;

  })();

}).call(this);
(function() {
  pages.findFriends.FriendsBlockAbstract = (function() {
    function FriendsBlockAbstract(el) {
      this.$el = $(el);
      this.$list = $('.friends__list', this.$el);
      this.dataProvider = new PossibleFriendsDataProvider();
      this.data = {
        total_friends: 0,
        total_pages: 1,
        page: 1
      };
      this.xhr = {
        abort: $.noop,
        state: $.noop
      };
      this.initLoadOnScroll();
    }

    FriendsBlockAbstract.prototype.load = function() {
      throw 'Not Implemented';
    };

    FriendsBlockAbstract.prototype.reset = function() {
      this.xhr.abort();
      this.data = {
        total_friends: 0,
        total_pages: 0,
        page: 1
      };
      this.$el.addClass('-hidden');
      return this.$list.empty();
    };

    FriendsBlockAbstract.prototype.initLoadOnScroll = function() {
      var $document, $window;
      $document = $(document);
      $window = $(window);
      return $window.on('periodic_scroll.findFriendsPage', (function(_this) {
        return function() {
          var scroll;
          scroll = $window.scrollTop();
          if (_this.data.page + 1 > _this.data.total_pages || _this.xhr.state() === 'pending') {
            return;
          }
          if (!_this.$list.is(':visible') || scroll < _this.$list.offset().top + _this.$list.height() / 2 - $window.height()) {
            return;
          }
          _this.load(_this.data.page + 1);
          if (scroll >= $document.height() - $window.height() - 80) {
            return $window.scrollTop(scroll + 100);
          }
        };
      })(this));
    };

    FriendsBlockAbstract.prototype.renderList = function() {
      throw 'Not Implemented';
    };

    return FriendsBlockAbstract;

  })();

}).call(this);
(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  pages.findFriends.RecommendedFriendsBlock = (function(superClass) {
    extend(RecommendedFriendsBlock, superClass);

    function RecommendedFriendsBlock(el) {
      RecommendedFriendsBlock.__super__.constructor.apply(this, arguments);
      new utils.ObservableMixin(this);
      this.dataProvider = new dataProviders.ApiV2();
      this.perPage = 20;
    }

    RecommendedFriendsBlock.prototype.load = function(page) {
      var loaderCls, reqType;
      if (page == null) {
        page = 1;
      }
      this.xhr.abort();
      if (page === 1) {
        loaderCls = '-abs';
        reqType = 'initial';
      } else {
        loaderCls = 'small';
        reqType = 'next';
      }
      LoadRotator.appendToContainer(this.$list, loaderCls);
      this.xhr = this.dataProvider.getFriendshipsByType([], reqType, this.perPage);
      this.data.page = page;
      return this.xhr.always((function(_this) {
        return function() {
          return LoadRotator.removeFromContainer(_this.$list);
        };
      })(this)).fail(function(e) {
        if (e.status) {
          return Growl.msg(I18n.ERRORS.INTERNAL_SERVER_ERROR.SUB, I18n.ERRORS.INTERNAL_SERVER_ERROR.TRY_AGAIN);
        }
      }).done((function(_this) {
        return function(data) {
          _this.data.total_pages = data.friends.length < _this.perPage ? page : page + 1;
          _this.renderList(data.friends);
          if (page === 1) {
            _this.trigger('loaded:first');
            return Stats.track('find_friends_who_to_follow_loaded');
          }
        };
      })(this));
    };

    RecommendedFriendsBlock.prototype.renderList = function(friends) {
      var $block, friend, i, len, results;
      this.$el.removeClass('-hidden');
      results = [];
      for (i = 0, len = friends.length; i < len; i++) {
        friend = friends[i];
        $block = $(JST['app/site/templates/blocks/friendships_block/friendship_recommended_item']({
          friend: friend
        })).wrap('<div class="grid-col -col-one-half"></div>').parent().appendTo(this.$list);
        results.push(chms.utils.Autoinit.init(widgets.WidgetFollowButtonInit, $block));
      }
      return results;
    };

    return RecommendedFriendsBlock;

  })(pages.findFriends.FriendsBlockAbstract);

}).call(this);
(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  pages.findFriends.RegisteredFriendsBlock = (function(superClass) {
    extend(RegisteredFriendsBlock, superClass);

    function RegisteredFriendsBlock(el) {
      RegisteredFriendsBlock.__super__.constructor.apply(this, arguments);
      this.initFollows();
      new utils.ObservableMixin(this);
      new pages.findFriends.SearchFilter(this);
    }

    RegisteredFriendsBlock.prototype.setProvider = function(provider) {
      this.provider = provider;
      return this.load();
    };

    RegisteredFriendsBlock.prototype.load = function(page) {
      var isSearching, params;
      if (page == null) {
        page = 1;
      }
      this.xhr.abort();
      if (page > 1) {
        LoadRotator.appendToContainer(this.$list, 'small');
      }
      params = {
        provider: this.provider,
        per_page: 25,
        omit_following: true
      };
      $.extend(params, {
        q: this.data.search
      });
      this.xhr = this.dataProvider.showRegisteredFriends(page, params);
      this.data.page = page;
      isSearching = !!this.data.search;
      return this.xhr.always((function(_this) {
        return function() {
          clearTimeout(_this.data.retry_timeout);
          return LoadRotator.removeFromContainer(_this.$list);
        };
      })(this)).fail(function(e) {
        if (e.status) {
          return Growl.msg(I18n.ERRORS.INTERNAL_SERVER_ERROR.SUB, I18n.ERRORS.INTERNAL_SERVER_ERROR.TRY_AGAIN);
        }
      }).done((function(_this) {
        return function(data) {
          _this.data.total_pages = data.total_pages;
          _this.data.total_friends = data.total_friends;
          if (data.friends_fetching_flag) {
            _this.data.retry_timeout = setTimeout((function() {
              return _this.load();
            }), 5000);
            return;
          }
          if (page === 1) {
            _this.$list.empty();
          }
          _this.renderList(data.friends, data.total_friends, isSearching);
          if (!isSearching && !_this.data.triggered_all && page >= data.total_pages) {
            _this.data.triggered_all = true;
            _this.trigger('loaded:all', data.total_friends);
          }
          if (!isSearching && !data.triggered_first && page === 1) {
            _this.data.triggered_first = true;
            _this.trigger('loaded:first', data.total_friends);
            Stats.track('find_friends_friends_loaded', {
              provider: data.provider,
              total_friends: data.total_friends
            });
          }
          return _this.trigger('loaded', page);
        };
      })(this));
    };

    RegisteredFriendsBlock.prototype.renderList = function(friends, total_friends, isSearching) {
      var $item, i, item, len, results;
      this.$el.removeClass('-hidden');
      this.$followAllBtn.toggleClass('-hidden', friends.length <= 1).find('span').html(total_friends);
      if (!isSearching) {
        $('.friends__desc', this.$el).toggleClass('-hidden', friends.length !== 0);
        $('.filter__search', this.$el).toggleClass('-hidden', friends.length <= 1);
        $('.friends__filter', this.$el).toggleClass('-hidden', friends.length <= 1);
      }
      results = [];
      for (i = 0, len = friends.length; i < len; i++) {
        item = friends[i];
        $item = $(JST['app/site/templates/blocks/friendships_block/friendship_item']({
          friend: item
        })).wrap('<div class="grid-col -col-one-half" />').parent().appendTo(this.$list);
        results.push(chms.utils.Autoinit.init(widgets.WidgetFollowButtonInit, $item));
      }
      return results;
    };

    RegisteredFriendsBlock.prototype.reset = function() {
      RegisteredFriendsBlock.__super__.reset.apply(this, arguments);
      return this.$followAllBtn.toggleClass('follow-all--followed', false);
    };

    RegisteredFriendsBlock.prototype.initFollows = function() {
      var locked;
      this.$followAllBtn = $('.follow-all', this.$el);
      locked = false;
      this.$followAllBtn.click((function(_this) {
        return function() {
          var $followBtns, provider, total_friends;
          if (locked) {
            return;
          }
          _this.$followAllBtn.toggleClass('follow-all--followed', true);
          $followBtns = $('.-follow', _this.$el).trigger(widgets.FollowButton.ACTIONS.FOLLOW, true);
          locked = true;
          provider = _this.provider;
          total_friends = _this.data.total_friends;
          return _this.dataProvider.followAllFriendsFromProvider(provider, _this.data.search).fail(function() {
            _this.$followAllBtn.toggleClass('follow-all--followed', false);
            $followBtns.trigger(widgets.FollowButton.ACTIONS.UNFOLLOW, true);
            return Growl.msg(I18n.ERRORS.INTERNAL_SERVER_ERROR.SUB, I18n.ERRORS.INTERNAL_SERVER_ERROR.TRY_AGAIN);
          }).done(function() {
            return Stats.track('find_friends_follow_all_occured', {
              provider: provider,
              total_friends: total_friends
            });
          }).always(function() {
            return locked = false;
          });
        };
      })(this));
      this.$el.on(widgets.FollowButton.EVENTS.ELEMENT.FOLLOWED, (function(_this) {
        return function(e) {
          _this.trigger('follow');
          return Stats.track('find_friends_follow_occured', {
            provider: _this.provider,
            channel_id: e.targetId
          });
        };
      })(this));
      return this.$el.on(widgets.FollowButton.EVENTS.ELEMENT.UNFOLLOWED, (function(_this) {
        return function(e) {
          return _this.trigger('unfollow');
        };
      })(this));
    };

    return RegisteredFriendsBlock;

  })(pages.findFriends.FriendsBlockAbstract);

}).call(this);
(function() {
  pages.findFriends.SearchFilter = (function() {
    function SearchFilter(friendsBlock) {
      var $searchInput, inputTimeout;
      this.$form = $('.filter__search', friendsBlock.$el);
      this.$form.on('submit', function() {
        return false;
      });
      $searchInput = $('input.query', this.$form);
      inputTimeout = 0;
      $searchInput.on('input', (function(_this) {
        return function(e) {
          var val;
          val = $searchInput.val();
          clearTimeout(inputTimeout);
          _this.showLoader();
          if (val === '') {
            delete friendsBlock.data.search;
            friendsBlock.load();
            return;
          }
          return inputTimeout = _.delay(function() {
            friendsBlock.data.search = val;
            return friendsBlock.load();
          }, e.which === 13 && 1 || 500);
        };
      })(this));
      friendsBlock.on('loaded', (function(_this) {
        return function() {
          return _this.hideLoader();
        };
      })(this));
    }

    SearchFilter.prototype.showLoader = function() {
      if (this.$form.hasClass('searching')) {
        return;
      }
      this.$form.addClass('searching');
      return LoadRotator.appendToContainer(this.$form, 'tiny');
    };

    SearchFilter.prototype.hideLoader = function() {
      if (!this.$form.hasClass('searching')) {
        return;
      }
      this.$form.removeClass('searching');
      return LoadRotator.removeFromContainer(this.$form);
    };

    return SearchFilter;

  })();

}).call(this);
(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  pages.findFriends.UnregisteredFriendsBlock = (function(superClass) {
    extend(UnregisteredFriendsBlock, superClass);

    function UnregisteredFriendsBlock(el) {
      UnregisteredFriendsBlock.__super__.constructor.apply(this, arguments);
      this.initInvites();
      new utils.ObservableMixin(this);
      new pages.findFriends.SearchFilter(this);
    }

    UnregisteredFriendsBlock.prototype.setProvider = function(provider) {
      this.provider = provider;
      return this.load();
    };

    UnregisteredFriendsBlock.prototype.load = function(page) {
      var isSearching, params, ref;
      if (page == null) {
        page = 1;
      }
      this.xhr.abort();
      if ((ref = this.provider) === 'vkontakte' || ref === 'facebook') {
        this.$list.empty();
        this.renderList([], 1, false);
        return;
      }
      if (page > 1) {
        LoadRotator.appendToContainer(this.$list, 'small');
      }
      params = {
        provider: this.provider,
        per_page: 25,
        omit_marked_to_invite: true
      };
      if (this.provider === 'google') {
        params.omit_without_name = true;
      }
      $.extend(params, {
        q: this.data.search
      });
      this.xhr = this.dataProvider.showUnregisteredFriends(page, params);
      this.data.page = page;
      isSearching = !!this.data.search;
      return this.xhr.always((function(_this) {
        return function() {
          return LoadRotator.removeFromContainer(_this.$list);
        };
      })(this)).fail(function(e) {
        if (e.status) {
          return Growl.msg(I18n.ERRORS.INTERNAL_SERVER_ERROR.SUB, I18n.ERRORS.INTERNAL_SERVER_ERROR.TRY_AGAIN);
        }
      }).done((function(_this) {
        return function(data) {
          _this.data.total_pages = data.total_pages;
          _this.data.total_friends = data.total_friends;
          if (page === 1) {
            _this.$list.empty();
          }
          _this.renderList(data.friends, isSearching);
          return _this.trigger('loaded', page);
        };
      })(this));
    };

    UnregisteredFriendsBlock.prototype.renderList = function(friends, isSearching) {
      var $item, gravatar, i, item, len, results;
      if (!isSearching) {
        this.$el.toggleClass('-hidden', friends.length === 0);
        $('.filter__search', this.$el).toggleClass('-hidden', friends.length <= 1);
      }
      results = [];
      for (i = 0, len = friends.length; i < len; i++) {
        item = friends[i];
        $item = $(JST['app/site/templates/blocks/friendships_block/friendship_invite_item']({
          friend: item
        })).wrap('<div class="grid-col -col-one-half" />').parent().appendTo(this.$list);
        if (gravatar = $item.find('.invite-item:first').attr('data-gravatar')) {
          results.push($('<img />').load(function() {
            return $('.object-media__img', $item).css('background-image', "url(" + gravatar + ")");
          }).attr('src', gravatar));
        } else {
          results.push(void 0);
        }
      }
      return results;
    };

    UnregisteredFriendsBlock.prototype.initInvites = function() {
      var $window;
      $window = $(window);
      this.$el.find('.invite-all').click((function(_this) {
        return function() {
          var params, ref;
          if ((ref = _this.provider) === 'vkontakte' || ref === 'facebook') {
            return;
          }
          params = _this.provider === 'google' && {
            omit_without_name: true
          } || void 0;
          _this.dataProvider.inviteAllFriendsFromProvider(_this.provider, params).fail(function() {
            return Growl.msg(I18n.ERRORS.INTERNAL_SERVER_ERROR.SUB, I18n.ERRORS.INTERNAL_SERVER_ERROR.TRY_AGAIN);
          });
          return _this.$el.fadeOut(function() {
            return $(this).addClass('-hidden').css('display', '');
          });
        };
      })(this));
      return this.$list.on('click', '.invite', (function(_this) {
        return function(e) {
          var $el, ref;
          if ((ref = _this.provider) === 'vkontakte' || ref === 'facebook') {
            return;
          }
          $el = $(e.currentTarget);
          $el.closest('.grid-col').fadeOut(function() {
            $(this).remove();
            return $window.trigger('scroll');
          });
          _this.dataProvider.inviteFriends([$el.attr('data-friendship-id')]).fail(function() {
            return Growl.msg(I18n.ERRORS.INTERNAL_SERVER_ERROR.SUB, I18n.ERRORS.INTERNAL_SERVER_ERROR.TRY_AGAIN);
          });
          if (--_this.data.total_friends === 0) {
            return _this.$el.fadeOut(function() {
              return $(this).addClass('-hidden').css('display', '');
            });
          }
        };
      })(this));
    };

    return UnregisteredFriendsBlock;

  })(pages.findFriends.FriendsBlockAbstract);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.ChangePasswordForm = (function(superClass) {
    extend(ChangePasswordForm, superClass);

    ChangePasswordForm.EVENTS = {
      CHANGED: "ChangePasswordForm:Changed"
    };

    function ChangePasswordForm(opts) {
      this.hided = bind(this.hided, this);
      this.change = bind(this.change, this);
      ChangePasswordForm.__super__.constructor.apply(this, arguments);
      this.provider = new dataProviders.ApiV2();
      this.form = $("form", this.el);
      this.form.on('submit', (function(_this) {
        return function(e) {
          e.preventDefault();
          e.stopPropagation();
          if (_this.form.valid()) {
            return _this.change();
          }
        };
      })(this));
      this.form.validate({
        rules: {
          "user[password]": {
            required: true
          },
          "user[password_changing]": {
            required: true,
            normalOrStrongPassword: true
          },
          onsubmit: false
        },
        errorPlacement: (function(_this) {
          return function(error, element) {
            return null;
          };
        })(this)
      });
      this.oldPasswordInput = $("input[name='user[password]']", this.el);
      this.newPasswordInput = $("input[name='user[password_changing]']", this.el);
      new AuthPopup.Handlers.PasswordStrengthChecker({
        el: this.newPasswordInput.parent()
      });
    }

    ChangePasswordForm.prototype.change = function() {
      this.hideError();
      return this.provider.updateUserPrivateSettings(this.form.serialize(), {
        success: (function(_this) {
          return function(data) {
            _this.el.trigger(Popup.ACTION_CLOSE);
            return Growl.succ(I18n.t("profile.edit.saved_successfull.header"), I18n.t("profile.edit.saved_successfull.message"));
          };
        })(this),
        error: (function(_this) {
          return function(data) {
            if (data.status === 422) {
              _this.oldPasswordInput.addClass("error");
              return _this.showError(I18n.PROFILE.ERRORS.PASSWORD_INCORECT);
            } else {
              return Growl.msg(I18n.ERRORS.INTERNAL_SERVER_ERROR.SUB, I18n.ERRORS.INTERNAL_SERVER_ERROR.TRY_AGAIN);
            }
          };
        })(this)
      });
    };

    ChangePasswordForm.prototype.hided = function() {
      ChangePasswordForm.__super__.hided.apply(this, arguments);
      return this.el.remove();
    };

    return ChangePasswordForm;

  })(ChangeConfirmPasswordAbstractDialog);

}).call(this);
(function() {
  $.Controller('Header', {
    init: function() {
      this.page = $('.page-container');
      this.searchContainer = this.element.find('.header__search');
      this.input = this.searchContainer.find('input[type=text]');
      this.element.find('form').on('submit', (function(_this) {
        return function() {
          if (_this.input.val().indexOf('%') !== -1) {
            return _this.input.val(encodeURIComponent(_this.input.val()));
          }
        };
      })(this));
      this.input.on('click', function() {
        return this.select();
      });
      this.initCreateDropdown();
      if (GlobalState.USER.isLogedIn()) {
        return this.initChatsCounter();
      }
    },
    initChatsCounter: function() {
      var cable, counter, currentUserId, disconnect, el, isDisconnected, reconnect, timeoutId;
      if (window.env === 'development') {
        return;
      }
      el = $('.header__channel-chat-button .badge-counter', this.element);
      if (!el.length) {
        return;
      }
      counter = new widgets.Counter(el, helpers.Application.roundToK);
      isDisconnected = false;
      timeoutId = null;
      cable = window.ActionCable.createConsumer("wss://chat.coub.com/cable?token=" + window.chat_token);
      currentUserId = GlobalState.USER.getCurrentUserId();
      cable.subscriptions.create({
        channel: 'UserCable',
        id: currentUserId
      }, {
        received: (function(_this) {
          return function(data) {
            if (data.event === 'unread_chats') {
              counter.el.removeClass("-dot");
              return counter.setValue(data.count);
            } else if (data.event === 'unread_join_requests' && counter.getValue() === 0) {
              counter.el.addClass("-dot");
              return counter.setValue(1);
            }
          };
        })(this)
      });
      disconnect = (function(_this) {
        return function() {
          if (isDisconnected) {
            return;
          }
          console.log('action cable disconnect');
          isDisconnected = true;
          return cable.subscriptions.consumer.disconnect();
        };
      })(this);
      reconnect = (function(_this) {
        return function() {
          if (!isDisconnected) {
            return;
          }
          console.log('action cable reconnect');
          isDisconnected = false;
          return cable.subscriptions.consumer.connect();
        };
      })(this);
      window.onblur = (function(_this) {
        return function() {
          clearTimeout(timeoutId);
          return timeoutId = setTimeout(disconnect, 5000);
        };
      })(this);
      return window.onfocus = (function(_this) {
        return function() {
          clearTimeout(timeoutId);
          return timeoutId = setTimeout(reconnect, 3000);
        };
      })(this);
    },
    initCreateDropdown: function() {
      var createButton;
      createButton = $(".header__nav .nav__item.create", this.element);
      return new window.HoverableAbsoluteDropdown({
        el: createButton,
        classNames: "header__create-dropdown",
        defaultContent: JST["app/site/templates/blocks/header/create_dropdown_content"](),
        handle: createButton,
        handlerEventOpen: "mouseenter",
        dropdownPosition: AbsoluteDropdown.POSITION_TYPE.ABSOLUTE_BOTTOM,
        handlerEventClose: HoverableAbsoluteDropdown.EVENTS.MOUSEOUT_TIMEOUT,
        hideTimeout: 150,
        animationDuration: 1
      });
    }
  });

  window.Header.isProfilePanelVisible = function() {
    var heroCoverHeight;
    heroCoverHeight = $('.hero-cover__content-box').height() / 2;
    if (!heroCoverHeight) {
      return false;
    }
    return $(window).scrollTop() > heroCoverHeight;
  };

}).call(this);
(function() {
  if (typeof I18n === "undefined" || I18n === null) {
    window.I18n = {};
  }

  window.I18n.template = function(localeStr) {
    var fn;
    fn = function(vals) {
      var i, str;
      str = this;
      for (i in vals) {
        str = str.replace('%{' + i + '}', vals[i]);
      }
      return str;
    };
    return fn.bind(localeStr);
  };

  window.I18n.ERRORS = {
    INTERNAL_SERVER_ERROR: {
      SUB: "An unexpected error occurred.",
      TRY_AGAIN: "We are working to solve this issue.<br />Please try again later."
    },
    AUTH_FAILED: {
      HEADER: "Authorization failed",
      SUB: "It seems, that you cancelled authorization process. Please, try again."
    },
    too_fast: {
      follow: 'You are following too fast',
      like: 'You are liking too fast',
      recoub: 'You are reposting too fast',
      slow_down: 'Please slow down'
    }
  };

  window.I18n.CREATE = {
    VIDEO_UPLOAD_ERRORS: {
      CANT_READ: "We could not read this file.",
      EXCEEEDS_DURATION: "Videos must be 20 minutes or shorter."
    },
    MESSAGES: {
      SAVE_SUCCESS: {
        TITLE: "Saved!",
        MESSAGE: "Your coub saved successfuly"
      },
      SAVE_ERROR: {
        TITLE: "Error while saving!",
        MESSAGE: "Error while saving occurred. Try to reload editor."
      }
    }
  };

  window.I18n.CUSTOMIZE_POPUP = {
    AFTER_CREATE: {
      TAGS_PLACEHOLDER: "Use comma or press Enter to separate tags"
    },
    SIMPLE_EDIT: {
      MESSAGE_AFTER_SAVE: {
        HEADER: "Done!",
        MESSAGE: "The changes have been saved."
      }
    },
    ERROR_MESSAGES: {
      TITLE_REQUIRED: "Please write a caption for your coub.",
      TITLE_TOO_LONG: "You've exceeded the 140 character limit."
    }
  };

  window.I18n.AUTH_POPUP = {
    BUTTONS: {
      VIEW_MORE: "Show more",
      VIEW_LESS: "Show fewer"
    }
  };

  window.I18n.PROFILE = {
    ERRORS: {
      PASSWORD_INCORECT: "The password is incorrect",
      EMAIL_IS_INVALID: "Incorrect email",
      EMAIL_IS_REGISTERED: "This email is already registered",
      PERMALINK_UNAVAILABLE: "This URL is unavailable",
      PERMALINK_TOO_SHORT: "The URL must be at least 8 characters long",
      PERMALINK_INVALID: "Use only a-z, 0-9, period (.), or hyphen (-)",
      PERMALINK_ENDS_WITH_DOT: "URL must not end with the dot symbol"
    },
    ADD_COVER: "Edit cover"
  };

  window.I18n.FIND_FRIENDS = {
    INVITE: {
      FACEBOOK: {
        INVITE_MESSAGE: "Join Coub, man"
      }
    }
  };

  window.I18n.sharing = {
    share_vk_short: "VK",
    share_tweeter_short: "Tweet"
  };

  window.I18n.editor = {
    pane: "Editor Control Pane",
    search_tags_pane: "Search Tags Pane",
    editors_stats: "Editors stats",
    banners_page: "translation missing: en.editor.banners_page",
    avatar_moderation: "Avatar Moderation",
    background_moderation: "Background moderation",
    weekly_digests: "Weekly Digests",
    saved_users: "Saved users",
    explore_queue: "Explore queue"
  };

  window.I18n.stats = {
    pane: "Stats pane"
  };

  window.I18n.admin = {
    pane: "Admin Control Pane"
  };

  window.I18n.embed = {
    get_app: "Get app",
    get_app_ru: "Скачать приложение",
    open_in_app: "Open in app",
    open_in_app_ru: "Открыть в приложении",
    views: "views",
    views_count: I18n.template("%{count} views"),
    views_singular_ru: "просмотр",
    views_plural_ru: "просмотров",
    views_double_ru: "просмотра",
    unmute: "Click to Unmute",
    unmute_ru: "Включить звук",
    back: "Back",
    by: I18n.template("by %{link}"),
    video_source: "Original video",
    share_ru: "Поделиться",
    site_name: "Coub",
    hd: "HD",
    open_on_coub: "Open on Coub",
    restart: "Restart",
    edit_coub: "Edit coub",
    edit_info: "Edit info",
    add_community: "Add to community",
    change_community: "Change community",
    delete_coub: "Delete coub",
    download_loops: "Download loops",
    promote_coub: "Promote coub",
    sharing: {
      download: "Download",
      loading: "Loading...",
      facebook: "Facebook",
      twitter: "Twitter",
      vkontakte: "VKontakte",
      more: "More..."
    },
    tooltips: {
      favourites_add: "Bookmark",
      favourites_remove: "Bookmarked",
      fullscreen_on: "Fullscreen",
      fullscreen_off: "Exit fullscreen",
      share: "Share",
      logo: "Watch on coub.com",
      hd_on: "Turn HD on",
      hd_off: "Turn HD off",
      audio_failed: "MP3 is not supported",
      settings: "Settings"
    },
    copy_link: {
      copy: "Copy link",
      copied: "Copied!",
      failed_to_copy: "Can't copy:("
    },
    social_names: {
      facebook: "Facebook",
      twitter: "Twitter",
      messenger: "Messenger",
      watsapp: "WhatsApp",
      link: "Link"
    }
  };

  window.I18n.growl_errors = {
    reload: {
      header: "Page error",
      error: "Please reload this page"
    }
  };

  window.I18n.follow_confirmation = {
    confirm: "Confirm channel following"
  };

  window.I18n.notifications = {
    follow: {
      is_now_following_suffix: 'is now following you',
      follow_back_suffix: 'followed you back'
    },
    likes_recoubs: {
      likes: "You liked %{count} from this channel",
      recoubs: "You recoubed %{count} from this channel",
      likes_recoubs: "You liked & recoubed %{count} coubs from this channel"
    }
  };

  window.I18n.site_notifications = {
    kinds: {
      sn_friend_follow: 'Your %{sn} friend %{nickname} is now following you as %{channel}',
      sn_friend_registered: 'Your %{sn} friend %{nickname} just joined Coub as %{channel}',
      sn_friend_follow_equal_name: 'Your %{sn} friend %{nickname} is now following you',
      sn_friend_registered_equal_name: 'Your %{sn} friend %{nickname} just joined Coub'
    }
  };

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.CustomActionAbstractLink = (function() {
    CustomActionAbstractLink.prototype.SELECTOR = null;

    function CustomActionAbstractLink() {
      this.makeAction = bind(this.makeAction, this);
      if (!this.SELECTOR) {
        throw "CustomActionAbstractLink: you need to override SELECTOR";
      }
      $(this.SELECTOR).live("click", {
        obj: this
      }, this.click);
    }

    CustomActionAbstractLink.prototype.click = function(event) {
      var el, isOpenInNewTab, link, mobile;
      isOpenInNewTab = event.metaKey || event.ctrlKey;
      mobile = GlobalState.PLATFORM.isMobile();
      el = $(this);
      link = el.attr("href");
      if (!isOpenInNewTab) {
        event.preventDefault();
      }
      return event.data.obj.makeAction({
        el: el,
        link: link,
        newTab: isOpenInNewTab,
        mobile: mobile
      });
    };

    CustomActionAbstractLink.prototype.makeAction = function(opts) {
      throw "CustomActionAbstractLink: override makeAction method";
    };

    return CustomActionAbstractLink;

  })();

}).call(this);
(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.CoubPageRemixLink = (function(superClass) {
    extend(CoubPageRemixLink, superClass);

    function CoubPageRemixLink() {
      return CoubPageRemixLink.__super__.constructor.apply(this, arguments);
    }

    CoubPageRemixLink.prototype.SELECTOR = '.media-block__item.coub__recoub-block a[type="coub-url"]';

    CoubPageRemixLink.prototype.makeAction = function(opts) {
      if (opts.link && !opts.newTab && History.enabled && !opts.mobile) {
        return History.pushState({}, '', opts.link);
      }
    };

    return CoubPageRemixLink;

  })(CustomActionAbstractLink);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.CoubPageSuggestLink = (function(superClass) {
    extend(CoubPageSuggestLink, superClass);

    function CoubPageSuggestLink() {
      this.makeAction = bind(this.makeAction, this);
      return CoubPageSuggestLink.__super__.constructor.apply(this, arguments);
    }

    CoubPageSuggestLink.LINK_SELECTOR = 'a[type="coubSuggest"]';

    CoubPageSuggestLink.prototype.SELECTOR = '.suggests a[type="coubSuggest"], .channel-coubs a[type="coubSuggest"]';

    CoubPageSuggestLink.prototype.makeAction = function(opts) {
      var $suggest, path, title;
      if (opts.link) {
        $suggest = opts.el.closest('.suggest__item');
        if ($suggest.hasClass('disabled')) {
          return;
        }
        if (!this.clickCounter) {
          this.clickCounter = 0;
        }
        this.clickCounter++;
        $suggest.addClass('clicked');
        title = $suggest.find('.suggest__item-stamp .hbold').text();
        if (!opts.newTab && History.enabled) {
          if (!opts.mobile) {
            History.pushState({}, title, opts.link);
            path = "" + document.location.pathname + document.location.search;
            ga('send', 'pageview', path);
            console.log("[DEBUG]", "pageview!", path);
          } else {
            window.location = opts.link;
          }
        }
        if ($suggest.length) {
          return window.ym && ym(48571952, "reachGoal", "to_relativecoubs");
        } else if (opts.el.hasClass("channel-coubs__item")) {
          return window.ym && ym(48571952, "reachGoal", "to_morefromauthor");
        }
      }
    };

    return CoubPageSuggestLink;

  })(CustomActionAbstractLink);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.EmbedPopupLink = (function(superClass) {
    extend(EmbedPopupLink, superClass);

    function EmbedPopupLink() {
      this.makeAction = bind(this.makeAction, this);
      return EmbedPopupLink.__super__.constructor.apply(this, arguments);
    }

    EmbedPopupLink.prototype.SELECTOR = 'a[type="embedPopup"]';

    EmbedPopupLink.prototype.makeAction = function(opts) {
      if (opts.link && !opts.newTab) {
        return OEmbedPopupHelper.show(opts.link, "", opts.el.attr("source"), opts.el.attr('data-button-title'));
      }
    };

    return EmbedPopupLink;

  })(CustomActionAbstractLink);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.PromoteCoubLink = (function(superClass) {
    extend(PromoteCoubLink, superClass);

    function PromoteCoubLink() {
      this.makeAction = bind(this.makeAction, this);
      return PromoteCoubLink.__super__.constructor.apply(this, arguments);
    }

    PromoteCoubLink.prototype.SELECTOR = 'a[type="promoteCoub"]';

    PromoteCoubLink.prototype.makeAction = function(opts) {
      var id, p;
      if (p = opts.el.attr('data-coub-permalink')) {
        this.onPopupOpen();
        return new pages.PromotedCoubForm({
          coubPermalink: p
        }).one(pages.PromotedCoubForm.EVENTS.CLOSED, this.onPopupClose);
      } else if (id = opts.el.attr('data-promoted-id')) {
        this.onPopupOpen();
        return new pages.PromotedCoubDetails(id).one(pages.PromotedCoubDetails.EVENTS.CLOSED, this.onPopupClose);
      }
    };

    PromoteCoubLink.prototype.onPopupOpen = function() {
      return $(document).trigger("flash_player:suspend");
    };

    PromoteCoubLink.prototype.onPopupClose = function() {
      this.destroy();
      return $(document).trigger("flash_player:play");
    };

    return PromoteCoubLink;

  })(CustomActionAbstractLink);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.LoopTimer = (function() {
    function LoopTimer($coubViewer, $timer) {
      this.stopTimer = bind(this.stopTimer, this);
      this.startTimer = bind(this.startTimer, this);
      this.vb = $coubViewer.find('.viewer');
      this.input = $timer.find('.loop__num');
      this.rotationBg = $timer.find('.loop__pic');
      this.durationMs = $timer.attr('data-coub-duration') * 1000;
      this.vb.on(Player.EVENT_PLAYING, this.startTimer).on(Player.EVENT_PAUSED, this.stopTimer).on('suspend', this.stopTimer);
    }

    LoopTimer.prototype.startTimer = function() {
      clearInterval(this.interval);
      this.startTime = new Date().valueOf();
      return this.interval = setInterval(this.update.bind(this), 300);
    };

    LoopTimer.prototype.stopTimer = function() {
      return clearInterval(this.interval);
    };

    LoopTimer.prototype.update = function() {
      var diff, loopsCount, loopsCountStr, prevLoopsCount;
      diff = new Date().valueOf() - this.startTime;
      loopsCount = Math.floor(diff / this.durationMs);
      if (loopsCount <= 99) {
        loopsCountStr = loopsCount < 10 ? "0" + loopsCount : loopsCount.toString();
        prevLoopsCount = this.input.html();
        if (loopsCountStr !== prevLoopsCount) {
          this.input.html(loopsCountStr);
          this.input.removeClass('-infinity');
          return this.rotationBg.addClass('-rotate');
        } else {
          return this.rotationBg.removeClass('-rotate');
        }
      } else {
        this.input.addClass('-infinity').html('');
        return this.vb.off(Player.EVENT_PLAYING, this.startTimer).off(Player.EVENT_PAUSED, this.stopTimer).off('suspend', this.stopTimer);
      }
    };

    return LoopTimer;

  })();

}).call(this);
(function() {
  window.CoubMainMenu = (function() {
    CoubMainMenu.EVENTS = {
      COMMUNITY_CLICKED: 'Event.CoubMainMenuCommunityClicked'
    };

    CoubMainMenu.ACTIONS = {
      COMMUNITY_SELECT: 'Action.CoubMainMenuCommunitySelect'
    };

    CoubMainMenu.FOLD_COOKIE_KEY = 'coub_main_menu_fold';

    function CoubMainMenu() {
      this.el = $('.main-menu');
      if (!this.el.length) {
        return;
      }
      this.s = this.constructor;
      this.body = $('body');
      this.communityItems = $('.main-menu__community-item', this.el);
      if (GlobalState.USER.isLogedIn()) {
        this.communitiesService = new functions.CommunitiesService();
        this.initCommunitiesChange();
      }
      this.initOverlayMode();
      this.initMoreLessToggler($('.main-menu__nav-item.more-less-toggler', this.el).first(), $('.main-menu__nav-hidden', this.el));
      this.initCommunitiesClick();
      this.initCommunitiesSelect();
      this.initThemeChange();
      this.initFolding();
      this.initResize();
    }

    CoubMainMenu.prototype.initMoreLessToggler = function(toggler, hiddenContainer) {
      var isShowed;
      isShowed = false;
      return toggler.click((function(_this) {
        return function() {
          isShowed = !isShowed;
          toggler.toggleClass('-more', !isShowed);
          return hiddenContainer.toggleClass('-hidden', !isShowed);
        };
      })(this));
    };

    CoubMainMenu.prototype.initOverlayMode = function() {
      var hide, hideTimeoutId, logo, shade;
      logo = $('.header__logo', 'header.header');
      shade = $('.main-menu__shade', this.el);
      hideTimeoutId = null;
      hide = (function(_this) {
        return function() {
          _this.el.removeClass('-visible');
          return _this.body.removeClass('disable-scroll');
        };
      })(this);
      logo.mouseover((function(_this) {
        return function() {
          if (_this.el.hasClass('-always-visible') && window.innerWidth < 1280 && !_this.el.hasClass('-visible') || !_this.el.hasClass('-always-visible') || _this.el.hasClass('-folded')) {
            _this.el.addClass('-visible');
            _this.body.addClass('disable-scroll');
            return _this.resize();
          }
        };
      })(this));
      shade.mouseover((function(_this) {
        return function() {
          return hideTimeoutId = setTimeout(hide, 300);
        };
      })(this));
      return shade.mouseleave((function(_this) {
        return function() {
          return clearTimeout(hideTimeoutId);
        };
      })(this));
    };

    CoubMainMenu.prototype.initCommunitiesChange = function() {
      var changeOffState, onCommunitiesChanged, onCommunitiesUnsubscribeFailed, onSwitcherClick;
      changeOffState = (function(_this) {
        return function(communityId, isOn, disable) {
          return _this.communityItems.filter("[data-community-id=" + communityId + "]").each(function(i, item) {
            $(item).toggleClass('off', !isOn);
            return $('.switcher', item).toggleClass('-off', !isOn).toggleClass('disabled', !!disable).trigger({
              type: Prompt.EVENT_CHANGE_TEXT,
              content: isOn ? I18n.t('trends.prompts.unsubscribe') : I18n.t('trends.prompts.subscribe')
            });
          });
        };
      })(this);
      onCommunitiesChanged = (function(_this) {
        return function(communityId, isOn) {
          changeOffState(communityId, isOn);
          if (!isOn) {
            return;
          }
          return $(".switcher", _this.communityItems).removeClass("disabled");
        };
      })(this);
      onCommunitiesUnsubscribeFailed = (function(_this) {
        return function(communityId) {
          return changeOffState(communityId, true, true);
        };
      })(this);
      onSwitcherClick = (function(_this) {
        return function(e) {
          var $communityItem, communityId, isOff;
          e.preventDefault();
          e.stopPropagation();
          $communityItem = $(e.currentTarget).parent();
          communityId = $communityItem.attr('data-community-id');
          isOff = $communityItem.hasClass("off");
          return _this.communitiesService.toggle(communityId, isOff);
        };
      })(this);
      this.communitiesService.on(functions.CommunitiesService.EVENTS.CHANGE_STARTED, onCommunitiesChanged);
      this.communitiesService.on(functions.CommunitiesService.EVENTS.UNSUBSRIBE_FAILED, onCommunitiesUnsubscribeFailed);
      return $('.switcher', this.communityItems).click(onSwitcherClick);
    };

    CoubMainMenu.prototype.initCommunitiesClick = function() {
      return this.communityItems.click((function(_this) {
        return function(e) {
          var communityId, communityPermalink, item;
          if (e.metaKey || e.ctrlKey || $(e.target).hasClass('page-reload')) {
            return;
          }
          e.preventDefault();
          item = $(e.currentTarget);
          if (item.hasClass('active')) {
            return;
          }
          communityPermalink = item.attr('data-community-permalink');
          communityId = parseInt(item.attr('data-community-id'));
          return _this.el.triggerHandler(_this.s.EVENTS.COMMUNITY_CLICKED, [communityPermalink, communityId]);
        };
      })(this));
    };

    CoubMainMenu.prototype.initCommunitiesSelect = function() {
      return this.el.on(this.s.ACTIONS.COMMUNITY_SELECT, (function(_this) {
        return function(e, communityPermalink) {
          return _this.communityItems.removeClass('active').filter("[data-community-permalink=" + communityPermalink + "]").addClass('active');
        };
      })(this));
    };

    CoubMainMenu.prototype.initThemeChange = function() {
      return $('.main-menu__change-theme .switcher', this.el).click(function() {
        var isOff;
        isOff = $(this).hasClass('-off');
        $.cookie('dark_theme_enabled', isOff, {
          path: '/',
          expires: 365 * 5
        });
        $(this).toggleClass('-off');
        return window.location.reload();
      });
    };

    CoubMainMenu.prototype.initResize = function() {
      return $(window).resize(_.debounce((function(_this) {
        return function() {
          return _this.resize();
        };
      })(this), 100));
    };

    CoubMainMenu.prototype.resize = function() {
      return $('.hasScroller', this.el).nice_scroller();
    };

    CoubMainMenu.prototype.initFolding = function() {
      var foldButton, isFolded;
      foldButton = $('.main-menu__fold', this.el);
      isFolded = this.el.hasClass('-folded');
      return foldButton.click((function(_this) {
        return function() {
          isFolded = !isFolded;
          _this.body.removeClass('disable-scroll');
          _this.el.removeClass('-visible').toggleClass('-folded', isFolded);
          $.cookie(_this.s.FOLD_COOKIE_KEY, isFolded, {
            expires: 1,
            path: '/'
          });
          if (GlobalState.PAGE.isProfile()) {
            return _this.triggerResizeWithTimeout(150);
          }
        };
      })(this));
    };

    CoubMainMenu.prototype.triggerResizeWithTimeout = function(timeout) {
      var isResizing, triggerResize;
      isResizing = true;
      triggerResize = (function(_this) {
        return function() {
          $(window).trigger('resize');
          if (isResizing) {
            return requestAnimationFrame(triggerResize);
          }
        };
      })(this);
      setTimeout((function(_this) {
        return function() {
          return isResizing = false;
        };
      })(this), timeout);
      return triggerResize();
    };

    return CoubMainMenu;

  })();

}).call(this);
(function() {
  window.CoubPageMenu = (function() {
    function CoubPageMenu() {
      this.el = $('.page-menu');
      if (!this.el.length) {
        return;
      }
      this.initHiddenItemsDropdown();
      this.initItemsHover();
    }

    CoubPageMenu.prototype.initHiddenItemsDropdown = function() {
      var dropdown;
      dropdown = $('.page-menu__more-items', this.el);
      return this.el.on('click', dropdown.selector + " .page-menu__item", (function(_this) {
        return function(e) {
          var lastHorElement;
          lastHorElement = $('.page-menu__item:not(.list__item):last', _this.el).get(0);
          e.currentTarget.classList.remove('list__item', 'list__item-beta');
          lastHorElement.classList.add('list__item', 'list__item-beta');
          _this.swapElements(e.currentTarget, lastHorElement);
          return dropdown.triggerHandler('hide');
        };
      })(this));
    };

    CoubPageMenu.prototype.initItemsHover = function() {
      var items, menuInner;
      menuInner = $('.page-menu__inner:first', this.el);
      items = $('> .page-menu__item', menuInner);
      menuInner.on('mouseover', items.selector, (function(_this) {
        return function(e) {
          var target;
          target = $(e.currentTarget);
          $(items.selector).removeClass('-hovered');
          target.addClass('-hovered');
          return menuInner.addClass('-mouse-over');
        };
      })(this));
      return menuInner.on('mouseleave', items.selector, (function(_this) {
        return function(e) {
          $(items.selector).removeClass('-hovered');
          return menuInner.removeClass('-mouse-over');
        };
      })(this));
    };

    CoubPageMenu.prototype.swapElements = function(el1, el2) {
      var next1, next2, parent1, parent2;
      parent1 = el1.parentNode;
      next1 = el1.nextSibling;
      parent2 = el2.parentNode;
      next2 = el2.nextSibling;
      parent1.insertBefore(el2, next1);
      return parent2.insertBefore(el1, next2);
    };

    return CoubPageMenu;

  })();

}).call(this);
(function() {
  window.CoubModal = {
    createPopup: function(data) {
      var popup, template;
      if (!data.type) {
        data.type = 'simple';
      }
      template = $(this.getTemplate(data));
      $("body").append(template);
      popup = new Popup({
        el: template,
        removeOnClose: data.removeOnClose
      });
      popup.show();
      return popup;
    },
    getTemplate: function(data) {
      var classes;
      classes = '';
      if (data.footer === void 0) {
        data.footer = "";
      }
      if (data.classes != null) {
        classes += data.classes;
      }
      if (data.type != null) {
        classes += " modal--" + data.type;
      }
      data.classes = classes;
      return $(JST["app/site/templates/modal_popup/modal_popup"](data));
    }
  };

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.EmbedPopup = (function(superClass) {
    extend(EmbedPopup, superClass);

    EmbedPopup.prototype.EVENT_CONTENT_UPDATED = "EmbedPopup::Events::ModalContentUpdated";

    EmbedPopup.prototype.LOADING_CLASS = "modal--loading";

    function EmbedPopup(opts) {
      if (opts == null) {
        opts = {};
      }
      this.animateExpand = bind(this.animateExpand, this);
      this.afterClose = bind(this.afterClose, this);
      this.setLoading = bind(this.setLoading, this);
      this.getFooterLayout = bind(this.getFooterLayout, this);
      this.setFooter = bind(this.setFooter, this);
      this.setContent = bind(this.setContent, this);
      this.render = bind(this.render, this);
      if ((opts.showMacButton != null) && (opts.source != null)) {
        this.showMacButton = opts.showMacButton;
        this.macButtonUrl = opts.source;
      } else {
        this.showMacButton = false;
      }
      this.buttonText = opts.buttonTitle;
      EmbedPopup.__super__.constructor.apply(this, arguments);
    }

    EmbedPopup.prototype.render = function() {
      var s;
      return s = EmbedPopup.__super__.render.apply(this, arguments).addClass("embed-popup");
    };

    EmbedPopup.prototype.setContent = function(content) {
      var $content, h, w;
      $content = $(content);
      if ($content.is('iframe')) {
        w = $content.attr('width');
        h = $content.attr('height');
        $content.addClass('-fill');
      }
      this.rendered.find(".modal__body").css({
        position: 'relative',
        paddingTop: w && h && helpers.Coub.aspectRatio(w, h).percent
      }).html($content);
      if (this.buttonText) {
        this.rendered.find(".make-coub").text(this.buttonText);
      }
      this.rendered.find(".make-coub.disabled").on('click', function() {
        return false;
      });
      return $(document).trigger(this.EVENT_CONTENT_UPDATED, [this.getLayout()]);
    };

    EmbedPopup.prototype.setFooter = function(content) {
      if (content !== "") {
        return this.rendered.find(".modal__footer").html(this.getFooterLayout(content));
      } else {
        return this.rendered.find(".modal__footer").html("");
      }
    };

    EmbedPopup.prototype.getFooterLayout = function(title) {
      var button;
      if (this.showMacButton) {
        button = JST["app/site/templates/widgets/make_another_coub_button/make_another_coub_button"]({
          url: this.macButtonUrl,
          classes: ''
        });
        return button;
      } else {
        return "";
      }
    };

    EmbedPopup.prototype.setLoading = function(value) {
      if (value === true) {
        this.get().addClass(this.LOADING_CLASS);
        return LoadRotator.appendToContainterAndStart(this.getContentContainer());
      } else {
        LoadRotator.removeFromContainer(this.getContentContainer());
        return this.get().removeClass(this.LOADING_CLASS);
      }
    };

    EmbedPopup.prototype.afterClose = function() {
      EmbedPopup.__super__.afterClose.apply(this, arguments);
      $(document).trigger("flash_player:play");
      return this.setLoading(false);
    };

    EmbedPopup.prototype.animateExpand = function() {
      if (!this.animator) {
        this.animator = new CoubAnimators.EmbedPopupAnimator(this);
      }
      return this.animator.animate(CoubAnimators.EmbedPopupAnimator.ACTIONS.EXPAND);
    };

    EmbedPopup.show = function(data, source) {
      var popup;
      if (source != null) {
        popup = new EmbedPopup({
          showMacButton: true,
          source: source,
          buttonTitle: data.buttonTitle
        });
      } else {
        popup = new EmbedPopup();
      }
      Stats.track('embed_popup_showed');
      if (popup.appendToBody(popup.render(data))) {
        $(document).trigger("flash_player:suspend");
        return popup;
      } else {
        return null;
      }
    };

    return EmbedPopup;

  })(ModalPopup);

}).call(this);
(function() {
  $.Controller("ModeratedButton", {
    init: function() {
      this.id = this.element.attr('data-coub-id');
      return this.element.bind("click", (function(_this) {
        return function() {
          return _this.removeFromEdited();
        };
      })(this));
    },
    removeFromEdited: function() {
      return $.ajax({
        url: "/editor/coubs/" + this.id + "/remove_from_edited",
        type: "POST",
        success: (function(_this) {
          return function() {
            return Growl.succ('Coub', 'Coub was successfully removed from Edited');
          };
        })(this)
      });
    }
  });

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.MultipageDialog = (function() {
    MultipageDialog.ACTIONS = {
      MOVE_TO_PAGE_BY_ID: "MultipageDialog:MoveToPageById",
      MOVE_BACK: "MultipageDialog:MoveBack"
    };

    MultipageDialog.TRANSITION_DIRECTION = {
      FORWARD: 0,
      BACK: 1
    };

    MultipageDialog.EVENTS = {
      TO_PAGES: {
        BEFORE_CLOSING: "MultipageDialog:Pages:BeforeClosing",
        BEFORE_OPENING: "MultipageDialog:Pages:BeforeOpening",
        AFTER_CLOSING: "MultipageDialog:Pages:AfterClosing",
        AFTER_OPENING: "MultipageDialog:Pages:AfterOpening"
      },
      MOVE_BACK: "MultipageDialog:Pages:MoveBack"
    };

    function MultipageDialog(container) {
      this.resizeDialog = bind(this.resizeDialog, this);
      this.dispatchEventToPage = bind(this.dispatchEventToPage, this);
      this.pageTransition = bind(this.pageTransition, this);
      this.moveBack = bind(this.moveBack, this);
      this.moveToPageById = bind(this.moveToPageById, this);
      this.moveToPage = bind(this.moveToPage, this);
      this.initToStartPage = bind(this.initToStartPage, this);
      this.getIdByPage = bind(this.getIdByPage, this);
      this.getPageById = bind(this.getPageById, this);
      this.getCurrentPage = bind(this.getCurrentPage, this);
      this.getStartPage = bind(this.getStartPage, this);
      this.isLocked = bind(this.isLocked, this);
      this.unlock = bind(this.unlock, this);
      this.lock = bind(this.lock, this);
      this._unbind = bind(this._unbind, this);
      this._bind = bind(this._bind, this);
      this.locked = false;
      this.el = $(container);
      this.popup = this.el.parents('.modal');
      this.animator = new CoubAnimators.MultipageDialogStandartAnimator(this.el);
      this.pagesContainer = $(".dialog__pages, .pages", this.el);
      this.pages = $("[page-id]", this.pagesContainer);
      this.navigation = $("[navigate-to]", this.el);
      this.navigationContainer = $(".dialog__navigation, .navigation", this.el);
      this.navigationBack = $(".back", this.navigationContainer);
      this.initToStartPage();
      this._bind();
      this.el.bind(MultipageDialog.ACTIONS.MOVE_TO_PAGE_BY_ID, (function(_this) {
        return function(e, pageId) {
          return _this.moveToPageById(pageId);
        };
      })(this));
      this.el.bind(MultipageDialog.ACTIONS.MOVE_BACK, (function(_this) {
        return function() {
          return _this.moveBack();
        };
      })(this));
      this.navigation.on("click", (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          return _this.moveToPageById(el.attr("navigate-to"));
        };
      })(this));
    }

    MultipageDialog.prototype._bind = function() {
      this.navigationBack.bind("click", this.moveBack);
      $(window).on('resize', this.resizeDialog);
      return this.popup.on(Popup.EVENT_HIDED, this._unbind);
    };

    MultipageDialog.prototype._unbind = function() {
      return $(window).off('resize', this.resizeDialog);
    };

    MultipageDialog.prototype.lock = function() {
      return this.locked = true;
    };

    MultipageDialog.prototype.unlock = function() {
      return this.locked = false;
    };

    MultipageDialog.prototype.isLocked = function() {
      return this.locked;
    };

    MultipageDialog.prototype.getStartPage = function() {
      var startPage;
      if ((startPage = this.pagesContainer.find("[start-page=true]")).size() > 0) {
        return startPage;
      } else {
        return this.pages.first();
      }
    };

    MultipageDialog.prototype.getCurrentPage = function() {
      var len;
      if ((len = this.navigationStack.length) !== 0) {
        return this.navigationStack[len - 1];
      } else {
        return void 0;
      }
    };

    MultipageDialog.prototype.getPageById = function(id) {
      var page;
      if ((page = $("[page-id='" + id + "']", this.pagesContainer)).size() > 0) {
        return page;
      } else {
        return void 0;
      }
    };

    MultipageDialog.prototype.getIdByPage = function(page) {
      var id;
      if (page && (id = page.attr("page-id"))) {
        return id;
      } else {
        return void 0;
      }
    };

    MultipageDialog.prototype.initToStartPage = function() {
      if (!this.isLocked()) {
        this.navigationStack = [];
        this.pages.hide();
        return this.moveToPage(this.getStartPage(), false);
      }
    };

    MultipageDialog.prototype.moveToPage = function(page, animated) {
      var currentPage, newPageId;
      if (animated == null) {
        animated = true;
      }
      if (!this.isLocked()) {
        if (!(newPageId = this.getIdByPage(page))) {
          throw "MultipageDialog: you try move to page what does not have id " + (page.attr("page-id"));
        } else if (this.getIdByPage(currentPage = this.getCurrentPage()) !== newPageId) {
          this.navigationStack.push(page);
          return this.pageTransition(currentPage, page, MultipageDialog.TRANSITION_DIRECTION.FORWARD, animated);
        } else {
          return false;
        }
      }
    };

    MultipageDialog.prototype.moveToPageById = function(id, animated) {
      var page;
      if (animated == null) {
        animated = true;
      }
      if ((page = this.getPageById(id))) {
        return this.moveToPage(page, animated);
      } else {
        throw "MultipageDialog: pages container does not have page with id " + id;
      }
    };

    MultipageDialog.prototype.moveBack = function(animated) {
      var curPage, prevPage;
      if (animated == null) {
        animated = true;
      }
      if (!this.isLocked()) {
        if (this.navigationStack.length > 1) {
          curPage = this.navigationStack.pop();
          prevPage = this.getCurrentPage();
          this.pageTransition(curPage, prevPage, MultipageDialog.TRANSITION_DIRECTION.BACK, animated);
          return this.el.trigger(MultipageDialog.EVENTS.MOVE_BACK);
        } else {
          return false;
        }
      }
    };

    MultipageDialog.prototype.pageTransition = function(from, to, direction, animated) {
      var afterTransition, changeWidth, isBackVisible, moveBackArrow, pages;
      if (from == null) {
        from = void 0;
      }
      if (animated == null) {
        animated = true;
      }
      if (!this.isLocked()) {
        this.lock();
        this.dispatchEventToPage(from, MultipageDialog.EVENTS.TO_PAGES.BEFORE_CLOSING);
        this.dispatchEventToPage(to, MultipageDialog.EVENTS.TO_PAGES.BEFORE_OPENING);
        afterTransition = (function(_this) {
          return function() {
            _this.unlock();
            _this.dispatchEventToPage(from, MultipageDialog.EVENTS.TO_PAGES.AFTER_CLOSING);
            _this.dispatchEventToPage(to, MultipageDialog.EVENTS.TO_PAGES.AFTER_OPENING);
            return _this.toggleBackButtonState(to);
          };
        })(this);
        if (animated && from) {
          isBackVisible = this.navigationBack.is(":visible");
          pages = this.navigationStack.length;
          moveBackArrow = (pages > 1 && !isBackVisible) || (pages === 1 && isBackVisible);
          if (to.is("[data-no-back]")) {
            moveBackArrow = false;
          }
          changeWidth = to.outerWidth();
          $(this.animator).one(CoubAnimators.MultipageDialogStandartAnimator.EVENTS.ANIMATION_COMPLETE, afterTransition);
          return this.animator.transition(from, to, direction, moveBackArrow, changeWidth);
        } else {
          if (from) {
            from.hide();
          }
          to.show();
          if (this.navigationStack.length === 1) {
            this.navigationBack.hide();
          } else {
            this.navigationBack.show();
          }
          return afterTransition();
        }
      }
    };

    MultipageDialog.prototype.dispatchEventToPage = function(page, event) {
      if (page) {
        return page.trigger(event);
      }
    };

    MultipageDialog.prototype.toggleBackButtonState = function(page) {
      if (page.is('[data-no-back]') || this.navigationStack.length === 1) {
        return this.navigationBack.hide();
      } else {
        return this.navigationBack.show();
      }
    };

    MultipageDialog.prototype.resizeDialog = function() {
      return this.el.css({
        width: '100%'
      });
    };

    MultipageDialog.constructClientDialog = function(opts) {
      var cont, dialog, getDialog, modal;
      if (opts == null) {
        opts = {};
      }
      getDialog = (function(_this) {
        return function() {
          var data;
          data = [];
          _.each(opts.pages, function(route, id) {
            return data.push({
              route: route,
              id: id
            });
          });
          return JST["app/site/templates/widgets/multipage_dialog/multipage_dialog"]({
            data: data,
            dClass: opts.dClass != null ? opts.dClass : '',
            startId: opts.startId
          });
        };
      })(this);
      modal = ModalPopup.show({
        content: getDialog(),
        type: 'dialog',
        classes: opts.mClass != null ? opts.mClass : ''
      });
      if (modal) {
        cont = modal.get();
        dialog = new MultipageDialog($('.dialog', cont));
        opts.constructed(cont, dialog);
        return dialog;
      }
    };

    return MultipageDialog;

  })();

}).call(this);
(function() {
  $.Controller("NiceSelect", {
    "ul.list li click": function(e) {
      this.selectItem(e);
      return false;
    },
    init: function() {
      this.input = $("input[type=hidden]", this.element);
      this.button = $(".dropdown__handler .sb", this.element);
      this.handler = $(".dropdown__handler", this.element);
      this.image = this.element.attr('img-replace');
      this.setButtonIconClassName();
      if ((this.buttonControl = $('span', this.button)).size() === 0) {
        this.button.html("<span>" + (this.button.text()) + "</span>");
        this.buttonControl = this.button.find("span");
      }
      this.element.bind("setContent", this.setContent.bind(this));
      return this.element.bind(NiceSelect.ACTION_REFRESH, this.refresh.bind(this));
    },
    setContent: function(evt) {
      this.content = evt.content;
      return this.content.find("ul.list li").on("click", (function(_this) {
        return function(e) {
          _this.selectItem($(e.currentTarget));
          return false;
        };
      })(this));
    },
    refresh: function() {
      return $("ul.list li[data-val='" + (this.input.val()) + "']", this.element).click();
    },
    setButtonIconClassName: function() {
      var val;
      val = this.input.val();
      return this.handler.attr('class', "dropdown__handler " + val);
    },
    selectItem: function(e) {
      var buttonVal, t, text, val;
      $("ul.list li", this.element).removeClass('active selected');
      if (this.content) {
        $("ul.list li", this.content).removeClass('active selected');
      }
      e.addClass('active selected');
      val = e.attr('data-val');
      this.button.addClass(val);
      this.input.val(val).trigger('change');
      this.element.trigger({
        type: NiceSelect.EVENT_SELECTED,
        val: val
      });
      buttonVal = $.trim(this.buttonControl.text());
      if ((t = e.find("[text]")).size() > 0) {
        this.buttonControl.text(t.text().trim());
      } else if (buttonVal.match(/:/)) {
        text = buttonVal.split(":")[0];
        this.buttonControl.text(text + ": " + ($.trim(e.text())));
      } else {
        this.buttonControl.text($.trim(e.text()));
      }
      this.setButtonIconClassName();
      this.element.trigger('hide');
      if (this.image != null) {
        return this.replaceImage(e);
      }
    },
    selectValue: function(val) {
      this.input.val(val);
      return this.refresh();
    },
    replaceImage: function(selected) {
      var curImg, handlerImg, srcset;
      curImg = selected.find('img');
      handlerImg = this.handler.find('img');
      if ((srcset = curImg.attr('srcset')) != null) {
        return this.handler.find('img').attr({
          srcset: srcset
        });
      } else {
        return this.handler.find('img').attr({
          src: Params.get('missing_userpic'),
          srcset: ''
        });
      }
    }
  });

  window.NiceSelect = {
    ACTION_REFRESH: "NiceSelect:Action:Refresh"
  };

  window.NiceSelect.EVENT_SELECTED = "NiceSelect:Selected";

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.CoubPageCoubsChanger = (function() {
    CoubPageCoubsChanger.DT = "window.CoubPageCoubsChanger";

    function CoubPageCoubsChanger() {
      this.onLoadError = bind(this.onLoadError, this);
      this.onCoubDataLoaded = bind(this.onCoubDataLoaded, this);
      this.loadNextCoub = bind(this.loadNextCoub, this);
      this.loadPrevCoub = bind(this.loadPrevCoub, this);
      this.initButtons = bind(this.initButtons, this);
      this.getInitialPage = bind(this.getInitialPage, this);
      this.reset = bind(this.reset, this);
      this.init = bind(this.init, this);
      this.loadLocker = new chms.utils.Locker();
      this.dataProvider = new window.CoubsChangerDataProvider();
    }

    CoubPageCoubsChanger.prototype.init = function(el) {
      this.el = el;
      if (this.page) {
        return this.initButtons();
      } else {
        return this.getInitialPage();
      }
    };

    CoubPageCoubsChanger.prototype.reset = function() {
      var ref;
      return ref = [], this.page = ref[0], this.totalPages = ref[1], this.initialChannel = ref[2], ref;
    };

    CoubPageCoubsChanger.prototype.getInitialPage = function() {
      var coubId, onPageDataLoaded;
      this.initialChannel = this.el.attr('data-channel');
      if (!this.initialChannel) {
        return;
      }
      coubId = this.el.attr('data-coub-id');
      onPageDataLoaded = (function(_this) {
        return function(json) {
          _this.page = json.page;
          _this.totalPages = json.total_pages;
          return _this.initButtons();
        };
      })(this);
      return this.dataProvider.getInitialPage(this.initialChannel, coubId, onPageDataLoaded, this.onLoadError);
    };

    CoubPageCoubsChanger.prototype.initButtons = function() {
      var nextButton, prevButton;
      prevButton = $(".button-prev-next.-prev", this.el);
      nextButton = $(".button-prev-next.-next", this.el);
      prevButton.click(this.loadPrevCoub);
      nextButton.click(this.loadNextCoub);
      if (this.page !== 1) {
        prevButton.removeClass('-disabled');
      }
      if (this.page !== this.totalPages) {
        return nextButton.removeClass('-disabled');
      }
    };

    CoubPageCoubsChanger.prototype.loadPrevCoub = function() {
      if (this.loadLocker.isLocked()) {
        return;
      }
      this.loadLocker.lock();
      AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.PLAYER.PREV_CLICKED);
      this.page--;
      return this.dataProvider.getPage(this.initialChannel, this.page, 1, this.onCoubDataLoaded, this.onLoadError);
    };

    CoubPageCoubsChanger.prototype.loadNextCoub = function() {
      if (this.loadLocker.isLocked()) {
        return;
      }
      this.loadLocker.lock();
      AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.PLAYER.NEXT_CLICKED);
      this.page++;
      return this.dataProvider.getPage(this.initialChannel, this.page, 1, this.onCoubDataLoaded, this.onLoadError);
    };

    CoubPageCoubsChanger.prototype.onCoubDataLoaded = function(json) {
      var coub;
      this.loadLocker.unlock();
      coub = json.coubs[0];
      return History.pushState({
        from: window.CoubPageCoubsChanger.DT
      }, coub.title, Routes.view_coub_by_permalink_path(coub.permalink));
    };

    CoubPageCoubsChanger.prototype.onLoadError = function() {
      this.loadLocker.unlock();
      return ErrorMessages.internalServerError();
    };

    return CoubPageCoubsChanger;

  })();

}).call(this);
(function() {
  window.CoubPageSuggestions = (function() {
    CoubPageSuggestions.prototype.INITIAL_COUNT = 40;

    CoubPageSuggestions.prototype.MORE_LIMIT = 40;

    CoubPageSuggestions.prototype.MAX_LIMIT = 400;

    function CoubPageSuggestions() {
      this.xhr = false;
      this.isEmpty = true;
      $(window).on('periodic_scroll', (function(_this) {
        return function() {
          var $document, $window;
          $window = $(window);
          $document = $(document);
          if (_this.isEmpty || _this.allLoaded || (_this.xhr && _this.xhr.state() === 'pending') || ($window.scrollTop() < _this.$el.offset().top + _this.$el.height() / 2 && $window.scrollTop() < $document.height() - $window.height() - 80)) {
            return;
          }
          return _this.loadNextPage();
        };
      })(this));
    }

    CoubPageSuggestions.prototype.preload = function(suggestionsUrl) {
      return this.preloadXhr || (this.preloadXhr = $.get(suggestionsUrl, {
        count: this.INITIAL_COUNT
      }));
    };

    CoubPageSuggestions.prototype.clearCache = function() {
      this.preloadXhr && this.preloadXhr.abort();
      this.preloadXhr = null;
      return this;
    };

    CoubPageSuggestions.prototype.empty = function() {
      var $list;
      this.clearCache();
      $list = $('.suggests--page:first > .suggest__list', this.$el).empty();
      return $list.data("masonry") && $list.masonry("destroy");
    };

    CoubPageSuggestions.prototype.render = function(container, coub_permalink, fn) {
      var done;
      this.xhr && this.xhr.abort();
      this.allLoaded = false;
      this.page = 1;
      this.$el = $('.suggests-block-col', container);
      this.coub_permalink = coub_permalink;
      this.isEmpty = true;
      this.initVideoPreviews(this.$el);
      done = (function(_this) {
        return function() {
          _this.isEmpty = _this.getItems().length === 0;
          if (!_this.isEmpty) {
            _this.arrange();
          }
          fn && fn();
          if (!_this.isEmpty && _this.getItems().length < _this.MORE_LIMIT) {
            return _this.loadNextPage();
          }
        };
      })(this);
      return this.preload().done((function(_this) {
        return function(suggestions) {
          var html;
          html = _.reduce(suggestions.coubs, function(res, suggest) {
            var tpl;
            tpl = JST['app/site/templates/suggestions/suggest'](suggest);
            return res + tpl;
          }, '');
          $('.suggests--page:first > .suggest__list', _this.$el).html(html);
          return done();
        };
      })(this)).always(this.clearCache.bind(this));
    };

    CoubPageSuggestions.prototype.arrange = function(reload) {
      var $list;
      if (this.isEmpty) {
        return;
      }
      $('.suggests', this.$el).removeClass('-v-hidden');
      $list = $('.suggests:not(.SUGGEST_OLD) > .suggest__list', this.$el);
      if (reload) {
        $list.masonry('reloadItems');
        return $list.masonry();
      } else {
        return $list.masonry({
          columnWidth: 232,
          gutterWidth: 14,
          itemSelector: '.suggest__item',
          isFitWidth: true
        });
      }
    };

    CoubPageSuggestions.prototype.getItems = function() {
      return this.$el.find('.suggests:first .suggest__item');
    };

    CoubPageSuggestions.prototype.getItemPermalinks = function() {
      return _.map(this.getItems(), function(v) {
        return $('a[data-permalink]:first', v).attr('data-permalink');
      });
    };

    CoubPageSuggestions.prototype.loadNextPage = function() {
      var params;
      if (this.page === 1) {
        LoadRotator.appendToContainer(this.$el, 'small -center');
      }
      params = {
        page: this.page + 1,
        count: this.MORE_LIMIT
      };
      this.xhr = $.get(CoubPageSuggestions.getSuggestUrl(), params);
      this.xhr.always((function(_this) {
        return function() {
          return LoadRotator.removeFromContainer(_this.$el);
        };
      })(this));
      this.xhr.fail(ErrorMessages.ajaxCallServerError);
      return this.xhr.done((function(_this) {
        return function(suggestions) {
          var html, new_sugggestions, rendered_permalinks;
          rendered_permalinks = _.map($('.suggests:first .suggest__item', _this.$el), function(v) {
            return v.getAttribute('data-permalink');
          });
          new_sugggestions = _.filter(suggestions.coubs, function(v) {
            return rendered_permalinks.indexOf(v.permalink) === -1;
          });
          html = _.reduce(new_sugggestions, function(res, suggest) {
            var tpl;
            tpl = JST['app/site/templates/suggestions/suggest'](suggest);
            return res + tpl;
          }, '');
          $('.suggests:first > .suggest__list', _this.$el).append(html);
          _this.allLoaded = !new_sugggestions.length || _this.getItems().length >= _this.MAX_LIMIT;
          _this.page++;
          return _this.arrange(true);
        };
      })(this));
    };

    CoubPageSuggestions.prototype.initVideoPreviews = function($container) {
      $container.on("mouseenter", ".suggest__item", function(e) {
        var video;
        video = $("video", e.currentTarget).get(0);
        return video && video.play();
      });
      return $container.on("mouseleave", ".suggest__item", function(e) {
        var video;
        video = $("video", e.currentTarget).get(0);
        return video && video.pause();
      });
    };

    CoubPageSuggestions.getSuggestType = function() {
      return $('.suggests--page').attr('data-type');
    };

    CoubPageSuggestions.getSuggestUrl = function(container) {
      return $('.suggests--page', container).attr('data-url');
    };

    return CoubPageSuggestions;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.ModernCoubPage = (function() {
    ModernCoubPage.prototype.CONST = {
      SCROLL_TIME: 250
    };

    ModernCoubPage.prototype.DEFAULT_ACTIONS = {
      RECOUB: "#recoub",
      LIKE: "#like",
      EMBED_VIDEO_BLOCK: "#fromEmbedVideoBlock",
      OPEN_SHARING_POPUP: "#openSharingPopup",
      SIGNUP_AND_ADD_TO_FAVS: "#signupAndFav"
    };

    ModernCoubPage.prototype.HD_THRESHOLD = 960;

    function ModernCoubPage(el) {
      var hash;
      this.el = el;
      this.initAmplitude = bind(this.initAmplitude, this);
      this.makeDefaultAction = bind(this.makeDefaultAction, this);
      this.getViewerBlockContainer = bind(this.getViewerBlockContainer, this);
      this.getMainCoubBlock = bind(this.getMainCoubBlock, this);
      this.getMainViewerBlock = bind(this.getMainViewerBlock, this);
      this.getViewerBlocks = bind(this.getViewerBlocks, this);
      this.loadCoub = bind(this.loadCoub, this);
      this.updateContentQueryHandler = bind(this.updateContentQueryHandler, this);
      this.updateContentMakeQuery = bind(this.updateContentMakeQuery, this);
      this.changestate = bind(this.changestate, this);
      this.getAjaxReloadAnimator = bind(this.getAjaxReloadAnimator, this);
      this.resizeViewer = bind(this.resizeViewer, this);
      this.reinit = bind(this.reinit, this);
      this.initCoubCard = bind(this.initCoubCard, this);
      this.init = bind(this.init, this);
      if (!helpers.Coub.isPromoPage()) {
        new CoubPageSuggestLink();
        this.coubsChanger = new window.CoubPageCoubsChanger();
      }
      new CoubPageRemixLink();
      this.initCoubCard();
      this.init();
      this.makeDefaultAction();
      if ((hash = History.getHash()) !== "") {
        History.replaceState({}, document.title, document.location.href.replace("#" + hash, ""));
      }
      History.Adapter.bind(window, "statechange", this.changestate);
      $(window).on("resize", _.throttle(this.resizeViewer, 200));
      this.initAmplitude();
    }

    ModernCoubPage.prototype.init = function() {
      this.getMainViewerBlock().one('playWasStarted', (function(_this) {
        return function(e) {
          helpers.Application.setFocusNoScroll(e.target);
          _this.suggestions.render(_this.el, _this.getCoubPermalink(), function() {
            return _this.getAjaxReloadAnimator().load();
          });
          if (!helpers.Coub.isPromoPage()) {
            return chms.utils.Autoinit.init(CoubMoreFromChannel, _this.el);
          }
        };
      })(this));
      this.resizeViewer();
      CoubBlockClientside.constructFromContainer(this.el, {
        startWithHD: true,
        autoplay: true
      });
      return Stats.track("coub_page_showed", {
        permalink: this.getCoubPermalink()
      });
    };

    ModernCoubPage.prototype.initCoubCard = function(page) {
      var $promo_bg, $viewer, card, data, m, paddingTop;
      page || (page = this.el);
      data = ModernCoubPage.getCoubJson(page);
      data.render = {
        "card-type": "page"
      };
      AmplitudeCoub.clearTrackedOnce(AmplitudeCoub.COUB_PAGE.SCROLL.SCROLLED_TO_SUGGESTS);
      AmplitudeCoub.clearTrackedOnce(AmplitudeCoub.COUB_PAGE.SCROLL.SCROLLED_TO_BOTTOM);
      this.suggestions || (this.suggestions = new CoubPageSuggestions());
      this.suggestions.clearCache().preload(CoubPageSuggestions.getSuggestUrl(page));
      _.defer((function(_this) {
        return function() {
          var dTime, date, dateCreated, obj, obj1;
          _this.coubsChanger && _this.coubsChanger.init($(".viewer__coubs-changer", page));
          if (!GlobalState.USER.isOwnerOf(data.channel.id)) {
            _this.setupBanners(page, data.is_safe_for_ads);
          }
          new window.CoubMediaBlock($('.coub__media-block', page));
          dateCreated = new Date(data.created_at);
          dTime = Date.now() - dateCreated.getTime();
          if (dTime > 6 * 2628000000) {
            date = AmplitudeCoub.PROPS.DATE_HALFYEAR;
          } else if (dTime > 604800000) {
            date = AmplitudeCoub.PROPS.DATE_FIRST_WEEK_HALFYEAR;
          } else {
            date = AmplitudeCoub.PROPS.DATE_FIRST_WEEK;
          }
          obj = (
            obj1 = {},
            obj1["" + AmplitudeCoub.PROPS.HAS_MORE_FROM_AUTHOR] = window.CoubMoreFromChannel.MORE_COUBS_LOADING,
            obj1["" + AmplitudeCoub.PROPS.HAS_MUSIC_SOURCE] = $(".media-block__item--audio").size() > 0,
            obj1["" + AmplitudeCoub.PROPS.HAS_VIDEO_SOURCE] = $(".media-block__item--video").size() > 0,
            obj1["" + AmplitudeCoub.PROPS.HAS_TAGS] = $(".coub__tags--page").size() > 0,
            obj1["" + AmplitudeCoub.PROPS.IS_NSFW] = data.not_safe_for_work === true,
            obj1["" + AmplitudeCoub.PROPS.IS_AGE_RESCTRICTED] = data.age_restricted || data.age_restricted_by_admin,
            obj1["" + date] = true,
            obj1["" + AmplitudeCoub.PROPS.COUB_PERMALINK] = _this.getCoubPermalink(),
            obj1
          );
          if (_this.prevCoubPermalink) {
            obj[AmplitudeCoub.PROPS.FROM_COUB_SUGGEST] = _this.prevCoubPermalink;
          }
          return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.VIEW_OCCURED, obj);
        };
      })(this));
      card = JST["app/site/templates/coub_block/coub"](data);
      $(".page-stub", page).replaceWith(card);
      if (helpers.Coub.isPromoPage()) {
        $viewer = this.getViewerBlockContainer();
        paddingTop = 0;
        if (m = document.body.className.match(/min-player-height-(\d+)/)) {
          if ($viewer.height() < m[1]) {
            paddingTop = m[1] - $viewer.height();
            $('.coub', page).css('padding-top', paddingTop);
          }
        }
        $(document).on(CoubBlockClientside.EVENT_RELOAD_COMPLETE, (function(_this) {
          return function() {
            return $('.coub', page).css('padding-top', paddingTop);
          };
        })(this));
        $promo_bg = $('.promo-background').first();
        if ($promo_bg.hasClass('promo-background--stick-to-top')) {
          $promo_bg.css({
            height: $promo_bg.attr('data-height')
          });
        } else {
          $promo_bg.css({
            height: $viewer.offset().top + $viewer.height()
          });
        }
        $promo_bg.addClass('-showed');
      }
      $(document).off(CoubBlockClientside.EVENT_RELOAD_COMPLETE).on(CoubBlockClientside.EVENT_RELOAD_COMPLETE, (function(_this) {
        return function() {
          _this.suggestions.empty();
          return _this.suggestions.render(_this.el, _this.getCoubPermalink());
        };
      })(this));
      if (data.communities && data.communities.length) {
        return window.ym && ym(48571952, "params", {
          params: {
            category: data.communities[0].permalink
          }
        });
      }
    };

    ModernCoubPage.prototype.reinit = function() {
      this.init();
      return this.getAjaxReloadAnimator().element = this.el;
    };

    ModernCoubPage.prototype.resizeViewer = function() {
      var $viewer, new_size, size, viewer_rect;
      viewer_rect = $(".coub__inner").width() >= this.HD_THRESHOLD ? [this.HD_THRESHOLD, 720] : blocks.coub.CardTypes.types["page"].size;
      $viewer = $(".viewer", this.el);
      size = [$viewer.width(), $viewer.height()];
      new_size = helpers.Coub.scaleToRect(size, viewer_rect).map((function(_this) {
        return function(v) {
          return v + "px";
        };
      })(this));
      return $viewer.css({
        width: new_size[0],
        height: new_size[1]
      });
    };

    ModernCoubPage.prototype.getAjaxReloadAnimator = function() {
      return this.ajaxReloadAnimator || (this.ajaxReloadAnimator = new CoubAnimators.CoubPageAjaxReloadAnimator(this.el));
    };

    ModernCoubPage.prototype.changestate = function(event) {
      var state;
      state = History.getState();
      if (!(state.data && state.data.from === window.CoubPageCoubsChanger.DT)) {
        this.coubsChanger && this.coubsChanger.reset();
      }
      return this.updateContentMakeQuery(state.url);
    };

    ModernCoubPage.prototype.updateContentMakeQuery = function(url) {
      this.currentQuery && this.currentQuery.abort();
      this.currentQuery = $.get(url).then(this.updateContentQueryHandler, this.showErrorPopup);
      this.getAjaxReloadAnimator().suggestReload();
      this.googleBanner && this.googleBanner.destroy();
      return this.googleBanner = null;
    };

    ModernCoubPage.prototype.showErrorPopup = function(e) {
      if (e.statusText === "abort") {
        return;
      } else if (e.status === 404) {
        Growl.msg(I18n.t("errors.not_found.header"), "");
      } else {
        Growl.msg(I18n.ERRORS.INTERNAL_SERVER_ERROR.SUB, I18n.ERRORS.INTERNAL_SERVER_ERROR.TRY_AGAIN);
      }
      return History.back();
    };

    ModernCoubPage.prototype.updateContentQueryHandler = function(data) {
      this.currentQuery = null;
      this.getMainViewerBlock().triggerHandler('suspend');
      return this.loadCoub(data);
    };

    ModernCoubPage.prototype.loadCoub = function(data) {
      var page, title;
      title = data.match(/<title>(.*?)<\/title>/);
      if (title) {
        $("title").html(title[1]);
      }
      page = $(data).find('.coub-page');
      this.initCoubCard(page);
      this.getAjaxReloadAnimator().preloadState(page);
      this.el.replaceWith(page);
      this.el = page;
      this.reinit();
      return chms.utils.Autoinit.init(widgets.WidgetFollowButtonInit, this.el);
    };

    ModernCoubPage.prototype.getCoubPermalink = function() {
      return this.el.attr('data-permalink');
    };

    ModernCoubPage.prototype.getViewerBlocks = function() {
      return $(".viewer");
    };

    ModernCoubPage.prototype.getMainViewerBlock = function() {
      return $(".coub__viewer > .viewer");
    };

    ModernCoubPage.prototype.getMainCoubBlock = function() {
      return $(".coub", this.el);
    };

    ModernCoubPage.prototype.getViewerBlockContainer = function() {
      return $(".coub__viewer");
    };

    ModernCoubPage.prototype.makeDefaultAction = function() {
      var action, hash;
      hash = window.location.hash;
      action = (function() {
        switch (hash) {
          case this.DEFAULT_ACTIONS.LIKE:
            return (function(_this) {
              return function() {
                return _this.getMainCoubBlock().triggerHandler(CoubBlockClientside.ACTION_AUTOLIKE);
              };
            })(this);
          case this.DEFAULT_ACTIONS.RECOUB:
            return (function(_this) {
              return function() {
                return _this.getMainCoubBlock().triggerHandler(CoubBlockClientside.ACTION_AUTORECOUB);
              };
            })(this);
          case this.DEFAULT_ACTIONS.EMBED_VIDEO_BLOCK:
            AmplitudeCoub.trackOnce(AmplitudeCoub.COUB_PAGE.VIEW_FROM_VIDEO_SOURCE_OCCURED);
            return (function(_this) {
              return function() {
                return $('.coub__media-block [data-type="embedBlock"]').first().trigger('click');
              };
            })(this);
          case this.DEFAULT_ACTIONS.OPEN_SHARING_POPUP:
            return (function(_this) {
              return function() {
                return $('.coub__sharing__dropdown .dropdown__handler .sb').trigger('click');
              };
            })(this);
          case this.DEFAULT_ACTIONS.SIGNUP_AND_ADD_TO_FAVS:
            return (function(_this) {
              return function() {
                return !GlobalState.USER.isLogedIn() && $('.viewer__favourites').trigger('click');
              };
            })(this);
        }
      }).call(this);
      return action && $(document).ready(action);
    };

    ModernCoubPage.prototype.setupBanners = function(page, isSafeForAds) {
      var belowBanner, belowBannerEl;
      if (!GlobalState.COUNTRY.isExUssr()) {
        return;
      }
      if (isSafeForAds) {
        belowBanner = new widgets.AdfoxAdaptiveBanner({
          p1: 'canqk',
          p2: 'fqhi',
          ownerId: 220463
        }, {
          tabletWidth: 970,
          phoneWidth: 480,
          isAutoReloads: false
        });
        window.Ya && window.Ya.headerBidding && window.Ya.headerBidding.pushAdUnits([
          {
            code: belowBanner.id,
            sizes: [[970, 250]],
            bids: [
              {
                bidder: 'betweenDigital',
                params: {
                  placementId: '2687620'
                }
              }, {
                bidder: 'rtbhouse',
                params: {
                  placementId: 'Kn5tBgtA0YiIWtKmaPBP'
                }
              }, {
                bidder: 'criteo',
                params: {
                  placementId: '1381791'
                }
              }, {
                bidder: 'alfasense',
                params: {
                  placementId: 'direct_otm_1509'
                }
              }, {
                bidder: 'getintent',
                params: {
                  placementId: '81_MF_Coub.com_D_970x250-CoubPage'
                }
              }
            ]
          }
        ]);
      } else {
        belowBanner = new widgets.AdfoxBanner({
          p1: 'cdamc',
          p2: 'fqhh',
          ownerId: 220463
        });
      }
      belowBannerEl = $("<div/>", {
        "class": "adfox-coub-page-banner",
        id: belowBanner.id
      }).insertAfter($('.coub-block-col', page));
      return belowBanner.load((function() {
        return belowBannerEl.addClass("-shown");
      }), (function() {
        return belowBannerEl.remove();
      }));
    };

    ModernCoubPage.prototype.initAmplitude = function() {
      var audioBlock, authorBlock, authorPopup, coubCard, footer, header, logInPopup, moreCoubs, player, sharingCoubCard, sharingPlayer, singUpPopup, tags, trackPopupShown, videoBlock;
      AmplitudeCoub.trackOnce(AmplitudeCoub.COUB_PAGE.SESSION_STARTED);
      $("[coub-embed-popup]").live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.EMBED_BTN_CLICKED);
      });
      coubCard = $(".coub__description");
      $(".description__stamp__meta", coubCard).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.COUB_CARD.AUTHOR_CLICKED);
      });
      $(".coub__like-button", coubCard).live("mousedown", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.COUB_CARD.LIKE_CLICKED);
      });
      $(".coub__recoub-button .dropdown__handler > i", coubCard).live("mousedown", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.COUB_CARD.RECOUB_CLICKED);
      });
      $(".coub__recoub-button[data-unloged-action=recoub]", coubCard).live("mousedown", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.COUB_CARD.RECOUB_CLICKED);
      });
      $(".description__stamp__external", coubCard).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.COUB_CARD.VIDEO_SOURCE_CLICKED);
      });
      player = $(".coub__viewer");
      $(".coub__viewer [show-in-app-btn]", player).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.PLAYER.OPEN_IN_APP_CLICKED);
      });
      authorBlock = $(".channel--box-card");
      $(".box-card__screen", authorBlock).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.AUTHOR_BLOCK.AUTHOR_CLICKED);
      });
      $(".channel__avatar", authorBlock).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.AUTHOR_BLOCK.AUTHOR_CLICKED);
      });
      $(".channel__title", authorBlock).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.AUTHOR_BLOCK.AUTHOR_CLICKED);
      });
      $(".channel-follow-button", authorBlock).live("click", function(e) {
        return AmplitudeCoub.trackOne(AmplitudeCoub.COUB_PAGE.AUTHOR_BLOCK.FOLLOW_CLICKED);
      });
      $(".channel__counters a:eq(0)", authorBlock).live("click", function(e) {
        return AmplitudeCoub.trackOne(AmplitudeCoub.COUB_PAGE.AUTHOR_BLOCK.COUBS_COUNTER_CLICKED);
      });
      $(".channel__counters a:eq(1)", authorBlock).live("click", function(e) {
        return AmplitudeCoub.trackOne(AmplitudeCoub.COUB_PAGE.AUTHOR_BLOCK.RECOUBS_COUNTER_CLICKED);
      });
      authorPopup = $(".dropdown__content .channel--box-card");
      trackPopupShown = (function(_this) {
        return function() {
          if ($(".dropdown__content .channel--box-card").size() === 0) {
            clearTimeout(_this.popupShowTimeout);
            return _this.popupShowTimeout = setTimeout(function() {
              if ($(".dropdown__content .channel--box-card").size() > 0) {
                return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.AUTHOR_POPUP.POPUP_SHOWN);
              }
            }, 300);
          }
        };
      })(this);
      $(".description__stamp__meta", coubCard).live("mouseover", function() {
        return trackPopupShown();
      });
      $(".object-media__img", coubCard).live("mouseover", function() {
        return trackPopupShown();
      });
      $(".box-card__screen", authorPopup).live("click", function() {
        return AmplitudeCoub.trackOne(AmplitudeCoub.COUB_PAGE.AUTHOR_POPUP.AUTHOR_CLICKED);
      });
      $(".channel__avatar", authorPopup).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.AUTHOR_POPUP.AUTHOR_CLICKED);
      });
      $(".channel__title", authorPopup).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.AUTHOR_POPUP.AUTHOR_CLICKED);
      });
      $(".channel-follow-button", authorPopup).live("click", function() {
        return AmplitudeCoub.trackOne(AmplitudeCoub.COUB_PAGE.AUTHOR_POPUP.FOLLOW_CLICKED);
      });
      $(".channel__counters a:eq(0)", authorPopup).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.AUTHOR_POPUP.COUBS_COUNTER_CLICKED);
      });
      $(".channel__counters a:eq(1)", authorPopup).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.AUTHOR_POPUP.RECOUBS_COUNTER_CLICKED);
      });
      videoBlock = $(".coub__media-block .media-block__item--video");
      $(".object-media__img", videoBlock).live("mousedown", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.VIDEO_SOURCE_BLOCK.SOURCE_CLICKED);
      });
      $(".object-media__body h5", videoBlock).live("mousedown", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.VIDEO_SOURCE_BLOCK.SOURCE_CLICKED);
      });
      $(".object-media__body .make-coub", videoBlock).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.VIDEO_SOURCE_BLOCK.COUB_IT_CLICKED);
      });
      audioBlock = $(".coub__media-block .media-block__item--audio");
      $(".object-media__img", audioBlock).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.MUSIC_SOURCE_BLOCK.SOURCE_CLICKED);
      });
      $(".object-media__body h5 a", audioBlock).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.MUSIC_SOURCE_BLOCK.SOURCE_CLICKED);
      });
      $(".object-media__body .itunes", audioBlock).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.MUSIC_SOURCE_BLOCK.ITUNES_CLICKED);
      });
      sharingPlayer = $(".viewer__sharing__items", player);
      sharingCoubCard = $(".coub__sharing__dropdown .dropdown__content");
      $("[widget-copy-link]", sharingCoubCard).live("click", function() {
        var obj1;
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.SHARE.COPY_LINK, (
          obj1 = {},
          obj1["" + AmplitudeCoub.PROPS.FROM_COUB_CARD] = true,
          obj1
        ));
      });
      $(".-sharing-mail", sharingCoubCard).live("click", function() {
        var obj1;
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.SHARE.MAIL, (
          obj1 = {},
          obj1["" + AmplitudeCoub.PROPS.FROM_COUB_CARD] = true,
          obj1
        ));
      });
      tags = $(".coub__tags--page");
      $("a", tags).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.TAGS.TAG_CLICKED);
      });
      $("button", tags).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.TAGS.MORE_CLICKED);
      });
      moreCoubs = $("[coub-channel-coubs]");
      $(".channel-coubs a:not(:last-child)", moreCoubs).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.MORE_COUBS_BLOCK.COUB_CLICKED);
      });
      $(".channel-coubs a:last-child", moreCoubs).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.MORE_COUBS_BLOCK.MORE_CLICKED);
      });
      $(window).on('scroll', (function(_this) {
        return function() {
          if ($(window).scrollTop() > window.innerHeight / 2) {
            AmplitudeCoub.trackOnce(AmplitudeCoub.COUB_PAGE.SCROLL.SCROLLED_TO_SUGGESTS);
          }
          if ($(document).height() === $(window).scrollTop() + window.innerHeight) {
            return AmplitudeCoub.trackOnce(AmplitudeCoub.COUB_PAGE.SCROLL.SCROLLED_TO_BOTTOM);
          }
        };
      })(this));
      $(document).on("click", ".suggest__item", (function(_this) {
        return function(e) {
          var obj1;
          _this.prevCoubPermalink = _this.getCoubPermalink();
          return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.COUBS_SUGGESTS.COUB_CLICKED, (
            obj1 = {},
            obj1["" + AmplitudeCoub.PROPS.COUB_PERMALINK] = $(e.currentTarget).attr("data-permalink"),
            obj1["" + AmplitudeCoub.PROPS.SUGGESTS] = $('.suggest__item').map(function(i, obj) {
              return $('a', obj).data('permalink');
            }).toArray().join(", "),
            obj1["" + AmplitudeCoub.PROPS.SUGGESTS_TYPE] = CoubPageSuggestions.getSuggestType(),
            obj1
          ));
        };
      })(this));
      header = $("header");
      $(".header__logo", header).click(function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.HEADER.LOGO_CLICKED);
      });
      $(".header__nav .explore", header).click(function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.HEADER.FEATURED_CLICKED);
      });
      $(".header__nav .hot", header).click(function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.HEADER.POPULAR_CLICKED);
      });
      $("button[data-action=sign_up]", header).click(function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.HEADER.SIGNUP_CLICKED);
      });
      $("button[data-action=sign_in]", header).click(function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.HEADER.LOGIN_CLICKED);
      });
      $(".header__nav .create", header).click(function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.HEADER.CREATE_CLICKED);
      });
      $(".header-channel__avatar", header).click(function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.HEADER.USERPIC_CLICKED);
      });
      $("[block-notifications-popup] .dropdown__handler").click(function() {
        return AmplitudeCoub.trackOne(AmplitudeCoub.COUB_PAGE.HEADER.NOTIFICATIONS_CLICKED);
      });
      $("[block-friendship-notifications-popup] .dropdown__handler").click(function() {
        return AmplitudeCoub.trackOne(AmplitudeCoub.COUB_PAGE.HEADER.FOLLOWERS_CLICKED);
      });
      footer = $('footer');
      $(".footer__nav .list__item a:eq(0)", footer).click(function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.FOOTER.ABOUT);
      });
      $(".footer__nav .list__item a:eq(1)", footer).click(function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.FOOTER.MEDIA);
      });
      $(".footer__nav .list__item a:eq(2)", footer).click(function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.FOOTER.BLOG);
      });
      $(".footer__nav .list__item a:eq(3)", footer).click(function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.FOOTER.TERMS_OF_SERVICE);
      });
      $(".footer__nav .list__item a:eq(4)", footer).click(function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.FOOTER.ADVERTISE);
      });
      $(".footer__nav .list__item a:eq(5)", footer).click(function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.FOOTER.APPS);
      });
      $(".footer__nav .list__item a:eq(6)", footer).click(function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.FOOTER.BRAND);
      });
      $(".footer__nav .list__item a:eq(7)", footer).click(function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.FOOTER.DEVELOPERS);
      });
      $(".footer__nav .list__item a:eq(8)", footer).click(function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.FOOTER.HELP);
      });
      $(".footer__copyright a", footer).click(function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.FOOTER.EMAIL);
      });
      logInPopup = $(".modal--auth .modal__content .registration--sign_in");
      $(".registration__soc-buttons .vkontakte", logInPopup).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.SIGNUP_MODAL.LOGIN.FROM_VK);
      });
      $(".registration__soc-buttons .facebook", logInPopup).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.SIGNUP_MODAL.LOGIN.FROM_FB);
      });
      $(".registration__soc-buttons .twitter", logInPopup).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.SIGNUP_MODAL.LOGIN.FROM_TW);
      });
      $(".registration__soc-buttons .google", logInPopup).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.SIGNUP_MODAL.LOGIN.FROM_GOOGLE);
      });
      $(".login-pass [type=submit]", logInPopup).live("mousedown", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.SIGNUP_MODAL.LOGIN.FROM_MAIL);
      });
      singUpPopup = $(".modal--auth .modal__content .registration--sign_up");
      $(".registration-form__social .vkontakte", singUpPopup).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.SIGNUP_MODAL.SIGNUP.FROM_VK);
      });
      $(".registration-form__social .facebook", singUpPopup).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.SIGNUP_MODAL.SIGNUP.FROM_FB);
      });
      $(".registration-form__social .twitter", singUpPopup).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.SIGNUP_MODAL.SIGNUP.FROM_TW);
      });
      return $(".email-registration-form .registration-form__submit", singUpPopup).live("click", function() {
        return AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.SIGNUP_MODAL.SIGNUP.FROM_MAIL);
      });
    };

    ModernCoubPage.getCoubJson = function(page) {
      var e;
      page = page || $("body");
      try {
        return JSON.parse(page.find("#coubPageCoubJson").html());
      } catch (error) {
        e = error;
        (typeof Honeybadger !== "undefined" && Honeybadger !== null) && Honeybadger.setContext({
          json: page.find("#coubPageCoubJson").html()
        });
        throw e;
      }
    };

    return ModernCoubPage;

  })();

}).call(this);
(function() {
  pages.NotFound = {
    init: function() {
      $('.load-more').click(this.loadRandCoubs);
      return this.loadRandCoubs();
    },
    loadRandCoubs: function() {
      return $.get(Routes.random_coubs_path(), function(suggestions) {
        var html;
        html = _.reduce(suggestions.coubs, function(res, suggest) {
          var tpl;
          tpl = JST['app/site/templates/suggestions/suggest'](suggest);
          return res + tpl;
        }, '');
        return $('.suggests--random > .suggest__list').html(html);
      });
    }
  };

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.pages.editAccount.channelsNavigation = (function() {
    function channelsNavigation(opts) {
      if (opts == null) {
        opts = {};
      }
      this.changeUrl = bind(this.changeUrl, this);
      this.selectEdit = bind(this.selectEdit, this);
      this.parent = opts.parent;
      $(".slidingDoors.channelsNavigation li").bind('click', this.selectEdit);
    }

    channelsNavigation.prototype.selectEdit = function(e) {
      var button, channelId, type;
      button = $(e.currentTarget);
      if (!button.hasClass('active')) {
        type = button.attr('data-type');
        channelId = button.attr('data-entity-id');
        $('.slidingDoors.channelsNavigation li').removeClass('active');
        button.add(button.parent()).addClass('active');
        return this.parent.getPageById(channelId, type);
      }
    };

    channelsNavigation.prototype.changeUrl = function(permalink, type) {
      type = type === 'account' ? type : permalink;
      return History.replaceState({}, I18n.t('titles.edit_profile'), Routes.profile_edit_path(type));
    };

    return channelsNavigation;

  })();

}).call(this);
(function() {
  pages.editAccount.Main = (function() {
    function Main($el) {
      this.$el = $el;
      this._init();
      this._bind();
    }

    Main.prototype._init = function() {
      (this.navigation = $(JST["app/site/templates/channels/edit/navigation"]())).appendTo(this.$el.find('.-col-one-third'));
      this.provider = new dataProviders.ApiV2;
      return this.curView = void 0;
    };

    Main.prototype._bind = function() {
      $('.edit-account__nav li[data-entity=user]', this.$el).click(this.navigateToAccount);
      $('.edit-account__nav li[data-entity=channel]', this.$el).click(this.navigateToChannel);
      page('/account/edit', (function(_this) {
        return function() {
          var id;
          _this.selectNavItem(void 0);
          if (_this.curView != null) {
            _this.curView.el.remove();
          }
          _this.curView = new pages.editAccount.AccountView();
          id = Params.getBranchValue('current_user.id');
          return _this.curView.render(id, _this);
        };
      })(this));
      page('/:permalink/edit', (function(_this) {
        return function(ctx) {
          var action, id;
          action = ctx.params.permalink;
          _this.selectNavItem(action);
          if (!_.include(helpers.Channel.mapPermalinks(), action)) {
            return page("/account/edit");
          }
          if (_this.curView != null) {
            _this.curView.el.remove();
          }
          _this.curView = new pages.editAccount.ChannelView();
          id = helpers.Channel.getSpecificParam({
            permalink: action
          }, 'id');
          return _this.curView.render(id, _this);
        };
      })(this));
      return page();
    };

    Main.prototype.navigateToAccount = function() {
      return page('/account/edit');
    };

    Main.prototype.navigateToChannel = function(e) {
      var item, permalink;
      item = $(e.currentTarget);
      permalink = item.attr('data-entity-permalink');
      return page("/" + permalink + "/edit");
    };

    Main.prototype.selectNavItem = function(action) {
      this.navigation.find('li').removeClass('active');
      if (action != null) {
        return this.navigation.find("li[data-entity-permalink='" + action + "']").addClass('active');
      } else {
        return this.navigation.find("li[data-entity='user']").addClass('active');
      }
    };

    Main.prototype.renderPage = function(page) {
      this.$el.find('.-col-two-thirds').first().html(page);
      $('.dropdown', page).dropdown();
      return $('.dropdown--select', page).nice_select();
    };

    Main.prototype.showLoader = function() {
      return LoadRotator.appendWithOverlayAndStart(this.$el.find('.-col-two-thirds').first());
    };

    Main.prototype.hideLoader = function() {
      return LoadRotator.removeWithOverlay(this.$el.find('.-col-two-thirds').first());
    };

    Main.construct = function() {
      var el;
      if ((el = $('.edit-profile-page')).length) {
        return new pages.editAccount.Main(el);
      }
    };

    return Main;

  })();

}).call(this);
(function() {
  window.pages.editAccount.AccountView = (function() {
    function AccountView() {}

    AccountView.prototype.render = function(id, main) {
      main.showLoader();
      return new dataProviders.ApiV2().getUserForEdit(id, {
        success: (function(_this) {
          return function(resp) {
            var page;
            page = $(JST["app/site/templates/channels/edit/user_settings_page"](resp.user));
            main.renderPage(page);
            _this._init(page, main);
            return _this._bind(resp.user);
          };
        })(this),
        error: function() {
          return ErrorMessages.internalServerError();
        },
        complete: function() {
          return main.hideLoader();
        }
      });
    };

    AccountView.prototype._init = function(el, main) {
      var emailInput, provider;
      this.el = el;
      provider = new dataProviders.ApiV2();
      this.genderSelect = new GenderSelect({
        el: $(".gender-pick", this.el)
      });
      emailInput = $("input[name='user[email]']", this.el);
      $('.date-select', this.el).each(function() {
        return new NiceDateSelect({
          el: this
        });
      });
      new validations.EmailValidation(emailInput, emailInput.parent(), Params.getBranchValue("current_user.permalink"));
      return new ConfirmableFormSubmitLogic({
        form: this.el,
        input: emailInput,
        provider: provider.updateUserSettings,
        main: main
      });
    };

    AccountView.prototype._bind = function(userData) {
      this.genderSelect.highlightChangedGender();
      $('.change-pass', this.el).on('click', this.showChangePassDialog);
      return this.renderChangePhoneNumber(userData.phone_number);
    };

    AccountView.prototype.renderChangePhoneNumber = function(currentPhoneNumber) {
      var $el, html, onLinkSuccess;
      $el = $('.change-phone-number', this.el);
      html = JST["app/site/templates/channels/edit/widgets/phone_settings"](currentPhoneNumber);
      $el.html(html);
      if (currentPhoneNumber) {
        return $('button', $el).click((function(_this) {
          return function() {
            return $.put(Routes.update_phone_number_api_v2_users_path()).done(function(data) {
              return _this.renderChangePhoneNumber(data.phone_number);
            }).fail(function(e) {
              if (e.status === 422 && e.responseText.indexOf('email') !== -1) {
                return Growl.msg(I18n.t('announces.errors.heading'), I18n.t('profile.errors.phone_unlink_error'));
              } else {
                return ErrorMessages.internalServerError();
              }
            });
          };
        })(this));
      } else {
        onLinkSuccess = (function(_this) {
          return function(data) {
            return $.put(Routes.update_phone_number_api_v2_users_path(), _.pick(data, 'token', 'provider')).fail(ErrorMessages.internalServerError).done(function(data) {
              return _this.renderChangePhoneNumber(data.phone_number);
            });
          };
        })(this);
        return new AuthPopup.Handlers.OAuthButton({
          el: $('.settings__auth-button', $el),
          kind: 'firebase',
          onSuccess: onLinkSuccess,
          onFailure: $.noop
        });
      }
    };

    AccountView.prototype.showChangePassDialog = function() {
      var temp;
      temp = JST["app/site/templates/channels/edit/widgets/modals/change_password_content"]();
      return ModalPopup.constructPopup({
        content: temp,
        constructed: function(cont) {
          return new ChangePasswordForm({
            el: cont
          });
        }
      });
    };

    return AccountView;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.pages.editAccount.ChannelView = (function() {
    function ChannelView() {
      this.showDeletionDialog = bind(this.showDeletionDialog, this);
    }

    ChannelView.prototype.DELETE_CHANNEL = {
      PAGES: {
        delete_confirm: 'app/site/templates/channels/edit/widgets/delete_channel/delete_channel_confirm_page',
        pass_confirm: 'app/site/templates/channels/edit/widgets/modals/confirm_password_content'
      }
    };

    ChannelView.prototype.render = function(id, main) {
      main.showLoader();
      return new dataProviders.ApiV2().getChannelForEdit(id, {
        success: (function(_this) {
          return function(channel) {
            var page;
            page = $(JST["app/site/templates/channels/edit/channel_settings_page"](channel.channel));
            main.renderPage(page);
            _this._init(page, main);
            return _this._bind();
          };
        })(this),
        error: function() {
          return ErrorMessages.internalServerError();
        },
        complete: function() {
          return main.hideLoader();
        }
      });
    };

    ChannelView.prototype._init = function(el, main) {
      var permalinkInput, provider;
      this.el = el;
      provider = new dataProviders.ApiV2();
      this.channelId = $('input[type=hidden]#channel_id', this.el).val();
      permalinkInput = $("input[name='channel[permalink]']", this.el);
      chms.utils.Autoinit.init(widgets.FieldCounter, this.el);
      AddAuthenticationButton.construct();
      new validations.PermalinkValidation(permalinkInput, permalinkInput.parent(), this.channelId);
      return new ConfirmableFormSubmitLogic({
        form: this.el,
        input: permalinkInput,
        provider: provider.updateChannelSettings,
        main: main,
        onSuccess: (function(_this) {
          return function(data) {
            return $.handleRedirect(Routes.profile_edit_path(data.permalink));
          };
        })(this)
      });
    };

    ChannelView.prototype._bind = function() {
      $('.delete-channel', this.el).on('click', this.showDeletionDialog);
      return $(document).off(ConfirmPasswordDialog.EVENTS.DELETED).one(ConfirmPasswordDialog.EVENTS.DELETED, (function(_this) {
        return function(e) {
          window.location.replace(e.link);
          return Stats.track("account_was_deleted");
        };
      })(this));
    };

    ChannelView.prototype.showDeletionDialog = function() {
      return MultipageDialog.constructClientDialog({
        pages: this.DELETE_CHANNEL.PAGES,
        constructed: (function(_this) {
          return function(cont, dialog) {
            $('[move-to-confirm]', cont).on('click', function() {
              return dialog.moveToPageById('confirm-password');
            });
            return ConfirmPasswordDialog.constructInside({
              type: 'deletion',
              el: cont,
              id: _this.channelId
            });
          };
        })(this)
      });
    };

    return ChannelView;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.ConfirmableFormSubmitLogic = (function() {
    function ConfirmableFormSubmitLogic(opts) {
      this.passwordConfirmed = bind(this.passwordConfirmed, this);
      this.submit = bind(this.submit, this);
      this.validateForm = bind(this.validateForm, this);
      if ((opts.form == null) || (opts.input == null)) {
        throw "ConfirmableFormSubmitLogic: it require a form and input in order to work";
      }
      this.form = opts.form;
      this.input = opts.input;
      this.provider = opts.provider;
      this.main = opts.main;
      this.onSuccess = opts.onSuccess;
      this.setInitialState();
      this.validateForm();
      this._bind();
    }

    ConfirmableFormSubmitLogic.prototype._bind = function() {
      $(document).off(ConfirmPasswordDialog.EVENTS.DONE).on(ConfirmPasswordDialog.EVENTS.DONE, this.passwordConfirmed);
      this.form.on('submit', (function(_this) {
        return function(e) {
          e.preventDefault();
          return _this.submit(e);
        };
      })(this));
      return this.form.find('input.settings__link-field').keyup(function() {
        return $(this).removeClass('ignore');
      });
    };

    ConfirmableFormSubmitLogic.prototype.validateForm = function() {
      $.validator.addMethod("url_regexp", (function(value, element) {
        var re, val;
        re = /(http(s)?:\\)?([\w-]+\.)+(\[\?%&=]*)?/;
        val = $.trim(value);
        if (val.match(re) || _.isEmpty(val)) {
          return true;
        } else {
          return false;
        }
      }), $.validator.messages.url);
      return this.form.validate({
        ignore: '.ignore',
        rules: {
          "channel[title]": {
            required: true,
            maxlength: 255
          },
          "channel[homepage]": {
            url_regexp: true
          },
          "channel[tumblr]": {
            url_regexp: true
          },
          "channel[youtube]": {
            url_regexp: true
          },
          "channel[vimeo]": {
            url_regexp: true
          }
        },
        onkeyup: false,
        onfocusout: false,
        messages: {
          "channel[title]": {
            required: I18n.t('profile.errors.title_is_required'),
            maxlength: I18n.t('profile.errors.title_is_too_long')
          }
        }
      });
    };

    ConfirmableFormSubmitLogic.prototype.submit = function(e) {
      if (this.form.valid()) {
        if ($("input.loading, input.error", this.form).length === 0) {
          if (this.input.attr('type') === 'email' && !Params.getBranchValue('current_user.email_confirmed')) {
            return this.save(e);
          } else if (this.initialState === this.input.val()) {
            return this.save(e);
          } else {
            return ConfirmPasswordDialog.construct('private');
          }
        }
      }
    };

    ConfirmableFormSubmitLogic.prototype.passwordConfirmed = function(e) {
      e.stopPropagation();
      this.form.find("input#password").val(e.password);
      this.save(e);
      return this.setInitialState();
    };

    ConfirmableFormSubmitLogic.prototype.externalAccountLinkError = function(resp) {
      var err, errFields, showErrors, validator;
      err = JSON.parse(resp.responseText).errors;
      validator = this.form.validate();
      errFields = [];
      showErrors = function(errFields) {
        var channel, e, field_name, j, len, message;
        e = {};
        for (j = 0, len = errFields.length; j < len; j++) {
          field_name = errFields[j];
          channel = "channel[" + field_name + "]";
          message = "invalid " + field_name + " link";
          e[channel] = message;
        }
        return validator.showErrors(e);
      };
      if (err.hasOwnProperty('tumblr')) {
        errFields.push('tumblr');
      }
      if (err.hasOwnProperty('youtube')) {
        errFields.push('youtube');
      }
      if (err.hasOwnProperty('vimeo')) {
        errFields.push('vimeo');
      }
      if (errFields.length) {
        showErrors(errFields);
        return true;
      } else {
        return false;
      }
    };

    ConfirmableFormSubmitLogic.prototype.save = function(e) {
      e.preventDefault();
      e.stopPropagation();
      this.main.showLoader();
      return this.provider(this.form.serialize(), {
        success: (function(_this) {
          return function(resp) {
            Growl.succ(I18n.t("profile.edit.saved_successfull.header"), I18n.t("profile.edit.saved_successfull.message"));
            if (_this.onSuccess != null) {
              return _this.onSuccess(resp);
            }
          };
        })(this),
        error: (function(_this) {
          return function(r) {
            if (!_this.externalAccountLinkError(r)) {
              return ErrorMessages.internalServerError();
            }
          };
        })(this),
        complete: (function(_this) {
          return function() {
            _this.main.hideLoader();
            return _this.form.find("input#password").val("");
          };
        })(this)
      });
    };

    ConfirmableFormSubmitLogic.prototype.setInitialState = function() {
      var dirtyLinkFields;
      this.initialState = this.input.val();
      dirtyLinkFields = this.form.find('input.settings__link-field').filter(function() {
        return this.value.length > 0;
      });
      return dirtyLinkFields.each(function(i, inp) {
        return $(inp).addClass(' ignore');
      });
    };

    return ConfirmableFormSubmitLogic;

  })();

}).call(this);
(function() {
  widgets.StoryCoubForm = (function() {
    StoryCoubForm.ATTR_NAME = 'widget-story-coub-form';

    StoryCoubForm.EVENTS = {
      FORM_FILLED: 'widgets.StoryCoubForm::Event::FormFilled',
      MOVE_UP: 'widgets.StoryCoubForm::Event::MoveUp',
      MOVE_DOWN: 'widgets.StoryCoubForm::Event::MoveDown',
      DELETE: 'widgets.StoryCoubForm::Event::Delete'
    };

    StoryCoubForm.ERRORS = {
      NO_COUB: "widgets.StoryCoubForm::Error::NoCoub",
      HEADLINE_CHARS_LIMIT_REACHED: "widgets.StoryCoubForm::Error::HeadlineCharsLimitReached"
    };

    function StoryCoubForm(el) {
      this.el = el;
      new utils.ObservableMixin(this);
      this.s = this.constructor;
    }

    StoryCoubForm.prototype.init = function() {
      this.thumbnailRadioBtn = $('.story-form__coub-form__header input[name="story[thumbnail_coub_id]"]', this.el);
      this.thumbnailLabel = $('.story-form__coub-form__header label', this.el);
      this.headlineCounter = chms.utils.Autoinit.init(widgets.InputCounter, this.el)[0];
      this.initCoub();
      this.initCoubInput();
      this.initDeleteButton();
      this.initSortButtons();
      return this.initHeadlineInput();
    };

    StoryCoubForm.prototype.initCoub = function() {
      var json, script;
      this.coubContainer = $('.story-form__coub-form__coub', this.el);
      script = $('> .data', this.coubContainer);
      if (!script.length) {
        return;
      }
      json = JSON.parse(script.text());
      script.remove();
      return this.appendCoub(json);
    };

    StoryCoubForm.prototype.appendCoub = function(json) {
      var card;
      this.isFormFilled = true;
      json.render = {
        'no-sharing': 'true'
      };
      card = $(JST['app/site/templates/coub_block/coub'](json));
      card.prependTo(this.coubContainer);
      this.coubContainer.removeClass('-hidden');
      return CoubBlockClientside.constructFromContainer(this.coubContainer);
    };

    StoryCoubForm.prototype.initCoubInput = function() {
      var submit;
      this.coubInputContainer = $('.story-form__coub-form__input-container', this.el);
      this.coubInput = $('> .input-field', this.coubInputContainer);
      submit = (function(_this) {
        return function() {
          if (_this.isCoubLoading) {
            return;
          }
          return _.defer(function() {
            var p, url;
            url = _this.coubInput.val();
            if (p = helpers.Application.getCoubPermalinkFromUrl(url)) {
              return _this.loadCoub(p);
            } else {
              _this.setCoubInputErrorClass();
              return _this.onError('ты написал хуйню вместо урла коба, неудачник');
            }
          });
        };
      })(this);
      this.coubInput.on('keydown', (function(_this) {
        return function(e) {
          if (_this.isCoubLoading) {
            e.preventDefault();
          }
          if (e.keyCode === Utils.KEY_CODES.ENTER) {
            return submit();
          }
        };
      })(this));
      return this.coubInput.on('paste', submit);
    };

    StoryCoubForm.prototype.setCoubInputErrorClass = function() {
      return this.coubInput.addClass('error').one('input', function(e) {
        return $(this).removeClass('error');
      });
    };

    StoryCoubForm.prototype.loadCoub = function(permalink) {
      this.isCoubLoading = true;
      this.coubInput.addClass('disabled');
      LoadIndicator.appendToContainer(this.coubInputContainer, LoadIndicator.SIZE.SMALL, LoadIndicator.ALIGN.RIGHT);
      return $.get(Routes.check_coub_api_v2_stories_path({
        permalink: permalink
      })).done((function(_this) {
        return function(coubJson) {
          var thumbnailInputId;
          thumbnailInputId = "story_thumbnail_coub_id_" + coubJson.id;
          _this.thumbnailRadioBtn.attr("id", thumbnailInputId).val(coubJson.id);
          _this.thumbnailLabel.attr("for", thumbnailInputId);
          _this.coubInput.addClass('-hidden').val(coubJson.id);
          _this.appendCoub(coubJson);
          return _this.trigger(_this.s.EVENTS.FORM_FILLED);
        };
      })(this)).fail((function(_this) {
        return function(e) {
          _this.setCoubInputErrorClass();
          return _this.onError("чото коб не грузится, хуй знает");
        };
      })(this)).always((function(_this) {
        return function() {
          _this.isCoubLoading = false;
          _this.coubInput.removeClass('disabled');
          return LoadIndicator.removeFromContainer(_this.coubInputContainer);
        };
      })(this));
    };

    StoryCoubForm.prototype.initDeleteButton = function() {
      this.deleteBtn = $('.delete-coub', this.el);
      return this.deleteBtn.click((function(_this) {
        return function() {
          return _this.trigger(_this.s.EVENTS.DELETE);
        };
      })(this));
    };

    StoryCoubForm.prototype.initSortButtons = function() {
      this.up = $('.story-form__coub-form__sort .up', this.el);
      this.down = $('.story-form__coub-form__sort .down', this.el);
      this.up.on('click', (function(_this) {
        return function() {
          return _this.trigger(_this.s.EVENTS.MOVE_UP);
        };
      })(this));
      return this.down.on('click', (function(_this) {
        return function() {
          return _this.trigger(_this.s.EVENTS.MOVE_DOWN);
        };
      })(this));
    };

    StoryCoubForm.prototype.setIndex = function(i, total) {
      var isThumbnailDisabled;
      $('.story-form__coub-form__header h5 span', this.el).text(i + 1);
      isThumbnailDisabled = !this.isFormFilled || total < 3;
      this.up.toggleClass('disabled', i === 0 || !this.isFormFilled);
      this.down.toggleClass('disabled', i === total - 2 || !this.isFormFilled);
      this.deleteBtn.toggleClass('disabled', !this.isFormFilled);
      return this.thumbnailLabel.add(this.thumbnailRadioBtn).toggleClass('disabled', isThumbnailDisabled);
    };

    StoryCoubForm.prototype.initHeadlineInput = function() {
      return $('.story-form__coub-form__input__headline', this.el).on("input", function(e) {
        return this.value = this.value.replace(/\r|\n/g, " ");
      });
    };

    StoryCoubForm.prototype.isThumbnail = function() {
      return this.thumbnailRadioBtn.prop('checked');
    };

    StoryCoubForm.prototype.setThumbnail = function() {
      return this.thumbnailRadioBtn.prop('checked', true);
    };

    StoryCoubForm.prototype.destroy = function() {
      this.el.height(this.el.height());
      return setTimeout((function(_this) {
        return function() {
          _this.el.addClass('-deleted');
          return setTimeout(function() {
            return _this.el.remove();
          }, 500);
        };
      })(this), 50);
    };

    StoryCoubForm.prototype.check = function() {
      if (this.coubInput.val() && !this.isFormFilled) {
        return {
          el: this.coubInput,
          message: this.s.ERRORS.NO_COUB
        };
      }
      if (this.headlineCounter.isCharsLimitReached()) {
        return {
          el: this.headlineCounter.el,
          message: this.s.ERRORS.HEADLINE_CHARS_LIMIT_REACHED
        };
      }
      return null;
    };

    StoryCoubForm.prototype.disable = function() {
      return this.el.addClass('disabled');
    };

    StoryCoubForm.prototype.enable = function() {
      return this.el.removeClass('disabled');
    };

    StoryCoubForm.prototype.onError = function(e) {
      return console.error(e);
    };

    return StoryCoubForm;

  })();

}).call(this);
(function() {
  window.StoryCoubForms = (function() {
    function StoryCoubForms(el4) {
      var form, j, len, ref;
      this.el = el4;
      this.storyCoubForms = chms.utils.Autoinit.init(widgets.StoryCoubForm, this.el);
      this.saveFormTemplate();
      ref = this.storyCoubForms;
      for (j = 0, len = ref.length; j < len; j++) {
        form = ref[j];
        form.init();
        this.addListeners(form);
      }
      this.initCoubsPause();
    }

    StoryCoubForms.prototype.initCoubsPause = function() {
      var viewers;
      viewers = $('.viewer', this.el);
      return viewers.on('playWasStarted', (function(_this) {
        return function(e) {
          return viewers.filter(function(i, el) {
            return e.currentTarget !== el;
          }).trigger('suspend');
        };
      })(this));
    };

    StoryCoubForms.prototype.addListeners = function(form) {
      form.on(widgets.StoryCoubForm.EVENTS.DELETE, (function(_this) {
        return function() {
          return _this.deleteForm(form);
        };
      })(this));
      form.on(widgets.StoryCoubForm.EVENTS.FORM_FILLED, (function(_this) {
        return function() {
          return _this.addNewForm();
        };
      })(this));
      form.on(widgets.StoryCoubForm.EVENTS.MOVE_UP, (function(_this) {
        return function() {
          return _this.moveForm(form, -1);
        };
      })(this));
      return form.on(widgets.StoryCoubForm.EVENTS.MOVE_DOWN, (function(_this) {
        return function() {
          return _this.moveForm(form, 1);
        };
      })(this));
    };

    StoryCoubForms.prototype.moveForm = function(form, i) {
      var animationStep1, animationStep2, animationStep3, el1, el2, el3, h1, h2, index, mb, moveUp, newIndex, t1, t2;
      if (this.isFormAnimated) {
        return;
      }
      this.isFormAnimated = true;
      index = this.storyCoubForms.indexOf(form);
      newIndex = index + i;
      moveUp = i < 0;
      el1 = form.el;
      h1 = el1.height();
      t1 = el1.offset().top;
      el2 = this.storyCoubForms[newIndex].el;
      h2 = el2.height();
      t2 = el2.offset().top;
      el3 = moveUp ? this.storyCoubForms[index + 1].el : this.storyCoubForms[newIndex + 1].el;
      mb = 19;
      el1.addClass('-on-top').css({
        top: t1 + "px"
      });
      el2.css({
        top: t2 + "px"
      });
      this.storyCoubForms.splice(index, 1);
      this.storyCoubForms.splice(newIndex, 0, form);
      this.updateIndices();
      animationStep1 = (function(_this) {
        return function() {
          el1.addClass('-animated -scaled').css({
            top: (moveUp ? t2 : t1 + h2 + mb) + "px"
          });
          el2.addClass('-animated -scaled').css({
            top: (moveUp ? t2 + h1 + mb : t1) + "px"
          });
          return el3.css({
            'margin-top': (h1 + h2 + 3 * mb) + "px"
          });
        };
      })(this);
      animationStep2 = (function(_this) {
        return function() {
          el1.removeClass('-scaled');
          return el2.removeClass('-scaled');
        };
      })(this);
      animationStep3 = (function(_this) {
        return function() {
          el1.removeClass('-animated -on-top').css({
            top: 0
          });
          el2.removeClass('-animated').css({
            top: 0
          });
          el3.css({
            'margin-top': 0
          });
          if (moveUp) {
            el2.before(el1);
          } else {
            el2.after(el1);
          }
          return _this.isFormAnimated = false;
        };
      })(this);
      return requestAnimationFrame((function(_this) {
        return function() {
          animationStep1();
          setTimeout(animationStep2, 400);
          return setTimeout(animationStep3, 800);
        };
      })(this));
    };

    StoryCoubForms.prototype.deleteForm = function(form) {
      var isThumbnail;
      isThumbnail = form.isThumbnail();
      form.off(widgets.StoryCoubForm.EVENTS.DELETE).off(widgets.StoryCoubForm.EVENTS.FORM_FILLED).off(widgets.StoryCoubForm.EVENTS.MOVE_UP).off(widgets.StoryCoubForm.EVENTS.MOVE_DOWN).destroy();
      this.storyCoubForms.splice(this.storyCoubForms.indexOf(form), 1);
      if (this.storyCoubForms.length === 0) {
        this.addNewForm();
      }
      if (isThumbnail) {
        this.storyCoubForms[0].setThumbnail();
      }
      this.updateIndices();
      return this.checkCoubsCount();
    };

    StoryCoubForms.prototype.addNewForm = function() {
      var form, formEl;
      formEl = this.formTemplate.clone();
      this.el.append(formEl);
      form = new widgets.StoryCoubForm(formEl);
      form.init();
      this.addListeners(form);
      this.storyCoubForms.push(form);
      this.updateIndices();
      this.checkCoubsCount();
      if (this.storyCoubForms.length === 2) {
        return this.storyCoubForms[0].setThumbnail();
      }
    };

    StoryCoubForms.prototype.checkCoubsCount = function() {
      if (this.storyCoubForms.length > 60) {
        return _.last(this.storyCoubForms).disable();
      } else {
        return _.last(this.storyCoubForms).enable();
      }
    };

    StoryCoubForms.prototype.saveFormTemplate = function() {
      var last, ref;
      ref = this.storyCoubForms, last = ref[ref.length - 1];
      return this.formTemplate = last.el.clone();
    };

    StoryCoubForms.prototype.updateIndices = function() {
      var form, i, j, len, ref, results;
      ref = this.storyCoubForms;
      results = [];
      for (i = j = 0, len = ref.length; j < len; i = ++j) {
        form = ref[i];
        results.push(form.setIndex(i, this.storyCoubForms.length));
      }
      return results;
    };

    StoryCoubForms.prototype.check = function() {
      var error, form, j, len, ref;
      if (this.storyCoubForms.length === 1) {
        return {
          message: "добавь хотя бы один коб, епта",
          el: this.storyCoubForms[0].coubInput
        };
      }
      ref = this.storyCoubForms;
      for (j = 0, len = ref.length; j < len; j++) {
        form = ref[j];
        error = form.check();
        if (error) {
          return error;
        }
      }
    };

    return StoryCoubForms;

  })();

}).call(this);
(function() {
  window.StoryForm = (function() {
    StoryForm.ATTR_NAME = 'story-form';

    function StoryForm(el1) {
      this.el = el1;
      this.storyCoubsController = new StoryCoubForms($('.story-form__coub-forms', this.el));
      this.inputs = chms.utils.Autoinit.init(widgets.InputCounter, this.el);
      chms.utils.Autoinit.init(widgets.LinkInserter, this.el);
      $('.story-form__channels-dropdown .niceScroller', this.el).nice_scroller();
      window.onbeforeunload = function() {
        return 'Are you sure you want to navigate away from this page?';
      };
      this.initTagit();
      this.initSubmit();
    }

    StoryForm.prototype.initTagit = function() {
      return $('.story-tags', this.el).tagit({
        allowDuplicates: false,
        allowSpaces: true,
        useCoubAutocomplete: true,
        placeholderText: I18n.t('stories.form.tags'),
        fieldName: 'tags[]',
        autocomplete: {
          source: (function(_this) {
            return function(search, showChoices) {
              _this.currentQuery && _this.currentQuery.abort();
              return _this.debouncedSearch(search, showChoices);
            };
          })(this)
        },
        onTagClicked: function(event, ui) {
          return $(this).tagit('removeTag', ui.tag);
        },
        preprocessTag: function(val) {
          return val.replace(/[#,]/g, "");
        },
        afterTagAdded: function(e, tag) {
          return $(this).data('uiTagit').tagInput.attr('placeholder', '');
        },
        afterTagRemoved: function(e, tag) {
          if ($(this).tagit('assignedTags').length) {
            return;
          }
          return $(this).data('uiTagit').tagInput.attr('placeholder', 'Tags');
        }
      }).removeClass('-hidden');
    };

    StoryForm.prototype.debouncedSearch = _.throttle(function(search, showChoices) {
      this.currentQuery = $.get(Routes.search_api_v2_tags_path(), {
        title: search
      });
      return this.currentQuery.done(function(data) {
        var availableTags;
        availableTags = _.pluck(data, 'value').map(function(v) {
          return decodeURIComponent(v);
        });
        return showChoices(availableTags);
      });
    }, 300);

    StoryForm.prototype.initSubmit = function() {
      this.form = $('> form', this.el);
      this.form.on('submit', (function(_this) {
        return function(e) {
          return e.preventDefault();
        };
      })(this));
      $('.sb.save-as-draft', this.el).on('click', (function(_this) {
        return function() {
          return _this.submit(false);
        };
      })(this));
      return $('.sb.publish', this.el).on('click', (function(_this) {
        return function() {
          return _this.submit(true);
        };
      })(this));
    };

    StoryForm.prototype.setError = function(error) {
      var el, msg, top;
      el = error.el;
      msg = error.message;
      if (el.hasClass('input-field') && !el.hasClass('error')) {
        el.addClass('error').one('input', function(e) {
          return $(this).removeClass('error');
        });
      }
      top = error.el.offset().top - 75;
      if ($(window).scrollTop() > top) {
        $('html, body').animate({
          scrollTop: top
        }, 500);
      }
      return console.error(msg);
    };

    StoryForm.prototype.submit = function(isPublish) {
      var data, descriptionField, error, i, j, len, ref, url;
      if (this.isLoading) {
        return;
      }
      if (error = this.storyCoubsController.check()) {
        this.setError(error);
        return;
      }
      if (!$('.story-heading', this.el).val()) {
        this.setError({
          el: $('.story-heading', this.el),
          message: 'нет заголовка'
        });
        return;
      }
      ref = this.inputs;
      for (j = 0, len = ref.length; j < len; j++) {
        i = ref[j];
        if (i.isCharsLimitReached()) {
          this.setError({
            el: i.el,
            message: 'много символов'
          });
          return;
        }
      }
      $('.is-published-checkbox', this.el).attr('checked', isPublish);
      data = this.form.serialize();
      url = this.form.attr('action');
      this.isLoading = true;
      if (window.is_editor && location.href.indexOf('/new') !== -1) {
        descriptionField = this.form[0]["story[description]"];
        if (descriptionField && descriptionField.value === "" && !confirm("Похоже поле описание пустое, это ок?")) {
          this.isLoading = false;
          return;
        }
      }
      $.post(url, data).done(function(r) {
        window.onbeforeunload = null;
        return location.href = Routes.story_path(r.id);
      }).fail(function(e) {
        this.isLoading = false;
        return alert(e.responseText);
      });
      return window.ym && ym(48571952, "reachGoal", "created_story");
    };

    return StoryForm;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.StoryCoubsScroller = (function() {
    StoryCoubsScroller.prototype.SCROLL_QUEUE_NAME = 'StoryCoubsScroller:ScrollQueue';

    function StoryCoubsScroller(el1, opts) {
      this.el = el1;
      this.opts = opts;
      this.onKeyUp = bind(this.onKeyUp, this);
      this.onKeyDown = bind(this.onKeyDown, this);
      this.stopScrollToCoub = bind(this.stopScrollToCoub, this);
      this.onScroll = bind(this.onScroll, this);
      this.initScroll();
      if (this.opts.enableKeyboard) {
        this.initKeyboard();
      }
      if (this.opts.smartImmediatePlay) {
        this.smartImmediatePlay();
      }
      this.el.on("click", ".viewer", (function(_this) {
        return function(e) {
          return _this.playCoub($(e.currentTarget));
        };
      })(this));
    }

    StoryCoubsScroller.prototype.playCoub = function(viewer) {
      var next, prev;
      if (!viewer || !viewer.length || viewer.hasClass('active')) {
        return;
      }
      prev = $('.viewer.active', this.el);
      prev.add(prev.closest(".coub")).removeClass('active');
      prev.triggerHandler(this.opts.unloadCoubs ? 'unembed' : 'suspend');
      viewer.add(viewer.closest(".coub")).addClass("active");
      viewer.triggerHandler('play');
      if (this.opts.enableKeyboard) {
        helpers.Application.setFocusNoScroll(viewer);
      }
      if (this.opts.noPreload) {
        return;
      }
      clearTimeout(this.preloadTimeout);
      next = viewer.closest(this.opts.coubSelector).nextAll(this.opts.coubSelector).first();
      if (!next.length) {
        return;
      }
      return this.preloadTimeout = setTimeout(function(nextCoub) {
        return $('.viewer', nextCoub).triggerHandler('preload');
      }, 300, next);
    };

    StoryCoubsScroller.prototype.initScroll = function() {
      $(window).on('scroll', _.throttle(this.onScroll, 300));
      $(window).on('wheel', this.stopScrollToCoub);
      if (this.opts.immediatePlay) {
        return this.onScroll();
      }
    };

    StoryCoubsScroller.prototype.onScroll = function() {
      if (this.isScrollingToCoub) {
        return;
      }
      return this.playCoub(this.getCoubToPlay());
    };

    StoryCoubsScroller.prototype.stopScrollToCoub = function() {
      if (!this.isScrollingToCoub) {
        return;
      }
      $('html, body').stop(this.SCROLL_QUEUE_NAME, true);
      return this.isScrollingToCoub = false;
    };

    StoryCoubsScroller.prototype.getCoubToPlay = function() {
      var $viewers, fullySel, fullyVisible, index, max, ratios, wb, wh, wt;
      $viewers = $(this.opts.coubSelector + " .viewer", this.el);
      fullySel = ":in-viewport-with-offsets(" + this.opts.offsetTop + "," + this.opts.offsetBottom + ")";
      fullyVisible = $viewers.filter(fullySel);
      if (fullyVisible.length) {
        return fullyVisible.first();
      } else {
        wh = $(window).height() - (this.opts.offsetTop + this.opts.offsetBottom);
        wt = $(window).scrollTop() + this.opts.offsetTop;
        wb = wt + wh;
        ratios = _.map($viewers, function(el) {
          var $el, b, eb, eh, et, t;
          $el = $(el);
          eh = $el.height();
          et = $el.offset().top;
          eb = et + eh;
          t = Math.max(wt, et);
          b = Math.min(wb, eb);
          return (b - t) / eh;
        });
        max = _.max(ratios);
        if (max <= 0) {
          return;
        }
        index = ratios.indexOf(max);
        return $viewers.eq(index);
      }
    };

    StoryCoubsScroller.prototype.smartImmediatePlay = function() {
      var $firstBlock, bottomPos;
      if ($(window).scrollTop() > 0) {
        return;
      }
      $firstBlock = $(this.opts.coubSelector + " .viewer").first();
      bottomPos = $firstBlock.offset().top + $firstBlock.height();
      if (bottomPos < window.innerHeight) {
        return this.playCoub($firstBlock);
      }
    };

    StoryCoubsScroller.prototype.initKeyboard = function() {
      $(window).on('keydown', this.onKeyDown);
      return $(window).on('keyup', this.onKeyUp);
    };

    StoryCoubsScroller.prototype.onKeyDown = function(e) {
      if (e.metaKey || $(document.activeElement).is('input, textarea') || helpers.Location.isFullScreen()) {
        return;
      }
      switch (e.keyCode) {
        case Utils.KEY_CODES.UP:
        case Utils.KEY_CODES.k:
          e.preventDefault();
          e.stopPropagation();
          return this.gotoBlock(-1);
        case Utils.KEY_CODES.DOWN:
        case Utils.KEY_CODES.j:
          e.preventDefault();
          e.stopPropagation();
          return this.gotoBlock(1);
        case Utils.KEY_CODES.SPACE:
          e.preventDefault();
          e.stopPropagation();
          return this.gotoBlock(e.shiftKey ? -1 : 1);
      }
    };

    StoryCoubsScroller.prototype.onKeyUp = function(e) {
      if (e.metaKey) {
        return;
      }
      switch (e.keyCode) {
        case Utils.KEY_CODES.UP:
        case Utils.KEY_CODES.DOWN:
        case Utils.KEY_CODES.j:
        case Utils.KEY_CODES.k:
        case Utils.KEY_CODES.SPACE:
          e.preventDefault();
          return e.stopPropagation();
      }
    };

    StoryCoubsScroller.prototype.gotoBlock = function(dir) {
      var coubs, current, currentIndex, newIndex, next;
      coubs = $('.viewer', this.el);
      current = coubs.filter('.active');
      next = !current.length ? coubs.first() : (currentIndex = coubs.index(current), newIndex = currentIndex + (dir > 0 ? 1 : -1), newIndex = Math.max(newIndex, 0), newIndex = Math.min(newIndex, coubs.length - 1), coubs.eq(newIndex));
      this.scrollToCoub(next);
      return this.playCoub(next);
    };

    StoryCoubsScroller.prototype.scrollToCoub = function(viewer) {
      var h3, scrollPos;
      h3 = viewer.closest(this.opts.coubSelector).prev();
      scrollPos = h3.offset().top - this.opts.offsetTop - 20;
      $('html, body').stop(this.SCROLL_QUEUE_NAME, true).animate({
        scrollTop: scrollPos
      }, {
        duration: 250,
        queue: this.SCROLL_QUEUE_NAME
      }).dequeue(this.SCROLL_QUEUE_NAME);
      return this.isScrollingToCoub = true;
    };

    return StoryCoubsScroller;

  })();

}).call(this);
(function($, undefined) {

/**
 * Unobtrusive scripting adapter for jQuery
 *
 * Requires jQuery 1.6.0 or later.
 * https://github.com/rails/jquery-ujs

 * Uploading file using rails.js
 * =============================
 *
 * By default, browsers do not allow files to be uploaded via AJAX. As a result, if there are any non-blank file fields
 * in the remote form, this adapter aborts the AJAX submission and allows the form to submit through standard means.
 *
 * The `ajax:aborted:file` event allows you to bind your own handler to process the form submission however you wish.
 *
 * Ex:
 *     $('form').live('ajax:aborted:file', function(event, elements){
 *       // Implement own remote file-transfer handler here for non-blank file inputs passed in `elements`.
 *       // Returning false in this handler tells rails.js to disallow standard form submission
 *       return false;
 *     });
 *
 * The `ajax:aborted:file` event is fired when a file-type input is detected with a non-blank value.
 *
 * Third-party tools can use this hook to detect when an AJAX file upload is attempted, and then use
 * techniques like the iframe method to upload the file instead.
 *
 * Required fields in rails.js
 * ===========================
 *
 * If any blank required inputs (required="required") are detected in the remote form, the whole form submission
 * is canceled. Note that this is unlike file inputs, which still allow standard (non-AJAX) form submission.
 *
 * The `ajax:aborted:required` event allows you to bind your own handler to inform the user of blank required inputs.
 *
 * !! Note that Opera does not fire the form's submit event if there are blank required inputs, so this event may never
 *    get fired in Opera. This event is what causes other browsers to exhibit the same submit-aborting behavior.
 *
 * Ex:
 *     $('form').live('ajax:aborted:required', function(event, elements){
 *       // Returning false in this handler tells rails.js to submit the form anyway.
 *       // The blank required inputs are passed to this function in `elements`.
 *       return ! confirm("Would you like to submit the form with missing info?");
 *     });
 */

  // Shorthand to make it a little easier to call public rails functions from within rails.js
  var rails;

  $.rails = rails = {
    // Link elements bound by jquery-ujs
    linkClickSelector: 'a[data-confirm], a[data-method], a[data-remote], a[data-disable-with]',

    // Select elements bound by jquery-ujs
    inputChangeSelector: 'select[data-remote], input[data-remote], textarea[data-remote]',

    // Form elements bound by jquery-ujs
    formSubmitSelector: 'form',

    // Form input elements bound by jquery-ujs
    formInputClickSelector: 'form input[type=submit], form input[type=image], form button[type=submit], form button:not(button[type])',

    // Form input elements disabled during form submission
    disableSelector: 'input[data-disable-with], button[data-disable-with], textarea[data-disable-with]',

    // Form input elements re-enabled after form submission
    enableSelector: 'input[data-disable-with]:disabled, button[data-disable-with]:disabled, textarea[data-disable-with]:disabled',

    // Form required input elements
    requiredInputSelector: 'input[name][required]:not([disabled]),textarea[name][required]:not([disabled])',

    // Form file input elements
    fileInputSelector: 'input:file',

    // Link onClick disable selector with possible reenable after remote submission
    linkDisableSelector: 'a[data-disable-with]',

    // Make sure that every Ajax request sends the CSRF token
    CSRFProtection: function(xhr) {
      var token = $('meta[name="csrf-token"]').attr('content');
      if (token) xhr.setRequestHeader('X-CSRF-Token', token);
    },

    // Triggers an event on an element and returns false if the event result is false
    fire: function(obj, name, data) {
      var event = $.Event(name);
      obj.trigger(event, data);
      return event.result !== false;
    },

    // Default confirm dialog, may be overridden with custom confirm dialog in $.rails.confirm
    confirm: function(message) {
      return confirm(message);
    },

    // Default ajax function, may be overridden with custom function in $.rails.ajax
    ajax: function(options) {
      return $.ajax(options);
    },

    // Submits "remote" forms and links with ajax
    handleRemote: function(element) {
      var method, url, data,
        crossDomain = element.data('cross-domain') || null,
        dataType = element.data('type') || ($.ajaxSettings && $.ajaxSettings.dataType),
        options;

      if (rails.fire(element, 'ajax:before')) {

        if (element.is('form')) {
          method = element.attr('method');
          url = element.attr('action');
          data = element.serializeArray();
          // memoized value from clicked submit button
          var button = element.data('ujs:submit-button');
          if (button) {
            data.push(button);
            element.data('ujs:submit-button', null);
          }
        } else if (element.is(rails.inputChangeSelector)) {
          method = element.data('method');
          url = element.data('url');
          data = element.serialize();
          if (element.data('params')) data = data + "&" + element.data('params');
        } else {
          method = element.data('method');
          url = element.attr('href');
          data = element.data('params') || null;
        }

        options = {
          type: method || 'GET', data: data, dataType: dataType, crossDomain: crossDomain,
          // stopping the "ajax:beforeSend" event will cancel the ajax request
          beforeSend: function(xhr, settings) {
            if (settings.dataType === undefined) {
              xhr.setRequestHeader('accept', '*/*;q=0.5, ' + settings.accepts.script);
            }
            return rails.fire(element, 'ajax:beforeSend', [xhr, settings]);
          },
          success: function(data, status, xhr) {
            element.trigger('ajax:success', [data, status, xhr]);
          },
          complete: function(xhr, status) {
            element.trigger('ajax:complete', [xhr, status]);
          },
          error: function(xhr, status, error) {
            element.trigger('ajax:error', [xhr, status, error]);
          }
        };
        // Only pass url to `ajax` options if not blank
        if (url) { options.url = url; }

        return rails.ajax(options);
      } else {
        return false;
      }
    },

    // Handles "data-method" on links such as:
    // <a href="/users/5" data-method="delete" rel="nofollow" data-confirm="Are you sure?">Delete</a>
    handleMethod: function(link) {
      var href = link.attr('href'),
        method = link.data('method'),
        target = link.attr('target'),
        csrf_token = $('meta[name=csrf-token]').attr('content'),
        csrf_param = $('meta[name=csrf-param]').attr('content'),
        form = $('<form method="post" action="' + href + '"></form>'),
        metadata_input = '<input name="_method" value="' + method + '" type="hidden" />';

      if (csrf_param !== undefined && csrf_token !== undefined) {
        metadata_input += '<input name="' + csrf_param + '" value="' + csrf_token + '" type="hidden" />';
      }

      if (target) { form.attr('target', target); }

      form.hide().append(metadata_input).appendTo('body');
      form.submit();
    },

    /* Disables form elements:
      - Caches element value in 'ujs:enable-with' data store
      - Replaces element text with value of 'data-disable-with' attribute
      - Sets disabled property to true
    */
    disableFormElements: function(form) {
      form.find(rails.disableSelector).each(function() {
        var element = $(this), method = element.is('button') ? 'html' : 'val';
        element.data('ujs:enable-with', element[method]());
        element[method](element.data('disable-with'));
        element.prop('disabled', true);
      });
    },

    /* Re-enables disabled form elements:
      - Replaces element text with cached value from 'ujs:enable-with' data store (created in `disableFormElements`)
      - Sets disabled property to false
    */
    enableFormElements: function(form) {
      form.find(rails.enableSelector).each(function() {
        var element = $(this), method = element.is('button') ? 'html' : 'val';
        if (element.data('ujs:enable-with')) element[method](element.data('ujs:enable-with'));
        element.prop('disabled', false);
      });
    },

   /* For 'data-confirm' attribute:
      - Fires `confirm` event
      - Shows the confirmation dialog
      - Fires the `confirm:complete` event

      Returns `true` if no function stops the chain and user chose yes; `false` otherwise.
      Attaching a handler to the element's `confirm` event that returns a `falsy` value cancels the confirmation dialog.
      Attaching a handler to the element's `confirm:complete` event that returns a `falsy` value makes this function
      return false. The `confirm:complete` event is fired whether or not the user answered true or false to the dialog.
   */
    allowAction: function(element) {
      var message = element.data('confirm'),
          answer = false, callback;
      if (!message) { return true; }

      if (rails.fire(element, 'confirm')) {
        answer = rails.confirm(message);
        callback = rails.fire(element, 'confirm:complete', [answer]);
      }
      return answer && callback;
    },

    // Helper function which checks for blank inputs in a form that match the specified CSS selector
    blankInputs: function(form, specifiedSelector, nonBlank) {
      var inputs = $(), input,
        selector = specifiedSelector || 'input,textarea';
      form.find(selector).each(function() {
        input = $(this);
        // Collect non-blank inputs if nonBlank option is true, otherwise, collect blank inputs
        if (nonBlank ? input.val() : !input.val()) {
          inputs = inputs.add(input);
        }
      });
      return inputs.length ? inputs : false;
    },

    // Helper function which checks for non-blank inputs in a form that match the specified CSS selector
    nonBlankInputs: function(form, specifiedSelector) {
      return rails.blankInputs(form, specifiedSelector, true); // true specifies nonBlank
    },

    // Helper function, needed to provide consistent behavior in IE
    stopEverything: function(e) {
      $(e.target).trigger('ujs:everythingStopped');
      e.stopImmediatePropagation();
      return false;
    },

    // find all the submit events directly bound to the form and
    // manually invoke them. If anyone returns false then stop the loop
    callFormSubmitBindings: function(form, event) {
      var events = form.data('events'), continuePropagation = true;
      if (events !== undefined && events['submit'] !== undefined) {
        $.each(events['submit'], function(i, obj){
          if (typeof obj.handler === 'function') return continuePropagation = obj.handler(event);
        });
      }
      return continuePropagation;
    },

    //  replace element's html with the 'data-disable-with' after storing original html
    //  and prevent clicking on it
    disableElement: function(element) {
      element.data('ujs:enable-with', element.html()); // store enabled state
      element.html(element.data('disable-with')); // set to disabled state
      element.bind('click.railsDisable', function(e) { // prevent further clicking
        return rails.stopEverything(e)
      });
    },

    // restore element to its original state which was disabled by 'disableElement' above
    enableElement: function(element) {
      if (element.data('ujs:enable-with') !== undefined) {
        element.html(element.data('ujs:enable-with')); // set to old enabled state
        // this should be element.removeData('ujs:enable-with')
        // but, there is currently a bug in jquery which makes hyphenated data attributes not get removed
        element.data('ujs:enable-with', false); // clean up cache
      }
      element.unbind('click.railsDisable'); // enable element
    }

  };

  $.ajaxPrefilter(function(options, originalOptions, xhr){ if ( !options.crossDomain ) { rails.CSRFProtection(xhr); }});

  $(document).delegate(rails.linkDisableSelector, 'ajax:complete', function() {
      rails.enableElement($(this));
  });

  $(document).delegate(rails.linkClickSelector, 'click.rails', function(e) {
    var link = $(this), method = link.data('method'), data = link.data('params');
    if (!rails.allowAction(link)) return rails.stopEverything(e);

    if (link.is(rails.linkDisableSelector)) rails.disableElement(link);

    if (link.data('remote') !== undefined) {
      if ( (e.metaKey || e.ctrlKey) && (!method || method === 'GET') && !data ) { return true; }

      if (rails.handleRemote(link) === false) { rails.enableElement(link); }
      return false;

    } else if (link.data('method')) {
      rails.handleMethod(link);
      return false;
    }
  });

  $(document).delegate(rails.inputChangeSelector, 'change.rails', function(e) {
    var link = $(this);
    if (!rails.allowAction(link)) return rails.stopEverything(e);

    rails.handleRemote(link);
    return false;
  });

  $(document).delegate(rails.formSubmitSelector, 'submit.rails', function(e) {
    var form = $(this),
      remote = form.data('remote') !== undefined,
      blankRequiredInputs = rails.blankInputs(form, rails.requiredInputSelector),
      nonBlankFileInputs = rails.nonBlankInputs(form, rails.fileInputSelector);

    if (!rails.allowAction(form)) return rails.stopEverything(e);

    // skip other logic when required values are missing or file upload is present
    if (blankRequiredInputs && form.attr("novalidate") == undefined && rails.fire(form, 'ajax:aborted:required', [blankRequiredInputs])) {
      return rails.stopEverything(e);
    }

    if (remote) {
      if (nonBlankFileInputs) {
        return rails.fire(form, 'ajax:aborted:file', [nonBlankFileInputs]);
      }

      // If browser does not support submit bubbling, then this live-binding will be called before direct
      // bindings. Therefore, we should directly call any direct bindings before remotely submitting form.
      if (!$.support.submitBubbles && $().jquery < '1.7' && rails.callFormSubmitBindings(form, e) === false) return rails.stopEverything(e);

      rails.handleRemote(form);
      return false;

    } else {
      // slight timeout so that the submit button gets properly serialized
      setTimeout(function(){ rails.disableFormElements(form); }, 13);
    }
  });

  $(document).delegate(rails.formInputClickSelector, 'click.rails', function(event) {
    var button = $(this);

    if (!rails.allowAction(button)) return rails.stopEverything(event);

    // register the pressed submit button
    var name = button.attr('name'),
      data = name ? {name:name, value:button.val()} : null;

    button.closest('form').data('ujs:submit-button', data);
  });

  $(document).delegate(rails.formSubmitSelector, 'ajax:beforeSend.rails', function(event) {
    if (this == event.target) rails.disableFormElements($(this));
  });

  $(document).delegate(rails.formSubmitSelector, 'ajax:complete.rails', function(event) {
    if (this == event.target) rails.enableFormElements($(this));
  });

})( jQuery );
(function() {
  window.StoryPage = (function() {
    StoryPage.ATTR_NAME = 'story-page';

    function StoryPage(el1) {
      this.el = el1;
      this.hasTimelineAds = this.el.attr('data-has-timeline-ads') != null;
      chms.utils.Autoinit.init(widgets.CopyLinkToClipboard, this.el);
      CustomSharingButton.constructIn(this.el);
      chms.utils.Autoinit.init(widgets.ChannelDropdown, $('.story__stamp', this.el));
      new TagsBlock({
        el: $('.story__tags', this.el)
      });
      this.initCoubs();
      this.adjustCoubsMaxHeight();
      this.initLikeRepost();
      new StoryCoubsScroller(this.el, {
        coubSelector: '.story__coub',
        offsetTop: $('header.header').height(),
        offsetBottom: 0,
        enableKeyboard: true,
        smartImmediatePlay: true
      });
    }

    StoryPage.prototype.initCoubs = function() {
      var coubsPerPage;
      coubsPerPage = 4;
      $('.story__coub > script', this.el).each((function(_this) {
        return function(i, el) {
          var adsContainer, card, json;
          el = $(el);
          json = JSON.parse(el.html());
          $.extend(json, {
            render: {
              'no-sharing': 'true',
              'no-tags': 'true',
              'no-date': 'true'
            },
            timelinePage: Math.floor(i / coubsPerPage) + 1,
            timelineIndex: i % coubsPerPage
          });
          card = JST['app/site/templates/coub_block/coub'](json);
          el.parent().prepend(card);
          if (_this.hasTimelineAds && (i - 3) % 7 === 0) {
            adsContainer = $("<div class='story__coub timeline-banner'/>").insertAfter(el.parent());
            $('<h3>').insertAfter(el.parent());
            return new widgets.StoryCoubsBanner(adsContainer);
          }
        };
      })(this));
      $('.story__coub', this.el).removeAttr('style');
      CoubBlockClientside.constructFromContainer($('.story__coub', this.el), {}, {
        timelineProviderUrl: Routes.coubs_api_v2_story_path(this.el.attr("story-id"), {
          per_page: coubsPerPage
        })
      });
      return $('.viewer', this.el).trigger('hidefinger');
    };

    StoryPage.prototype.adjustCoubsMaxHeight = function() {
      var maxHeight;
      maxHeight = 520;
      return $('.story__coub', this.el).each(function() {
        var $storyCoub, p, vh, viewer;
        $storyCoub = $(this);
        viewer = $storyCoub.find('.coub__viewer');
        if ((vh = viewer.height()) > maxHeight) {
          p = maxHeight / vh;
          return $storyCoub.css({
            width: (p * 100) + "%"
          });
        }
      });
    };

    StoryPage.prototype.initLikeRepost = function() {
      var button, buttons_container, dropdown, j, k, len, len1, ref, ref1;
      buttons_container = $('.story__sharing', this.el);
      ref = [widgets.LikeStoryButton, widgets.RepostStoryButton];
      for (j = 0, len = ref.length; j < len; j++) {
        button = ref[j];
        chms.utils.Autoinit.init(button, buttons_container);
      }
      buttons_container.find("[widget-counter]").each(function() {
        return new widgets.Counter($(this), helpers.Application.roundToK);
      });
      ref1 = [blocks.LikesStoryListDropdown, blocks.RepostsStoryListDropdown];
      for (k = 0, len1 = ref1.length; k < len1; k++) {
        dropdown = ref1[k];
        blocks.UserListDropdownAbstract.constructIn(dropdown, buttons_container, true);
      }
      $(".niceScroller", buttons_container).nice_scroller();
      if (!GlobalState.USER.isLogedIn()) {
        UnlogedActionHandler.construct(buttons_container);
      }
      if (window.is_admin || window.is_editor) {
        chms.utils.Autoinit.init(siteAdmin.moderation.StoryModerationOpenerWidget, this.el);
      }
      return this.el.one(widgets.LikeButton.EVENTS.LIKE_POSTED, (function(_this) {
        return function() {
          return $("[" + widgets.LikeStoryButton.ATTR_NAME + "]", _this.el).first().triggerHandler(widgets.LikeStoryButton.ACTIONS.AUTOLIKE);
        };
      })(this));
    };

    return StoryPage;

  })();

}).call(this);
(function() {
  widgets.InputCounter = (function() {
    InputCounter.ATTR_NAME = 'widget-input-counter';

    InputCounter.ACTIONS = {
      REFRESH: 'InputCounter::Actions::Refresh'
    };

    function InputCounter(el) {
      this.el = el;
      this.s = this.constructor;
      this.limit = this.el.attr('data-chars-limit');
      this.field = $('> input, > textarea', this.el);
      this.indicator = $('> span', this.el);
      this.el.on("keydown keyup change paste " + this.s.ACTIONS.REFRESH, this.check.bind(this));
      this.check();
    }

    InputCounter.prototype.check = function() {
      var charsLeft, count;
      count = this.el.attr('data-count') || this.field.val().length;
      charsLeft = this.limit - count;
      this.indicator.text(charsLeft).toggleClass('-limit-reached', charsLeft < 0);
      return this.field.toggleClass('error', charsLeft < 0);
    };

    InputCounter.prototype.isCharsLimitReached = function() {
      return this.indicator.hasClass('-limit-reached');
    };

    return InputCounter;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.LinkInserter = (function() {
    LinkInserter.ATTR_NAME = 'widget-link-inserter';

    function LinkInserter(el1) {
      this.el = el1;
      this.onPaste = bind(this.onPaste, this);
      this.onKeyUp = bind(this.onKeyUp, this);
      this.onSelection = bind(this.onSelection, this);
      this.onPlaceholder = bind(this.onPlaceholder, this);
      this.placeholder = $("<div class='wysiwyg-placeholder -hidden'>" + (this.el.attr('placeholder')) + "</div>");
      this.w = wysiwyg({
        element: this.el[0],
        onPlaceholder: this.onPlaceholder,
        onSelection: this.onSelection,
        onKeyUp: this.onKeyUp
      });
      this.wElement = $(this.w.getElement());
      this.wElement.wrap("<div class='" + (this.el.attr('class')) + " wysiwyg-container'></div>").addClass('wysiwyg-editor').on('paste', this.onPaste);
      this.container = this.wElement.parent();
      this.container.append(this.placeholder);
      this.el.insertAfter(this.container);
      this.parseWysiwygContent();
    }

    LinkInserter.prototype.onPlaceholder = function(isVisible) {
      return this.placeholder.toggleClass('-hidden', !isVisible);
    };

    LinkInserter.prototype.onSelection = function(collapsed, rect, nodes, rightclick) {
      var link, popup;
      if (this.preventPopup) {
        this.preventPopup = false;
        return;
      }
      if (collapsed) {
        link = null;
        $.each(nodes, (function(_this) {
          return function(index, node) {
            var popup;
            link = $(node).closest('a');
            if (link.length) {
              popup = $(_this.w.openPopup());
              return _this.buildPopup(popup, rect, link);
            }
          };
        })(this));
        if (!(link && link.length)) {
          return this.w.closePopup();
        }
      } else {
        popup = $(this.w.openPopup());
        return this.buildPopup(popup, rect);
      }
    };

    LinkInserter.prototype.onKeyUp = function(key, character, shiftKey, altKey, ctrlKey, metaKey) {
      if (key === 27) {
        this.preventPopup = true;
        return this.w.closePopup();
      } else {
        return this.parseWysiwygContent();
      }
    };

    LinkInserter.prototype.onPaste = function(e) {
      var html, insertTextAtCursor, text;
      insertTextAtCursor = function(text) {
        var range, sel;
        if (window.getSelection) {
          sel = window.getSelection();
          if (sel.getRangeAt && sel.rangeCount) {
            range = sel.getRangeAt(0);
            range.deleteContents();
            return range.insertNode(document.createTextNode(text));
          }
        } else if (document.selection && document.selection.createRange) {
          return document.selection.createRange().text = text;
        }
      };
      e.preventDefault();
      e = e.originalEvent;
      if (e.clipboardData && e.clipboardData.getData) {
        text = e.clipboardData.types.indexOf("text/html") !== -1 ? (html = e.clipboardData.getData("text/html"), this.stripHtmlExceptLinks(html)) : e.clipboardData.getData("text/plain");
        return document.execCommand("insertHTML", false, text);
      } else if (window.clipboardData && window.clipboardData.getData) {
        text = window.clipboardData.getData("Text");
        return insertTextAtCursor(text);
      }
    };

    LinkInserter.prototype.stripHtmlExceptLinks = function(htmlStr) {
      var $el, $elements, $wrapper, blockRegex, el, j, newLine;
      blockRegex = /^(br|address|blockquote|center|dir|div|dl|fieldset|form|h[1-6]|hr|isindex|menu|noframes|noscript|ol|p|pre|table|ul|dd|dt|frameset|li|tbody|td|tfoot|th|thead|tr)$/i;
      $wrapper = $("<div/>").html(htmlStr);
      $elements = $wrapper.find("*").not("a");
      for (j = $elements.length - 1; j >= 0; j += -1) {
        el = $elements[j];
        $el = $(el);
        if ($el.is("script, style, meta, template")) {
          $el.remove();
        }
        newLine = blockRegex.test(el.nodeName) ? "\r\n" : "";
        $el.replaceWith("" + el.innerHTML + newLine);
      }
      $wrapper.find("a").each(function(i, el) {
        var attrs;
        attrs = _.chain(el.attributes).pluck("name").without("href").value();
        return $(el).removeAttr(attrs.join(" "));
      });
      return $wrapper.html().replace(/<!--.*?-->/g, "").replace(/(\r?\n){3,}/g, "\r\n\r\n").trim();
    };

    LinkInserter.prototype.parseWysiwygContent = function() {
      var text;
      text = '';
      this.wElement.contents().each(function(i, el) {
        var t;
        if (el.nodeType === 3) {
          return text += el.nodeValue;
        } else if ($(el).is('a')) {
          return text += el.outerHTML;
        } else if ($(el).is('div')) {
          t = $(el).html();
          t.replace('<br>', '');
          return text += "\n" + t;
        }
      });
      this.el.text(text);
      text = $('<div/>').html(text).text();
      return this.el.parents('[widget-input-counter]').attr('data-count', text.length).triggerHandler(widgets.InputCounter.ACTIONS.REFRESH);
    };

    LinkInserter.prototype.buildPopup = function(popup, rect, link) {
      var clear, content, left, submit, top;
      popup.addClass('wysiwyg-popup');
      content = $(this.getPopupContent(link && link.attr('href')));
      popup.html(content);
      left = rect.left + rect.width / 2 - popup.outerWidth() / 2;
      top = rect.top - popup.outerHeight() - this.container.scrollTop() + 10;
      popup.css({
        left: left,
        top: top
      });
      popup.addClass('showed');
      submit = (function(_this) {
        return function(preventPopup) {
          var value;
          if (preventPopup == null) {
            preventPopup = false;
          }
          if ((value = $('input', popup).val())) {
            if (value.indexOf('#') === 0) {
              value = Routes.tag_url(value.substr(1));
            } else if (value.indexOf('http') !== 0) {
              value = "http://" + value;
            }
            if (link) {
              link.attr('href', value);
            } else {
              _this.w.insertLink(value);
              _this.preventPopup = preventPopup;
            }
            _this.w.closePopup();
            return _this.parseWysiwygContent();
          } else {
            return clear();
          }
        };
      })(this);
      clear = (function(_this) {
        return function() {
          link.contents().unwrap();
          _this.w.closePopup();
          return _this.parseWysiwygContent();
        };
      })(this);
      $('button.link-inserter__submit', popup).click(submit);
      $('button.link-inserter__clear', popup).click(clear);
      $('input', popup).on('focus', (function(_this) {
        return function() {
          return content.removeClass('-delete');
        };
      })(this));
      return $('input', popup).on('keydown', (function(_this) {
        return function(e) {
          switch (e.keyCode) {
            case 13:
              e.preventDefault();
              e.stopPropagation();
              return submit(true);
            case 27:
              return _this.w.closePopup();
          }
        };
      })(this));
    };

    LinkInserter.prototype.getPopupContent = function(value) {
      if (value == null) {
        value = '';
      }
      return "<div class=\"link-inserter__popup-content inline--container " + (value && '-delete' || value) + "\">\n  <input class=\"link-inserter__popup-text\" placeholder=\"Paste or type a link or #tag\" value=" + value + ">\n  <button class=\"sb -blue link-inserter__submit\"></button>\n  <button class=\"sb link-inserter__clear\"></button>\n</div>";
    };

    return LinkInserter;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.EmbedDispatcher = (function() {
    EmbedDispatcher.prototype.key = 'embed_current_playing_coub';

    function EmbedDispatcher(opts) {
      this.checkIfNeedToShut = bind(this.checkIfNeedToShut, this);
      var error;
      try {
        this.latestId = $.storage.get(this.key);
      } catch (error1) {
        error = error1;
        $.storage.set(this.key, '');
        this.latestId = '';
      }
      if (opts == null) {
        opts = {};
      }
      this.opts = opts;
      this.id = this.generateRandID();
      this.checkingInterval = setInterval(this.checkIfNeedToShut, 100);
    }

    EmbedDispatcher.prototype.destroy = function() {
      var ref;
      clearInterval(this.checkingInterval);
      return ref = [], this.opts = ref[0], this.id = ref[1], this.checkingInterval = ref[2], this.latestId = ref[3], ref;
    };

    EmbedDispatcher.prototype.startedPlaying = function() {
      $.storage.set(this.key, this.id);
      return this.latestId = this.id;
    };

    EmbedDispatcher.prototype.checkIfNeedToShut = function() {
      try {
        if (this.latestId !== $.storage.get(this.key)) {
          this.opts.onStop();
        }
        return this.latestId = $.storage.get(this.key);
      } catch (error1) {
        return this.startedPlaying();
      }
    };

    EmbedDispatcher.prototype.generateRandID = function() {
      return "coub_embed_" + Math.round(Math.random() * Math.random() * 10000000);
    };

    return EmbedDispatcher;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.Html5Player = (function() {
    Html5Player.prototype.STATE = {
      UNLOADED: "unloaded",
      LOADING: "loading",
      PLAYING: "playing",
      PAUSED: "paused"
    };

    Html5Player.prototype.STORAGE = {
      SOUND_LEVEL: 'player_sound_level',
      HD_ENABLED: 'player_hd_enabled'
    };

    Html5Player.prototype.DT = "Html5Player";

    function Html5Player(viewerBlock, opts) {
      var e, jsonStr;
      if (opts == null) {
        opts = {};
      }
      this.unmute = bind(this.unmute, this);
      this.mute = bind(this.mute, this);
      this.play = bind(this.play, this);
      this.blurHandler = bind(this.blurHandler, this);
      this.hdHandler = bind(this.hdHandler, this);
      this.soundLevelHandler = bind(this.soundLevelHandler, this);
      this.storageHandler = bind(this.storageHandler, this);
      this.playOnPopupClose = bind(this.playOnPopupClose, this);
      this.suspendOnPopupOpen = bind(this.suspendOnPopupOpen, this);
      this.vb = $(viewerBlock).addClass('viewer--v2');
      this.isEmbed = !!opts.embed;
      this.ui = new html5Player.UI(this, this.isEmbed);
      try {
        this.data = opts.data ? opts.data : (jsonStr = $('.data > script', this.vb).html(), JSON.parse(jsonStr));
      } catch (error) {
        e = error;
        this.ui.setView(html5Player.UI.prototype.VIEW.DISABLED);
        console.log('[HB-DEBUG]', "Something wrong with coub's JSON", {
          context: {
            json: jsonStr
          }
        });
        return;
      }
      this.changeState(this.STATE.UNLOADED);
      this.html5Data = this.data.file_versions.html5;
      this.opts = opts;
      if (!this.html5Data.video) {
        console.log('[PLAYER]', 'no video');
        return this.fallback();
      }
      this.hasSuperHD = !!this.html5Data.video.higher;
      this.hasHD = !!this.html5Data.video.high;
      this.isHD = this.hasHD && (!!opts.startWithHD || this.getHDValue());
      this.hasAudio = !!this.html5Data.audio && !opts.noAudio;
      this.isAutoplay = !!opts.autoplay;
      this.noControls = !!opts.noControls;
      this.isMuted = !!opts.muted;
      if (this.noControls) {
        this.ui.hideControlsPermanently();
      }
      this.ui.setQuality(this.isHD);
      this.ui.setSoundLevel(this.getSoundLevel());
      if (!this.hasHD) {
        this.ui.hideHDControls();
      }
      if (!this.hasAudio) {
        this.ui.hideSoundControls();
      }
      if (helpers.Location.isVkontakteEmbed()) {
        this.ui.hideSharingControls();
      }
      if (!(document.fullscreenEnabled || document.msFullscreenEnabled || document.mozFullScreenEnabled || document.webkitFullscreenEnabled)) {
        this.ui.hideFullScreenControls();
      }
      this.ui.setView(html5Player.UI.prototype.VIEW.UNLOADED);
      if (this.data.ahmad_promo) {
        this.ui.setAhmadPromoQuote(this.data.ahmad_promo);
      }
      if ((this.data.promo_data || {}).pelmeshki && !GlobalState.BROWSER.isSafari()) {
        this.pelmeshkiPromoVideo = new html5Player.PelmeshkiPromo(this.ui, this.data.promo_data.pelmeshki);
      }
      this.core = new html5Player.VideoCore(this, this.getVideoData(this.isHD), this.isHD);
      this.attachEvents();
      this.vb.triggerHandler(Player.EVENT_READY);
      if (this.isEmbed) {
        this.dispatcher = new EmbedDispatcher({
          onStop: (function(_this) {
            return function() {
              if (!_this.isAutoplay || !_this.isMuted) {
                return _this.suspend();
              }
            };
          })(this)
        });
      }
      if (this.isAdOverlayEnabled()) {
        this.adManager = new html5Player.EmbedAds(this.ui, this.data);
      }
      if (GlobalState.USER.isLogedIn() || this.isEmbed) {
        this.favourites = new html5Player.Favourites(this.data.id, this.data.permalink, this.data.favourite && !this.isEmbed);
      }
      this.core.notifyAboutReadyState();
      if (this.isAutoplay) {
        this.play();
      }
      if (this.hasAudio && this.isMuted) {
        this.toggleMute(true, false);
      }
    }

    Html5Player.prototype.fallback = function(isPlaying) {
      if (this.fallenBack) {
        return;
      }
      this.fallenBack = true;
      this.vb.triggerHandler(Player.EVENT_HTML5_FALLBACK);
      this.unload();
      this.dispatcher && this.dispatcher.destroy();
      this.vb.removeClass('viewer--v2').off('.player');
      this.ui.setView(html5Player.UI.prototype.VIEW.EMPTY);
      this.opts.skip_html5 = true;
      new Player(this.vb, this.opts);
      if (isPlaying) {
        this.vb.triggerHandler('play');
      }
      if (this.handControlActivated) {
        this.vb.triggerHandler(Player.ACTION_ACTIVATE_HAND_CONTROL);
      }
      return this.pelmeshkiPromoVideo && this.pelmeshkiPromoVideo.destroy();
    };

    Html5Player.prototype.getVideoData = function(isHD) {
      var qualityKeys, videoData;
      qualityKeys = isHD && this.hasSuperHD && (this.vb.width() >= 720 || this.vb.height() >= 720) ? ["higher", "high"] : isHD ? ["high", "high"] : ["med", "med"];
      videoData = {
        duration: this.data.duration,
        videoUrl: this.html5Data.video[qualityKeys[0]].url,
        videoSize: this.html5Data.video[qualityKeys[0]].size
      };
      if (this.hasAudio) {
        videoData.audioUrl = this.html5Data.audio[qualityKeys[1]].url;
        videoData.audioSize = this.html5Data.audio[qualityKeys[1]].size;
        videoData.audioSampleDuration = this.html5Data.audio.sample_duration;
      }
      return videoData;
    };

    Html5Player.prototype.hasFocus = function() {
      return (!document.hidden && (this.isEmbed || document.hasFocus())) || (GlobalState.BROWSER.isSafari() && this.isFullScreen === true);
    };

    Html5Player.prototype.attachEvents = function() {
      if (!this.isEmbed) {
        $(window).on('blur focus', this.blurHandler);
      }
      $(document).on('visibilitychange', this.blurHandler).on('flash_player:mute', this.mute).on('flash_player:unmute', this.unmute).on('flash_player:suspend', this.suspendOnPopupOpen).on('flash_player:play', this.playOnPopupClose);
      $(window).on('storage', this.storageHandler);
      $(document).on('soundlevelchanged', this.soundLevelHandler);
      $(document).on('hdvaluechanged', this.hdHandler);
      this.ui.viewerClick.on('click.player', this.togglePlayState.bind(this));
      this.ui.fullScreenButton.click(this.toggleFullScreen.bind(this));
      this.ui.shareButton.click(this.togglePlayState.bind(this));
      this.ui.muteOverlay.click(this.plugInSound.bind(this));
      this.ui.hdButton.click((function(_this) {
        return function() {
          return _this.toggleQuality(null, true);
        };
      })(this));
      this.ui.soundButton.click(this.toggleMute.bind(this));
      this.ui.mobileMark.click(this.pause.bind(this));
      this.ui.infoBlock.click(this.pause.bind(this));
      this.ui.replayButton.click(this.replay.bind(this));
      this.ui.settingsReplayButton.click(this.replay.bind(this));
      this.ui.favouritesButton.on('click unloged_action:favourites', this.toggleFavourites.bind(this));
      this.vb.on('play.player', this.play.bind(this));
      this.vb.on('pause.player', this.pause.bind(this));
      this.vb.on('suspend.player', this.suspendHandler.bind(this));
      this.vb.on('preload.player', this.preload.bind(this));
      this.vb.on('unembed.player', this.unload.bind(this));
      this.vb.on('forceplay.player', (function(_this) {
        return function() {
          return _this.play(true);
        };
      })(this));
      this.vb.on('hidefinger.player', this.ui.hideFinger.bind(this.ui));
      this.vb.on('resize.player', this.ui.setSizes.bind(this.ui));
      this.vb.on('keyup.player', this.keyHandler.bind(this));
      this.vb.on(Player.ACTION_ACTIVATE_HAND_CONTROL + ".player", (function(_this) {
        return function() {
          _this.handControlActivated = true;
          _this.ui.showFinger();
          _this.dispatcher && _this.dispatcher.destroy();
          return _this.dispatcher = new EmbedDispatcher({
            onStop: function() {
              if (!_this.userPaused) {
                return _this.unload();
              }
            }
          });
        };
      })(this));
      this.vb.on(Player.ACTION_DEACTIVATE_HAND_CONTROL + ".player", (function(_this) {
        return function() {
          _this.handControlActivated = false;
          _this.ui.hideFinger();
          return _this.dispatcher && _this.dispatcher.destroy();
        };
      })(this));
      this.vb.on(Player.ACTION_UNEMBED_IF_NOT_PLAYING + ".player", (function(_this) {
        return function() {
          if (_this.state !== _this.STATE.PLAYING && !_this.userPaused) {
            return _this.unload();
          }
        };
      })(this));
      this.vb.on(Player.ACTION_SET_FULLSCREEN_ELEMENT + ".player", (function(_this) {
        return function(e, el) {
          return _this.ui.setFullScreenElement(el);
        };
      })(this));
      this.vb.on(Player.ACTION_SHOW_CONTROLS + ".player", this.ui.showControls.bind(this.ui));
      this.vb.on(Player.ACTION_HIDE_CONTROLS + ".player", this.ui.hideControls.bind(this.ui));
      this.vb.on(Player.ACTION_TURN_HD_ON + ".player", (function(_this) {
        return function() {
          return _this.toggleQuality(true);
        };
      })(this));
      return this.vb.on("dom_remove", (function(_this) {
        return function() {
          _this.unload();
          _this.dispatcher && _this.dispatcher.destroy();
          $(window).off('blur focus', _this.blurHandler).off('storage', _this.storageHandler);
          return $(document).off('visibilitychange', _this.blurHandler).off('flash_player:mute', _this.mute).off('flash_player:unmute', _this.unmute).off('soundlevelchanged', _this.soundLevelHandler).off('hdvaluechanged', _this.hdHandler).off('flash_player:suspend', _this.suspendOnPopupOpen).off('flash_player:play', _this.playOnPopupClose);
        };
      })(this));
    };

    Html5Player.prototype.suspendOnPopupOpen = function() {
      if ([this.STATE.LOADING, this.STATE.PLAYING].indexOf(this.state) !== -1 && [this.ui.VIEW.UNLOADED, this.ui.VIEW.SUSPENDED].indexOf(this.ui.view) === -1) {
        this.isTemporallySuspended = true;
        return this.suspend();
      }
    };

    Html5Player.prototype.playOnPopupClose = function() {
      if (this.isTemporallySuspended) {
        this.isTemporallySuspended = false;
        return this.play();
      }
    };

    Html5Player.prototype.storageHandler = function(e) {
      if (!this.isMuted && e.originalEvent.key === this.STORAGE.SOUND_LEVEL) {
        this.setSoundLevel(this.getSoundLevel(), false);
      }
      if (this.state === this.STATE.UNLOADED && e.originalEvent.key === this.STORAGE.HD_ENABLED) {
        return this.toggleQuality(this.getHDValue());
      }
    };

    Html5Player.prototype.soundLevelHandler = function(e, sender) {
      if (this.isMuted || sender === this) {
        return;
      }
      return this.setSoundLevel(this.getSoundLevel(), false);
    };

    Html5Player.prototype.hdHandler = function(e, sender) {
      if (this.state !== this.STATE.UNLOADED || sender === this) {
        return;
      }
      return this.toggleQuality(this.getHDValue());
    };

    Html5Player.prototype.blurHandler = function() {
      if (!this.hasFocus()) {
        return;
        if (this.state !== this.STATE.PLAYING) {
          return;
        }
        this.suspend();
        return this.browserPaused = true;
      } else if (this.browserPaused) {
        this.browserPaused = false;
        if (this.state !== this.STATE.UNLOADED) {
          return this.play();
        }
      } else if (this.state === this.STATE.PLAYING) {
        return this.core.sync();
      }
    };

    Html5Player.prototype.togglePlayState = function(e) {
      var isCenterButton, isShareButton, ref, ref1;
      isCenterButton = e && e.target === $(".viewer__click", this.vb).get(0);
      isShareButton = e && e.currentTarget === this.ui.shareButton.get(0);
      if (GlobalState.PAGE.isCoubPage() && isCenterButton) {
        AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.PLAYER.CENTER_CLICKED);
      }
      if (this.ui.view === html5Player.UI.prototype.VIEW.SUGGESTS) {
        if (isShareButton) {
          this.userPaused = true;
          return this.pause(e);
        } else if ((ref = this.state) === this.STATE.PAUSED || ref === this.STATE.LOADING) {
          this.userPaused = false;
          return this.play();
        }
      } else if ((ref1 = this.state) === this.STATE.PLAYING || ref1 === this.STATE.LOADING) {
        this.userPaused = true;
        return this.pause(e);
      } else {
        this.userPaused = false;
        return this.play();
      }
    };

    Html5Player.prototype.plugInSound = function() {
      var ref;
      if ((ref = this.state) !== this.STATE.PLAYING && ref !== this.STATE.PAUSED) {
        return;
      }
      this.vb.triggerHandler(Player.EVENT_PLUG_IN_SOUND);
      if (this.isMuted) {
        this.toggleMute(false, false);
      } else {
        this.core.rewind();
        this.playLoop();
      }
      return this.dispatcher && this.dispatcher.startedPlaying();
    };

    Html5Player.prototype.suspendHandler = function() {
      this.browserPaused = false;
      return this.suspend();
    };

    Html5Player.prototype.keyHandler = function(e) {
      switch (e.which) {
        case 87:
          return this.core.changeTempo(1.15);
        case 83:
          return this.core.changeTempo(0.87);
        case 82:
          return this.replay(false);
        case 80:
          if (this.state === this.STATE.PLAYING) {
            return this.suspend();
          } else if (this.state === this.STATE.PAUSED) {
            return this.play();
          }
      }
    };

    Html5Player.prototype.play = function(force) {
      if (force == null) {
        force = false;
      }
      if (force === true) {
        this.userPaused = false;
      }
      if (this.state === this.STATE.PLAYING || (this.state === this.STATE.PAUSED && this.userPaused)) {
        return;
      }
      this.suspendOnPreload = false;
      this.ui.setSizes();
      if (this.isPrerollEnabled()) {
        this.vb.on(html5Player.Preroll.prototype.EVENT_PREROLL_COMPLETED, this.play).on(html5Player.Preroll.prototype.EVENT_PREROLL_CLOSED, this.play).on(html5Player.Preroll.prototype.EVENT_PREROLL_FAILED, this.play);
        return this.prerollManager = html5Player.Preroll.getInstance(this.data, this.ui);
      } else if (this.prerollManager && !this.prerollManager.locker.isLocked()) {
        this.prerollManager.destroy();
        this.preloadAndPlay();
        return this.pelmeshkiPromoVideo && this.pelmeshkiPromoVideo.play();
      } else if (!this.prerollManager) {
        this.preloadAndPlay();
        return this.pelmeshkiPromoVideo && this.pelmeshkiPromoVideo.play();
      }
    };

    Html5Player.prototype.pause = function(e) {
      var isShareButton, ref, ref1, sharingShown;
      isShareButton = e && e.currentTarget === this.ui.shareButton.get(0);
      sharingShown = (ref = this.ui.view) === html5Player.UI.prototype.VIEW.SHARING || ref === html5Player.UI.prototype.VIEW.UNLOADED_SHARING;
      if (GlobalState.PAGE.isCoubPage()) {
        if (this.state !== this.STATE.PAUSED) {
          AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.PLAYER.PAUSE_OCCURED);
        }
        if (isShareButton) {
          AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.PLAYER.SHARE_BTN_CLICKED);
        }
      }
      if ((ref1 = this.state) === this.STATE.LOADING || ref1 === this.STATE.PAUSED || ref1 === this.STATE.PLAYING) {
        this.changeState(this.STATE.PAUSED);
        if (!this.userPaused) {
          this.userPaused = isShareButton;
        }
        this.core.pause();
        if (isShareButton) {
          this.ui.setView(html5Player.UI.prototype.VIEW.SHARING);
        } else {
          this.ui.setView(html5Player.UI.prototype.VIEW.SUGGESTS);
        }
        return this.pelmeshkiPromoVideo && this.pelmeshkiPromoVideo.pause();
      } else if (this.state === this.STATE.UNLOADED) {
        if (isShareButton) {
          if (sharingShown) {
            return this.ui.setView(html5Player.UI.prototype.VIEW.UNLOADED);
          } else {
            return this.ui.setView(html5Player.UI.prototype.VIEW.UNLOADED_SHARING);
          }
        } else {
          return this.ui.setView(html5Player.UI.prototype.VIEW.UNLOADED);
        }
      }
    };

    Html5Player.prototype.suspend = function() {
      if (this.state === this.STATE.PLAYING) {
        this.changeState(this.STATE.PAUSED);
        this.core.pause();
        return this.ui.setView(html5Player.UI.prototype.VIEW.SUSPENDED);
      } else if (this.state === this.STATE.LOADING) {
        return this.suspendOnPreload = true;
      }
    };

    Html5Player.prototype.replay = function(withAnimation) {
      if (withAnimation == null) {
        withAnimation = true;
      }
      this.play(true);
      if (withAnimation) {
        (this.restartStoredSoundLevel == null) && (this.restartStoredSoundLevel = this.getSoundLevel());
        this.core.setSoundLevel(0);
        return this.ui.blackScreenAnimation((function(_this) {
          return function() {
            _this.core.setSoundLevel(_this.restartStoredSoundLevel);
            _this.restartStoredSoundLevel = void 0;
            _this.core.rewind();
            return _this.core.resetTempo();
          };
        })(this));
      } else {
        return this.core.rewind();
      }
    };

    Html5Player.prototype.mute = function() {
      return this.toggleMute(true);
    };

    Html5Player.prototype.unmute = function() {
      return this.toggleMute(false);
    };

    Html5Player.prototype.preload = function() {
      var drawProgress, framesDefer, minProgress;
      this.changeState(this.STATE.LOADING);
      if (!this.preloadDefer) {
        minProgress = 0.1;
        drawProgress = (function(_this) {
          return function(p) {
            return _this.ui.framesProgress(Math.max(p, minProgress));
          };
        })(this);
        if (this.hasAudio) {
          this.core.preloadAudio();
        }
        framesDefer = this.core.preloadFrames();
        framesDefer.load.progress(function(p) {
          return drawProgress(p);
        });
        this.ui.framesProgress(minProgress);
        this.preloadDefer = {
          play: $.when(framesDefer.play),
          load: $.when(framesDefer.load)
        };
        this.preloadDefer.play.done(function() {
          drawProgress(1);
          return drawProgress = $.noop;
        });
      }
      return this.preloadDefer;
    };

    Html5Player.prototype.unload = function() {
      var ref;
      if (this.state === this.STATE.UNLOADED) {
        return;
      }
      this.changeState(this.STATE.UNLOADED);
      ref = [], this.preloadDefer = ref[0], this.userPaused = ref[1], this.browserPaused = ref[2], this.suspendOnPreload = ref[3];
      this.core.reinit();
      this.ui.setView(html5Player.UI.prototype.VIEW.UNLOADED);
      return this.pelmeshkiPromoVideo && this.pelmeshkiPromoVideo.stop();
    };

    Html5Player.prototype.toggleFullScreen = function() {
      if (GlobalState.PAGE.isCoubPage()) {
        AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.PLAYER.FULLSCREEN_CLICKED);
      }
      this.isFullScreen = this.ui.toggleFullScreen();
      if (this.isFullScreen) {
        if (!this.isHD) {
          this.toggleQuality(true);
        }
        if (this.state === this.STATE.UNLOADED) {
          return this.play();
        }
      }
    };

    Html5Player.prototype.toggleQuality = function(isHD, dispatch) {
      var oldState;
      if (dispatch == null) {
        dispatch = false;
      }
      if (!this.hasHD) {
        return;
      }
      oldState = this.state;
      this.changeState(this.STATE.UNLOADED);
      this.isHD = _.isBoolean(isHD) ? isHD : !this.isHD;
      this.core.reinit(this.getVideoData(this.isHD), this.isHD);
      this.ui.setQuality(this.isHD);
      this.preloadDefer = void 0;
      this.userPaused = false;
      if (oldState !== this.STATE.UNLOADED) {
        this.preloadAndPlay();
      }
      if (dispatch) {
        $.storage.set(this.STORAGE.HD_ENABLED, this.isHD);
        return $(document).triggerHandler('hdvaluechanged', this);
      }
    };

    Html5Player.prototype.setSoundLevel = function(val, dispatch) {
      if (dispatch == null) {
        dispatch = true;
      }
      this.core.setSoundLevel(val);
      this.ui.setSoundLevel(val);
      if (this.isMuted && val) {
        this.isMuted = false;
        this.core.setMuteState(false);
        this.ui.setView(html5Player.UI.prototype.VIEW.PLAYING);
      }
      if (dispatch) {
        $.storage.set(this.STORAGE.SOUND_LEVEL, val);
        return $(document).triggerHandler('soundlevelchanged', this);
      }
    };

    Html5Player.prototype.getSoundLevel = function() {
      var lvl;
      lvl = $.storage.get(this.STORAGE.SOUND_LEVEL);
      if (lvl == null) {
        lvl = 1;
      }
      return lvl;
    };

    Html5Player.prototype.getHDValue = function() {
      return $.storage.get(this.STORAGE.HD_ENABLED);
    };

    Html5Player.prototype.toggleMute = function(val, dispatch) {
      var lvl, newState;
      if (dispatch == null) {
        dispatch = true;
      }
      lvl = this.getSoundLevel();
      newState = _.isBoolean(val) ? val : this.isMuted ? false : !!lvl;
      if (newState) {
        return this.setSoundLevel(0, dispatch);
      } else {
        return this.setSoundLevel(lvl || 1, dispatch);
      }
    };

    Html5Player.prototype.toggleFavourites = function(e) {
      if (this.favourites) {
        if (e && e.type === 'unloged_action:favourites') {
          this.favourites.isAdded = false;
        }
        if (this.isEmbed && !GlobalState.USER.isLogedIn()) {
          return this.favourites.openLoginPage();
        } else {
          return this.favourites.toggle((function(_this) {
            return function() {
              return _this.ui.toggleFavouritesState(_this.favourites.isAdded);
            };
          })(this));
        }
      }
    };

    Html5Player.prototype.preloadAndPlay = function() {
      this.dispatcher && this.dispatcher.startedPlaying();
      if (this.preload().play.state() === 'pending') {
        this.ui.setView(html5Player.UI.prototype.VIEW.LOADING);
      }
      this.preload().play.fail((function(_this) {
        return function(e) {
          (typeof Honeybadger !== "undefined" && Honeybadger !== null) && Honeybadger.notify("MS Play Error", {
            context: {
              message: e,
              permalink: _this.data.permalink
            }
          });
          return _this.fallback(true);
        };
      })(this));
      return this.preload().play.done((function(_this) {
        return function() {
          if (!_this.userPaused) {
            _this.playLoop();
          }
          if (_this.suspendOnPreload) {
            return _this.suspend();
          } else if (!_this.hasFocus()) {
            _this.suspend();
            return _this.browserPaused = true;
          }
        };
      })(this));
    };

    Html5Player.prototype.playLoop = function() {
      this.changeState(this.STATE.PLAYING);
      if (this.hasAudio) {
        this.core.setSoundLevel(this.getSoundLevel());
        this.core.setMuteState(this.isMuted);
        if (this.isMuted && this.isAutoplay) {
          this.ui.setView(html5Player.UI.prototype.VIEW.AUTOPLAY_MUTED);
        } else {
          this.ui.setView(html5Player.UI.prototype.VIEW.PLAYING);
        }
      } else {
        this.ui.setView(html5Player.UI.prototype.VIEW.PLAYING);
      }
      this.core.single('buffering', (function(_this) {
        return function() {
          _this.ui.setView(html5Player.UI.prototype.VIEW.LOADING);
          return _this.preloadDefer.load.done(function() {
            _this.core.sync();
            if (_this.state === _this.STATE.PLAYING) {
              return _this.playLoop();
            }
          });
        };
      })(this));
      this.core.single("browser-audio-autoplay-blocked", (function(_this) {
        return function() {
          return _this.ui.setView(html5Player.UI.prototype.VIEW.AUTOPLAY_MUTED);
        };
      })(this));
      this.core.single("browser-video-autoplay-blocked", (function(_this) {
        return function() {
          _this.changeState(_this.STATE.PAUSED);
          _this.ui.setView(html5Player.UI.prototype.VIEW.BROWSER_MUTED);
          return _this.ui.showFinger();
        };
      })(this));
      this.core.play();
      this.notifyAboutView();
      return this.dispatcher && this.dispatcher.startedPlaying();
    };

    Html5Player.prototype.changeState = function(state) {
      var key, ref, value;
      console.log(this.DT, "Change state to", state);
      this.state = state;
      ref = this.STATE;
      for (key in ref) {
        value = ref[key];
        this.vb.removeClass("-state-" + value);
      }
      this.vb.addClass("-state-" + state);
      return this.tryToShowAd();
    };

    Html5Player.prototype.tryToShowAd = function() {
      if (this.adManager != null) {
        if (this.state === "playing") {
          return this.adManager.showAd();
        }
      }
    };

    Html5Player.prototype.isEmbedAdsEnabled = function() {
      return this.isEmbed && !helpers.Location.isAdsDisabled();
    };

    Html5Player.prototype.isSiteAdsEnabled = function() {
      return GlobalState.COUNTRY.isExUssr() && !this.isEmbed;
    };

    Html5Player.prototype.isAdOverlayEnabled = function() {
      var isSmallCard;
      isSmallCard = this.opts && this.opts.cardType === "small";
      return !this.noControls && this.data.is_safe_for_ads && !isSmallCard && !GlobalState.PAGE.isChatPage() && (this.isEmbedAdsEnabled() || helpers.Location.isVkontakteEmbed() || this.isSiteAdsEnabled());
    };

    Html5Player.prototype.isPrerollEnabled = function() {
      return !this.noControls && this.data.is_safe_for_ads && html5Player.Preroll.isEnabled() && ((this.isEmbedAdsEnabled() && !this.isAutoplay) || helpers.Location.isVkontakteEmbed());
    };

    Html5Player.prototype.notifyAboutView = function() {
      var promotedData;
      if (this.notifedAboutView) {
        return;
      }
      this.notifedAboutView = true;
      StatsDataProvider.coubIncrementViews(this.data.permalink, 'html5', this.isEmbed);
      if (this.data && this.data.render && (promotedData = this.data.render.promoted)) {
        return $.post(Routes.increment_views_api_v2_promoted_coub_path(promotedData.id), {
          token: promotedData.token
        });
      }
    };

    return Html5Player;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  html5Player.AdmanLoader = (function() {
    AdmanLoader.INSTANCES = {};

    function AdmanLoader(permalink, ui, forceReload) {
      this.permalink = permalink;
      this.ui = ui;
      if (forceReload == null) {
        forceReload = false;
      }
      this.get = bind(this.get, this);
      this.init = bind(this.init, this);
      if (!html5Player.AdmanLoader.INSTANCES[this.permalink]) {
        html5Player.AdmanLoader.INSTANCES[this.permalink] = this;
        _.defer(this.init);
      } else {
        if (forceReload) {
          html5Player.AdmanLoader.INSTANCES[this.permalink].init();
        }
        return html5Player.AdmanLoader.INSTANCES[this.permalink];
      }
    }

    AdmanLoader.prototype.init = function() {
      var adm, initOpts, puid, referrer, videoEl, videoQuality, wrapper;
      if (typeof AdmanHTML === "undefined" || AdmanHTML === null) {
        this.isError = true;
        return;
      }
      wrapper = this.ui.admanOverlayContainer.get(0);
      videoEl = $('.adman-ad-preroll > video', this.ui.prerollBlock).get(0);
      videoQuality = this.ui.prerollBlock.height();
      puid = GlobalState.PAGE.isEmbed() ? helpers.Location.isVkontakteEmbed() ? 152 : 611 : 151;
      referrer = encodeURIComponent(GlobalState.PAGE.getReferrer() || 'http://coub.com');
      initOpts = {
        slot: 4111,
        wrapper: wrapper,
        videoEl: videoEl,
        videoQuality: videoQuality,
        browser: {},
        params: {
          puid1: puid,
          dl: referrer
        }
      };
      if (this.adm) {
        adm = this.adm;
        this.adm.stop();
        this.adm = null;
      } else {
        adm = new AdmanHTML();
      }
      adm.onReady((function(_this) {
        return function(e) {
          _this.adm = adm;
          if (_this.onReadyCallback) {
            return _this.onReadyCallback(adm);
          }
        };
      })(this));
      adm.onError((function(_this) {
        return function(e) {
          if (_this.onErrorCallback) {
            return _this.onErrorCallback();
          } else {
            return _this.isError = true;
          }
        };
      })(this));
      return adm.init(initOpts);
    };

    AdmanLoader.prototype.get = function(onReadyCallback, onErrorCallback) {
      this.onReadyCallback = onReadyCallback;
      this.onErrorCallback = onErrorCallback;
      return _.defer((function(_this) {
        return function() {
          if (_this.adm) {
            _this.onReadyCallback(_this.adm);
          }
          if (_this.isError) {
            return _this.onErrorCallback();
          }
        };
      })(this));
    };

    return AdmanLoader;

  })();

}).call(this);
(function() {
  html5Player.Preroll = (function() {
    Preroll.prototype.EVENT_PREROLL_SHOWN = "Html5Player::Preroll::PrerollShown";

    Preroll.prototype.EVENT_PREROLL_CLOSED = "Html5Player::Preroll::PrerollClosed";

    Preroll.prototype.EVENT_PREROLL_FAILED = "Html5Player::Preroll::PrerollFail";

    Preroll.prototype.EVENT_PREROLL_COMPLETED = "Html5Player::Preroll::PrerollCompleted";

    function Preroll(data1, ui1) {
      this.data = data1;
      this.ui = ui1;
      this.vb = this.ui.vb;
      this.locker = new chms.utils.Locker();
      this.prerollBlock = this.ui.prerollBlock;
      this.skipButton = $('.preroll__controls--skip-button', this.controls);
      this.bar = $('.preroll__controls--bar', this.controls);
      this.timer = $('.preroll__controls--timer', this.controls);
      this.init();
      html5Player.Preroll.toggle(false);
    }

    Preroll.prototype.init = function() {
      throw "Not Implemented";
    };

    Preroll.prototype.destroy = function() {
      return true;
    };

    Preroll.prototype.sharedState = {
      prerollType: "adman",
      prerollDisabled: false,
      shownTimes: 0
    };

    Preroll.prototype.dispatchAndUnlock = function(eventName) {
      this.locker.unlock();
      return this.vb.triggerHandler(eventName);
    };

    Preroll.prototype.onAdStart = function() {
      this.sharedState.shownTimes++;
      this.toggleVisibility(true);
      return this.vb.triggerHandler(this.EVENT_PREROLL_SHOWN);
    };

    Preroll.prototype.onAdEnd = function() {
      this.toggleVisibility(false);
      return this.dispatchAndUnlock(this.EVENT_PREROLL_COMPLETED);
    };

    Preroll.prototype.onAdSkip = function() {
      this.toggleVisibility(false);
      return this.dispatchAndUnlock(this.EVENT_PREROLL_CLOSED);
    };

    Preroll.prototype.toggleVisibility = function(val) {
      return this.prerollBlock.add(this.adBlock).toggleClass("-hidden", !val);
    };

    Preroll.getInstance = function(data, ui) {
      if (this.prototype.sharedState.prerollType === "vast") {
        return new html5Player.VastPreroll(data, ui);
      } else {
        return new html5Player.AdmanPreroll(data, ui);
      }
    };

    Preroll.setPrerollType = function(val) {
      return this.prototype.sharedState.prerollType = val;
    };

    Preroll.toggle = function(val) {
      return this.prototype.sharedState.prerollDisabled = !val;
    };

    Preroll.isEnabled = function() {
      return !this.prototype.sharedState.prerollDisabled;
    };

    Preroll.getShownTimes = function() {
      return this.prototype.sharedState.shownTimes || 0;
    };

    return Preroll;

  })();

}).call(this);
(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  html5Player.AdmanPreroll = (function(superClass) {
    extend(AdmanPreroll, superClass);

    function AdmanPreroll() {
      return AdmanPreroll.__super__.constructor.apply(this, arguments);
    }

    AdmanPreroll.prototype.init = function() {
      var admanLoader, onError, onReady;
      this.locker.lock();
      this.controls = $('.preroll__controls', this.prerollBlock);
      this.adBlock = this.prerollBlock.find(".adman-ad-preroll");
      onReady = (function(_this) {
        return function(adm) {
          var allowCloseDelay, firstPreroll, prerolls;
          _this.adm = adm;
          adm.onStarted(function(e) {
            _this.skipButton.click(function() {
              if (_this.skipButton.hasClass('-disabled')) {
                return;
              }
              adm.skip();
              return _this.onAdSkip();
            });
            return _this.onAdStart();
          });
          adm.onTimeRemained(function(e) {
            var text;
            text = e.currentTime >= allowCloseDelay ? (_this.skipButton.removeClass('-disabled'), "Skip Ad &rarr;") : "Skip Ad in " + (allowCloseDelay - e.currentTime);
            _this.skipButton.html(text);
            _this.setBarWidth(e.percent);
            return _this.setTimer(Math.ceil(e.duration - e.currentTime));
          });
          adm.onCompleted(_this.onAdEnd.bind(_this));
          prerolls = adm.getBannersForSection('preroll');
          firstPreroll = prerolls[0];
          if (firstPreroll) {
            _this.positionControls(firstPreroll.width !== "0" && firstPreroll.width || _this.prerollBlock.width(), firstPreroll.height !== "0" && firstPreroll.height || _this.prerollBlock.height());
            allowCloseDelay = firstPreroll.allowCloseDelay || 5;
            return adm.start('preroll');
          } else {
            return _this.dispatchAndUnlock(_this.EVENT_PREROLL_COMPLETED);
          }
        };
      })(this);
      onError = (function(_this) {
        return function() {
          return _this.dispatchAndUnlock(_this.EVENT_PREROLL_FAILED);
        };
      })(this);
      admanLoader = new html5Player.AdmanLoader(this.data.permalink, this.ui);
      return admanLoader.get(onReady, onError);
    };

    AdmanPreroll.prototype.destroy = function() {
      if (!this.adm) {
        return;
      }
      this.adm.onStarted(null);
      this.adm.onTimeRemained(null);
      this.adm.onCompleted(null);
      return this.adm = null;
    };

    AdmanPreroll.prototype.positionControls = function(width, height) {
      var left, s, top, wh, ww;
      ww = window.innerWidth;
      wh = window.innerHeight;
      s = Math.max(width / ww, height / wh);
      width /= s;
      height /= s;
      left = (ww - width) / 2;
      top = (wh - height) / 2;
      return this.controls.css({
        width: width,
        height: height,
        left: left,
        top: top
      });
    };

    AdmanPreroll.prototype.setBarWidth = function(p) {
      return this.bar.width(p + "%");
    };

    AdmanPreroll.prototype.setTimer = function(t) {
      if (t < 10) {
        t = "0" + t;
      }
      t = "0:" + t;
      return this.timer.text(t);
    };

    return AdmanPreroll;

  })(html5Player.Preroll);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  html5Player.BaseOverlay = (function() {
    function BaseOverlay() {
      this.setElementSize = bind(this.setElementSize, this);
      this.onOverlayClick = bind(this.onOverlayClick, this);
      this.trackStatPixel = bind(this.trackStatPixel, this);
      this.trackStat = bind(this.trackStat, this);
      this.getOverlayTemplate = bind(this.getOverlayTemplate, this);
      this.s = this.constructor;
      this.init();
    }

    BaseOverlay.prototype.getOverlayTemplate = function(w, h) {
      var src;
      src = this.data["img" + w + "x" + h];
      return "<img src=" + src + " width=" + w + " height=" + h + ">";
    };

    BaseOverlay.prototype.trackStat = function(type) {
      var i, len, p, results, stat;
      stat = this.data.pixels[type];
      if (_.isArray(stat)) {
        results = [];
        for (i = 0, len = stat.length; i < len; i++) {
          p = stat[i];
          results.push(this.trackStatPixel(p));
        }
        return results;
      } else {
        if (stat != null) {
          return this.trackStatPixel(stat);
        }
      }
    };

    BaseOverlay.prototype.trackStatPixel = function(url) {
      if (url.indexOf('/api/v2/bs/') !== -1) {
        return $.post(url);
      } else {
        return $('body').append("<img src=" + url + " style='position:absolute;left:-10000px'>");
      }
    };

    BaseOverlay.prototype.onOverlayClick = function() {
      this.trackStat("click");
      return window.open(this.data.clickUrl, '_blank');
    };

    BaseOverlay.prototype.setElementSize = function(w, h) {
      return this.el.css({
        width: w + "px",
        height: h + "px"
      });
    };

    return BaseOverlay;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  html5Player.CustomOverlay = (function(superClass) {
    extend(CustomOverlay, superClass);

    CustomOverlay.SCHEMA = [[600, 100], [400, 100], [240, 100]];

    function CustomOverlay(el, closeBtn, data) {
      this.el = el;
      this.closeBtn = closeBtn;
      this.data = data;
      this.init = bind(this.init, this);
      CustomOverlay.__super__.constructor.apply(this, arguments);
    }

    CustomOverlay.prototype.init = function() {
      var banner, i, j, len, overlay, ref, w;
      w = this.el.width();
      ref = this.s.SCHEMA;
      for (j = 0, len = ref.length; j < len; j++) {
        i = ref[j];
        if (w >= i[0]) {
          overlay = {
            width: i[0],
            height: i[1]
          };
          break;
        }
      }
      if (!overlay) {
        return;
      }
      banner = $(this.getOverlayTemplate(overlay.width, overlay.height));
      this.el.append(banner).append(this.closeBtn);
      this.setElementSize(overlay.width, overlay.height);
      this.trackStat("view");
      return banner.click((function(_this) {
        return function() {
          return _this.onOverlayClick();
        };
      })(this));
    };

    return CustomOverlay;

  })(html5Player.BaseOverlay);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  html5Player.EmbedAds = (function() {
    EmbedAds.prototype.EVENT_BANNER_SHOWN = "Html5Player::EmbedAds::BannerShown";

    EmbedAds.prototype.EVENT_BANNER_CLOSED = "Html5Player::EmbedAds::BannerClosed";

    EmbedAds.prototype.EVENT_BANNER_FAIL = "Html5Player::EmbedAds::BannerFail";

    EmbedAds.prototype.OVERLAYS = {};

    function EmbedAds(ui, data1) {
      this.ui = ui;
      this.data = data1;
      this.showCloseButton = bind(this.showCloseButton, this);
      this.clear = bind(this.clear, this);
      this.showNextAd = bind(this.showNextAd, this);
      this.showAd = bind(this.showAd, this);
      this.getAvailableHeight = bind(this.getAvailableHeight, this);
      this.showMegaAdfox = bind(this.showMegaAdfox, this);
      this.showMediaforceFixed = bind(this.showMediaforceFixed, this);
      this.showCoubOverlay = bind(this.showCoubOverlay, this);
      this.showAdMan = bind(this.showAdMan, this);
      this.showCriteo = bind(this.showCriteo, this);
      this.showAdfoxCustom = bind(this.showAdfoxCustom, this);
      this.showEmbeddedOverlay = bind(this.showEmbeddedOverlay, this);
      this.showGoogleVpaidOverlay = bind(this.showGoogleVpaidOverlay, this);
      this.appearAnimation = bind(this.appearAnimation, this);
      this.initAppearAnimation = bind(this.initAppearAnimation, this);
      this.init = bind(this.init, this);
      this.vb = this.ui.vb;
      this.player = $('.viewer__player', this.vb);
      this.$el = this.ui.adsBlock.find('.viewer__das__banner');
      this.isEmbed = this.ui.isEmbed;
      this.init();
      this.queue = [];
      if (!this.isEmbed) {
        this.queue.push(this.showEmbeddedOverlay);
        this.queue.push(this.showCoubOverlay);
        this.queue.push(this.showMegaAdfox);
        this.queue.push(this.showAdfoxCustom);
        this.queue.push(this.showMediaforceFixed);
        this.queue.push(this.showAdMan);
        if (!this.isNSFWCoub()) {
          this.queue.push(this.showCriteo);
        }
      } else {
        if (GlobalState.BROWSER.hasAdblock()) {
          this.queue.push(this.showCoubOverlay);
        } else {
          if (GlobalState.PAGE.getUrlParam('ref')) {
            this.queue.push(this.showAdMan);
          } else {
            this.queue.push(this.showEmbeddedOverlay);
            if (helpers.Location.isVkontakteEmbed()) {
              this.queue.push(this.showCoubOverlay);
              this.queue.push(this.showAdMan);
            } else {
              this.queue.push(this.showCoubOverlay);
              this.queue.push(this.showMegaAdfox);
              this.queue.push(this.showAdfoxCustom);
              this.queue.push(this.showMediaforceFixed);
              this.queue.push(this.showAdMan);
              if (!this.isNSFWCoub()) {
                this.queue.push(this.showCriteo);
              }
            }
          }
        }
      }
      if (this.data.permalink === 'cdj3r' || (window.env === 'development' && this.data.permalink === '4ac7')) {
        this.queue = [this.showGoogleVpaidOverlay];
      }
    }

    EmbedAds.prototype.init = function() {
      this.$closeBtn = $('.viewer__das__close', this.$el);
      $('div', this.$closeBtn).click((function(_this) {
        return function() {
          _this.$el.hide();
          return _this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_CLOSED);
        };
      })(this));
      this.vb.on(html5Player.EmbedAds.prototype.EVENT_BANNER_FAIL, this.clear);
      this.vb.on(html5Player.EmbedAds.prototype.EVENT_BANNER_SHOWN, this.showCloseButton);
      return this.vb.on(html5Player.EmbedAds.prototype.EVENT_BANNER_SHOWN, this.initAppearAnimation);
    };

    EmbedAds.prototype.initAppearAnimation = function() {
      this.ui.adsBlock.css("margin-bottom", "-" + (this.ui.adsBlock.offsetParent().height() - this.ui.adsBlock.position().top + 100) + "px");
      setTimeout(this.appearAnimation, 50);
      return this.vb.one("hover", this.appearAnimation);
    };

    EmbedAds.prototype.appearAnimation = function() {
      if (this.vb.hasClass("-visible-controls")) {
        this.ui.adsBlock.addClass("viewer__das__animated");
        return this.ui.adsBlock.css("margin-bottom", "0px");
      }
    };

    EmbedAds.prototype.showGoogleVpaidOverlay = function() {
      var adContainerElement, adDisplayContainer, adsLoader, adsRequest, onAdError, onAdsManagerLoaded, videoContent;
      if (!window.google || !window.google.ima) {
        return this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_FAIL);
      }
      onAdError = (function(_this) {
        return function(e) {
          console.log('GoogleVPAID.onAdError', e);
          _this.googleAdsContainer.remove();
          _this.adsManager = null;
          _this.player.trigger('play');
          return _this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_FAIL);
        };
      })(this);
      onAdsManagerLoaded = (function(_this) {
        return function(e) {
          var adsRenderingSettings, mode, onAdEvent;
          console.log('onAdsManagerLoaded', e);
          onAdEvent = function(e) {
            console.log('onAdEvent', e);
            if (e.type === 'loaded') {
              _this.player.trigger('pause');
              return _this.googleAdsContainer.css({
                'pointer-events': 'auto'
              });
            } else if (e.type === 'start') {

            } else if (e.type === 'complete' || e.type === 'skip') {
              _this.googleAdsContainer.remove();
              _this.player.trigger('play');
              return _this.adsManager = null;
            }
          };
          adsRenderingSettings = new google.ima.AdsRenderingSettings();
          adsRenderingSettings.restoreCustomPlaybackStateOnAdBreakComplete = true;
          adsRenderingSettings.useStyledNonLinearAds = true;
          _this.adsManager = e.getAdsManager(videoContent, adsRenderingSettings);
          _this.adsManager.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR, onAdError);
          _this.adsManager.addEventListener(google.ima.AdEvent.Type.LOADED, onAdEvent);
          _this.adsManager.addEventListener(google.ima.AdEvent.Type.STARTED, onAdEvent);
          _this.adsManager.addEventListener(google.ima.AdEvent.Type.COMPLETE, onAdEvent);
          _this.adsManager.addEventListener(google.ima.AdEvent.Type.SKIPPED, onAdEvent);
          mode = helpers.Location.isFullScreen() ? google.ima.ViewMode.FULLSCREEN : google.ima.ViewMode.NORMAL;
          _this.adsManager.init(_this.googleAdsContainer.width(), _this.googleAdsContainer.height(), mode);
          return _this.adsManager.start();
        };
      })(this);
      this.googleAdsContainer = $('<div style="width:100%;height:100%;pointer-events:none"/>').appendTo(this.ui.controlsContainer);
      console.log(123123, this.googleAdsContainer);
      google.ima.settings.setVpaidMode(google.ima.ImaSdkSettings.VpaidMode.INSECURE);
      adContainerElement = this.googleAdsContainer.get(0);
      videoContent = $('video', this.player).get(0);
      adDisplayContainer = new google.ima.AdDisplayContainer(adContainerElement, videoContent);
      adsLoader = new google.ima.AdsLoader(adDisplayContainer);
      adsLoader.addEventListener(google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED, onAdsManagerLoaded, false);
      adsLoader.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR, onAdError, false);
      adsRequest = new google.ima.AdsRequest();
      adsRequest.adTagUrl = '//ima3vpaid.appspot.com/?adTagUrl=http%3A%2F%2Fgoogleads.g.doubleclick.net%2Fpagead%2Fads%3Fad_type%3Dvideo%26client%3Dca-video-pub-4968145218643279%26videoad_start_delay%3D0%26description_url%3Dhttp%253A%252F%252Fwww.youtube.com%26hl%3Den%26max_ad_duration%3D40000%26adtest%3Don&type=js';
      adsRequest.nonLinearAdSlotWidth = 640;
      adsRequest.nonLinearAdSlotHeight = 100;
      adDisplayContainer.initialize();
      return adsLoader.requestAds(adsRequest);
    };

    EmbedAds.prototype.resize = function() {
      var mode;
      if (this.adsManager) {
        mode = helpers.Location.isFullScreen() ? google.ima.ViewMode.FULLSCREEN : google.ima.ViewMode.NORMAL;
        return this.adsManager.resize(this.googleAdsContainer.width(), this.googleAdsContainer.height(), mode);
      }
    };

    EmbedAds.prototype.showEmbeddedOverlay = function() {
      var promoWinnerId;
      promoWinnerId = _.chain(this.data.promo_winner_recoubers).last().first().value();
      if (promoWinnerId) {
        return $.get("/api/v2/bg/" + promoWinnerId).done((function(_this) {
          return function(overlay) {
            var data, uid;
            uid = helpers.Ads.getUniqId();
            data = {
              img240x100: overlay.image240x100,
              img400x100: overlay.image400x100,
              img600x100: overlay.image600x100,
              clickUrl: "/api/v2/bc/" + overlay.uuid + "?uid=" + uid,
              pixels: {
                click: null,
                view: "/api/v2/bs/" + overlay.uuid + "?uid=" + uid
              }
            };
            new html5Player.CustomOverlay(_this.ui.customOverlayContainer, _this.$closeBtn, data);
            return _this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_SHOWN);
          };
        })(this)).fail((function(_this) {
          return function() {
            return _this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_FAIL);
          };
        })(this));
      } else {
        return this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_FAIL);
      }
    };

    EmbedAds.prototype.showAdfoxCustom = function() {
      return $.ajax({
        url: '//ads.adfox.ru/214153/getCode?pp=h&ps=bkuu&p2=fmlo',
        dataType: 'xml',
        xhrFields: {
          withCredentials: true
        },
        success: (function(_this) {
          return function(r) {
            var banner, cls, data, h, i, images, j, len, pixels, ref, w;
            banner = $('banner', r);
            switch ($('> type', banner).text()) {
              case 'custom':
                cls = html5Player.CustomOverlay;
                break;
              case 'expanded':
                cls = html5Player.ExpandedOverlay;
                break;
              default:
                _this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_FAIL);
                return;
            }
            console.log("AdfoxCustom", r);
            data = {
              clickUrl: $('> click_url', banner).text(),
              pixels: {
                click: [],
                view: []
              }
            };
            images = $('> images', banner);
            ref = cls.SCHEMA;
            for (j = 0, len = ref.length; j < len; j++) {
              i = ref[j];
              w = i[0];
              h = i[1];
              data["img" + w + "x" + h] = $("> image" + w + "x" + h, images).text();
            }
            pixels = $('> pixels', banner);
            $('> show > pixel', pixels).each(function(i, el) {
              return data.pixels.view.push($(el).text());
            });
            $('> click > pixel', pixels).each(function(i, el) {
              return data.pixels.click.push($(el).text());
            });
            new cls(_this.ui.customOverlayContainer, _this.$closeBtn, data, _this.getAvailableHeight());
            return _this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_SHOWN);
          };
        })(this),
        error: (function(_this) {
          return function(e) {
            console.error(e);
            return _this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_FAIL);
          };
        })(this)
      });
    };

    EmbedAds.prototype.showCriteo = function() {
      if (this.player.width() < 350) {
        this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_FAIL);
        return;
      }
      return $.ajax({
        type: "GET",
        url: '//cas.criteo.com/delivery/0.1/napi.json?zoneid=761457',
        xhrFields: {
          withCredentials: true
        },
        success: (function(_this) {
          return function(r) {
            var data, p;
            console.log("CRITEO", r);
            if (r.response_status !== 0) {
              _this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_FAIL);
              return;
            }
            p = r.products[0];
            data = {
              image_url: p.image.url,
              title: p.title,
              description: p.description,
              bottom_text: p.price,
              criteo_about_text: r.advertiser.legal_text,
              criteo_about_url: r.privacy.optout_click_url,
              click_url: p.click_url,
              view_url: r.impression_pixels
            };
            new html5Player.WhiteOverlay(_this.ui.customOverlayContainer, _this.$closeBtn, data, _this.vb);
            return _this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_SHOWN);
          };
        })(this),
        error: (function(_this) {
          return function() {
            return _this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_FAIL);
          };
        })(this)
      });
    };

    EmbedAds.prototype.showAdMan = function(forceReload) {
      var admanLoader, onError, onReady;
      if (forceReload == null) {
        forceReload = false;
      }
      onReady = (function(_this) {
        return function(adm) {
          var overlays;
          overlays = adm.getBannersForSection('overlay');
          console.warn("ADMAN onReady", overlays);
          if (overlays.every(function(v) {
            return v.params === 'coub' && v.type === 'image';
          })) {
            if (!_this.isEmbed || GlobalState.PAGE.getUrlParam('ref')) {
              _this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_FAIL);
              return;
            }
            switch (overlays.length) {
              case 3:
                return _this.createCustomOverlay(overlays, html5Player.CustomOverlay);
              case 6:
                return _this.createCustomOverlay(overlays, html5Player.ExpandedOverlay);
              default:
                _this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_FAIL);
            }
          } else {
            if (overlays.length > 0) {
              _this.$el.addClass('-adman');
              _this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_SHOWN);
              return adm.start('overlay');
            }
          }
        };
      })(this);
      onError = (function(_this) {
        return function() {
          return _this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_FAIL);
        };
      })(this);
      admanLoader = new html5Player.AdmanLoader(this.data.permalink, this.ui, forceReload);
      return admanLoader.get(onReady, onError);
    };

    EmbedAds.prototype.createCustomOverlay = function(overlays, cls) {
      var data, h, j, k, len, len1, ref, schema, type, v, w;
      data = {
        clickUrl: overlays[0].urlToNavigateOnClick,
        pixels: {
          click: [],
          view: []
        }
      };
      if (overlays.find((function(_this) {
        return function(v) {
          return v.width === 500;
        };
      })(this))) {
        cls.SCHEMA[1] = [500, 100];
      }
      schema = cls.SCHEMA;
      for (j = 0, len = schema.length; j < len; j++) {
        type = schema[j];
        w = type[0];
        h = type[1];
        data["img" + w + "x" + h] = overlays.find((function(_this) {
          return function(v) {
            return v.width === w && v.height === h;
          };
        })(this)).src;
      }
      ref = overlays[0].statistics;
      for (k = 0, len1 = ref.length; k < len1; k++) {
        v = ref[k];
        switch (v.type) {
          case "playbackStarted":
            data.pixels.view.push(v.url);
            break;
          case "click":
            data.pixels.click.push(v.url);
        }
      }
      new cls(this.ui.customOverlayContainer, this.$closeBtn, data, this.getAvailableHeight());
      return this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_SHOWN);
    };

    EmbedAds.prototype.showCoubOverlay = function() {
      var day, dt, last_show_at, max_shows_per_day, overlay_data, shows, t, uid;
      day = 60 * 60 * 24 * 1000;
      max_shows_per_day = GlobalState.COUNTRY.isRussia() ? 0 : 0;
      t = new Date().getTime();
      uid = helpers.Ads.getUniqId();
      last_show_at = $.cookie('coub_overlay_last_show_at');
      dt = last_show_at ? t - last_show_at : day + 1;
      shows = dt > day ? 0 : parseInt($.cookie('coub_overlay_show')) || 0;
      if (shows >= max_shows_per_day) {
        return this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_FAIL);
      }
      if (!overlay_data) {
        return this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_FAIL);
      }
      overlay_data = $.extend(true, {}, overlay_data);
      overlay_data.clickUrl += uid;
      overlay_data.pixels.view += uid;
      new html5Player.CustomOverlay(this.ui.customOverlayContainer, this.$closeBtn, overlay_data);
      shows++;
      $.cookie('coub_overlay_last_show_at', t, {
        expires: 1,
        path: '/'
      });
      $.cookie('coub_overlay_show', shows, {
        expires: 1,
        path: '/'
      });
      return this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_SHOWN);
    };

    EmbedAds.prototype.showMediaforceFixed = function() {
      var bannerHeight, bannerWidth, callbackFired, checkRender, containerWidth, id, onRender, onStub, ratio;
      if (!window.Ya || !window.Ya.adfoxCode || !window.Ya.headerBidding) {
        return this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_FAIL);
      }
      id = "adfox_overlay_" + (Date.now());
      this.ui.customOverlayContainer.attr({
        id: id
      });
      this.ui.bannerContainer.css({
        'max-width': 'none'
      });
      bannerWidth = 728;
      bannerHeight = 90;
      containerWidth = this.ui.customOverlayContainer.width();
      if (bannerWidth > containerWidth) {
        ratio = containerWidth / bannerWidth;
        this.ui.customOverlayContainer.css({
          width: bannerWidth + "px",
          transform: "scale(" + ratio + ")",
          'transform-origin': 'bottom left'
        });
        this.$closeBtn.css({
          'margin-top': (bannerHeight * (1 - ratio)) + "px"
        });
      } else {
        this.ui.bannerContainer.css({
          display: 'inline-block'
        });
      }
      callbackFired = false;
      onRender = (function(_this) {
        return function() {
          if (callbackFired) {
            return;
          }
          callbackFired = true;
          console.log('mediaforce render');
          _this.$closeBtn.addClass('-big-area');
          return _this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_SHOWN);
        };
      })(this);
      onStub = (function(_this) {
        return function() {
          if (callbackFired) {
            return;
          }
          callbackFired = true;
          console.log('mediaforce stub');
          _this.ui.customOverlayContainer.removeAttr('id').css({
            width: '',
            transform: '',
            'transform-origin': ''
          });
          _this.$closeBtn.css({
            'margin-top': ''
          });
          _this.ui.bannerContainer.css({
            'max-width': '',
            display: ''
          });
          return _this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_FAIL);
        };
      })(this);
      checkRender = (function(_this) {
        return function() {
          if (callbackFired) {
            return;
          }
          console.log('mediaforce check callbacks');
          if (_this.ui.customOverlayContainer.height() > 0) {
            return onRender();
          } else {
            return onStub();
          }
        };
      })(this);
      window.Ya.headerBidding.pushAdUnits([
        {
          code: id,
          sizes: [[728, 90]],
          bids: [
            {
              bidder: 'betweenDigital',
              params: {
                placementId: '2687618'
              }
            }, {
              bidder: 'rtbhouse',
              params: {
                placementId: '2TNjEAGc8xXLzSNJwGge'
              }
            }, {
              bidder: 'alfasense',
              params: {
                placementId: 'direct_otm_1511'
              }
            }, {
              bidder: 'getintent',
              params: {
                placementId: '81_MF_Coub.com_D_Overlay'
              }
            }
          ]
        }
      ]);
      window.Ya.adfoxCode.createAdaptive({
        ownerId: 220463,
        containerId: id,
        params: {
          p1: 'cbmfd',
          p2: 'fqhi'
        },
        onRender: onRender,
        onStub: onStub
      }, ['desktop', 'tablet'], {
        tabletWidth: 720,
        phoneWidth: 480,
        isAutoReloads: false
      });
      return setTimeout(checkRender, 3000);
    };

    EmbedAds.prototype.showMegaAdfox = function() {
      var containerId, params, targetWidth, width;
      if (!window.Ya || !window.Ya.adfoxCode) {
        return this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_FAIL);
      }
      containerId = "adfox_" + (Date.now());
      this.ui.customOverlayContainer.attr("id", containerId);
      width = this.ui.customOverlayContainer.width();
      if (width >= 600) {
        targetWidth = 600;
        params = {
          p1: "cbxaw",
          p2: "gcjo"
        };
      } else if (width >= 400) {
        targetWidth = 400;
        params = {
          p1: "cbxav",
          p2: "gcjn"
        };
      } else if (width >= 240) {
        targetWidth = 240;
        params = {
          p1: "cbxau",
          p2: "gcjm"
        };
      } else {
        return this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_FAIL);
      }
      return window.Ya.adfoxCode.create({
        ownerId: 214153,
        containerId: containerId,
        params: params,
        onRender: (function(_this) {
          return function() {
            return _this.ui.customOverlayContainer.width(targetWidth).append(_this.$closeBtn.removeClass("-hidden"));
          };
        })(this),
        onStub: (function(_this) {
          return function() {
            return _this.vb.triggerHandler(html5Player.EmbedAds.prototype.EVENT_BANNER_FAIL);
          };
        })(this)
      });
    };

    EmbedAds.prototype.getAvailableHeight = function() {
      return this.ui.vb.height() - parseInt(this.ui.adsBlock.css('bottom'));
    };

    EmbedAds.prototype.showAd = function() {
      if (!this.isShowed) {
        this.isShowed = true;
        this.vb.on(html5Player.EmbedAds.prototype.EVENT_BANNER_FAIL, this.showNextAd);
        return this.showNextAd();
      }
    };

    EmbedAds.prototype.showNextAd = function() {
      var fn;
      if (this.queue.length === 0) {
        return;
      }
      fn = this.queue.shift();
      return fn();
    };

    EmbedAds.prototype.clear = function() {
      return this.$el.find(".-removeable").remove();
    };

    EmbedAds.prototype.showCloseButton = function() {
      return this.$closeBtn.removeClass('-hidden');
    };

    EmbedAds.prototype.isNSFWCoub = function() {
      return this.data.age_restricted || this.data.age_restricted_by_admin || this.data.not_safe_for_work || _.some(this.data.categories, function(category) {
        return category.permalink === 'nsfw';
      });
    };

    return EmbedAds;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  html5Player.ExpandedOverlay = (function(superClass) {
    extend(ExpandedOverlay, superClass);

    ExpandedOverlay.DT = "html5Player.ExpandedOverlay";

    ExpandedOverlay.SCHEMA = [[600, 300], [600, 100], [400, 200], [400, 100], [240, 160], [240, 100]];

    function ExpandedOverlay(el, closeBtn, data, availableHeight) {
      this.el = el;
      this.closeBtn = closeBtn;
      this.data = data;
      this.availableHeight = availableHeight;
      this.init = bind(this.init, this);
      ExpandedOverlay.__super__.constructor.apply(this, arguments);
    }

    ExpandedOverlay.prototype.init = function() {
      var big, bigOverlay, foldBtn, i, item, len, o, ref, small, smallOverlay, w;
      w = this.el.width();
      ref = this.s.SCHEMA;
      for (i = 0, len = ref.length; i < len; i++) {
        item = ref[i];
        if (w >= item[0]) {
          o = _.where(this.s.SCHEMA, {
            0: item[0]
          });
          big = {
            width: o[0][0],
            height: o[0][1]
          };
          small = {
            width: o[1][0],
            height: o[1][1]
          };
          break;
        }
      }
      if (!o) {
        return;
      }
      console.log(this.s.DT, big, small, w, this.availableHeight);
      smallOverlay = $(this.getOverlayTemplate(small.width, small.height));
      smallOverlay.click((function(_this) {
        return function() {
          return _this.onOverlayClick();
        };
      })(this));
      if (this.availableHeight >= big.height) {
        console.log(this.s.DT, "fit");
        bigOverlay = $(this.getOverlayTemplate(big.width, big.height));
        foldBtn = $('.banner-fold', this.el);
        foldBtn.removeClass('-hidden');
        this.closeBtn.addClass('-force-hidden');
        this.setElementSize(big.width, big.height);
        this.el.append(bigOverlay).append(this.closeBtn).append(foldBtn);
        bigOverlay.click((function(_this) {
          return function() {
            return _this.onOverlayClick();
          };
        })(this));
        foldBtn.click((function(_this) {
          return function() {
            foldBtn.addClass('-hidden');
            _this.closeBtn.removeClass('-force-hidden');
            bigOverlay.replaceWith(smallOverlay);
            return _this.setElementSize(small.width, small.height);
          };
        })(this));
      } else {
        console.log(this.s.DT, "not fit");
        this.setElementSize(small.width, small.height);
        this.el.append(smallOverlay).append(this.closeBtn);
      }
      return this.trackStat("view");
    };

    return ExpandedOverlay;

  })(html5Player.BaseOverlay);

}).call(this);
(function() {
  html5Player.SimpleOverlay = (function() {
    function SimpleOverlay(el, data) {
      var banner;
      this.el = el;
      this.data = data;
      banner = $(this.getTemplate(this.data.img, this.data.title));
      this.el.append(banner);
      banner.click((function(_this) {
        return function() {
          return window.open(_this.data.clickUrl, '_blank');
        };
      })(this));
    }

    SimpleOverlay.prototype.getTemplate = function(src, text) {
      return "<div class=\"html5-player-simple-overlay\">\n  <img src=\"" + src + "\"></img>\n  <p>" + text + "</p>\n</div>";
    };

    return SimpleOverlay;

  })();

}).call(this);
(function() {
  html5Player.WhiteOverlay = (function() {
    function WhiteOverlay(el, closeBtn, data, vb) {
      var banner;
      this.el = el;
      this.closeBtn = closeBtn;
      this.data = data;
      this.vb = vb;
      banner = $(this.getTemplate());
      banner.append(this.closeBtn);
      this.el.append(banner);
      if (!this.data.bottom_img) {
        $('.bottom img', banner).remove();
      }
      if (!this.data.bottom_text) {
        $('.bottom span', banner).remove();
      }
      if (this.data.criteo_about_text) {
        this.initCriteoInfo();
      }
      this.initShowTracking();
    }

    WhiteOverlay.prototype.initCriteoInfo = function() {
      var aboutText, expandedText, info;
      info = $('.criteo-info', this.el);
      info.removeClass('-hidden');
      aboutText = $('.info-text-hoverable', info);
      expandedText = $('.info-expanded', info);
      aboutText.mouseover((function(_this) {
        return function() {
          var p, pMin;
          aboutText.addClass('-hidden');
          expandedText.removeClass('-hidden').css({
            padding: 0,
            width: 'auto'
          });
          pMin = 5;
          p = (expandedText.offset().left - _this.el.offset().left) / 2;
          if (p > pMin) {
            return expandedText.css({
              padding: "5px " + p + "px 5px " + p + "px"
            });
          } else {
            return expandedText.css({
              width: (expandedText.width() + p * 2) + "px",
              padding: "5px " + pMin + "px 5px " + pMin + "px"
            });
          }
        };
      })(this));
      return expandedText.mouseout((function(_this) {
        return function() {
          aboutText.removeClass('-hidden');
          return expandedText.addClass('-hidden');
        };
      })(this));
    };

    WhiteOverlay.prototype.initShowTracking = function() {
      this.vb.on(Player.EVENT_PLAYING, (function(_this) {
        return function() {
          return _this.startVisibilityCheck();
        };
      })(this));
      this.vb.on(Player.EVENT_PAUSED, (function(_this) {
        return function() {
          return _this.stopVisibilityCheck();
        };
      })(this));
      return this.startVisibilityCheck();
    };

    WhiteOverlay.prototype.startVisibilityCheck = function() {
      if (this.hasShowed || this.interval) {
        return;
      }
      return this.interval = setInterval((function(_this) {
        return function() {
          if (_this.isOverlayVisible()) {
            return _this.onShow();
          }
        };
      })(this), 190);
    };

    WhiteOverlay.prototype.stopVisibilityCheck = function() {
      return clearInterval(this.interval);
    };

    WhiteOverlay.prototype.isOverlayVisible = function() {
      return this.vb.hasClass('-visible-controls') && this.vb.filter('.-changer-mode, .-ui-state-autoplay_muted').length === 0;
    };

    WhiteOverlay.prototype.onShow = function() {
      var i, len, p, ref, results;
      this.hasShowed = true;
      this.stopVisibilityCheck();
      if (_.isArray(this.data.view_url)) {
        ref = this.data.view_url;
        results = [];
        for (i = 0, len = ref.length; i < len; i++) {
          p = ref[i];
          results.push(this.trackPixel(p.url));
        }
        return results;
      } else {
        return this.trackPixel(this.data.view_url);
      }
    };

    WhiteOverlay.prototype.trackPixel = function(p) {
      return $('body').append("<img src=" + p + " width=0 height=0/>");
    };

    WhiteOverlay.prototype.getTemplate = function() {
      return "<div class=\"html5-player__white-overlay\">\n  <a href=" + this.data.click_url + " target=\"_blank\">\n    <div class=\"img\" style=\"background-image:url(" + this.data.image_url + ")\"></div>\n    <div class=\"content -color--black\">\n      <div class=\"title hbold\">" + this.data.title + "</div>\n      <div class=\"description\">" + this.data.description + "</div>\n      <div class=\"bottom\">\n        <span>" + this.data.bottom_text + "</span>\n        <img src=" + (this.data.bottom_img || '') + " />\n      </div>\n    </div>\n  </a>\n  <div class=\"criteo-info -hidden\">\n    <a href=" + this.data.criteo_about_url + " target=\"_blank\">\n      <div class=\"info-expanded -hidden\">\n        <div>" + this.data.criteo_about_text + "</div>\n      </div>\n      <div class=\"info-text-hoverable\">О компании</div>\n      <div class=\"info-text\">AdChoices</div>\n      <div class=\"info-icon\"></div>\n    </a>\n  </div>\n</div>";
    };

    return WhiteOverlay;

  })();

}).call(this);
(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  html5Player.VastPreroll = (function(superClass) {
    extend(VastPreroll, superClass);

    function VastPreroll() {
      return VastPreroll.__super__.constructor.apply(this, arguments);
    }

    VastPreroll.prototype.init = function() {
      if (!window.google || !window.google.ima) {
        _.defer((function(_this) {
          return function() {
            console.error("VAST ERROR", "IMA SDK is absent");
            return _this.dispatchAndUnlock(_this.EVENT_PREROLL_FAILED);
          };
        })(this));
        return;
      }
      this.locker.lock();
      this.adBlock = this.prerollBlock.find(".vast-ad-preroll");
      this.adsQueue = [];
      return this.requestAd(this.getPladformUrl());
    };

    VastPreroll.prototype.requestAd = function(vastUrl) {
      var adDisplayContainer, adsLoader, adsRequest, onAdError, onAdsManagerLoaded;
      this.adBlock.empty();
      adDisplayContainer = new google.ima.AdDisplayContainer(this.adBlock.get(0));
      adDisplayContainer.initialize();
      onAdError = (function(_this) {
        return function(e) {
          console.error("VAST ERROR", e.getError());
          if (_this.adsQueue.length && helpers.Location.isVkontakteEmbed()) {
            return _this.requestAd(_this.adsQueue.shift()());
          } else {
            return _this.dispatchAndUnlock(_this.EVENT_PREROLL_FAILED);
          }
        };
      })(this);
      onAdsManagerLoaded = (function(_this) {
        return function(adsManagerLoadedEvent) {
          var adError, adsManager, adsRenderingSettings;
          adsRenderingSettings = new google.ima.AdsRenderingSettings();
          adsRenderingSettings.uiElements = [google.ima.UiElements.COUNTDOWN, google.ima.UiElements.AD_ATTRIBUTION];
          adsManager = adsManagerLoadedEvent.getAdsManager({
            currentTime: 0
          }, adsRenderingSettings);
          adsManager.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR, onAdError);
          adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED, _this.onAdEnd.bind(_this));
          adsManager.addEventListener(google.ima.AdEvent.Type.PAUSED, function(e) {
            return $(window).on('focus.vastPreroll visibilitychange.vastPreroll', (function() {
              if (document.hidden) {
                return;
              }
              $(window).off('focus.vastPreroll visibilitychange.vastPreroll');
              return this.resume();
            }).bind(e.target));
          });
          adsManager.addEventListener(google.ima.AdEvent.Type.COMPLETE, function() {
            return $(window).off('focus.vastPreroll visibilitychange.vastPreroll');
          });
          adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED, function() {
            return $(window).off('focus.vastPreroll visibilitychange.vastPreroll');
          });
          try {
            adsManager.init(_this.prerollBlock.width(), _this.prerollBlock.height(), google.ima.ViewMode.NORMAL);
            adsManager.start();
            return _this.onAdStart();
          } catch (error) {
            adError = error;
            return console.error("VAST ERROR", adError);
          }
        };
      })(this);
      adsLoader = new google.ima.AdsLoader(adDisplayContainer);
      adsLoader.addEventListener(google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED, onAdsManagerLoaded, false);
      adsLoader.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR, onAdError, false);
      adsRequest = new google.ima.AdsRequest();
      adsRequest.adTagUrl = vastUrl;
      return adsLoader.requestAds(adsRequest);
    };

    VastPreroll.prototype.makeUrl = function(baseUrl, params) {
      var urlParams;
      urlParams = _.chain(params).map(function(v, k) {
        if ((v == null) || v === "") {
          return;
        }
        return k + "=" + (encodeURIComponent(v));
      }).compact().join("&").value();
      return baseUrl + "&" + urlParams;
    };

    VastPreroll.prototype.getMailUrl = function() {
      return this.makeUrl("https://ad.mail.ru/vast/3930?puid1=69&puid2=17&puid3=1", {
        duration: Math.floor(this.data.duration),
        dl: GlobalState.PAGE.getReferrer(),
        preview: getQueryParameters().preview
      });
    };

    VastPreroll.prototype.getPladformUrl = function() {
      return this.makeUrl("https://out.pladform.ru/getVast?pl=110690&type=preroll&license=3&target=web-html5", {
        age: this.isAgeRestrictedCoub(this.data) ? 5 : 1,
        thematic: this.getPladformThematic(this.data.categories),
        duration: Math.floor(this.data.duration),
        dl: GlobalState.PAGE.getReferrer()
      });
    };

    VastPreroll.prototype.isAgeRestrictedCoub = function(coubData) {
      return coubData.age_restricted || coubData.age_restricted_by_admin || (_.some(coubData.categories, function(coubCategory) {
        return coubCategory.permalink === "nsfw";
      }));
    };

    VastPreroll.prototype.getPladformThematic = function(coubCategories) {
      var thematic, thematicsMap;
      thematicsMap = {
        "funny": 1098,
        "animals-pets": 592,
        "mashup": 1592,
        "anime": 687,
        "movies": 420,
        "gaming": 391,
        "cartoons": 688,
        "tv-series": 1762,
        "art": 8109,
        "music": 585,
        "news": 746,
        "sports": 957,
        "geek": 8110,
        "celebrity": 8109,
        "nature-travel": 8107,
        "fashion": 8106,
        "nsfw": 1196
      };
      thematic = null;
      _.some(coubCategories, function(coubCategory) {
        thematic = thematicsMap[coubCategory.permalink];
        if (thematic != null) {
          return true;
        }
      });
      return thematic;
    };

    return VastPreroll;

  })(html5Player.Preroll);

}).call(this);
(function() {
  html5Player.Favourites = (function() {
    Favourites.prototype.DT = 'html5Player.Favourites';

    function Favourites(coubId, coubPermalink, isAdded) {
      this.coubId = coubId;
      this.coubPermalink = coubPermalink;
      this.isAdded = isAdded;
      this.isLoading = false;
    }

    Favourites.prototype.toggle = function(onToggled) {
      if (this.isLoading) {
        return;
      }
      if (this.isAdded) {
        return this.remove(onToggled);
      } else {
        return this.add(onToggled);
      }
    };

    Favourites.prototype.add = function(onComplete) {
      console.log(this.DT, 'add');
      return this.createRequest('POST').done((function(_this) {
        return function(result) {
          console.log(_this.DT, 'add done', result);
          return _this.isAdded = true;
        };
      })(this)).fail((function(_this) {
        return function(error) {
          console.log(_this.DT, 'fail', error);
          if (error) {
            if (error.status === 422) {
              console.log(_this.DT, 'already added');
              return _this.isAdded = true;
            } else if (error.status === 403 || (window.env === 'development' && error.status === 500)) {
              console.log(_this.DT, 'unlogged');
              return _this.openLoginPage();
            }
          }
        };
      })(this)).always(onComplete);
    };

    Favourites.prototype.remove = function(onComplete) {
      console.log(this.DT, 'remove');
      return this.createRequest('DELETE').done((function(_this) {
        return function(result) {
          console.log(_this.DT, 'remove done', result);
          return _this.isAdded = false;
        };
      })(this)).fail((function(_this) {
        return function(error) {
          return console.log(_this.DT, 'remove fail', error);
        };
      })(this)).always(onComplete);
    };

    Favourites.prototype.createRequest = function(type) {
      this.isLoading = true;
      return $.ajax({
        url: '/api/v2/favourites',
        type: type,
        data: {
          id: this.coubId
        }
      }).always((function(_this) {
        return function() {
          return _this.isLoading = false;
        };
      })(this));
    };

    Favourites.prototype.openLoginPage = function() {
      return window.open("/view/" + this.coubPermalink + "#signupAndFav");
    };

    return Favourites;

  })();

}).call(this);
(function() {
  html5Player.MediaElementStrategy = (function() {
    function MediaElementStrategy(kind, isHD, el) {
      this.isHD = isHD;
      this.el = el;
      this.kind = kind;
      this.el || (this.el = this.createElement());
      this.destroyCalls = 0;
      this.setSrcCalls = 0;
    }

    MediaElementStrategy.prototype.destroy = function() {
      var e, ref;
      this.destroyCalls++;
      if (this.mediaSource) {
        this.mediaSource.removeEventListener("sourceopen", this.mediaSourceOpenListener);
      }
      if (this.sourceBuffer) {
        this.sourceBuffer.removeEventListener("updateend", this.bufferUpdateListener);
        if (this.sourceBuffer.updating) {
          this.sourceBuffer.abort();
        }
        try {
          this.mediaSource.removeSourceBuffer(this.sourceBuffer);
        } catch (error) {
          e = error;
          (typeof Honeybadger !== "undefined" && Honeybadger !== null) && Honeybadger.notify(e, {
            context: {
              msBuffers: this.mediaSource.sourceBuffers.length,
              destroyCalls: this.destroyCalls,
              setSrcCalls: this.setSrcCalls
            }
          });
        }
      }
      this.xhr && this.xhr.abort();
      URL.revokeObjectURL && URL.revokeObjectURL(this.el.attr('src'));
      this.el.removeAttr("src");
      this.el.get(0).load();
      this.el.remove();
      return ref = [], this.mediaSource = ref[0], this.sourceBuffer = ref[1], this.xhr = ref[2], this.el = ref[3], ref;
    };

    MediaElementStrategy.prototype.createElement = function() {
      if (this.kind === 'video') {
        return $("<video class='viewer__video' loop='loop' preload='auto' />");
      } else {
        return $("<audio preload='auto'></audio>");
      }
    };

    MediaElementStrategy.prototype.setSrc = function(src, size) {
      var MS, minChunkSize;
      this.setSrcCalls++;
      this.mimeCodec = this.getCodec();
      MS = window.MediaSource;
      if (MS && MS.isTypeSupported(this.mimeCodec)) {
        this.size = size;
        minChunkSize = this.kind === 'video' && 262144 || 131072;
        if (!this.isHD) {
          minChunkSize /= 2;
        }
        this.chunkSize = this.kind === 'video' ? Math.max(Math.ceil(this.size / 4), minChunkSize) : minChunkSize;
        return this.setMediaSource(src);
      } else {
        console.log("[PLAYER]", "media", this.kind, "fallback to media element");
        return this.setSource(src);
      }
    };

    MediaElementStrategy.prototype.getCodec = function() {
      if (this.kind === 'video') {
        return 'video/mp4; codecs="avc1.64001f"';
      } else if (GlobalState.BROWSER.isSafari()) {
        return 'audio/mp3; codecs="mp4a.6b"';
      } else {
        return 'audio/mpeg';
      }
    };

    MediaElementStrategy.prototype.fetchChunk = function(url, chunkNo, isFinalChunk) {
      var bytesRange, defer;
      defer = $.Deferred();
      this.xhr = new XMLHttpRequest();
      this.xhr.onload = (function(_this) {
        return function() {
          return defer.resolve(_this.xhr.response, chunkNo);
        };
      })(this);
      this.xhr.onerror = function() {
        return defer.reject();
      };
      this.xhr.onprogress = function(e) {
        return defer.notify(e.loaded / e.total);
      };
      bytesRange = ((chunkNo - 1) * this.chunkSize) + "-";
      if (!isFinalChunk) {
        bytesRange += "" + (chunkNo * this.chunkSize - 1);
      }
      this.xhr.open('get', url);
      this.xhr.setRequestHeader('Range', "bytes=" + bytesRange);
      this.xhr.responseType = 'arraybuffer';
      this.xhr.send();
      return defer.promise();
    };

    MediaElementStrategy.prototype.setMediaSource = function(src) {
      var loadDefer, playDefer;
      this.mediaSource = new MediaSource();
      playDefer = $.Deferred();
      loadDefer = $.Deferred();
      this.el.attr('src', URL.createObjectURL(this.mediaSource));
      this.el.on('canplay', function() {
        return playDefer.resolve();
      });
      this.el.on('error', (function(_this) {
        return function(e) {
          var err;
          err = e.target.error || {};
          return playDefer.reject(_this.kind + " element err " + err.message + " " + err.code);
        };
      })(this));
      this.mediaSourceOpenListener = (function(_this) {
        return function() {
          var chunkNo, chunks, isProgressiveDownload, loadChunk, progress, progress_per_chunk, requestedChunks, segmentDuration;
          _this.mediaSource.removeEventListener("sourceopen", _this.mediaSourceOpenListener);
          chunks = Math.ceil(_this.size / _this.chunkSize);
          chunkNo = 1;
          progress_per_chunk = Math.round(1 / chunks * 100) / 100;
          progress = 0;
          isProgressiveDownload = _this.kind !== "video" && _this.size >= 262144;
          requestedChunks = [];
          segmentDuration = 0;
          _this.sourceBuffer = _this.mediaSource.addSourceBuffer(_this.mimeCodec);
          loadChunk = function() {
            var xhr;
            xhr = _this.fetchChunk(src, chunkNo, chunkNo === chunks);
            xhr.fail(function() {
              return loadDefer.reject();
            });
            xhr.progress(function(p) {
              return loadDefer.notify(progress + progress_per_chunk * p);
            });
            return xhr.done(function(data, chunkNumber) {
              var e;
              try {
                if (chunkNumber === 1 && _this.kind === 'video') {
                  _this.decode(data);
                }
                return _this.sourceBuffer.appendBuffer(data);
              } catch (error) {
                e = error;
                return playDefer.reject('sourceBuffer err');
              }
            });
          };
          _this.bufferUpdateListener = function() {
            var e;
            if (++chunkNo > chunks) {
              try {
                _this.mediaSource.endOfStream();
              } catch (error) {
                e = error;
                $.noop();
              }
              loadDefer.notify(1);
              loadDefer.resolve();
              delete _this.xhr;
              return _this.el.off("timeupdate.mediaEl");
            } else {
              progress = progress_per_chunk * (chunkNo - 1);
              loadDefer.notify(progress);
              if (!isProgressiveDownload) {
                return loadChunk();
              }
            }
          };
          if (isProgressiveDownload) {
            _this.el.on("timeupdate.mediaEl", function(e) {
              if (requestedChunks.indexOf(chunkNo) !== -1 || _this.sourceBuffer.buffered.length < 1) {
                return;
              }
              segmentDuration || (segmentDuration = _this.sourceBuffer.buffered.end(0));
              if (e.target.currentTime < _this.sourceBuffer.buffered.end(0) - segmentDuration * 0.8) {
                return;
              }
              requestedChunks.push(chunkNo);
              return loadChunk();
            });
          }
          _this.sourceBuffer.addEventListener("updateend", _this.bufferUpdateListener);
          return loadChunk();
        };
      })(this);
      this.mediaSource.addEventListener("sourceopen", this.mediaSourceOpenListener);
      return {
        load: loadDefer.promise(),
        play: playDefer.promise()
      };
    };

    MediaElementStrategy.prototype.setSource = function(src) {
      var defer;
      defer = $.Deferred();
      this.el.attr('src', src);
      this.el.on('progress', function() {
        var buffered, loaded, total;
        if (this.buffered.length > 0) {
          total = this.duration;
          buffered = this.buffered.end(this.buffered.length - 1);
          loaded = buffered / total;
          return defer.notify(loaded);
        } else {
          return defer.notify(0);
        }
      });
      this.el.one('error', function() {
        return defer.reject(this.error && this.error.message);
      });
      this.el.one('canplaythrough', function() {
        defer.notify(1);
        return defer.resolve();
      });
      return {
        load: defer.promise(),
        play: defer.promise()
      };
    };

    MediaElementStrategy.prototype.decode = function(buf) {
      var x;
      x = new Uint16Array(buf, 0, 2);
      if (x[0] === 19392) {
        return x[0] = 0;
      }
    };

    return MediaElementStrategy;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  html5Player.UI = (function() {
    UI.prototype.VIEW = {
      UNLOADED: 0,
      LOADING: 1,
      SUSPENDED: 2,
      SUGGESTS: 3,
      DISABLED: 4,
      PLAYING: 5,
      AUTOPLAY_MUTED: 6,
      SHARING: 7,
      UNLOADED_SHARING: 8,
      BROWSER_MUTED: 9,
      EMPTY: 10
    };

    function UI(player, isEmbed) {
      this.restoreScrollAfterFullscreen = bind(this.restoreScrollAfterFullscreen, this);
      this.fullScreenHandler = bind(this.fullScreenHandler, this);
      this.onOutsideClick = bind(this.onOutsideClick, this);
      this.player = player;
      this.isEmbed = isEmbed;
      this.viewCls = _.reduce(this.VIEW, function(memo, v, k) {
        memo[v] = "-ui-state-" + (k.toLowerCase());
        return memo;
      }, {});
      this.vb = this.player.vb;
      $('.viewer__filter__hack', this.vb).removeClass('-hidden');
      this.playerContainer = $('.viewer__player', this.vb);
      this.poster = $('img.viewer__img', this.vb);
      this.blackScreen = $('.viewer__black-screen', this.vb);
      this.controlsContainer = $('.viewer__controls__container', this.vb);
      this.viewerClick = $('.viewer__click', this.vb);
      this.sharingLayer = $('.viewer__sharing', this.controlsContainer);
      this.sharingItems = $('.viewer__sharing__items', this.controlsContainer);
      this.suggestsLayer = $('.viewer__suggests', this.controlsContainer);
      this.spinner = $('.viewer__spinner', this.controlsContainer);
      this.viewerControls = $('.viewer__controls', this.vb).removeClass('-hidden');
      this.muteOverlay = $('.viewer__mute', this.controlsContainer);
      this.shareButton = $('.viewer__share', this.viewerControls);
      this.fullScreenButton = $('.viewer__fullscreen', this.viewerControls);
      this.favouritesButton = $('.viewer__favourites', this.viewerControls);
      this.copyLinkButton = $('.viewer__copylink', this.controlsContainer);
      this.settingsCopyLinkButton = $('.viewer__settings-copy', this.viewerControls);
      this.sharingCopyLinkButton = $('.viewer__sharing__item .copy', this.sharingLayer);
      this.soundBar = $('.viewer__sound__bar > .sound-bar-slider', this.viewerControls);
      this.soundButton = $('.viewer__sound', this.controlsContainer);
      this.hdButton = $('.viewer__settings-hd', this.viewerControls);
      this.playControls = $('.viewer__controls__play', this.viewerControls);
      this.settingsHandler = $('.viewer__settings-handler', this.viewerControls);
      this.settingsContent = $('.viewer__settings-content', this.viewerControls);
      this.replayButton = $('.viewer__replay', this.suggestsLayer);
      this.settingsReplayButton = $('.viewer__settings-replay', this.viewerControls);
      this.infoBlock = $('.viewer__coub-info', this.controlsContainer);
      this.fullscreenLogo = $('.viewer__fullscreen-logo', this.controlsContainer);
      this.fingerButton = $('.viewer__hand', this.controlsContainer).removeClass('-hidden');
      this.mobileMark = $('.viewer__site-logo', this.controlsContainer);
      this.changerButtons = $('.viewer__coubs-changer', this.controlsContainer);
      this.adsBlock = $('.viewer__das', this.controlsContainer);
      this.bannerContainer = $('.viewer__das__banner', this.adsBlock);
      this.admanOverlayContainer = $('.adman-ad-overlay', this.adsBlock);
      this.customOverlayContainer = $('.custom-ad-overlay', this.adsBlock);
      this.prerollBlock = $('.viewer__das__preroll', this.vb);
      this.init();
      this.initSound();
      this.initSettingsDropdown();
      this.initCopyLink();
      chms.utils.Autoinit.init(widgets.DownloadCoubVideoButton, this.vb);
      _.defer((function(_this) {
        return function() {
          return _this.checkAdblockSocialMedia();
        };
      })(this));
    }

    UI.prototype.init = function() {
      var idleCountdown;
      this.ratio = parseFloat(this.playerContainer.attr('data-aspect-ratio'));
      this.setSizes();
      this.poster.on('load', this.setSizes.bind(this));
      idleCountdown = _.debounce((function(_this) {
        return function() {
          if (_this.viewerControls.is(':hover') || _this.isSettingsDropdownOpened) {
            return;
          }
          _this.vb.removeClass('-visible-controls');
          return _this.vb.one('mousemove', function() {
            return _this.vb.addClass('-visible-controls');
          });
        };
      })(this), 5000);
      this.vb.on('mousemove', idleCountdown).hover((function(_this) {
        return function(e) {
          return _this.vb.toggleClass('-visible-controls', e.type === 'mouseenter' || _this.isSettingsDropdownOpened);
        };
      })(this));
      $(document).on('fullscreenchange', this.fullScreenHandler);
      $('[data-prompt]', this.controlsContainer).prompt();
      return this.vb.on("dom_remove", (function(_this) {
        return function() {
          return $(document).off('fullscreenchange', _this.fullScreenHandler);
        };
      })(this));
    };

    UI.prototype.initSound = function() {
      var $soundBarHoverArea, $soundBarWrap, dragging, hoverTimeout, isSoundBarHover, setSlider;
      dragging = false;
      hoverTimeout = void 0;
      isSoundBarHover = false;
      $soundBarHoverArea = $('.viewer__sound__hover__area', this.controlsContainer);
      $soundBarWrap = this.soundBar.parent();
      this.soundButton.mouseenter((function(_this) {
        return function() {
          clearTimeout(hoverTimeout);
          return $soundBarWrap.addClass('-visible');
        };
      })(this));
      $soundBarHoverArea.mouseenter(function() {
        isSoundBarHover = true;
        return clearTimeout(hoverTimeout);
      });
      $soundBarHoverArea.add(this.soundButton).mouseleave((function(_this) {
        return function() {
          isSoundBarHover = false;
          if (dragging) {
            return;
          }
          return hoverTimeout = setTimeout(function() {
            return $soundBarWrap.removeClass('-visible');
          }, 400);
        };
      })(this));
      setSlider = (function(_this) {
        return function(e) {
          var maxWidth, minWidth, percent, val;
          maxWidth = $soundBarWrap.width();
          minWidth = 0;
          val = e.pageX - _this.soundBar.offset().left;
          if (helpers.Location.isFullScreen()) {
            val = val / 2;
          }
          if (val > maxWidth) {
            val = maxWidth;
          }
          if (val < minWidth) {
            val = minWidth;
          }
          percent = (val - minWidth) / (maxWidth - minWidth);
          return _this.player.setSoundLevel(percent);
        };
      })(this);
      return $soundBarWrap.on('mousedown', (function(_this) {
        return function(e) {
          var dragTimeout;
          if (e.which !== 1) {
            return;
          }
          setSlider(e);
          dragTimeout = setTimeout(function() {
            dragging = true;
            $('body').addClass('-no-select');
            return _this.soundBar.addClass('-drag');
          }, 100);
          return $(document).on('mousemove', setSlider).one('mouseup', function() {
            clearTimeout(dragTimeout);
            dragging = false;
            $('body').removeClass('-no-select');
            $(document).off('mousemove', setSlider);
            _this.soundBar.removeClass('-drag');
            if (!isSoundBarHover) {
              return $soundBarWrap.removeClass('-visible');
            }
          });
        };
      })(this));
    };

    UI.prototype.initSettingsDropdown = function() {
      var open;
      this.isSettingsDropdownOpened = false;
      open = (function(_this) {
        return function() {
          var bottom, h;
          _this.isSettingsDropdownOpened = true;
          _this.settingsContent.removeClass('-hidden');
          if (!GlobalState.PAGE.isEmbed()) {
            bottom = parseInt(_this.settingsContent.css("bottom"));
            h = _this.height - bottom - 12;
            _this.settingsContent.css({
              "max-height": h + "px"
            }).nice_scroller({
              forceInit: true
            });
          }
          _this.settingsHandler.attr('inactive', true).addClass('-hover').trigger(Prompt.ACTION_HIDE);
          _this.changerButtons.add(_this.viewerClick).addClass('disabled');
          return $(document).on('click', _this.onOutsideClick);
        };
      })(this);
      return this.settingsHandler.on('click', (function(_this) {
        return function(e) {
          e.stopPropagation();
          if (_this.isSettingsDropdownOpened) {
            return _this.closeSettingsDropdown();
          } else {
            return open();
          }
        };
      })(this));
    };

    UI.prototype.onOutsideClick = function(e) {
      var target;
      target = $(e.target);
      if (!this.isSettingsDropdownOpened) {
        return;
      }
      if (!target.closest('.viewer__settings-content').length || target.closest('[dropdown-close]').length) {
        return this.closeSettingsDropdown();
      }
    };

    UI.prototype.closeSettingsDropdown = function() {
      if (!this.isSettingsDropdownOpened) {
        return;
      }
      this.isSettingsDropdownOpened = false;
      this.settingsContent.addClass('-hidden');
      this.settingsHandler.removeAttr('inactive').removeClass('-hover');
      this.changerButtons.add(this.viewerClick).removeClass('disabled');
      return $(document).off('click', this.onOutsideClick);
    };

    UI.prototype.initSharingScreen = function() {
      var input;
      if (this.isSharingScreenInitialized || this.sharingControlsHidden) {
        return;
      }
      window.CustomSharingButton.constructIn(this.sharingLayer);
      input = $('input', this.sharingLayer);
      input.click(function(e) {
        return _.defer((function(_this) {
          return function() {
            e.stopPropagation();
            _this.focus();
            return _this.setSelectionRange(0, _this.value.length);
          };
        })(this));
      });
      input.trigger('click');
      $('.viewer__sharing__item a.other', this.sharingLayer).click((function(_this) {
        return function(e) {
          if (GlobalState.PAGE.isCoubPage()) {
            e.preventDefault();
            if (helpers.Location.isFullScreen()) {
              _this.toggleFullScreen();
            }
            return _this.vb.parents('[coub-block].coub').find('.coub__sharing .coub__sharing__dropdown .dropdown__handler .sb').trigger('click');
          }
        };
      })(this));
      return this.isSharingScreenInitialized = true;
    };

    UI.prototype.initCopyLink = function() {
      var changeText, copiedIcon, copyIcon, textArea, textChangeId, textToCopy;
      textToCopy = this.copyLinkButton.attr('data-text');
      textArea = $("<textarea>" + textToCopy + "</textarea>");
      textChangeId = null;
      copyIcon = $("> i", this.settingsCopyLinkButton).first();
      copiedIcon = $("> i", this.settingsCopyLinkButton).last();
      changeText = (function(_this) {
        return function(newText) {
          _this.copyLinkButton.trigger({
            type: Prompt.EVENT_CHANGE_TEXT,
            content: newText
          });
          $("> span", _this.settingsCopyLinkButton).text(newText);
          return $("> span", _this.sharingCopyLinkButton).text(newText);
        };
      })(this);
      return this.copyLinkButton.add(this.settingsCopyLinkButton).add(this.sharingCopyLinkButton).click((function(_this) {
        return function(e) {
          var newText;
          textArea.appendTo(_this.vb).select();
          newText = document.execCommand('copy') ? I18n.embed.copy_link.copied : I18n.embed.copy_link.failed_to_copy;
          changeText(newText);
          copyIcon.addClass("-hidden");
          copiedIcon.removeClass("-hidden");
          _this.sharingCopyLinkButton.add(_this.copyLinkButton).addClass('done');
          textArea.detach();
          clearTimeout(textChangeId);
          return textChangeId = setTimeout(function() {
            changeText(I18n.embed.copy_link.copy);
            _this.sharingCopyLinkButton.add(_this.copyLinkButton).removeClass('done');
            copyIcon.removeClass("-hidden");
            return copiedIcon.addClass("-hidden");
          }, 1000);
        };
      })(this));
    };

    UI.prototype.initSuggests = function() {
      this.suggests || (this.suggests = new html5Player.Suggests(this.suggestsLayer));
      return this.suggests.resize();
    };

    UI.prototype.checkAdblockSocialMedia = function() {
      if (this.sharingItems.css('display') === 'none') {
        this.hideSharingControls();
        return this.copyLinkButton.addClass('-sharing-replace');
      }
    };

    UI.prototype.setSizes = function() {
      this.vb.removeClass('-horizontal -vertical');
      if (this.vb.hasClass('-fullscreen')) {
        if (this.ratio < window.innerHeight / window.innerWidth) {
          this.vb.addClass('-horizontal');
        } else {
          this.vb.addClass('-vertical');
        }
      }
      this.width = this.vb.width();
      this.height = this.vb.height();
      if (helpers.Location.isFullScreen() && this.poster.length) {
        this.fullscreenLogo.css({
          left: this.poster.position().left + 50,
          top: this.poster.position().top + 30
        });
      }
      this.suggests && this.suggests.resize();
      this.player.adManager && this.player.adManager.resize();
      return this.resizeUI();
    };

    UI.prototype.resizeUI = function() {
      var isX2;
      isX2 = this.width >= 440 && this.height >= 130;
      return this.vb.toggleClass('x2', isX2).toggleClass('-h-lt-250', this.height < 250).toggleClass('-h-lt-190', this.height < 190).toggleClass('-h-lt-160', this.height < 160).toggleClass('-h-lt-130', this.height < 130).toggleClass('-w-lt-415', this.width < 415).toggleClass('-w-lt-300', this.width < 300).toggleClass('-w-lt-225', this.width < 225).toggleClass('-w-lt-200', this.width < 200).toggleClass('-w-lt-175', this.width < 175).toggleClass('-w-lt-140', this.width < 140).toggleClass('-w-lt-110', this.width < 110);
    };

    UI.prototype.isVisible = function() {
      return this.poster.is(":visible");
    };

    UI.prototype.framesProgress = function(progress) {
      if (progress === 1) {
        return this.spinner.addClass('-hidden');
      }
    };

    UI.prototype.setFullScreenElement = function(el) {
      return this.fullScreenElement = el;
    };

    UI.prototype.toggleFullScreen = function() {
      var isFullScreen;
      isFullScreen = helpers.Location.isFullScreen();
      if (!isFullScreen) {
        this.savedScroll = $(window).scrollTop();
        $(document).on("fullscreenchange", this.restoreScrollAfterFullscreen);
      }
      (this.fullScreenElement || this.vb).fullScreen(!isFullScreen);
      return !isFullScreen;
    };

    UI.prototype.fullScreenHandler = function() {
      var isFullScreen;
      isFullScreen = helpers.Location.isFullScreen();
      this.vb.toggleClass('-fullscreen', isFullScreen);
      this.fullScreenButton.toggleClass('-on', isFullScreen).trigger({
        type: Prompt.EVENT_CHANGE_TEXT,
        content: I18n.embed.tooltips["fullscreen_" + (isFullScreen && "off" || "on")]
      });
      return this.setSizes();
    };

    UI.prototype.restoreScrollAfterFullscreen = function() {
      if (helpers.Location.isFullScreen()) {
        return;
      }
      $(document).off("fullscreenchange", this.restoreScrollAfterFullscreen);
      return $(window).scrollTop(this.savedScroll);
    };

    UI.prototype.setQuality = function(isHD) {
      return this.hdButton.add(this.settingsHandler).toggleClass('-sd', !isHD);
    };

    UI.prototype.setMuteState = function(isMuted) {
      return this.soundButton.toggleClass('-has-sound', !isMuted);
    };

    UI.prototype.setSoundLevel = function(val) {
      this.setMuteState(!val);
      return this.soundBar.width(val * 100 + '%');
    };

    UI.prototype.toggleFavouritesState = function(value) {
      value = Boolean(value);
      return this.favouritesButton.toggleClass('-added', value).trigger({
        type: Prompt.EVENT_CHANGE_TEXT,
        content: I18n.embed.tooltips["favourites_" + (value && "remove" || "add")]
      });
    };

    UI.prototype.setAhmadPromoQuote = function(data) {
      var content;
      content = $(this.getAhmadPromoContent(data.quote, data.source));
      return $('canvas', this.vb).after(content);
    };

    UI.prototype.getAhmadPromoContent = function(quote, artist) {
      return "<div class=\"-ahmad-promo-quote-container " + (this.isEmbed ? '-embed' : '') + "\">\n  <div class=\"-ahmad-promo-quote\">" + quote + "</div>\n  <div class=\"-ahmad-promo-artist\">— " + artist + "</div>\n</div>";
    };

    UI.prototype.hideControlsPermanently = function() {
      return this.controlsContainer.addClass('-force-hidden');
    };

    UI.prototype.hideControls = function() {
      return this.controlsContainer.addClass('-hidden');
    };

    UI.prototype.showControls = function() {
      return this.controlsContainer.removeClass('-hidden');
    };

    UI.prototype.hideFinger = function() {
      return this.fingerButton.addClass('-force-hidden');
    };

    UI.prototype.showFinger = function() {
      return this.fingerButton.removeClass('-force-hidden');
    };

    UI.prototype.hideSoundControls = function() {
      this.soundBar.parent().addClass("viewer__sound__bar--hidden");
      return this.soundButton.addClass('-force-hidden');
    };

    UI.prototype.hideSharingControls = function() {
      this.sharingControlsHidden = true;
      return this.sharingItems.add(this.shareButton).addClass('-force-hidden');
    };

    UI.prototype.hideHDControls = function() {
      this.hdButton.addClass('-force-hidden');
      return this.settingsHandler.addClass('-sd');
    };

    UI.prototype.hideFullScreenControls = function() {
      return this.fullScreenButton.addClass('-force-hidden');
    };

    UI.prototype.fadeInfoBlocks = function(val) {
      return this.infoBlock.toggleClass('-faded', val);
    };

    UI.prototype.blackScreenAnimation = function(onComplete) {
      this.blackScreen.removeClass('-hidden');
      this.poster.addClass('-hidden');
      clearTimeout(this.blackScreenTimeoutId);
      return this.blackScreenTimeoutId = setTimeout((function(_this) {
        return function() {
          _this.blackScreen.addClass('-hidden');
          _this.poster.removeClass('-hidden');
          return onComplete();
        };
      })(this), 300);
    };

    UI.prototype.setView = function(view) {
      this.view = view;
      this.vb.removeClass(_.values(this.viewCls).join(" ")).addClass(this.viewCls[view]);
      this.fingerButton.removeClass('disabled');
      this.sharingLayer.add(this.suggestsLayer).add(this.spinner).add(this.fingerButton).add(this.mobileMark).add(this.copyLinkButton).add(this.muteOverlay).add(this.fullScreenButton).add(this.shareButton).add(this.playControls).add(this.soundButton).add(this.replayButton).add(this.infoBlock).add(this.adsBlock).add(this.settingsHandler).add(this.favouritesButton).addClass('-hidden');
      switch (view) {
        case this.VIEW.UNLOADED:
          this.closeSettingsDropdown();
          return this.mobileMark.add(this.fingerButton).add(this.infoBlock).add(this.copyLinkButton).add(this.fullScreenButton).add(this.shareButton).add(this.favouritesButton).removeClass('-hidden');
        case this.VIEW.LOADING:
          return this.mobileMark.add(this.fullScreenButton).add(this.shareButton).add(this.favouritesButton).add(this.spinner).add(this.copyLinkButton).add(this.playControls).add(this.soundButton).add(this.infoBlock).add(this.adsBlock).add(this.settingsHandler).removeClass('-hidden');
        case this.VIEW.PLAYING:
          return this.mobileMark.add(this.fullScreenButton).add(this.shareButton).add(this.favouritesButton).add(this.playControls).add(this.soundButton).add(this.copyLinkButton).add(this.infoBlock).add(this.adsBlock).add(this.settingsHandler).removeClass('-hidden');
        case this.VIEW.AUTOPLAY_MUTED:
          this.fullScreenButton.add(this.copyLinkButton).add(this.muteOverlay).add(this.favouritesButton).removeClass('-hidden');
          return setTimeout((function(_this) {
            return function() {
              return _this.muteOverlay.addClass('-hide');
            };
          })(this), 3000);
        case this.VIEW.BROWSER_MUTED:
          return this.fingerButton.removeClass('-hidden');
        case this.VIEW.SUSPENDED:
          this.closeSettingsDropdown();
          return this.mobileMark.add(this.fullScreenButton).add(this.shareButton).add(this.favouritesButton).add(this.playControls).add(this.soundButton).add(this.copyLinkButton).removeClass('-hidden');
        case this.VIEW.SHARING:
          this.sharingLayer.add(this.mobileMark).add(this.fullScreenButton).add(this.shareButton).add(this.infoBlock).add(this.favouritesButton).add(this.playControls).add(this.soundButton).add(this.settingsHandler).add(this.replayButton).removeClass('-hidden');
          return this.initSharingScreen();
        case this.VIEW.UNLOADED_SHARING:
          this.sharingLayer.add(this.mobileMark).add(this.fullScreenButton).add(this.shareButton).add(this.infoBlock).add(this.favouritesButton).removeClass('-hidden');
          return this.initSharingScreen();
        case this.VIEW.DISABLED:
          this.mobileMark.add(this.fingerButton).removeClass('-hidden');
          return this.fingerButton.addClass('disabled');
        case this.VIEW.SUGGESTS:
          this.suggestsLayer.add(this.playControls).add(this.replayButton).add(this.soundButton).add(this.favouritesButton).add(this.fullScreenButton).add(this.settingsHandler).add(this.shareButton).removeClass('-hidden');
          return this.initSuggests();
        case this.VIEW.EMPTY:
          return null;
      }
    };

    return UI;

  })();

}).call(this);
(function() {
  html5Player.VideoCore = (function() {
    function VideoCore(player, videoData, isHD) {
      this.isHD = isHD;
      new utils.ObservableMixin(this);
      this.player = player;
      this.videoData = videoData;
    }

    VideoCore.prototype.reinit = function(videoData, isHD) {
      var i, len, m, ref, ref1, ref2, ref3;
      this.isHD = isHD;
      ref = [this.audioMedia, this.videoMedia];
      for (i = 0, len = ref.length; i < len; i++) {
        m = ref[i];
        m && m.destroy();
      }
      ref1 = [], this.videoDefer = ref1[0], this.audioDefer = ref1[1], this.videoMedia = ref1[2], this.audioMedia = ref1[3];
      if (this.audio) {
        ref2 = [], this.audio.onplay = ref2[0], this.audio.ontimeupdate = ref2[1];
      }
      this.video && (this.video.ontimeupdate = null);
      ref3 = [], this.audio = ref3[0], this.video = ref3[1];
      if (videoData != null) {
        return this.videoData = videoData;
      }
    };

    VideoCore.prototype.changeTempo = function(coef) {
      this.audio && (this.audio.playbackRate *= coef);
      return this.video && (this.video.playbackRate *= coef);
    };

    VideoCore.prototype.resetTempo = function() {
      this.audio && (this.audio.playbackRate = 1);
      return this.video && (this.video.playbackRate = 1);
    };

    VideoCore.prototype.setSoundLevel = function(val) {
      if (!this.audio) {
        return;
      }
      return this.audio.volume = val;
    };

    VideoCore.prototype.setMuteState = function(val) {
      if (!this.audio) {
        return;
      }
      return this.audio.muted = !!val;
    };

    VideoCore.prototype.rewind = function() {
      this.video && (this.video.currentTime = 0);
      return this.audio && (this.audio.currentTime = 0);
    };

    VideoCore.prototype.preloadFrames = function() {
      var $video, prevRatio;
      if (!this.videoDefer) {
        this.videoMedia = new html5Player.MediaElementStrategy('video', this.isHD);
        $video = this.videoMedia.el;
        $video.prependTo(this.player.ui.playerContainer);
        if (!GlobalState.BROWSER.isSafari()) {
          $video.attr('poster', this.player.ui.poster.attr('src'));
        }
        $video.on('stalled ended', (function(_this) {
          return function() {
            if (_this.video.buffered.length > 0 && _this.video.buffered.end(0) === _this.video.duration) {
              return;
            }
            _this.audio && _this.audio.pause();
            _this.video.pause();
            return _this.trigger('buffering');
          };
        })(this));
        this.video = $video.get(0);
        this.videoDefer = this.videoMedia.setSrc(this.videoData.videoUrl, this.videoData.videoSize);
        if (this.player.opts.withLoopEvent) {
          prevRatio = 0;
          this.video.ontimeupdate = (function(_this) {
            return function() {
              var ratio;
              ratio = _this.video.currentTime / _this.videoData.duration;
              if (ratio < prevRatio) {
                _this.notifyAboutLoop();
              }
              return prevRatio = ratio;
            };
          })(this);
        }
        this.logMediaErrors(this.videoDefer, 'video');
      }
      return this.videoDefer;
    };

    VideoCore.prototype.preloadAudio = function() {
      var $audio;
      if (!this.audioDefer) {
        this.audioMedia = new html5Player.MediaElementStrategy('audio', this.isHD);
        $audio = this.audioMedia.el;
        $audio.on('ended', (function(_this) {
          return function() {
            _this.audio.ontimeupdate = function() {
              _this.sync();
              return _this.audio.ontimeupdate = null;
            };
            _this.audio.play();
            return _this.notifyAboutAudioTrackEnd();
          };
        })(this));
        $audio.appendTo(this.player.vb);
        this.audio = $audio.get(0);
        this.audioDefer = this.audioMedia.setSrc(this.videoData.audioUrl, this.videoData.audioSize);
        this.logMediaErrors(this.audioDefer, 'audio');
      }
      return this.audioDefer;
    };

    VideoCore.prototype.play = function() {
      this.notifyAboutPlay();
      if (this.audio) {
        if (this.videoData.audioSampleDuration) {
          this.video.playbackRate = this.videoData.duration / this.videoData.audioSampleDuration;
        }
        if (!GlobalState.BROWSER.isSafari()) {
          this.audio.onplay = (function(_this) {
            return function(e) {
              _this.kickStartVideo();
              return _this.audio.onplay = null;
            };
          })(this);
        }
        this.audio.ontimeupdate = (function(_this) {
          return function(e) {
            if (e.target.currentTime === 0) {
              _this.sync();
            }
            _this.kickStartVideo();
            return _this.audio.ontimeupdate = null;
          };
        })(this);
        return this.tryStartAudio();
      } else {
        return this.kickStartVideo();
      }
    };

    VideoCore.prototype.pause = function() {
      var ref;
      this.notifyAboutPause();
      if (this.video) {
        this.video.pause();
      }
      if (this.audio) {
        ref = [], this.audio.ontimeupdate = ref[0], this.audio.onplay = ref[1];
        if (GlobalState.BROWSER.isSafari()) {
          return _.defer((function(audio) {
            return audio.pause();
          }), this.audio);
        } else {
          return this.audio.pause();
        }
      }
    };

    VideoCore.prototype.sync = function() {
      if (!this.video || !this.audio) {
        return;
      }
      return this.video.currentTime = Math.round(1000 * this.audio.currentTime) % Math.round(1000 * this.videoData.duration) / 1000;
    };

    VideoCore.prototype.kickStartVideo = function() {
      var promise;
      promise = this.video.play();
      if (!promise || !promise.then) {
        return;
      }
      promise.then((function(_this) {
        return function() {
          if (!_this.video || _this.video.currentTime !== 0) {
            return;
          }
          return _this.video.currentTime = 0.001;
        };
      })(this));
      return promise["catch"]((function(_this) {
        return function() {
          return _this.trigger("browser-video-autoplay-blocked");
        };
      })(this));
    };

    VideoCore.prototype.tryStartAudio = function() {
      var promise;
      promise = this.audio.play();
      if (!promise || !promise.then) {
        return;
      }
      return promise["catch"]((function(_this) {
        return function() {
          _this.trigger("browser-audio-autoplay-blocked");
          return _this.kickStartVideo();
        };
      })(this));
    };

    VideoCore.prototype.logMediaErrors = function(mediaDefer, kind) {
      mediaDefer.play.fail(function(reason) {
        return console.log("[PLAYER]", "core", kind, "play failed", reason);
      });
      return mediaDefer.load.fail(function() {
        return console.log("[PLAYER]", "core", kind, "load failed");
      });
    };

    VideoCore.prototype.notifyAboutReadyState = function() {
      this.player.vb.triggerHandler(Player.EVENT_READY);
      return Stats.track('html5_player_initialized');
    };

    VideoCore.prototype.notifyAboutPlay = function() {
      this.player.vb.triggerHandler(Player.EVENT_PLAYING);
      return Stats.track('html5_player_started');
    };

    VideoCore.prototype.notifyAboutPause = function() {
      this.player.vb.triggerHandler(Player.EVENT_PAUSED);
      return Stats.track('html5_player_pause');
    };

    VideoCore.prototype.notifyAboutAudioTrackEnd = function() {
      return this.player.vb.triggerHandler(Player.EVENT_AUDIO_TRACK_ENDED);
    };

    VideoCore.prototype.notifyAboutLoop = function() {
      return this.player.vb.triggerHandler(Player.LOOP_OCCURED);
    };

    return VideoCore;

  })();

}).call(this);
(function() {
  html5Player.PelmeshkiPromo = (function() {
    function PelmeshkiPromo(playerUi, promoData) {
      var cls;
      cls = "viewer__player__pelmeshki -" + promoData.video;
      this.video = $("<video />", {
        loop: true,
        muted: true,
        "class": cls,
        src: this.getVideoUrl()
      }).get(0);
      $(".viewer__player", playerUi.vb).append(this.video);
    }

    PelmeshkiPromo.prototype.play = function() {
      return this.video.play();
    };

    PelmeshkiPromo.prototype.pause = function() {
      return this.video.pause();
    };

    PelmeshkiPromo.prototype.stop = function() {
      this.video.pause();
      return this.video.currentTime = 0;
    };

    PelmeshkiPromo.prototype.destroy = function() {
      this.video.pause();
      return $(this.video).remove();
    };

    PelmeshkiPromo.prototype.getVideoUrl = function() {
      return "//coubsecureassets-a.akamaihd.net/assets/promo/pelmeshki/dj2-5d4b6f10118446ea53dccd53bece02448673b470278378bc6f8dd7ca94f347ed.webm";
    };

    return PelmeshkiPromo;

  })();

}).call(this);
(function() {
  html5Player.Suggest = (function() {
    function Suggest(opts) {
      this.opts = opts;
      this.el = $(this.getTemplate(this.opts.data));
      this.el.appendTo(this.opts.container);
      this.el.css({
        left: this.opts.x,
        top: this.opts.y,
        width: this.opts.width,
        height: this.opts.height
      });
      this.initVideoHover();
    }

    Suggest.prototype.initVideoHover = function() {
      var v;
      v = $('video', this.el);
      v.one('canplaythrough', (function(_this) {
        return function() {
          return _this.el.addClass('-loaded');
        };
      })(this));
      this.el.on('mouseover', (function(_this) {
        return function() {
          return v.get(0).play();
        };
      })(this));
      return this.el.on('mouseleave', (function(_this) {
        return function() {
          return v.get(0).pause();
        };
      })(this));
    };

    Suggest.prototype.getTemplate = function(data) {
      var fitClass;
      fitClass = data.image_width / data.image_height > this.opts.width / this.opts.height ? '-fit-vertical' : '';
      return "<div class=\"viewer__suggest -ribbon " + fitClass + "\">\n  <img src=" + data.image_url + " />\n  <video src=" + data.video_url + " poster=" + data.image_url + " loop preload=\"none\" />\n  <a href=" + (this.permalinkToCoubUrl(data.permalink)) + " target=\"_blank\" class=\"-fill\"></a>\n</div>";
    };

    Suggest.prototype.permalinkToCoubUrl = function(permalink) {
      return "/view/" + permalink;
    };

    return Suggest;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  html5Player.Suggests = (function() {
    Suggests.prototype.SUGGESTS_PER_PAGE = 42;

    Suggests.prototype.MIN_WIDTH = 300;

    Suggests.prototype.MIN_HEIGHT = 225;

    Suggests.prototype.MARGIN = 12;

    Suggests.prototype.LIMIT_RATIO = 1;

    function Suggests(el) {
      this.el = el;
      this.onButtonsClick = bind(this.onButtonsClick, this);
      this.suggestsPath = this.el.attr('data-suggests-path');
      this.loadIndex = 1;
      this.listIndex = 0;
      this.suggestsData = [];
      this.container = $('.viewer__suggests-stub', this.el);
      this.buttons = $('.viewer__suggests-list-btn', this.el);
      this.init();
    }

    Suggests.prototype.init = function() {
      this.buttons.click(this.onButtonsClick);
      return this.loadSuggests((function(_this) {
        return function() {
          return _this.resize();
        };
      })(this));
    };

    Suggests.prototype.resize = function() {
      var calculateLayout, height, ratio, width;
      if (!this.suggestsData.length) {
        return;
      }
      width = this.container.width();
      height = this.container.height();
      calculateLayout = (function(_this) {
        return function() {
          _this.suggestsCount = _this.columns * _this.rows;
          if (_this.suggestsCount > 0) {
            _this.suggestWidth = Math.round((width - (_this.columns + 1) * _this.MARGIN) / _this.columns);
            return _this.suggestHeight = Math.round((height - _this.rows * _this.MARGIN) / _this.rows);
          }
        };
      })(this);
      this.listIndex = 0;
      this.unlock();
      this.columns = Math.ceil(width / (this.MIN_WIDTH + this.MARGIN));
      this.rows = Math.ceil(height / (this.MIN_HEIGHT + this.MARGIN));
      calculateLayout();
      if (this.suggestsCount > 0) {
        ratio = this.suggestWidth / this.suggestHeight;
        console.log('ratio', ratio);
        if (this.suggestsCount === 1) {
          if (ratio > 2 * this.LIMIT_RATIO) {
            this.columns++;
          } else {
            this.rows++;
          }
          calculateLayout();
        } else if (ratio < this.LIMIT_RATIO) {
          this.rows++;
          calculateLayout();
        }
        return this.render();
      }
    };

    Suggests.prototype.render = function(animationDirection) {
      var i, j, k, l, newPage, oldPage, ref, ref1, suggestData, x, y;
      if (animationDirection == null) {
        animationDirection = 0;
      }
      oldPage = $('.viewer__suggests-page', this.container);
      newPage = $(this.getSuggestsPageTemplate()).appendTo(this.container);
      x = y = this.MARGIN;
      for (j = k = 0, ref = this.rows - 1; 0 <= ref ? k <= ref : k >= ref; j = 0 <= ref ? ++k : --k) {
        for (i = l = 0, ref1 = this.columns - 1; 0 <= ref1 ? l <= ref1 : l >= ref1; i = 0 <= ref1 ? ++l : --l) {
          suggestData = this.suggestsData[this.listIndex * this.suggestsCount + j * this.columns + i];
          if (!suggestData) {
            break;
          }
          new html5Player.Suggest({
            container: newPage,
            x: x,
            y: y,
            width: this.suggestWidth,
            height: this.suggestHeight,
            data: suggestData
          });
          x += this.suggestWidth + this.MARGIN;
        }
        x = this.MARGIN;
        y += this.suggestHeight + this.MARGIN;
      }
      if (animationDirection) {
        this.lock();
        if (animationDirection === 1) {
          newPage.addClass('-right');
          this.container.addClass('-to-right');
        } else {
          newPage.addClass('-left');
          this.container.addClass('-to-left');
        }
        this.container.addClass('-animated');
        return setTimeout((function(_this) {
          return function() {
            newPage.removeClass('-right -left');
            _this.container.removeClass('-to-right -to-left -animated');
            oldPage.remove();
            return _this.unlock();
          };
        })(this), 300);
      } else {
        this.unlock();
        return oldPage.remove();
      }
    };

    Suggests.prototype.loadSuggests = function(onLoadComplete) {
      this.lock();
      console.log('load page', this.loadIndex);
      $.ajax({
        url: this.suggestsPath,
        data: {
          page: this.loadIndex,
          count: this.SUGGESTS_PER_PAGE
        },
        error: this.onError,
        success: (function(_this) {
          return function(result) {
            _this.suggestsData = _this.suggestsData.concat(result.coubs);
            return onLoadComplete();
          };
        })(this)
      });
      return this.loadIndex++;
    };

    Suggests.prototype.onButtonsClick = function(e) {
      var direction, target;
      target = $(e.currentTarget);
      if (target.hasClass('-prev')) {
        direction = -1;
        this.listIndex--;
      } else if (target.hasClass('-next')) {
        direction = 1;
        this.listIndex++;
      } else {
        return;
      }
      if ((this.listIndex + 1) * this.suggestsCount >= this.suggestsData.length) {
        return this.loadSuggests((function(_this) {
          return function() {
            return _this.render(direction);
          };
        })(this));
      } else {
        return this.render(direction);
      }
    };

    Suggests.prototype.onError = function(e) {
      return console.log('html5Player Suggests Error', e);
    };

    Suggests.prototype.lock = function() {
      return this.buttons.addClass('disabled');
    };

    Suggests.prototype.unlock = function() {
      this.buttons.removeClass('disabled');
      return this.buttons.filter('.-prev').toggleClass('disabled', this.listIndex === 0);
    };

    Suggests.prototype.getSuggestsPageTemplate = function() {
      return "<div class=\"viewer__suggests-page\"></div>";
    };

    return Suggests;

  })();

}).call(this);
(function() {
  mobilePlayer.CanvasCore = (function() {
    CanvasCore.prototype.NEXT_FRAME_TIMEOUT = 40;

    function CanvasCore(player, videoData) {
      this.player = player;
      this.videoData = videoData;
      this.screen = player.ui.screen.get(0);
      this.ctx = this.screen.getContext('2d');
      this.loopTimeout = -1;
    }

    CanvasCore.prototype.reinit = function() {
      var d, el, i, j, len, len1, ref, ref1, ref2;
      ref = [this.chunksDefer];
      for (i = 0, len = ref.length; i < len; i++) {
        d = ref[i];
        d && d.resolve();
      }
      this.pause();
      ref1 = [this.video];
      for (j = 0, len1 = ref1.length; j < len1; j++) {
        el = ref1[j];
        $(el).attr('src', '');
        el && el.load();
        $(el).remove();
      }
      return ref2 = [], this.chunksDefer = ref2[0], this.sharedAudio = ref2[1], this.video = ref2[2], ref2;
    };

    CanvasCore.prototype.preloadFrames = function() {
      var $video;
      if (this.chunksDefer == null) {
        $video = $("<video preload='auto' muted src='" + this.videoData.video + "' />").appendTo($('.data', this.player.vb));
        this.video = $video.get(0);
        this.chunksDefer = $.Deferred();
        $video.on('canplay', (function(_this) {
          return function() {
            _this.screen.width = _this.video.videoWidth;
            _this.screen.height = _this.video.videoHeight;
            _this.chunksDefer.notify(1);
            return _this.chunksDefer.resolve();
          };
        })(this));
        this.video.load();
      }
      return this.chunksDefer.promise();
    };

    CanvasCore.prototype.loadAudio = function() {
      this.sharedAudio || (this.sharedAudio = new mobilePlayer.SharedAudio(this.videoData.audio));
      return this.sharedAudio.load();
    };

    CanvasCore.prototype.drawFrame = function() {
      return this.ctx.drawImage(this.video, 0, 0, this.screen.width, this.screen.height);
    };

    CanvasCore.prototype.playSimpleLoop = function() {
      var playLoop;
      this.notifyAboutPlay();
      playLoop = (function(_this) {
        return function() {
          var newTime;
          newTime = _this.video.currentTime + (Date.now() - _this.lastDraw) / 1000;
          _this.video.currentTime = newTime <= _this.videoData.duration ? newTime : newTime - _this.videoData.duration;
          _this.drawFrame();
          _this.lastDraw = Date.now();
          return _this.loopTimeout = setTimeout(playLoop, _this.NEXT_FRAME_TIMEOUT);
        };
      })(this);
      this.lastDraw = Date.now();
      return playLoop();
    };

    CanvasCore.prototype.playAudioSyncLoop = function() {
      var playLoop;
      this.notifyAboutPlay();
      this.sharedAudio || (this.sharedAudio = new mobilePlayer.SharedAudio(this.videoData.audio));
      playLoop = (function(_this) {
        return function() {
          _this.video.currentTime = Math.round(1000 * _this.sharedAudio.getEl().currentTime) % Math.round(1000 * _this.videoData.duration) / 1000;
          _this.drawFrame();
          return _this.loopTimeout = setTimeout(playLoop, _this.NEXT_FRAME_TIMEOUT);
        };
      })(this);
      this.sharedAudio.play();
      return playLoop();
    };

    CanvasCore.prototype.rewind = function() {
      clearTimeout(this.loopTimeout);
      this.video.currentTime = 0;
      return this.drawFrame();
    };

    CanvasCore.prototype.pause = function() {
      this.notifyAboutPause();
      clearTimeout(this.loopTimeout);
      return this.sharedAudio && this.sharedAudio.pause();
    };

    CanvasCore.prototype.toggleMute = function(val) {
      return this.sharedAudio && this.sharedAudio.toggleMute(val);
    };

    CanvasCore.prototype.notifyAboutReadyState = function() {
      return this.player.vb.triggerHandler(Player.EVENT_READY);
    };

    CanvasCore.prototype.notifyAboutPlay = function() {
      if (this.player.isAutoplay) {
        AmplitudeMobile.trackOnce('started');
      }
      return this.player.vb.triggerHandler(Player.EVENT_PLAYING);
    };

    CanvasCore.prototype.notifyAboutPause = function() {
      return this.player.vb.triggerHandler(Player.EVENT_PAUSED);
    };

    return CanvasCore;

  })();

}).call(this);
(function() {
  mobilePlayer.UI = (function() {
    UI.prototype.VIEW = {
      UNLOADED: 0,
      LOADING: 1,
      SUSPENDED: 2,
      PAUSED: 3,
      DISABLED: 4,
      PLAYING: 5,
      PLAYING_MUTED: 6,
      PAUSED_COPY_LINK: 7
    };

    UI.prototype.ACTION_RESIZE = "mobileplayer-UI:Actions:Resize";

    function UI(player, isEmbed) {
      this.player = player;
      this.isEmbed = isEmbed;
      this.vb = this.player.vb;
      this.playerContainer = $('.viewer__player:first', this.vb);
      this.poster = $('img.viewer__img:first', this.vb);
      this.controlsContainer = $('.viewer__controls__container:first', this.vb);
      this.viewerControls = $('.viewer__controls', this.vb).removeClass('-hidden');
      this.pauseLayer = $('.viewer__pause:first', this.controlsContainer);
      this.copyLayer = $('.viewer__copy:first', this.controlsContainer);
      this.linkButton = $('.viewer__share__social.copy:first', this.controlsContainer);
      this.loadingBar = $('.viewer__progress:first', this.controlsContainer);
      this.imagesContainer = $('.images:first', this.loadingBar);
      this.screen = $('.viewer__screen:first', this.playerContainer).removeClass('-hidden');
      this.muteButton = $('.viewer__mute:first', this.controlsContainer);
      this.fingerButton = $('.viewer__hand:first', this.controlsContainer).removeClass('-hidden');
      this.playButton = $('.viewer__play__mobile:first', this.controlsContainer);
      this.shareButton = $('.viewer__share__mobile:first', this.controlsContainer);
      this.stamp = $('.viewer__stamp:first', this.controlsContainer);
      this.mobileMark = $('.viewer__site-logo:first', this.controlsContainer);
      this.changerButtons = $('.viewer__coubs-changer', this.controlsContainer);
      this.toAppPause = $('.viewer__pause__open-in-app', this.controlsContainer);
      this.toApp = $('.viewer__open-in-app', this.controlsContainer);
      this.getApp = $('.viewer__get-app', this.controlsContainer);
      this.coubLink = $('.viewer__coub-link', this.controlsContainer);
      this.vb.on(this.ACTION_RESIZE, this.setSizes.bind(this));
    }

    UI.prototype.init = function() {
      this.setSizes();
      this.poster.on('load', this.setSizes.bind(this));
      this.mobileMark.click(function() {
        return AmplitudeMobile.track('logo_clicked');
      });
      $('.viewer__pause__play', this.vb).click(function() {
        return AmplitudeMobile.track('pause_button_clicked');
      });
      return this.initOpenInApp();
    };

    UI.prototype.initPauseScreen = function() {
      var $shares;
      if (this.isPauseScreenInitialized) {
        return;
      }
      $shares = $('.viewer__share__social', this.pauseLayer);
      if (helpers.Location.isVkontakteEmbed()) {
        $shares.not('.copy').remove();
      } else {
        if (!GlobalState.PLATFORM.isMobile()) {
          $shares.filter('.watsapp, .messenger').remove();
        }
        window.CustomSharingButton.constructIn(this.pauseLayer);
      }
      $shares.filter('.social').click(function() {
        return AmplitudeMobile.track('sharing_clicked', {
          to: this.getAttribute('data-custom-sharing')
        });
      });
      this.linkButton.click((function(_this) {
        return function() {
          return _this.setView(_this.VIEW.PAUSED_COPY_LINK);
        };
      })(this));
      $('input', this.copyLayer).click(function(e) {
        e.stopPropagation();
        return this.setSelectionRange(0, this.value.length);
      });
      return this.isPauseScreenInitialized = true;
    };

    UI.prototype.initOpenInApp = function() {
      return widgets.AppLink.constructIn(this.controlsContainer);
    };

    UI.prototype.hideToApp = function() {
      return this.toAppPause.add(this.toApp).add(this.getApp).addClass('-force-hidden');
    };

    UI.prototype.setSizes = function() {
      this.width = this.poster.width();
      this.height = this.poster.height();
      return this.screen.css({
        width: this.width,
        height: this.height
      });
    };

    UI.prototype.isVisible = function() {
      return this.poster.is(":visible");
    };

    UI.prototype.loadingProgress = function(progress) {
      this.loadingBar.removeClass("-hidden -progress10 -progress50");
      if (progress <= 0.1) {
        this.loadingBar.addClass("-progress10");
      } else if (progress <= 0.5) {
        this.loadingBar.addClass("-progress50");
      }
      if (progress === 1) {
        return this.loadingBar.addClass('-hidden');
      }
    };

    UI.prototype.setAhmadPromoQuote = function(data) {
      var content;
      content = $(this.getAhmadPromoContent(data.quote, data.source));
      return $('canvas', this.vb).after(content);
    };

    UI.prototype.getAhmadPromoContent = function(quote, artist) {
      return "<div class=\"-ahmad-promo-quote-container\">\n  <div class=\"-ahmad-promo-quote\">" + quote + "</div>\n  <div class=\"-ahmad-promo-artist\">— " + artist + "</div>\n</div>";
    };

    UI.prototype.hideFinger = function() {
      return this.fingerButton.addClass('-force-hidden');
    };

    UI.prototype.hideControlsPermanently = function(keepHand) {
      if (keepHand) {
        return this.controlsContainer.children().not('.viewer__hand').addClass('-force-hidden');
      } else {
        return this.controlsContainer.addClass('-force-hidden');
      }
    };

    UI.prototype.audioFailed = function() {
      return this.muteButton.removeClass('-fill').addClass('-failed').find('> i:first').attr({
        'data-prompt': I18n.embed.tooltips.audio_failed,
        'data-prompt-class': 'hbold',
        'direction': 'below',
        'constraint': 'right'
      }).prompt();
    };

    UI.prototype.setView = function(view) {
      this.pauseLayer.add(this.copyLayer).add(this.toApp).add(this.getApp).add(this.coubLink).add(this.toAppPause).add(this.fingerButton).add(this.mobileMark).add(this.muteButton).add(this.shareButton).add(this.playButton).add(this.loadingBar).add(this.stamp).add(this.changerButtons).addClass('-hidden');
      this.fingerButton.removeClass('disabled');
      this.mobileMark.removeClass('-blue');
      this.getApp.removeClass('-bottom');
      switch (view) {
        case this.VIEW.UNLOADED:
          this.mobileMark.add(this.fingerButton).add(this.shareButton).removeClass('-hidden');
          return this.getApp.addClass('-bottom');
        case this.VIEW.LOADING:
          return this.mobileMark.add(this.loadingBar).add(this.shareButton).removeClass('-hidden');
        case this.VIEW.PLAYING:
          return this.mobileMark.removeClass('-hidden');
        case this.VIEW.PLAYING_MUTED:
          return this.muteButton.add(this.mobileMark).add(this.shareButton).removeClass('-hidden');
        case this.VIEW.SUSPENDED:
          this.mobileMark.add(this.shareButton).add(this.playButton).removeClass('-hidden');
          return this.muteButton.toggleClass('-hidden', this.player.isAudioPreloaded);
        case this.VIEW.PAUSED:
          this.pauseLayer.add(this.toApp).add(this.getApp).add(this.mobileMark).add(this.stamp).removeClass('-hidden');
          this.mobileMark.addClass('-blue');
          return this.initPauseScreen();
        case this.VIEW.PAUSED_COPY_LINK:
          this.copyLayer.add(this.toApp).add(this.getApp).add(this.mobileMark).add(this.stamp).removeClass('-hidden');
          this.mobileMark.addClass('-blue');
          return this.initPauseScreen();
        case this.VIEW.DISABLED:
          this.mobileMark.add(this.fingerButton).add(this.shareButton).removeClass('-hidden');
          return this.fingerButton.addClass('disabled');
      }
    };

    return UI;

  })();

}).call(this);
(function() {
  mobilePlayer.VideoCore = (function() {
    function VideoCore(player, videoData) {
      this.player = player;
      this.videoData = videoData;
    }

    VideoCore.prototype.reinit = function() {
      var d, el, i, j, len, len1, ref, ref1, ref2;
      ref = [this.chunksDefer];
      for (i = 0, len = ref.length; i < len; i++) {
        d = ref[i];
        d && d.resolve();
      }
      this.pause();
      ref1 = [this.video];
      for (j = 0, len1 = ref1.length; j < len1; j++) {
        el = ref1[j];
        $(el).attr('src', '');
        el && el.load();
        $(el).remove();
      }
      return ref2 = [], this.chunksDefer = ref2[0], this.sharedAudio = ref2[1], this.video = ref2[2], ref2;
    };

    VideoCore.prototype.preloadFrames = function() {
      var $video, promise;
      if (this.chunksDefer == null) {
        $video = $("<video preload='auto' muted src='" + this.videoData.video + "' loop />");
        $video.prependTo(this.player.ui.playerContainer);
        this.video = $video.get(0);
        this.chunksDefer = $.Deferred();
        $video.one("canplaythrough", (function(_this) {
          return function() {
            _this.video.pause();
            _this.video.currentTime = 0;
            $video.css("visibility", "");
            _this.chunksDefer.notify(1);
            return _this.chunksDefer.resolve();
          };
        })(this));
        $video.css("visibility", "hidden");
        promise = this.video.play();
      }
      return this.chunksDefer.promise();
    };

    VideoCore.prototype.loadAudio = function() {
      this.sharedAudio || (this.sharedAudio = new mobilePlayer.SharedAudio(this.videoData.audio));
      return this.sharedAudio.load();
    };

    VideoCore.prototype.playSimpleLoop = function() {
      this.notifyAboutPlay();
      return this.video.play();
    };

    VideoCore.prototype.playAudioSyncLoop = function() {
      this.notifyAboutPlay();
      this.sharedAudio || (this.sharedAudio = new mobilePlayer.SharedAudio(this.videoData.audio));
      this.video.play();
      return this.sharedAudio.play().done(this.sync.bind(this));
    };

    VideoCore.prototype.rewind = function() {
      return this.video.currentTime = 0;
    };

    VideoCore.prototype.pause = function() {
      this.notifyAboutPause();
      this.video && this.video.pause();
      return this.sharedAudio && this.sharedAudio.pause();
    };

    VideoCore.prototype.sync = function() {
      return this.video.currentTime = Math.round(1000 * this.sharedAudio.getEl().currentTime) % Math.round(1000 * this.videoData.duration) / 1000;
    };

    VideoCore.prototype.toggleMute = function(val) {
      return this.sharedAudio && this.sharedAudio.toggleMute(val);
    };

    VideoCore.prototype.notifyAboutReadyState = function() {
      return this.player.vb.triggerHandler(Player.EVENT_READY);
    };

    VideoCore.prototype.notifyAboutPlay = function() {
      if (this.player.isAutoplay) {
        AmplitudeMobile.trackOnce("started");
      }
      return this.player.vb.triggerHandler(Player.EVENT_PLAYING);
    };

    VideoCore.prototype.notifyAboutPause = function() {
      return this.player.vb.triggerHandler(Player.EVENT_PAUSED);
    };

    return VideoCore;

  })();

}).call(this);
(function() {
  mobilePlayer.SharedAudio = (function() {
    function SharedAudio(sources) {
      this.sharedElement = mobilePlayer.SharedAudioElement.init();
      this.sources = sources;
      this.muted = false;
    }

    SharedAudio.prototype.getEl = function(jqEl) {
      var $audioEl;
      $audioEl = this.sharedElement.getEl();
      return jqEl && $audioEl || $audioEl[0];
    };

    SharedAudio.prototype.isCurrent = function() {
      return this.sources === this.sharedElement.getSources();
    };

    SharedAudio.prototype.toggleMute = function(val) {
      return this.muted = !!val;
    };

    SharedAudio.prototype.load = function() {
      this.sharedElement.setSrc(this.sources);
      this.getEl().muted = true;
      return this.sharedElement.play();
    };

    SharedAudio.prototype.play = function() {
      if (!this.isCurrent()) {
        return this.load().done((function(_this) {
          return function() {
            return _this.getEl().muted = _this.muted;
          };
        })(this));
      } else {
        this.getEl().muted = this.muted;
        return this.sharedElement.play();
      }
    };

    SharedAudio.prototype.pause = function() {
      if (!this.isCurrent()) {
        return;
      }
      return this.getEl().pause();
    };

    return SharedAudio;

  })();

}).call(this);
(function() {
  mobilePlayer.SharedAudioElement = {
    init: function() {
      this.el || (this.el = $('<audio loop preload="metadata" />').appendTo("body"));
      return this;
    },
    getEl: function() {
      return this.el;
    },
    getSources: function() {
      return this.sources;
    },
    setSrc: function(sources) {
      var i, len, versionUrl;
      this.sources = sources;
      this.canPlayFired = false;
      this.el.off().empty();
      for (i = 0, len = sources.length; i < len; i++) {
        versionUrl = sources[i];
        $("<source />", {
          src: versionUrl
        }).appendTo(this.el);
      }
      this.el[0].load();
      this.el.on("pause", function(e) {
        if (!this.ended) {
          return;
        }
        return _.defer(function(audio) {
          if (!audio.ended && audio.paused) {
            return audio.play();
          }
        }, this);
      });
      return this.el.on("ended", function() {
        this.currentTime = 0;
        return this.play();
      });
    },
    play: function() {
      var defer, onPlay;
      defer = $.Deferred();
      this.el.on("progress", function(e) {
        var buffered, total;
        if (this.buffered.length > 0) {
          total = this.duration;
          buffered = this.buffered.end(this.buffered.length - 1);
          return defer.notify(buffered / total);
        } else {
          return defer.notify(0);
        }
      });
      this.el.on("error", (function(_this) {
        return function() {
          defer.notify(1);
          return defer.reject();
        };
      })(this));
      onPlay = function() {
        defer.notify(1);
        return defer.resolve();
      };
      if (this.canPlayFired) {
        this.el.one("play", onPlay);
      } else {
        this.el.one("canplay", (function(_this) {
          return function() {
            _this.hasTouch = true;
            _this.canPlayFired = true;
            return onPlay();
          };
        })(this));
      }
      this.el.get(0).play();
      return defer.promise();
    },
    allowedToPlay: function() {
      return this.hasTouch || this.initGestureNotRequired;
    },
    testGestureReq: function() {
      var audioEl, playPromise;
      if (!this.gestureDefer) {
        this.gestureDefer = $.Deferred();
        audioEl = $("<audio />", {
          preload: "none",
          src: "data:audio/m4a;base64,Q2FsYW1pbmUgLSBUcmFtcG9saW5lCg=="
        }).get(0);
        playPromise = audioEl.play();
        if (!playPromise || !playPromise["catch"]) {
          return this.gestureDefer.reject().promise();
        }
        playPromise["catch"]((function(_this) {
          return function(e) {
            if (e.name && e.name !== "NotAllowedError") {
              _this.initGestureNotRequired = true;
              return _this.gestureDefer.resolve();
            } else {
              return _this.gestureDefer.reject();
            }
          };
        })(this));
      }
      return this.gestureDefer.promise();
    }
  };

}).call(this);
(function() {
  window.MobilePlayer = (function() {
    MobilePlayer.prototype.STATE = {
      UNLOADED: "unloaded",
      LOADING: "loading",
      PLAYING: "playing",
      PAUSED: "paused"
    };

    MobilePlayer.prototype.DT = "MobilePlayer";

    function MobilePlayer(viewerBlock, opts) {
      var e, jsonStr, videoData;
      if (opts == null) {
        opts = {};
      }
      this.vb = $(viewerBlock).addClass('viewer--mobile');
      this.isEmbed = !!opts.embed;
      this.ui = new mobilePlayer.UI(this, this.isEmbed);
      this.ui.init();
      try {
        this.data = opts.data ? opts.data : (jsonStr = $('.data > script', this.vb).html(), JSON.parse(jsonStr));
      } catch (error) {
        e = error;
        this.ui.setView(mobilePlayer.UI.prototype.VIEW.DISABLED);
        console.log('[HB-DEBUG]', "Something wrong with coub's JSON", {
          context: {
            json: jsonStr
          }
        });
        throw e;
      }
      try {
        this.mobileData = this.data.file_versions.mobile;
      } catch (error) {
        e = error;
        this.ui.setView(mobilePlayer.UI.prototype.VIEW.DISABLED);
        console.log('[HB-DEBUG]', "Can't find mobile data in coub's JSON", {
          context: {
            json: JSON.stringify(this.data)
          }
        });
        throw e;
      }
      try {
        videoData = {
          duration: this.data.duration,
          audio: this.mobileData.audio,
          video: this.mobileData.video
        };
      } catch (error) {
        e = error;
        this.ui.setView(mobilePlayer.UI.prototype.VIEW.DISABLED);
        console.log('[HB-DEBUG]', "Something wrong with base64 chunks", {
          context: {
            mobileData: JSON.stringify(this.mobileData)
          }
        });
        throw e;
      }
      this.changeState(this.STATE.UNLOADED);
      this.ui.setView(mobilePlayer.UI.prototype.VIEW.UNLOADED);
      this.hasAudio = !!videoData.audio;
      this.hasSelfSound = this.hasAudio && this.data.has_sound;
      this.isAudioPreloaded = false;
      AmplitudeMobile.init(this.isEmbed, this.hasSelfSound, this.hasAudio, videoData.duration, 1);
      this.core = GlobalState.PLATFORM.isIos() ? (this.ui.vb.addClass('viewer--ios'), new mobilePlayer.CanvasCore(this, videoData)) : new mobilePlayer.VideoCore(this, videoData);
      if (this.data.ahmad_promo) {
        this.ui.setAhmadPromoQuote(this.data.ahmad_promo);
      }
      this.canAutoplay = !GlobalState.PLATFORM.isVkIpadApp() && (!GlobalState.PLATFORM.isMobile() || GlobalState.PLATFORM.isIos() || this.data.permalink === "4abl");
      this.isAutoplay = this.canAutoplay && !!opts.autoplay;
      this.noControls = !!opts.noControls;
      if (this.noControls) {
        this.ui.hideControlsPermanently(!this.isAutoplay);
      }
      this.isMuted = (this.canAutoplay || this.noControls) && !!opts.muted;
      this.attachEvents();
      if (this.isAutoplay) {
        this.play();
      }
      this.dispatcher = new EmbedDispatcher({
        onStop: (function(_this) {
          return function() {
            if (!_this.isAutoplay || (_this.hasAudio && _this.isAudioPreloaded)) {
              return _this.suspend();
            }
          };
        })(this)
      });
      this.core.notifyAboutReadyState();
      if (this.isEmbed) {
        this.preload();
      }
      if (this.isAdult()) {
        this.ui.hideToApp();
      }
    }

    MobilePlayer.prototype.isAdult = function() {
      return this.data.age_restricted || this.data.age_restricted_by_admin || this.data.not_safe_for_work;
    };

    MobilePlayer.prototype.attachEvents = function() {
      $(document).on('visibilitychange', (function(_this) {
        return function() {
          if (document.hidden) {
            if (_this.state !== _this.STATE.PLAYING) {
              return;
            }
            _this.suspend();
            return _this.browserPaused = true;
          } else if (_this.browserPaused) {
            _this.play();
            return _this.browserPaused = false;
          }
        };
      })(this));
      this.vb.on('click', '.viewer__click', this.togglePlayState.bind(this));
      this.ui.muteButton.click(this.plugInSound.bind(this));
      this.ui.shareButton.click(this.pause.bind(this));
      this.vb.on('play', (function(_this) {
        return function() {
          _this.play();
          return AmplitudeMobile.track('play_triggered');
        };
      })(this));
      this.vb.on('pause', this.pause.bind(this));
      this.vb.on('suspend', this.suspend.bind(this));
      this.vb.on('resize', this.ui.setSizes.bind(this.ui));
      if (this.canAutoplay) {
        this.vb.on('hidefinger', this.ui.hideFinger.bind(this.ui));
      }
      this.vb.on('suspend.player', this.suspend.bind(this));
      this.vb.on('forceplay.player', (function(_this) {
        return function() {
          return _this.play(true);
        };
      })(this));
      this.vb.on('pluginsound.player', this.plugInSound.bind(this));
      this.vb.on('preload.player', this.preload.bind(this));
      return this.vb.on('unembed.player', this.unload.bind(this));
    };

    MobilePlayer.prototype.togglePlayState = function() {
      if (GlobalState.PAGE.isCoubPage()) {
        AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.PLAYER.CENTER_CLICKED);
      }
      if (this.state === this.STATE.LOADING) {
        return;
      }
      if (this.state !== this.STATE.PLAYING) {
        this.userPaused = false;
        this.notifyAboutView();
        if (this.isAudioPreloaded || !this.hasAudio) {
          this.play(true);
        } else {
          this.preloadAllAndPlay();
        }
        return AmplitudeMobile.track('play_clicked');
      } else {
        this.userPaused = true;
        this.pause();
        return AmplitudeMobile.track('pause_clicked');
      }
    };

    MobilePlayer.prototype.plugInSound = function() {
      var ref;
      if (GlobalState.PAGE.isCoubPage()) {
        AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.PLAYER.PLAYER_UNMUTE_CLICKED);
        AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.PLAYER.CENTER_CLICKED);
      }
      if ((ref = this.state) !== this.STATE.PLAYING && ref !== this.STATE.PAUSED) {
        return;
      }
      if (this.isAudioFailed || !this.hasAudio) {
        return;
      }
      if (this.isAudioPreloaded) {
        this.core.rewind();
        this.playWithAudio();
      } else {
        this.core.pause();
        this.preloadAudioAndPlay();
      }
      return AmplitudeMobile.track('unmute_clicked');
    };

    MobilePlayer.prototype.play = function(isUserIntent) {
      if (this.state === this.STATE.PAUSED && !this.userPaused) {
        if (this.hasAudio && this.canPlayAudio()) {
          return this.playWithAudio();
        } else {
          return this.playMuted();
        }
      } else if (this.state === this.STATE.UNLOADED) {
        if (!this.canAutoplay && !isUserIntent) {
          return;
        }
        if (this.hasAudio && !this.isMuted && (this.canPlayAudio() || isUserIntent || !GlobalState.PLATFORM.isMobile())) {
          this.preloadAllAndPlay();
        } else {
          this.preloadFramesAndPlay();
        }
        return this.notifyAboutView();
      }
    };

    MobilePlayer.prototype.pause = function() {
      var ref, ref1;
      if ((ref = this.state) !== this.STATE.PAUSED && ref !== this.STATE.PLAYING && ref !== this.STATE.UNLOADED) {
        return;
      }
      if (GlobalState.PAGE.isCoubPage()) {
        AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.PLAYER.PAUSE_OCCURED);
      }
      if ((ref1 = this.state) === this.STATE.PAUSED || ref1 === this.STATE.PLAYING) {
        this.changeState(this.STATE.PAUSED);
        this.core.pause();
      }
      if (helpers.Location.isVkontakteEmbed()) {
        return this.ui.setView(mobilePlayer.UI.prototype.VIEW.PAUSED_COPY_LINK);
      } else {
        return this.ui.setView(mobilePlayer.UI.prototype.VIEW.PAUSED);
      }
    };

    MobilePlayer.prototype.suspend = function() {
      var ref;
      if ((ref = this.state) !== this.STATE.PLAYING) {
        return;
      }
      this.changeState(this.STATE.PAUSED);
      this.core.pause();
      return this.ui.setView(mobilePlayer.UI.prototype.VIEW.SUSPENDED);
    };

    MobilePlayer.prototype.mute = function() {
      return this.core.toggleMute(true);
    };

    MobilePlayer.prototype.unmute = function() {
      return this.core.toggleMute(false);
    };

    MobilePlayer.prototype.preload = function() {
      if (GlobalState.PLATFORM.isIos()) {
        return this.core.preloadFrames();
      }
    };

    MobilePlayer.prototype.unload = function() {
      var ref;
      if (this.state === this.STATE.UNLOADED) {
        return;
      }
      this.core.reinit();
      this.changeState(this.STATE.UNLOADED);
      ref = [], this.userPaused = ref[0], this.browserPaused = ref[1], this.isAudioPreloaded = ref[2];
      return this.ui.setView(mobilePlayer.UI.prototype.VIEW.UNLOADED);
    };

    MobilePlayer.prototype.preloadFramesAndPlay = function() {
      var framesDefer;
      this.changeState(this.STATE.LOADING);
      this.ui.setView(mobilePlayer.UI.prototype.VIEW.LOADING);
      this.ui.loadingProgress(0.1);
      framesDefer = this.core.preloadFrames();
      framesDefer.done((function(_this) {
        return function() {
          return _this.playMuted();
        };
      })(this));
      framesDefer.progress((function(_this) {
        return function(progress) {
          return _this.ui.loadingProgress(Math.max(progress, 0.1));
        };
      })(this));
      return framesDefer.fail((function(_this) {
        return function() {
          return _this.unload();
        };
      })(this));
    };

    MobilePlayer.prototype.preloadAudioAndPlay = function() {
      var audioDefer;
      audioDefer = this.core.loadAudio();
      audioDefer.done((function(_this) {
        return function() {
          _this.isAudioPreloaded = true;
          _this.core.rewind();
          return _this.playWithAudio();
        };
      })(this));
      audioDefer.fail((function(_this) {
        return function() {
          _this.isAudioFailed = true;
          _this.ui.audioFailed();
          _this.core.rewind();
          return _this.playMuted();
        };
      })(this));
      audioDefer.progress((function(_this) {
        return function(progress) {
          return _this.ui.loadingProgress(Math.max(progress, 0.1));
        };
      })(this));
      this.changeState(this.STATE.LOADING);
      this.ui.setView(mobilePlayer.UI.prototype.VIEW.LOADING);
      return this.ui.loadingProgress(0.1);
    };

    MobilePlayer.prototype.preloadAllAndPlay = function() {
      var audioDefer, audioProg, checkAll, drawProgress, framesDefer, framesPreloaded, framesProg;
      framesDefer = this.core.preloadFrames();
      audioDefer = this.core.loadAudio();
      audioProg = 0;
      framesProg = 0;
      framesPreloaded = false;
      checkAll = (function(_this) {
        return function() {
          if (!framesPreloaded) {
            return;
          }
          if (_this.isAudioPreloaded) {
            return _this.playWithAudio();
          } else if (_this.isAudioFailed) {
            _this.ui.audioFailed();
            return _this.playMuted();
          }
        };
      })(this);
      drawProgress = (function(_this) {
        return function() {
          return _this.ui.loadingProgress(Math.max(audioProg * .5 + framesProg * .5, .1));
        };
      })(this);
      audioDefer.done((function(_this) {
        return function() {
          _this.isAudioPreloaded = true;
          return checkAll();
        };
      })(this));
      audioDefer.fail((function(_this) {
        return function() {
          _this.isAudioFailed = true;
          return checkAll();
        };
      })(this));
      framesDefer.done((function(_this) {
        return function() {
          framesPreloaded = true;
          return checkAll();
        };
      })(this));
      audioDefer.progress((function(_this) {
        return function(progress) {
          console.log(_this.DT, 'audio', progress);
          audioProg = progress;
          return drawProgress();
        };
      })(this));
      framesDefer.progress((function(_this) {
        return function(progress) {
          console.log(_this.DT, 'video', progress);
          framesProg = progress;
          return drawProgress();
        };
      })(this));
      this.changeState(this.STATE.LOADING);
      this.ui.setView(mobilePlayer.UI.prototype.VIEW.LOADING);
      return this.ui.loadingProgress(0.1);
    };

    MobilePlayer.prototype.canPlayAudio = function() {
      return this.isAudioPreloaded || mobilePlayer.SharedAudioElement.allowedToPlay();
    };

    MobilePlayer.prototype.playMuted = function() {
      this.changeState(this.STATE.PLAYING);
      this.dispatcher && this.dispatcher.startedPlaying();
      if (this.hasAudio) {
        this.ui.setView(mobilePlayer.UI.prototype.VIEW.PLAYING_MUTED);
      } else {
        this.ui.setView(mobilePlayer.UI.prototype.VIEW.PLAYING);
      }
      return this.core.playSimpleLoop();
    };

    MobilePlayer.prototype.playWithAudio = function() {
      this.changeState(this.STATE.PLAYING);
      this.ui.setView(mobilePlayer.UI.prototype.VIEW.PLAYING);
      this.dispatcher && this.dispatcher.startedPlaying();
      return this.core.playAudioSyncLoop();
    };

    MobilePlayer.prototype.changeState = function(state) {
      var key, ref, value;
      console.log(this.DT, "Change state to", state);
      this.state = state;
      ref = this.STATE;
      for (key in ref) {
        value = ref[key];
        this.vb.removeClass("-state-" + value);
      }
      return this.vb.addClass("-state-" + state);
    };

    MobilePlayer.prototype.notifyAboutView = function() {
      if (this.notifedAboutView) {
        return;
      }
      this.notifedAboutView = true;
      return StatsDataProvider.coubIncrementViews(this.data.permalink, 'mobile', this.isEmbed);
    };

    return MobilePlayer;

  })();

}).call(this);
(function() {
  window.Player = (function() {
    function Player(el, opts) {
      if (opts == null) {
        opts = {};
      }
      if (!opts.skip_html5 && window.MediaSource && !GlobalState.PLATFORM.isMobile()) {
        this.curHandler = new Html5Player(el, opts);
      }
      this.curHandler || (this.curHandler = new MobilePlayer(el, opts));
    }

    return Player;

  })();

  $.fn.player = function(opts) {
    return this.each(function() {
      if (!this.getAttribute('data-player-initialized')) {
        this.setAttribute('data-player-initialized', true);
        return new Player(this, opts);
      }
    });
  };

  Player.ACTION_ACTIVATE_HAND_CONTROL = "Player:Actions:ActivateHandControl";

  Player.ACTION_DEACTIVATE_HAND_CONTROL = "Player:Actions:DeactivateHandControl";

  Player.ACTION_UNEMBED_IF_NOT_PLAYING = "Player:Actions:UnembedIfNotPlaying";


  /* HTML5 Actions */

  Player.ACTION_SET_FULLSCREEN_ELEMENT = "Player:Actions:SetFullscreenElement";

  Player.ACTION_HIDE_CONTROLS = "Player:Actions:HideControls";

  Player.ACTION_SHOW_CONTROLS = "Player:Actions:ShowControls";

  Player.ACTION_TURN_HD_ON = "Player:Actions:TurnHdOn";

  Player.EVENT_READY = "Player:Ready";

  Player.EVENT_PLAYING = "playWasStarted";

  Player.EVENT_PAUSED = "Player:Paused";

  Player.EVENT_PLUG_IN_SOUND = "Player:PlugInSound";

  Player.EVENT_HTML5_FALLBACK = "Player:Html5Fallback";

  Player.EVENT_AUDIO_TRACK_ENDED = "Player::AudioTrackEnded";

  Player.LOOP_OCCURED = "Player::LoopOccured";

}).call(this);
(function() {
  window.AboutPage = (function() {
    function AboutPage(el) {
      var $el, $withLoop;
      $el = $(el);
      new blocks.LazyViewerBlocks($el);
      $withLoop = $('.-with-loop', $el);
      $el.on(blocks.LazyViewerBlocks.prototype.EVENT_VIEWER_LOADED, (function(_this) {
        return function(e, coubViewer) {
          if (!$withLoop.is(coubViewer)) {
            return;
          }
          $el.off(blocks.LazyViewerBlocks.prototype.EVENT_VIEWER_LOADED);
          return new LoopTimer($withLoop, $('.loop'));
        };
      })(this));
    }

    return AboutPage;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.ChannelsPromoPage = (function() {
    function ChannelsPromoPage(opts) {
      this.getCoverHeight = bind(this.getCoverHeight, this);
      this.coverPlay = bind(this.coverPlay, this);
      this.$el = $(opts.el);
      this.cover = $('.hero-cover', this.$el);
      this.coverViewer = this.cover.find('.viewer:first');
      this.coverHeight = this.getCoverHeight();
      new blocks.LazyViewerBlocks(this.$el, {
        startWithHD: true,
        muted: true
      });
      if (!GlobalState.PLATFORM.isMobile()) {
        this.coverViewer.player({
          muted: true,
          startWithHD: true,
          noControls: true
        }).trigger('preload').trigger('play');
        $(document).on(functions.ScrollHandler.EVENT_SCROLL, this.coverPlay);
        $(window).on('resize', (function(_this) {
          return function() {
            return _this.coverHeight = _this.getCoverHeight();
          };
        })(this));
      }
    }

    ChannelsPromoPage.prototype.coverPlay = function() {
      if (functions.ScrollHandler.getScrollPos() < this.coverHeight) {
        return this.coverViewer.trigger('play');
      } else {
        return this.coverViewer.trigger('suspend');
      }
    };

    ChannelsPromoPage.prototype.getCoverHeight = function() {
      return this.cover.outerHeight();
    };

    return ChannelsPromoPage;

  })();

}).call(this);
(function() {
  $.Controller("CoubsDoubleCarousel", {
    init: function(el, opts) {
      if (opts == null) {
        opts = {};
      }
      console.log('init coubs double carousel', el, opts);
      this.opts = opts;
      this.disabled = opts.disabled;
      this.header = $(".header");
      this.index = 0;
      this.list = $(".list", this.element);
      this.blocks = $(".slideshow__item", this.element);
      this.viewers = $('.viewer', this.element);
      this.slideshowWrapper = $(".slideshow__wrapper", this.element);
      this.dotsBlock = $(".slideshow__dots");
      this.dots = $(".dot");
      this.slidesDescriptionItem = $(".slideshow__item-desc", this.el);
      this.blocksNumber = this.blocks.size();
      this.shift = 0;
      this.blockWidth = this.blocks.eq(this.index).width() + this.shift * 2;
      this.viewportShift = this.header.height() + parseInt(this.header.css("padding-top")) + parseInt(this.header.css("padding-bottom"));
      this.positionBlocks();
      this.setHeight(this.blocks.first().height());
      this.slideshowWrapper.css({
        width: this.blocksNumber * this.blockWidth
      });
      this.slideshow = true;
      this.dots.eq(this.index).addClass("-active");
      this.slidesDescriptionItem.eq(this.index).addClass("active");
      this.animationDuration = 600;
      this.slideshowInterval = 10000;
      this.dots.bind("click", (function(_this) {
        return function(e) {
          var index;
          if (!$(e.target).hasClass("-active")) {
            _this.unembed();
            _this.slideshow = false;
            index = $(e.target).index();
            _this.viewers.eq(index).trigger('preload');
            _this.showNextCoub(index);
            return _this.slideshow = false;
          }
        };
      })(this));
      this.element.bind("carouselEnable", (function(_this) {
        return function() {
          return _this.enable();
        };
      })(this));
      this.element.bind("carouselDisable", (function(_this) {
        return function() {
          return _this.disable();
        };
      })(this));
      this.element.bind("carouselUnembed", (function(_this) {
        return function() {
          return _this.unembed();
        };
      })(this));
      this.element.bind("carouselPlay", (function(_this) {
        return function() {
          return _this.play();
        };
      })(this));
      $('.sb.-left', this.element).on('click', (function(_this) {
        return function() {
          if (window.location.href.indexOf('lays') !== -1) {
            $('body').append("<img src='http://ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=bdtqo&pfb=dgcuc&pr=ervfdeq'/>");
          }
          _this.prevPlay();
          return _this.slideshow = false;
        };
      })(this));
      $('.sb.-right', this.element).on('click', (function(_this) {
        return function() {
          if (window.location.href.indexOf('lays') !== -1) {
            $('body').append("<img src='http://ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=bdtqo&pfb=dgcuc&pr=ervfdeq'/>");
          }
          _this.nextPlay();
          return _this.slideshow = false;
        };
      })(this));
      this.blocks.eq(this.index).one("playWasStarted", (function(_this) {
        return function() {
          _this.slideshow = true;
          return setInterval((function() {
            var index;
            index = _this.cycleIndex(_this.index + 1);
            if (_this.slideshow) {
              _this.unembed();
              return _this.showNextCoub(index);
            }
          }), _this.slideshowInterval);
        };
      })(this));
      $(window).bind("periodic_scroll focus", (function(_this) {
        return function() {
          return _this.embedSlideshowCoubs();
        };
      })(this));
      if (!this.disabled) {
        return _.delay(this.embedSlideshowCoubs.bind(this), 500);
      }
    },
    embedSlideshowCoubs: function() {
      if (this.disabled) {
        return;
      }
      if (this.element.is(":in-viewport")) {
        if (!this.playing) {
          this.play();
          return this.startAgain();
        }
      } else {
        if (!this.playing) {
          return;
        }
        this.unembed();
        return this.slideshow = false;
      }
    },
    positionBlocks: function() {
      var shift, width;
      width = this.blocks.eq(this.index).width();
      shift = 0;
      return _.each(this.blocks, function(b) {
        var index, left;
        index = $(b).index();
        left = shift + (width + shift * 2) * index;
        return $(b).css({
          position: 'absolute',
          'top': '0px',
          'left': left + "px"
        });
      });
    },
    unembed: function() {
      this.viewers.eq(this.index).trigger('unembed').trigger('suspend');
      return this.playing = false;
    },
    play: function() {
      var block, nextInd;
      if (!document.hasFocus() || this.disabled) {
        return;
      }
      console.log('received play', this.element);
      block = this.viewers.eq(this.index);
      block.trigger('play');
      if (this.index === this.blocksNumber - 1) {
        this.element.trigger('lastElement');
      }
      nextInd = this.cycleIndex(this.index + 1);
      this.viewers.eq(nextInd).trigger('preload');
      return this.playing = true;
    },
    nextPlay: function() {
      var index;
      index = this.cycleIndex(this.index + 1);
      this.unembed();
      this.viewers.eq(index).trigger('preload');
      return this.showNextCoub(index);
    },
    prevPlay: function() {
      var index;
      index = this.cycleIndex(this.index - 1);
      this.unembed();
      this.viewers.eq(index).trigger('preload');
      return this.showNextCoub(index);
    },
    preload: function() {
      return this.viewers.eq(this.index).trigger('preload');
    },
    startAgain: function() {
      if (this.element.is(":in-viewport")) {
        return this.slideshow = true;
      }
    },
    showNextCoub: function(index) {
      this.dots.removeClass("-active");
      this.dots.eq(index).addClass("-active");
      this.slidesDescriptionItem.removeClass("-active");
      this.slidesDescriptionItem.eq(index).addClass("-active");
      if (this.opts.dynamicHeight) {
        this.setHeight(this.blocks.eq(index).height());
      }
      this.slideshowWrapper.animate({
        left: "-" + (this.blockWidth * index) + "px"
      }, this.animationDuration, ((function(_this) {
        return function() {
          return _this.animationFinished(index);
        };
      })(this)));
      if (this.startAgainTimeout) {
        clearTimeout(this.startAgainTimeout);
      }
      if (index === this.blocksNumber - 1) {
        return this.element.trigger('lastElement');
      }
    },
    cycleIndex: function(ind) {
      if (ind < 0) {
        ind = this.blocksNumber + ind;
      }
      if (ind > this.blocksNumber - 1) {
        ind = ind - this.blocksNumber;
      }
      return ind;
    },
    animationFinished: function(index) {
      if (index !== void 0) {
        this.index = index;
      } else {
        this.index = this.cycleIndex(this.index + 1);
      }
      this.element.trigger('animationFinished', [this.index]);
      return _.defer((function(_this) {
        return function() {
          return _this.play();
        };
      })(this));
    },
    setHeight: function(height) {
      console.log('set height', this.element, this.slideshowWrapper);
      this.element.css({
        height: height
      });
      return this.slideshowWrapper.css({
        height: height
      });
    },
    enable: function() {
      return this.disabled = false;
    },
    disable: function() {
      return this.disabled = true;
    }
  });

}).call(this);
(function() {
  $.Controller("ExplorePageSlideshow", {
    init: function() {
      var block, startProgress, stopProgress;
      this.header = $("header.header");
      this.index = 0;
      this.list = $(".list", this.element);
      this.blocks = $(".slideshow__item", this.element);
      this.coubBlocks = this.blocks.find('.viewer');
      this.pauseCarousel = this.blocks.find('[pause-carousel]');
      this.slideshowWrapper = $(".slideshow__wrapper", this.element);
      this.dotsBlock = $(".slideshow__dots", this.element);
      this.dots = this.dotsBlock.find(".dot");
      this.blocksNumber = this.blocks.size();
      this.coubLoadProgress = $(".progress", this.element);
      this.containerWidth = 970;
      this.containerHeight = 330;
      this.animationDuration = 600;
      this.slideshowInterval = 15000;
      this.shift = 0;
      this.blockWidth = this.blocks.eq(this.index).width() + this.shift * 2;
      this.viewportShift = this.header.height() + parseInt(this.header.css("padding-top")) + parseInt(this.header.css("padding-bottom"));
      this.positionBlocks();
      this.element.css({
        height: this.containerHeight
      });
      this.slideshowWrapper.css({
        height: this.containerHeight,
        width: (this.blocksNumber * this.blockWidth) + "px"
      });
      this.slideshow = true;
      this.dots.eq(this.index).addClass("-active");
      this.dots.bind("click", (function(_this) {
        return function(e) {
          var index;
          if (!$(e.target).hasClass("-active")) {
            _this.unembed();
            _this.slideshow = false;
            index = $(e.target).index();
            _this.showNextCoub(index);
            return _this.pausedInterval = true;
          }
        };
      })(this));
      this.pauseCarousel.bind('mouseenter', (function(_this) {
        return function() {
          if (!_this.pausedInterval) {
            return _this.slideshow = false;
          }
        };
      })(this));
      this.pauseCarousel.bind('mouseleave', (function(_this) {
        return function() {
          if (!_this.pausedInterval) {
            return _this.slideshow = true;
          }
        };
      })(this));
      stopProgress = (function(_this) {
        return function() {
          clearInterval(_this.coubLoadProgressTimer);
          _this.coubLoadProgressTimer = void 0;
          _this.coubLoadProgress.css("width", "100%");
          return setTimeout((function() {
            return _this.coubLoadProgress.hide();
          }), 300);
        };
      })(this);
      startProgress = (function(_this) {
        return function(inc) {
          var cp, pinc;
          _this.coubLoadProgress.show();
          pinc = inc;
          cp = 0;
          return _this.coubLoadProgressTimer = setInterval(function() {
            if ((cp += pinc) >= 90) {
              stopProgress();
            }
            return _this.coubLoadProgress.css('width', '#{cp}%');
          }, 500);
        };
      })(this);
      block = this.blocks.eq(this.index).find('.viewer');
      block.one("loaded", (function(_this) {
        return function() {
          return startProgress((90 / parseInt(block.attr("duration"))) / 2);
        };
      })(this));
      this.blocks.eq(this.index).find('.viewer').one("playWasStarted", (function(_this) {
        return function() {
          stopProgress();
          return _this.restartSlideshow();
        };
      })(this));
      $(window).bind("periodic_scroll", (function(_this) {
        return function() {
          return _this.embedSlideshowCoubs();
        };
      })(this));
      return _.delay(((function(_this) {
        return function() {
          return _this.embedSlideshowCoubs();
        };
      })(this)), 500);
    },
    restartSlideshow: function() {
      if (this.slideshowIntervalTimer) {
        clearInterval(this.slideshowIntervalTimer);
      }
      this.slideshow = true;
      return this.slideshowIntervalTimer = setInterval(((function(_this) {
        return function() {
          var index;
          index = _this.cycleIndex(_this.index + 1);
          if (_this.slideshow) {
            _this.unembed();
            return _this.showNextCoub(index);
          }
        };
      })(this)), this.slideshowInterval);
    },
    embedSlideshowCoubs: function() {
      if (this.element.is(":in-viewport-partly-with-shift(" + this.viewportShift + ")")) {
        if (!this.playing) {
          this.play();
          this.restartSlideshow();
        }
        return this.muteOrUnmute();
      } else {
        if (!this.playing) {
          return;
        }
        this.unembed();
        return this.slideshow = false;
      }
    },
    positionBlocks: function() {
      var shift, width;
      width = this.blocks.eq(this.index).width();
      shift = 0;
      return _.each(this.blocks, function(b) {
        var index, left;
        index = $(b).index();
        left = shift + (width + shift * 2) * index;
        return $(b).css({
          position: 'absolute',
          'top': '0',
          'left': left + "px"
        });
      });
    },
    unembed: function() {
      this.blocks.eq(this.index).find('.viewer').trigger('unembed');
      return this.playing = false;
    },
    play: function() {
      var block, nextInd;
      block = this.blocks.eq(this.index).find('.viewer');
      if (block.length > 0) {
        block.one('playWasStarted', (function(_this) {
          return function() {
            return _this.muteOrUnmute();
          };
        })(this));
        block.trigger('play');
      }
      nextInd = this.cycleIndex(this.index + 1);
      this.blocks.eq(nextInd).find('.viewer').trigger('preload');
      return this.playing = true;
    },
    muteOrUnmute: function() {
      if (this.element.is(":in-viewport-with-shift(" + this.viewportShift + ")") && document.hasFocus()) {
        return $('.viewer', this.element).trigger('unmute');
      } else {
        return $('.viewer', this.element).trigger('mute');
      }
    },
    startAgain: function() {
      if (this.element.is(":in-viewport-partly-with-shift(" + this.viewportShift + ")")) {
        return this.slideshow = true;
      }
    },
    showNextCoub: function(index) {
      this.dots.removeClass("-active");
      this.dots.eq(index).addClass("-active");
      this.slideshowWrapper.animate({
        left: "-" + (this.blockWidth * index) + "px"
      }, this.animationDuration, ((function(_this) {
        return function() {
          return _this.animationFinished(index);
        };
      })(this)));
      if (this.startAgainTimeout) {
        clearTimeout(this.startAgainTimeout);
      }
      return this.startAgainTimeout = setTimeout(((function(_this) {
        return function() {
          return _this.startAgain();
        };
      })(this)), 30000);
    },
    cycleIndex: function(ind) {
      if (ind < 0) {
        ind = this.blocksNumber + ind;
      }
      if (ind > this.blocksNumber - 1) {
        ind = ind - this.blocksNumber;
      }
      return ind;
    },
    animationFinished: function(index) {
      if (index !== void 0) {
        this.index = index;
      } else {
        this.index = this.cycleIndex(this.index + 1);
      }
      return _.defer((function(_this) {
        return function() {
          return _this.play();
        };
      })(this));
    }
  });

}).call(this);
(function() {
  window.FaqPage = (function() {
    function FaqPage(opts) {
      this.$el = $(opts.el);
      this.heading = $('.faq-heading h1', this.$el);
      this.questions = $('.faq-questions', this.$el);
      this.searchInput = $('.faq-nav__form input', this.$el);
      this.navItems = $('.faq-nav__list li', this.$el);
      this.isSearchMode = false;
      this.initSearchForm();
      this.initNavigation();
    }

    FaqPage.prototype.initSearchForm = function() {
      var inputTimeout, searchXhr;
      inputTimeout = 0;
      searchXhr = false;
      return this.searchInput.on('input', (function(_this) {
        return function(e) {
          clearTimeout(inputTimeout);
          if (!_this.searchInput.val()) {
            return;
          }
          return inputTimeout = _.delay(function() {
            _this.isSearchMode = true;
            _this.setLoader();
            _this.navItems.removeClass('selected');
            _this.heading.html(I18n.t('promo.faq.search.title'));
            searchXhr && searchXhr.abort();
            return searchXhr = $.post(Routes.faq_search_path(), {
              q: _this.searchInput.val()
            }).done(function(data) {
              return _this.setQuestions(data || ("<div class=\"faq-nothing-found -centered-text\">" + (I18n.t('promo.faq.search.nothing_found')) + ".</div>"));
            });
          }, e.which === 13 && 1 || 500);
        };
      })(this));
    };

    FaqPage.prototype.initNavigation = function() {
      var navXhr, selIndex;
      if (History.enabled) {
        this.navItems.on('click', 'a', (function(_this) {
          return function(e) {
            var $link;
            _this.searchInput.val('');
            $link = _this.navItems.filter(e.delegateTarget);
            if (_this.isSearchMode) {
              _this.isSearchMode = false;
              if (_this.navItems.index($link) === History.getState().data.menuIndex) {
                $(window).trigger('statechange');
                return false;
              }
            }
            History.pushState({
              title: $link.attr('data-title'),
              menuIndex: _this.navItems.index($link)
            }, $link.attr('data-page-title'), Routes.faq_page_path({
              category: $link.attr('data-alias')
            }));
            return false;
          };
        })(this));
        navXhr = false;
        selIndex = this.navItems.filter('.selected').index();
        History.replaceState({
          title: this.heading.html(),
          menuIndex: selIndex
        }, document.title, location.href);
        return $(window).on('statechange', (function(_this) {
          return function() {
            var alias, state;
            state = History.getState();
            _this.navItems.removeClass('selected');
            _this.navItems.eq(state.data.menuIndex).addClass('selected');
            _this.setLoader();
            _this.heading.html(state.data.title);
            navXhr && navXhr.abort();
            navXhr = $.post(state.hash).done(function(data) {
              return _this.setQuestions(data);
            });
            if (Params.getBranchValue("current_user.is_admin")) {
              alias = _this.navItems.filter('.selected').attr('data-alias');
              return $('.faq-add-item', _this.$el).attr('href', Routes.new_admin_faq_path({
                category: alias
              }));
            }
          };
        })(this));
      }
    };

    FaqPage.prototype.setLoader = function() {
      this.questions.addClass('fade');
      return LoadRotator.appendToContainterAndStart(this.questions, '-abs');
    };

    FaqPage.prototype.setQuestions = function(html) {
      window.scrollTo(0, 0);
      return this.questions.removeClass('fade').html(html);
    };

    return FaqPage;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.MediaPage = (function() {
    function MediaPage(opts) {
      this.getCoverHeight = bind(this.getCoverHeight, this);
      this.coverPlay = bind(this.coverPlay, this);
      var $slideshow;
      this.$el = $(opts.el);
      this.cover = $('.hero-cover', this.$el);
      this.coverViewer = this.cover.find('.viewer:first');
      this.coverHeight = this.getCoverHeight();
      new blocks.LazyViewerBlocks($('section', this.$el).not('.-carousel'));
      if (!GlobalState.PLATFORM.isMobile()) {
        this.coverViewer.player({
          muted: true,
          startWithHD: true,
          noControls: true
        }).trigger('preload').trigger('play');
        $(document).on(functions.ScrollHandler.EVENT_SCROLL, this.coverPlay);
        $(window).on('resize', (function(_this) {
          return function() {
            return _this.coverHeight = _this.getCoverHeight();
          };
        })(this));
        $slideshow = $('.slideshow', this.$el);
        blocks.ViewerBlock.constructFromContainer($slideshow).done(function() {
          return $slideshow.coubs_double_carousel();
        });
      }
    }

    MediaPage.prototype.coverPlay = function() {
      if (functions.ScrollHandler.getScrollPos() < this.coverHeight) {
        return this.coverViewer.trigger('play');
      } else {
        return this.coverViewer.trigger('suspend');
      }
    };

    MediaPage.prototype.getCoverHeight = function() {
      return this.cover.outerHeight();
    };

    return MediaPage;

  })();

}).call(this);
(function() {
  $.Controller("TosNavigation", {
    init: function() {
      this.scroll = this.element.find('.niceScroller');
      if (!GlobalState.PLATFORM.isMobile()) {
        $(window).on('scroll', (function(_this) {
          return function() {
            return _this.activeTerm();
          };
        })(this)).on('resize', (function(_this) {
          return function() {
            return _this.resizeNav();
          };
        })(this));
        this.element.find('li').click((function(_this) {
          return function(evt) {
            return _this.goToTerm($(evt.currentTarget));
          };
        })(this));
        this.activeTerm();
        return this.resizeNav();
      }
    },
    resizeNav: function() {
      var innerHeight, scrollArea;
      innerHeight = this.scroll.find('.list').height();
      scrollArea = $(window).height() - $('.header').height() - 155;
      if (innerHeight > scrollArea) {
        this.scroll.css({
          height: scrollArea
        });
      } else {
        this.scroll.css({
          height: innerHeight
        });
      }
      return this.scroll.nice_scroller();
    },
    activeTerm: function() {
      var current;
      current = $(".tos__body h3:in-viewport-partly").first();
      return this.highlightMenuItem(current.attr('data-anchor'));
    },
    goToTerm: function(el) {
      var id, offset, shift;
      id = el.attr('data-anchor');
      el = $(".tos__body [data-anchor='" + id + "']");
      offset = $(el).offset().top;
      shift = 117;
      $.scrollTo(offset - shift, 200);
      return setTimeout((function(_this) {
        return function() {
          return _this.highlightMenuItem(id);
        };
      })(this), 300);
    },
    highlightMenuItem: function(id) {
      if (id != null) {
        $('.tos__navigation li').removeClass('active');
        return $(".tos__navigation li[data-anchor='" + id + "']").addClass('active');
      }
    }
  });

}).call(this);
(function() {
  window.Prompt = (function() {
    Prompt.prototype.DIRECTIONS = {
      ABOVE: 'above',
      BELOW: 'below',
      LEFT: 'left',
      RIGHT: 'right'
    };

    Prompt.prototype.CONSTRAINTS = {
      LEFT: 'left',
      RIGHT: 'right',
      NONE: 'none'
    };

    Prompt.EVENT_CHANGE_TEXT = "prompt:changeText";

    Prompt.ACTION_HIDE = "prompt:Actions:Hide";

    Prompt.ACTION_SHOW = "prompt:Actions:Show";

    function Prompt(el, opts) {
      this.element = $(el);
      this.disableCheckTimer = void 0;
      this.bindedHidePrompt = this.hidePrompt.bind(this);
      this.element.bind("mouseenter.prompt", this.showPrompt.bind(this));
      this.element.bind("mouseleave.prompt hidePrompt.prompt", this.bindedHidePrompt);
      $(window).on("scroll", this.bindedHidePrompt);
      this.element.bind(Prompt.EVENT_CHANGE_TEXT, this.changeText.bind(this));
      this.element.bind(Prompt.ACTION_SHOW, this.showPrompt.bind(this));
      this.element.bind(Prompt.ACTION_HIDE, this.hidePrompt.bind(this));
    }

    Prompt.prototype.destroy = function() {
      this.hidePrompt();
      $(window).off("scroll", this.bindedHidePrompt);
      return this.element.off(".prompt " + Prompt.EVENT_CHANGE_TEXT + " " + Prompt.ACTION_SHOW + " " + Prompt.ACTION_HIDE);
    };

    Prompt.prototype.showPrompt = function(e) {
      if (e != null) {
        e.preventDefault();
      }
      if (this.tooltip == null) {
        if (this.isActive()) {
          this.cssClass = [this.element.attr('data-prompt-class'), this.getDirection()];
          this.getTooltip();
          this.elementPosition();
          return this.startDisableCheckTimer();
        }
      }
    };

    Prompt.prototype.startDisableCheckTimer = function() {
      this.stopDisableCheckTimer();
      return this.disableCheckTimer = setInterval((function(_this) {
        return function() {
          if (_this.tooltip != null) {
            if ((_this.element.attr("disabled") != null) || !_this.isActive()) {
              return _this.hidePrompt();
            }
          } else {
            return _this.stopDisableCheckTimer();
          }
        };
      })(this), 1000);
    };

    Prompt.prototype.stopDisableCheckTimer = function() {
      if (this.disableCheckTimer != null) {
        clearInterval(this.disableCheckTimer);
        return this.disableCheckTimer = void 0;
      }
    };

    Prompt.prototype.getTooltip = function() {
      return this.tooltip = new Tooltip({
        type: this.cssClass.join(' '),
        element: this.element,
        content: this.getContent()
      });
    };

    Prompt.prototype.hidePrompt = function(e) {
      if (e != null) {
        e.preventDefault();
      }
      if (this.tooltip) {
        this.tooltip.remove();
        return this.tooltip = null;
      }
    };

    Prompt.prototype.elementPosition = function() {
      var constraint, defaultLeft, defaultTop, direction, elHeight, elWidth, left, rect, top;
      direction = this.getDirection();
      constraint = this.getConstraint();
      defaultTop = this.element.offset().top;
      defaultLeft = this.element.offset().left;
      rect = this.element.get(0).getBoundingClientRect();
      elWidth = rect.width;
      elHeight = rect.height;
      switch (direction) {
        case this.DIRECTIONS.ABOVE:
          top = defaultTop;
          left = defaultLeft + elWidth / 2;
          break;
        case this.DIRECTIONS.BELOW:
          top = defaultTop + elHeight;
          left = defaultLeft + elWidth / 2;
          break;
        case this.DIRECTIONS.LEFT:
          top = defaultTop + elHeight / 2;
          left = defaultLeft;
          break;
        case this.DIRECTIONS.RIGHT:
          top = defaultTop + elHeight / 2;
          left = defaultLeft + elWidth;
          break;
        default:
          top = defaultTop;
          left = defaultLeft;
      }
      return this.tooltip.position(left, top, direction, constraint);
    };

    Prompt.prototype.getDirection = function() {
      var direction;
      direction = this.element.attr('direction');
      if (direction != null) {
        return this.DIRECTIONS[direction.toUpperCase()];
      } else {
        return this.DIRECTIONS.ABOVE;
      }
    };

    Prompt.prototype.getConstraint = function() {
      var constraint;
      constraint = this.element.attr('constraint');
      if (constraint != null) {
        return this.CONSTRAINTS[constraint.toUpperCase()];
      } else {
        return this.CONSTRAINTS.NONE;
      }
    };

    Prompt.prototype.changeText = function(e, content) {
      this.setContent(content || e.content);
      if ((this.tooltip != null) && (this.tooltip.el != null) && this.tooltip.el.is(":visible")) {
        this.tooltip.setContent(this.getContent());
        return this.elementPosition();
      }
    };

    Prompt.prototype.isActive = function() {
      return this.element.attr('inactive') == null;
    };

    Prompt.prototype.getContent = function() {
      var v;
      if ((v = this.element.attr('data-prompt')) != null) {
        return v;
      } else {
        return "";
      }
    };

    Prompt.prototype.setContent = function(content) {
      if (content == null) {
        content = "";
      }
      return this.element.attr("data-prompt", content);
    };

    return Prompt;

  })();

  $.fn.prompt = function(opts) {
    return this.each(function() {
      if (!this.getAttribute('data-prompt-initialized')) {
        this.setAttribute('data-prompt-initialized', true);
        return new Prompt(this, opts);
      }
    });
  };

}).call(this);
(function() {
  var RawVideoNotification;

  RawVideoNotification = (function() {
    function RawVideoNotification() {}

    RawVideoNotification.prototype.constuctor = function(el) {
      var closeBtn;
      this.element = $(el);
      closeBtn = $('.close-small', this.element);
      this.id = closeBtn.attr('id');
      $('.sb.-blue', this.element).on("click", (function(_this) {
        return function() {
          return _this.hideNotification();
        };
      })(this));
      return closeBtn.on("click", (function(_this) {
        return function() {
          _this.element.fadeOut(300);
          return _this.hideNotification();
        };
      })(this));
    };

    RawVideoNotification.prototype.hideNotification = function() {
      return $.del(Routes.notifications_group_path(this.id)).fail(function() {
        return ErrorMessages.internalServerError();
      });
    };

    return RawVideoNotification;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.AbusesList = (function() {
    function AbusesList(el) {
      this.el = el;
      this.getClaimButton = bind(this.getClaimButton, this);
      this.deleteSpecific = bind(this.deleteSpecific, this);
      this.deleteAllClaims = bind(this.deleteAllClaims, this);
      this.el = this.el.find('[editor-abuses-list]');
      this.coubId = this.el.attr('data-coub-id');
      this.specificClaim = this.el.find('.deleteClaim');
      this.deleteAll = this.el.find('.deleteAll');
      this.provider = new dataProviders.ApiV2();
      $("[data-prompt]", this.el).prompt();
      this.deleteAll.bind('click', this.deleteAllClaims);
      this.specificClaim.bind('click', (function(_this) {
        return function(e) {
          return _this.deleteSpecific(e.currentTarget);
        };
      })(this));
    }

    AbusesList.prototype.deleteAllClaims = function() {
      return this.provider.deleteAllAbuses(this.coubId, {
        success: (function(_this) {
          return function() {
            _this.el.remove();
            return Growl.succ('Abuse', 'All abuses were successfully removed');
          };
        })(this),
        error: (function(_this) {
          return function() {
            return Growl.msg('Abuse', 'Error occured. Please, try again later.');
          };
        })(this)
      });
    };

    AbusesList.prototype.deleteSpecific = function(btn) {
      var id;
      id = $(btn).attr('data-abuse-id');
      return this.provider.deleteAbuseClaim(id, {
        success: (function(_this) {
          return function() {
            _this.getClaimButton(id).parent().remove();
            return Growl.succ('Abuse', 'Abuse was successfully removed');
          };
        })(this),
        error: (function(_this) {
          return function() {
            return Growl.msg('Abuse', 'Error occured. Please, try again later.');
          };
        })(this)
      });
    };

    AbusesList.prototype.getClaimButton = function(id) {
      return this.el.find(".deleteClaim[data-abuse-id=" + id + "]");
    };

    AbusesList.construct = function(container) {
      if (container.length) {
        return new AbusesList(container);
      }
    };

    return AbusesList;

  })();

}).call(this);
(function() {
  window.EditorBest2016Moderation = (function() {
    EditorBest2016Moderation.ATTR_NAME = "widget-editor-best2016-moderation";

    function EditorBest2016Moderation(el) {
      this.el = el;
      this.coubId = this.el.attr('data-coub-id');
      this.removedCategories = [];
      this.saveBtn = this.el.find('.editor-best2016-moderation__submit');
      this.saveBtn.click(this.submit.bind(this));
      this.initPopButtons();
      this.initBestCategoryPicker();
      this.loadCategories();
    }

    EditorBest2016Moderation.prototype.initPopButtons = function() {
      return this.el.find('.editor-best2016-moderation__pop').on('click', 'button', (function(_this) {
        return function(e) {
          if ($(e.currentTarget).hasClass('active')) {
            return;
          }
          $('button', e.delegateTarget).removeClass('active');
          $(e.currentTarget).addClass('active');
          return _this.saveBtn.addClass('stateChanged');
        };
      })(this));
    };

    EditorBest2016Moderation.prototype.initBestCategoryPicker = function() {
      this.$categories = $("[name=best_categories]", this.el).tagit({
        readOnly: true
      });
      return $('ul.ui-widget-content', this.el).addClass('input-field -sq').on('click', '.tagit-choice', (function(_this) {
        return function(e) {
          if (_this.el.find('.editor-best2016-moderation__pop button.active').length === 0) {
            _this.el.find('.editor-best2016-moderation__pop button').first().addClass('active');
          }
          _this.removedCategories.push($(e.currentTarget).find('.tagit-label').text());
          _this.saveBtn.addClass('stateChanged');
          return $(e.currentTarget).remove();
        };
      })(this));
    };

    EditorBest2016Moderation.prototype.loadCategories = function() {
      this.showLoader();
      return $.get(Routes.best2016_categories_editor_coub_path(this.coubId)).always(this.hideLoader.bind(this)).fail(ErrorMessages.internalServerError).done((function(_this) {
        return function(data) {
          return data.forEach(function(permalink) {
            return _this.$categories.tagit('createTag', permalink);
          });
        };
      })(this));
    };

    EditorBest2016Moderation.prototype.submit = function() {
      var is_banned, post_data, present_categories;
      this.showLoader();
      is_banned = this.el.find('.editor-best2016-moderation__pop button.active[data-ban]').length > 0;
      present_categories = $('ul.ui-widget-content .tagit-label', this.el).map(function(i, v) {
        return $(v).text();
      }).toArray();
      post_data = {
        removed_categories: this.removedCategories,
        present_categories: present_categories,
        ban: is_banned
      };
      return $.post(Routes.best2016_moderation_editor_coub_path(this.coubId), post_data).fail(ErrorMessages.internalServerError).done((function(_this) {
        return function() {
          _this.saveBtn.removeClass('stateChanged');
          return _this.hideLoader();
        };
      })(this));
    };

    EditorBest2016Moderation.prototype.showLoader = function() {
      return LoadRotator.appendWithOverlayAndStart(this.el);
    };

    EditorBest2016Moderation.prototype.hideLoader = function() {
      return LoadRotator.removeWithOverlay(this.el);
    };

    return EditorBest2016Moderation;

  })();

}).call(this);
(function() {
  window.EditorCopyrightClaim = (function() {
    EditorCopyrightClaim.ATTR_NAME = "widget-editor-copyright-claim";

    function EditorCopyrightClaim(el) {
      el.on("submit", (function(_this) {
        return function(e) {
          var $form, $submitButton, coubId, data;
          e.preventDefault();
          $form = $(e.currentTarget);
          $submitButton = $form.find("button");
          $submitButton.addClass("disabled");
          coubId = $form.attr("data-coub-id");
          data = $form.serialize('*');
          return $.post(Routes.set_copyright_claim_editor_coub_path(coubId), data).fail(ErrorMessages.internalServerError).done(function() {
            return Growl.succ("Claim saved!");
          }).always(function() {
            return $submitButton.removeClass("disabled");
          });
        };
      })(this));
    }

    return EditorCopyrightClaim;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.EditorCoubCatsAndFlagsMenu = (function() {
    function EditorCoubCatsAndFlagsMenu(opts) {
      this.hideLoader = bind(this.hideLoader, this);
      this.showLoader = bind(this.showLoader, this);
      this.getStates = bind(this.getStates, this);
      this.stateChanged = bind(this.stateChanged, this);
      this.dependentExploreChecks = bind(this.dependentExploreChecks, this);
      this.submit = bind(this.submit, this);
      this.newChanges = bind(this.newChanges, this);
      this.getSubmitButton = bind(this.getSubmitButton, this);
      this.getCoubId = bind(this.getCoubId, this);
      this.getAllChecks = bind(this.getAllChecks, this);
      this.getExploreCheck = bind(this.getExploreCheck, this);
      this.getBookmarkedCheck = bind(this.getBookmarkedCheck, this);
      this.getFlagsChecks = bind(this.getFlagsChecks, this);
      this.el = $(opts.el);
      this.provider = new EditorCoubCatFlagDataProvider();
      this.bookmarkedCheck = this.getBookmarkedCheck();
      $('.editorAbuseDropdown', this.el).dropdown();
      this.initialStates = this.getStates(this.getAllChecks());
      this.initialBookmarked = this.bookmarkedCheck.is(":checked");
      $('.pop-coub', this.el).on('click', (function(_this) {
        return function(e) {
          var btn, coubId, error, success;
          btn = $(e.currentTarget);
          coubId = btn.attr('data-coub-id');
          success = function() {
            return btn.addClass('stateChanged');
          };
          error = function() {
            return ErrorMessages.internalServerError();
          };
          return _this.provider.popCoub(coubId, success, error);
        };
      })(this));
      this.el.on('submit', (function(_this) {
        return function(e) {
          e.preventDefault();
          if (_this.newChanges()) {
            return _this.submit();
          }
        };
      })(this));
      this.el.on('click', 'input[type=checkbox]', this.stateChanged);
      this.el.on('click', 'input[name=no_category], input[name=visible_on_explore_root], input[name=bookmarked]', this.dependentExploreChecks);
    }

    EditorCoubCatsAndFlagsMenu.prototype.getFlagsChecks = function() {
      return $("input", this.el);
    };

    EditorCoubCatsAndFlagsMenu.prototype.getBookmarkedCheck = function() {
      return $("input[name=bookmarked]", this.el);
    };

    EditorCoubCatsAndFlagsMenu.prototype.getExploreCheck = function() {
      return $("input[name=no_category], input[name=visible_on_explore_root]", this.el);
    };

    EditorCoubCatsAndFlagsMenu.prototype.getAllChecks = function() {
      return $("input[type=checkbox]", this.el);
    };

    EditorCoubCatsAndFlagsMenu.prototype.getCoubId = function() {
      return $("input[name=coub_id]", this.el).val();
    };

    EditorCoubCatsAndFlagsMenu.prototype.getSubmitButton = function() {
      return $("button[type=submit]", this.el);
    };

    EditorCoubCatsAndFlagsMenu.prototype.newChanges = function() {
      return this.getSubmitButton().hasClass('stateChanged');
    };

    EditorCoubCatsAndFlagsMenu.prototype.submit = function() {
      var bookmarked, coubId, error, flagCheck, flags, i, len, ref, success;
      flags = {};
      coubId = this.getCoubId();
      bookmarked = this.bookmarkedCheck.is(":checked");
      ref = this.getAllChecks();
      for (i = 0, len = ref.length; i < len; i++) {
        flagCheck = ref[i];
        if ($(flagCheck).is(":checked")) {
          flags[$(flagCheck).val()] = true;
        } else {
          flags[$(flagCheck).val()] = false;
        }
      }
      this.getSubmitButton().attr("disabled", "true");
      this.showLoader();
      error = (function(_this) {
        return function() {
          Growl.msg(I18n.ERRORS.INTERNAL_SERVER_ERROR.SUB, I18n.ERRORS.INTERNAL_SERVER_ERROR.TRY_AGAIN);
          return _this.hideLoader();
        };
      })(this);
      success = (function(_this) {
        return function() {
          _this.hideLoader();
          _this.getSubmitButton().removeAttr("disabled").removeClass("stateChanged");
          _this.initialBookmarked = bookmarked;
          return _this.initialStates = _this.getStates(_this.getAllChecks());
        };
      })(this);
      return this.provider.updateFlagsOrCategories(coubId, flags, success, error);
    };

    EditorCoubCatsAndFlagsMenu.prototype.dependentExploreChecks = function(e) {
      var checked, checks, currentCheck;
      currentCheck = $(e.currentTarget);
      checked = currentCheck.is(':checked');
      checks = this.getExploreCheck();
      if (checked && !currentCheck.is(this.bookmarkedCheck)) {
        checks.attr('checked', false);
        currentCheck.attr('checked', true);
      }
      if (this.bookmarkedCheck.is(":checked") && currentCheck.is(checks[1]) && checked) {
        this.bookmarkedCheck.attr('checked', false);
      }
      if ($(checks[1]).is(":checked") && currentCheck.is(this.bookmarkedCheck) && checked) {
        return $(checks[1]).attr('checked', false);
      }
    };

    EditorCoubCatsAndFlagsMenu.prototype.stateChanged = function() {
      var newStates;
      newStates = this.getStates(this.getAllChecks());
      if (_.isEqual(this.initialStates, newStates)) {
        return this.getSubmitButton().removeClass('stateChanged');
      } else {
        return this.getSubmitButton().addClass('stateChanged');
      }
    };

    EditorCoubCatsAndFlagsMenu.prototype.getStates = function(checks) {
      var check, i, len, out;
      out = [];
      for (i = 0, len = checks.length; i < len; i++) {
        check = checks[i];
        out.push($(check).is(":checked"));
      }
      return out;
    };

    EditorCoubCatsAndFlagsMenu.prototype.showLoader = function() {
      return LoadRotator.appendWithOverlayAndStart($(this.el));
    };

    EditorCoubCatsAndFlagsMenu.prototype.hideLoader = function() {
      return LoadRotator.removeWithOverlay($(this.el));
    };

    EditorCoubCatsAndFlagsMenu.construct = function(container) {
      return container.find(".moderation__form").each(function() {
        return new EditorCoubCatsAndFlagsMenu({
          el: this
        });
      });
    };

    return EditorCoubCatsAndFlagsMenu;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.EditorQueueSort = (function() {
    EditorQueueSort.ATTR_NAME = 'widget-editor-queue-sort';

    EditorQueueSort.prototype.EVENTS = {
      LOADED: "EditorQueueSort:Events:Loaded"
    };

    function EditorQueueSort(params1) {
      this.params = params1 != null ? params1 : {};
      this.getReorderMethod = bind(this.getReorderMethod, this);
      this.getCoubsMethod = bind(this.getCoubsMethod, this);
      this.afterReorder = bind(this.afterReorder, this);
      this.hideLoader = bind(this.hideLoader, this);
      this.showLoader = bind(this.showLoader, this);
      this.reorderQueue = bind(this.reorderQueue, this);
      this.updateCounter = bind(this.updateCounter, this);
      this.initQueueItems = bind(this.initQueueItems, this);
      this.initSorter = bind(this.initSorter, this);
      this.appendQueueList = bind(this.appendQueueList, this);
      this.getQueueList = bind(this.getQueueList, this);
      this.el = this.params.el;
      this.list = $('[widget-editor-queue-sort-list]', this.params.el);
      this.count = $('[widget-editor-queue-sort-count]', this.params.el);
      this.items = void 0;
      this.provider = new EditorCoubCatFlagDataProvider();
      this.showLoader();
    }

    EditorQueueSort.prototype.getQueueList = function(params) {
      var error, success;
      if (params == null) {
        params = {};
      }
      return this.getCoubsMethod()(params, success = (function(_this) {
        return function(resp) {
          _this.appendQueueList(resp);
          return _this.hideLoader();
        };
      })(this), error = (function(_this) {
        return function() {
          _this.hideLoader();
          return ErrorMessages.internalServerError();
        };
      })(this));
    };

    EditorQueueSort.prototype.appendQueueList = function(resp) {
      var coub, i, index, int, lastPublished, len, publishedStamp, ref, stamp;
      lastPublished = resp.last_published_at;
      if (this.items != null) {
        this.items.remove();
      }
      ref = resp.coubs;
      for (index = i = 0, len = ref.length; i < len; index = ++i) {
        coub = ref[index];
        if (lastPublished != null) {
          publishedStamp = parseInt(lastPublished) * 1000;
          int = 30 * (1 + index) * 60000;
          stamp = moment(publishedStamp + int).format("hh:mm A");
          this.params.last_published_at = publishedStamp;
          this.params.will_be_published = stamp;
          this.params.position = 1 + index;
        }
        this.list.append(JST['app/site/templates/site_editor/channels_queue/item']({
          coub: coub,
          params: this.params
        }));
      }
      this.list.addClass('fade');
      this.initSorter();
      this.initQueueItems();
      return $(this).trigger(this.EVENTS.LOADED);
    };

    EditorQueueSort.prototype.initSorter = function() {
      this.items = this.list.children('li');
      return this.list.multisortable({
        items: '.recoubs-queue__item',
        selectedClass: "queue-selected",
        start: (function(_this) {
          return function(e, ui) {
            var excluded;
            excluded = _this.items.not(ui.item[0]);
            excluded.addClass('fade');
            $(ui.item[0]).addClass('drag');
            if (e.metaKey || e.ctrlKey) {
              return excluded.addClass('scale');
            }
          };
        })(this),
        stop: (function(_this) {
          return function(e, ui) {
            var excluded;
            excluded = _this.items.not(ui.item[0]);
            excluded.removeClass('fade scale');
            return $(ui.item[0]).removeClass('drag');
          };
        })(this),
        update: (function(_this) {
          return function(e, ui) {
            return _this.reorderQueue($(ui.item[0]).attr('data-recoub-id'), ui.item.index() + 1);
          };
        })(this),
        click: (function(_this) {
          return function(e, ui) {
            var target;
            target = $(e.target);
            if (target.is("img,a")) {
              return $(ui[0]).removeClass('queue-selected');
            }
          };
        })(this)
      });
    };

    EditorQueueSort.prototype.initQueueItems = function() {
      this.list.find('[put-on-top]').on('click', (function(_this) {
        return function(e) {
          var id, item;
          item = $(e.currentTarget).parents('li').detach();
          id = item.attr('data-recoub-id');
          _this.list.prepend(item);
          return _this.reorderQueue(id, 1);
        };
      })(this));
      this.list.find('[show-editorial]').on('click', (function(_this) {
        return function(e) {
          var permalink;
          permalink = $(e.currentTarget).parents('li').attr('data-permalink');
          return EditorialPopup.show(permalink);
        };
      })(this));
      return this.updateCounter();
    };

    EditorQueueSort.prototype.updateCounter = function() {
      if (this.count != null) {
        return this.count.text($('[widget-editor-queue-sort-list] > li', this.el).length);
      }
    };

    EditorQueueSort.prototype.reorderQueue = function(id, position) {
      var data, error, ids, success;
      ids = _.map($('[widget-editor-queue-sort-list] > li', this.el), function(item) {
        return $(item).attr('data-recoub-id');
      });
      data = {
        id: id,
        position: position,
        ids: ids
      };
      this.items.addClass('fade');
      return this.getReorderMethod()(data, success = (function(_this) {
        return function() {
          _this.items.removeClass('fade');
          return _this.afterReorder();
        };
      })(this), error = (function(_this) {
        return function() {
          return ErrorMessages.internalServerError();
        };
      })(this));
    };

    EditorQueueSort.prototype.showLoader = function() {
      return LoadRotator.appendToContainterAndStart(this.list.parent());
    };

    EditorQueueSort.prototype.hideLoader = function() {
      return LoadRotator.removeFromContainer(this.list.parent());
    };

    EditorQueueSort.prototype.afterReorder = function() {
      throw "Implement afterReorder";
    };

    EditorQueueSort.prototype.getCoubsMethod = function() {
      throw "Implement getCoubsMethod";
    };

    EditorQueueSort.prototype.getReorderMethod = function() {
      throw "Implement getReorderMethod";
    };

    return EditorQueueSort;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.EditorTimelineFiltration = (function() {
    EditorTimelineFiltration.EVENTS = {
      FILTER_CHANGED: "EditorTimelineFiltration:FilterChanged"
    };

    EditorTimelineFiltration.prototype.FILTERS = {
      TIMELINER: "timeliner",
      SELECTER: "selecter",
      DATE: "date"
    };

    EditorTimelineFiltration.prototype.PARAMS = {
      EXCLUDE: 'exclude'
    };

    function EditorTimelineFiltration(el1, type1) {
      var filter, i, len, ref;
      this.el = el1;
      this.type = type1;
      this.reloadTimeline = bind(this.reloadTimeline, this);
      this.filtersWork = bind(this.filtersWork, this);
      this.timeline = this.el.find('[clientside-timeline]').first();
      this.controls = this.el.find('[widget-editor-timeline-controls]');
      this.provider = new TimelineDataProvider();
      this.params = this.provider.setEditorTimelineType(TimelineDataProvider.UNIFIED_ADMIN_FILTER[this.type.toUpperCase()]);
      ref = [this.FILTERS.TIMELINER, this.FILTERS.SELECTER, this.FILTERS.DATE];
      for (i = 0, len = ref.length; i < len; i++) {
        filter = ref[i];
        this.filtersWork(filter);
      }
      $(document).on(EditorTimelineFiltration.EVENTS.FILTER_CHANGED, this.reloadTimeline);
    }

    EditorTimelineFiltration.prototype.filtersWork = function(filter) {
      var dateWork, newParam, reload, selecterWork, setParam, timelinerWork, type;
      filter = this.el.find("[filtration-type=" + filter + "]");
      type = filter.attr('filtration-type');
      timelinerWork = (function(_this) {
        return function() {
          var timeliners;
          timeliners = filter.find('button.timeliner');
          return timeliners.on('click', function(e) {
            var el, filtrationKeys, prop, val;
            el = $(e.currentTarget);
            filtrationKeys = JSON.parse(el.attr('filtration-key'));
            timeliners.removeClass('active');
            el.addClass('active');
            for (prop in filtrationKeys) {
              val = filtrationKeys[prop];
              if (_.isEmpty(setParam(_this.params, prop, val)) || val === _this.PARAMS.EXCLUDE) {
                newParam(prop, val);
              }
            }
            return reload();
          });
        };
      })(this);
      selecterWork = (function(_this) {
        return function() {
          var key;
          key = filter.attr('filtration-key');
          return filter.on(NiceSelect.EVENT_SELECTED, function(e) {
            if (_.isEmpty(setParam(_this.params, key, e.val)) || e.val === _this.PARAMS.EXCLUDE) {
              newParam(key, e.val);
            }
            return reload();
          });
        };
      })(this);
      dateWork = (function(_this) {
        return function() {
          var form, i, input, inputs, key, len;
          key = filter.attr('filtration-key');
          form = $('form', filter);
          inputs = $(".datepickable", filter);
          for (i = 0, len = inputs.length; i < len; i++) {
            input = inputs[i];
            setParam(_this.params['by_period'], $(input).attr('name'), $(input).val());
          }
          return form.on('submit', function(e) {
            var j, len1;
            e.preventDefault();
            for (j = 0, len1 = inputs.length; j < len1; j++) {
              input = inputs[j];
              setParam(_this.params, $(input).attr('name'), $(input).val());
            }
            return reload();
          });
        };
      })(this);
      newParam = (function(_this) {
        return function(k, v) {
          if (v === _this.PARAMS.EXCLUDE) {
            return delete _this.params[k];
          } else {
            return _this.params[k] = v;
          }
        };
      })(this);
      setParam = (function(_this) {
        return function(obj, key, value) {
          var prop;
          for (prop in obj) {
            if (obj[prop] instanceof Object) {
              setParam(obj[prop], key, value);
            } else {
              if (prop === key) {
                return obj[prop] = value;
              }
            }
          }
        };
      })(this);
      reload = (function(_this) {
        return function() {
          return $(document).trigger(EditorTimelineFiltration.EVENTS.FILTER_CHANGED);
        };
      })(this);
      switch (type) {
        case this.FILTERS.TIMELINER:
          return timelinerWork();
        case this.FILTERS.SELECTER:
          return selecterWork();
        case this.FILTERS.DATE:
          return dateWork();
      }
    };

    EditorTimelineFiltration.prototype.reloadTimeline = function() {
      return this.timeline.triggerHandler(clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_PROPERTIES, this.params);
    };

    EditorTimelineFiltration.construct = function(el, type) {
      if (el.length) {
        return new window.EditorTimelineFiltration(el, type);
      }
    };

    return EditorTimelineFiltration;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.EditorTimelineView = (function() {
    EditorTimelineView.FILTER_CHANGED = "EditorTimelineView:FilterChanged";

    function EditorTimelineView(el1, type1) {
      this.el = el1;
      this.type = type1;
      this.getDateFilters = bind(this.getDateFilters, this);
      this.getDefaultView = bind(this.getDefaultView, this);
      this.reloadTimeline = bind(this.reloadTimeline, this);
      this.dateFormSubmit = bind(this.dateFormSubmit, this);
      this.setFilters = bind(this.setFilters, this);
      this.initFilters = bind(this.initFilters, this);
      this.timeline = this.el.find(".coubsList").first();
      this.controls = this.el.find(".timelineControls").first();
      this.formContainer = this.el.find(".editor-date-filter");
      this.dateForm = $("form", this.formContainer);
      this.dateFilters = $(".datepickable", this.dateForm);
      this.timelineDataProvider = new TimelineDataProvider();
      $(document).bind(EditorTimelineView.FILTER_CHANGED, (function(_this) {
        return function(e) {
          return _this.setFilters(e.filter_type, e.direction, e.val);
        };
      })(this));
      this.currentFilters = this.timelineDataProvider.setEditorTimelineType(TimelineDataProvider.UNIFIED_ADMIN_FILTER[this.type.toUpperCase()]);
      this.getDateFilters(this.dateFilters);
      this.initFilters();
      this.dateForm.bind('submit', (function(_this) {
        return function(e) {
          _this.dateFormSubmit(e);
          return e.preventDefault();
        };
      })(this));
    }

    EditorTimelineView.prototype.initFilters = function() {
      var filter;
      filter = $('#order-by-type', this.controls);
      return filter.on("click", function() {
        if ($(this).hasClass('active')) {
          return;
        }
        filter.removeClass('active');
        $(this).addClass('active');
        return $(document).trigger({
          type: EditorTimelineView.FILTER_CHANGED,
          val: $(this).attr('data-type'),
          filter_type: TimelineDataProvider.EDITOR_FILTER.REORDER_BY.FIELD_NAME,
          direction: $(this).attr('data-direction')
        });
      });
    };

    EditorTimelineView.prototype.setFilters = function(filter_type, direction, val) {
      switch (filter_type) {
        case 'field_name':
          this.currentFilters.reorder_by[filter_type] = val;
          break;
        default:
          if (this.currentFilters[filter_type] !== val) {
            this.currentFilters[filter_type] = val;
          }
      }
      this.currentFilters.reorder_by.direction = direction;
      this.getDateFilters(this.dateFilters);
      console.log("FILTERS", this.currentFilters);
      return this.reloadTimeline(this.currentFilters);
    };

    EditorTimelineView.prototype.dateFormSubmit = function(e) {
      this.getDateFilters(this.dateFilters);
      return this.reloadTimeline(this.currentFilters);
    };

    EditorTimelineView.prototype.reloadTimeline = function(filters) {
      return this.timeline.triggerHandler(clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_PROPERTIES, filters);
    };

    EditorTimelineView.prototype.getDefaultView = function() {
      return this.el.attr('data-default-view');
    };

    EditorTimelineView.prototype.getDateFilters = function(inputs) {
      this.currentFilters.by_period.from = $(inputs[0]).val();
      return this.currentFilters.by_period.to = $(inputs[1]).val();
    };

    EditorTimelineView.construct = function(el, type) {
      if (el.length) {
        return new window.EditorTimelineView(el, type);
      }
    };

    return EditorTimelineView;

  })();

}).call(this);
(function() {
  window.EditorTrendList = {
    init: function($el) {
      return $el.on('click', 'a', function(e) {
        var coubId, trendId;
        e.preventDefault();
        if (!confirm('Are you sure?')) {
          return;
        }
        coubId = e.delegateTarget.getAttribute('data-coub-id');
        trendId = e.currentTarget.getAttribute('data-trend-id');
        return $.post(Routes.ban_from_trend_editor_coub_path(coubId, {
          trend_id: trendId
        })).done(function() {
          return $(e.currentTarget).closest('li').remove();
        }).fail(ErrorMessages.internalServerError);
      });
    },
    construct: function(container) {
      return this.init($('.trend-info', container));
    }
  };

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.WeeklyDigestEditor = (function() {
    WeeklyDigestEditor.ATTR_NAME = 'widget-weekly-digest-editor';

    WeeklyDigestEditor.prototype.ACTIONS = {
      ADD: {
        PERMALINK: 'addItemViaPermalink',
        ID: 'addItemViaId'
      },
      REMOVE: {
        ID: 'removeItem'
      }
    };

    WeeklyDigestEditor.prototype.EVENTS = {
      UPDATE_COUNTER: 'WeeklyDigestEditor:Events:UpdateCounter'
    };

    function WeeklyDigestEditor(el) {
      var control, k, len, ref;
      this.el = el;
      this.sendDigest = bind(this.sendDigest, this);
      this.renderList = bind(this.renderList, this);
      this.renderItem = bind(this.renderItem, this);
      this.getTemplate = bind(this.getTemplate, this);
      this.reorderQueue = bind(this.reorderQueue, this);
      this.sorterInit = bind(this.sorterInit, this);
      this.updateCounter = bind(this.updateCounter, this);
      this.removeItemControlInit = bind(this.removeItemControlInit, this);
      this.addItemControlInit = bind(this.addItemControlInit, this);
      this.removeItemButtonsInit = bind(this.removeItemButtonsInit, this);
      this.addItemStaticInit = bind(this.addItemStaticInit, this);
      this.addItemFormInit = bind(this.addItemFormInit, this);
      this.digestId = this.el.attr('weekly-digest-id');
      this.addItemForm = $('[weekly-add-item-form]', this.el);
      this.counter = $('[weekly-digest-coubs-count]', this.el);
      this.provider = new dataProviders.EditorWeeklyDataProvider();
      this.locker = new chms.utils.Locker($(this.el));
      ref = [this.addItemFormInit, this.removeItemButtonsInit, this.sorterInit, this.addItemStaticInit];
      for (k = 0, len = ref.length; k < len; k++) {
        control = ref[k];
        control();
      }
      this.counter.on(this.EVENTS.UPDATE_COUNTER, this.updateCounter);
      $('[weekly-digest-ready]', this.el).on('click', this.sendDigest);
    }

    WeeklyDigestEditor.prototype.addItemFormInit = function() {
      var forms;
      forms = $('[weekly-add-item-form]', this.el);
      return _.each(forms, (function(_this) {
        return function(e, i) {
          var entity, form, input, type;
          form = $(e);
          input = $('[weekly-add-item-input]', form);
          entity = form.attr('entity-type');
          type = form.attr('request-type');
          return _this.addItemControlInit({
            value: null,
            type: type,
            entity: entity,
            container: form,
            input: input,
            remote: false
          });
        };
      })(this));
    };

    WeeklyDigestEditor.prototype.addItemStaticInit = function() {
      var items;
      items = $('[weekly-digest-static-item]', this.el);
      return _.each(items, (function(_this) {
        return function(e, i) {
          var entity, item, type, value;
          item = $(e);
          entity = item.attr('entity-type');
          type = item.attr('request-type');
          value = item.attr('entity-id');
          return _this.addItemControlInit({
            value: value,
            type: type,
            entity: entity,
            container: item,
            input: null,
            remote: true
          });
        };
      })(this));
    };

    WeeklyDigestEditor.prototype.removeItemButtonsInit = function() {
      var items;
      items = $('[weekly-digest-data-item]', this.el);
      if (items.length) {
        return _.each(items, (function(_this) {
          return function(e, i) {
            var entity, id, item;
            item = $(e);
            entity = item.attr('entity-type');
            id = item.attr('entity-id');
            return _this.removeItemControlInit({
              item: item,
              entity: entity,
              id: id,
              remote: false
            });
          };
        })(this));
      }
    };

    WeeklyDigestEditor.prototype.addItemControlInit = function(opts) {
      var add, button, list, method, remote, update;
      if (opts == null) {
        opts = {};
      }
      button = $('[weekly-digest-add-item-control]', opts.container);
      list = $("[weekly-digest-data-container=" + (opts.entity.toLowerCase()) + "]", this.el);
      method = this.ACTIONS.ADD[opts.type.toUpperCase()];
      remote = opts.remote;
      add = (function(_this) {
        return function() {
          var value;
          if (opts.input != null) {
            value = opts.input.val();
          } else {
            value = opts.value;
          }
          if (value.length) {
            return _this.locker.safeExec(function() {
              return _this.provider[method](_this.digestId, value, opts.entity, {
                success: function(resp) {
                  update(resp.weekly_digest_item);
                  if (remote) {
                    return opts.container.remove();
                  }
                },
                error: function(resp) {
                  return ErrorMessages.internalServerError();
                },
                complete: function() {
                  return _this.locker.unlock();
                }
              });
            });
          }
        };
      })(this);
      update = (function(_this) {
        return function(item) {
          _this.renderItem(list, _this.getTemplate(item.entity_type, item.entity, item.position), remote);
          if (item.entity === 'Coub') {
            return _this.counter.trigger(_this.EVENTS.UPDATE_COUNTER);
          }
        };
      })(this);
      return button.on('click', add);
    };

    WeeklyDigestEditor.prototype.removeItemControlInit = function(opts) {
      var button, remoteUpdate, remove;
      if (opts == null) {
        opts = {};
      }
      button = $('[weekly-digest-remove-item-control]', opts.item);
      remove = (function(_this) {
        return function() {
          return _this.locker.safeExec(function() {
            return _this.provider[_this.ACTIONS.REMOVE.ID](_this.digestId, opts.id, opts.entity, {
              success: function(resp) {
                var container;
                if (opts.remote) {
                  container = $("[weekly-digest-static-item][entity-type=" + opts.entity + "]", _this.el).parent();
                  remoteUpdate(container);
                } else {
                  _this.renderList(resp.digest_items, opts.entity);
                }
                if (opts.entity === 'Coub') {
                  return _this.counter.trigger(_this.EVENTS.UPDATE_COUNTER);
                }
              },
              error: function(resp) {
                return ErrorMessages.internalServerError();
              },
              complete: function() {
                return _this.locker.unlock();
              }
            });
          });
        };
      })(this);
      remoteUpdate = (function(_this) {
        return function(list) {
          var entity, type, value;
          value = opts.item.attr('entity-id');
          type = 'id';
          entity = opts.entity;
          button.off('click').removeAttr('weekly-digest-remove-item-control').attr('weekly-digest-add-item-control', true).text('Add');
          list.append(opts.item.detach());
          return _this.addItemControlInit({
            value: value,
            type: type,
            entity: entity,
            container: opts.item,
            input: null,
            remote: true
          });
        };
      })(this);
      return button.on('click', remove);
    };

    WeeklyDigestEditor.prototype.updateCounter = function() {
      var count;
      count = $('[weekly-digest-data-container=coub]', this.el).find('.wkly-digest__item').length;
      return this.counter.text(count);
    };

    WeeklyDigestEditor.prototype.sorterInit = function() {
      var dragging_items, list, old_positions;
      list = $('[weekly-digest-sorter]', this.el);
      this.items = list.find('.wkly-digest__item');
      dragging_items = null;
      old_positions = null;
      return list.multisortable({
        axis: 'y',
        items: '.wkly-digest__item',
        selectedClass: "wkly-selected",
        start: (function(_this) {
          return function(e, ui) {
            var excluded;
            excluded = _this.items.not(ui.item[0]);
            excluded.addClass('fade');
            $(ui.item[0]).addClass('drag');
            ui.helper.height('');
            ui.placeholder.height(ui.helper.height());
            if (e.metaKey || e.ctrlKey) {
              excluded.addClass('scale');
            }
            dragging_items = $('.wkly-selected', _this.el);
            old_positions = [];
            return dragging_items.each(function(i, item) {
              var ind;
              ind = $(item).index();
              if ($(ui.item[0]).index() < ind) {
                ind--;
              }
              return old_positions.push(ind);
            });
          };
        })(this),
        stop: (function(_this) {
          return function(e, ui) {
            var excluded, positions;
            excluded = _this.items.not(ui.item[0]);
            excluded.removeClass('fade scale');
            $(ui.item[0]).removeClass('drag');
            positions = [];
            dragging_items.each(function(i, item) {
              var j, new_pos;
              new_pos = $(item).index();
              j = i + 1;
              while (j < old_positions.length) {
                if (old_positions[j] <= new_pos) {
                  new_pos++;
                }
                j++;
              }
              return positions.push(new_pos + 1);
            });
            return _this.reorderQueue(dragging_items, positions);
          };
        })(this),
        update: (function(_this) {
          return function(e, ui) {};
        })(this),
        click: (function(_this) {
          return function(e, ui) {
            var target;
            target = $(e.target);
            if (target.is("img,a")) {
              return $(ui[0]).removeClass('wkly-selected');
            }
          };
        })(this)
      });
    };

    WeeklyDigestEditor.prototype.reorderQueue = function(items, positions) {
      return this.locker.safeExec((function(_this) {
        return function() {
          var i, reposition;
          i = 0;
          reposition = function() {
            var entity, id, item, position;
            item = items[i];
            id = $(item).attr('entity-id');
            entity = $(item).attr('entity-type');
            position = positions[i];
            return _this.provider.repositionItemInDigest(_this.digestId, id, entity, position, {
              success: function(resp) {
                if (i === items.length - 1) {
                  return _this.renderList(resp.digest_items, entity);
                } else {
                  i++;
                  return reposition();
                }
              },
              error: function(resp) {
                return ErrorMessages.internalServerError();
              },
              complete: function() {
                return _this.locker.unlock();
              }
            });
          };
          return reposition();
        };
      })(this));
    };

    WeeklyDigestEditor.prototype.getTemplate = function(entity, item, position) {
      var template;
      template = $(JST["app/site/templates/site_editor/weekly_digest/" + (entity.toLowerCase()) + "_item"]({
        item: item,
        position: position
      }));
      return template;
    };

    WeeklyDigestEditor.prototype.renderItem = function(container, item, remote) {
      var entity, id;
      entity = item.attr('entity-type');
      id = item.attr('entity-id');
      this.removeItemControlInit({
        item: item,
        entity: entity,
        id: id,
        remote: remote
      });
      return container.append(item);
    };

    WeeklyDigestEditor.prototype.renderList = function(items, entity) {
      var list;
      list = $("[weekly-digest-data-container=" + (entity.toLowerCase()) + "]", this.el);
      list.html('');
      return _.each(items, (function(_this) {
        return function(e, i) {
          return _this.renderItem(list, _this.getTemplate(entity, e.entity, e.position));
        };
      })(this));
    };

    WeeklyDigestEditor.prototype.sendDigest = function() {
      return this.locker.safeExec((function(_this) {
        return function() {
          return _this.provider.didgestReady(_this.digestId, {
            success: function() {
              return window.location.replace(Routes.editor_weekly_digests_path());
            },
            error: function() {
              _this.locker.unlock();
              return ErrorMessages.internalServerError();
            }
          });
        };
      })(this));
    };

    WeeklyDigestEditor.sendTestMail = function() {
      var provider;
      provider = new dataProviders.EditorWeeklyDataProvider();
      return $('[weekly-digest-test-mail]').on('click', function() {
        var btn, id;
        btn = $(this);
        id = btn.attr('weekly-digest-id');
        return provider.sendTestMail(id, {
          success: (function(_this) {
            return function() {
              return btn.text('OK!');
            };
          })(this),
          error: (function(_this) {
            return function() {
              return ErrorMessages.internalServerError();
            };
          })(this)
        });
      });
    };

    return WeeklyDigestEditor;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.GlobalEditorButtons = (function() {
    function GlobalEditorButtons(el) {
      var clicked;
      this.el = el;
      this.getButtons = bind(this.getButtons, this);
      this.getGlobalSafeUrl = bind(this.getGlobalSafeUrl, this);
      this.moderate = bind(this.moderate, this);
      this.container = $('.global-editor-btns', this.el);
      this.buttons = $('.sb', this.container);
      clicked = (function(_this) {
        return function(e) {
          e.preventDefault();
          if (!$(e.currentTarget).hasClass('active')) {
            return _this.moderate(e.currentTarget);
          }
        };
      })(this);
      this.buttons.on('click', clicked);
    }

    GlobalEditorButtons.prototype.moderate = function(button) {
      var error, permalink, safe, status, success, type;
      status = Boolean($(button).attr('data-safe'));
      permalink = $(button).attr("data-permalink");
      safe = {
        safe: status
      };
      type = $(button).attr("data-global-type");
      this.buttons.addClass('disabled');
      success = (function(_this) {
        return function() {
          _this.buttons.removeClass('disabled active');
          return $(".sb[data-global-type=" + type + "]", _this.container).addClass('active');
        };
      })(this);
      error = (function(_this) {
        return function() {
          return Growl.msg(I18n.ERRORS.INTERNAL_SERVER_ERROR.SUB, I18n.ERRORS.INTERNAL_SERVER_ERROR.TRY_AGAIN);
        };
      })(this);
      return $.ajax({
        url: this.getGlobalSafeUrl(permalink, $.param(safe)),
        type: "PUT",
        success: success,
        error: error
      });
    };

    GlobalEditorButtons.prototype.getGlobalSafeUrl = function(permalink, data) {
      return "/editor/coubs/" + permalink + "/set_global_safe_status?" + data;
    };

    GlobalEditorButtons.prototype.getButtons = function() {
      return $('.sb', this.el);
    };

    GlobalEditorButtons.construct = function(container) {
      return new GlobalEditorButtons(container);
    };

    return GlobalEditorButtons;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.ChannelsDelayedQueue = (function(superClass) {
    extend(ChannelsDelayedQueue, superClass);

    function ChannelsDelayedQueue(params) {
      this.params = params != null ? params : {};
      this.isCurrent = bind(this.isCurrent, this);
      this.changeTitles = bind(this.changeTitles, this);
      this.publishNow = bind(this.publishNow, this);
      this.initQueueItems = bind(this.initQueueItems, this);
      this.selectQueue = bind(this.selectQueue, this);
      this.getReorderMethod = bind(this.getReorderMethod, this);
      this.getCoubsMethod = bind(this.getCoubsMethod, this);
      ChannelsDelayedQueue.__super__.constructor.apply(this, arguments);
      this.channelSelector = $('aside ul > li', this.el);
      this.titleLink = $('h1 > a', this.el);
      this.channelSelector.bind('click', (function(_this) {
        return function(e) {
          return _this.selectQueue(e);
        };
      })(this));
      this.getQueueList(this.el.attr('data-channel-id'));
    }

    ChannelsDelayedQueue.prototype.getCoubsMethod = function() {
      return this.provider.getEditorChannelRecoubsQueue;
    };

    ChannelsDelayedQueue.prototype.getReorderMethod = function() {
      return this.provider.reorderChannelRecoubsQueue;
    };

    ChannelsDelayedQueue.prototype.selectQueue = function(e) {
      var id, item, permalink, queueSize;
      e.preventDefault();
      item = $(e.currentTarget);
      permalink = item.attr('data-channel-permalink');
      id = item.attr('data-channel-id');
      queueSize = item.attr('data-queue-size');
      if (!this.isCurrent(item)) {
        this.list.removeClass('fade');
        this.changeTitles(item, permalink);
        if (parseInt(queueSize) !== 0) {
          return this.getQueueList(id);
        }
      }
    };

    ChannelsDelayedQueue.prototype.initQueueItems = function() {
      ChannelsDelayedQueue.__super__.initQueueItems.apply(this, arguments);
      return this.list.find('[publish-now]').on('click', (function(_this) {
        return function(e) {
          var id, item;
          _this.items.addClass('fade');
          item = $(e.currentTarget).parents('li');
          id = item.attr('data-recoub-id');
          return _this.publishNow(id, item);
        };
      })(this));
    };

    ChannelsDelayedQueue.prototype.publishNow = function(id, item) {
      var error, success;
      return this.provider.publishEditorChannelDelayedRecoub(id, success = (function(_this) {
        return function() {
          item.remove();
          _this.updateCounter();
          _this.getQueueList(_this.el.attr('data-channel-id'));
          _this.items.removeClass('fade');
          return Growl.msg('Success', 'Delayed recoub published');
        };
      })(this), error = (function(_this) {
        return function() {
          _this.items.removeClass('fade');
          return ErrorMessages.internalServerError();
        };
      })(this));
    };

    ChannelsDelayedQueue.prototype.changeTitles = function(selector, permalink) {
      var title, url;
      url = Routes.channel_url({
        id: permalink
      });
      title = selector.find('a').text();
      this.channelSelector.removeClass('disabled');
      selector.addClass('disabled');
      this.titleLink.attr('href', url).text(title);
      return History.replaceState({}, I18n.t('editor.channel_stats.queue_title'), Routes.recoubs_queue_editor_channel_path({
        id: permalink
      }));
    };

    ChannelsDelayedQueue.prototype.isCurrent = function(selector) {
      return selector.hasClass('disabled');
    };

    return ChannelsDelayedQueue;

  })(EditorQueueSort);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.ExploreDelayedQueue = (function(superClass) {
    extend(ExploreDelayedQueue, superClass);

    function ExploreDelayedQueue(params) {
      this.params = params != null ? params : {};
      this.afterReorder = bind(this.afterReorder, this);
      this.publishNow = bind(this.publishNow, this);
      this.initQueueItems = bind(this.initQueueItems, this);
      this.getReorderMethod = bind(this.getReorderMethod, this);
      this.getCoubsMethod = bind(this.getCoubsMethod, this);
      ExploreDelayedQueue.__super__.constructor.apply(this, arguments);
      this.getQueueList();
      $(this).one(this.EVENTS.LOADED, (function(_this) {
        return function() {
          var s;
          if (_this.items.length && (_this.params.last_published_at != null)) {
            s = moment(_this.params.last_published_at + (30 * _this.items.length * 60000)).format('hh:mm A');
            return $('span.medium', _this.el).text(s);
          }
        };
      })(this));
    }

    ExploreDelayedQueue.prototype.getCoubsMethod = function() {
      return this.provider.getEditorExploreDelayedQueue;
    };

    ExploreDelayedQueue.prototype.getReorderMethod = function() {
      return this.provider.reorderEditorExploreDelayedQueue;
    };

    ExploreDelayedQueue.prototype.initQueueItems = function() {
      ExploreDelayedQueue.__super__.initQueueItems.apply(this, arguments);
      return this.list.find('[publish-now]').on('click', (function(_this) {
        return function(e) {
          var id, item;
          _this.items.addClass('fade');
          item = $(e.currentTarget).parents('li');
          id = item.attr('data-recoub-id');
          return _this.publishNow(id, item);
        };
      })(this));
    };

    ExploreDelayedQueue.prototype.publishNow = function(id, item) {
      var error, success;
      return this.provider.publishEditorExploreDelayedQueue(id, success = (function(_this) {
        return function() {
          item.remove();
          _this.updateCounter();
          _this.getQueueList();
          return _this.items.removeClass('fade');
        };
      })(this), error = (function(_this) {
        return function() {
          _this.items.removeClass('fade');
          return ErrorMessages.internalServerError();
        };
      })(this));
    };

    ExploreDelayedQueue.prototype.afterReorder = function() {
      return this.getQueueList();
    };

    return ExploreDelayedQueue;

  })(EditorQueueSort);

}).call(this);
(function() {
  $.Controller("TextShortener", {
    init: function(el, opts) {
      this.opts = opts;
      if (this.opts == null) {
        this.opts = {};
      }
      this.linesCount = this.opts.linesCount || parseInt(this.element.attr('data-lines-count'));
      this.maxHeight = this.linesCount * parseInt(this.element.css('line-height'));
      this.text = this.element.text();
      return this.shorten();
    },
    shorten: function() {
      var count, newT, results, t;
      if (this.element.height() <= this.maxHeight) {
        return;
      }
      if (this.element.is('a')) {
        this.element.attr('title', this.text);
      }
      if ($.browser.webkit) {
        this.element.css({
          "display": "-webkit-box",
          "-webkit-line-clamp": this.linesCount + '',
          "-webkit-box-orient": "vertical"
        });
        return;
      }
      this.element.html('');
      this.words = this.text.split(" ");
      count = 0;
      t = '';
      results = [];
      while (true) {
        if (count === this.words.length) {
          newT = this.words.slice(0, count).join(' ');
        } else {
          newT = this.words.slice(0, count).join(' ') + "...";
        }
        this.element.each(function() {
          return this.innerHTML = newT;
        });
        if (this.element.height() > this.maxHeight || count > this.words.length) {
          this.element.each(function() {
            return this.innerHTML = t.replace(/\,$/, '');
          });
          break;
        } else {
          t = newT;
          results.push(count += 1);
        }
      }
      return results;
    }
  });

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.FieldCounter = (function() {
    FieldCounter.ATTR_NAME = 'widget-field-counter';

    FieldCounter.prototype.EVENTS = 'keydown keyup change paste';

    function FieldCounter(el1) {
      this.el = el1;
      this.unlock = bind(this.unlock, this);
      this.lock = bind(this.lock, this);
      this.isUnlocked = bind(this.isUnlocked, this);
      this.isLocked = bind(this.isLocked, this);
      this.checkIfLocked = bind(this.checkIfLocked, this);
      this.getLength = bind(this.getLength, this);
      this.updateIndicator = bind(this.updateIndicator, this);
      this.count = bind(this.count, this);
      this.limit = this.el.attr('count-limit');
      this.indicator = $('[widget-field-counter-indicator]');
      this.updateIndicator(this.getLength());
      this.checkIfLocked();
      this.el.on(this.EVENTS, this.count);
    }

    FieldCounter.prototype.count = function(event) {
      if (this.isLocked()) {
        if (event.keyCode === $.ui.keyCode.BACKSPACE) {
          this.unlock();
        } else {
          return false;
        }
      } else {
        if (this.getLength() >= this.limit) {
          this.el.val(this.el.val().substr(0, this.limit));
          this.lock();
        }
      }
      return this.updateIndicator(this.getLength());
    };

    FieldCounter.prototype.updateIndicator = function(val) {
      return this.indicator.html(this.limit - val);
    };

    FieldCounter.prototype.getLength = function() {
      return this.el.val().length;
    };

    FieldCounter.prototype.checkIfLocked = function() {
      if (this.getLength() >= this.limit) {
        return this.lock();
      } else {
        return this.unlock();
      }
    };

    FieldCounter.prototype.isLocked = function() {
      return this.el.hasClass('locked');
    };

    FieldCounter.prototype.isUnlocked = function() {
      return this.el.hasClass('unlocked');
    };

    FieldCounter.prototype.lock = function() {
      this.el.removeClass('unlocked').addClass('locked');
      return this.indicator.css({
        'color': '#ff0000'
      });
    };

    FieldCounter.prototype.unlock = function() {
      this.el.removeClass('locked').addClass('unlocked');
      return this.indicator.css({
        'color': ''
      });
    };

    return FieldCounter;

  })();

  $.Controller("TextareaCounter", {
    init: function(el, limit, cbk) {
      this.beforeData = this.element.val();
      this.element.bind("keydown keyup change paste", (function(_this) {
        return function(event) {
          cbk(_this.element, _this.count());
          if (_this.element.val() !== _this.beforeData) {
            if (_this.count() >= limit) {
              _this.element.val(_this.element.val().substr(0, limit));
            }
            _this.beforeData = _this.element.val();
            return cbk(_this.element, _this.count());
          }
        };
      })(this));
      return cbk(this.element, this.count());
    },
    count: function() {
      return this.element.val().length;
    }
  });

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.UnlogedAction = (function() {
    UnlogedAction.prototype.EXPARE = 600000;

    UnlogedAction.STORAGE_KEY = "unloged_action";

    UnlogedAction.ACTION_PREFIX = "unloged_action:";

    UnlogedAction.prototype.PERFORM_TIMEOUT = 20000;

    UnlogedAction.prototype.PERFORM_INTERVAL = 1000;

    UnlogedAction.prototype.SEND_ACTION_TIME = 1000;

    function UnlogedAction() {
      this.performAction = bind(this.performAction, this);
      this.isActionValid = bind(this.isActionValid, this);
      this.init = bind(this.init, this);
      if (UnlogedAction.__instance == null) {
        UnlogedAction.__instance = this;
        this.init();
      } else {
        return UnlogedAction.__instance;
      }
    }

    UnlogedAction.prototype.init = function() {
      var action;
      if (GlobalState.USER.isLogedIn() && (action = UnlogedAction.get())) {
        return this.performAction();
      } else {
        return UnlogedAction.clear();
      }
    };

    UnlogedAction.prototype.isActionValid = function() {
      return (action.selector != null) && (action.action != null) && (action.data != null) && (action.time != null);
    };

    UnlogedAction.prototype.performAction = function() {
      var action, perform, timeoutInterval, tryInterval, tryPerform;
      action = UnlogedAction.get();
      if ((Date.now() - action.time) < this.EXPARE) {
        tryPerform = (function(_this) {
          return function() {
            if ($(action.selector).size() > 0) {
              perform();
              return true;
            } else {
              return false;
            }
          };
        })(this);
        perform = (function(_this) {
          return function() {
            var sendAction;
            sendAction = function() {
              return $(action.selector).first().trigger({
                type: "" + UnlogedAction.ACTION_PREFIX + action.action,
                data: action.data
              });
            };
            setTimeout(sendAction, _this.SEND_ACTION_TIME);
            UnlogedAction.clear();
            if (typeof tryInterval !== "undefined" && tryInterval !== null) {
              clearInterval(tryInterval);
            }
            if (typeof timeoutInterval !== "undefined" && timeoutInterval !== null) {
              return clearInterval(timeoutInterval);
            }
          };
        })(this);
        if (!tryPerform()) {
          tryInterval = setInterval(tryPerform, this.PERFORM_INTERVAL);
          return timeoutInterval = setTimeout(perform, this.PERFORM_TIMEOUT);
        }
      } else {
        return UnlogedAction.clear();
      }
    };

    UnlogedAction.set = function(widgetSelector, action, data) {
      if (data == null) {
        data = {};
      }
      if ((widgetSelector == null) || (action == null)) {
        throw "UnlogedAction: to add action please pass widgetSelector and action";
      }
      if (!GlobalState.USER.isLogedIn()) {
        action = JSON.stringify({
          selector: widgetSelector,
          action: action,
          data: data,
          time: Date.now()
        });
        $.storage.set(UnlogedAction.STORAGE_KEY, action);
        return true;
      } else {
        return false;
      }
    };

    UnlogedAction.get = function() {
      var action, exception, parsed;
      if ((action = $.storage.get(UnlogedAction.STORAGE_KEY)) != null) {
        try {
          parsed = JSON.parse(action);
          return parsed;
        } catch (error) {
          exception = error;
          return void 0;
        }
      } else {
        return void 0;
      }
    };

    UnlogedAction.clear = function() {
      return $.storage.del(UnlogedAction.STORAGE_KEY);
    };

    return UnlogedAction;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.UnlogedActionHandler = (function() {
    UnlogedActionHandler.ACTIONS = {
      START_SESSION: 'UnloggedActionHandler:StartSession'
    };

    function UnlogedActionHandler(opts) {
      this.startSession = bind(this.startSession, this);
      this.el = $(opts.el);
      this.action = $(this.el).attr("data-unloged-action");
      this.selector = $(this.el).attr("data-unloged-action-selector");
      $(this.el).bind("click " + UnlogedActionHandler.ACTIONS.START_SESSION, this.startSession);
    }

    UnlogedActionHandler.prototype.startSession = function() {
      UnlogedAction.set(this.selector, this.action);
      return $(document).one(AuthPopup.Base.EVENTS.POPUP_CLOSED, UnlogedAction.clear);
    };

    UnlogedActionHandler.construct = function(container) {
      if (container == null) {
        container = $("body");
      }
      return container.find("[data-unloged-action]").each(function() {
        return new UnlogedActionHandler({
          el: $(this)
        });
      });
    };

    return UnlogedActionHandler;

  })();

}).call(this);
(function() {
  window.VerificationEmailBlock = (function() {
    function VerificationEmailBlock(el) {
      this.el = el;
      $('.verify-email__resend', this.el).click(this.resendEmail.bind(this));
    }

    VerificationEmailBlock.prototype.resendEmail = function(e) {
      var error, provider, success;
      e.preventDefault();
      provider = new LoginDataProvider();
      success = (function(_this) {
        return function() {
          var popup;
          popup = ModalPopup.show({
            content: $(".verify-email__success", _this.el)[0].outerHTML,
            footer: "",
            type: 'simple',
            classes: 'verify-email__success-popup'
          });
          return popup.getContentContainer().find(".verify-email__success").show();
        };
      })(this);
      error = function() {
        return Growl.msg(I18n.ERRORS.INTERNAL_SERVER_ERROR.SUB, I18n.ERRORS.INTERNAL_SERVER_ERROR.TRY_AGAIN);
      };
      return provider.resendEmailVerification(success, error);
    };

    VerificationEmailBlock.construct = function() {
      return $(".verify-email").first().each(function() {
        return new VerificationEmailBlock(this);
      });
    };

    return VerificationEmailBlock;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  blocks.LazyViewerBlocks = (function() {
    LazyViewerBlocks.prototype.EVENT_VIEWER_LOADED = "Blocks::LazyViewerBlocks::ViewerLoaded";

    function LazyViewerBlocks(container, opts) {
      if (opts == null) {
        opts = {};
      }
      this.togglePlayers = bind(this.togglePlayers, this);
      this.container = $(container);
      this.coubViewers = $('.coub__viewer--simple', this.container);
      this.opts = opts;
      this.togglePlayers();
      $(window).on('periodic_scroll', this.togglePlayers);
    }

    LazyViewerBlocks.prototype.togglePlayers = function() {
      var $active, $activeViewer;
      $active = this.coubViewers.filter(':in-viewport').first();
      if ($active.length && !$active.hasClass('-playing')) {
        $active.addClass('-playing');
        $activeViewer = $('> .viewer', $active);
        if ($active.hasClass('-loaded')) {
          $activeViewer.trigger('play');
        } else if (!$active.hasClass('-loading')) {
          $active.addClass('-loading');
          new blocks.ViewerBlock($activeViewer, this.opts).load().done((function(_this) {
            return function() {
              _this.container.triggerHandler(_this.EVENT_VIEWER_LOADED, $active);
              $active.addClass('-loaded').removeClass('-loading');
              if ($active.hasClass('-playing')) {
                return $('> .viewer', $active).trigger('play');
              }
            };
          })(this));
        }
      }
      return this.coubViewers.filter('.-playing.-loaded').not($active).removeClass('-playing').find('> .viewer').trigger('suspend');
    };

    return LazyViewerBlocks;

  })();

}).call(this);
(function() {
  blocks.ViewerBlock = (function() {
    ViewerBlock.ATTR_NAME = 'blocks-viewer-block';

    function ViewerBlock(el, opts) {
      if (opts == null) {
        opts = {};
      }
      this.el = $(el);
      this.opts = opts;
    }

    ViewerBlock.prototype.load = function() {
      return new dataProviders.ApiV2().getCoub(this.el.attr('data-permalink'), {
        success: (function(_this) {
          return function(coub) {
            var $viewer;
            if (!_this.opts.noControls) {
              $viewer = $(JST['app/site/templates/coub_block/viewer_block'](coub));
              $viewer.find('.viewer__img').replaceWith(_this.el.find('.viewer__img'));
              _this.el.replaceWith($viewer);
              _this.el = $viewer;
            }
            return _this.el.player($.extend({
              data: coub
            }, _this.opts)).trigger('preload').trigger('hidefinger');
          };
        })(this),
        error: function() {
          return ErrorMessages.internalServerError();
        }
      });
    };

    ViewerBlock.constructFromContainer = function(container, opts) {
      var defers;
      if (opts == null) {
        opts = {};
      }
      defers = _.map($("[" + blocks.ViewerBlock.ATTR_NAME + "]", container || $('body')), function(el) {
        return new blocks.ViewerBlock(el, opts).load();
      });
      return $.when.apply($, defers);
    };

    return ViewerBlock;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.AbstractAppSchemeLink = (function() {
    AbstractAppSchemeLink.prototype.schemeLink = 'what://ever';

    AbstractAppSchemeLink.prototype.alternativeLink = 'http://what.ever';

    AbstractAppSchemeLink.prototype.redirectHTPP = 'what_ever_redirect_http';

    AbstractAppSchemeLink.prototype.redirectApp = 'what_ever_redirect_app';

    AbstractAppSchemeLink.prototype.settings = {
      delay: 5000,
      delta: 500
    };

    function AbstractAppSchemeLink(el) {
      this.openAppStore = bind(this.openAppStore, this);
      this.open = bind(this.open, this);
      this.el = $(el);
      this.el.on('click', (function(_this) {
        return function() {
          return _this.open();
        };
      })(this));
    }

    AbstractAppSchemeLink.prototype.open = function() {
      var timeout;
      if (!this.disableAutomaticStoreRedirect()) {
        timeout = setTimeout(this.openAppStore(Date.now()), this.settings.delay);
      }
      return window.location.href = this.schemeLink;
    };

    AbstractAppSchemeLink.prototype.openAppStore = function(ts) {
      return (function(_this) {
        return function() {
          var wait;
          wait = _this.settings.delay + _this.settings.delta;
          if ((Date.now() - ts) < wait) {
            return window.location.href = _this.alternativeLink;
          }
        };
      })(this);
    };

    AbstractAppSchemeLink.prototype.disableAutomaticStoreRedirect = function() {
      var uagent;
      uagent = navigator.userAgent;
      if (uagent.indexOf('Twitter') !== -1) {
        return true;
      }
      if (uagent.indexOf('FBAN/MessengerForiOS') !== -1) {
        return true;
      }
      return false;
    };

    AbstractAppSchemeLink.prototype.getScheme = function() {
      var m;
      m = this.schemeLink.match(/^(\w+):\/\//);
      if (m.length) {
        return m[1];
      } else {
        return void 0;
      }
    };

    return AbstractAppSchemeLink;

  })();

}).call(this);
(function() {
  widgets.AppLink = {
    get: function(permalink) {
      if (GlobalState.PLATFORM.isWindophone()) {
        return "coubwp://view/" + permalink;
      } else if (GlobalState.PLATFORM.isIos()) {
        return "coub://view/" + permalink;
      } else if (GlobalState.PLATFORM.isAndroid()) {
        return "https://w3jvk.app.goo.gl/?link=http://coub.com/view/" + permalink + "&apn=com.coub.android&ibi=com.coub.app&ius=coub&isi=714042522&at=10l5bB&efr=1";
      } else {
        return "";
      }
    },
    getStore: function() {
      if (GlobalState.PLATFORM.isIos()) {
        return "itms-apps://itunes.apple.com/app/coub/id714042522";
      } else if (GlobalState.PLATFORM.isAndroid()) {
        return "https://play.google.com/store/apps/details?id=com.coub.android";
      } else {
        return "";
      }
    },
    constructIn: function($container) {
      return $('[app-link]', $container).each(function() {
        var $link, link, match, permalink;
        $link = $(this);
        permalink = $link.attr('data-coub-permalink');
        if (!permalink && GlobalState.PLATFORM.isAndroid() && (match = window.location.pathname.match(/(view|embed)\/([a-zA-Z0-9]+)/))) {
          permalink = match[2];
        }
        link = permalink ? widgets.AppLink.get(permalink) : widgets.AppLink.getStore();
        if (link) {
          return $link.attr('href', link);
        } else {
          return $link.remove();
        }
      });
    }
  };

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.Autocomplete = (function() {
    function Autocomplete(opts) {
      this.hide = bind(this.hide, this);
      this.show = bind(this.show, this);
      this.updatePosition = bind(this.updatePosition, this);
      this.renderChoices = bind(this.renderChoices, this);
      this.getPopup = bind(this.getPopup, this);
      this.render = bind(this.render, this);
      this.clearInitValue = bind(this.clearInitValue, this);
      this.restoreInitValue = bind(this.restoreInitValue, this);
      this.saveInitValue = bind(this.saveInitValue, this);
      this.navigateAutocomplete = bind(this.navigateAutocomplete, this);
      this.onKey = bind(this.onKey, this);
      this.select = opts.select;
      this.source = opts.source;
      this.el = $(opts.el);
      $(this.el).bind("focus", this.clearInitValue);
      $(this.el).bind("blur", (function(_this) {
        return function() {
          return setTimeout(_this.hide, 100);
        };
      })(this));
      $(this.el).bind("keyup keydown", this.onKey);
    }

    Autocomplete.prototype.onKey = function(e) {
      switch (e.keyCode) {
        case $.ui.keyCode.UP:
        case $.ui.keyCode.DOWN:
          if (e.type === "keydown") {
            e.preventDefault();
            if (this.getPopup().is(":visible")) {
              if (e.keyCode === $.ui.keyCode.UP) {
                return this.navigateAutocomplete(-1);
              } else {
                return this.navigateAutocomplete(+1);
              }
            }
          }
          break;
        default:
          if (e.type === "keyup") {
            if ($(this.el).val() === "") {
              this.hide();
            } else if ((this.prevVal == null) || this.prevVal !== $(this.el).val()) {
              this.source($(this.el).val(), this.renderChoices);
            }
            return this.prevVal = $(this.el).val();
          }
      }
    };

    Autocomplete.prototype.navigateAutocomplete = function(offset) {
      var els, i, sel, select;
      els = this.getPopup().find("li");
      sel = els.filter(".active").first();
      select = (function(_this) {
        return function(el) {
          $(_this.el).val(el.text());
          sel.removeClass("active");
          return el.addClass("active");
        };
      })(this);
      if (sel.size() > 0) {
        i = els.index(sel) + offset;
        if (i >= 0 && i < els.length) {
          return select($(els[i]));
        } else {
          this.restoreInitValue();
          return sel.removeClass("active");
        }
      } else {
        this.saveInitValue();
        if (offset > 0) {
          return select(els.first());
        } else {
          return select(els.last());
        }
      }
    };

    Autocomplete.prototype.saveInitValue = function() {
      return $(this.el).attr("init-value", $(this.el).val());
    };

    Autocomplete.prototype.restoreInitValue = function() {
      $(this.el).val($(this.el).attr("init-value"));
      return this.clearInitValue();
    };

    Autocomplete.prototype.clearInitValue = function() {
      return $(this.el).removeAttr("init-value");
    };

    Autocomplete.prototype.render = function() {
      var el;
      el = $(JST['app/site/templates/widgets/absolute_dropdown/absolute_dropdown']({
        content: void 0,
        classes: 'dropdown--autocomplete -fixed -below'
      }));
      el.hide();
      el.css({
        'z-index': 2000002
      });
      $("body").append(el);
      return this.popup = el;
    };

    Autocomplete.prototype.getPopup = function() {
      if (this.popup == null) {
        this.render();
      }
      return this.popup;
    };

    Autocomplete.prototype.renderChoices = function(choices) {
      var list;
      if (choices.length > 0 && $(this.el).val() !== "") {
        list = $(JST["app/site/templates/widgets/dropdown/list"]({
          choices: choices,
          type: "",
          attrs: 'data-scroll-type="vertical"',
          classes: 'niceScroller'
        })).nice_scroller();
        this.getPopup().find(".dropdown__content").html(list);
        this.updatePosition();
        this.show();
        return $("li", this.getPopup()).bind("click", (function(_this) {
          return function(e) {
            var v;
            v = $(e.currentTarget).text();
            _this.select(e, {
              item: {
                value: v
              }
            });
            _this.hide();
            return _this.el.focus();
          };
        })(this));
      } else {
        return this.hide();
      }
    };

    Autocomplete.prototype.updatePosition = function() {
      var o, shift;
      o = $(this.el).offset();
      shift = 35;
      return this.getPopup().css({
        left: o.left,
        top: o.top + $(this.el).height() + shift - $(window).scrollTop()
      });
    };

    Autocomplete.prototype.show = function() {
      $(this.el).data("autocomplete-open", true);
      return this.getPopup().removeClass('-hidden').show();
    };

    Autocomplete.prototype.hide = function() {
      $(this.el).data("autocomplete-open", false);
      return this.getPopup().addClass('-hidden').hide();
    };

    return Autocomplete;

  })();

}).call(this);
(function() {
  window.EditorCategories = (function() {
    EditorCategories.ATTR_NAME = "widget-editor-categories";

    function EditorCategories(el) {
      var data;
      this.el = el;
      this.button = $(".sb.-sq", this.el);
      this.coubId = $(this.el).attr('data-coub-id');
      data = JSON.parse($('.data', this.el).html());
      this.categories = data.available;
      $("[name=categories]", this.el).val(data.taken.map(function(c) {
        return c.title;
      }).join(',')).tagit({
        tagLimit: 1,
        allowSpaces: true,
        allowDuplicates: false,
        useCoubAutocomplete: true,
        placeholderText: "Add category",
        autocomplete: {
          source: (function(_this) {
            return function(search, showChoices) {
              var matched;
              matched = _this.categoriesMatcher(search.toLowerCase());
              return showChoices(_.pluck(matched, 'title'));
            };
          })(this)
        },
        beforeTagAdded: (function(_this) {
          return function(e, ui) {
            var category;
            category = _.find(_this.categories, function(c) {
              return c.title === ui.tagLabel;
            });
            if (!category) {
              return false;
            }
            return ui.tag.attr('data-id', category.id);
          };
        })(this),
        afterTagAdded: (function(_this) {
          return function() {
            return _this.button.addClass('stateChanged');
          };
        })(this)
      });
      $('ul.ui-widget-content', this.el).addClass('input-field -sq').on('click', '.tagit-choice', (function(_this) {
        return function(e) {
          $(e.currentTarget).remove();
          return _this.button.addClass('stateChanged');
        };
      })(this));
      this.button.removeClass('stateChanged').click(this.submit.bind(this));
    }

    EditorCategories.prototype.categoriesMatcher = function(search) {
      return this.categories.filter(function(category) {
        return category.title.toLowerCase().indexOf(search) !== -1;
      });
    };

    EditorCategories.prototype.submit = function() {
      var category_ids;
      this.showLoader();
      category_ids = $('ul.ui-widget-content .tagit-choice', this.el).map(function() {
        return $(this).attr('data-id');
      }).toArray();
      return $.put(Routes.update_categories_editor_coub_path(this.coubId), {
        categories: category_ids
      }).done((function(_this) {
        return function() {
          _this.button.removeClass('stateChanged');
          return _this.hideLoader();
        };
      })(this)).fail((function(_this) {
        return function() {
          _this.hideLoader();
          return ErrorMessages.internalServerError();
        };
      })(this));
    };

    EditorCategories.prototype.showLoader = function() {
      return LoadRotator.appendWithOverlayAndStart(this.el);
    };

    EditorCategories.prototype.hideLoader = function() {
      return LoadRotator.removeWithOverlay(this.el);
    };

    return EditorCategories;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.EditorRecouber = (function() {
    EditorRecouber.ATTR_NAME = "widget-editor-channel-recouber";

    function EditorRecouber(el) {
      this.el = el;
      this.hideLoader = bind(this.hideLoader, this);
      this.showLoader = bind(this.showLoader, this);
      this.removeFromAvailabe = bind(this.removeFromAvailabe, this);
      this.addToAvailable = bind(this.addToAvailable, this);
      this.recoubToChosen = bind(this.recoubToChosen, this);
      this.editorChannels = $(".editor-recouber__data", this.el);
      this.button = $(".sb.-sq", this.el);
      this.channelsWithRecoubs = $("ul.list--inline", this.el);
      this.hash = JSON.parse(this.editorChannels.html());
      this.normalizeHash(this.hash);
      this.availableChannels = [];
      this.coubId = $(this.el).attr('data-coub-id');
      this.fetchTitles(this.hash);
      $(".editor-recouber__tags", this.el).tagit({
        allowSpaces: true,
        allowDuplicates: false,
        useCoubAutocomplete: true,
        autocomplete: {
          source: (function(_this) {
            return function(search, showChoices) {
              var filtered, search_lowered;
              search_lowered = search.toLowerCase();
              filtered = _this.availableChannels.filter(function(v) {
                return v.toLowerCase().indexOf(search_lowered) !== -1;
              });
              return showChoices(filtered);
            };
          })(this)
        },
        beforeTagAdded: (function(_this) {
          return function(e, ui) {
            return _this.availableChannels.indexOf(ui.tagLabel) !== -1;
          };
        })(this),
        onTagClicked: function(e, ui) {
          return $(this).tagit('removeTag', ui.tag);
        }
      });
      $('.ui-widget-content', this.el).addClass('input-field -sq');
      $('ul.list--inline', this.el).off('click').on('click', 'li', (function(_this) {
        return function(e) {
          return _this.unrecoubFromChannel(e.currentTarget);
        };
      })(this));
      this.button.off('click').on('click', this.recoubToChosen);
    }

    EditorRecouber.prototype.recoubToChosen = function() {
      var chosen_titles, data, error, permalinks, success;
      chosen_titles = $(".editor-recouber__tags", this.el).tagit('assignedTags');
      permalinks = this.fetchPermalinks(chosen_titles, this.hash);
      data = {
        channels_permalinks: permalinks,
        delayed: this.getDelayedPublishFlag()
      };
      success = (function(_this) {
        return function(resp) {
          _this.button.toggleClass('stateChanged', !_.isEmpty(resp.editors_channels));
          _this.addToChannelsWithRecoubs(resp.editors_channels);
          return _this.hideLoader();
        };
      })(this);
      error = (function(_this) {
        return function(resp) {
          _this.hideLoader();
          return ErrorMessages.internalServerError();
        };
      })(this);
      this.showLoader();
      return $.post(Routes.add_to_editorial_channels_editor_coub_path(this.coubId), data).done(success).fail(error);
    };

    EditorRecouber.prototype.unrecoubFromChannel = function(listEl) {
      var error, permalink, success;
      permalink = $(listEl).attr('data-permalink');
      success = (function(_this) {
        return function(resp) {
          _this.hideLoader();
          _this.addToAvailable(resp.editors_channels);
          $(listEl).remove();
          return _this.button.toggleClass('stateChanged', !!_this.channelsWithRecoubs.find('li').length);
        };
      })(this);
      error = (function(_this) {
        return function(resp) {
          _this.hideLoader();
          return ErrorMessages.internalServerError();
        };
      })(this);
      this.showLoader();
      return $.del(Routes.remove_from_editorial_channels_editor_coub_path(this.coubId), {
        channels_permalinks: [permalink]
      }).done(success).fail(error);
    };

    EditorRecouber.prototype.fetchPermalinks = function(titles, permalinks_hash) {
      return _.chain(permalinks_hash).invert().pick(titles).values().value();
    };

    EditorRecouber.prototype.fetchTitles = function(permalinks_hash) {
      return this.availableChannels = _.values(permalinks_hash);
    };

    EditorRecouber.prototype.addToChannelsWithRecoubs = function(permalinks_hash) {
      $(".editor-recouber__tags", this.el).tagit('removeAll');
      this.removeFromAvailabe(permalinks_hash);
      return _.each(permalinks_hash, (function(_this) {
        return function(title, permalink) {
          return _this.channelsWithRecoubs.append(_this.getListItemTemplate(permalink, title));
        };
      })(this));
    };

    EditorRecouber.prototype.addToAvailable = function(permalinks_hash) {
      this.normalizeHash(permalinks_hash);
      _.extend(this.hash, permalinks_hash);
      return this.fetchTitles(this.hash);
    };

    EditorRecouber.prototype.removeFromAvailabe = function(permalinks_hash) {
      this.hash = _.omit(this.hash, _.keys(permalinks_hash));
      return this.fetchTitles(this.hash);
    };

    EditorRecouber.prototype.normalizeHash = function(permalinks_hash) {
      return _.each(permalinks_hash, function(v, k) {
        return permalinks_hash[k] = v.trim();
      });
    };

    EditorRecouber.prototype.showLoader = function() {
      return LoadRotator.appendWithOverlayAndStart(this.el);
    };

    EditorRecouber.prototype.hideLoader = function() {
      return LoadRotator.removeWithOverlay(this.el);
    };

    EditorRecouber.prototype.getDelayedPublishFlag = function() {
      return $('input.editor-recouber__delayed', this.el).prop('checked');
    };

    EditorRecouber.prototype.getListItemTemplate = function(permalink, title) {
      return $("<li/>", {
        "class": 'list__item -color--emperor',
        text: title
      }).attr('data-permalink', permalink);
    };

    return EditorRecouber;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.BlackDrop = (function() {
    function BlackDrop(els) {
      if (els == null) {
        els = [];
      }
      this.position = bind(this.position, this);
      this.bds = els;
      this.dropEls = $.map(this.bds, function(bd) {
        return bd.el.get(0);
      });
      this.blackdrop = this.getBlackDrop(this.bds);
      this.showed = false;
    }

    BlackDrop.prototype.show = function() {
      if (this.showed) {
        throw 'widgets.BlackDrop: you can\'t attach blackdrop';
      }
      $(this.dropEls).addClass('blackdrop__element');
      return this.position(this.getBlackDrop(this.opts).appendTo('body'));
    };

    BlackDrop.prototype.clean = function() {
      if (!this.showed) {
        throw 'widgets.BlackDrop: you can\'t clean blackdrop';
      }
      this.blackdrop.removeClass('showed');
      return setTimeout((function(_this) {
        return function() {
          $(_this.dropEls).removeClass('blackdrop__element');
          _this.blackdrop.remove();
          return _this.showed = false;
        };
      })(this), 100);
    };

    BlackDrop.prototype.toggle = function() {
      if (this.showed) {
        return this.clean();
      } else {
        return this.show();
      }
    };

    BlackDrop.prototype.position = function(template) {
      var bd, i, j, len, props, ref;
      ref = this.bds;
      for (i = j = 0, len = ref.length; j < len; i = ++j) {
        bd = ref[i];
        props = {};
        props.width = bd.el.outerWidth();
        props.height = bd.el.outerHeight();
        props.top = bd.el.offset().top;
        props.left = bd.el.offset().left;
        $(template.find('.blackdrop__helper')[i]).css({
          width: props.width,
          height: props.height,
          left: props.left,
          top: props.top
        });
      }
      return setTimeout((function(_this) {
        return function() {
          template.addClass('showed');
          return _this.showed = true;
        };
      })(this), 100);
    };

    BlackDrop.prototype.getBlackDrop = function(els) {
      if (els == null) {
        els = [];
      }
      if (this.blackdrop != null) {
        return this.blackdrop;
      }
      return $(JST["app/site/templates/widgets/black_drop/black_drop"]({
        els: els
      }));
    };

    BlackDrop.construct = function(els) {
      if (els == null) {
        els = [];
      }
      if ($('.blackdrop__helper:visible').length) {
        throw 'widgets.BlackDrop: Oops! You\'ve already attached one';
      }
      return new widgets.BlackDrop(els);
    };

    return BlackDrop;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.CategoriesSelector = (function() {
    CategoriesSelector.prototype.CATEGORIES_LIMIT = 1;

    function CategoriesSelector(el1) {
      this.el = el1;
      this.exclude = bind(this.exclude, this);
      new utils.ObservableMixin(this);
      this.selectedCategories = [];
      $('.community__item.-active', this.el).each((function(_this) {
        return function(i, el) {
          return _this.selectedCategories.push($(el).attr('data-community-id'));
        };
      })(this));
      $('.communities__container', this.el).nice_scroller();
      $(window).resize(_.debounce((function(_this) {
        return function() {
          return $('.communities__container', _this.el).filter(":visible").nice_scroller();
        };
      })(this), 100));
      $('.community__item', this.el).click((function(_this) {
        return function(e) {
          var c, category, i, item;
          item = $(e.currentTarget);
          if (item.hasClass('-disabled')) {
            return;
          }
          category = item.attr("data-community-id");
          item.toggleClass('-active');
          if (item.hasClass('-active')) {
            if (_this.selectedCategories.length === _this.CATEGORIES_LIMIT) {
              c = _this.selectedCategories.shift();
              $(".community__item[data-community-id='" + c + "']", _this.el).removeClass('-active');
            }
            if (category) {
              _this.selectedCategories.push(category);
            }
          } else if ((i = _this.selectedCategories.indexOf(category)) !== -1) {
            _this.selectedCategories.splice(i, 1);
          }
          return _this.trigger('selected', _this.selectedCategories);
        };
      })(this));
    }

    CategoriesSelector.prototype.exclude = function(categories) {
      var c, i, j, len, results;
      results = [];
      for (j = 0, len = categories.length; j < len; j++) {
        c = categories[j];
        i = $(".community__item[data-community-id='" + c + "']", this.el);
        if (!i.hasClass('-active')) {
          results.push(i.addClass('-disabled'));
        } else {
          results.push(void 0);
        }
      }
      return results;
    };

    CategoriesSelector.prototype.getSelected = function() {
      return this.selectedCategories;
    };

    return CategoriesSelector;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.Controlable = (function(superClass) {
    extend(Controlable, superClass);

    function Controlable(opts) {
      if (opts == null) {
        opts = {};
      }
      this.onKeydown = bind(this.onKeydown, this);
      if (opts.listenOn) {
        this.listenOn = opts.listenOn;
      }
      if (opts.handleFn != null) {
        this.handleFn = opts.handleFn;
      } else {
        this.handleFn = (function(_this) {
          return function() {
            return null;
          };
        })(this);
      }
      Controlable.__super__.constructor.apply(this, arguments);
    }

    Controlable.prototype.onKeydown = function(e) {
      return this.handleFn(e);
    };

    return Controlable;

  })(AbstractControlable);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.CountriesSelector = (function() {
    CountriesSelector.EVENTS = {
      CHANGE: 'CountriesSelector::Events::Change'
    };

    function CountriesSelector(el, opts) {
      var cc, code, i, len;
      this.el = el;
      this.opts = opts;
      this.onCountryXClick = bind(this.onCountryXClick, this);
      this.onBlur = bind(this.onBlur, this);
      this.onFocus = bind(this.onFocus, this);
      this.onKeyUp = bind(this.onKeyUp, this);
      this.onKeyDown = bind(this.onKeyDown, this);
      new utils.ObservableMixin(this);
      this.s = this.constructor;
      this.dropdown = $(JST['app/site/templates/widgets/absolute_dropdown/absolute_dropdown']({
        content: void 0,
        classes: 'dropdown--autocomplete -fixed -below'
      }));
      this.dropdown.css({
        'z-index': 2000002
      });
      $("body").append(this.dropdown);
      this.dropdownContent = $('.dropdown__content', this.dropdown);
      this.input = $('> input', this.el);
      this.placeholder = $('.placeholder', this.el);
      this.input.focus(this.onFocus);
      this.input.blur(this.onBlur);
      this.input.keydown(this.onKeyDown);
      this.input.keyup(this.onKeyUp);
      this.el.on('click', '.country-item svg', this.onCountryXClick);
      if (cc = this.opts.value) {
        this.input.addClass('-hidden');
        this.dropdown.remove();
        for (i = 0, len = cc.length; i < len; i++) {
          code = cc[i];
          this.addCountry(code);
        }
      }
    }

    CountriesSelector.prototype.addCountry = function(countryCode) {
      var template;
      template = $(this.getCountryTemplate(countryCode, this.opts.tagName));
      if ($('.country-item', this.el).length) {
        $('.country-item', this.el).last().after(template);
      } else {
        this.el.prepend(template);
        this.placeholder.addClass('-hidden');
      }
      this.input.val('');
      this.renderChoices();
      return this.trigger(this.s.EVENTS.CHANGE);
    };

    CountriesSelector.prototype.removeCountry = function(countryCode) {
      $(".country-item[data-country-code=" + countryCode + "]", this.el).remove();
      if (!$('.country-item', this.el).length) {
        this.placeholder.removeClass('-hidden');
      }
      return this.trigger(this.s.EVENTS.CHANGE);
    };

    CountriesSelector.prototype.removeLastCountry = function() {
      var countryCode;
      countryCode = $('.country-item', this.el).last().attr('data-country-code');
      return countryCode && this.removeCountry(countryCode);
    };

    CountriesSelector.prototype.renderChoices = function() {
      var choices, items, possibleCountries, searchStr, selectedCountries;
      this.destroyCountriesList();
      searchStr = this.input.val();
      this.placeholder.toggleClass('-hidden', $('.country-item', this.el).length > 0 || searchStr !== "");
      selectedCountries = $('.country-item', this.el).map(function() {
        return $(this).attr('data-country-code');
      }).get();
      possibleCountries = _.difference(this.opts.availableCountries, selectedCountries);
      choices = possibleCountries.filter((function(_this) {
        return function(c) {
          return I18n.t("countries." + c).toLowerCase().indexOf(searchStr.toLowerCase()) !== -1;
        };
      })(this));
      if (!choices.length) {
        this.hideDropdown();
        return;
      }
      choices = choices.map(function(c) {
        return {
          value: I18n.t("countries." + c),
          attr: c
        };
      }).sort(function(a, b) {
        if (a.value > b.value) {
          return 1;
        } else if (a.value < b.value) {
          return -1;
        } else {
          return 0;
        }
      });
      this.list = $(JST["app/site/templates/widgets/dropdown/list"]({
        choices: choices,
        type: "",
        attrs: 'data-scroll-type="vertical"',
        classes: 'niceScroller'
      }));
      items = $('li', this.list);
      items.first().addClass('active');
      this.list.on("mousedown", "li", (function(_this) {
        return function(e) {
          _this.addCountry($(e.currentTarget).attr('data-attr'));
          return _this.hideDropdown();
        };
      })(this));
      this.dropdownContent.html(this.list);
      this.showDropdown();
      return this.list.nice_scroller({
        forceInit: true
      });
    };

    CountriesSelector.prototype.updateDropdownPosition = function() {
      var o, shift;
      o = $(this.input).offset();
      shift = 0;
      return this.dropdown.css({
        left: o.left,
        top: o.top + $(this.input).height() + shift - $(window).scrollTop()
      });
    };

    CountriesSelector.prototype.showDropdown = function() {
      this.updateDropdownPosition();
      return this.dropdown.removeClass('-hidden');
    };

    CountriesSelector.prototype.hideDropdown = function() {
      return this.dropdown.addClass('-hidden');
    };

    CountriesSelector.prototype.navigateDropdown = function(pos) {
      var container, currentItem, currentPos, itemTop, items, nextPos, scrollTop;
      items = $('li', this.dropdownContent);
      currentPos = items.filter('.active').index();
      nextPos = currentPos + pos;
      if (nextPos < 0 || nextPos >= items.length) {
        return;
      }
      items.removeClass('active').eq(nextPos).addClass('active');
      currentItem = items.filter('.active');
      container = $('.antiscroll-inner', this.dropdownContent);
      itemTop = currentItem.position().top;
      scrollTop = container.scrollTop();
      if (itemTop < scrollTop) {
        return container.scrollTop(itemTop);
      } else if (itemTop + currentItem.outerHeight() > scrollTop + this.dropdownContent.height()) {
        return container.scrollTop(itemTop + currentItem.outerHeight() - this.dropdownContent.height());
      }
    };

    CountriesSelector.prototype.onKeyDown = function(e) {
      switch (e.keyCode) {
        case 38:
          e.preventDefault();
          return this.navigateDropdown(-1);
        case 40:
          e.preventDefault();
          return this.navigateDropdown(1);
        case 13:
          e.preventDefault();
          return this.addCountry($('li.active', this.dropdownContent).attr('data-attr'));
        case 8:
          if (this.input.val() === "") {
            return this.removeLastCountry();
          }
      }
    };

    CountriesSelector.prototype.onKeyUp = function(e) {
      if ([38, 40, 13].indexOf(e.keyCode) !== -1) {
        return;
      }
      return this.renderChoices();
    };

    CountriesSelector.prototype.onFocus = function() {
      return this.renderChoices();
    };

    CountriesSelector.prototype.onBlur = function() {
      return setTimeout((function(_this) {
        return function() {
          return _this.hideDropdown();
        };
      })(this), 50);
    };

    CountriesSelector.prototype.onCountryXClick = function(e) {
      return this.removeCountry($(e.currentTarget).closest('.country-item').attr('data-country-code'));
    };

    CountriesSelector.prototype.destroyCountriesList = function() {
      if (this.list) {
        this.list.off('mousedown');
        return this.list.remove();
      }
    };

    CountriesSelector.prototype.destroy = function() {
      this.destroyCountriesList();
      return this.dropdown.remove();
    };

    CountriesSelector.prototype.getCountryTemplate = function(countryCode, inputTagName) {
      var countryTitle;
      countryTitle = I18n.t("countries." + countryCode);
      return "<div class=\"country-item\" data-country-code=\"" + countryCode + "\">\n  <span>" + countryTitle + "</span>\n  " + (JST["app/site/templates/svg/icons/16/close"]()) + "\n  <input type=\"hidden\" name=\"" + inputTagName + "\" value=\"" + countryCode + "\" />\n</div>";
    };

    return CountriesSelector;

  })();

}).call(this);

/*
   Меню с выбором страны и языка
 */

(function() {
  widgets.CountrySelector = (function() {
    CountrySelector.ATTR_NAME = "widget-country-selector";

    function CountrySelector(el) {
      var content, handler;
      this.el = el;
      handler = $('.handler', this.el);
      content = $('.content', this.el).removeClass('-hidden').detach();
      this.dropdown = new window.HoverableAbsoluteDropdown({
        el: this.el,
        classNames: "country-selector-dropdown",
        defaultContent: content,
        handle: handler,
        handlerEventOpen: "click",
        dropdownPosition: AbsoluteDropdown.POSITION_TYPE.ABSOLUTE_TOP_OR_BOTTOM_CLOSE,
        animationDuration: 1
      });
      $('.list__item', content).click(function(e) {
        var countryCode, target;
        target = $(e.currentTarget);
        if (target.hasClass('active')) {
          return;
        }
        countryCode = target.attr('data-code');
        return $.put(Routes.update_regular_info_api_v2_users_path(), {
          user: {
            current_country: countryCode
          }
        }).done(function() {
          return location.reload();
        });
      });
    }

    return CountrySelector;

  })();

}).call(this);
(function() {
  widgets.LocaleSelector = (function() {
    LocaleSelector.ATTR_NAME = "widget-locale-selector";

    function LocaleSelector(el) {
      $('.list__item', el).click(function(e) {
        $.cookie('locale', $(this).attr('data-code'), {
          path: '/',
          expires: 365
        });
        return location.reload();
      });
    }

    return LocaleSelector;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.CustomSharingButton = (function() {
    CustomSharingButton.ATTR = "custom-sharing-button";

    function CustomSharingButton(el) {
      this.isDisabled = bind(this.isDisabled, this);
      this.track = bind(this.track, this);
      this.onClick = bind(this.onClick, this);
      this.init = bind(this.init, this);
      this.btn = $(el);
      this.init();
      this.provider = new SocialSharingDataProvider().getProviderByName(this.type);
      if (this.provider != null) {
        this.btn.on("click", this.onClick);
      } else {
        throw "CustomSharingButton: unknown button type " + this.type;
      }
    }

    CustomSharingButton.prototype.init = function() {
      this.type = this.btn.attr("data-custom-sharing");
      this.title = this.btn.attr("data-encoded-title");
      this.url = this.btn.attr("data-url");
      this.permalink = this.btn.attr("data-permalink");
      return this.img = this.btn.attr("data-img");
    };

    CustomSharingButton.prototype.onClick = function(e) {
      var from, h, left, obj, params, top, url, w;
      if (GlobalState.PAGE.isCoubPage()) {
        if (this.btn.parent().hasClass("coub__sharing__list")) {
          from = AmplitudeCoub.PROPS.FROM_COUB_CARD;
        } else {
          from = AmplitudeCoub.PROPS.FROM_PLAYER;
        }
        AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.SHARE.SHARE_SOCIAL, (
          obj = {},
          obj["" + AmplitudeCoub.PROPS.SOCIAL_SHARE_TARGET] = this.type,
          obj["" + from] = true,
          obj
        ));
      }
      if (this.isDisabled()) {
        return;
      }
      if (this.provider.onClick != null) {
        this.provider.onClick(e, this);
        return;
      }
      w = this.provider.popupW != null ? this.provider.popupW : 640;
      h = this.provider.popupH != null ? this.provider.popupH : 430;
      left = $(window).width() / 2 - w / 2;
      top = $(window).height() / 2 - h / 2;
      params = "menubar=no,toolbar=no,status=no,width=" + w + ",height=" + h + ",toolbar=no,left=" + left + ",top=" + top;
      if (this.url != null) {
        url = this.url;
      } else {
        url = Routes.view_coub_by_permalink_url(this.permalink);
      }
      window.open(this.provider.getPopupUrl(this.title, url, this.img), "_share_coub_" + this.type, params);
      return this.track();
    };

    CustomSharingButton.prototype.track = function() {
      return Stats.track('social_share', {
        sharing_destination: this.type,
        url: window.location.pathname,
        coubUrl: this.url
      });
    };

    CustomSharingButton.prototype.isDisabled = function() {
      return this.btn.hasClass("disabled");
    };

    CustomSharingButton.constructIn = function(container) {
      if (container == null) {
        container = $("body");
      }
      return container.find("[" + CustomSharingButton.ATTR + "]").each(function() {
        return new CustomSharingButton($(this));
      });
    };

    CustomSharingButton.getAttributes = function(provider, url, title, img) {
      var attrs;
      attrs = [CustomSharingButton.ATTR];
      attrs.push("data-custom-sharing='" + provider + "'");
      attrs.push("data-permalink='" + url + "'");
      attrs.push("data-encoded-title=\"" + (encodeURIComponent(title)) + "\"");
      attrs.push("data-img='" + img + "'");
      return attrs.join(" ");
    };

    CustomSharingButton.getAttributesForCoub = function(provider, coub) {
      var img, imgVersion;
      if (provider === SocialSharingDataProvider.TYPES.PINTEREST.NAME) {
        imgVersion = "pinterest";
      } else {
        imgVersion = "med";
      }
      img = helpers.Coub.getFileVersion(coub.image_versions, imgVersion);
      return CustomSharingButton.getAttributes(provider, coub.permalink, coub.title, img);
    };

    CustomSharingButton.attachTo = function(container, provider, coub, classes, active) {
      var r, t;
      if (classes == null) {
        classes = "";
      }
      if (active == null) {
        active = true;
      }
      t = JST["app/site/templates/coub_block/social_action_buttons/custom_sharing_button"];
      r = $(t({
        provider: provider,
        coub: coub,
        checkFacebook: false,
        active: active,
        classes: classes
      }));
      container.append(r);
      return CustomSharingButton.constructIn(container);
    };

    return CustomSharingButton;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.ShareCoubVideoButton = (function() {
    ShareCoubVideoButton.ATTR_NAME = "share-coub-video-button";

    function ShareCoubVideoButton(el) {
      this.el = el;
      this.onAuthError = bind(this.onAuthError, this);
      this.onSharingError = bind(this.onSharingError, this);
      this.onSharingDone = bind(this.onSharingDone, this);
      this.onAuthSuccess = bind(this.onAuthSuccess, this);
      this.onClick = bind(this.onClick, this);
      this.provider = new window.AuthDataProvider();
      this.kind = this.el.attr("data-provider");
      this.coubId = this.el.attr("data-coub-id");
      this.coubPermalink = this.el.attr("data-coub-permalink");
      this.coubTitle = this.el.attr("data-coub-title");
      this.coubImage = this.el.attr("data-img");
      this.isVideoStatusRequestNeeded = this.el.attr("data-has-video") == null;
      this.el.click(this.onClick);
    }

    ShareCoubVideoButton.prototype.onClick = function() {
      var kind;
      this.openSharingPopup();
      if (this.isVideoStatusRequestNeeded) {
        this.isVideoStatusRequestNeeded = false;
        $.get(Routes.share_video_status_api_v2_coub_path(this.coubPermalink));
      }
      kind = this.provider.KIND[this.kind.toUpperCase()];
      return this.loginFormWindow = this.provider.authorizeInProvider(kind, this.onAuthSuccess, this.onAuthError);
    };

    ShareCoubVideoButton.prototype.openSharingPopup = function() {
      $(document).trigger("flash_player:suspend");
      this.popup = CoubModal.createPopup({
        content: '',
        classes: "share-coub-video__popup " + this.kind
      });
      this.popupBody = $(".modal__body", this.popup.el);
      LoadIndicator.appendToContainer(this.popup.el, LoadIndicator.SIZE.BIG);
      return this.popup.el.one(window.Popup.EVENT_HIDED, (function(_this) {
        return function() {
          return _this.destroy();
        };
      })(this));
    };

    ShareCoubVideoButton.prototype.onAuthSuccess = function(result) {
      var popupData;
      LoadIndicator.removeFromContainer(this.popup.el);
      popupData = {
        provider: this.kind,
        defaultText: this.getDefaultMessage(),
        image: this.coubImage
      };
      this.popup.setContent(JST["app/site/templates/coub_block/social_action_buttons/share_video_popup"](popupData));
      this.textEl = $(".share-coub-video__popup__textarea", this.popup.el);
      this.errorMsgEl = $(".share-coub-video__popup__error-msg", this.popup.el);
      this.submitButton = $(".share-coub-video__popup__submit", this.popup.el);
      return this.submitButton.click((function(_this) {
        return function() {
          if (_this.textEl.val().length > 280) {
            return _this.togglePopupError(true);
          } else {
            return _this.share(result);
          }
        };
      })(this));
    };

    ShareCoubVideoButton.prototype.getDefaultMessage = function() {
      var i18nKey, lengthNoTitle, text, truncatedTitle, url;
      url = Routes.view_coub_by_permalink_url(this.coubPermalink);
      i18nKey = (function() {
        switch (this.kind) {
          case "twitter":
            return "coub.auto_post.twitter_message";
          case "vkontakte":
            return "coub.auto_post.message";
        }
      }).call(this);
      text = I18n.t(i18nKey, {
        url: url,
        title: this.coubTitle
      });
      if (text.length > 280) {
        lengthNoTitle = I18n.t(i18nKey, {
          url: url,
          title: ""
        }).length;
        truncatedTitle = this.coubTitle.substr(0, 280 - lengthNoTitle);
        text = I18n.t(i18nKey, {
          url: url,
          title: truncatedTitle
        });
      }
      return text;
    };

    ShareCoubVideoButton.prototype.togglePopupError = function(value) {
      this.textEl.toggleClass("error", value);
      this.errorMsgEl.toggleClass("-hidden", !value);
      this.submitButton.toggleClass("disabled", value);
      if (value) {
        return this.textEl.one("input", (function(_this) {
          return function() {
            return _this.togglePopupError(false);
          };
        })(this));
      }
    };

    ShareCoubVideoButton.prototype.share = function(authResult) {
      var data, url;
      if (this.isLoading) {
        return;
      }
      this.isLoading = true;
      this.popupBody.addClass("disabled");
      data = {
        token: authResult.token
      };
      if (this.kind === "twitter") {
        data.secret = authResult.secret;
      }
      data.message = this.textEl.val();
      url = (function() {
        switch (this.kind) {
          case "twitter":
            return Routes.share_video_to_twitter_api_v2_coub_path(this.coubId);
          case "vkontakte":
            return Routes.share_video_to_vkontakte_api_v2_coub_path(this.coubId);
        }
      }).call(this);
      return $.post(url, data).done(this.onSharingDone).fail(this.onSharingError).always((function(_this) {
        return function() {
          _this.isLoading = false;
          return _this.popupBody.removeClass("disabled");
        };
      })(this));
    };

    ShareCoubVideoButton.prototype.destroy = function() {
      this.loginFormWindow && this.loginFormWindow.close();
      if (this.popup) {
        this.popup.close();
        this.popup.el.off(window.Popup.EVENT_HIDED);
        this.popup.el.remove();
      }
      return $(document).trigger("flash_player:play");
    };

    ShareCoubVideoButton.prototype.onSharingDone = function(r) {
      return this.destroy();
    };

    ShareCoubVideoButton.prototype.onSharingError = function(e) {
      return Growl.msg(I18n.ERRORS.INTERNAL_SERVER_ERROR.SUB, I18n.ERRORS.INTERNAL_SERVER_ERROR.TRY_AGAIN);
    };

    ShareCoubVideoButton.prototype.onAuthError = function() {
      Growl.msg(I18n.ERRORS.AUTH_FAILED.HEADER, I18n.ERRORS.AUTH_FAILED.SUB);
      return this.destroy();
    };

    ShareCoubVideoButton.getAttrs = function(provider, coub) {
      var attrs, hasVideoForSharing, img;
      img = helpers.Coub.getFileVersion(coub.image_versions, "small");
      hasVideoForSharing = coub.file_versions && coub.file_versions.share && coub.file_versions.share["default"];
      attrs = [this.ATTR_NAME, "auto-init"];
      attrs.push("data-provider='" + provider + "'");
      attrs.push("data-coub-id='" + coub.id + "'");
      attrs.push("data-coub-permalink='" + coub.permalink + "'");
      attrs.push("data-coub-title='" + (utils.encodeQuotes(coub.title, true)) + "'");
      attrs.push("data-img='" + img + "'");
      if (hasVideoForSharing) {
        attrs.push("data-has-video");
      }
      return attrs.join(" ");
    };

    return ShareCoubVideoButton;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.DeleteCoubButton = (function() {
    DeleteCoubButton.ATTR_NAME = "widget-delete-coub-button";

    function DeleteCoubButton(el) {
      this.el = el;
      this.onDeleteSuccess = bind(this.onDeleteSuccess, this);
      this.xhrCompleted = bind(this.xhrCompleted, this);
      this.xhrBeforeSend = bind(this.xhrBeforeSend, this);
      this.onClick = bind(this.onClick, this);
      this.provider = new dataProviders.ApiV2();
      this.xhrLock = new chms.utils.Locker();
      this.permalink = this.el.attr("data-permalink");
      this.el.on('click', this.onClick);
    }

    DeleteCoubButton.prototype.onClick = function() {
      if (this.xhrLock.isLocked() || !window.confirm('Are you sure?')) {
        return;
      }
      return this.provider.deleteCoub(this.permalink, {
        beforeSend: this.xhrBeforeSend,
        complete: this.xhrCompleted,
        success: this.onDeleteSuccess,
        error: ErrorMessages.internalServerError
      });
    };

    DeleteCoubButton.prototype.xhrBeforeSend = function() {
      return this.xhrLock.lock();
    };

    DeleteCoubButton.prototype.xhrCompleted = function() {
      return this.xhrLock.unlock();
    };

    DeleteCoubButton.prototype.onDeleteSuccess = function() {
      var channel, id;
      if (GlobalState.PAGE.isCoubPage()) {
        id = Params.get("current_channel_id");
        channel = _.find(Params.getBranchValue('current_user.channels'), function(channel) {
          return channel.id === id;
        });
        return window.location = Routes.channel_path(channel.permalink);
      } else {
        return $(document).trigger(window.CoubBlockClientside.ACTION_DELETE, [this.permalink]);
      }
    };

    return DeleteCoubButton;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.DownloadCoubLoopsButton = (function() {
    DownloadCoubLoopsButton.ATTR_NAME = "widget-download-coub-loops";

    function DownloadCoubLoopsButton(el) {
      this.onClick = bind(this.onClick, this);
      el.on('click', this.onClick);
    }

    DownloadCoubLoopsButton.prototype.onClick = function(e) {
      var coub_permalink, loops;
      loops = window.prompt("How many loops to download?", 2);
      if (!loops) {
        return;
      }
      if (loops > 5) {
        return alert("max 5 loops");
      }
      coub_permalink = $(e.currentTarget).attr("data-permalink");
      return window.open(Routes.download_editor_coub_path(coub_permalink, {
        loops: loops
      }), "_blank");
    };

    return DownloadCoubLoopsButton;

  })();

}).call(this);

/*
  Кнопка скачать видео коба, юзается в том числе и в эмбеде
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.DownloadCoubVideoButton = (function() {
    DownloadCoubVideoButton.ATTR_NAME = "widget-download-coub-video";

    function DownloadCoubVideoButton(el) {
      this.el = el;
      this.onClick = bind(this.onClick, this);
      this.permalink = this.el.attr("data-permalink");
      this.isPlayer = this.el.hasClass("-player");
      this.el.on("click", this.onClick);
    }

    DownloadCoubVideoButton.prototype.onClick = function(e) {
      e.preventDefault();
      return this.loadStatus();
    };

    DownloadCoubVideoButton.prototype.loadStatus = function() {
      this.startLoadingAnimation();
      return $.get("/api/v2/coubs/" + this.permalink + "/share_video_status").fail((function(_this) {
        return function(e) {
          _this.stopLoadingAnimation();
          return console.error("widgets.DownloadCoubVideoButton LoadError", e);
        };
      })(this)).done((function(_this) {
        return function(r) {
          if (r.status === "ready") {
            _this.stopLoadingAnimation();
            return _this.downloadFile(r.url + "?dl=1");
          } else {
            return setTimeout(function() {
              return _this.loadStatus();
            }, 5000);
          }
        };
      })(this));
    };

    DownloadCoubVideoButton.prototype.startLoadingAnimation = function() {
      if (this.isLoading) {
        return;
      }
      this.isLoading = true;
      this.el.addClass("-loading");
      if (this.isPlayer) {
        return $("> span", this.el).text(I18n.embed.sharing.loading);
      } else {
        $("> i", this.el).addClass("-hidden");
        return LoadIndicator.appendToContainer(this.el, LoadIndicator.SIZE.SMALL);
      }
    };

    DownloadCoubVideoButton.prototype.stopLoadingAnimation = function() {
      this.isLoading = false;
      this.el.removeClass("-loading");
      if (this.isPlayer) {
        return $("> span", this.el).text(I18n.embed.sharing.download);
      } else {
        $("> i", this.el).removeClass("-hidden");
        return LoadIndicator.removeFromContainer(this.el);
      }
    };

    DownloadCoubVideoButton.prototype.downloadFile = function(url) {
      return this.el.off("click").attr("href", url).get(0).click();
    };

    return DownloadCoubVideoButton;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.GenderSelect = (function() {
    function GenderSelect(opts) {
      this.reset = bind(this.reset, this);
      this.highlightChangedGender = bind(this.highlightChangedGender, this);
      this.selectGender = bind(this.selectGender, this);
      this.container = $(opts.el);
      this.input = $("input.gender-input", this.container);
      this.input.on('change', this.highlightChangedGender);
      $('.sb', this.container).click(this.selectGender);
    }

    GenderSelect.prototype.selectGender = function(e) {
      var el;
      this.container.removeClass('error');
      this.container.find('.sb').removeClass('active');
      el = $(e.currentTarget);
      this.input.val(el.attr('data-val'));
      return el.addClass('active');
    };

    GenderSelect.prototype.highlightChangedGender = function() {
      var el, val;
      val = this.input.val();
      el = this.container.find(".sb[data-val=" + val + "]");
      return this.selectGender({
        currentTarget: el.get(0)
      });
    };

    GenderSelect.prototype.reset = function() {
      $(".active").removeClass("active");
      return this.input.val("");
    };

    return GenderSelect;

  })();

}).call(this);
(function() {
  window.ErrorMessages = {
    ajaxCallServerError: function(e) {
      if (e.statusText === "abort") {
        return;
      }
      return ErrorMessages.internalServerError();
    },
    internalServerError: function() {
      Growl.msg(I18n.ERRORS.INTERNAL_SERVER_ERROR.SUB, I18n.ERRORS.INTERNAL_SERVER_ERROR.TRY_AGAIN);
      return console.error("api call failed");
    }
  };

}).call(this);
(function() {
  window.Growl = {
    TIMING: {
      ANIMATION: 250,
      REMOVE: 5000
    },
    msg: function(heading, description, className) {
      var growl, options;
      if (className == null) {
        className = '';
      }
      options = {
        className: className,
        heading: heading,
        description: description
      };
      $('.tooltip--growl').remove();
      growl = this.get(options).appendTo('body');
      return this.show(growl);
    },
    get: function(opts) {
      return $(JST["app/site/templates/widgets/tooltip/growl"](opts));
    },
    succ: function(heading, description) {
      return this.msg(heading, description || '', '-success');
    },
    show: function(growl) {
      Stats.track('growl_showed');
      requestAnimationFrame(function() {
        return growl.addClass('-showed');
      });
      growl.one('click', (function(_this) {
        return function() {
          return _this.hide(growl);
        };
      })(this));
      return setTimeout(function(g) {
        return Growl.hide(g);
      }, this.TIMING.REMOVE, growl);
    },
    hide: function(growl) {
      requestAnimationFrame(function() {
        return growl.removeClass('-showed');
      });
      return setTimeout(function(g) {
        return g.remove();
      }, this.TIMING.ANIMATION, growl);
    }
  };

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.Incrementor = (function(superClass) {
    extend(Incrementor, superClass);

    Incrementor.EVENT_SELECTED = "Incrementor:Selected";

    function Incrementor(opts) {
      if (opts == null) {
        opts = {};
      }
      this.getSelected = bind(this.getSelected, this);
      this.setCollection = bind(this.setCollection, this);
      this.getCollection = bind(this.getCollection, this);
      this.select = bind(this.select, this);
      this.onKeydown = bind(this.onKeydown, this);
      Incrementor.__super__.constructor.apply(this, arguments);
      if ((opts != null) && opts.collection) {
        this.setCollection(opts.collection);
      } else {
        throw "Incrementor: require opts.collection in order to work";
      }
    }

    Incrementor.prototype.onKeydown = function(e) {
      var nextItem, prevItem, selected;
      if (e.keyCode === Utils.KEY_CODES.DOWN || e.keyCode === Utils.KEY_CODES.UP) {
        e.preventDefault();
        switch (e.keyCode) {
          case Utils.KEY_CODES.DOWN:
            if (!this.collection.isLastItemOnCollection(selected = this.getSelected())) {
              nextItem = this.collection.getNextItem(selected);
              if (nextItem == null) {
                nextItem = this.collection.getFirstItem();
              }
              return this.select(nextItem);
            }
            break;
          case Utils.KEY_CODES.UP:
            if (!this.collection.isFirstItemOnCollection(selected = this.getSelected())) {
              prevItem = this.collection.getPrevItem(selected);
              if (prevItem == null) {
                prevItem = this.collection.getFirstItem();
              }
              return this.select(prevItem);
            }
        }
      }
    };

    Incrementor.prototype.select = function(item) {
      $(this.el).val(item);
      return $(this.el).trigger({
        type: Incrementor.EVENT_SELECTED,
        val: item,
        el: this.el
      });
    };

    Incrementor.prototype.getCollection = function() {
      return this.collection;
    };

    Incrementor.prototype.setCollection = function(newCollection) {
      return this.collection = newCollection;
    };

    Incrementor.prototype.getSelected = function() {
      switch (this.collection.collectionType) {
        case IncrementorCollection.COLLECTION_TYPE_STR:
          return $(this.el).val();
        case IncrementorCollection.COLLECTION_TYPE_INT:
          return parseInt($(this.el).val());
        default:
          throw "Incrementor: unknown collection type " + this.collection.collectionType;
      }
    };

    return Incrementor;

  })(AbstractControlable);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.IncrementorCollection = (function() {
    IncrementorCollection.COLLECTION_TYPE_STR = 0;

    IncrementorCollection.COLLECTION_TYPE_INT = 1;

    function IncrementorCollection(collection, collectionType) {
      if (collection == null) {
        collection = void 0;
      }
      if (collectionType == null) {
        collectionType = 0;
      }
      this.getFirstItem = bind(this.getFirstItem, this);
      this.getPrevItem = bind(this.getPrevItem, this);
      this.getNextItem = bind(this.getNextItem, this);
      this.isFirstItemOnCollection = bind(this.isFirstItemOnCollection, this);
      this.isLastItemOnCollection = bind(this.isLastItemOnCollection, this);
      this.collectionType = collectionType;
      if (collection != null) {
        this.collection = collection;
      } else {
        throw "IncrementorCollection: it requires collection in order to work";
      }
    }

    IncrementorCollection.prototype.isLastItemOnCollection = function(item) {
      return this.collection[this.collection.length - 1] === item;
    };

    IncrementorCollection.prototype.isFirstItemOnCollection = function(item) {
      return this.collection[0] === item;
    };

    IncrementorCollection.prototype.getNextItem = function(item) {
      return this.collection[this.collection.indexOf(item) + 1];
    };

    IncrementorCollection.prototype.getPrevItem = function(item) {
      return this.collection[this.collection.indexOf(item) - 1];
    };

    IncrementorCollection.prototype.getFirstItem = function(item) {
      return this.collection[0];
    };

    return IncrementorCollection;

  })();

}).call(this);
(function() {
  window.LoadIndicator = (function() {
    LoadIndicator.CLASS = "load-indicator";

    LoadIndicator.ALIGN = {
      CENTER: '-center',
      RIGHT: '-right',
      TOP_CENTER: '-top-center'
    };

    LoadIndicator.SIZE = {
      SMALL: '-small',
      BIG: '-big'
    };

    LoadIndicator.COLOR = {
      BLUE: '-blue',
      WHITE: '-white'
    };

    function LoadIndicator(el, size, align, color) {
      this.el = el;
      if (size == null) {
        size = LoadIndicator.SIZE.SMALL;
      }
      if (align == null) {
        align = LoadIndicator.ALIGN.CENTER;
      }
      if (color == null) {
        color = LoadIndicator.COLOR.BLUE;
      }
      this.s = this.constructor;
      this.cls = size + " " + align + " " + color;
      this.indicator = $(this.getTemplate(size));
      this.el.append(this.indicator);
    }

    LoadIndicator.prototype.getTemplate = function(size) {
      var center, radius, stroke;
      stroke = 3;
      radius = (function() {
        switch (size) {
          case LoadIndicator.SIZE.BIG:
            return 16;
          case LoadIndicator.SIZE.SMALL:
            return 10;
        }
      })();
      center = radius + stroke;
      return "<div class='" + this.s.CLASS + " " + this.cls + "'>\n  <svg>\n    <circle cx=" + center + " cy=" + center + " r=" + radius + "/>\n  </svg>\n</div>";
    };

    LoadIndicator.prototype.hide = function() {
      return this.indicator.hide();
    };

    LoadIndicator.prototype.show = function() {
      return this.indicator.fadeIn(100);
    };

    LoadIndicator.appendToContainer = function(container, size, align, color) {
      return new LoadIndicator(container, size, align, color);
    };

    LoadIndicator.removeFromContainer = function(container) {
      return $("." + this.CLASS, container).remove();
    };

    return LoadIndicator;

  })();

}).call(this);
(function() {
  window.LoadRotator = (function() {
    function LoadRotator() {}

    LoadRotator.appendToContainer = function(container, cl) {
      var l;
      if (cl == null) {
        cl = "";
      }
      container.append("<div class='loadRotator " + cl + "'></div>");
      l = container.find(".loadRotator");
      l.makeLoader();
      return l;
    };

    LoadRotator.appendToContainterAndStart = function(container, cl) {
      return LoadRotator.appendToContainer(container, cl);
    };

    LoadRotator.removeFromContainer = function(container) {
      return container.find(".loadRotator").remove();
    };

    LoadRotator.appendWithOverlayAndStart = function(container, cl, contCl) {
      var ovrl;
      if (contCl == null) {
        contCl = '';
      }
      ovrl = $(" <div class='loader__overlay " + contCl + "'></div> ");
      container.append(ovrl);
      ovrl.show();
      return LoadRotator.appendToContainterAndStart(ovrl, cl);
    };

    LoadRotator.removeWithOverlay = function(container) {
      return container.find('.loader__overlay').remove();
    };

    return LoadRotator;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.DaySelectTable = (function(superClass) {
    extend(DaySelectTable, superClass);

    DaySelectTable.EVENT_SELECTED = "DaySelectTable:Selected";

    function DaySelectTable(opts) {
      if (opts == null) {
        opts = {};
      }
      this.atRightEdge = bind(this.atRightEdge, this);
      this.atBottomEdge = bind(this.atBottomEdge, this);
      this.atLastCol = bind(this.atLastCol, this);
      this.atFirstCol = bind(this.atFirstCol, this);
      this.atLastRow = bind(this.atLastRow, this);
      this.atFirstRow = bind(this.atFirstRow, this);
      this.pick = bind(this.pick, this);
      this.select = bind(this.select, this);
      this.onKeydown = bind(this.onKeydown, this);
      this.getNextRow = bind(this.getNextRow, this);
      this.getRowByIndex = bind(this.getRowByIndex, this);
      this.getRowByElement = bind(this.getRowByElement, this);
      this.getNextColIndex = bind(this.getNextColIndex, this);
      this.getPrevColIndex = bind(this.getPrevColIndex, this);
      this.getPrevRowIndex = bind(this.getPrevRowIndex, this);
      this.getNextRowIndex = bind(this.getNextRowIndex, this);
      this.getLastRowIndexForElCol = bind(this.getLastRowIndexForElCol, this);
      this.getLastRowIndex = bind(this.getLastRowIndex, this);
      this.getFirstRowIndex = bind(this.getFirstRowIndex, this);
      this.getRowIndex = bind(this.getRowIndex, this);
      this.getLastColIndexForElRow = bind(this.getLastColIndexForElRow, this);
      this.getCommonLastColIndex = bind(this.getCommonLastColIndex, this);
      this.getFirstColIndex = bind(this.getFirstColIndex, this);
      this.getColIndex = bind(this.getColIndex, this);
      this.getTable = bind(this.getTable, this);
      this.getSelected = bind(this.getSelected, this);
      DaySelectTable.__super__.constructor.apply(this, arguments);
    }

    DaySelectTable.prototype.getSelected = function() {
      var s;
      if ((s = $("td.active", this.getTable())).length > 0) {
        return s;
      } else {
        return this.select(0, 0);
      }
    };

    DaySelectTable.prototype.getTable = function() {
      return $("table", this.el);
    };

    DaySelectTable.prototype.getColIndex = function(el) {
      return el.index();
    };

    DaySelectTable.prototype.getFirstColIndex = function() {
      return 0;
    };

    DaySelectTable.prototype.getCommonLastColIndex = function() {
      return $("tr:first td", this.getTable()).length - 1;
    };

    DaySelectTable.prototype.getLastColIndexForElRow = function(el) {
      return this.getRowByElement(el).find("td").length - 1;
    };

    DaySelectTable.prototype.getRowIndex = function(el) {
      return this.getRowByElement(el).index();
    };

    DaySelectTable.prototype.getFirstRowIndex = function() {
      return 0;
    };

    DaySelectTable.prototype.getLastRowIndex = function() {
      return this.getTable().find("tr").length - 1;
    };

    DaySelectTable.prototype.getLastRowIndexForElCol = function(el) {
      var colIndex, j, ref, rowIndex, rows, td;
      colIndex = this.getColIndex(el);
      rows = this.getTable().find("tr");
      for (rowIndex = j = ref = this.getLastRowIndex(); ref <= 0 ? j < 0 : j > 0; rowIndex = ref <= 0 ? ++j : --j) {
        if ((td = $($(rows[rowIndex]).find("td")[colIndex])).length > 0 && td.attr("data-val") !== void 0) {
          return rowIndex;
        }
      }
      return void 0;
    };

    DaySelectTable.prototype.getNextRowIndex = function(el) {
      if (!this.atLastRow(el)) {
        return this.getRowIndex(el) + 1;
      } else {
        return void 0;
      }
    };

    DaySelectTable.prototype.getPrevRowIndex = function(el) {
      if (!this.atFirstRow(el)) {
        return this.getRowIndex(el) - 1;
      } else {
        return void 0;
      }
    };

    DaySelectTable.prototype.getPrevColIndex = function(el) {
      var i;
      if ((i = this.getColIndex(el) - 1) >= 0) {
        return i;
      } else {
        return void 0;
      }
    };

    DaySelectTable.prototype.getNextColIndex = function(el) {
      var i;
      if ((i = this.getColIndex(el) + 1) <= this.getLastColIndexForElRow(el)) {
        return i;
      } else {
        return void 0;
      }
    };

    DaySelectTable.prototype.getRowByElement = function(el) {
      return el.parents("tr");
    };

    DaySelectTable.prototype.getRowByIndex = function(i) {
      return $($("tr", this.getTable())[i]);
    };

    DaySelectTable.prototype.getNextRow = function(el) {
      var i;
      if ((i = this.getNextRowIndex(el)) !== void 0) {
        return this.getRowByIndex(i);
      } else {
        return void 0;
      }
    };

    DaySelectTable.prototype.onKeydown = function(e) {
      var selected;
      DaySelectTable.__super__.onKeydown.apply(this, arguments);
      switch (e.keyCode) {
        case Utils.KEY_CODES.UP:
          if (!this.atFirstRow(selected = this.getSelected())) {
            return this.select(this.getPrevRowIndex(selected), this.getColIndex(selected));
          } else if (!this.atFirstCol(selected)) {
            return this.select(this.getLastRowIndexForElCol(selected), this.getPrevColIndex(selected));
          }
          break;
        case Utils.KEY_CODES.DOWN:
          if (!this.atBottomEdge(selected = this.getSelected())) {
            return this.select(this.getNextRowIndex(selected), this.getColIndex(selected));
          } else if (!this.atLastCol(selected)) {
            return this.select(this.getFirstRowIndex(), this.getNextColIndex(selected));
          }
          break;
        case Utils.KEY_CODES.LEFT:
          if (!this.atFirstCol(selected = this.getSelected())) {
            return this.select(this.getRowIndex(selected), this.getPrevColIndex(selected));
          } else if (!this.atFirstRow(selected)) {
            return this.select(this.getPrevRowIndex(selected), this.getCommonLastColIndex());
          }
          break;
        case Utils.KEY_CODES.RIGHT:
          if (!this.atRightEdge(selected = this.getSelected())) {
            return this.select(this.getRowIndex(selected), this.getNextColIndex(selected));
          } else if (!this.atLastRow(selected)) {
            return this.select(this.getNextRowIndex(selected), this.getFirstColIndex());
          }
          break;
        case Utils.KEY_CODES.ENTER:
          return this.pick();
      }
    };

    DaySelectTable.prototype.select = function(row, col) {
      var newSelected;
      if ($("td.active", this.getTable()).length > 0) {
        this.getSelected().removeClass("active");
      }
      newSelected = $($(this.getTable().find("tr")[row]).find("td")[col]);
      newSelected.addClass("active");
      return $(this.el).trigger({
        type: DaySelectTable.EVENT_SELECTED,
        el: newSelected
      });
    };

    DaySelectTable.prototype.pick = function() {
      return this.getSelected().trigger("click");
    };

    DaySelectTable.prototype.atFirstRow = function(el) {
      return this.getRowIndex(el) === this.getFirstRowIndex();
    };

    DaySelectTable.prototype.atLastRow = function(el) {
      return this.getRowIndex(el) === this.getLastRowIndex();
    };

    DaySelectTable.prototype.atFirstCol = function(el) {
      return this.getColIndex(el) === this.getFirstColIndex();
    };

    DaySelectTable.prototype.atLastCol = function(el) {
      return this.getColIndex(el) === this.getLastColIndexForElRow(el);
    };

    DaySelectTable.prototype.atBottomEdge = function(el) {
      var bottomElDontHaveDataVal, bottomElDontHaveRowAtElInd, i, tds;
      i = this.getColIndex(el);
      bottomElDontHaveRowAtElInd = (tds = $("td", this.getNextRow(el))).length - 1 < i;
      bottomElDontHaveDataVal = $(tds[i]).attr("data-val") === void 0;
      return this.atLastRow(el) || bottomElDontHaveRowAtElInd || bottomElDontHaveDataVal;
    };

    DaySelectTable.prototype.atRightEdge = function(el) {
      var tds;
      tds = this.getRowByElement(el).find("td");
      return this.atLastCol(el) || $(tds[this.getNextColIndex(el)]).attr("data-val") === void 0;
    };

    return DaySelectTable;

  })(AbstractControlable);

}).call(this);
(function() {
  $.Controller('NiceScroller', {
    init: function(el, opts) {
      this.element = $(el);
      this.opts = opts != null ? opts : {};
      this.axis = this.element.attr('data-scroll-type') === 'vertical' ? 'y' : 'x';
      this.scrollStep = 8;
      if (GlobalState.PLATFORM.isMobile()) {
        this.element.css("overflow-" + this.axis, 'scroll');
        this.inner = this.element;
      } else {
        this.inner = $('<div class="antiscroll-inner"></div>').append(this.element.contents());
        this.element.append(this.inner).addClass('antiscroll-wrap').one('mousemove.nice_scroller_init', this.refresh.bind(this));
      }
      this.element.addClass("niceScroller " + (this.axis === 'y' ? 'vertical' : 'horizontal')).on('moveForward', (function(_this) {
        return function() {
          return _this.moveContentByStep(_this.scrollStep);
        };
      })(this)).on('moveBackward', (function(_this) {
        return function() {
          return _this.moveContentByStep(-1 * _this.scrollStep);
        };
      })(this)).on('showMoreUsers', (function(_this) {
        return function(e, step) {
          return _this.moveContentByStep(step);
        };
      })(this)).on('moveTo', (function(_this) {
        return function(e, position) {
          return _this.moveToPoint(position);
        };
      })(this)).on('moveToItem', (function(_this) {
        return function(e, item) {
          return _this.moveToItem($(item));
        };
      })(this));
      this.inner.on('scroll', (function(_this) {
        return function() {
          return _.defer(function() {
            if (_this.inner.scrollTop() === _this.getMaxOffset()) {
              _this.element.trigger('nice_scroll:at_the_end');
            }
            if (_this.inner.scrollTop() === 0) {
              _this.element.trigger('nice_scroll:in_the_beginning');
            } else {
              _this.element.trigger('nice_scroll:in_progress');
            }
            return _this.element.trigger('nice_scroll:update');
          });
        };
      })(this));
      if (this.opts.forceInit) {
        return this.refresh();
      }
    },
    moveContentByStep: function(step) {
      var newPoint;
      newPoint = this.getContentOffset() + step;
      return this.moveToPoint(newPoint);
    },
    moveToPercent: function(percent) {
      var newPos;
      newPos = Math.round(this.getMaxOffset() * percent);
      return this.moveToPoint(newPos);
    },
    moveToPoint: function(position) {
      this.refresh();
      if (this.axis === 'y') {
        return this.inner.scrollTop(position);
      } else {
        return this.inner.scrollLeft(position);
      }
    },
    moveToItem: function(item) {
      var listHeight, listOffset, step, userHeight, userOffset;
      listOffset = this.element.offset().top;
      listHeight = this.element.height();
      userHeight = item.outerHeight(true);
      userOffset = item.offset().top - listOffset + userHeight;
      if (userOffset < userHeight) {
        step = userHeight - userOffset;
      } else {
        step = listHeight - userOffset;
      }
      return this.moveContentByStep(-step);
    },
    getContentOffset: function() {
      if (this.axis === 'y') {
        return this.inner.scrollTop();
      } else {
        return this.inner.scrollLeft();
      }
    },
    getMaxOffset: function() {
      if (this.axis === 'y') {
        return this.inner.prop('scrollHeight') - this.element.height();
      } else {
        return this.inner.prop('scrollWidth') - this.element.width();
      }
    },
    getScrollContainer: function() {
      return this.inner;
    },
    update: function() {
      this._super();
      return this.refresh();
    },
    refresh: function() {
      if (GlobalState.PLATFORM.isMobile()) {
        return;
      }
      if (this.axis === 'y') {
        this.inner.css('height', '');
        this.inner.height(this.element.height());
      } else {
        this.inner.css('width', '');
        this.inner.width(this.element.width());
      }
      if (!this.element.data('antiscroll')) {
        if (this.axis === 'y') {
          this.element.width(this.inner.width());
        } else {
          this.element.height(this.inner.height());
        }
        this.inner.css("overflow-" + this.axis, 'scroll');
        return this.element.antiscroll({
          x: this.axis === 'x',
          y: this.axis === 'y',
          padding: 3
        });
      } else {
        return this.element.data('antiscroll').refresh();
      }
    }
  });

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.NiceDateSelect = (function() {
    NiceDateSelect.prototype.monthNames = I18n.t('smart_datetime_new.month_full_names');

    NiceDateSelect.prototype.monthNamesShort = I18n.t('smart_datetime_new.month_names');

    function NiceDateSelect(opts) {
      var attrs, h, j, m, name, ref, ref1, results;
      this.opts = opts != null ? opts : {};
      this.zeroPad = bind(this.zeroPad, this);
      this.fromDateToDateString = bind(this.fromDateToDateString, this);
      this.fromDateStringToDate = bind(this.fromDateStringToDate, this);
      this.fillTextFields = bind(this.fillTextFields, this);
      this.populateDropdowns = bind(this.populateDropdowns, this);
      this.textFieldWasChanged = bind(this.textFieldWasChanged, this);
      this.minuteInputBlur = bind(this.minuteInputBlur, this);
      this.minuteInputFocus = bind(this.minuteInputFocus, this);
      this.hourInputBlur = bind(this.hourInputBlur, this);
      this.hourInputFocus = bind(this.hourInputFocus, this);
      this.dayInputBlur = bind(this.dayInputBlur, this);
      this.dayInputFocus = bind(this.dayInputFocus, this);
      this.yearInputBlur = bind(this.yearInputBlur, this);
      this.yearInputFocus = bind(this.yearInputFocus, this);
      this.monthInputBlur = bind(this.monthInputBlur, this);
      this.monthInputFocus = bind(this.monthInputFocus, this);
      this.yearSelectHided = bind(this.yearSelectHided, this);
      this.monthSelectHided = bind(this.monthSelectHided, this);
      this.yearSelectShowed = bind(this.yearSelectShowed, this);
      this.monthSelectShowed = bind(this.monthSelectShowed, this);
      this.daySelectHided = bind(this.daySelectHided, this);
      this.daySelectShowed = bind(this.daySelectShowed, this);
      this.pickMinute = bind(this.pickMinute, this);
      this.pickHour = bind(this.pickHour, this);
      this.pickYear = bind(this.pickYear, this);
      this.pickMonth = bind(this.pickMonth, this);
      this.pickDay = bind(this.pickDay, this);
      this.setValueByInput = bind(this.setValueByInput, this);
      this.setValueByDropdown = bind(this.setValueByDropdown, this);
      this.resetCurDate = bind(this.resetCurDate, this);
      this.setCurDate = bind(this.setCurDate, this);
      this.setMinute = bind(this.setMinute, this);
      this.setHour = bind(this.setHour, this);
      this.setYear = bind(this.setYear, this);
      this.setMonth = bind(this.setMonth, this);
      this.setDay = bind(this.setDay, this);
      this.getDefaultDate = bind(this.getDefaultDate, this);
      this.getCurDate = bind(this.getCurDate, this);
      this.getMonthsDropdownList = bind(this.getMonthsDropdownList, this);
      this.getYearsDropdownList = bind(this.getYearsDropdownList, this);
      this.getDayPicker = bind(this.getDayPicker, this);
      this.getYearPicker = bind(this.getYearPicker, this);
      this.getMonthPicker = bind(this.getMonthPicker, this);
      this.getDaysList = bind(this.getDaysList, this);
      this.getYearsList = bind(this.getYearsList, this);
      this.getMothsList = bind(this.getMothsList, this);
      this.getMinuteInput = bind(this.getMinuteInput, this);
      this.getHourInput = bind(this.getHourInput, this);
      this.getDayInput = bind(this.getDayInput, this);
      this.getYearInput = bind(this.getYearInput, this);
      this.getMonthInput = bind(this.getMonthInput, this);
      this.el = $(this.opts.el);
      this.input = $('input.date-select__input', this.el).first();
      this.select = $('.date-select__picker', this.el);
      this.textFields = [$('input.month-input', this.el), $('input.day-input', this.el), $('input.year-input', this.el), $('input.hour-input', this.el), $('input.minute-input', this.el)];
      this.yearNames = (function() {
        results = [];
        for (var j = ref = new Date().getFullYear() - 13; ref <= 1900 ? j <= 1900 : j >= 1900; ref <= 1900 ? j++ : j--){ results.push(j); }
        return results;
      }).apply(this);
      this.inputMonthNames = this.opts.fullMonthNames && this.monthNames || this.monthNamesShort;
      this.hoursList = (function() {
        var k, results1;
        results1 = [];
        for (h = k = 23; k >= 0; h = --k) {
          results1.push(this.zeroPad(h));
        }
        return results1;
      }).call(this);
      this.minutesList = (function() {
        var k, results1;
        results1 = [];
        for (m = k = 55; k >= 0; m = k += -5) {
          results1.push(this.zeroPad(m));
        }
        return results1;
      }).call(this);
      this.incrementors = {
        day: {
          el: this.getDayInput(),
          collection: new IncrementorCollection([1], IncrementorCollection.COLLECTION_TYPE_INT)
        },
        month: {
          el: this.getMonthInput(),
          collection: new IncrementorCollection(this.inputMonthNames, IncrementorCollection.COLLECTION_TYPE_STR)
        },
        year: {
          el: this.getYearInput(),
          collection: new IncrementorCollection(this.yearNames, IncrementorCollection.COLLECTION_TYPE_INT)
        },
        hours: {
          el: this.getHourInput(),
          collection: new IncrementorCollection(this.hoursList, IncrementorCollection.COLLECTION_TYPE_STR)
        },
        minutes: {
          el: this.getMinuteInput(),
          collection: new IncrementorCollection(this.minutesList, IncrementorCollection.COLLECTION_TYPE_STR)
        }
      };
      ref1 = this.incrementors;
      for (name in ref1) {
        attrs = ref1[name];
        attrs.el.on(Incrementor.EVENT_SELECTED, (function(_this) {
          return function(e) {
            return _this.setValueByInput($(e.el));
          };
        })(this));
        this.incrementors[name] = new Incrementor({
          el: attrs.el,
          collection: attrs.collection
        });
      }
      this.populateDropdowns();
      new DaySelectTable({
        el: this.getDaysList()
      });
      this.getDaysList().on(DaySelectTable.EVENT_SELECTED, (function(_this) {
        return function(e) {
          return _this.setDay(e.el);
        };
      })(this));
      $(".niceScroller", this.el).each((function(_this) {
        return function(i, list) {
          new ControlableNiceScroller({
            el: list,
            selectedClass: "active"
          });
          return $(list).on(ControlableNiceScroller.EVENT_SELECTED, function(e) {
            return _this.setValueByDropdown(e.el);
          });
        };
      })(this));
      $('input[type=hidden]', this.el).on("change", (function(_this) {
        return function() {
          _this.fillTextFields();
          return _this.populateDropdowns();
        };
      })(this));
      $('input[type=text]', this.el).on("blur", (function(_this) {
        return function() {
          return _this.textFieldWasChanged();
        };
      })(this));
      $('input[type=text]', this.el).on("keydown", (function(_this) {
        return function(e) {
          if (e.keyCode !== Utils.KEY_CODES.ENTER) {
            return;
          }
          e.preventDefault();
          e.stopPropagation();
          return _this.textFieldWasChanged();
        };
      })(this));
      $("input", this.el).on("click", (function(_this) {
        return function(e) {
          e.stopPropagation();
          return $(e.target).closest(".dropdown").trigger("hide");
        };
      })(this));
      this.el.on('click', '.days-list td[data-val]', this.pickDay);
      this.el.on('click', '.months-list li', this.pickMonth);
      this.el.on('click', '.years-list li', this.pickYear);
      this.el.on('change', '.day-picker', this.pickDay);
      this.el.on('change', '.month-picker', this.pickMonth);
      this.el.on('change', '.year-picker', this.pickYear);
      this.el.on('change', '.time-select .hour-input', this.pickHour);
      this.el.on('change', '.time-select .minute-input', this.pickMinute);
      this.el.on('showed', '.dropdown.day-select', this.daySelectShowed);
      this.el.on('hided', '.dropdown.day-select', this.daySelectHided);
      this.el.on('showed', '.dropdown.month-select', this.monthSelectShowed);
      this.el.on('hided', '.dropdown.month-select', this.monthSelectHided);
      this.el.on('showed', '.dropdown.year-select', this.yearSelectShowed);
      this.el.on('hided', '.dropdown.year-select', this.yearSelectHided);
      this.el.on('focus', '.dropdown .month-input', this.monthInputFocus);
      this.el.on('blur', '.dropdown .month-input', this.monthInputBlur);
      this.el.on('focus', '.dropdown .day-input', this.dayInputFocus);
      this.el.on('blur', '.dropdown .day-input', this.dayInputBlur);
      this.el.on('focus', '.dropdown .year-input', this.yearInputFocus);
      this.el.on('blur', '.dropdown .year-input', this.yearInputBlur);
      this.el.on('focus', '.time-select .hour-input', this.hourInputFocus);
      this.el.on('blur', '.time-select .hour-input', this.hourInputBlur);
      this.el.on('focus', '.time-select .minute-input', this.minuteInputFocus);
      this.el.on('blur', '.time-select .minute-input', this.minuteInputBlur);
    }

    NiceDateSelect.prototype.getMonthInput = function() {
      return $(".month-input", this.el);
    };

    NiceDateSelect.prototype.getYearInput = function() {
      return $(".year-input", this.el);
    };

    NiceDateSelect.prototype.getDayInput = function() {
      return $(".day-input", this.el);
    };

    NiceDateSelect.prototype.getHourInput = function() {
      return $(".hour-input", this.el);
    };

    NiceDateSelect.prototype.getMinuteInput = function() {
      return $(".minute-input", this.el);
    };

    NiceDateSelect.prototype.getMothsList = function() {
      return $('.months-list', this.el);
    };

    NiceDateSelect.prototype.getYearsList = function() {
      return $('.years-list', this.el);
    };

    NiceDateSelect.prototype.getDaysList = function() {
      return $('.days-list', this.el);
    };

    NiceDateSelect.prototype.getMonthPicker = function() {
      return $('select.month-picker', this.el);
    };

    NiceDateSelect.prototype.getYearPicker = function() {
      return $('select.year-picker', this.el);
    };

    NiceDateSelect.prototype.getDayPicker = function() {
      return $('select.day-picker', this.el);
    };

    NiceDateSelect.prototype.getYearsDropdownList = function() {
      return $(".dropdown.year-select .niceScroller", this.el);
    };

    NiceDateSelect.prototype.getMonthsDropdownList = function() {
      return $(".dropdown.month-select .niceScroller", this.el);
    };

    NiceDateSelect.prototype.getCurDate = function() {
      var d, value;
      if ((value = this.input.val()).match(/\d+\/\d+\/\d+/)) {
        return this.fromDateStringToDate(value);
      } else {
        d = new Date(value);
        if (isNaN(d.getTime())) {
          d = this.getDefaultDate();
        }
        if (this.opts.utc) {
          this.input.val(moment(d).toISOString());
        } else {
          this.input.val(this.fromDateToDateString(d));
        }
        return d;
      }
    };

    NiceDateSelect.prototype.getDefaultDate = function() {
      var defaultDate;
      defaultDate = this.input.attr("data-default-date");
      if (defaultDate) {
        return this.fromDateStringToDate(defaultDate);
      } else {
        return new Date();
      }
    };

    NiceDateSelect.prototype.setDay = function(el, val) {
      var d;
      if (val == null) {
        val = $(el).attr('data-val');
      }
      d = this.getCurDate();
      d.setDate(val);
      return this.setCurDate(d);
    };

    NiceDateSelect.prototype.setMonth = function(el, val) {
      var d;
      if (val == null) {
        val = $(el).attr('data-val');
      }
      d = this.getCurDate();
      d.setMonth(parseInt(val));
      return this.setCurDate(d);
    };

    NiceDateSelect.prototype.setYear = function(el, val) {
      var d;
      if (val == null) {
        val = $(el).attr('data-val');
      }
      d = this.getCurDate();
      d.setYear(parseInt(val));
      return this.setCurDate(d);
    };

    NiceDateSelect.prototype.setHour = function(el, val) {
      var d;
      if (val == null) {
        val = $(el).attr('data-val');
      }
      d = this.getCurDate();
      d.setHours(parseInt(val));
      return this.setCurDate(d);
    };

    NiceDateSelect.prototype.setMinute = function(el, val) {
      var d;
      if (val == null) {
        val = $(el).attr('data-val');
      }
      d = this.getCurDate();
      d.setMinutes(parseInt(val));
      return this.setCurDate(d);
    };

    NiceDateSelect.prototype.setCurDate = function(newD) {
      var now;
      if (!this.getYearInput().length) {
        now = new Date();
        newD.setYear(now.getFullYear());
        if (newD < now) {
          newD.setYear(now.getFullYear() + 1);
        }
      }
      if (this.opts.utc) {
        this.input.val(moment(newD).toISOString());
      } else {
        this.input.val([this.zeroPad(newD.getMonth() + 1), this.zeroPad(newD.getDate()), newD.getFullYear()].join('/'));
      }
      return this.input.trigger('change');
    };

    NiceDateSelect.prototype.resetCurDate = function() {
      return this.setCurDate(this.getCurDate());
    };

    NiceDateSelect.prototype.setValueByDropdown = function(selected) {
      var dropdown;
      dropdown = $(selected).parents(".dropdown");
      if (dropdown.hasClass("month-select")) {
        return this.setMonth(selected);
      } else if (dropdown.hasClass("year-select")) {
        return this.setYear(selected);
      }
    };

    NiceDateSelect.prototype.setValueByInput = function(input) {
      if (input.hasClass("year-input")) {
        return this.setYear(void 0, input.val());
      } else if (input.hasClass("month-input")) {
        return this.setMonth(void 0, this.inputMonthNames.indexOf(input.val()));
      } else if (input.hasClass("day-input")) {
        return this.setDay(void 0, input.val());
      } else if (input.hasClass("hour-input")) {
        return this.setHour(null, input.val());
      } else if (input.hasClass("minute-input")) {
        return this.setMinute(null, input.val());
      }
    };

    NiceDateSelect.prototype.pickDay = function(e) {
      var el;
      el = e.currentTarget;
      if ($(el).is('select')) {
        return this.setDay(void 0, $(el).val());
      } else {
        this.setDay(el);
        return this.getDaysList().parents('.dropdown.day-select').trigger('hide');
      }
    };

    NiceDateSelect.prototype.pickMonth = function(e) {
      var el;
      el = e.currentTarget;
      if ($(el).is('select')) {
        return this.setMonth(void 0, $(el).val());
      } else {
        this.setMonth(el);
        return $('.list').parents('.dropdown.month-select').trigger('hide');
      }
    };

    NiceDateSelect.prototype.pickYear = function(e) {
      var el;
      el = e.currentTarget;
      if ($(el).is('select')) {
        return this.setYear(void 0, $(el).val());
      } else {
        this.setYear(el);
        return $('.list').parents('.dropdown.year-select').trigger('hide');
      }
    };

    NiceDateSelect.prototype.pickHour = function(e) {
      return this.setHour(null, $(e.currentTarget).val());
    };

    NiceDateSelect.prototype.pickMinute = function(e) {
      return this.setMinute(null, $(e.currentTarget).val());
    };

    NiceDateSelect.prototype.daySelectShowed = function() {
      $(".day-input", this.el).blur();
      return this.getDaysList().trigger(DaySelectTable.ACTION_LISTEN);
    };

    NiceDateSelect.prototype.daySelectHided = function() {
      return this.getDaysList().trigger(DaySelectTable.ACTION_UNLISTEN);
    };

    NiceDateSelect.prototype.monthSelectShowed = function() {
      $(".month-input", this.el).blur();
      return this.getMonthsDropdownList().trigger(ControlableNiceScroller.ACTION_LISTEN);
    };

    NiceDateSelect.prototype.yearSelectShowed = function() {
      $(".year-input", this.el).blur();
      return this.getYearsDropdownList().trigger(ControlableNiceScroller.ACTION_LISTEN);
    };

    NiceDateSelect.prototype.monthSelectHided = function() {
      return this.getMonthsDropdownList().trigger(ControlableNiceScroller.ACTION_UNLISTEN);
    };

    NiceDateSelect.prototype.yearSelectHided = function() {
      return this.getYearsDropdownList().trigger(ControlableNiceScroller.ACTION_UNLISTEN);
    };

    NiceDateSelect.prototype.monthInputFocus = function() {
      return this.getMonthInput().trigger(Incrementor.ACTION_LISTEN);
    };

    NiceDateSelect.prototype.monthInputBlur = function() {
      return this.getMonthInput().trigger(Incrementor.ACTION_UNLISTEN);
    };

    NiceDateSelect.prototype.yearInputFocus = function() {
      return this.getYearInput().trigger(Incrementor.ACTION_LISTEN);
    };

    NiceDateSelect.prototype.yearInputBlur = function() {
      return this.getYearInput().trigger(Incrementor.ACTION_UNLISTEN);
    };

    NiceDateSelect.prototype.dayInputFocus = function() {
      return this.getDayInput().trigger(Incrementor.ACTION_LISTEN);
    };

    NiceDateSelect.prototype.dayInputBlur = function() {
      return this.getDayInput().trigger(Incrementor.ACTION_UNLISTEN);
    };

    NiceDateSelect.prototype.hourInputFocus = function() {
      return this.getHourInput().trigger(Incrementor.ACTION_LISTEN);
    };

    NiceDateSelect.prototype.hourInputBlur = function() {
      return this.getHourInput().trigger(Incrementor.ACTION_UNLISTEN);
    };

    NiceDateSelect.prototype.minuteInputFocus = function() {
      return this.getMinuteInput().trigger(Incrementor.ACTION_LISTEN);
    };

    NiceDateSelect.prototype.minuteInputBlur = function() {
      return this.getMinuteInput().trigger(Incrementor.ACTION_UNLISTEN);
    };

    NiceDateSelect.prototype.textFieldWasChanged = function() {
      var isDateValid, month, newD, vals;
      month = this.monthNames.indexOf(this.textFields[0].val());
      if (month === -1) {
        month = this.inputMonthNames.map((function(_this) {
          return function(v) {
            return v.toLowerCase();
          };
        })(this)).indexOf(this.textFields[0].val().toLowerCase());
      }
      vals = [month];
      _.chain(this.textFields).rest().each(function($el) {
        return vals.push(parseInt($el.val()));
      });
      if (!this.getYearInput().length) {
        vals[2] = new Date().getFullYear();
      }
      if (!this.getHourInput().length) {
        vals[3] = 0;
      }
      if (!this.getMinuteInput().length) {
        vals[4] = 0;
      }
      newD = new Date(vals[2], vals[0], vals[1], vals[3], vals[4]);
      isDateValid = newD.getMonth() === vals[0] && newD.getDate() === vals[1] && newD.getFullYear() === vals[2] && newD.getFullYear() >= 1900;
      if (isDateValid) {
        return this.setCurDate(newD);
      } else {
        return this.resetCurDate();
      }
    };

    NiceDateSelect.prototype.populateDropdowns = function() {
      var appending, curDate, day, days, endInd, j, k, l, lacking, len, len1, maxDays, month, n, o, out, preOut, ref, ref1, results, rowNum, startInd, totalRows, year;
      curDate = this.getCurDate();
      this.getYearsList().add(this.getYearPicker()).html('');
      ref = this.yearNames;
      for (j = 0, len = ref.length; j < len; j++) {
        year = ref[j];
        this.getYearsList().append("<li class='list__item list__item-beta' data-val='" + year + "'>" + year + "</li>");
        this.getYearPicker().append("<option value='" + year + "' data-val='" + year + "'>" + year + "</option>");
      }
      this.getMothsList().add(this.getMonthPicker()).html('');
      for (month = k = 0; k <= 11; month = ++k) {
        this.getMothsList().append("<li class='list__item list__item-beta' data-val='" + month + "'>" + this.monthNames[month] + "</li>");
        this.getMonthPicker().append("<option value='" + month + "' data-val='" + month + "'>" + this.monthNames[month] + "</option>");
      }
      this.getDaysList().add(this.getDayPicker()).html('');
      curDate = this.getCurDate();
      maxDays = new Date(curDate.getFullYear(), curDate.getMonth() + 1, 0).getDate();
      preOut = [];
      days = (function() {
        results = [];
        for (var l = 1; 1 <= maxDays ? l <= maxDays : l >= maxDays; 1 <= maxDays ? l++ : l--){ results.push(l); }
        return results;
      }).apply(this);
      for (n = 0, len1 = days.length; n < len1; n++) {
        day = days[n];
        preOut.push("<td data-val='" + day + "'>" + day + "</td>");
        this.getDayPicker().append("<option value='" + day + "' data-val='" + day + "'>" + day + "</option>");
      }
      this.incrementors.day.setCollection(new IncrementorCollection(days.reverse(), IncrementorCollection.COLLECTION_TYPE_INT));
      out = [];
      totalRows = Math.ceil(preOut.length / 7);
      for (rowNum = o = 0, ref1 = totalRows - 1; 0 <= ref1 ? o <= ref1 : o >= ref1; rowNum = 0 <= ref1 ? ++o : --o) {
        startInd = rowNum * 7;
        endInd = Math.min(startInd + 7, preOut.length);
        if ((appending = preOut.slice(startInd, endInd)).length < 7) {
          lacking = 7 - appending.length;
          appending.push("<td colspan='" + lacking + "' id='colSpan' style='disabledGrid'>&nbsp;</td>");
        }
        out.push("<tr>" + (appending.join('')) + "</tr>");
      }
      this.getDaysList().html("<table>" + (out.join('')) + "</table>");
      $("li[data-val=" + (curDate.getFullYear()) + "]", this.getYearsList()).addClass('active');
      $("li[data-val=" + (curDate.getMonth()) + "]", this.getMothsList()).addClass('active');
      $("td[data-val=" + (curDate.getDate()) + "]", this.getDaysList()).addClass('active');
      $("option[data-val=" + (curDate.getFullYear()) + "]", this.getYearPicker()).attr('selected', 'selected');
      $("option[data-val=" + (curDate.getMonth()) + "]", this.getMonthPicker()).attr('selected', 'selected');
      return $("option[data-val=" + (curDate.getDate()) + "]", this.getDayPicker()).attr('selected', 'selected');
    };

    NiceDateSelect.prototype.fillTextFields = function() {
      var curD;
      curD = this.getCurDate();
      this.textFields[0].val(this.inputMonthNames[curD.getMonth()]);
      this.textFields[1].val(this.zeroPad(curD.getDate()));
      this.textFields[2].val(curD.getFullYear());
      this.textFields[3].val(this.zeroPad(curD.getHours()));
      return this.textFields[4].val(this.zeroPad(curD.getMinutes()));
    };

    NiceDateSelect.prototype.fromDateStringToDate = function(str) {
      return new Date(str);
    };

    NiceDateSelect.prototype.fromDateToDateString = function(d) {
      return (this.zeroPad(d.getMonth() + 1)) + "/" + (this.zeroPad(d.getDate())) + "/" + (d.getFullYear());
    };

    NiceDateSelect.prototype.zeroPad = function(v) {
      if (v < 10) {
        return "0" + v;
      } else {
        return "" + v;
      }
    };

    return NiceDateSelect;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.ControlableNiceScroller = (function(superClass) {
    extend(ControlableNiceScroller, superClass);

    ControlableNiceScroller.EVENT_SELECTED = "ControlableNiceScroller:Events:Selected";

    function ControlableNiceScroller(opts) {
      if (opts == null) {
        opts = {};
      }
      this.getSelectedIndex = bind(this.getSelectedIndex, this);
      this.getSelected = bind(this.getSelected, this);
      this.getStep = bind(this.getStep, this);
      this.pick = bind(this.pick, this);
      this.select = bind(this.select, this);
      this.navigate = bind(this.navigate, this);
      this.onKeydown = bind(this.onKeydown, this);
      ControlableNiceScroller.__super__.constructor.apply(this, arguments);
      $(this.el).nice_scroller();
      if (opts != null) {
        if (opts.selectedClass != null) {
          this.selectedClass = opts.selectedClass;
        } else {
          this.selectedClass = "controlsSelected";
        }
      }
    }

    ControlableNiceScroller.prototype.onKeydown = function(e) {
      ControlableNiceScroller.__super__.onKeydown.apply(this, arguments);
      switch (e.keyCode) {
        case Utils.KEY_CODES.DOWN:
          return this.navigate(+1);
        case Utils.KEY_CODES.UP:
          return this.navigate(-1);
        case Utils.KEY_CODES.ENTER:
          return this.pick();
      }
    };

    ControlableNiceScroller.prototype.navigate = function(offset) {
      var items, selectedIndex;
      if (offset == null) {
        offset = 0;
      }
      if (offset === 0) {
        return false;
      }
      items = $(this.el).find("li");
      selectedIndex = this.getSelectedIndex(items);
      if (selectedIndex === -1) {
        if (offset > 0) {
          return this.select(items.first());
        } else {
          return this.select(items.last());
        }
      } else if (selectedIndex === items.length - 1 && offset > 0) {

      } else if (selectedIndex === 0 && offset < 0) {

      } else {
        return this.select($(items[selectedIndex + offset], items));
      }
    };

    ControlableNiceScroller.prototype.select = function(el) {
      this.getSelected().removeClass(this.selectedClass);
      el.addClass(this.selectedClass);
      $(this.el).trigger("showMoreUsers", this.getStep(el));
      return $(this.el).trigger({
        type: ControlableNiceScroller.EVENT_SELECTED,
        el: el
      });
    };

    ControlableNiceScroller.prototype.pick = function() {
      return this.getSelected().trigger("click");
    };

    ControlableNiceScroller.prototype.getStep = function(focusedUser) {
      var list, listHeight, listOffset, step, userHeight, userOffset;
      list = $(this.el);
      if (focusedUser) {
        listOffset = list.offset().top;
        listHeight = list.height();
        userHeight = focusedUser.height();
        userOffset = focusedUser.offset().top - listOffset + userHeight;
        if (userOffset < userHeight) {
          step = userHeight - userOffset;
        } else {
          step = listHeight - userOffset;
        }
        return -step;
      } else {
        return 0;
      }
    };

    ControlableNiceScroller.prototype.getSelected = function() {
      return $("." + this.selectedClass, this.el);
    };

    ControlableNiceScroller.prototype.getSelectedIndex = function(list) {
      var i, j, len, listItem;
      i = 0;
      for (j = 0, len = list.length; j < len; j++) {
        listItem = list[j];
        if ($(listItem).hasClass(this.selectedClass)) {
          return i;
        } else {
          i++;
        }
      }
      return -1;
    };

    return ControlableNiceScroller;

  })(AbstractControlable);

}).call(this);
(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.OpenInAppButton = {};

  widgets.OpenInAppButton = {
    constructIn: function($container) {
      var $showInAppBtn;
      $showInAppBtn = $('[show-in-app-btn]', $container);
      if ($showInAppBtn.length === 0) {
        return false;
      }
      return $showInAppBtn.each(function(i, el) {
        var $el;
        $el = $(el);
        if (GlobalState.PLATFORM.isIos()) {
          $el.addClass('-ios');
          return new widgets.OpenInAppButton.IosShowInApp($el);
        } else if (GlobalState.PLATFORM.isWindophone()) {
          $el.addClass('-win');
          return new widgets.OpenInAppButton.WindowsShowInApp($el);
        } else if (GlobalState.PLATFORM.isAndroidNative()) {
          $el.addClass('-android');
          return new widgets.OpenInAppButton.AndroidShowInApp($el);
        } else {
          return $el.remove();
        }
      });
    }
  };

  widgets.OpenInAppButton.IosShowInApp = (function(superClass) {
    extend(IosShowInApp, superClass);

    function IosShowInApp() {
      IosShowInApp.__super__.constructor.apply(this, arguments);
      this.schemeLink = "coub://view/" + (this.el.attr("data-permalink"));
      this.alternativeLink = "itms-apps://itunes.apple.com/app/coub/id714042522";
      this.redirectHTPP = "mobile_player_redirect_http";
      this.redirectApp = "mobile_player_redirect_app";
    }

    return IosShowInApp;

  })(AbstractAppSchemeLink);

  widgets.OpenInAppButton.WindowsShowInApp = (function() {
    function WindowsShowInApp(el) {
      var $el, link;
      $el = $(el);
      link = "coubwp://view/" + ($el.attr("data-permalink"));
      $el.click(function() {
        window.location = link;
        return false;
      });
    }

    return WindowsShowInApp;

  })();

  widgets.OpenInAppButton.AndroidShowInApp = (function(superClass) {
    extend(AndroidShowInApp, superClass);

    function AndroidShowInApp(el) {
      var text;
      AndroidShowInApp.__super__.constructor.apply(this, arguments);
      this.schemeLink = "https://w3jvk.app.goo.gl/?link=http://coub.com/view/" + (this.el.attr('data-permalink')) + "&apn=com.coub.android";
      this.alternativeLink = "https://play.google.com/store/apps/details?id=com.coub.android";
      this.redirectHTPP = 'overlay_wia_redirect_http_android';
      this.redirectApp = 'overlay_wia_redirect_app_android';
      if (window !== window.top || navigator.userAgent.indexOf('FB_IAB') !== -1 || navigator.userAgent.indexOf('Twitter') !== -1) {
        text = I18n.embed["get_app" + (GlobalState.COUNTRY.isRussia() && '_ru' || '')];
        $('span', this.el).html(text);
        this.open = (function(_this) {
          return function() {
            return window.open(_this.alternativeLink);
          };
        })(this);
      }
    }

    return AndroidShowInApp;

  })(AbstractAppSchemeLink);

}).call(this);

/*
  Функционал добавления рекомендации на свой канал
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.ProfileAddRecommendations = (function() {
    ProfileAddRecommendations.ACTIONS = {
      CHANNEL_REMOVED: "widgets.ProfileAddRecommendations:Events:ChannelRemoved"
    };

    function ProfileAddRecommendations(opts) {
      this.hideLoader = bind(this.hideLoader, this);
      this.showLoader = bind(this.showLoader, this);
      this.hideError = bind(this.hideError, this);
      this.showError = bind(this.showError, this);
      this.removeChannel = bind(this.removeChannel, this);
      this.addChannel = bind(this.addChannel, this);
      this.parent = opts.parent;
      this.el = opts.el;
      this.content = this.el.find('.dropdown__content');
      this.list = this.el.find('ul.list');
      this.channels = Params.getBranchValue('current_user.channels').filter((function(_this) {
        return function(channel) {
          return channel.id !== parseInt(_this.parent.targetChannelId);
        };
      })(this));
      this._init();
      this._bind();
    }

    ProfileAddRecommendations.prototype._init = function() {
      return $(document).on(this.constructor.ACTIONS.CHANNEL_REMOVED, (function(_this) {
        return function(e) {
          return _this.removeChannel(e.params);
        };
      })(this));
    };

    ProfileAddRecommendations.prototype._bind = function() {
      var data, permReg;
      data = {};
      permReg = /^[a-zA-Z\-0-9\.]*$/;
      this.el.on("beforeShowed", (function(_this) {
        return function() {
          return _this.loadMyChannels();
        };
      })(this));
      this.el.on("hided", (function(_this) {
        return function() {
          return _this.hideError();
        };
      })(this));
      this.content.on('click', '.list__item', (function(_this) {
        return function(e) {
          var channelId, el, permalink;
          el = $(e.currentTarget);
          channelId = el.attr('data-channel-id');
          permalink = el.attr('data-channel-permalink');
          if (!el.hasClass('-on')) {
            data.channel_id = _this.parent.targetChannelId;
            data.permalink = permalink;
            return _this.addChannel(data, channelId);
          } else {
            data.channel_id = _this.parent.targetChannelId;
            data.id = channelId;
            return _this.removeChannel(data, channelId);
          }
        };
      })(this));
      return this.content.on('submit', 'form', (function(_this) {
        return function(e) {
          var permalink, url;
          e.preventDefault();
          url = e.currentTarget.elements.permalink.value;
          permalink = url.split("/").pop();
          if (permalink && permalink.match(permReg)) {
            data.channel_id = _this.parent.targetChannelId;
            data.permalink = permalink;
            return _this.addChannel(data);
          } else {
            return _this.showError(I18n.t('profile.errors.permalink_invalid'));
          }
        };
      })(this));
    };

    ProfileAddRecommendations.prototype.addChannel = function(data, channelId) {
      return this.parent.locker.safeExec((function(_this) {
        return function() {
          _this.parent.locker.lock();
          _this.hideError();
          _this.showLoader();
          return $.post(Routes.api_v2_channel_recommendations_path(data.channel_id), data).done(function(resp) {
            _this.list.find("li.list__item[data-channel-id='" + channelId + "']").addClass('-on');
            _this.parent.addChannels([resp.channel], {
              prepend: true
            });
            return _this.el.triggerHandler('position');
          }).fail(function(resp) {
            switch (resp.status) {
              case 422:
                return _this.showError(JSON.parse(resp.responseText).error);
              case 500:
                return ErrorMessages.internalServerError();
            }
          }).always(function() {
            _this.hideLoader();
            return _this.parent.locker.unlock();
          });
        };
      })(this));
    };

    ProfileAddRecommendations.prototype.removeChannel = function(data) {
      return this.parent.locker.safeExec((function(_this) {
        return function() {
          _this.parent.locker.lock();
          _this.hideError();
          _this.showLoader();
          return $.del(Routes.api_v2_channel_recommendations_path(data.channel_id), data).done(function(resp) {
            _this.list.find("li.list__item[data-channel-id='" + data.id + "']").removeClass('-on');
            _this.parent.removeChannelItem(data.id);
            return _this.el.triggerHandler('position');
          }).fail(function() {
            return ErrorMessages.internalServerError();
          }).always(function() {
            _this.hideLoader();
            return _this.parent.locker.unlock();
          });
        };
      })(this));
    };

    ProfileAddRecommendations.prototype.loadMyChannels = function() {
      if (this.myChannelsLoaded) {
        return;
      }
      return this.parent.locker.safeExec((function(_this) {
        return function() {
          _this.parent.locker.lock();
          _this.hideError();
          _this.showLoader();
          return $.get(Routes.my_api_v2_channel_recommendations_path(_this.parent.targetChannelId)).done(function(resp) {
            var channelsListHtml, currentChannelId, recommendedIds;
            recommendedIds = _.pluck(resp.channels, "id");
            currentChannelId = parseInt(_this.parent.targetChannelId);
            channelsListHtml = Params.getBranchValue('current_user.channels').reduce(function(html, channel) {
              var isActive;
              if (channel.id === currentChannelId) {
                return html;
              }
              isActive = recommendedIds.indexOf(channel.id) !== -1;
              return html + JST["app/site/templates/channel_item/my_recommendations_channel"]({
                channel: channel,
                isActive: isActive
              });
            }, '');
            _this.list.append(channelsListHtml);
            $('.list-wrap', _this.el).nice_scroller();
            return _this.myChannelsLoaded = true;
          }).fail(function() {
            return ErrorMessages.internalServerError();
          }).always(function() {
            _this.hideLoader();
            return _this.parent.locker.unlock();
          });
        };
      })(this));
    };

    ProfileAddRecommendations.prototype.showError = function(msg) {
      $('.input-field', this.el).addClass('error');
      return $('.-error-text', this.el).text(msg).show();
    };

    ProfileAddRecommendations.prototype.hideError = function() {
      $('.-error-text', this.el).hide();
      return $('.input-field', this.el).removeClass('error').val('');
    };

    ProfileAddRecommendations.prototype.showLoader = function() {
      return LoadRotator.appendWithOverlayAndStart(this.content);
    };

    ProfileAddRecommendations.prototype.hideLoader = function() {
      return LoadRotator.removeWithOverlay(this.content);
    };

    return ProfileAddRecommendations;

  })();

}).call(this);

/*
  Блок с рекомендованными каналами на странице канала
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.ProfileRecommendations = (function() {
    ProfileRecommendations.ATTR_NAME = "widget-profile-recommendations";

    ProfileRecommendations.EVENTS = {
      ChannelAdded: 'widgets.ProfileRecommendations:ChannelAdded'
    };

    ProfileRecommendations.prototype.CROWN_HINT_KEY = 'hide_owner_helper';

    function ProfileRecommendations(el) {
      this.changeUI = bind(this.changeUI, this);
      this.channelsPresent = bind(this.channelsPresent, this);
      this.showCrownHint = bind(this.showCrownHint, this);
      this.sorting = bind(this.sorting, this);
      this.removeChannelItem = bind(this.removeChannelItem, this);
      this.addChannels = bind(this.addChannels, this);
      this._bind = bind(this._bind, this);
      this._init = bind(this._init, this);
      this.el = el;
      this.myChannel = this.el.hasClass('-own');
      this.container = $('[data-channels]', this.el);
      this.head = this.el.find('.channels-block__heading');
      this.targetChannelId = this.el.attr('data-channel-id');
      this.targetChannelTitle = this.el.attr('channel-title');
      this.currentPage = 0;
      this.totalPages = void 0;
      this.allPagesLoaded = false;
      this._init();
      this._bind();
    }

    ProfileRecommendations.prototype._init = function() {
      this.locker = new chms.utils.Locker();
      return this.loadNextPage();
    };

    ProfileRecommendations.prototype._bind = function() {
      this.container.on('click', '.close-small', (function(_this) {
        return function(e) {
          var data, id;
          id = $(e.currentTarget).parent().attr('data-channel-id');
          data = {
            id: id,
            channel_id: _this.targetChannelId
          };
          return $(document).trigger({
            type: widgets.ProfileAddRecommendations.ACTIONS.CHANNEL_REMOVED,
            params: data
          });
        };
      })(this));
      if (this.myChannel) {
        this.addChannelHandler = new widgets.ProfileAddRecommendations({
          el: this.el.find('[widget-profile-recommendations-add]'),
          parent: this
        });
      }
      if (GlobalState.PLATFORM.isMobile()) {
        return;
      }
      return $(window).on('periodic_scroll.recommendations', (function(_this) {
        return function() {
          if (_this.allPagesLoaded) {
            return $(window).off('periodic_scroll.recommendations');
          } else if ($(window).scrollTop() > _this.container.offset().top + _this.container.height() / 2 - $(window).height()) {
            return _this.loadNextPage();
          }
        };
      })(this));
    };

    ProfileRecommendations.prototype.loadPage = function(page) {
      return $.get(Routes.api_v2_channel_recommendations_path(this.targetChannelId), {
        page: page,
        per_page: 10
      }).always((function(_this) {
        return function() {
          return _this.locker.unlock();
        };
      })(this)).fail(function() {
        return ErrorMessages.internalServerError();
      }).done((function(_this) {
        return function(resp) {
          _this.addChannels(resp.channels);
          if (resp.total_pages === page || resp.total_pages === 0) {
            return _this.allPagesLoaded = true;
          }
        };
      })(this));
    };

    ProfileRecommendations.prototype.loadNextPage = function() {
      return this.locker.safeExec((function(_this) {
        return function() {
          if (_this.allPagesLoaded) {
            return;
          }
          _this.locker.lock();
          return _this.loadPage(++_this.currentPage);
        };
      })(this));
    };

    ProfileRecommendations.prototype.addChannels = function(channels, opts) {
      var block, channel, i, len;
      if (opts == null) {
        opts = {};
      }
      if (!channels.length) {
        return;
      }
      for (i = 0, len = channels.length; i < len; i++) {
        channel = channels[i];
        if (!this.myChannel) {
          channel.channel_owner = this.targetChannelTitle;
        }
        block = $(JST['app/site/templates/channel_item/recommendation_channel'](channel));
        if (opts.prepend) {
          this.container.prepend(block);
        } else {
          this.container.append(block);
        }
        chms.utils.Autoinit.init(widgets.WidgetFollowButtonInit, block);
      }
      this.changeUI();
      if (this.myChannel) {
        return this.sorting();
      }
    };

    ProfileRecommendations.prototype.removeChannelItem = function(id) {
      this.container.find(".channel[data-channel-id='" + id + "']").parent().remove();
      return this.changeUI();
    };

    ProfileRecommendations.prototype.sorting = function() {
      return this.container.sortable({
        handle: $('[data-sort-handle]', this.container),
        start: (function(_this) {
          return function(e, ui) {
            return $('.antiscroll-wrap', _this.el).css({
              'overflow': 'visible'
            });
          };
        })(this),
        stop: (function(_this) {
          return function(e, ui) {
            return $('.antiscroll-wrap', _this.el).css({
              'overflow': 'hidden'
            });
          };
        })(this),
        update: (function(_this) {
          return function(e, ui) {
            var id, position;
            id = $(ui.item[0]).find('.channel').attr('data-channel-id');
            position = _this.container.find('.channel--simple').length - $(ui.item[0]).index() + 1;
            return $.put(Routes.api_v2_channel_recommendations_path(_this.targetChannelId), {
              id: id,
              channel_id: _this.targetChannelId,
              position: position
            });
          };
        })(this)
      });
    };

    ProfileRecommendations.prototype.showCrownHint = function() {
      if (!$.storage.get(this.CROWN_HINT_KEY)) {
        this.addChannelHandler.el.trigger('hide');
        return widgets.hints.SimpleHint.setHint({
          el: this.el.find('i.crown').first(),
          key: this.CROWN_HINT_KEY,
          position: 'below-center -below',
          locales: {
            heading: I18n.t('guide.simple_helper.hide_owner_helper_title'),
            sub: I18n.t('guide.simple_helper.hide_owner_helper')
          }
        });
      }
    };

    ProfileRecommendations.prototype.channelsPresent = function() {
      return this.el.find('.channel.channel--simple').length;
    };

    ProfileRecommendations.prototype.changeUI = function() {
      $("[data-prompt]", this.el).prompt();
      if (this.channelsPresent()) {
        this.head.addClass('channels-block__heading--no-padding').find('h3').html(I18n.t('channel_recommendation.with_channels_title', {
          title: this.targetChannelTitle
        }));
        this.el.removeClass('-empty -ribbon');
      } else {
        this.head.removeClass('channels-block__heading--no-padding').find('h3').html(I18n.t('channel_recommendation.recommend'));
        this.el.addClass('-empty -ribbon');
      }
      return this.el.trigger(widgets.ProfileRecommendations.EVENTS.ChannelAdded);
    };

    return ProfileRecommendations;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.RestorableForm = (function() {
    function RestorableForm(form) {
      this.refreshCustomWidgets = bind(this.refreshCustomWidgets, this);
      this.restore = bind(this.restore, this);
      this.remember = bind(this.remember, this);
      this.form = form;
      this.remember();
      this.afterRestore = (function(_this) {
        return function() {
          return null;
        };
      })(this);
    }

    RestorableForm.prototype.remember = function() {
      var field, i, key, len, ref, results, t;
      this.stored = {};
      ref = this.form.find("[name]");
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        field = ref[i];
        field = $(field);
        t = field.attr("type");
        key = (field.attr("name")) + "#" + t;
        this.stored[key] = {
          el: field,
          t: t
        };
        switch (t) {
          case "checkbox":
            results.push(this.stored[key].val = field.is(":checked"));
            break;
          default:
            results.push(this.stored[key].val = field.val());
        }
      }
      return results;
    };

    RestorableForm.prototype.restore = function() {
      var d, name, ref;
      ref = this.stored;
      for (name in ref) {
        d = ref[name];
        switch (d.t) {
          case "checkbox":
            if (d.val) {
              d.el.attr("checked", d.val);
            } else {
              d.el.removeAttr("checked");
            }
            break;
          default:
            d.el.val(d.val);
        }
      }
      this.refreshCustomWidgets();
      return this.afterRestore();
    };

    RestorableForm.prototype.refreshCustomWidgets = function() {
      $(".visibilitySelect", this.form).each(function() {
        return $(this).trigger(NiceSelect.ACTION_REFRESH);
      });
      return $(".tagit-hidden-input", this.form).each(function() {
        return $(this).tagit("refresh");
      });
    };

    return RestorableForm;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.Scroller = (function() {
    function Scroller() {
      this.timeout = bind(this.timeout, this);
      this.coverHandler = bind(this.coverHandler, this);
      this.defaultHandler = bind(this.defaultHandler, this);
      this.getUIHandler = bind(this.getUIHandler, this);
      this.getType = bind(this.getType, this);
      var attachV, fire, fireV, handler, type;
      this.header = $('header.header');
      this.mobile = GlobalState.PLATFORM.isMobile();
      this.h = helpers.Scrollers;
      if (window.requestAnimationFrame != null) {
        this.frame = true;
      } else {
        this.frame = false;
      }
      type = this.getType();
      handler = this.getUIHandler(type);
      attachV = this.h.getAttachValue(type);
      fireV = this.h.getFireValue(type);
      fire = (function(_this) {
        return function() {
          return handler(attachV);
        };
      })(this);
      $(window).on('scroll', _.throttle(fire, fireV));
      if (GlobalState.UI.hasSolidHeader()) {
        this.header.addClass('solid');
      }
    }

    Scroller.prototype.getType = function() {
      var type;
      if (this.h.withTransHeader()) {
        type = 'cover';
      } else {
        type = 'default';
      }
      return type;
    };

    Scroller.prototype.getUIHandler = function(type) {
      var handler;
      handler = this[type + "Handler"];
      if (handler != null) {
        return handler;
      } else {
        throw "Not existing handler, Scroller." + type + "Handler";
      }
    };

    Scroller.prototype.defaultHandler = function(value) {
      var attach, detach;
      attach = (function(_this) {
        return function() {
          return _this.header.addClass('-scrolled');
        };
      })(this);
      detach = (function(_this) {
        return function() {
          return _this.header.removeClass('-scrolled');
        };
      })(this);
      return this.h.changeUI(value, attach, detach, this.frame);
    };

    Scroller.prototype.coverHandler = function(value) {
      var attach, detach;
      attach = (function(_this) {
        return function() {
          if (!_this.header.hasClass('-lock')) {
            _this.header.removeClass('-transparent');
          }
          return _this.header.addClass('-scrolled');
        };
      })(this);
      detach = (function(_this) {
        return function() {
          if (!_this.header.hasClass('-lock')) {
            _this.header.addClass('-transparent');
          }
          return _this.header.removeClass('-scrolled');
        };
      })(this);
      return this.h.changeUI(value, attach, detach, this.frame);
    };

    Scroller.prototype.timeout = function(value, handler) {
      return setTimeout((function(_this) {
        return function() {
          return handler;
        };
      })(this), value);
    };

    Scroller.construct = function() {
      if (!GlobalState.UI.hasStaticHeader()) {
        return new window.Scroller();
      }
    };

    return Scroller;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.Toggler = (function() {
    Toggler.ACTION_SHOW = "Toggler:Show";

    Toggler.ACTION_HIDE = "Toggler.Hide";

    function Toggler(controller, element, options) {
      if (options == null) {
        options = {};
      }
      this.perform = bind(this.perform, this);
      this.hide = bind(this.hide, this);
      this.show = bind(this.show, this);
      this.toggle = bind(this.toggle, this);
      this.controller = controller;
      this.element = element;
      this.animator = options.animator != null ? options.animator : new TogglerAnimators()["default"];
      this.beforeToggle = options.beforeToggle != null ? options.beforeToggle : ((function(_this) {
        return function() {
          return null;
        };
      })(this));
      this.controller.bind("click", this.toggle);
    }

    Toggler.prototype.toggle = function() {
      if (this.element.is(":visible")) {
        this.perform(Toggler.ACTION_HIDE);
        return $(document).trigger(Toggler.ACTION_HIDE);
      } else {
        this.perform(Toggler.ACTION_SHOW);
        return $(document).trigger(Toggler.ACTION_SHOW);
      }
    };

    Toggler.prototype.show = function() {
      if (!this.element.is(":visible")) {
        this.perform(Toggler.ACTION_SHOW);
        return true;
      } else {
        return false;
      }
    };

    Toggler.prototype.hide = function() {
      if (this.element.is(":visible")) {
        this.perform(Toggler.ACTION_HIDE);
        return true;
      } else {
        return false;
      }
    };

    Toggler.prototype.perform = function(action) {
      this.beforeToggle(action);
      return this.animator(this.controller, this.element, action);
    };

    return Toggler;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.TogglerAnimators = (function(superClass) {
    extend(TogglerAnimators, superClass);

    function TogglerAnimators() {
      this.blind = bind(this.blind, this);
      this.cssMoreLess = bind(this.cssMoreLess, this);
      this["default"] = bind(this["default"], this);
      return TogglerAnimators.__super__.constructor.apply(this, arguments);
    }

    TogglerAnimators.prototype["default"] = function(controller, element, action) {
      if (action === Toggler.ACTION_SHOW) {
        element.show();
      } else {
        element.hide();
      }
      return this.sendAnimationComplete();
    };

    TogglerAnimators.prototype.cssMoreLess = function(controller, element, action) {
      var toggle;
      toggle = (function(_this) {
        return function() {
          return controller.add(element).toggleClass('-less');
        };
      })(this);
      return requestAnimationFrame(toggle);
    };

    TogglerAnimators.prototype.blind = function(controller, element, action) {
      var hide, show;
      show = (function(_this) {
        return function() {
          element.css({
            opacity: 0
          }).show("blind");
          setTimeout((function() {
            return element.animate({
              opacity: 1
            }, 150);
          }), 150);
          return _this.sendAnimationComplete();
        };
      })(this);
      hide = (function(_this) {
        return function() {
          element.animate({
            opacity: 0
          }, 150);
          setTimeout((function() {
            return element.hide("blind");
          }), 75);
          return _this.sendAnimationComplete();
        };
      })(this);
      if (action === Toggler.ACTION_SHOW) {
        return show();
      } else {
        return hide();
      }
    };

    return TogglerAnimators;

  })(CoubAnimators.AbstractAnimator);

}).call(this);
(function() {
  window.validations = {};

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.validations.EmailValidation = (function() {
    function EmailValidation(emailInput, inputContainer, permalink) {
      this.hideErrorOnEmailInput = bind(this.hideErrorOnEmailInput, this);
      this.showErrorOnEmailInput = bind(this.showErrorOnEmailInput, this);
      this.hideLoader = bind(this.hideLoader, this);
      this.showLoader = bind(this.showLoader, this);
      this.input = emailInput;
      this.inputContainer = inputContainer;
      this.permalink = permalink;
      this.provider = new LoginDataProvider();
      new RemoteValidator(this.input, ((function(_this) {
        return function(val, success, error) {
          _this.hideErrorOnEmailInput();
          _this.showLoader();
          return _this.provider.validateAndCheckUniqEmailAndPermalink(val, _this.permalink, success, error, _this.hideLoader);
        };
      })(this)), {
        beforeCheck: (function(_this) {
          return function(val) {
            if (!val.match(CoubEnvironment.USER.EMAIL_REGEXP)) {
              _this.showErrorOnEmailInput(I18n.PROFILE.ERRORS.EMAIL_IS_INVALID);
              return false;
            } else {
              return true;
            }
          };
        })(this),
        success: (function(_this) {
          return function(resp) {
            switch (resp.result.email) {
              case "taken":
                return _this.showErrorOnEmailInput(I18n.PROFILE.ERRORS.EMAIL_IS_REGISTERED);
              default:
                return _this.hideErrorOnEmailInput();
            }
          };
        })(this),
        error: (function(_this) {
          return function(resp) {
            if (resp.readyState === 4) {
              return ErrorMessages.internalServerError();
            }
          };
        })(this)
      });
    }

    EmailValidation.prototype.showLoader = function() {
      return this.input.addClass("loading");
    };

    EmailValidation.prototype.hideLoader = function() {
      return this.input.removeClass("loading");
    };

    EmailValidation.prototype.showErrorOnEmailInput = function(error) {
      var e;
      if ((e = $("label.-error-text", this.inputContainer)).size() === 0) {
        this.inputContainer.append("<label for=\"user_email\" class=\"-error-text\"></label>");
        e = $("label.-error-text", this.inputContainer);
      }
      this.input.addClass("error");
      this.inputContainer.addClass('error');
      e.text(error);
      if (!e.is(":visible")) {
        return e.show("blind");
      }
    };

    EmailValidation.prototype.hideErrorOnEmailInput = function() {
      $("label.-error-text", this.inputContainer).hide();
      this.inputContainer.removeClass('error');
      return this.input.removeClass("error");
    };

    return EmailValidation;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.validations.PermalinkValidation = (function() {
    function PermalinkValidation(permalinkInput, inputContainer, channelId) {
      this.hideErrorOnPermalink = bind(this.hideErrorOnPermalink, this);
      this.showErrorOnPermalink = bind(this.showErrorOnPermalink, this);
      this.hideLoader = bind(this.hideLoader, this);
      this.showLoader = bind(this.showLoader, this);
      this.PERMALINK_STRUCTURE_REGEXP = /^[a-zA-Z\-0-9\.]*$/;
      this.MIN_PERMALINK_LENGTH = 8;
      this.input = permalinkInput;
      this.inputContainer = inputContainer;
      this.provider = new LoginDataProvider();
      new RemoteValidator(this.input, ((function(_this) {
        return function(val, success, error) {
          _this.hideErrorOnPermalink();
          _this.showLoader();
          return _this.provider.validateChannelPermalink(val, channelId, success, error, _this.hideLoader);
        };
      })(this)), {
        beforeCheck: (function(_this) {
          return function(val) {
            if (!val.match(CoubEnvironment.USER.PERMALINK_REGEXP)) {
              if (!val.match(_this.PERMALINK_STRUCTURE_REGEXP)) {
                _this.showErrorOnPermalink(I18n.PROFILE.ERRORS.PERMALINK_INVALID);
              } else if (val.match(/\.$/)) {
                _this.showErrorOnPermalink(I18n.PROFILE.ERRORS.PERMALINK_ENDS_WITH_DOT);
              }
              return false;
            } else {
              return true;
            }
          };
        })(this),
        immediateCheck: (function(_this) {
          return function(val) {
            if (_this.input.val().length < _this.MIN_PERMALINK_LENGTH) {
              _this.showErrorOnPermalink(I18n.PROFILE.ERRORS.PERMALINK_TOO_SHORT);
              return false;
            } else {
              _this.hideErrorOnPermalink();
              return true;
            }
          };
        })(this),
        success: (function(_this) {
          return function(resp) {
            switch (resp.result) {
              case "taken":
                return _this.showErrorOnPermalink(I18n.PROFILE.ERRORS.PERMALINK_UNAVAILABLE);
              default:
                return _this.hideErrorOnPermalink();
            }
          };
        })(this),
        error: (function(_this) {
          return function(resp) {
            if (resp.readyState === 4) {
              return ErrorMessages.internalServerError();
            }
          };
        })(this)
      });
    }

    PermalinkValidation.prototype.showLoader = function() {
      return this.input.addClass("loading");
    };

    PermalinkValidation.prototype.hideLoader = function() {
      return this.input.removeClass("loading");
    };

    PermalinkValidation.prototype.showErrorOnPermalink = function(error) {
      var e;
      if ((e = $("label.-error-text", this.inputContainer)).size() === 0) {
        this.inputContainer.append("<label for=\"channel_permalink\" class=\"-error-text\"></label>");
        e = $("label.-error-text", this.inputContainer);
      }
      e.text(error);
      this.input.addClass("error");
      this.inputContainer.addClass('error');
      if (!e.is(":visible")) {
        return e.show("blind");
      }
    };

    PermalinkValidation.prototype.hideErrorOnPermalink = function() {
      $("label.-error-text", this.inputContainer).hide();
      this.inputContainer.removeClass('error');
      return this.input.removeClass("error");
    };

    return PermalinkValidation;

  })();

}).call(this);

/*
  Дропдаун с выбором каналов.
 */

(function() {
  blocks.ChannelMenuDropdown = (function() {
    ChannelMenuDropdown.ATTR_NAME = "blocks-channel-menu-dropdown";

    function ChannelMenuDropdown(el) {
      var content, eventOpen, i, len, subw, w;
      this.el = el;
      content = $(JST["app/site/templates/blocks/channel_menu_dropdown/content"]());
      content.nice_scroller();
      eventOpen = GlobalState.PLATFORM.isMobile() ? "click" : "mouseenter";
      this.dropdown = new window.HoverableAbsoluteDropdown({
        el: this.el,
        classNames: "channel-menu-dropdown",
        defaultContent: content,
        handle: this.el,
        handlerEventOpen: eventOpen,
        dropdownPosition: AbsoluteDropdown.POSITION_TYPE.ABSOLUTE_BOTTOM,
        handlerEventClose: HoverableAbsoluteDropdown.EVENTS.MOUSEOUT_TIMEOUT,
        hideTimeout: 150,
        animationDuration: 1
      });
      subw = [widgets.ChannelChanger, channels.CreateChannelPopup, widgets.AvatarChangeListener];
      for (i = 0, len = subw.length; i < len; i++) {
        w = subw[i];
        chms.utils.Autoinit.init(w, content);
      }
    }

    return ChannelMenuDropdown;

  })();

}).call(this);
(function() {
  blocks.ChannelsBlock = (function() {
    ChannelsBlock.ATTR_NAME = 'blocks-channels-block';

    function ChannelsBlock(el) {
      this.el = el;
      this.opts = this.el.data();
      this.fetch();
    }

    ChannelsBlock.prototype.fetch = function() {
      return $.get(this.opts.url, (function(_this) {
        return function(resp) {
          var template;
          template = JST["app/site/templates/blocks/channels_block/channels_block"](_.extend(_this.opts, {
            channels: _.sample(resp.channels, _this.opts.count)
          }));
          _this.el.html(template);
          chms.utils.Autoinit.init(widgets.WidgetFollowButtonInit, _this.el);
          return $('.coubs-list').triggerHandler(clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_CONTENTS);
        };
      })(this));
    };

    return ChannelsBlock;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.clientsideTimeline = {};


  /*
    Клиентсайд таймлайн (рендерит карточки на клиенте).
  
    Если у элемента есть аттрибут show-no-coubs-stub тогда
    заглушка о том что нет кобов может быть отображена.
    Этот аттрибут должен содержать имя юзера.
  
    Если у элемента есть аттрибут ATTR_NO_COUBS_STUB_TEXT тогда
    он будет использован в заглушке.
  
    Если у элемента есть аттрибут data-source-json тогда таймлайн не будет запрашивать
    данные с сервера и будет рендерить данные из переданного жсона. Для того чтобы передать
    жсон надо тригернуть на элементе событие ACTION_SET_DATA_SOURCE_JSON и передать нужный
    жсон в качестве параметра:
      $("[clientside-timeline]").trigger(clientsideTimeline.ClientsideTimeline.ACTION_SET_DATA_SOURCE_JSON, [JSON])
   */

  window.clientsideTimeline.ClientsideTimeline = (function() {
    ClientsideTimeline.prototype.PRELOAD_HEIGHT = 1080;

    ClientsideTimeline.ACTION_UPDATE_PROPERTIES = "clientsideTimeline.ClientsideTimeline:Actions:UpdateProperties";

    ClientsideTimeline.ACTION_SET_DATA_SOURCE_JSON = "clientsideTimeline-ClientsideTimeline:Actions:SetDataSourceJson";

    ClientsideTimeline.ACTION_SET_RENDER_DATA = "clientsideTimeline-ClientsideTimeline:Actions:SetRenderData";

    ClientsideTimeline.ACTION_RELOAD = "clientsideTimeline-ClientsideTimeline:Actions:Reload";

    ClientsideTimeline.ACTION_UPDATE_VIEW = "clientsideTimeline.ClientsideTimeline:Actions:UpdateView";

    ClientsideTimeline.ACTION_UPDATE_CONTENTS = "clientsideTimeline.ClientsideTimeline:Actions:UpdateContents";

    ClientsideTimeline.EVENT_ALL_PAGES_LOADED = "clientsideTimeline.ClientsideTimeline:Events:AllPagesLoaded";

    ClientsideTimeline.EVENT_FIRST_PAGE_LOADED = "clientsideTimeline.ClientsideTimeline:Events:FirstPageLoaded";

    ClientsideTimeline.EVENT_VIEW_CHANGED = "clientsideTimeline.ClientsideTimeline:Events:ViewChanged";

    ClientsideTimeline.EVENT_PAGE_START_LOADING = "clientsideTimeline-ClientsideTimeline:Events:PageStartLoading";

    ClientsideTimeline.TYPE_COUBS = "clientsideTimeline-ClientsideTimeline:Type:Coubs";

    ClientsideTimeline.TYPE_STORIES = "clientsideTimeline-ClientsideTimeline:Type:Stories";

    ClientsideTimeline.prototype.DT = "clientsideTimeline.ClientsideTimeline";

    function ClientsideTimeline(el) {
      this.delayedCoubsInit = bind(this.delayedCoubsInit, this);
      this.isDataSourceJson = bind(this.isDataSourceJson, this);
      this.showNoCoubsStubIfAllowed = bind(this.showNoCoubsStubIfAllowed, this);
      this.getViewerContainer = bind(this.getViewerContainer, this);
      this.updateCurrentCoubIndex = bind(this.updateCurrentCoubIndex, this);
      this.loadNextPage = bind(this.loadNextPage, this);
      this.loadCurrentPage = bind(this.loadCurrentPage, this);
      this.getAdditionalProps = bind(this.getAdditionalProps, this);
      this.hasAdditionalOpts = bind(this.hasAdditionalOpts, this);
      this.updateProperties = bind(this.updateProperties, this);
      this.reload = bind(this.reload, this);
      this.onContentsUpdate = bind(this.onContentsUpdate, this);
      this.onCoubDelete = bind(this.onCoubDelete, this);
      this.setRenderData = bind(this.setRenderData, this);
      this.setDataSourceJson = bind(this.setDataSourceJson, this);
      this.s = clientsideTimeline.ClientsideTimeline;
      this.el = el;
      this.dynopt = new blocks.clientsideTimeline.DynamicOptimization(this);
      this.coubsInitQueue = [];
      this.provider = new TimelineDataProvider();
      this.loadingLocker = new chms.utils.Locker();
      this.initialLoadIndicator = LoadIndicator.appendToContainer($('.initial-load-indicator', this.el), LoadIndicator.SIZE.BIG, LoadIndicator.ALIGN.TOP_CENTER);
      this.nextPageLoadIndicator = LoadIndicator.appendToContainer($('.next-page-load-indicator', this.el), LoadIndicator.SIZE.BIG);
      this.nextPageLoadIndicator.hide();
      this.list = $('.coubs-list__inner', this.el);
      this.additionalOptsExistense = this.hasAdditionalOpts();
      this.scrollOptimizer = new ScrollEventOptimizer(this.processPreloadMore.bind(this));
      $(document).on(CoubBlockClientside.ACTION_DELETE, this.onCoubDelete);
      this.retryCounter = new functions.RetryCounter();
      this.reload();
      this.el.on(clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_PROPERTIES, (function(_this) {
        return function(e, props) {
          return _this.updateProperties(props);
        };
      })(this)).on(clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_VIEW, (function(_this) {
        return function(e) {
          return _this.setCurrentView(e.view);
        };
      })(this)).on(clientsideTimeline.ClientsideTimeline.ACTION_SET_DATA_SOURCE_JSON, this.setDataSourceJson).on(clientsideTimeline.ClientsideTimeline.ACTION_SET_RENDER_DATA, this.setRenderData).on(clientsideTimeline.ClientsideTimeline.ACTION_RELOAD, this.reload).on(clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_CONTENTS, this.onContentsUpdate);
      if (GlobalState.PAGE.isProfile() && $(window).height() >= this.PRELOAD_HEIGHT) {
        this.el.on(clientsideTimeline.ClientsideTimeline.EVENT_FIRST_PAGE_LOADED, _.wrap(this.loadNextPage, _.defer));
      }
      this.el.on("dom_remove", this.destroy.bind(this));
    }

    ClientsideTimeline.prototype.setDataSourceJson = function(e, json) {
      this.jsonDataSource = json;
      return this.appendCoubs(this.jsonDataSource);
    };

    ClientsideTimeline.prototype.setRenderData = function(e, data) {
      this.extraRenderData = data;
      return this.reload();
    };

    ClientsideTimeline.prototype.isFullyLoaded = function() {
      if (this.isDataSourceJson()) {
        return true;
      } else if (this.totalPages != null) {
        return (this.currentPage + 1) > this.totalPages;
      } else {
        return this.nextAnchor === null;
      }
    };

    ClientsideTimeline.prototype.destroy = function() {
      this.coubsInitQueue = [];
      this.dynopt && this.dynopt.destroy();
      this.destroyTimelineView();
      this.scrollOptimizer.disactivate();
      $(document).off(CoubBlockClientside.ACTION_DELETE, this.onCoubDelete);
      this.list.find('.page').remove();
      return this.el.removeAttr('view').off([clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_PROPERTIES, clientsideTimeline.ClientsideTimeline.ACTION_SET_DATA_SOURCE_JSON, clientsideTimeline.ClientsideTimeline.ACTION_SET_RENDER_DATA, clientsideTimeline.ClientsideTimeline.ACTION_RELOAD, clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_VIEW, clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_CONTENTS, clientsideTimeline.ClientsideTimeline.EVENT_ALL_PAGES_LOADED, clientsideTimeline.ClientsideTimeline.EVENT_FIRST_PAGE_LOADED, clientsideTimeline.ClientsideTimeline.EVENT_VIEW_CHANGED, clientsideTimeline.ClientsideTimeline.EVENT_PAGE_START_LOADING].join(' '));
    };

    ClientsideTimeline.prototype.onCoubDelete = function(e, permalink) {
      return _.defer((function(_this) {
        return function() {
          var $coubBlock;
          $coubBlock = _this.list.find("[data-permalink='" + permalink + "']");
          _this.dynopt && _this.dynopt.removeData($coubBlock.get(0));
          return _this.onContentsUpdate();
        };
      })(this));
    };

    ClientsideTimeline.prototype.onContentsUpdate = function() {
      if ((this.currentView != null) && this.currentView.name === blocks.clientsideTimeline.TimelineViews.views.mosaic.name) {
        this.getTimelineView().recalculateMosaic();
      }
      if (!this.dynopt) {
        return;
      }
      this.dynopt.refreshOffsets();
      return this.dynopt.render();
    };

    ClientsideTimeline.prototype.scrollToPageMenu = function() {
      var pageMenu, pageMenuShift, targetTop;
      pageMenu = $('.page-menu');
      if (!pageMenu.length) {
        return;
      }
      pageMenuShift = parseInt(pageMenu.css('top')) || 0;
      targetTop = this.list.offset().top - pageMenu.outerHeight(true) - pageMenuShift;
      if ($(window).scrollTop() > targetTop) {
        return $(window).scrollTop(targetTop);
      }
    };

    ClientsideTimeline.prototype.reload = function() {
      var attr, j, len, m, ref;
      if (this.loadPageQuery != null) {
        this.loadPageQuery.abort();
        this.nextPageLoadIndicator.hide();
      }
      this.destroyTimelineView();
      this.scrollToPageMenu();
      this.coubsInitQueue = [];
      this.dynopt && this.dynopt.invalidateData();
      this.list.find(".page").remove();
      $('body').removeClass('unsafe-for-ads');
      this.providerUrl = this.el.attr("url");
      if (!this.providerUrl) {
        throw "ClientsideTimeline: it requires url in order to work";
      }
      this.providerData = {};
      this.renderData = $.extend({
        'no-sharing': true
      }, this.extraRenderData);
      ref = this.el[0].attributes;
      for (j = 0, len = ref.length; j < len; j++) {
        attr = ref[j];
        m = attr.name.match(/^data-(.+)/i);
        if ((m != null) && (m[1] != null)) {
          this.providerData[m[1]] = attr.value;
        }
        m = attr.name.match(/^render-(.+)/i);
        if ((m != null) && (m[1] != null)) {
          this.renderData[m[1]] = attr.value;
        }
      }
      this.currentPage = 1;
      this.nextAnchor = void 0;
      this.totalPages = void 0;
      this.currentCoubIndex = 0;
      if (this.getCurrentType() === this.s.TYPE_COUBS) {
        this.getTimelineView().render();
        this.getTimelineView().initialize(this.list, true);
      }
      if (!this.isDataSourceJson()) {
        this.initialLoadIndicator.show();
        return this.loadCurrentPage();
      }
    };

    ClientsideTimeline.prototype.updateProperties = function(props) {
      var prop, value;
      if (props == null) {
        props = {};
      }
      if (this.additionalOptsExistense) {
        this.el.attr('additional-opts', JSON.stringify(props));
      } else {
        for (prop in props) {
          value = props[prop];
          this.el.attr("data-" + prop, value);
        }
      }
      return this.reload();
    };

    ClientsideTimeline.prototype.hasAdditionalOpts = function() {
      return !_.isEmpty(this.el.attr('additional-opts'));
    };

    ClientsideTimeline.prototype.getAdditionalProps = function() {
      return JSON.parse(this.el.attr('additional-opts'));
    };

    ClientsideTimeline.prototype.loadCurrentPage = function() {
      return this.loadingLocker.safeExec((function(_this) {
        return function() {
          _this.el.trigger(_this.s.EVENT_PAGE_START_LOADING);
          _this.loadingLocker.lock();
          _this.providerData.page = _this.currentPage;
          _this.providerData.anchor = _this.nextAnchor;
          if (_this.additionalOptsExistense) {
            _this.providerData = $.extend({}, _this.providerData, _this.getAdditionalProps());
          }
          return _this.loadPageQuery = _this.provider.getByUrl(_this.providerUrl, _this.providerData, {
            success: function(r) {
              var isSafeForAds, url;
              _this.retryCounter.loadSuccess();
              _this.totalPages = r.total_pages;
              _this.nextAnchor = r.next;
              if (parseInt(r.page) === 1) {
                _this.el.trigger(clientsideTimeline.ClientsideTimeline.EVENT_FIRST_PAGE_LOADED);
              }
              if (parseInt(r.page) === parseInt(_this.totalPages)) {
                _this.el.trigger(clientsideTimeline.ClientsideTimeline.EVENT_ALL_PAGES_LOADED);
              }
              _this.logPageLoaded();
              if (_this.currentPage > 1) {
                url = window.location.pathname + "/page-" + _this.currentPage;
                ga('send', 'pageview', url);
                console.log("[DEBUG]", "pageview!", url);
              }
              switch (_this.getCurrentType()) {
                case _this.s.TYPE_COUBS:
                  if (GlobalState.TIMELINE.type() === 'best2014_tags') {
                    _this.appendCoubs(r.coubs, {
                      tag_title: r.description
                    });
                  } else if (GlobalState.TIMELINE.type() === 'best2015_memes' || GlobalState.TIMELINE.type() === 'best2016_memes') {
                    _this.appendCoubs(r.coubs, {
                      meme_title: r.description
                    });
                  } else {
                    isSafeForAds = r.coubs.every(function(c) {
                      return c.recoub_to && c.recoub_to.is_safe_for_ads || c.is_safe_for_ads;
                    });
                    if (!isSafeForAds) {
                      $('body').addClass('unsafe-for-ads');
                    }
                    _this.appendCoubs(_.filter(r.coubs, function(c) {
                      return c.type !== 'Coub::Temp';
                    }));
                  }
                  break;
                case _this.s.TYPE_STORIES:
                  _this.appendStories(r.stories);
              }
              _this.loadingLocker.unlock();
              return window.ym && ym(48571952, "reachGoal", "page_scroll", {
                page_num: r.page
              });
            },
            error: function() {
              var ntry;
              if (_this.loadPageQuery.statusText !== "abort") {
                _this.currentPage--;
                ntry = function() {
                  _this.loadingLocker.unlock();
                  return _this.loadNextPage();
                };
                if (!_this.retryCounter.tryAgain(ntry)) {
                  _this.nextPageLoadIndicator.hide();
                  return Growl.msg(I18n.growl_errors.reload.header, I18n.growl_errors.reload.error);
                }
              } else {
                return _this.loadingLocker.unlock();
              }
            }
          });
        };
      })(this));
    };

    ClientsideTimeline.prototype.loadNextPage = function() {
      return this.loadingLocker.safeExec((function(_this) {
        return function() {
          if (!_this.isFullyLoaded()) {
            _this.currentPage += 1;
            _this.nextPageLoadIndicator.show();
            return _this.loadCurrentPage();
          }
        };
      })(this));
    };

    ClientsideTimeline.prototype.appendStories = function(stories) {
      var date, dateToShow, dt, j, len, page, s, story, storyDate;
      this.initialLoadIndicator.hide();
      this.nextPageLoadIndicator.hide();
      page = $('<div class="page"></div>');
      for (j = 0, len = stories.length; j < len; j++) {
        s = stories[j];
        if (GlobalState.PAGE.isFeaturedStoriesPage()) {
          storyDate = new Date(s.featured_at);
          if (!this.todayDate) {
            this.todayDate = storyDate;
          }
          dt = Math.round(new moment.duration(this.todayDate - storyDate).asDays());
          if (dt > 0) {
            dateToShow = (function() {
              switch (dt) {
                case 1:
                  return I18n.t('stories.dates.yesterday');
                case 2:
                  return I18n.t('stories.dates.before_yesterday');
                default:
                  return I18n.t('stories.dates.earlier');
              }
            })();
          }
          if (dateToShow && this.lastShowedDate !== dateToShow) {
            this.lastShowedDate = dateToShow;
            date = $("<h5>" + dateToShow + "</h5>");
            page.append(date);
          }
        }
        story = $(JST['app/site/templates/story/story_card'](s));
        page.append(story);
      }
      this.list.append(page);
      if (this.currentPage === 1 && stories.length === 0) {
        this.showNoCoubsStubIfAllowed(page);
      }
      chms.utils.Autoinit.init(widgets.StoryCard, page);
      return this.el.trigger('page:loaded');
    };

    ClientsideTimeline.prototype.appendCoubs = function(coubs, extra) {
      var $card, afterRender, ci, coub, data, isMosaic, j, len, pageContainer, renderAdCallback, tileBanner, timelineCoubsCount;
      this.initialLoadIndicator.hide();
      this.nextPageLoadIndicator.hide();
      pageContainer = $(JST["app/site/templates/timeline/page"]({
        pageNum: this.currentPage,
        timeline: GlobalState.TIMELINE.type(),
        extra: extra
      }));
      isMosaic = this.currentView.name === blocks.clientsideTimeline.TimelineViews.views.mosaic.name;
      if (isMosaic && this.renderData) {
        delete this.renderData["editor-controls"];
      }
      if (this.hasTimelineBanners() && !(this.renderData && this.renderData["editor-controls"])) {
        timelineCoubsCount = $('.coub', this.list).length;
        afterRender = $.Callbacks('once');
      }
      for (ci = j = 0, len = coubs.length; j < len; ci = ++j) {
        coub = coubs[ci];
        timelineCoubsCount += 1;
        coub.render = this.renderData;
        coub.timelineIndex = ci;
        coub.timelinePage = this.currentPage;
        data = JSON.stringify(coub);
        $card = $(JST["app/site/templates/coub_block/coub"](coub));
        $('<div/>', {
          text: data,
          "class": 'data -hidden'
        }).appendTo($card);
        if (this.hasTimelineBanners() && !(this.renderData && this.renderData["editor-controls"])) {
          if (isMosaic && timelineCoubsCount % 30 === 0) {
            tileBanner = new widgets.AdfoxTileWidget();
            pageContainer.append(tileBanner.render());
            afterRender.add(tileBanner.load.bind(tileBanner));
          } else if (!isMosaic) {
            if ((timelineCoubsCount - 2) % 7 === 0) {
              renderAdCallback = function($anchor, isFirstPage) {
                return widgets.PromotedCoub.load($anchor, this.renderData).fail(function() {
                  return GlobalState.COUNTRY.isExUssr() && new widgets.AdTimelineBanners($anchor, isFirstPage);
                });
              };
              afterRender.add(renderAdCallback.bind(this, $card, timelineCoubsCount < 7));
            }
          }
        }
        pageContainer.append($card);
      }
      this.list.append(pageContainer);
      afterRender && afterRender.fire();
      if (this.currentPage === 1 && coubs.length === 0) {
        this.showNoCoubsStubIfAllowed(pageContainer);
      }
      this.attachCoubHandlers(pageContainer);
      this.getTimelineView().appendPage(pageContainer);
      return this.el.trigger('page:loaded');
    };

    ClientsideTimeline.prototype.processPreloadMore = function() {
      return this.loadingLocker.safeExec((function(_this) {
        return function() {
          if (_this.getTimelineView().isLoadNew()) {
            return _this.loadNextPage();
          }
        };
      })(this));
    };

    ClientsideTimeline.prototype.getCurrentType = function() {
      if (this.el.attr('data-type') === 'stories') {
        return this.s.TYPE_STORIES;
      } else {
        return this.s.TYPE_COUBS;
      }
    };

    ClientsideTimeline.prototype.updateCurrentCoubIndex = function() {
      return this.currentCoubIndex = $('.coub', this.el).index($('.coub.active', this.el));
    };

    ClientsideTimeline.prototype.getViewerContainer = function(block) {
      return $('.viewer', block);
    };

    ClientsideTimeline.prototype.getNextBlock = function(b) {
      var ind;
      ind = $('.coub', this.el).index(b);
      return $('.coub', this.el).eq(ind + 1);
    };

    ClientsideTimeline.prototype.attachCoubHandlers = function(container) {
      var $container;
      $container = $(container);
      if ($container.is('[coub-block]')) {
        $container.filter('[coub-block]').not(".timeline-banner").each((function(_this) {
          return function(i, el) {
            return _this.coubsInitQueue.push(el);
          };
        })(this));
      } else {
        $('[coub-block]', $container).not(".timeline-banner").each((function(_this) {
          return function(i, el) {
            return _this.coubsInitQueue.push(el);
          };
        })(this));
      }
      cancelAnimationFrame(this.delayedCoubsInitTimeout);
      return this.delayedCoubsInitTimeout = requestAnimationFrame(this.delayedCoubsInit);
    };

    ClientsideTimeline.prototype.getCurrentView = function() {
      var sk, v;
      if (this.currentView == null) {
        if ((sk = this.el.attr("storage-key")) != null) {
          v = new TimelineViewDataProvider().getUserViewSetting(sk) || this.el.attr("view") || blocks.clientsideTimeline.TimelineViews.views.list.name;
        } else {
          v = new TimelineViewDataProvider().getUserViewSettingProfile() || this.el.attr("view") || blocks.clientsideTimeline.TimelineViews.views.list.name;
        }
        this.el.attr('view', v);
        this.currentView = blocks.clientsideTimeline.TimelineViews.views[v];
      }
      return this.currentView;
    };

    ClientsideTimeline.prototype.getTimelineView = function() {
      return this.timelineView || (this.timelineView = new (this.getCurrentView().getHandler())(this));
    };

    ClientsideTimeline.prototype.destroyTimelineView = function() {
      this.timelineView && this.timelineView.destroy();
      return this.timelineView = null;
    };

    ClientsideTimeline.prototype.setCurrentView = function(view) {
      if (view === this.currentView) {
        return;
      }
      this.destroyTimelineView();
      this.currentView = view;
      this.el.attr("view", view.name).trigger(this.s.EVENT_VIEW_CHANGED, [view.name]);
      this.dynopt && this.dynopt.invalidateData();
      return this.reload();
    };

    ClientsideTimeline.prototype.logPageLoaded = function() {
      Stats.track('timeline_page_loaded', {
        page_number: this.currentPage,
        timeline_type: GlobalState.TIMELINE.type(),
        source_url: this.providerUrl
      });
      if (this.currentPage === 1) {
        return Stats.track('timeline_session_started', {
          timeline_type: GlobalState.TIMELINE.type(),
          following_count: GlobalState.USER.followingCount(),
          source_url: this.providerUrl
        });
      }
    };

    ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT = "no-coubs-stub-text";

    ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB = "show-no-coubs-stub";

    ClientsideTimeline.prototype.showNoCoubsStubIfAllowed = function(c) {
      var t, template, v;
      if ((v = this.el.attr(this.s.ATTR_SHOW_NO_COUBS_STUB)) == null) {
        return;
      }
      template = JST["app/site/templates/timeline/no_coubs_stub"];
      if ((t = this.el.attr(this.s.ATTR_NO_COUBS_STUB_TEXT)) != null) {
        return c.append(template({
          text: utils.htmlEncode(t)
        }));
      } else {
        return c.append(template({
          username: utils.htmlEncode(v)
        }));
      }
    };

    ClientsideTimeline.prototype.isDataSourceJson = function() {
      return this.el.attr("data-source-json") != null;
    };

    ClientsideTimeline.prototype.delayedCoubsInit = function() {
      var coubBlockEl;
      coubBlockEl = this.coubsInitQueue.shift();
      if (coubBlockEl == null) {
        this.dynopt && this.dynopt.mapBlocks();
        return;
      }
      new CoubBlockClientside({
        el: coubBlockEl,
        changerOpts: {
          timelineProviderUrl: this.providerUrl
        }
      });
      this.getTimelineView().initialize(coubBlockEl);
      return this.delayedCoubsInitTimeout = requestAnimationFrame(this.delayedCoubsInit);
    };

    ClientsideTimeline.prototype.delayedCoubsDequeue = function(el) {
      var index;
      index = this.coubsInitQueue.indexOf(el);
      if (index === -1) {
        return;
      }
      return this.coubsInitQueue.splice(index, 1);
    };

    ClientsideTimeline.prototype.hasTimelineBanners = function() {
      return $('body').hasClass('has-adfox-sidebar');
    };

    ClientsideTimeline.constructIn = function(c) {
      if (c == null) {
        c = $("body");
      }
      return c.find("[clientside-timeline]").not('[delayed-init]').each(function() {
        return new clientsideTimeline.ClientsideTimeline($(this));
      });
    };

    return ClientsideTimeline;

  })();

}).call(this);

/*
  Клиентсайд таймлайн для каналов, выводит каналы списком.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.clientsideTimeline.ClientsideTimelineChannels = (function() {
    ClientsideTimelineChannels.ATTR_NAME = "widget-clientside-timeline-channels";

    ClientsideTimelineChannels.ACTION_LOAD_PAGE = "clientsideTimeline.ClientsideTimelineChannels:Actions:PageLoaded";

    ClientsideTimelineChannels.ACTION_RELOAD_PAGE = "clientsideTimeline.ClientsideTimelineChannels:Actions:PageReloaded";

    ClientsideTimelineChannels.ACTION_UPDATE_PROPERTIES = "clientsideTimeline.ClientsideTimelineChannels:Actions:UpdateProperties";

    function ClientsideTimelineChannels(el) {
      this.hideLoader = bind(this.hideLoader, this);
      this.showLoader = bind(this.showLoader, this);
      this.renderChannelsList = bind(this.renderChannelsList, this);
      this.loadNextPage = bind(this.loadNextPage, this);
      this.isLoadNew = bind(this.isLoadNew, this);
      this.processPreloadMore = bind(this.processPreloadMore, this);
      this.getDataAndCreateQuery = bind(this.getDataAndCreateQuery, this);
      this.createPage = bind(this.createPage, this);
      this.reload = bind(this.reload, this);
      this.updateTimelineProperties = bind(this.updateTimelineProperties, this);
      this.el = $(el);
      this.loadIndicator = LoadIndicator.appendToContainer(this.el, LoadIndicator.SIZE.BIG, LoadIndicator.ALIGN.TOP_CENTER);
      this.currentPage = 1;
      new ScrollEventOptimizer((function(_this) {
        return function() {
          return _this.processPreloadMore();
        };
      })(this));
      this.loadingLocker = new chms.utils.Locker();
      this.retryCounter = new functions.RetryCounter();
      widgets.timeline.FilterChannelsTimeline.constructIn($('.page-container'));
      this.createPage();
      $(document).on(clientsideTimeline.ClientsideTimelineChannels.ACTION_UPDATE_PROPERTIES, (function(_this) {
        return function(e, props, reload) {
          return _this.updateTimelineProperties(props, reload);
        };
      })(this));
      this.el.on(clientsideTimeline.ClientsideTimelineChannels.ACTION_RELOAD_PAGE, this.reload).on(clientsideTimeline.ClientsideTimelineChannels.ACTION_UPDATE_PROPERTIES, (function(_this) {
        return function(e, props, reload) {
          return _this.updateTimelineProperties(props, reload);
        };
      })(this));
    }

    ClientsideTimelineChannels.prototype.updateTimelineProperties = function(props, reload) {
      if (props == null) {
        props = {};
      }
      if (reload == null) {
        reload = true;
      }
      this.el.attr('additional-opts', JSON.stringify(props));
      return reload && this.reload();
    };

    ClientsideTimelineChannels.prototype.reload = function() {
      this.currentPage = 1;
      if (this.loadPageQuery != null) {
        this.loadPageQuery.abort();
        this.hideLoader();
      }
      this.el.children('.grid-container').empty();
      return this.createPage();
    };

    ClientsideTimelineChannels.prototype.createPage = function() {
      this.showLoader();
      return this.getDataAndCreateQuery();
    };

    ClientsideTimelineChannels.prototype.getDataAndCreateQuery = function() {
      var additionalOpts, loadComplete, loadError, loadSuccess;
      this.loadingLocker.lock();
      this.timelineUrl = this.el.attr('url');
      this.providerData = {};
      if ((additionalOpts = this.el.attr('additional-opts'))) {
        this.providerData = JSON.parse(additionalOpts);
      }
      this.providerData.page = this.currentPage;
      this.providerData.per_page = 25;
      if (!this.timelineUrl) {
        throw "ClientsideTimelineChannels: it requires url in order to work";
      }
      loadSuccess = (function(_this) {
        return function(n) {
          _this.totalPages = n.total_pages;
          _this.renderChannelsList(n, $('.grid-container', _this.el));
          _this.retryCounter.loadSuccess();
          _this.hideLoader();
          return _this.loadingLocker.unlock();
        };
      })(this);
      loadComplete = (function(_this) {
        return function() {
          return _this.el.trigger(window.clientsideTimeline.ClientsideTimelineChannels.ACTION_LOAD_PAGE);
        };
      })(this);
      loadError = (function(_this) {
        return function() {
          var ntry;
          if (_this.loadPageQuery.statusText !== "abort") {
            _this.currentPage--;
            ntry = function() {
              _this.loadingLocker.unlock();
              return _this.loadNextPage();
            };
            if (!_this.retryCounter.tryAgain(ntry)) {
              _this.hideLoader();
              return Growl.msg(I18n.growl_errors.reload.header, I18n.growl_errors.reload.error);
            }
          }
        };
      })(this);
      return this.loadPageQuery = $.get(this.timelineUrl, $.param(this.providerData, true)).then(loadSuccess, loadError).always(loadComplete);
    };

    ClientsideTimelineChannels.prototype.processPreloadMore = function() {
      if (this.isLoadNew()) {
        return this.loadNextPage();
      }
    };

    ClientsideTimelineChannels.prototype.isLoadNew = function() {
      var line;
      line = $('.page-container').height() - ($(window).height() * 1.5);
      return $(window).scrollTop() > line;
    };

    ClientsideTimelineChannels.prototype.loadNextPage = function() {
      return this.loadingLocker.safeExec((function(_this) {
        return function() {
          if ((_this.currentPage + 1) <= _this.totalPages) {
            _this.currentPage += 1;
            return _this.createPage();
          }
        };
      })(this));
    };

    ClientsideTimelineChannels.prototype.renderChannelsList = function(resp, container) {
      var channel, channels, i, j, len, len1, ref, widget;
      channels = resp.channels;
      if (!channels.length) {
        return;
      }
      for (i = 0, len = channels.length; i < len; i++) {
        channel = channels[i];
        container.append("<div class='grid-col -col-one-third eq'>\n  " + (JST['app/site/templates/channel_item/simple_channel_item']({
          channel: channel
        })) + "\n</div>");
      }
      ref = [widgets.FollowingCounter, widgets.FollowersCounter];
      for (j = 0, len1 = ref.length; j < len1; j++) {
        widget = ref[j];
        chms.utils.Autoinit.init(widget, container);
      }
      return chms.utils.Autoinit.init(widgets.WidgetFollowButtonInit, container);
    };

    ClientsideTimelineChannels.prototype.showLoader = function() {
      return this.loadIndicator.show();
    };

    ClientsideTimelineChannels.prototype.hideLoader = function() {
      return this.loadIndicator.hide();
    };

    return ClientsideTimelineChannels;

  })();

}).call(this);

/*
  Оптимизация таймлайна которая скрывает элементы не видимые
  во вьюпорте
 */

(function() {
  blocks.clientsideTimeline.DynamicOptimization = (function() {
    function DynamicOptimization(timeline) {
      this.timeline = timeline;
      this.invalidateData();
      this.renderLocker = new chms.utils.Locker();
      this.throttledRender = _.throttle(_.wrap(this.render.bind(this), _.defer), 500, {
        leading: false
      });
      $(window).on('scroll', this.throttledRender);
      window.dynopt = this;
    }

    DynamicOptimization.prototype.destroy = function() {
      this.invalidateData();
      return $(window).off('scroll', this.throttledRender);
    };

    DynamicOptimization.prototype.render = function() {
      if (helpers.Location.isFullScreen()) {
        return;
      }
      return this.renderLocker.safeExec((function(_this) {
        return function() {
          var is_mosaic, reallyFar, rfBottom, rfTop, scrollOffset, vastness, wh;
          scrollOffset = $(window).scrollTop();
          wh = $(window).height();
          if ((_this.topBound + wh) < scrollOffset && (_this.bottomBound - wh) > scrollOffset) {
            return;
          }
          is_mosaic = !!_this.timeline.list.data('masonry');
          vastness = wh * (is_mosaic && 1 || 3);
          reallyFar = vastness * 2;
          _this.topBound = scrollOffset - vastness;
          _this.bottomBound = scrollOffset + wh + vastness;
          rfTop = scrollOffset - reallyFar;
          rfBottom = scrollOffset + wh + reallyFar;
          _this.data.forEach(function(o) {
            if ((o.top < _this.topBound || o.top > _this.bottomBound) && o.visible) {
              return _this.removeFromRender(o);
            } else if ((o.top >= _this.topBound && o.top <= _this.bottomBound) && (!o.visible || o.detached)) {
              return _this.addToRender(o);
            } else if ((o.top < rfTop || o.top > rfBottom) && !o.detached && !o.hasEditorControls) {
              return _this.detachFromDom(o);
            }
          });
          if (is_mosaic) {
            return _this.timeline.list.masonry('reloadItems');
          }
        };
      })(this));
    };

    DynamicOptimization.prototype.mapBlocks = function($container) {
      if ($container == null) {
        $container = this.timeline.el;
      }
      this.invalidateBounds();
      return $container.find("[coub-block]").not(".timeline-banner, [data-dynopt-processed], .coub--promoted").each((function(_this) {
        return function(i, v) {
          return _this.addData(v);
        };
      })(this));
    };

    DynamicOptimization.prototype.addToRender = function(o) {
      if (o.detached) {
        this.attachToDom(o);
      }
      o.el.css({
        height: ""
      }).removeClass("coub__dont-render");
      o.poster.css({
        height: '',
        width: ''
      });
      o.el.triggerHandler(TagsBlock.ACTION_UPDATE_LAYOUT);
      o.visible = true;
      return o.detached = false;
    };

    DynamicOptimization.prototype.removeFromRender = function(o) {
      o.el.css({
        height: o.height
      }).addClass("coub__dont-render");
      o.poster.css({
        height: o.height,
        width: o.width
      });
      return o.visible = false;
    };

    DynamicOptimization.prototype.detachFromDom = function(o) {
      var clone, contents, ref;
      o.card.remove();
      ref = [], o.card = ref[0], o.poster = ref[1];
      contents = o.el.contents().detach();
      clone = o.el.clone().html(contents);
      o.el.replaceWith(clone);
      this.timeline.delayedCoubsDequeue(o.el.get(0));
      o.el = clone;
      return o.detached = true;
    };

    DynamicOptimization.prototype.attachToDom = function(o) {
      var $block, coub, e;
      try {
        coub = JSON.parse($('> .data', o.el).html());
      } catch (error) {
        e = error;
        (typeof Honeybadger !== "undefined" && Honeybadger !== null) && Honeybadger.setContext({
          json: $('> .data', o.el).html()
        });
        throw e;
      }
      $block = $(JST["app/site/templates/coub_block/coub"](coub));
      o.card = $block.find('> .coub__inner');
      o.poster = $block.find('.viewer__img');
      o.el.prepend(o.card);
      return this.timeline.attachCoubHandlers(o.el);
    };

    DynamicOptimization.prototype.invalidateData = function() {
      this.data = [];
      this.dataIndex = [];
      return this.invalidateBounds();
    };

    DynamicOptimization.prototype.invalidateBounds = function() {
      var ref;
      return ref = [], this.topBound = ref[0], this.bottomBound = ref[1], ref;
    };

    DynamicOptimization.prototype.addData = function(el) {
      var $card, $el, $poster;
      if (this.dataIndex.indexOf(el) !== -1) {
        return false;
      }
      $el = $(el);
      $card = $el.children(".coub__inner");
      $poster = $el.find(".viewer__img");
      $el.attr("data-dynopt-processed", true);
      this.data.push({
        top: $el.offset().top,
        el: $el,
        card: $card,
        poster: $poster,
        visible: !$el.hasClass("coub__dont-render"),
        detached: $card.length === 0,
        height: $el.outerHeight(),
        width: $el.outerWidth(),
        hasEditorControls: $el.hasClass('coub--editorial')
      });
      return this.dataIndex.push(el);
    };

    DynamicOptimization.prototype.removeData = function(el) {
      var i;
      i = this.dataIndex.indexOf(el);
      if (i === -1) {
        return;
      }
      this.data.splice(i, 1);
      return this.dataIndex.splice(i, 1);
    };

    DynamicOptimization.prototype.refreshOffsets = function() {
      return this.data.forEach(function(v) {
        return v.top = v.el.offset().top;
      });
    };

    return DynamicOptimization;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.TimelineFullscreenChanger = (function() {
    TimelineFullscreenChanger.prototype.DT = "window.TimelineFullscreenChanger";

    function TimelineFullscreenChanger(el1, opts) {
      this.el = el1;
      this.opts = opts != null ? opts : {};
      this.onLoadError = bind(this.onLoadError, this);
      this.returnButtons = bind(this.returnButtons, this);
      this.extractChangerContainer = bind(this.extractChangerContainer, this);
      this.onInitialPageLoaded = bind(this.onInitialPageLoaded, this);
      this.fullScreenHandler = bind(this.fullScreenHandler, this);
      this.init = bind(this.init, this);
      this.currentCoub = $('.viewer', this.el);
      this.initialCoub = this.currentCoub;
      this.initialPermalink = this.currentCoub.attr('data-permalink');
      this.container = $('.coub__viewer', this.el);
      this.currentCoub.wrap($('<div class="fullscreen-changer__animation_container"></div>'));
      this.animationContainer = $('.fullscreen-changer__animation_container', this.container);
      this.currentCoub.trigger(Player.ACTION_SET_FULLSCREEN_ELEMENT, [this.container]);
      this.currentCoub.one(Player.EVENT_PLAYING, this.init);
    }

    TimelineFullscreenChanger.prototype.init = function() {
      $(document).on('fullscreenchange', this.fullScreenHandler);
      return this.el.on("dom_remove", (function(_this) {
        return function() {
          return $(document).off('fullscreenchange', _this.fullScreenHandler);
        };
      })(this));
    };

    TimelineFullscreenChanger.prototype.fullScreenHandler = function() {
      if (helpers.Location.isFullScreen()) {
        return this.activate();
      } else {
        return this.deactivate();
      }
    };

    TimelineFullscreenChanger.prototype.activate = function() {
      var obj;
      if (this.isActivated || !this.el.hasClass('active')) {
        return;
      }
      this.isActivated = true;
      this.currentPage = parseFloat(this.el.attr('timeline-page'));
      this.currentIndex = parseFloat(this.el.attr('timeline-index'));
      this.timeline = {};
      this.coubs = (
        obj = {},
        obj["" + this.initialPermalink] = this.currentCoub,
        obj
      );
      return this.loadPage(this.currentPage, this.onInitialPageLoaded);
    };

    TimelineFullscreenChanger.prototype.deactivate = function() {
      var ref;
      if (!this.isActivated) {
        return;
      }
      this.isActivated = false;
      this.query && this.query.state() === 'pending' && this.query.abort();
      clearTimeout(this.finishReplacementTimeout);
      $('.tooltip, .viewer', this.container).filter((function(_this) {
        return function(i, el) {
          return el !== _this.initialCoub[0];
        };
      })(this)).remove();
      this.initialCoub.css({
        display: 'block',
        margin: '0 auto'
      });
      this.initialCoub.triggerHandler('play.player');
      this.initialCoub.triggerHandler('resize.player');
      this.initialCoub.triggerHandler(Player.ACTION_SHOW_CONTROLS);
      this.currentCoub = this.initialCoub;
      this.updateChangerButtons(true);
      this.currentCoub.get(0).focus();
      return ref = [], this.timeline = ref[0], this.coubs = ref[1], ref;
    };

    TimelineFullscreenChanger.prototype.onInitialPageLoaded = function() {
      return this.preloadAdjacentCoubs(false);
    };

    TimelineFullscreenChanger.prototype.preloadAdjacentCoubs = function(preload) {
      if (preload == null) {
        preload = true;
      }
      if (this.currentIndex === 0 && this.currentPage !== 1) {
        return this.loadPage(this.currentPage - 1, (function(_this) {
          return function() {
            return _this.fetchDataForCreate(preload);
          };
        })(this));
      } else if (this.currentIndex === this.timeline[this.currentPage].length - 1 && this.currentPage < this.totalPages) {
        return this.loadPage(this.currentPage + 1, (function(_this) {
          return function() {
            return _this.fetchDataForCreate(preload);
          };
        })(this));
      } else {
        return this.fetchDataForCreate(preload);
      }
    };

    TimelineFullscreenChanger.prototype.fetchDataForCreate = function(preload) {
      var c, j, len, p;
      p = [];
      if (this.currentIndex === 0) {
        p.push(_.last(this.timeline[this.currentPage - 1]));
      } else {
        p.push(this.timeline[this.currentPage][this.currentIndex - 1]);
      }
      if (this.currentIndex === this.timeline[this.currentPage].length - 1) {
        p.push(_.first(this.timeline[this.currentPage + 1]));
      } else {
        p.push(this.timeline[this.currentPage][this.currentIndex + 1]);
      }
      p = _.compact(p);
      for (j = 0, len = p.length; j < len; j++) {
        c = p[j];
        this.createCoub(c, preload);
      }
      $(document).trigger('fullscreenchange');
      return this.updateChangerButtons(false);
    };

    TimelineFullscreenChanger.prototype.createCoub = function(c, preload) {
      var coub;
      if (this.coubs[c.permalink] != null) {
        return;
      }
      coub = $(JST["app/site/templates/coub_block/viewer_block"](c));
      coub.css({
        display: 'none'
      });
      new Player(coub);
      coub.triggerHandler(Player.ACTION_TURN_HD_ON);
      coub.triggerHandler('hidefinger.player');
      if (preload) {
        coub.triggerHandler('preload.player');
      }
      this.coubs[c.permalink] = coub;
      return this.currentCoub.after(coub);
    };

    TimelineFullscreenChanger.prototype.loadPage = function(page, success) {
      if (this.timeline[page] != null) {
        return success();
      }
      this.query && this.query.state() === 'pending' && this.query.abort();
      this.query = $.get(this.opts.timelineProviderUrl, {
        page: page
      });
      this.query.done((function(_this) {
        return function(data) {
          _this.totalPages = data.total_pages;
          _this.timeline[page] = data.coubs;
          return success();
        };
      })(this));
      return this.query.fail(this.onLoadError);
    };

    TimelineFullscreenChanger.prototype.updateChangerButtons = function(hide) {
      var addListeners, next, prev, removeListeners, viewer;
      prev = $('.viewer__coubs-changer .button-prev-next.-prev', this.currentCoub);
      next = $('.viewer__coubs-changer .button-prev-next.-next', this.currentCoub);
      viewer = this.currentCoub;
      prev.toggleClass('-disabled', hide || (this.currentPage === 1 && this.currentIndex === 0));
      next.toggleClass('-disabled', hide || (this.currentPage === this.totalPages && this.currentIndex === this.timeline[this.currentPage].length - 1));
      removeListeners = function() {
        prev.off('click');
        next.off('click');
        return viewer.off("keyup.timelineFullScreenChanger");
      };
      addListeners = (function(_this) {
        return function() {
          prev.on('click', function(e) {
            e.stopPropagation();
            removeListeners();
            if (_this.currentIndex === 0) {
              _this.currentPage--;
              _this.currentIndex = _this.timeline[_this.currentPage].length - 1;
            } else {
              _this.currentIndex--;
            }
            return _this.replaceCoub(false);
          });
          next.on('click', function(e) {
            e.stopPropagation();
            if (_this.currentIndex === _this.timeline[_this.currentPage].length - 1) {
              if (!_this.timeline[_this.currentPage + 1]) {
                return;
              }
              _this.currentPage++;
              _this.currentIndex = 0;
            } else {
              _this.currentIndex++;
            }
            removeListeners();
            return _this.replaceCoub(true);
          });
          return viewer.on("keyup.timelineFullScreenChanger", function(e) {
            if (e.which === 37) {
              return prev.click();
            } else if (e.which === 39) {
              return next.click();
            }
          });
        };
      })(this);
      if (hide) {
        return removeListeners();
      } else {
        return addListeners();
      }
    };

    TimelineFullscreenChanger.prototype.extractChangerContainer = function() {
      this.changerButtons = $('.viewer__coubs-changer', this.currentCoub);
      this.changerButtons.data('previousElement', this.changerButtons.prev());
      return this.animationContainer.after(this.changerButtons);
    };

    TimelineFullscreenChanger.prototype.returnButtons = function() {
      if (this.changerButtons) {
        this.changerButtons.insertAfter(this.changerButtons.data('previousElement'));
        return this.changerButtons = null;
      }
    };

    TimelineFullscreenChanger.prototype.enableChangerMode = function() {
      var ref;
      this.currentCoub.addClass('-changer-mode');
      ref = [], this.initialMouseX = ref[0], this.initialMouseY = ref[1];
      return this.currentCoub.on('mousemove.changer', (function(_this) {
        return function(e) {
          if (!_this.initialMouseX) {
            _this.initialMouseX = e.pageX;
          }
          if (!_this.initialMouseY) {
            _this.initialMouseY = e.pageY;
          }
          if (Math.abs(e.pageX - _this.initialMouseX) > 100 || Math.abs(e.pageY - _this.initialMouseY) > 100) {
            return _this.disableChangerMode();
          }
        };
      })(this));
    };

    TimelineFullscreenChanger.prototype.disableChangerMode = function() {
      return this.currentCoub.removeClass('-changer-mode').off('mousemove.changer');
    };

    TimelineFullscreenChanger.prototype.replaceCoub = function(fromRightToLeft) {
      var acl, ncl, newCoub, oldCoub, p, wh, ww;
      clearTimeout(this.finishReplacementTimeout);
      this.finishReplacement && this.finishReplacement();
      this.extractChangerContainer();
      this.disableChangerMode();
      p = this.timeline[this.currentPage][this.currentIndex].permalink;
      ww = window.innerWidth;
      wh = window.innerHeight;
      if (fromRightToLeft) {
        ncl = ww;
        acl = -ww;
      } else {
        ncl = -ww;
        acl = ww;
      }
      oldCoub = this.currentCoub;
      oldCoub.triggerHandler('suspend.player');
      oldCoub.triggerHandler(Player.ACTION_HIDE_CONTROLS);
      newCoub = this.coubs[p];
      newCoub.css({
        display: 'block',
        margin: (-wh) + "px 0 0 " + ncl + "px"
      }).triggerHandler(Player.ACTION_HIDE_CONTROLS);
      this.animationContainer.addClass('-animated').css({
        margin: "0 0 0 " + acl + "px"
      });
      oldCoub.after(newCoub);
      _.defer(function() {
        return newCoub.triggerHandler('resize.player');
      });
      this.finishReplacement = (function(_this) {
        return function() {
          _this.animationContainer.removeClass('-animated').css({
            margin: 0
          });
          oldCoub.css({
            display: 'none'
          });
          newCoub.css({
            margin: 0
          });
          newCoub.triggerHandler('play.player');
          newCoub.triggerHandler(Player.ACTION_SHOW_CONTROLS);
          _this.returnButtons();
          _this.enableChangerMode();
          return _this.finishReplacement = null;
        };
      })(this);
      this.currentCoub = newCoub;
      this.currentCoub.get(0).focus();
      this.preloadAdjacentCoubs();
      return this.finishReplacementTimeout = setTimeout(this.finishReplacement, 250);
    };

    TimelineFullscreenChanger.prototype.onLoadError = function(e) {
      return console.error(this.DT, "Load Error", e);
    };

    return TimelineFullscreenChanger;

  })();

}).call(this);
(function() {
  window.blocks.clientsideTimeline.TimelineViews = {
    views: {
      list: {
        name: "list",
        getHandler: function() {
          return blocks.clientsideTimeline.TimelineViewList;
        }
      },
      mosaic: {
        name: "mosaic",
        getHandler: function() {
          return blocks.clientsideTimeline.TimelineViewMosaic;
        }
      },
      listWithoutScroll: {
        name: "listWithoutScroll",
        getHandler: function() {
          return blocks.clientsideTimeline.TimelineViewListWithoutScroll;
        }
      }
    }
  };

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.blocks.clientsideTimeline.TimelineViewAbstract = (function() {
    TimelineViewAbstract.prototype.viewActive = false;

    function TimelineViewAbstract(parent) {
      this.parent = parent;
      this.isCoverInFocus = bind(this.isCoverInFocus, this);
      this.onCoverBlur = bind(this.onCoverBlur, this);
      this.onCoverFocus = bind(this.onCoverFocus, this);
      this.appendPage = bind(this.appendPage, this);
      this.render = bind(this.render, this);
      this.destroy = bind(this.destroy, this);
      this.initialize = bind(this.initialize, this);
    }

    TimelineViewAbstract.prototype.initialize = function(container1, firstTime) {
      this.container = container1;
      if (firstTime == null) {
        firstTime = false;
      }
      if (firstTime && (pages.profile.view.Cover != null)) {
        $('.hero-cover__att').bind(pages.profile.view.Cover.EVENT_COVER_FOCUS, this.onCoverFocus);
        $('.hero-cover__att').bind(pages.profile.view.Cover.EVENT_COVER_BLUR, this.onCoverBlur);
      }
      return this.viewActive = true;
    };

    TimelineViewAbstract.prototype.destroy = function() {
      if (pages.profile.view.Cover != null) {
        $('.hero-cover__att').unbind(pages.profile.view.Cover.EVENT_COVER_FOCUS, this.onCoverFocus);
        $('.hero-cover__att').unbind(pages.profile.view.Cover.EVENT_COVER_BLUR, this.onCoverBlur);
      }
      this.coverInFocus = void 0;
      return this.viewActive = false;
    };

    TimelineViewAbstract.prototype.render = function() {
      throw "blocks.clientsideTimeline.TimelineViewAbstract: please override";
    };

    TimelineViewAbstract.prototype.appendPage = function(container) {
      throw "blocks.clientsideTimeline.TimelineViewAbstract: please override";
    };

    TimelineViewAbstract.prototype.isLoadNew = function() {
      var $lastCoub, $offsetEl, $window, line;
      $window = $(window);
      $lastCoub = this.parent.list.children(".page").last().children(".coub").last();
      $offsetEl = $lastCoub.length ? $lastCoub : this.parent.list;
      line = $offsetEl.offset().top + $offsetEl.height() - $window.height() * 3;
      return $window.scrollTop() > line;
    };

    TimelineViewAbstract.prototype.onCoverFocus = function() {
      return this.coverInFocus = true;
    };

    TimelineViewAbstract.prototype.onCoverBlur = function() {
      return this.coverInFocus = false;
    };

    TimelineViewAbstract.prototype.isCoverInFocus = function() {
      if (pages.profile.view.Cover == null) {
        return false;
      }
      if (!this.coverInFocus) {
        this.coverInFocus = pages.profile.view.Cover.isInFocus();
      }
      return this.coverInFocus;
    };

    TimelineViewAbstract.prototype.isAnyCoubPlaying = function() {
      return blocks.clientsideTimeline.TimelineViewAbstract.isAnyCoubPlaying($("body"));
    };

    TimelineViewAbstract.isAnyCoubPlaying = function(container) {
      return _.any(container.find("[coub-block]"), function(el) {
        return CoubBlockClientside.isPlaying($(el));
      });
    };

    return TimelineViewAbstract;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.blocks.clientsideTimeline.TimelineViewList = (function(superClass) {
    extend(TimelineViewList, superClass);

    TimelineViewList.prototype.DT = "blocks.clientsideTimeline.TimelineViewList";

    TimelineViewList.prototype.SCROLL_QUEUE_NAME = "TimelineViewList:ScrollQueue";

    function TimelineViewList(cb) {
      this.onCoverBlur = bind(this.onCoverBlur, this);
      this.onCoverFocus = bind(this.onCoverFocus, this);
      this.showOrHideNavHelp = bind(this.showOrHideNavHelp, this);
      this.goToBlock = bind(this.goToBlock, this);
      this.keyUp = bind(this.keyUp, this);
      this.keyDown = bind(this.keyDown, this);
      this.getFirstBlockInViewport = bind(this.getFirstBlockInViewport, this);
      this.getPlayingCoubMedian = bind(this.getPlayingCoubMedian, this);
      this.unembedPlayersFromRange = bind(this.unembedPlayersFromRange, this);
      this.unmarkPreviousBlock = bind(this.unmarkPreviousBlock, this);
      this.markBlock = bind(this.markBlock, this);
      this.markClickedBlock = bind(this.markClickedBlock, this);
      this.scrollHandler = bind(this.scrollHandler, this);
      this.stopScrollToCoub = bind(this.stopScrollToCoub, this);
      this.appendPage = bind(this.appendPage, this);
      this.render = bind(this.render, this);
      this.onEventStatusUpdated = bind(this.onEventStatusUpdated, this);
      this.destroy = bind(this.destroy, this);
      this.initialize = bind(this.initialize, this);
      var cm;
      TimelineViewList.__super__.constructor.apply(this, arguments);
      this.throttledScrollHandler = _.throttle(this.scrollHandler, 100);
      cm = this.parent.el.attr("coub-median");
      if (cm != null) {
        this.coubMedian = parseInt(cm);
      }
    }

    TimelineViewList.prototype.initialize = function(container, firstTime) {
      var vbs;
      if (firstTime == null) {
        firstTime = false;
      }
      TimelineViewList.__super__.initialize.apply(this, arguments);
      vbs = $(".viewer", container);
      if (firstTime) {
        this.showOrHideNavHelp();
        $(window).on("scroll", this.throttledScrollHandler).on("wheel", this.stopScrollToCoub).on("resize", this.scrollHandler).on("keydown", this.keyDown).on("keyup", this.keyUp);
        $(this.parent.el).on('click', '.coub', this.markClickedBlock);
        if (!this.isCoverInFocus()) {
          this.scrollHandler();
        }
        $(document).on(CoubBlockClientside.EVENT_RELOAD_COMPLETE, this.onEventStatusUpdated).on(CoubBlockClientside.ACTION_DELETE, this.scrollHandler);
      }
      return vbs.trigger(Player.ACTION_UNEMBED_IF_NOT_PLAYING).trigger('hidefinger').on("playWasStarted", this.showOrHideNavHelp);
    };

    TimelineViewList.prototype.destroy = function() {
      TimelineViewList.__super__.destroy.apply(this, arguments);
      $(".viewer", this.parent.list).off("playWasStarted", this.showOrHideNavHelp).trigger('unembed');
      $(".body-container .nav-tooltip").detach();
      $(this.parent.el).off('click', this.markClickedBlock);
      $(window).off("scroll", this.throttledScrollHandler).off("wheel", this.stopScrollToCoub).off("resize", this.scrollHandler).off("keydown", this.keyDown).off("keyup", this.keyUp);
      return $(document).off(CoubBlockClientside.EVENT_RELOAD_COMPLETE, this.onEventStatusUpdated).off(CoubBlockClientside.ACTION_DELETE, this.scrollHandler);
    };

    TimelineViewList.prototype.onEventStatusUpdated = function(e) {
      return this.initialize(e.cb.el);
    };

    TimelineViewList.prototype.render = function() {
      this.parent.renderData["card-type"] = "normal";
      return $(".coub", this.parent.list).trigger({
        type: CoubBlockClientside.ACTION_UPDATE_CARD_TYPE,
        cardType: blocks.coub.CardTypes.types.normal
      });
    };

    TimelineViewList.prototype.appendPage = function(container) {
      return setTimeout(this.scrollHandler, 200);
    };

    TimelineViewList.prototype.stopScrollToCoub = function(e) {
      if (!this.isScrollingToCoub) {
        return;
      }
      $('html, body').stop(this.SCROLL_QUEUE_NAME, true);
      return this.isScrollingToCoub = false;
    };

    TimelineViewList.prototype.scrollHandler = function() {
      if (this.isScrollingToCoub) {
        return;
      }
      if (this.isCoverInFocus()) {
        return $(".coub.active").removeClass("active");
      } else if (!helpers.Location.isFullScreen()) {
        return this.markBlock(this.getFirstBlockInViewport(), false, true);
      }
    };

    TimelineViewList.prototype.markClickedBlock = function(e) {
      if (helpers.Location.isFullScreen()) {
        return;
      }
      return this.markBlock($(e.currentTarget), true);
    };

    TimelineViewList.prototype.markBlock = function(block, through, noScroll) {
      var next, viewer;
      if (noScroll == null) {
        noScroll = false;
      }
      if (!block.length || block.hasClass('active') || !this.viewActive) {
        return;
      }
      this.unmarkPreviousBlock();
      block.addClass('active');
      this.parent.updateCurrentCoubIndex();
      viewer = this.parent.getViewerContainer(block);
      next = this.parent.getNextBlock(block);
      viewer.one("playWasStarted", (function(_this) {
        return function() {
          if (next.length > 0) {
            return _this.parent.getViewerContainer(next).triggerHandler('preload');
          } else {
            return _this.parent.el.one("page:loaded", function() {
              return _this.parent.getViewerContainer(_this.parent.getNextBlock(block)).trigger('preload');
            });
          }
        };
      })(this));
      viewer.triggerHandler('play');
      helpers.Application.setFocusNoScroll(viewer);
      this.unembedPlayersFromRange(block);
      if (!(noScroll || GlobalState.PLATFORM.isMobile() || ($('.coub', this.parent.el).index(block) === 0 && !through))) {
        return this.scrollToCoub(block);
      }
    };

    TimelineViewList.prototype.unmarkPreviousBlock = function() {
      var block;
      block = $(".coub.active", this.parent.el);
      if (!block.length) {
        return;
      }
      this.parent.getViewerContainer(block).triggerHandler('suspend');
      return block.removeClass('active');
    };

    TimelineViewList.prototype.unembedPlayersFromRange = function(block) {
      var bottomIndex, index, topIndex;
      index = $('.coub', this.parent.list).index(block);
      topIndex = index - 1;
      bottomIndex = index + 1;
      return $('.coub', this.parent.list).each((function(_this) {
        return function(ind, b) {
          if (ind < topIndex || ind > bottomIndex) {
            return _this.parent.getViewerContainer(b).triggerHandler('unembed');
          }
        };
      })(this));
    };

    TimelineViewList.prototype.scrollToCoub = function(el) {
      var scrollTo;
      if (GlobalState.PLATFORM.isMobile() || !el.length) {
        return;
      }
      scrollTo = el.offset().top - this.getPlayingCoubMedian();
      $('html, body').stop(this.SCROLL_QUEUE_NAME, true).animate({
        scrollTop: scrollTo
      }, {
        duration: 250,
        queue: this.SCROLL_QUEUE_NAME,
        complete: (function(_this) {
          return function() {
            return _this.isScrollingToCoub = false;
          };
        })(this)
      }).dequeue(this.SCROLL_QUEUE_NAME);
      return this.isScrollingToCoub = true;
    };

    TimelineViewList.prototype.getPlayingCoubMedian = function() {
      if (this.coubMedian != null) {
        return this.coubMedian;
      } else if (GlobalState.PAGE.isBestCoubs2014() || GlobalState.PAGE.isBestCoubs2015()) {
        return 86;
      } else if ($('header.header').hasClass('-static') || $('header.header').hasClass('-static-absolute')) {
        return $('.page-menu').height() + 10;
      } else {
        return $('header.header').height() + $('.page-menu').height() + 10;
      }
    };

    TimelineViewList.prototype.getFirstBlockInViewport = function() {
      var fullySel, fullyVisible, partlySel, partlyVisible, shift, visible;
      if ($(window).scrollTop() === 0 && (GlobalState.PAGE.isBestCoubs2018() || GlobalState.PAGE.isBestCoubs2019())) {
        return $.noop;
      }
      if ($(window).scrollTop() === 0 && !GlobalState.PAGE.isPromoProfile() && !GlobalState.PAGE.isFeaturedIndexPage()) {
        return this.parent.el.find("[coub-block]").first();
      } else {
        shift = this.getPlayingCoubMedian() - 1;
        visible = this.parent.el.find("[coub-block]").not(".coub__dont-render");
        fullySel = ":in-viewport-with-offsets(" + shift + ")";
        fullyVisible = $(".viewer" + fullySel + ", .coub__stub" + fullySel, visible);
        if (fullyVisible.length) {
          return fullyVisible.first().closest('.coub');
        } else {
          partlySel = ":in-viewport-partly-with-offsets(" + shift + ")";
          partlyVisible = $(".viewer" + partlySel + ", .coub__stub" + partlySel, visible);
          return partlyVisible.first().closest('.coub');
        }
      }
    };

    TimelineViewList.prototype.keyDown = function(e) {
      var keyCode;
      if (e.metaKey || $(document.activeElement).is('input, textarea') || helpers.Location.isFullScreen()) {
        return;
      }
      keyCode = e.which;
      if (keyCode === Utils.KEY_CODES.UP || keyCode === Utils.KEY_CODES.k || (keyCode === Utils.KEY_CODES.SPACE && e.shiftKey === true)) {
        e.preventDefault();
        e.stopPropagation();
        return this.goToBlock(1);
      } else if (keyCode === Utils.KEY_CODES.DOWN || keyCode === Utils.KEY_CODES.SPACE || keyCode === Utils.KEY_CODES.j) {
        e.preventDefault();
        e.stopPropagation();
        return this.goToBlock(-1);
      }
    };

    TimelineViewList.prototype.keyUp = function(e) {
      var keyCode;
      keyCode = e.which;
      if (e.metaKey) {
        return;
      }
      if (keyCode === $.ui.keyCode.DOWN || keyCode === $.ui.keyCode.SPACE || keyCode === 74) {
        e.preventDefault();
        e.stopPropagation();
        return $("[tooltip-next-coub]").removeClass('active');
      } else if (keyCode === $.ui.keyCode.UP || keyCode === 75) {
        e.preventDefault();
        e.stopPropagation();
        return $(".nav-tooltip__control--prev").removeClass('active');
      }
    };

    TimelineViewList.prototype.goToBlock = function(dir) {
      var current, index, newIndex, nextBlock, withCover;
      if (this.scrollLock) {
        return;
      }
      current = $('.coub.active', this.parent.el);
      if (!current.length) {
        newIndex = this.parent.currentCoubIndex > 0 ? this.parent.currentCoubIndex - dir : 0;
      } else {
        index = $('.coub', this.parent.el).index(current);
        newIndex = dir < 0 ? this.parent.currentCoubIndex + 1 : this.parent.currentCoubIndex - 1;
      }
      nextBlock = $(".coub:visible:eq(" + newIndex + ")", this.parent.el);
      withCover = GlobalState.PAGE.isProfile() || GlobalState.PAGE.isPromoCover();
      if (withCover && dir === -1 && index === 0 && current.offset().top - $(window).scrollTop() > 400) {
        this.scrollToCoub(current);
        return this.parent.currentCoubIndex = index;
      } else if (withCover && dir === 1 && index === 0) {
        return $.scrollTo(0, 150);
      } else if (nextBlock.length) {
        this.markBlock(nextBlock, true);
        return this.parent.currentCoubIndex = newIndex;
      }
    };

    TimelineViewList.prototype.TOOLTIP_FADE_TIME = 700;

    TimelineViewList.prototype.showOrHideNavHelp = function(e) {
      var tooltip;
      return;
      if (GlobalState.PLATFORM.isMobile()) {
        return;
      }
      if ($(".nav-tooltip").size() === 0) {
        tooltip = $(JST["app/site/templates/timeline/list_nav_tooltip"]());
        tooltip.hide();
        $(".body-container").append(tooltip);
      }
      if (tooltip == null) {
        tooltip = $(".body-container .nav-tooltip");
      }
      if (this.parent.currentCoubIndex === 0) {
        if (tooltip.is(":visible")) {
          tooltip.fadeOut(this.TOOLTIP_FADE_TIME);
        }
      } else {
        if (!tooltip.is(":visible")) {
          tooltip.fadeIn(this.TOOLTIP_FADE_TIME);
        }
      }
      $('[tooltip-next-coub]', tooltip).on('click', (function(_this) {
        return function() {
          return _this.goToBlock(-1);
        };
      })(this));
      return $('[tooltip-prev-coub]', tooltip).on('click', (function(_this) {
        return function() {
          return _this.goToBlock(1);
        };
      })(this));
    };

    TimelineViewList.prototype.onCoverFocus = function(e) {
      TimelineViewList.__super__.onCoverFocus.apply(this, arguments);
      if (e.coverType === pages.profile.view.Cover.COVER_TYPE.COUB) {
        $(".hero-cover__att .viewer").triggerHandler("play");
        return this.parent.list.find(".viewer").triggerHandler("suspend");
      }
    };

    TimelineViewList.prototype.onCoverBlur = function(e) {
      TimelineViewList.__super__.onCoverBlur.apply(this, arguments);
      if (e.coverType === pages.profile.view.Cover.COVER_TYPE.COUB) {
        $(".hero-cover__att .viewer").triggerHandler("suspend");
      }
      return this.markBlock(this.getFirstBlockInViewport(), true);
    };

    return TimelineViewList;

  })(blocks.clientsideTimeline.TimelineViewAbstract);

}).call(this);

/*
  Таймлайн в виде списка в котором кобы играют не по скролу а по появлению во вью порте
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.blocks.clientsideTimeline.TimelineViewListWithoutScroll = (function(superClass) {
    extend(TimelineViewListWithoutScroll, superClass);

    TimelineViewListWithoutScroll.prototype.DT = "blocks.clientsideTimeline.TimelineViewListWithoutScroll";

    function TimelineViewListWithoutScroll(cb) {
      this.scrollToCoub = bind(this.scrollToCoub, this);
      this.pauseAllExcept = bind(this.pauseAllExcept, this);
      this.scrollHandler = bind(this.scrollHandler, this);
      this.initialize = bind(this.initialize, this);
      TimelineViewListWithoutScroll.__super__.constructor.apply(this, arguments);
      this.scrollEventOptimizer = new ScrollEventOptimizer(this.scrollHandler, 350);
      this.scrollEventOptimizer.disactivate();
    }

    TimelineViewListWithoutScroll.prototype.initialize = function() {
      var bz;
      TimelineViewListWithoutScroll.__super__.initialize.apply(this, arguments);
      bz = this.parent.el.attr("blind-zone");
      if (bz != null) {
        return this.blindZone = parseInt(bz);
      } else {
        return this.blindZone = 0;
      }
    };

    TimelineViewListWithoutScroll.prototype.scrollHandler = function() {
      var cb;
      if (this.scrollEventOptimizer.currentTop < this.blindZone) {
        return this.pauseAllExcept();
      } else if (this.scrollEventOptimizer.speed < 750) {
        cb = this.getFirstBlockInViewport();
        if (!cb.hasClass("active")) {
          this.markBlock(cb, false, true);
          return this.pauseAllExcept(cb);
        }
      }
    };

    TimelineViewListWithoutScroll.prototype.pauseAllExcept = function(block) {
      var sel;
      sel = this.parent.list.find("[coub-block].active");
      if (block != null) {
        sel = sel.not(block);
      }
      if (sel.size() > 0) {
        return sel.removeClass("active").find(".viewer").trigger("suspend");
      }
    };

    TimelineViewListWithoutScroll.prototype.scrollToCoub = function(el, cbk) {
      var DURATION;
      if (!GlobalState.PLATFORM.isMobile() && !this.scrollLock) {
        if (el.size() !== 0) {
          this.scrollLock = true;
          DURATION = 250;
          setTimeout(((function(_this) {
            return function() {
              _this.scrollLock = false;
              if (cbk) {
                return cbk();
              }
            };
          })(this)), DURATION);
          return $('html, body').animate({
            scrollTop: el.offset().top - 75
          }, {
            duration: DURATION,
            queue: false
          });
        }
      }
    };

    return TimelineViewListWithoutScroll;

  })(blocks.clientsideTimeline.TimelineViewList);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.blocks.clientsideTimeline.TimelineViewMosaic = (function(superClass) {
    extend(TimelineViewMosaic, superClass);

    function TimelineViewMosaic() {
      this.onCoverBlur = bind(this.onCoverBlur, this);
      this.onCoverFocus = bind(this.onCoverFocus, this);
      this.startPlayingCoverIfCan = bind(this.startPlayingCoverIfCan, this);
      this.suspendCover = bind(this.suspendCover, this);
      this.appendPage = bind(this.appendPage, this);
      this.render = bind(this.render, this);
      this.destroy = bind(this.destroy, this);
      this.onEventStatusUpdated = bind(this.onEventStatusUpdated, this);
      this.recalculateMosaic = bind(this.recalculateMosaic, this);
      this.cancelCoubPlay = bind(this.cancelCoubPlay, this);
      this.playCoub = bind(this.playCoub, this);
      this.markBlockAsActive = bind(this.markBlockAsActive, this);
      this.initialize = bind(this.initialize, this);
      return TimelineViewMosaic.__super__.constructor.apply(this, arguments);
    }

    TimelineViewMosaic.prototype.DT = "blocks.clientsideTimeline.TimelineViewMosaic";

    TimelineViewMosaic.prototype.initialize = function(container, firstTime) {
      var vbs;
      if (firstTime == null) {
        firstTime = false;
      }
      TimelineViewMosaic.__super__.initialize.apply(this, arguments);
      this.initialized = true;
      vbs = $('.viewer', container);
      if (firstTime) {
        vbs.trigger(Player.ACTION_UNEMBED_IF_NOT_PLAYING);
        this.rawVideoAnnouncements = $('.timeline-right-block [block-raw-video-announcements]');
        this.rawVideoAnnouncements.on(rawVideoAnnouncements.Block.EVENT_ADDED + " " + rawVideoAnnouncements.Block.EVENT_DELETED, this.recalculateMosaic);
        this.profileRecommendations = $('.timeline-right-block [widget-profile-recommendations]');
        this.profileRecommendations.on(widgets.ProfileRecommendations.EVENTS.ChannelAdded, this.recalculateMosaic);
        $(document).on(CoubBlockClientside.EVENT_RELOAD_COMPLETE, this.onEventStatusUpdated);
      }
      return this.bindViewerBlocks(vbs);
    };

    TimelineViewMosaic.prototype.bindViewerBlocks = function(vbs) {
      vbs.trigger(Player.ACTION_ACTIVATE_HAND_CONTROL);
      vbs.on("playWasStarted", this.markBlockAsActive).on("playWasStarted", this.suspendCover).on(Player.EVENT_PAUSED, this.startPlayingCoverIfCan);
      if (GlobalState.PLATFORM.isMobile()) {
        return;
      }
      return vbs.on("mousemove", this.playCoub).on("mouseleave", this.cancelCoubPlay);
    };

    TimelineViewMosaic.prototype.markBlockAsActive = function(e) {
      $(".coub", this.parent.list).removeClass("active");
      return $(e.currentTarget).parents(".coub").addClass("active");
    };

    TimelineViewMosaic.prototype.playCoub = function(e) {
      var $viewer;
      if (helpers.Location.isFullScreen()) {
        return;
      }
      $viewer = $(e.currentTarget);
      if (this.isPlaying($viewer) || this.isPaused($viewer)) {
        return;
      }
      return $viewer.focus().triggerHandler("play");
    };

    TimelineViewMosaic.prototype.cancelCoubPlay = function(e) {
      var $viewer;
      if (helpers.Location.isFullScreen()) {
        return;
      }
      $viewer = $(e.currentTarget);
      if (!this.isPlaying($viewer)) {
        return;
      }
      return $viewer.triggerHandler("unembed");
    };

    TimelineViewMosaic.prototype.isPlaying = function(viewer) {
      return viewer.hasClass('-state-playing') || viewer.hasClass('-state-loading');
    };

    TimelineViewMosaic.prototype.isPaused = function(viewer) {
      return viewer.hasClass('-state-paused');
    };

    TimelineViewMosaic.prototype.recalculateMosaic = function() {
      if (this.parent.list.data('masonry')) {
        return this.parent.list.masonry();
      }
    };

    TimelineViewMosaic.prototype.onEventStatusUpdated = function(e) {
      this.parent.list.masonry("reloadItems");
      this.bindViewerBlocks(e.cb.getViewerBlock());
      return this.recalculateMosaic();
    };

    TimelineViewMosaic.prototype.destroy = function() {
      var vbs;
      if (!this.initialized) {
        return;
      }
      TimelineViewMosaic.__super__.destroy.apply(this, arguments);
      vbs = $(".viewer", this.parent.list);
      vbs.off("playWasStarted", this.markBlockAsActive);
      vbs.off("playWasStarted", this.suspendCover);
      vbs.off(Player.EVENT_PAUSED, this.startPlayingCoverIfCan);
      vbs.off("mousemove", this.playCoub);
      vbs.off("mouseleave", this.cancelCoubPlay);
      vbs.trigger(Player.ACTION_DEACTIVATE_HAND_CONTROL);
      vbs.trigger('unembed');
      this.rawVideoAnnouncements && this.rawVideoAnnouncements.off(rawVideoAnnouncements.Block.EVENT_ADDED + " " + rawVideoAnnouncements.Block.EVENT_DELETED, this.recalculateMosaic);
      this.profileRecommendations && this.profileRecommendations.off(widgets.ProfileRecommendations.EVENTS.ChannelAdded);
      $(document).off(CoubBlockClientside.EVENT_RELOAD_COMPLETE, this.onEventStatusUpdated);
      if (this.parent.list.data('masonry')) {
        return this.parent.list.masonry('destroy');
      }
    };

    TimelineViewMosaic.prototype.render = function() {
      var cornerStamp, ref, selector;
      this.parent.renderData['card-type'] = 'small';
      $('.coub', this.parent.list).trigger({
        type: CoubBlockClientside.ACTION_UPDATE_CARD_TYPE,
        cardType: blocks.coub.CardTypes.types.small
      });
      ref = GlobalState.PAGE.isBestCoubs2014() ? ['.coub:visible, .best-2014__tag', '.best-2014__promo-col'] : GlobalState.TIMELINE.type() === 'best2015_likes' ? ['.coub:visible', '.best-2015-page--coubs .timeline-right-block'] : GlobalState.TIMELINE.type() === 'best2015_gems' ? ['.coub:visible', '.best-2015-page--gems .timeline-right-block'] : GlobalState.TIMELINE.type() === 'best2015_memes' ? ['.coub:visible, .best-2015__meme', void 0] : GlobalState.TIMELINE.type() === 'best2016_memes' ? ['.coub:visible, .best-2016__meme', void 0] : GlobalState.TIMELINE.type() === 'best2016_oldspice' ? ['.coub:visible', '.oldspice-promo__vote-block .coub__inner'] : GlobalState.TIMELINE.type() === 'best2015_mybest' ? ['.coub:visible', '.feed-banner'] : ['.coub, .ad-banner--timeline, .adfox-banner--tile', '.timeline-right-block'], selector = ref[0], cornerStamp = ref[1];
      this.parent.list.masonry({
        columnWidth: 310,
        gutterWidth: 20,
        itemSelector: selector,
        cornerStamp: cornerStamp
      });
      return this.parent.list.masonry("resize");
    };

    TimelineViewMosaic.prototype.appendPage = function(container) {
      return this.parent.list.masonry("appended", container);
    };

    TimelineViewMosaic.prototype.suspendCover = function(e) {
      if (GlobalState.PAGE.isProfile() && pages.profile.view.Cover.getCoverType() === pages.profile.view.Cover.COVER_TYPE.COUB) {
        return $(".hero-cover__att .viewer").trigger("suspend");
      }
    };

    TimelineViewMosaic.prototype.startPlayingCoverIfCan = function() {
      console.log(this.DT, this.isAnyCoubPlaying());
      if (!this.isAnyCoubPlaying()) {
        return $(".hero-cover__att .viewer").trigger("play");
      }
    };

    TimelineViewMosaic.prototype.onCoverFocus = function(e) {
      TimelineViewMosaic.__super__.onCoverFocus.apply(this, arguments);
      return this.startPlayingCoverIfCan();
    };

    TimelineViewMosaic.prototype.onCoverBlur = function(e) {
      TimelineViewMosaic.__super__.onCoverBlur.apply(this, arguments);
      return $(".hero-cover__att .viewer").trigger("suspend");
    };

    return TimelineViewMosaic;

  })(blocks.clientsideTimeline.TimelineViewAbstract);

}).call(this);
(function() {
  window.blocks.coub.CardStatuses = {
    statuses: {
      normal: {
        name: "normal",
        viewerBlockTemplate: JST["app/site/templates/coub_block/viewer_block"]
      },
      temp: {
        name: "temp",
        viewerBlockTemplate: JST["app/site/templates/coub_block/stubs/temp_coub_card"]
      },
      inProcess: {
        name: "inProcess",
        viewerBlockTemplate: JST["app/site/templates/coub_block/stubs/in_process_card"],
        getHandler: (function(_this) {
          return function() {
            return blocks.coub.CardStatusIsProcessing;
          };
        })(this)
      },
      ageRestricted: {
        name: "ageRestricted",
        viewerBlockTemplate: JST["app/site/templates/coub_block/stubs/age_restricted_card"],
        getHandler: (function(_this) {
          return function() {
            return blocks.coub.CardStatusAgeRestricted;
          };
        })(this)
      },
      noPermission: {
        name: "noPermission",
        viewerBlockTemplate: JST["app/site/templates/coub_block/stubs/no_permission_card"]
      }
    },
    getCardStatusByCoub: function(coub) {
      if (!helpers.Coub.visibleForCurrentUser(coub)) {
        return blocks.coub.CardStatuses.statuses.noPermission;
      } else if (coub.type === "Coub::Temp") {
        return blocks.coub.CardStatuses.statuses.temp;
      } else if (!coub.is_done) {
        return blocks.coub.CardStatuses.statuses.inProcess;
      } else if (helpers.Coub.ageRestrictedForCurrentUser(coub)) {
        return blocks.coub.CardStatuses.statuses.ageRestricted;
      } else {
        return blocks.coub.CardStatuses.statuses.normal;
      }
    }
  };

}).call(this);
(function() {
  window.blocks.coub.CardStatusAbstract = (function() {
    function CardStatusAbstract(cb) {
      this.cb = cb;
    }

    return CardStatusAbstract;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.blocks.coub.CardStatusAgeRestricted = (function(superClass) {
    extend(CardStatusAgeRestricted, superClass);

    function CardStatusAgeRestricted(cb) {
      this.confirmAge = bind(this.confirmAge, this);
      CardStatusAgeRestricted.__super__.constructor.apply(this, arguments);
      $("[age-confirm-btn]", this.cb.el).one("click", this.confirmAge);
    }

    CardStatusAgeRestricted.prototype.confirmAge = function() {
      $.cookie('confirmed_age', '1', {
        path: '/'
      });
      return this.cb.reload(void 0);
    };

    return CardStatusAgeRestricted;

  })(blocks.coub.CardStatusAbstract);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.blocks.coub.CardStatusIsProcessing = (function(superClass) {
    extend(CardStatusIsProcessing, superClass);

    CardStatusIsProcessing.prototype.CHECK_STATE_TIME = 3000;

    CardStatusIsProcessing.prototype.DT = "blocks.coub.CardStatusIsProcessing";

    function CardStatusIsProcessing(cb) {
      this.finalizationCheck = bind(this.finalizationCheck, this);
      CardStatusIsProcessing.__super__.constructor.apply(this, arguments);
      this.finalizationStatusChecker = setInterval(this.finalizationCheck, this.CHECK_STATE_TIME);
      History.Adapter.bind(window, "statechange", this.destroy.bind(this));
    }

    CardStatusIsProcessing.prototype.finalizationCheck = function() {
      return $.get(Routes.processing_status_api_v2_coub_path(this.cb.permalink), (function(_this) {
        return function(data) {
          if (!data.done) {
            return;
          }
          setTimeout(function(cb) {
            return cb.reload();
          }, 2000, _this.cb);
          _this.destroy();
          return _this.playDing();
        };
      })(this));
    };

    CardStatusIsProcessing.prototype.playDing = function() {
      var sound;
      sound = $("#coubIsDoneSound").get(0);
      if (!sound) {
        return;
      }
      return sound.play();
    };

    CardStatusIsProcessing.prototype.destroy = function() {
      console.log(this.DT, "Destroy.");
      $(window).off("statechange", this.destroy);
      return clearInterval(this.finalizationStatusChecker);
    };

    return CardStatusIsProcessing;

  })(window.blocks.coub.CardStatusAbstract);

}).call(this);
(function() {
  window.blocks.coub.CardTypes = {
    types: {
      small: {
        name: "small",
        className: "small-card",
        size: [310, 2e308]
      },
      normal: {
        name: "normal",
        className: "normal-card",
        size: [640, 480]
      },
      page: {
        name: "page",
        className: "page-card",
        size: [640, 480]
      }
    },
    getClassName: function(type) {
      return type.className;
    },
    getDefaultCardType: function() {
      return blocks.coub.CardTypes.types.normal;
    },
    getSize: function(type) {
      return type.size;
    }
  };

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  blocks.FriendshipItem = (function() {
    FriendshipItem.ATTR_NAME = 'widget-friendship-item';

    FriendshipItem.prototype.COUNTS = {
      INITIAL: 3,
      DEFAULT: 1
    };

    FriendshipItem.TYPES = {
      FOLLOW: 'follow',
      IGNORE: 'ignore'
    };

    function FriendshipItem(el) {
      this.el = el;
      this.updateFriendshipsTrigger = bind(this.updateFriendshipsTrigger, this);
      this.getCountValue = bind(this.getCountValue, this);
      this.ignore = bind(this.ignore, this);
      this.getFriendship = bind(this.getFriendship, this);
      this.pushFriendId = bind(this.pushFriendId, this);
      this.el = $(this.el);
      this.type = this.el.attr('data-friendship-type');
      this.friendId = parseInt(this.el.attr('data-friendship-id'));
      this.provider = new dataProviders.ApiV2();
      this.locker = new chms.utils.Locker($(this.el));
      this.item = blocks.FriendshipItem;
      this.pushFriendId(this.friendId, this.type.toUpperCase());
      $(document).on(widgets.FollowButton.EVENTS.FOLLOW_COMPLETED, (function(_this) {
        return function(e) {
          if (e.targetId.toString() === _this.el.attr('data-channel-id')) {
            return _this.getFriendship(_this.item.TYPES.FOLLOW);
          }
        };
      })(this));
      this.el.find('.close-small').on('click', (function(_this) {
        return function() {
          return _this.ignore();
        };
      })(this));
    }

    FriendshipItem.prototype.pushFriendId = function(id, type) {
      return blocks.FriendshipsBlock.IDS[type].push(id);
    };

    FriendshipItem.prototype.getFriendship = function(type) {
      var count, current;
      current = blocks.FriendshipsBlock.getCurrentIds();
      count = this.getCountValue(type);
      return this.locker.safeExec((function(_this) {
        return function() {
          _this.locker.lock();
          return _this.provider.getFriendshipsByType({}, 'next', count, {
            success: function(resp) {
              return _this.updateFriendshipsTrigger(resp.friends, type);
            },
            error: function(resp) {
              return ErrorMessages.internalServerError();
            },
            complete: function() {
              return _this.locker.unlock();
            }
          });
        };
      })(this));
    };

    FriendshipItem.prototype.ignore = function() {
      return this.provider.ignorePossibleFriend(this.friendId, this.type, {
        success: (function(_this) {
          return function(resp) {
            return _this.getFriendship(_this.item.TYPES.IGNORE);
          };
        })(this),
        error: (function(_this) {
          return function(e) {
            if (e.status === 404) {
              return _this.getFriendship(_this.item.TYPES.IGNORE);
            } else {
              return ErrorMessages.internalServerError();
            }
          };
        })(this)
      });
    };

    FriendshipItem.prototype.getCountValue = function(type) {
      if (blocks.FriendshipsBlock.INITIAL_FOLLOW_ACTION && type === this.item.TYPES.FOLLOW) {
        return this.COUNTS.INITIAL;
      } else {
        return this.COUNTS.DEFAULT;
      }
    };

    FriendshipItem.prototype.updateFriendshipsTrigger = function(friends, type) {
      var parent;
      parent = this.el.parents('[widget-friendships-block]');
      return parent.trigger({
        type: blocks.FriendshipsBlock.EVENTS.UPDATE,
        friends: friends,
        currentId: this.friendId,
        actionType: type
      });
    };

    return FriendshipItem;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  CoubAnimators.FriendshipItemAnimator = (function() {
    FriendshipItemAnimator.prototype.ITEM_HEIGHT = 140;

    FriendshipItemAnimator.prototype.DURATIONS = {
      SINGLE: 300,
      MULTIPLE: 200,
      REMOVE: 300,
      FOLLOW: 100
    };

    FriendshipItemAnimator.prototype.TYPES = {
      SINGLE: {
        NAME: 'single'
      },
      MULTIPLE: {
        NAME: 'multiple'
      },
      REMOVE: {
        NAME: 'remove'
      }
    };

    function FriendshipItemAnimator(block) {
      this.block = block;
      this.unwrap = bind(this.unwrap, this);
      this.getItemsLength = bind(this.getItemsLength, this);
      this.tempWrap = bind(this.tempWrap, this);
      this.getCurrentWrap = bind(this.getCurrentWrap, this);
      this.getPrevItem = bind(this.getPrevItem, this);
      this.setCurrentAnimationHandler = bind(this.setCurrentAnimationHandler, this);
      this.followTimeout = bind(this.followTimeout, this);
      this.removePrevItem = bind(this.removePrevItem, this);
      this.getAndInitItem = bind(this.getAndInitItem, this);
      this.remove = bind(this.remove, this);
      this.multiple = bind(this.multiple, this);
      this.single = bind(this.single, this);
      this.animate = bind(this.animate, this);
      this.animators = CoubAnimators.FriendshipItemAnimator;
      this.itemClass = blocks.FriendshipItem;
      this.animationHandler = void 0;
      this.animationDuration = void 0;
      this.previous = void 0;
      this.type = void 0;
    }

    FriendshipItemAnimator.prototype.animate = function(opts) {
      var length;
      if (opts == null) {
        opts = {};
      }
      length = opts.items.length;
      this.type = length > 1 ? this.TYPES.MULTIPLE.NAME : this.TYPES.SINGLE.NAME;
      this.previous = this.getPrevItem(opts.prevId);
      this.setCurrentAnimationHandler(this.type);
      return this.animationHandler(opts.items, opts.actionType);
    };

    FriendshipItemAnimator.prototype.single = function(items, actionType) {
      var appended, cardAnimate, i, item, len;
      this.tempWrap(this.previous);
      for (i = 0, len = items.length; i < len; i++) {
        item = items[i];
        this.getAndInitItem(item, 'hooded');
      }
      appended = this.getCurrentWrap().find('.list__item:last');
      cardAnimate = (function(_this) {
        return function() {
          _this.previous.addClass('fade');
          appended.css({
            left: 0
          });
          return setTimeout(function() {
            appended.removeClass('hooded');
            _this.unwrap(appended);
            return _this.removePrevItem(_this.previous.children().attr('data-friendship-id'));
          }, _this.animationDuration);
        };
      })(this);
      if (actionType === this.itemClass.TYPES.FOLLOW) {
        return this.followTimeout(cardAnimate);
      } else {
        return _.defer(function() {
          return cardAnimate();
        });
      }
    };

    FriendshipItemAnimator.prototype.multiple = function(items, actionType) {
      var borderShift, i, item, len, slideToHeight, wrap, wrapHeight;
      this.tempWrap(this.previous);
      for (i = 0, len = items.length; i < len; i++) {
        item = items[i];
        this.getAndInitItem(item);
      }
      wrap = this.getCurrentWrap();
      borderShift = 1;
      wrapHeight = items.length * this.ITEM_HEIGHT + items.length * borderShift;
      slideToHeight = (function(_this) {
        return function() {
          wrap.css({
            height: wrapHeight
          });
          _this.previous.addClass('prev').css({
            opacity: 0
          });
          return setTimeout(function() {
            _this.removePrevItem(_this.previous.children().attr('data-friendship-id'));
            return _this.unwrap();
          }, _this.animationDuration);
        };
      })(this);
      return slideToHeight();
    };

    FriendshipItemAnimator.prototype.remove = function(id) {
      var blockRemove, item, itemRemove, wrap;
      this.type = this.TYPES.REMOVE.NAME;
      item = this.getPrevItem(id);
      this.tempWrap(item);
      wrap = this.getCurrentWrap();
      itemRemove = (function(_this) {
        return function() {
          item.addClass('fade');
          wrap.css({
            height: 0
          });
          return setTimeout(function() {
            return wrap.detach();
          }, _this.DURATIONS.REMOVE);
        };
      })(this);
      blockRemove = (function(_this) {
        return function() {
          return _this.block.remove();
        };
      })(this);
      if (this.getItemsLength() === 1) {
        this.block.css({
          height: this.block.height()
        });
        return this.followTimeout(blockRemove);
      } else {
        return this.followTimeout(itemRemove);
      }
    };

    FriendshipItemAnimator.prototype.getAndInitItem = function(item, cl) {
      var friendshipItem, listItem;
      if (cl == null) {
        cl = '';
      }
      listItem = $("<div class='list__item " + cl + "' />");
      friendshipItem = $(JST['app/site/templates/blocks/friendships_block/friendship_list_item'](item));
      this.previous.after(listItem.append(friendshipItem));
      chms.utils.Autoinit.init(blocks.FriendshipItem, listItem);
      return chms.utils.Autoinit.init(widgets.WidgetFollowButtonInit, listItem);
    };

    FriendshipItemAnimator.prototype.removePrevItem = function(id) {
      this.getPrevItem(id).detach();
      return this.previous = void 0;
    };

    FriendshipItemAnimator.prototype.followTimeout = function(handler) {
      return setTimeout((function(_this) {
        return function() {
          return handler();
        };
      })(this), this.DURATIONS.FOLLOW);
    };

    FriendshipItemAnimator.prototype.setCurrentAnimationHandler = function(type) {
      this.animationHandler = this[this.TYPES[type.toUpperCase()].NAME];
      return this.animationDuration = this.DURATIONS[type.toUpperCase()];
    };

    FriendshipItemAnimator.prototype.getPrevItem = function(id) {
      return this.block.find("[widget-friendship-item][data-friendship-id=" + id + "]").parent();
    };

    FriendshipItemAnimator.prototype.getCurrentWrap = function() {
      return this.block.find('.animation-wrap');
    };

    FriendshipItemAnimator.prototype.tempWrap = function(element) {
      return element.wrap("<div class='animation-wrap " + this.type + "' />");
    };

    FriendshipItemAnimator.prototype.getItemsLength = function() {
      return this.block.find('.list__item').length;
    };

    FriendshipItemAnimator.prototype.unwrap = function(element) {
      var next, prev, saved, wrap;
      if (element == null) {
        element = void 0;
      }
      if (this.type === this.TYPES.SINGLE.NAME) {
        return element.unwrap();
      } else {
        wrap = this.getCurrentWrap();
        saved = this.getCurrentWrap().children();
        prev = wrap.prev();
        next = wrap.next();
        saved.css({
          opacity: 0
        });
        wrap.detach();
        if (prev.length) {
          prev.after(saved);
        } else if (next.length) {
          next.before(saved);
        } else {
          this.block.find('.list').append(saved);
        }
        return setTimeout((function(_this) {
          return function() {
            return saved.css({
              opacity: 1
            });
          };
        })(this), this.animationDuration);
      }
    };

    return FriendshipItemAnimator;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  blocks.FriendshipsBlock = (function(superClass) {
    extend(FriendshipsBlock, superClass);

    FriendshipsBlock.ATTR_NAME = 'widget-friendships-block';

    FriendshipsBlock.IDS = {
      POSSIBLE: [],
      EDITORIAL: [],
      SUGGESTED: []
    };

    FriendshipsBlock.EVENTS = {
      UPDATE: 'blocks.FriendshipsBlock:Events:Update'
    };

    FriendshipsBlock.ACTIONS = {
      UPDATED: 'blocks.FriendshipsBlock:Actions:Updated'
    };

    FriendshipsBlock.INITIAL_FOLLOW_ACTION = true;

    FriendshipsBlock.prototype.DT = "blocks.FriendshipsBlock";

    function FriendshipsBlock(el) {
      this.el = el;
      this.initContent = bind(this.initContent, this);
      this.prerender = bind(this.prerender, this);
      this.update = bind(this.update, this);
      this.el = $(this.el);
      if (!this.prerender()) {
        this.initContent();
      }
    }

    FriendshipsBlock.prototype.update = function(friends, id, actionType) {
      var friend, i, ids, len, type;
      if (_.isEmpty(friends)) {
        this.animator.remove(id);
      } else {
        for (i = 0, len = friends.length; i < len; i++) {
          friend = friends[i];
          type = friend.type.toUpperCase();
          ids = _.without(blocks.FriendshipsBlock.IDS[type], id);
          blocks.FriendshipsBlock.IDS[type] = ids;
        }
        this.animator.animate({
          items: friends,
          prevId: id,
          actionType: actionType
        });
        console.log(blocks.FriendshipsBlock.INITIAL_FOLLOW_ACTION);
        if (actionType === 'follow') {
          if (blocks.FriendshipsBlock.INITIAL_FOLLOW_ACTION) {
            blocks.FriendshipsBlock.INITIAL_FOLLOW_ACTION = false;
          }
        }
      }
      return setTimeout(function() {
        return $(document).trigger(blocks.FriendshipsBlock.ACTIONS.UPDATED);
      }, this.animator.DURATIONS.SINGLE);
    };

    FriendshipsBlock.prototype.prerender = function() {
      console.log(this.DT, "Prerender.", this.el.attr("rendered") != null);
      if (this.el.attr("rendered") == null) {
        this.provider = new dataProviders.ApiV2();
        this.provider.getFriendshipsByType({}, 'initial', 4, {
          success: (function(_this) {
            return function(r) {
              var rendered, sh, t;
              t = JST["app/site/templates/blocks/friendships_block/friendships_layout"];
              if ((r.friends != null) && r.friends.length > 0) {
                rendered = $(t({
                  friends: r.friends
                }));
                _this.el.replaceWith(rendered);
                _this.el = rendered;
                _this.el.attr({
                  rendered: "true"
                });
                sh = _this.el.height();
                _this.el.css({
                  height: 0
                });
                _this.el.addClass("animate-prerender-300ms");
                requestAnimationFrame(function() {
                  _this.el.css({
                    height: sh
                  });
                  return setTimeout((function() {
                    rendered.removeClass("animate-prerender-300ms");
                    return rendered.css({
                      height: ""
                    });
                  }), 300);
                });
                chms.utils.Autoinit.init(widgets.WidgetFollowButtonInit, _this.el);
                _this.initContent();
                return $(document).trigger(blocks.FriendshipsBlock.ACTIONS.UPDATED);
              }
            };
          })(this),
          error: ErrorMessages.internalServerError
        });
        return true;
      } else {
        return false;
      }
    };

    FriendshipsBlock.prototype.initContent = function() {
      console.log(this.DT, "Init content.");
      chms.utils.Autoinit.init(blocks.FriendshipItem, this.el);
      this.animator = new CoubAnimators.FriendshipItemAnimator(this.el);
      return this.el.bind(blocks.FriendshipsBlock.EVENTS.UPDATE, (function(_this) {
        return function(event) {
          return _this.update(event.friends, event.currentId, event.actionType);
        };
      })(this));
    };

    FriendshipsBlock.getCurrentIds = function() {
      var editorial, possible, suggested;
      possible = blocks.FriendshipsBlock.IDS.POSSIBLE;
      editorial = blocks.FriendshipsBlock.IDS.EDITORIAL;
      suggested = blocks.FriendshipsBlock.IDS.EDITORIAL;
      return $.extend({
        possible: possible
      }, {
        editorial: editorial
      }, {
        suggested: suggested
      });
    };

    return FriendshipsBlock;

  })(AbstractPiece);

}).call(this);

/*
  Список нотификейшнов о фолловинге
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  blocks.FriendshipNotificationsList = (function(superClass) {
    extend(FriendshipNotificationsList, superClass);

    FriendshipNotificationsList.ATTR_NAME = "block-friendship-notifications-list";

    FriendshipNotificationsList.prototype.DT = "blocks.FriendshipNotificationsList";

    function FriendshipNotificationsList(el1, parent) {
      this.el = el1;
      this.parent = parent;
      this.initLoadMoreCounter = bind(this.initLoadMoreCounter, this);
      this.initChannelDropdown = bind(this.initChannelDropdown, this);
      this.initSubwidgets = bind(this.initSubwidgets, this);
      this.markCurrentGroupAsReaded = bind(this.markCurrentGroupAsReaded, this);
      this.calcMinTotalNotifications = bind(this.calcMinTotalNotifications, this);
      this.getPreloadMoreBtnHeigth = bind(this.getPreloadMoreBtnHeigth, this);
      this.resetNotifications = bind(this.resetNotifications, this);
      this.updateChannelId = bind(this.updateChannelId, this);
      this.initList = bind(this.initList, this);
      FriendshipNotificationsList.__super__.constructor.apply(this, arguments);
      this.udata = new siteData.UserData();
      this.uidata = new siteData.UI();
      this.initList();
      this.from = void 0;
      this.inputCurChannel = $("input[name='channel_id']", this.el);
      this.data = new siteData.AbstractReactiveData();
      this.updateChannelId();
      this.data.getFiltedStream(["currentChannel"]).onValue((function(_this) {
        return function() {
          _this.resetNotifications();
          return _this.markCurrentGroupAsReaded();
        };
      })(this));
      this.initSubwidgets();
      this.inputCurChannel.on("change", this.updateChannelId);
    }

    FriendshipNotificationsList.prototype.initList = function() {
      var initData, list, provider;
      provider = new dataProviders.ApiV2();
      list = new blocks.ItemList(this.el);
      initData = (function(_this) {
        return function() {
          list.data.set("currentServerPage", 0);
          return list.data.set("totalServerPages", 2e308);
        };
      })(this);
      initData();
      list.isServerHasItems = (function(_this) {
        return function() {
          return list.data.get("currentServerPage") < list.data.get("totalServerPages");
        };
      })(this);
      list.getDefaultPerPage = (function(_this) {
        return function() {
          return 20;
        };
      })(this);
      list.getTemplate = (function(_this) {
        return function() {
          return JST["app/site/templates/object_media/object_media_notification_list/object_media_notification_list"];
        };
      })(this);
      list.resetData = (function(_this) {
        return function() {
          list.initData();
          initData();
          return list.clearContent();
        };
      })(this);
      list.fetchDataFromServer = (function(_this) {
        return function(completed) {
          var nextPage, query;
          nextPage = list.data.get("currentServerPage") + 1;
          if (!list.isServerHasItems() || list.xhrLocker.isLocked()) {
            return false;
          } else {
            query = provider.getNotifications(nextPage, provider.NOTIFICATION_TYPE_FOLLOW, (_this.data.get("currentChannel") === "all" ? void 0 : _this.data.get("currentChannel")), _this.from, {
              beforeSend: function() {
                return list.xhrLocker.lock();
              },
              success: function(e) {
                list.data.concat("notrendered", e.notifications);
                list.data.set("totalServerPages", e.total_pages);
                list.data.addNum("currentServerPage", 1);
                if (!_this.from && (e.notifications != null) && e.notifications.length > 1) {
                  return _this.from = e.notifications[0].updated_at;
                }
              },
              error: ErrorMessages.internalServerError,
              complete: function() {
                list.xhrLocker.unlock();
                if (completed != null) {
                  return completed();
                }
              }
            });
            return true;
          }
        };
      })(this);
      list.drawItem = (function(_this) {
        return function(i) {
          var el;
          el = $(list.getTemplate()({
            bgLink: helpers.Notifications.getBgLink(i),
            classes: "-medium-avatar",
            img: JST["app/site/templates/blocks/friendship_notifications/friendship_notification_img"](i),
            body: JST["app/site/templates/blocks/friendship_notifications/friendship_notification_body"](i),
            important: i.important
          }));
          chms.utils.Autoinit.init(widgets.WidgetFollowButtonInit, el);
          new blocks.NotificationsGroup(el);
          el.addClass("animate-swing-in__item");
          setTimeout((function() {
            return this.addClass("animate-swing-in__item-showed");
          }).bind(el), 25);
          return el;
        };
      })(this);
      this.list = list;
      return this.loadbtn = this.list.loadControl;
    };

    FriendshipNotificationsList.prototype.updateChannelId = function() {
      var cid;
      cid = this.inputCurChannel.val();
      return this.data.setIfUnequal("currentChannel", cid);
    };

    FriendshipNotificationsList.prototype.resetNotifications = function() {
      this.list.resetData();
      return this.list.preloadAndDraw(this.parent.FIRST_PAGE_NOTIFICATIONS);
    };

    FriendshipNotificationsList.prototype.getPreloadMoreBtnHeigth = function() {
      var h, visible;
      visible = this.loadbtn.is(":visible");
      if (!visible) {
        this.loadbtn.show();
      }
      h = this.loadbtn.outerHeight(true);
      if (!visible) {
        this.loadbtn.css("display", "");
      }
      return h;
    };

    FriendshipNotificationsList.prototype.calcMinTotalNotifications = function() {
      return (this.list.data.get("totalServerPages") - 1) * this.list.getDefaultPerPage() + 1;
    };

    FriendshipNotificationsList.prototype.markCurrentGroupAsReaded = function() {
      var cu, key;
      cu = this.data.get("currentChannel");
      if (cu === "all") {
        key = "unreadFollowNotifications";
      } else {
        key = this.udata.getKeyForUnreadNotifications(cu, this.udata.s.UNREAD_NOTIFICATION_KIND_FRIENDS);
      }
      return this.parent.data.pushUniq("readedGroups", key);
    };

    FriendshipNotificationsList.prototype.initSubwidgets = function() {
      this.initLoadMoreCounter();
      this.initChannelDropdown();
      return LoadRotator.appendToContainer($(".subgroup__content", this.el), "small");
    };

    FriendshipNotificationsList.prototype.initChannelDropdown = function() {
      var ad, cs, cscontent, hideOnScroll, ns;
      cs = $("[channel-selector]", this.el);
      cscontent = $(cs.find(".dropdown__content").html());
      cscontent.find(".list-wrap").nice_scroller();
      cscontent.find(".list__item").each((function(_this) {
        return function(i, e) {
          var cfriends, el, inject, obj, sfriends;
          el = $(e);
          obj = el.attr("data-val");
          inject = $("<span class='counters -v-centered-box'>\n  <span widget-counter friends-counter class='counter__friends hbold'>\n    <span counter-value>0</span>\n  </span>\n</span>");
          cfriends = new widgets.Counter(inject.find("[friends-counter]"));
          if (obj === "all") {
            sfriends = "unreadFollowNotifications";
          } else {
            sfriends = _this.udata.getKeyForUnreadNotifications(obj, _this.udata.s.UNREAD_NOTIFICATION_KIND_FRIENDS);
          }
          _this.parent.data.getFiltedStream(["readedGroups"]).onValue(function(v) {
            if (v.value.indexOf(sfriends) !== -1 || v.value.indexOf("all") !== -1) {
              return cfriends.setValue(0);
            }
          });
          cfriends.setValue(_this.udata.get(sfriends));
          return $(e).append(inject);
        };
      })(this));
      hideOnScroll = (function(_this) {
        return function() {
          $(document).off('scroll', hideOnScroll);
          _this.parent.dropdown.find(".dd-notification-list.list-wrap").one("nice_scroll:update", hideOnScroll);
          return ns.trigger('hide');
        };
      })(this);
      this.parent.el.find("> .dropdown").on("hided", hideOnScroll);
      ad = new ControlableAbsoluteDropdown({
        el: cs,
        handle: cs.find("button"),
        defaultContent: cscontent
      });
      ns = cs.nice_select();
      this.uidata.getFiltedStream(["showedDropdowns"]).filter((function(_this) {
        return function(v) {
          return v.value.length > 1;
        };
      })(this)).onValue((function(_this) {
        return function() {
          _this.parent.dropdown.trigger(Dropdown.ACTION_ALLOW_HIDING);
          return _this.parent.dropdown.trigger('hide');
        };
      })(this));
      ad.el.on("beforeShow", (function(_this) {
        return function() {
          $(document).one('scroll', hideOnScroll);
          _this.parent.dropdown.find(".dd-notification-list.list-wrap").one("nice_scroll:update", hideOnScroll);
          return _this.parent.dropdown.trigger(Dropdown.ACTION_PREVENT_HIDING);
        };
      })(this));
      ad.el.on("hided", (function(_this) {
        return function(e) {
          _this.parent.dropdown.trigger(Dropdown.ACTION_ALLOW_HIDING);
          return e.stopPropagation();
        };
      })(this));
      ns.on("hide", (function(_this) {
        return function(e) {
          e.stopPropagation();
          return ad.hide();
        };
      })(this));
      return ns.trigger({
        type: "setContent",
        content: cscontent
      });
    };

    FriendshipNotificationsList.prototype.initLoadMoreCounter = function() {
      var drawStartLoaderValue, getCurrentKey, loadbtncounter;
      loadbtncounter = new widgets.Counter(this.loadbtn.find("[current-unread-counter]"), (function(_this) {
        return function(v) {
          return "+" + v;
        };
      })(this));
      getCurrentKey = (function(_this) {
        return function() {
          var val;
          val = _this.data.get("currentChannel");
          if (val && val !== "all") {
            return _this.udata.getKeyForUnreadNotifications(val, _this.udata.s.UNREAD_NOTIFICATION_KIND_FRIENDS);
          } else {
            return "unreadFollowNotifications";
          }
        };
      })(this);
      this.data.set("loadMoreGroupsReaded", []);
      this.data.sBeforeChanged.filter((function(_this) {
        return function(v) {
          return v.key === "currentChannel";
        };
      })(this)).onValue((function(_this) {
        return function(v) {
          return _this.data.pushUniq("loadMoreGroupsReaded", v.current);
        };
      })(this));
      drawStartLoaderValue = (function(_this) {
        return function() {
          var ck, rg;
          ck = getCurrentKey();
          rg = _this.parent.data.get("readedGroups");
          if (rg.indexOf("all") !== -1 || _this.data.get("loadMoreGroupsReaded").indexOf(_this.data.get("currentChannel")) !== -1) {
            return loadbtncounter.setValue(0);
          } else {
            return loadbtncounter.setValue(_this.udata.get(ck));
          }
        };
      })(this);
      this.data.getFiltedStream(["currentChannel"]).merge(this.parent.dropdown.asEventStream("showed").filter((function(_this) {
        return function(e) {
          return $(e.target).hasClass("notifications-friendship");
        };
      })(this))).onValue((function(_this) {
        return function() {
          return drawStartLoaderValue();
        };
      })(this));
      drawStartLoaderValue(true);
      return $(this.list.data).on(this.list.data.s.EVENT_DATA_CONCATED_TO_ARRAY, (function(_this) {
        return function(e) {
          var cv;
          if (e.key === "rendered") {
            cv = loadbtncounter.data.get("value");
            return loadbtncounter.setValue(Math.max(0, cv - e.concated.length));
          }
        };
      })(this));
    };

    return FriendshipNotificationsList;

  })(AbstractPiece);

}).call(this);

/*
  Попап для нотификейшнов фолловинга
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  blocks.FriendshipNotificationsPopup = (function(superClass) {
    extend(FriendshipNotificationsPopup, superClass);

    FriendshipNotificationsPopup.ATTR_NAME = "block-friendship-notifications-popup";

    FriendshipNotificationsPopup.prototype.DT = "blocks.FriendshipNotificationsPopup";

    FriendshipNotificationsPopup.prototype.STATE_NOT_INITED = "not-inited";

    FriendshipNotificationsPopup.prototype.STATE_INITED = "inited";

    FriendshipNotificationsPopup.prototype.FIRST_PAGE_NOTIFICATIONS = 4;

    function FriendshipNotificationsPopup(el) {
      this.el = el;
      this.initSubwidgets = bind(this.initSubwidgets, this);
      this.calcInitNotificationsSize = bind(this.calcInitNotificationsSize, this);
      this.calcHeight = bind(this.calcHeight, this);
      this.markAllAsRead = bind(this.markAllAsRead, this);
      this.draw = bind(this.draw, this);
      this.onScrollerAtTheEnd = bind(this.onScrollerAtTheEnd, this);
      this.initScroller = bind(this.initScroller, this);
      this.preloadInitialData = bind(this.preloadInitialData, this);
      this.setDropdownHeight = bind(this.setDropdownHeight, this);
      this.initData = bind(this.initData, this);
      FriendshipNotificationsPopup.__super__.constructor.apply(this, arguments);
      this.userData = new siteData.UserData();
      this.uidata = new siteData.UI();
      this.provider = new dataProviders.ApiV2();
      this.dropdown = $(".dropdown", this.el);
      this.content = $(".dd-notification-list", this.el);
      this.initData();
      this.initSubwidgets();
      this.dropdown.on("showed", (function(_this) {
        return function() {
          return _this.data.set("showed", true);
        };
      })(this));
      this.dropdown.on("hided", (function(_this) {
        return function() {
          _this.data.set("showed", false);
          return _this.markAllAsRead();
        };
      })(this));
      this.data.getFiltedStream(["showed"]).filter((function(_this) {
        return function() {
          return _this.data.get("state") === _this.STATE_NOT_INITED && _this.data.get("showed");
        };
      })(this)).onValue(this.preloadInitialData);
      this.data.getFiltedStream(["state", "showed"]).onValue(this.draw);
      this.data.getFiltedStream(["state"]).filter((function(_this) {
        return function(v) {
          return v.value === _this.STATE_INITED;
        };
      })(this)).onValue(this.initScroller);
      this.content.click((function(_this) {
        return function(e) {
          return e.stopPropagation();
        };
      })(this));
      this.uidata.getFiltedStream(["windowHeight"]).filter((function(_this) {
        return function() {
          return _this.content.is(":visible");
        };
      })(this)).onValue(this.setDropdownHeight);
      this.draw();
    }

    FriendshipNotificationsPopup.prototype.initData = function() {
      this.data = new siteData.AbstractReactiveData();
      this.data.set("state", this.STATE_NOT_INITED);
      this.data.set("showed", false);
      return this.data.set("readedGroups", []);
    };

    FriendshipNotificationsPopup.prototype.setDropdownHeight = function() {
      var h, sb, th;
      sb = this.content.find(".subgroup");
      th = sb.map((function(_this) {
        return function(i, e) {
          return $(e).height();
        };
      })(this)).get().reduce(((function(_this) {
        return function(o, t) {
          return o + t;
        };
      })(this)), 0);
      h = this.calcHeight();
      h = h > th && th !== 0 ? th : h;
      this.content.css({
        height: h
      });
      return this.content.nice_scroller();
    };

    FriendshipNotificationsPopup.prototype.preloadInitialData = function() {
      var allPreloaded, checkPreloaded, notificationsPreloaded, whoToFollowPreloaded;
      notificationsPreloaded = false;
      whoToFollowPreloaded = false;
      allPreloaded = (function(_this) {
        return function() {
          var checkRendered, rendered;
          _this.friendshipNotifications.list.preloadAndDraw(_this.FIRST_PAGE_NOTIFICATIONS, true);
          _this.whoToFollow.list.preloadAndDraw(void 0, true);
          rendered = 0;
          checkRendered = function() {
            rendered++;
            if (rendered === 2) {
              _this.setDropdownHeight();
              return _this.data.set("state", _this.STATE_INITED);
            }
          };
          _this.friendshipNotifications.list.renderLocker.executeAfterUnlock(checkRendered);
          _this.whoToFollow.list.renderLocker.executeAfterUnlock(checkRendered);
          return $.post(Routes.notifications_viewed_api_v2_channels_path(), {
            type: _this.provider.NOTIFICATION_TYPE_FOLLOW
          });
        };
      })(this);
      checkPreloaded = (function(_this) {
        return function() {
          if (notificationsPreloaded && whoToFollowPreloaded) {
            return allPreloaded();
          }
        };
      })(this);
      this.friendshipNotifications.list.fetchDataFromServer((function(_this) {
        return function() {
          notificationsPreloaded = true;
          return checkPreloaded();
        };
      })(this));
      return this.whoToFollow.subwItems.fetchDataFromServer((function(_this) {
        return function() {
          whoToFollowPreloaded = true;
          return checkPreloaded();
        };
      })(this));
    };

    FriendshipNotificationsPopup.prototype.initScroller = function() {
      var ns;
      ns = this.dropdown.find(".dd-notification-list.list-wrap");
      ns.nice_scroller();
      return ns.on("nice_scroll:at_the_end", this.onScrollerAtTheEnd);
    };

    FriendshipNotificationsPopup.prototype.onScrollerAtTheEnd = function() {
      return this.whoToFollow.list.preloadAndDraw(void 0);
    };

    FriendshipNotificationsPopup.prototype.draw = function() {
      var isinited;
      isinited = this.data.get("state") !== this.STATE_NOT_INITED;
      if (!isinited) {
        this.content.addClass("-not-inited");
        if (this.data.get("showed")) {
          LoadRotator.appendToContainterAndStart(this.content, "small init-rotator");
        }
      } else {
        this.content.removeClass("-not-inited");
      }
      if (!this.data.get("showed") || isinited) {
        return this.content.find(".init-rotator").remove();
      }
    };

    FriendshipNotificationsPopup.prototype.markAllAsRead = function() {
      var udata;
      udata = new siteData.UserData();
      udata.set("unreadFollowNotifications", 0);
      return this.data.pushUniq("readedGroups", "all");
    };

    FriendshipNotificationsPopup.prototype.calcHeight = function() {
      var iTop, inner, marginBottom, wHeight;
      inner = this.dropdown.find(".dropdown__inner");
      iTop = inner.offset().top;
      wHeight = $(window).height();
      marginBottom = 125 - iTop;
      return wHeight - iTop - marginBottom;
    };

    FriendshipNotificationsPopup.prototype.calcInitNotificationsSize = function(n, h) {
      var calc, countNotifi, followHeight, followsHeights, notifiHeight, subgroupHeights, vacantSpace;
      notifiHeight = 72;
      followHeight = 72;
      subgroupHeights = this.el.find(".subgroup__header").map((function(_this) {
        return function(i, e) {
          return $(e).outerHeight(true);
        };
      })(this)).get().reduce(((function(_this) {
        return function(f, s) {
          return f + s;
        };
      })(this)), 0);
      followsHeights = followHeight * 1.5;
      vacantSpace = h - subgroupHeights - followsHeights;
      calc = (function(_this) {
        return function() {
          var r1;
          r1 = Math.min(Math.round(vacantSpace / notifiHeight), n);
          return Math.max(r1, 1);
        };
      })(this);
      countNotifi = calc();
      if (countNotifi < n) {
        vacantSpace -= this.friendshipNotifications.getPreloadMoreBtnHeigth();
        countNotifi = calc();
      }
      return countNotifi;
    };

    FriendshipNotificationsPopup.prototype.initSubwidgets = function() {
      var mainCounter;
      this.friendshipNotifications = chms.utils.Autoinit.init(blocks.FriendshipNotificationsList, this.el, (function(_this) {
        return function(e, cl) {
          return new cl(e, _this);
        };
      })(this))[0];
      this.whoToFollow = chms.utils.Autoinit.init(blocks.WhoToFollowList, this.el, (function(_this) {
        return function(e, cl) {
          return new cl(e, _this);
        };
      })(this))[0];
      mainCounter = new widgets.Counter(this.el.find("[main-counter]"), helpers.Application.roundToK);
      this.data.getFiltedStream(["readedGroups"]).onValue((function(_this) {
        return function(v) {
          if (v.value.indexOf("unreadFollowNotifications") !== -1 || v.value.indexOf("all") !== -1) {
            return mainCounter.setValue(0);
          }
        };
      })(this));
      this.dropdown.one("showed", (function(_this) {
        return function() {
          return _this.data.pushUniq("readedGroups", "unreadFollowNotifications");
        };
      })(this));
      mainCounter.setValue(this.userData.get("unreadFollowNotifications"));
      LoadRotator.appendToContainer(this.friendshipNotifications.list.loadControl, "small");
      return LoadRotator.appendToContainer(this.whoToFollow.list.loadControl, "small");
    };

    return FriendshipNotificationsPopup;

  })(AbstractPiece);

}).call(this);

/*
  Список данных который можно поволнять с сервера
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  blocks.ItemList = (function(superClass) {
    extend(ItemList, superClass);

    ItemList.prototype.DT = "blocks.ItemList";

    ItemList.STATE_LOADING = "loading";

    ItemList.STATE_IDLE = "idle";

    ItemList.STATE_RENDERING = "render";

    ItemList.STATE_NO_CONTENT = "empty";

    function ItemList(el) {
      this.el = el;
      this.canRenderItems = bind(this.canRenderItems, this);
      this.isSomeItemsNotRendered = bind(this.isSomeItemsNotRendered, this);
      this.isThereFullPackOfNotRendered = bind(this.isThereFullPackOfNotRendered, this);
      this.isServerHasItems = bind(this.isServerHasItems, this);
      this.drawState = bind(this.drawState, this);
      this.drawLoadControl = bind(this.drawLoadControl, this);
      this.drawItem = bind(this.drawItem, this);
      this.drawContent = bind(this.drawContent, this);
      this.drawEmptyState = bind(this.drawEmptyState, this);
      this.clearContent = bind(this.clearContent, this);
      this.preloadAndDraw = bind(this.preloadAndDraw, this);
      this.getTemplate = bind(this.getTemplate, this);
      this.getDefaultPerPage = bind(this.getDefaultPerPage, this);
      this.fetchDataFromServer = bind(this.fetchDataFromServer, this);
      this.pushNToRender = bind(this.pushNToRender, this);
      this.resetData = bind(this.resetData, this);
      this.initData = bind(this.initData, this);
      this.initStateMachine = bind(this.initStateMachine, this);
      ItemList.__super__.constructor.apply(this, arguments);
      this.xhrLocker = new chms.utils.Locker();
      this.renderLocker = new chms.utils.Locker();
      this.content = this.el.find("[item-list-content]");
      this.loadControl = this.el.find("[item-list-load]");
      this.initData();
      this.initStateMachine();
      this.data.getFiltedStream(["torender"]).onValue(this.drawContent);
      this.data.getFiltedStream(["notrendered", "state"]).onValue(this.drawLoadControl);
      this.data.getFiltedStream(["rendered", "state"]).onValue(this.drawState);
      this.data.getFiltedStream(["state"]).filter((function(_this) {
        return function() {
          return _this.data.get("state") === _this.s.STATE_NO_CONTENT && _this.data.get("rendered").length === 0;
        };
      })(this)).onValue(this.drawEmptyState);
      this.loadControl.click((function(_this) {
        return function() {
          return _this.preloadAndDraw();
        };
      })(this));
      this.drawLoadControl();
    }

    ItemList.prototype.initStateMachine = function() {
      $(this.xhrLocker).on(this.xhrLocker.s.EVENT_LOCK_CHANGED, (function(_this) {
        return function() {
          if (_this.xhrLocker.isLocked()) {
            return _this.data.set("state", _this.s.STATE_LOADING);
          } else {
            return _this.data.set("state", _this.s.STATE_IDLE);
          }
        };
      })(this));
      return $(this.renderLocker).on(this.renderLocker.s.EVENT_LOCK_CHANGED, (function(_this) {
        return function() {
          if (_this.renderLocker.isLocked()) {
            return _this.data.set("state", _this.s.STATE_RENDERING);
          } else {
            return _this.data.set("state", _this.s.STATE_IDLE);
          }
        };
      })(this));
    };

    ItemList.prototype.initData = function() {
      if (this.data == null) {
        this.data = new siteData.AbstractReactiveData();
      }
      this.data.set("torender", []);
      this.data.set("notrendered", []);
      this.data.set("rendered", []);
      this.data.set("state", this.s.STATE_IDLE);
      return this.data.set("renderTimeout", 0);
    };

    ItemList.prototype.resetData = function() {
      this.initData();
      return this.clearContent();
    };

    ItemList.prototype.pushNToRender = function(n) {
      var to;
      to = this.data.get("notrendered").slice(0, n);
      this.data.concat("torender", to);
      return this.data.set("notrendered", this.data.get("notrendered").slice(n, 2e308));
    };

    ItemList.prototype.fetchDataFromServer = function() {};

    ItemList.prototype.getDefaultPerPage = function() {};

    ItemList.prototype.getTemplate = function() {
      return void 0;
    };

    ItemList.prototype.preloadAndDraw = function(n, withoutFetching) {
      var l;
      if (withoutFetching == null) {
        withoutFetching = false;
      }
      if (n == null) {
        n = this.getDefaultPerPage();
      }
      if (this.xhrLocker.isLocked()) {
        return;
      }
      if ((withoutFetching && this.isSomeItemsNotRendered()) || (this.isSomeItemsNotRendered() && (this.isThereFullPackOfNotRendered(n) || !this.isServerHasItems()))) {
        return this.pushNToRender(n);
      } else if (!withoutFetching && this.isServerHasItems()) {
        l = this.data.getFiltedStream(["notrendered"]).onValue((function(_this) {
          return function() {
            l();
            return _.defer(function() {
              return _this.preloadAndDraw(n, true);
            });
          };
        })(this));
        return this.fetchDataFromServer();
      } else {
        return this.data.set("state", this.s.STATE_NO_CONTENT);
      }
    };

    ItemList.prototype.clearContent = function() {
      return this.content.html('');
    };

    ItemList.prototype.drawEmptyState = function() {
      return this.content.html(I18n.t('notifications_popup.empty'));
    };

    ItemList.prototype.drawContent = function() {
      var item, j, len, timeoutAcc, tor;
      tor = this.data.get("torender");
      if (!(tor.length > 0)) {
        return;
      }
      if (this.renderLocker.isLocked()) {
        this.renderLocker.safeExec(this.drawContent);
        return;
      }
      this.renderLocker.lock();
      timeoutAcc = 0;
      for (j = 0, len = tor.length; j < len; j++) {
        item = tor[j];
        if (this.data.get("renderTimeout") > 0) {
          setTimeout((function() {
            return this.o.content.append(this.o.drawItem(this.i));
          }).bind({
            o: this,
            i: item
          }), timeoutAcc);
          timeoutAcc += this.data.get("renderTimeout");
        } else {
          this.content.append(this.drawItem(item));
        }
      }
      this.data.set("torender", []);
      this.data.concat("rendered", tor);
      return setTimeout(this.renderLocker.unlock, timeoutAcc);
    };

    ItemList.prototype.drawItem = function(i) {
      var t;
      t = this.getTemplate();
      if (t) {
        return t(i);
      }
    };

    ItemList.prototype.drawLoadControl = function() {
      if (this.canRenderItems() && this.data.get("rendered").length > 0) {
        this.loadControl.removeClass("-hided");
      } else {
        this.loadControl.addClass("-hided");
      }
      if (this.data.get("state") === this.s.STATE_LOADING) {
        return this.loadControl.addClass("-loading");
      } else {
        return this.loadControl.removeClass("-loading");
      }
    };

    ItemList.prototype.drawState = function() {
      if (this.data.get("rendered").length === 0) {
        this.el.addClass("-empty");
      } else {
        this.el.removeClass("-empty");
      }
      this.el.removeClass("-loading -no-content");
      switch (this.data.get("state")) {
        case this.s.STATE_LOADING:
          return this.el.addClass("-loading");
        case this.s.STATE_NO_CONTENT:
          return this.el.addClass("-no-content");
      }
    };

    ItemList.prototype.isServerHasItems = function() {
      return true;
    };

    ItemList.prototype.isThereFullPackOfNotRendered = function(n) {
      return this.data.get("notrendered").length >= n;
    };

    ItemList.prototype.isSomeItemsNotRendered = function() {
      return this.data.get("notrendered").length > 0;
    };

    ItemList.prototype.canRenderItems = function() {
      return this.isSomeItemsNotRendered() || this.isServerHasItems();
    };

    return ItemList;

  })(AbstractPiece);

}).call(this);

/*
  Список предложений о фолловинге
 */

(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  blocks.WhoToFollowList = (function(superClass) {
    extend(WhoToFollowList, superClass);

    WhoToFollowList.ATTR_NAME = "block-who-to-follow-list";

    WhoToFollowList.prototype.DT = "blocks.WhoToFollowList";

    function WhoToFollowList(el1) {
      this.el = el1;
      WhoToFollowList.__super__.constructor.apply(this, arguments);
      this.provider = new dataProviders.ApiV2();
      this.subwItems = new blocks.ItemList(this.el);
      this.list = this.subwItems;
      this.subwItems.data.set("loadFinished", false);
      this.subwItems.data.set("renderedFriendsIds", []);
      this.subwItems.getDefaultPerPage = (function(_this) {
        return function() {
          return 20;
        };
      })(this);
      this.subwItems.getTemplate = (function(_this) {
        return function() {
          return JST["app/site/templates/object_media/object_media_notification_list/object_media_notification_list"];
        };
      })(this);
      this.subwItems.isServerHasItems = (function(_this) {
        return function() {
          return !_this.subwItems.data.get("loadFinished");
        };
      })(this);
      this.subwItems.fetchDataFromServer = (function(_this) {
        return function(completed) {
          var query, type;
          if (!_this.subwItems.isServerHasItems() || _this.subwItems.xhrLocker.isLocked()) {
            return false;
          } else {
            type = 'initial';
            if (_this.list.data.get("rendered").length > 0) {
              type = 'next';
            }
            return query = _this.provider.getFriendshipsByType([], type, 20, {
              beforeSend: function() {
                _this.subwItems.xhrLocker.lock();
                return LoadRotator.appendToContainterAndStart(_this.subwItems.content, "small");
              },
              success: function(e) {
                _this.subwItems.data.concat("notrendered", e.friends);
                return _this.subwItems.data.set("loadFinished", e.friends.length === 0);
              },
              error: ErrorMessages.internalServerError,
              complete: function() {
                _this.subwItems.xhrLocker.unlock();
                if (completed != null) {
                  completed();
                }
                return LoadRotator.removeFromContainer(_this.subwItems.content);
              }
            });
          }
        };
      })(this);
      this.subwItems.drawItem = (function(_this) {
        return function(i) {
          var el;
          _this.subwItems.data.push("renderedFriendsIds", i.id);
          el = $(_this.subwItems.getTemplate()({
            bgLink: Routes.channel_path(i.permalink),
            classes: "-medium-avatar",
            img: JST["app/site/templates/blocks/friendship_notifications/who_to_follow_img"](i),
            body: JST["app/site/templates/blocks/friendship_notifications/who_to_follow_body"](i)
          }));
          el.addClass("animate-swing-in__item");
          setTimeout((function() {
            return this.addClass("animate-swing-in__item-showed");
          }).bind(el), 25);
          chms.utils.Autoinit.init(widgets.WidgetFollowButtonInit, el);
          return el;
        };
      })(this);
    }

    return WhoToFollowList;

  })(AbstractPiece);

}).call(this);

/*
  Блок группы нотификейшна
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  blocks.NotificationsGroup = (function(superClass) {
    extend(NotificationsGroup, superClass);

    NotificationsGroup.ATTR_NAME = "block-notifications-group";

    NotificationsGroup.prototype.DT = "blocks.NotificationsGroup";

    function NotificationsGroup(el) {
      this.el = el;
      this.removeImportant = bind(this.removeImportant, this);
      NotificationsGroup.__super__.constructor.apply(this, arguments);
      console.log(this.DT, "Init");
      this.udata = new siteData.UserData();
      if (this.el.hasClass("important")) {
        setTimeout(this.removeImportant, 2000);
      }
    }

    NotificationsGroup.prototype.removeImportant = function() {
      return this.el.removeClass("important");
    };

    return NotificationsGroup;

  })(AbstractPiece);

}).call(this);

/*
  Попап для нотификейшнов.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  blocks.NotificationsPopup = (function() {
    NotificationsPopup.ATTR_NAME = 'block-notifications-popup';

    NotificationsPopup.ACTIONS = {
      UNMARK_NOTIFICATIONS: 'blocks.NotificationsPopup:Actions:UnmarkNotifications'
    };

    NotificationsPopup.EVENTS = {
      NOTIFICATION_READ: 'blocks.NotificationsPopup:Events:NotificationRead'
    };

    function NotificationsPopup(el) {
      this.hideLoader = bind(this.hideLoader, this);
      this.showLoader = bind(this.showLoader, this);
      this.unmarkNotifications = bind(this.unmarkNotifications, this);
      this.isAllPagesLoaded = bind(this.isAllPagesLoaded, this);
      this.preloadNextPage = bind(this.preloadNextPage, this);
      this.loadCurrentPage = bind(this.loadCurrentPage, this);
      this.preloadData = bind(this.preloadData, this);
      this.initNewCounter = bind(this.initNewCounter, this);
      this.$el = $(el);
      this.udata = new siteData.UserData();
      this.provider = new dataProviders.ApiV2();
      this.locker = new chms.utils.Locker(this.$el);
      this.isFirstPageLoaded = false;
      this.allPagesLoaded = false;
      this.currentPage = 1;
      this.content = $('.dropdown__content', this.$el);
      this.list = $('.list', this.content);
      $(document).on(Params.EVENT_PARTICULAR_PARAM_CHANGED('current_channel_id'), (function(_this) {
        return function() {
          _this.list.empty();
          _this.isFirstPageLoaded = false;
          _this.allPagesLoaded = false;
          return _this.currentPage = 1;
        };
      })(this));
      this.content.click(function(e) {
        return e.stopPropagation();
      });
      $('.dropdown', this.$el).dropdown().on('showed', (function(_this) {
        return function() {
          return _this.preloadData();
        };
      })(this));
      this.retryCounter = new functions.RetryCounter();
      this.initNewCounter();
    }

    NotificationsPopup.prototype.initNewCounter = function() {
      var e;
      if ((e = this.$el.find("[widget-counter]"))) {
        this.newCounter = new widgets.Counter(e, helpers.Application.roundToK);
        $('.dropdown', this.$el).on('showed', (function(_this) {
          return function() {
            return _this.newCounter.setValue(0);
          };
        })(this));
        return this.newCounter.setValue(this.udata.get("unreadCommonNotifications"));
      }
    };

    NotificationsPopup.prototype.preloadData = function() {
      return this.locker.safeExec((function(_this) {
        return function() {
          if (_this.isFirstPageLoaded) {
            return;
          }
          _this.locker.lock();
          return _this.loadCurrentPage(_this.currentPage);
        };
      })(this));
    };

    NotificationsPopup.prototype.loadCurrentPage = function(page) {
      var query;
      this.showLoader();
      return query = this.provider.getNotifications(page, this.provider.NOTIFICATION_TYPE_COUB, void 0, void 0, {
        success: (function(_this) {
          return function(r) {
            var $page, key;
            $page = _this.renderPage(r.notifications, _this.currentPage);
            _this.isAllPagesLoaded(r.total_pages);
            _this.hideLoader();
            if (page === 1) {
              _this.isFirstPageLoaded = true;
              $.post(Routes.notifications_viewed_api_v2_channels_path(), {
                type: _this.provider.NOTIFICATION_TYPE_COUB
              });
              key = _this.udata.getKeyForUnreadNotifications(Params.get("current_channel_id"), _this.udata.s.UNREAD_NOTIFICATION_KIND_COMMON);
              _this.udata.set(key, 0);
              _this.$el.on('hided', _this.unmarkNotifications);
              _this.initScroller();
            }
            _this.initNotificationPage($page);
            return _this.locker.unlock();
          };
        })(this),
        error: (function(_this) {
          return function() {
            var ntry;
            if (!(query != null) || query.statusText !== "abort") {
              _this.currentPage--;
              ntry = function() {
                _this.locker.unlock();
                return _this.preloadNextPage();
              };
              if (!_this.retryCounter.tryAgain(ntry)) {
                _this.hideLoader();
                return Growl.msg(I18n.growl_errors.reload.header, I18n.growl_errors.reload.error);
              }
            } else {
              return _this.locker.unlock();
            }
          };
        })(this)
      });
    };

    NotificationsPopup.prototype.preloadNextPage = function() {
      return this.locker.safeExec((function(_this) {
        return function() {
          if (!_this.allPagesLoaded) {
            _this.locker.lock();
            return _this.loadCurrentPage(_this.currentPage += 1);
          }
        };
      })(this));
    };

    NotificationsPopup.prototype.renderPage = function(notifications) {
      var $cp;
      $cp = $(JST['app/site/templates/blocks/notifications_dropdown/page'](notifications));
      this.list.append($cp);
      chms.utils.Autoinit.init(widgets.WidgetFollowButtonInit, $cp);
      return $cp;
    };

    NotificationsPopup.prototype.initNotificationPage = function($list) {
      blocks.UserListDropdownAbstract.constructIn(blocks.NotificationGroupDropdown, $list);
      return $list.filter('.important').each(function() {
        if (Params.getBranchValue("current_user.is_admin")) {
          return new blocks.NotificationsGroup($(this));
        } else {
          return $(this).on('mouseleave', function() {
            var $block;
            $block = $(this).off('mouseleave');
            if (!$block.hasClass('important')) {
              return;
            }
            $(this).removeClass('important');
            return $(document).trigger(blocks.NotificationsPopup.EVENTS.NOTIFICATION_READ);
          });
        }
      });
    };

    NotificationsPopup.prototype.initScroller = function() {
      return this.content.find('.list-wrap').nice_scroller().on('nice_scroll:at_the_end', this.preloadNextPage);
    };

    NotificationsPopup.prototype.isAllPagesLoaded = function(pagesCount) {
      if (this.currentPage === pagesCount || pagesCount === 0) {
        return this.allPagesLoaded = true;
      }
    };

    NotificationsPopup.prototype.unmarkNotifications = function() {
      $('[block-notifications-group]', this.content).removeClass('important');
      return $(document).trigger(blocks.NotificationsPopup.ACTIONS.UNMARK_NOTIFICATIONS);
    };

    NotificationsPopup.prototype.showLoader = function() {
      var $wrap;
      $wrap = this.list.parent();
      return LoadRotator.appendToContainterAndStart($wrap, "small " + (this.currentPage === 1 && '-abs' || '-center'));
    };

    NotificationsPopup.prototype.hideLoader = function() {
      var $wrap;
      $wrap = this.list.parent();
      return LoadRotator.removeFromContainer($wrap);
    };

    return NotificationsPopup;

  })();

}).call(this);
(function() {
  window.rawVideoAnnouncements = {};

  window.rawVideoAnnouncements.Block = (function() {
    Block.EVENT_ADDED = "rawVideoAnnouncements.Block:Added";

    Block.EVENT_DELETED = "rawVideoAnnouncements.Block:Deleted";

    function Block(el, page) {
      this.el = el;
      this.page = page;
      this.permalink = this.el.attr("data-channel-permalink");
      this.provider = new dataProviders.ApiV2();
      new rawVideoAnnouncements.AddAnnouncement(this.el, this);
      this.list = $(".list", this.el);
      this.provider.getRawVideoAnnoucements(this.permalink, {
        success: (function(_this) {
          return function(d) {
            var announce, i, len, ref;
            ref = d.announcements;
            for (i = 0, len = ref.length; i < len; i++) {
              announce = ref[i];
              _this.addAnnounce(announce, false);
            }
            _this.el.trigger(rawVideoAnnouncements.Block.EVENT_ADDED);
            if (!_this.list.hasClass('-no-scroller')) {
              return _this.list.nice_scroller();
            }
          };
        })(this),
        error: ErrorMessages.internalServerError
      });
    }

    Block.prototype.addAnnounce = function(json, trigger) {
      var announce;
      if (trigger == null) {
        trigger = true;
      }
      announce = new rawVideoAnnouncements.AnnouncementItem(json, this);
      this.list.prepend(announce.el);
      if (trigger) {
        return this.el.trigger(rawVideoAnnouncements.Block.EVENT_ADDED);
      }
    };

    Block.constructIn = function(container) {
      return container.find("[block-raw-video-announcements]").each(function() {
        return new rawVideoAnnouncements.Block($(this), container);
      });
    };

    return Block;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.rawVideoAnnouncements.AddAnnouncement = (function() {
    function AddAnnouncement(el, parent) {
      this.hideLoader = bind(this.hideLoader, this);
      this.showLoader = bind(this.showLoader, this);
      this.hideError = bind(this.hideError, this);
      this.showError = bind(this.showError, this);
      this.submit = bind(this.submit, this);
      this.cancel = bind(this.cancel, this);
      this.el = el;
      this.parent = parent;
      this.dropdown = $(".timeline-announcements-dropdown", this.el);
      this.form = $("form", this.el);
      this.urlInput = this.form.find("[name='videoUrl']");
      this.errorSub = this.form.find(".timeline-announcements-dropdown__sub");
      this.restorable = new RestorableForm(this.el.find("form").first());
      this.restorable.afterRestore = this.hideError;
      this.provider = new dataProviders.ApiV2();
      $(".sb.cancel", this.el).click(this.cancel);
      this.form.submit(this.submit);
      this.dropdown.on("beforeShowed", (function(_this) {
        return function() {
          return _this.dropdown.addClass("xMark");
        };
      })(this)).on("beforeHided", (function(_this) {
        return function() {
          return _this.dropdown.removeClass("xMark");
        };
      })(this));
    }

    AddAnnouncement.prototype.cancel = function() {
      this.dropdown.trigger("hide");
      return this.restorable.restore();
    };

    AddAnnouncement.prototype.submit = function(e) {
      var url;
      e.preventDefault();
      url = this.urlInput.val();
      if (url !== "") {
        this.hideError();
        this.showLoader();
        return this.provider.createRawVideoAnnouncement(url, {
          success: (function(_this) {
            return function(d) {
              _this.parent.addAnnounce(d);
              return _this.cancel();
            };
          })(this),
          error: this.showError,
          complete: this.hideLoader
        });
      } else {
        return this.showError();
      }
    };

    AddAnnouncement.prototype.showError = function() {
      return this.urlInput.add(this.errorSub).addClass("error");
    };

    AddAnnouncement.prototype.hideError = function() {
      return this.urlInput.add(this.errorSub).removeClass("error");
    };

    AddAnnouncement.prototype.showLoader = function() {
      return LoadRotator.appendWithOverlayAndStart(this.dropdown.find('.dropdown__inner'));
    };

    AddAnnouncement.prototype.hideLoader = function() {
      return LoadRotator.removeWithOverlay(this.dropdown.find('.dropdown__inner'));
    };

    AddAnnouncement.constructIn = function(container, parent) {
      return container.find("[block-raw-video-announcements]").each(function() {
        return new rawVideoAnnouncements.Block($(this), parent);
      });
    };

    return AddAnnouncement;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.rawVideoAnnouncements.AnnouncementItem = (function() {
    function AnnouncementItem(json, parent) {
      this.processing = bind(this.processing, this);
      this.onUrlClick = bind(this.onUrlClick, this);
      this.init = bind(this.init, this);
      this.parent = parent;
      this.rwaProvider = new RawVideoAnnouncementDataProvider();
      this.init(json);
    }

    AnnouncementItem.prototype.init = function(json) {
      var rendered, userChannelPerm;
      this.json = json;
      userChannelPerm = helpers.Channel.getSpecificParam({
        permalink: this.parent.permalink
      }, 'permalink');
      this.json.showHideButton = Params.get("is_logged_in") && userChannelPerm === this.parent.permalink;
      this.id = json.id;
      rendered = $(JST["app/site/templates/announcements/item"](this.json));
      if (this.el != null) {
        this.el.replaceWith(rendered);
      }
      this.el = rendered;
      this.deleteBtn = this.el.find(".timeline-announcements-item__controls .delete");
      this.deleteBtn.one('click', this.initDeleteDropDown.bind(this));
      if (this.json.status_url != null) {
        this.processing();
      }
      return this.el.find("a[embed-popup]").on("click", this.onUrlClick);
    };

    AnnouncementItem.prototype.onUrlClick = function(e) {
      var el, link;
      e.preventDefault();
      e.stopPropagation();
      el = $(e.currentTarget);
      link = el.attr("href");
      return OEmbedPopupHelper.show(link, "", el.attr("source"), el.attr('data-button-title'));
    };

    AnnouncementItem.prototype.processing = function() {
      var complete, d, events, p, st, stateChanged, update;
      d = this.rwaProvider.processing(this.json.status_url);
      events = this.rwaProvider.PROCESSING_EVENTS;
      p = this.el.find('.timeline-announcements-item__progress .tail');
      st = this.el.find('.timeline-announcements-item__progress [status]');
      stateChanged = (function(_this) {
        return function(d) {
          console.log("state changed", d);
          p.width("0%");
          return st.text(d.status);
        };
      })(this);
      update = (function(_this) {
        return function(d) {
          return p.width(d.percent + "%");
        };
      })(this);
      complete = (function(_this) {
        return function(d) {
          console.log("complete", d);
          return _this.init(d);
        };
      })(this);
      d.dispather.bind(events.STAGE_CHANGED + " " + events.COMPLETE + " " + events.UPDATE, (function(_this) {
        return function(e) {
          switch (e.type) {
            case events.STAGE_CHANGED:
              return stateChanged(e.resp);
            case events.UPDATE:
              return update(e.resp);
            default:
              return complete(e.resp);
          }
        };
      })(this));
      return d.start();
    };

    AnnouncementItem.prototype.initDeleteDropDown = function() {
      var $content, dropdown;
      $content = $(JST['app/site/templates/announcements/remove_dropdown'](this.json));
      $content.find('[delete-button]:first').click((function(_this) {
        return function() {
          LoadRotator.appendWithOverlayAndStart(dropdown.getContent());
          return new dataProviders.ApiV2().deleteRawVideoAnnouncement(_this.id, {
            success: function() {
              _this.el.detach();
              return _this.parent.el.trigger(rawVideoAnnouncements.Block.EVENT_DELETED);
            },
            error: ErrorMessages.internalServerError,
            complete: function() {
              LoadRotator.removeWithOverlay(dropdown.getContent());
              return dropdown.hide();
            }
          });
        };
      })(this));
      dropdown = new AbsoluteDropdown({
        el: this.el,
        handle: this.deleteBtn,
        dropdownPosition: AbsoluteDropdown.POSITION_TYPE.ABSOLUTE_BOTTOM
      });
      dropdown.setContent($content);
      return dropdown.show();
    };

    return AnnouncementItem;

  })();

}).call(this);

/*
  Search popup Model
  Плагин попапа поиска с саджестами и recent search

  Логика попапа
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.SearchAutocomplete = (function() {
    SearchAutocomplete.ATTR_NAME = 'widget-search-auto-complete';

    SearchAutocomplete.START_LETTERS_COUNT = 0;

    SearchAutocomplete.RECENT_SEARCH_LOG = 'ResentSearch:AddItem';

    function SearchAutocomplete(el) {
      this.navigateAutocomplete = bind(this.navigateAutocomplete, this);
      this.makeFirstActive = bind(this.makeFirstActive, this);
      this.goLocation = bind(this.goLocation, this);
      this.openSearchResult = bind(this.openSearchResult, this);
      this.onKey = bind(this.onKey, this);
      this.hideLoader = bind(this.hideLoader, this);
      this.showLoader = bind(this.showLoader, this);
      this.deleteFristActiveFromRecent = bind(this.deleteFristActiveFromRecent, this);
      this.hideRecentSearchPopup = bind(this.hideRecentSearchPopup, this);
      this.hideResultsPopup = bind(this.hideResultsPopup, this);
      this.getInputValue = bind(this.getInputValue, this);
      this.removeSearchLogItem = bind(this.removeSearchLogItem, this);
      this.removeSearchLog = bind(this.removeSearchLog, this);
      this.getSearchLog = bind(this.getSearchLog, this);
      var checkAndShow, logData;
      this.el = el;
      this.input = $('[data-input]', this.el);
      this.submit = $('.header-search__button', this.el);
      this.provider = new SearchPopupDataProvider();
      this.popup = new SearchDropdown(this.el);
      this.loader = new window.LoadRotator(this.containerLoader);
      this.locker = new chms.utils.Locker();
      this.isRecentAvailable = false;
      this.loaderClear = true;
      this.hasContent = false;
      this.el.on('show', (function(_this) {
        return function() {
          return _this.el.addClass('-visible-popup');
        };
      })(this));
      this.el.on('hide', (function(_this) {
        return function() {
          return _this.el.removeClass('-visible-popup');
        };
      })(this));
      logData = $.storage.get(window.SearchAutocomplete.RECENT_SEARCH_LOG);
      if ((logData != null) && GlobalState.USER.isLogedIn()) {
        $.storage.del(window.SearchAutocomplete.RECENT_SEARCH_LOG);
        this.provider.addRecentItem(logData);
      }
      if (GlobalState.USER.isLogedIn()) {
        this.getSearchLog();
      }
      this.popup.renderSearchResultsContainer();
      this.popup.searchResultsPopup.hide();
      this.makeFirstActive();
      this.input.on('input', (function(_this) {
        return function() {
          return _this.getInputValue(_this.input.val());
        };
      })(this));
      $('html, .notifications-friendship .dropdown__handler').on('click', (function(_this) {
        return function(e) {
          var t;
          t = $(e.target);
          if (t.closest('.search-popup').length === 0 && !t.is(_this.input) && !t.is(_this.submit)) {
            _this.popup.hidePopup();
            if (_this.isRecentAvailable) {
              return _this.deleteFristActiveFromRecent();
            }
          }
        };
      })(this));
      checkAndShow = (function(_this) {
        return function() {
          if (_this.isRecentAvailable) {
            return _this.popup.showPopup();
          } else if (_this.input.val() !== '') {
            if (!_this.hasContent) {
              _this.getInputValue(_this.input.val());
            }
            return _this.popup.showPopup();
          }
        };
      })(this);
      $((function(_this) {
        return function() {
          var _intervalId;
          return _intervalId = setInterval(function() {
            if (_this.input.is(':focus')) {
              clearInterval(_intervalId);
              return checkAndShow();
            }
          }, 500);
        };
      })(this));
      this.input.on('focus', (function(_this) {
        return function() {
          if (GlobalState.PAGE.isCoubPage()) {
            AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.HEADER.SEARCH_FOCUSED);
          }
          return checkAndShow();
        };
      })(this));
      this.input.on('keydown', this.onKey);
      this.submit.on('click', this.openSearchResult);
      this.popup.getContentEl().on('click', 'a', (function(_this) {
        return function(e) {
          var element;
          e.preventDefault();
          element = $(e.target).parents('li');
          return _this.goLocation(element);
        };
      })(this));
      this.el.on('submit', function(e) {
        return false;
      });
    }

    SearchAutocomplete.prototype.getSearchLog = function() {
      var loadSuccess;
      loadSuccess = (function(_this) {
        return function(n) {
          if (n.length) {
            _this.popup.renderRecentSearchContent(n);
            _this.removeSearchLog();
            _this.removeSearchLogItem();
            return _this.isRecentAvailable = true;
          }
        };
      })(this);
      return this.loadSearchLogQuery = this.provider.getSearchLog(loadSuccess);
    };

    SearchAutocomplete.prototype.removeSearchLog = function() {
      var loadSuccess;
      loadSuccess = (function(_this) {
        return function() {
          return _this.popup.recentSearchPopup.remove();
        };
      })(this);
      return this.popup.recentSearchPopup.find('[data-clear-recent]').on('click', (function(_this) {
        return function() {
          _this.provider.deleteAllRecentItems(loadSuccess);
          _this.isRecentAvailable = false;
          return _this.popup.hidePopup();
        };
      })(this));
    };

    SearchAutocomplete.prototype.removeSearchLogItem = function() {
      this.clear = true;
      return this.popup.recentSearchPopup.on('click', '[data-delete-item]', (function(_this) {
        return function(e) {
          var id, loadError, loadSuccess;
          if (_this.clear) {
            _this.clear = false;
            id = $(e.currentTarget).attr('data-item-id');
            loadSuccess = function(n) {
              _this.popup.deleteRecentSearchItem(id, n);
              if (_this.popup.recentSearchPopup.find('[data-delete-item]').length === 0) {
                _this.popup.recentSearchPopup.remove();
                _this.isRecentAvailable = false;
                _this.popup.hidePopup();
              }
              return _this.clear = true;
            };
            loadError = function() {
              ErrorMessages.internalServerError();
              return _this.clear = true;
            };
            return _this.provider.deleteRecentItem(id, loadSuccess, {}, loadError);
          }
        };
      })(this));
    };

    SearchAutocomplete.prototype.getInputValue = function(val) {
      var getData, p;
      if (p = helpers.Application.getCoubPermalinkFromUrl(val)) {
        $.ajax({
          url: "/coubs/" + p + ".json",
          type: "GET",
          success: (function(_this) {
            return function(json) {
              return _this.popup.showGotoCoub(json.title, Routes.view_coub_by_permalink_path(p));
            };
          })(this),
          error: (function(_this) {
            return function() {
              return _this.popup.hideGotoCoub();
            };
          })(this)
        });
      } else {
        this.popup.hideGotoCoub();
      }
      this.popup.updateLinkToAll(val);
      this.popup.getContentEl().find('[dropdown-search]').filter(':visible').find('li:first').addClass('selected');
      if (this.loadDataQuery != null) {
        this.loadDataQuery.abort();
        this.loadDataQuery = void 0;
        this.popup.searchResultsContainer.empty();
      }
      clearTimeout(this.multiQueuePrevent);
      if (this.loaderClear && val.length > window.SearchAutocomplete.START_LETTERS_COUNT) {
        if (this.popup.searchResultsPopup.not(':visible')) {
          this.hideRecentSearchPopup();
        }
        this.showLoader();
      }
      getData = (function(_this) {
        return function() {
          var loadError, loadSuccess, searchQuery;
          if (val && val.length > window.SearchAutocomplete.START_LETTERS_COUNT) {
            _this.hideRecentSearchPopup();
            searchQuery = encodeURIComponent(val);
            loadSuccess = function(n) {
              _this.hasContent = true;
              _this.hideLoader();
              _this.popup.renderSearchResults(n, val);
              _this.popup.getContentEl().find('li').removeClass('selected');
              return _this.popup.getContentEl().find('[dropdown-search]').filter(':visible').find('li:first').addClass('selected');
            };
            loadError = function(e) {
              if (e.statusText !== 'abort') {
                ErrorMessages.internalServerError();
                _this.hideLoader();
                _this.popup.renderSearchResults(false, val);
                return _this.popup.getContentEl().find('[dropdown-search]').filter(':visible').find('li:first').addClass('selected');
              }
            };
            return _this.loadDataQuery = _this.provider.getResults(searchQuery, loadSuccess, loadError);
          } else {
            _this.hideLoader();
            return _this.hideResultsPopup();
          }
        };
      })(this);
      return this.multiQueuePrevent = setTimeout(getData, 300);
    };

    SearchAutocomplete.prototype.hideResultsPopup = function() {
      this.popup.searchResultsPopup.hide();
      if (this.isRecentAvailable) {
        return this.popup.recentSearchPopup.show();
      } else {
        return this.popup.hidePopup();
      }
    };

    SearchAutocomplete.prototype.hideRecentSearchPopup = function() {
      if (this.isRecentAvailable) {
        this.popup.recentSearchPopup.hide();
        this.deleteFristActiveFromRecent();
      } else {
        this.popup.showPopup();
      }
      return this.popup.searchResultsPopup.show();
    };

    SearchAutocomplete.prototype.deleteFristActiveFromRecent = function() {
      return this.popup.recentSearchPopup.find('li:first').removeClass('selected');
    };

    SearchAutocomplete.prototype.showLoader = function() {
      this.loaderClear = false;
      return this.popup.toggleLoader(true);
    };

    SearchAutocomplete.prototype.hideLoader = function() {
      this.loaderClear = true;
      return this.popup.toggleLoader(false);
    };

    SearchAutocomplete.prototype.onKey = function(e) {
      var container;
      container = this.popup.getContentEl().find('[dropdown-search ]').filter(':visible');
      container.on('mouseenter', (function(_this) {
        return function() {
          return _this.locker.lock();
        };
      })(this));
      container.on('mouseleave', (function(_this) {
        return function() {
          return _this.locker.unlock();
        };
      })(this));
      switch (e.keyCode) {
        case $.ui.keyCode.UP:
        case $.ui.keyCode.DOWN:
          e.preventDefault();
          if (this.popup.getContentEl().is(':visible')) {
            if (e.keyCode === $.ui.keyCode.UP) {
              return this.navigateAutocomplete(-1, container);
            } else {
              return this.navigateAutocomplete(+1, container);
            }
          }
          break;
        case $.ui.keyCode.ESCAPE:
          this.popup.hidePopup();
          this.input.blur();
          return container.find('li:first').addClass('selected');
        case $.ui.keyCode.ENTER:
        case $.ui.keyCode.NUMPAD_ENTER:
          e.preventDefault();
          if (this.popup.getContentEl().is(':visible')) {
            return this.openSearchResult();
          }
      }
    };

    SearchAutocomplete.prototype.openSearchResult = function() {
      var container, selected;
      container = this.popup.getContentEl().find('[dropdown-search]').filter(':visible');
      selected = container.find('li').filter('.selected');
      if (selected.size() > 0) {
        return this.goLocation(selected);
      }
    };

    SearchAutocomplete.prototype.goLocation = function(element) {
      var search_result, type, value;
      if (GlobalState.PAGE.isCoubPage()) {
        AmplitudeCoub.track(AmplitudeCoub.COUB_PAGE.HEADER.SEARCH_OCCURED);
      }
      search_result = element.find('a').attr('href');
      type = element.attr('data-log-type');
      if (type !== 'search' && GlobalState.USER.isLogedIn()) {
        value = element.attr('data-log-value');
        value = window.utils.stripTags(value);
        $.storage.set(window.SearchAutocomplete.RECENT_SEARCH_LOG, {
          type: type,
          value: value
        });
      }
      Stats.track("search_popup_" + type + "_clicked");
      return window.location.href = search_result;
    };

    SearchAutocomplete.prototype.makeFirstActive = function() {
      this.popup.getContentEl().on('mouseenter', (function(_this) {
        return function() {
          var container;
          clearTimeout(_this.addSelectedTimer);
          container = _this.popup.getContentEl().find('[dropdown-search]').filter(':visible');
          if (container.find('li').size() > 1) {
            return container.find('li').filter('.selected').removeClass('selected');
          }
        };
      })(this));
      return this.popup.getContentEl().on('mouseleave', (function(_this) {
        return function() {
          var container;
          container = _this.popup.getContentEl().find('[dropdown-search]').filter(':visible');
          _this.addSelected = function() {
            return container.find('li').first().addClass('selected');
          };
          return _this.addSelectedTimer = setTimeout(_this.addSelected, 350);
        };
      })(this));
    };

    SearchAutocomplete.prototype.navigateAutocomplete = function(offset, container) {
      var elements, select, selected;
      elements = container.find('li');
      selected = elements.filter('.selected').first();
      select = (function(_this) {
        return function(el) {
          selected.removeClass('selected');
          return el.addClass('selected');
        };
      })(this);
      return this.locker.safeExec((function(_this) {
        return function() {
          var i;
          if (selected.size() > 0) {
            i = elements.index(selected) + offset;
            if (i >= 0 && i < elements.length) {
              return select($(elements[i]));
            } else {
              if (offset > 0) {
                return select(elements.first());
              } else {
                return select(elements.last());
              }
            }
          } else {
            if (offset > 0) {
              return select(elements.first());
            } else {
              return select(elements.last());
            }
          }
        };
      })(this));
    };

    return SearchAutocomplete;

  })();

}).call(this);

/*
  Search popup View

  Это класс, в котором находится все, что касается контента попапа поиска
  с автокомплитом, вся логика находится в SearchAutocomplete.
  Здесь создание и рендер темплейтов, показываем и скрываем попапы.
 */

(function() {
  window.SearchDropdown = (function() {
    function SearchDropdown($el) {
      this.el = $el;
      this.dd = $el.dropdown();
      this.inner = $('.dropdown__inner', $el);
      this.content = $('.dropdown__content', this.inner);
      this.loader = $('.search-popup__loader', this.content);
      LoadRotator.appendToContainterAndStart(this.loader, 'small -abs');
    }

    SearchDropdown.prototype.getContentEl = function() {
      return this.content;
    };

    SearchDropdown.prototype.renderRecentSearchContent = function(content) {
      this.recentSearchPopup = $(JST["app/site/templates/widgets/search_popup/recent_search"](content));
      return this.content.append(this.recentSearchPopup);
    };

    SearchDropdown.prototype.deleteRecentSearchItem = function(id, content) {
      var newItem;
      this.recentSearchPopup.find("li[data-item-id='" + id + "']").remove();
      if (!$.isEmptyObject(content)) {
        newItem = $(JST["app/site/templates/widgets/search_popup/recent_search_item"](content));
        return this.recentSearchPopup.find('.search-popup__recent__list').append(newItem);
      }
    };

    SearchDropdown.prototype.updateLinkToAll = function(query) {
      var href, result;
      result = window.utils.stripTags(query);
      href = Routes.search_path({
        q: query
      });
      this.searchResultsPopup.find('[data-more-results]').attr('href', href);
      return this.searchResultsPopup.find('[data-more-results]').find('strong').html(result).attr('title', result);
    };

    SearchDropdown.prototype.hideGotoCoub = function() {
      return this.searchResultsPopup.find('[data-goto-coub]').addClass('-hidden');
    };

    SearchDropdown.prototype.showGotoCoub = function(title, href) {
      var el;
      el = this.searchResultsPopup.find('[data-goto-coub]');
      return el.removeClass('-hidden').attr('href', href).find('strong').html(title);
    };

    SearchDropdown.prototype.renderSearchResultsContainer = function() {
      this.searchResultsPopup = $(JST["app/site/templates/widgets/search_popup/search_results"]());
      this.content.append(this.searchResultsPopup);
      return this.searchResultsContainer = this.searchResultsPopup.find('.search-popup__result__list');
    };

    SearchDropdown.prototype.renderSearchResults = function(data, query) {
      var channels, tags;
      if (data) {
        this.searchResultsContainer.html('');
        channels = data.channels;
        tags = data.tags;
        this.searchTag = $(JST["app/site/templates/widgets/search_popup/search_tag"](tags));
        this.searchChannel = $(JST["app/site/templates/widgets/search_popup/search_channel"](channels));
        this.searchResultsContainer.append(this.searchTag);
        return this.searchResultsContainer.append(this.searchChannel);
      }
    };

    SearchDropdown.prototype.showPopup = function() {
      this.dd.dropdown('show');
      this.el.trigger('show');
      return Stats.track("search_popup_opened");
    };

    SearchDropdown.prototype.hidePopup = function() {
      this.dd.dropdown('hide');
      return this.el.trigger('hide');
    };

    SearchDropdown.prototype.toggleLoader = function(val) {
      return this.loader.toggleClass('-hidden', !val);
    };

    return SearchDropdown;

  })();

}).call(this);
(function() {
  blocks.StoriesBlock = (function() {
    StoriesBlock.ATTR_NAME = 'blocks-stories-block';

    StoriesBlock.prototype.ACTION_REINIT = 'StoriesBlock:Action:Reinit';

    function StoriesBlock(el1) {
      var cards;
      this.el = el1;
      this.container = $('.stories-block__container', this.el);
      this.url = this.el.attr('data-url');
      this.template = this.el.attr('data-card-class') === '-small' ? 'app/site/templates/story/story_card_small' : 'app/site/templates/story/story_card';
      if ((cards = $('.story-card', this.el)).length) {
        this.show();
        cards.each((function(_this) {
          return function(i, el) {
            var data, story;
            data = JSON.parse($('> script', el).text());
            story = $(JST[_this.template](data));
            return $(el).replaceWith(story);
          };
        })(this));
      } else if (this.url) {
        this.loadStories();
      } else {
        throw "Not enough data to render stories block";
      }
      this.el.on(this.ACTION_REINIT, (function(_this) {
        return function(e) {
          return _this.loadStories();
        };
      })(this));
    }

    StoriesBlock.prototype.loadStories = function() {
      return $.get(this.url).done((function(_this) {
        return function(r) {
          return _this.render(r.stories);
        };
      })(this)).fail(console.error);
    };

    StoriesBlock.prototype.render = function(stories) {
      var card, j, len, list, s;
      this.container.empty();
      if (stories.length > 0) {
        this.show();
      }
      for (j = 0, len = stories.length; j < len; j++) {
        s = stories[j];
        card = $(JST[this.template](s));
        this.container.append(card);
        new widgets.StoryCard(card);
      }
      if (!GlobalState.PLATFORM.isMobile() && (list = $('.coubs-list')).length) {
        return list.triggerHandler(clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_CONTENTS);
      }
    };

    StoriesBlock.prototype.show = function() {
      return this.el.removeClass('-hidden');
    };

    return StoriesBlock;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.TagsBlock = (function() {
    TagsBlock.ACTION_UPDATE_LAYOUT = 'TagsBlock:Actions:UpdateLayout';

    function TagsBlock(opts) {
      this.updateLayout = bind(this.updateLayout, this);
      this.el = opts.el;
      this.wrap = this.el.find('.tags-wrap');
      this.tags = this.wrap.find('a');
      this.cropper = this.getTagsCropper();
      this.uncropper = this.getTagsUncroppper();
      this.index = null;
      if (opts.coubBlock) {
        opts.coubBlock.on(TagsBlock.ACTION_UPDATE_LAYOUT, this.updateLayout);
      }
      this.updateLayout();
      this.cropper.on("click", this.crop.bind(this, true));
      this.uncropper.on("click", this.crop.bind(this, false));
      this.el.on('dom_remove', (function(_this) {
        return function() {
          return opts.coubBlock.off(TagsBlock.ACTION_UPDATE_LAYOUT, _this.updateLayout);
        };
      })(this));
    }

    TagsBlock.prototype.crop = function(expand) {
      if (expand == null) {
        expand = true;
      }
      this.el.toggleClass('-cropped', !expand);
      return this.tags.filter((function(_this) {
        return function(num, el) {
          return num >= _this.index;
        };
      })(this)).toggleClass('-hidden', !expand);
    };

    TagsBlock.prototype.updateLayout = function() {
      var currentLineOffset, i, j, len, lines, maxLines, ref, tag, tagOffset;
      maxLines = 1;
      currentLineOffset = this.tags.first().offset();
      lines = 1;
      ref = this.tags;
      for (i = j = 0, len = ref.length; j < len; i = ++j) {
        tag = ref[i];
        tagOffset = $(tag).offset();
        if (lines === maxLines && tagOffset.top > currentLineOffset.top) {
          this.index = this.wrap.offset().left + this.wrap.width() > $(this.tags[i - 1]).offset().left + $(this.tags[i - 1]).outerWidth() + 34 + 5 ? i : i - 1;
          break;
        } else if (tagOffset.top > currentLineOffset.top) {
          lines++;
          currentLineOffset = tagOffset;
        }
      }
      if (!this.index) {
        return;
      }
      this.el.addClass("-cropped");
      this.tags.eq(this.index).before(this.cropper);
      this.tags.last().after(this.uncropper);
      return this.tags.filter((function(_this) {
        return function(num, el) {
          return num >= _this.index;
        };
      })(this)).addClass('-hidden');
    };

    TagsBlock.prototype.getTagsCropper = function() {
      return $("<button />", {
        html: '&rarr;',
        type: "button",
        "class": "sb tags-cropper coub__tags-tag"
      });
    };

    TagsBlock.prototype.getTagsUncroppper = function() {
      return $("<button />", {
        html: '&larr;',
        type: "button",
        "class": "sb tags-uncropper coub__tags-tag"
      });
    };

    TagsBlock.construct = function(coubBlock) {
      var el;
      if ((el = $('.coub__tags.-with-cropper', coubBlock)).length) {
        return new TagsBlock({
          el: el,
          coubBlock: coubBlock
        });
      }
    };

    return TagsBlock;

  })();

}).call(this);

/*
  Дропдаун в котором выводится список юзеров.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  blocks.UserListDropdownAbstract = (function(superClass) {
    extend(UserListDropdownAbstract, superClass);

    UserListDropdownAbstract.prototype.INITIAL_PAGE = 1;

    function UserListDropdownAbstract() {
      this.hideLoader = bind(this.hideLoader, this);
      this.showLoader = bind(this.showLoader, this);
      this.getData = bind(this.getData, this);
      this.getProvider = bind(this.getProvider, this);
      this.initScroller = bind(this.initScroller, this);
      this.getWrapper = bind(this.getWrapper, this);
      this.renderPage = bind(this.renderPage, this);
      this.loadNextPage = bind(this.loadNextPage, this);
      this.loadPage = bind(this.loadPage, this);
      this.preloadData = bind(this.preloadData, this);
      UserListDropdownAbstract.__super__.constructor.apply(this, arguments);
      this.isFirstPageLoaded = false;
      this.allPagesLoaded = false;
      this.currentPage = 1;
      this.totalPages = void 0;
      this.locker = new chms.utils.Locker();
      this.retryCounter = new functions.RetryCounter();
    }

    UserListDropdownAbstract.prototype.preloadData = function() {
      return this.locker.safeExec((function(_this) {
        return function() {
          if (_this.isFirstPageLoaded) {
            return;
          }
          _this.locker.lock();
          _this.dropdown.setContent(_this.getWrapper());
          _this.dropdownWrap = $('.list-wrap', _this.dropdown.t);
          _this.dropdownList = $('.list', _this.dropdownWrap);
          _this.dropdown.position();
          return _this.loadPage(_this.currentPage);
        };
      })(this));
    };

    UserListDropdownAbstract.prototype.loadPage = function(page) {
      var query, xhrLogic;
      this.showLoader();
      query = void 0;
      xhrLogic = {
        success: (function(_this) {
          return function(resp) {
            _this.hideLoader();
            _this.retryCounter.loadSuccess();
            _this.renderPage(resp);
            if (parseInt(resp.page) === _this.INITIAL_PAGE) {
              _this.isFirstPageLoaded = true;
              _this.totalPages = resp.total_pages;
              _this.initScroller();
            }
            if (parseInt(resp.page) === _this.totalPages) {
              _this.allPagesLoaded = true;
            }
            return _this.locker.unlock();
          };
        })(this),
        error: (function(_this) {
          return function() {
            var ntry;
            if (!(query != null) || query.statusText !== "abort") {
              ntry = function() {
                _this.locker.unlock();
                return _this.loadPage(_this.currentPage);
              };
              if (!_this.retryCounter.tryAgain(ntry)) {
                _this.hideLoader();
                return Growl.msg(I18n.growl_errors.reload.header, I18n.growl_errors.reload.error);
              }
            } else {
              return _this.locker.unlock();
            }
          };
        })(this)
      };
      return query = this.getProvider().apply(this, this.getData().concat([page, xhrLogic]));
    };

    UserListDropdownAbstract.prototype.loadNextPage = function() {
      if (!this.allPagesLoaded) {
        return this.locker.safeExec((function(_this) {
          return function() {
            _this.locker.lock();
            return _this.loadPage(++_this.currentPage);
          };
        })(this));
      }
    };

    UserListDropdownAbstract.prototype.renderPage = function(response) {
      var $item, channel, i, isSmallFollow, len, ref, results;
      isSmallFollow = this.el.attr('data-small-follow');
      ref = response.channels;
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        channel = ref[i];
        $item = $(JST["app/site/templates/blocks/channels_in_list_dropdown/channel_in_list_dropdown"]({
          channel: channel,
          isSmallFollow: isSmallFollow
        }));
        this.dropdownList.append($item);
        results.push(chms.utils.Autoinit.init(widgets.WidgetFollowButtonInit, $item));
      }
      return results;
    };

    UserListDropdownAbstract.prototype.getWrapper = function() {
      return $(JST["app/site/templates/blocks/channels_in_list_dropdown/channels_in_list_dropdown"]());
    };

    UserListDropdownAbstract.prototype.initScroller = function() {
      this.dropdownWrap.nice_scroller().on("nice_scroll:at_the_end", this.loadNextPage);
      return this.dropdownWrap = this.dropdownWrap.data('controllers').nice_scroller.getScrollContainer();
    };

    UserListDropdownAbstract.prototype.getProvider = function() {
      throw "blocks.UserListDropdownAbstract: Implement getProvider method";
    };

    UserListDropdownAbstract.prototype.getData = function() {
      throw "blocks.UserListDropdownAbstract: Implement getProvider method";
    };

    UserListDropdownAbstract.prototype.showLoader = function() {
      return LoadRotator.appendToContainterAndStart(this.dropdownWrap, "small " + (this.currentPage === 1 && '-abs' || '-center'));
    };

    UserListDropdownAbstract.prototype.hideLoader = function() {
      return LoadRotator.removeFromContainer(this.dropdownWrap);
    };

    UserListDropdownAbstract.constructIn = function(dcl, container, isMouseOver) {
      var init;
      if (isMouseOver == null) {
        isMouseOver = false;
      }
      init = function(el, cl) {
        if (isMouseOver) {
          return new cl({
            el: el,
            handleEventOpen: "mouseenter",
            handleEventClose: HoverableAbsoluteDropdown.EVENTS.MOUSEOUT_TIMEOUT,
            dropdownClass: HoverableAbsoluteDropdown,
            dropdownPosition: AbsoluteDropdown.POSITION_TYPE.ABSOLUTE_BOTTOM
          });
        } else {
          return new cl({
            el: el
          });
        }
      };
      return chms.utils.Autoinit.init(dcl, container, init);
    };

    return UserListDropdownAbstract;

  })(PreloadableAbsDropdown);

}).call(this);

/*
  Дропдаун со списком фолловеров канала.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  blocks.FollowersListDropdown = (function(superClass) {
    extend(FollowersListDropdown, superClass);

    function FollowersListDropdown() {
      this.getData = bind(this.getData, this);
      this.getProvider = bind(this.getProvider, this);
      return FollowersListDropdown.__super__.constructor.apply(this, arguments);
    }

    FollowersListDropdown.ATTR_NAME = "block-followers-list-dropdown";

    FollowersListDropdown.prototype.getProvider = function() {
      return new dataProviders.ApiV2().getFollowersList;
    };

    FollowersListDropdown.prototype.getData = function() {
      return [this.el.attr("data-id")];
    };

    return FollowersListDropdown;

  })(blocks.UserListDropdownAbstract);

}).call(this);

/*
  Дропдаун со списком каналов, которые фолловит канал.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  blocks.FollowingListDropdown = (function(superClass) {
    extend(FollowingListDropdown, superClass);

    function FollowingListDropdown() {
      this.getData = bind(this.getData, this);
      this.getProvider = bind(this.getProvider, this);
      return FollowingListDropdown.__super__.constructor.apply(this, arguments);
    }

    FollowingListDropdown.ATTR_NAME = "block-following-list-dropdown";

    FollowingListDropdown.prototype.getProvider = function() {
      return new dataProviders.ApiV2().getFollowingList;
    };

    FollowingListDropdown.prototype.getData = function() {
      return [this.el.attr("data-id")];
    };

    return FollowingListDropdown;

  })(blocks.UserListDropdownAbstract);

}).call(this);

/*
  Дропдаун со списком лайков для коба.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  blocks.LikesListDropdown = (function(superClass) {
    extend(LikesListDropdown, superClass);

    function LikesListDropdown() {
      this.getData = bind(this.getData, this);
      this.getProvider = bind(this.getProvider, this);
      return LikesListDropdown.__super__.constructor.apply(this, arguments);
    }

    LikesListDropdown.ATTR_NAME = "block-likes-list-dropdown";

    LikesListDropdown.prototype.getProvider = function() {
      return new dataProviders.ApiV2().getLikesForCoub;
    };

    LikesListDropdown.prototype.getData = function() {
      return [this.el.attr("data-id")];
    };

    return LikesListDropdown;

  })(blocks.UserListDropdownAbstract);

}).call(this);

/*
  Дропдаун со списком лайков для коба.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  blocks.LikesStoryListDropdown = (function(superClass) {
    extend(LikesStoryListDropdown, superClass);

    function LikesStoryListDropdown() {
      this.getData = bind(this.getData, this);
      this.getProvider = bind(this.getProvider, this);
      return LikesStoryListDropdown.__super__.constructor.apply(this, arguments);
    }

    LikesStoryListDropdown.ATTR_NAME = "block-likes-story-list-dropdown";

    LikesStoryListDropdown.prototype.getProvider = function() {
      return new dataProviders.ApiV2().getLikesForStory;
    };

    LikesStoryListDropdown.prototype.getData = function() {
      return [this.el.attr("data-id")];
    };

    return LikesStoryListDropdown;

  })(blocks.UserListDropdownAbstract);

}).call(this);

/*
  Дропдаун с каналами юзера (для кнопки фолловинга)
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  blocks.MyChannelsListDropdown = (function(superClass) {
    extend(MyChannelsListDropdown, superClass);

    MyChannelsListDropdown.prototype.dropdown_class_names = 'dropdown--to-modal dropdown--follow';

    function MyChannelsListDropdown(opts) {
      if (opts == null) {
        opts = {};
      }
      this.unfollowListener = bind(this.unfollowListener, this);
      this.followListener = bind(this.followListener, this);
      this.getList = bind(this.getList, this);
      this.getWrapper = bind(this.getWrapper, this);
      this.renderPage = bind(this.renderPage, this);
      this.loadChannelsList = bind(this.loadChannelsList, this);
      this.preloadData = bind(this.preloadData, this);
      if (opts.dropdownCssClass != null) {
        this.dropdown_class_names += " " + opts.dropdownCssClass;
      }
      MyChannelsListDropdown.__super__.constructor.apply(this, arguments);
      this.channelsLoaded = false;
      this.channelId = opts.channelId;
      this.userChannels = opts.userChannels;
      this.followedFrom = opts.followedFrom;
      this.isFollowsPredefined = opts.isFollowsPredefined;
      this.followInstance = opts.followInstance;
      this.dropdownWrap = this.getWrapper();
      this.dropdown.setContent(this.dropdownWrap);
      if (this.isFollowsPredefined) {
        $(document).on(widgets.FollowButton.EVENTS.FOLLOWED, this.followListener);
        $(document).on(widgets.FollowButton.EVENTS.UNFOLLOWED, this.unfollowListener);
      }
      this.el.on('showed', (function(_this) {
        return function() {
          return _this.currentFollows = _.keys(_this.followInstance.followedFrom);
        };
      })(this));
      this.el.on('hided', (function(_this) {
        return function() {
          if (!_.isEqual(_this.currentFollows, _.keys(_this.followInstance.followedFrom))) {
            return _this.followInstance.triggerCompleted();
          }
        };
      })(this));
      this.el.on('beforeShow', (function(_this) {
        return function() {
          if (_this.channelsLoaded) {
            return _this.sortChannels();
          }
        };
      })(this));
      this.el.on('dom_remove', (function(_this) {
        return function() {
          $(document).off(widgets.FollowButton.EVENTS.FOLLOWED, _this.followListener);
          return $(document).off(widgets.FollowButton.EVENTS.UNFOLLOWED, _this.unfollowListener);
        };
      })(this));
    }

    MyChannelsListDropdown.prototype.preloadData = function() {
      if (this.channelsLoaded) {
        return;
      }
      if (this.isFollowsPredefined) {
        this.renderPage(_.keys(this.followedFrom).map(parseFloat));
        this.channelsLoaded = true;
        $(document).off(widgets.FollowButton.EVENTS.FOLLOWED, this.followListener);
        return $(document).off(widgets.FollowButton.EVENTS.UNFOLLOWED, this.unfollowListener);
      } else {
        this.showLoader();
        return this.loadChannelsList();
      }
    };

    MyChannelsListDropdown.prototype.loadChannelsList = function() {
      var loadSuccess;
      loadSuccess = (function(_this) {
        return function(resp) {};
      })(this);
      return $.get(Routes.api_v2_channel_path(this.channelId)).done((function(_this) {
        return function(resp) {
          _this.followInstance.updateFollows(resp.follows_by_users_channels);
          _this.renderPage(resp.follows_by_users_channels);
          return _this.channelsLoaded = true;
        };
      })(this)).fail(ErrorMessages.internalServerError);
    };

    MyChannelsListDropdown.prototype.renderPage = function(channelIds) {
      var content;
      this.hideLoader();
      content = JST['app/site/templates/widgets/follow_button/followers_list_dropdown']({
        channelId: this.channelId,
        channels: this.userChannels,
        followedFrom: channelIds
      });
      this.getList().append(content);
      this.initScroller();
      chms.utils.Autoinit.init(widgets.FollowButton, this.getList());
      Stats.track('follow_dropdown_opened');
      $('li', this.getList()).on(widgets.FollowButton.EVENTS.ELEMENT.FOLLOWED, function() {
        return Stats.track('follow_dropdown_clicked');
      });
      return this.sortChannels();
    };

    MyChannelsListDropdown.prototype.getWrapper = function() {
      return $(JST["app/site/templates/widgets/follow_button/followers_absolute_dropdown"]());
    };

    MyChannelsListDropdown.prototype.getList = function() {
      return this.dropdownWrap;
    };

    MyChannelsListDropdown.prototype.initScroller = function() {
      return this.getList().nice_scroller();
    };

    MyChannelsListDropdown.prototype.showLoader = function() {
      return LoadRotator.appendToContainterAndStart(this.dropdownWrap, 'small -abs');
    };

    MyChannelsListDropdown.prototype.hideLoader = function() {
      return LoadRotator.removeFromContainer(this.dropdownWrap);
    };

    MyChannelsListDropdown.prototype.followListener = function(e) {
      if (e.targetId === this.channelId) {
        return this.followedFrom[e.performerId] = void 0;
      }
    };

    MyChannelsListDropdown.prototype.unfollowListener = function(e) {
      if (e.targetId === this.channelId) {
        return delete this.followedFrom[e.performerId];
      }
    };

    MyChannelsListDropdown.prototype.sortChannels = function() {
      var $items, $list, followedFrom, getOrder;
      followedFrom = _.keys(this.followInstance.followedFrom);
      $list = $('ul', this.getList());
      $items = $list.children();
      getOrder = function($el) {
        return $el.data('sort') - ($el.hasClass('-on') ? 1000 : 0);
      };
      $items.sort(function(a, b) {
        if (getOrder($(a)) > getOrder($(b))) {
          return 1;
        } else {
          return -1;
        }
      });
      return $items.detach().appendTo($list);
    };

    return MyChannelsListDropdown;

  })(PreloadableAbsDropdown);

}).call(this);

/*
  Дропдаун группы нотификейшно

  У элемента контейнера должен быть аттрибут kind который
  указывает на тип дропдауна. Kind должен быть одним из
  blocks.NotificationGroupDropdown.KIND
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  blocks.NotificationGroupDropdown = (function(superClass) {
    extend(NotificationGroupDropdown, superClass);

    function NotificationGroupDropdown() {
      this.getKind = bind(this.getKind, this);
      this.getData = bind(this.getData, this);
      this.getProvider = bind(this.getProvider, this);
      return NotificationGroupDropdown.__super__.constructor.apply(this, arguments);
    }

    NotificationGroupDropdown.ATTR_NAME = "blocks-notification-group-dropdown";

    NotificationGroupDropdown.KIND = {
      LIKE: "like",
      RECOUB: "recoub",
      FOLLOW: "follow"
    };

    NotificationGroupDropdown.prototype.getProvider = function() {
      var p;
      p = new dataProviders.ApiV2();
      switch (this.getKind()) {
        case blocks.NotificationGroupDropdown.KIND.LIKE:
          return p.getNotificationsLikeDropdown;
        case blocks.NotificationGroupDropdown.KIND.RECOUB:
          return p.getNotificationsRecoubDropdown;
        default:
          return p.getNotificationsFollowDropdown;
      }
    };

    NotificationGroupDropdown.prototype.getData = function() {
      return [this.el.attr("data-id"), this.el.attr("data-ids").split(',')];
    };

    NotificationGroupDropdown.prototype.getKind = function() {
      var v;
      if ((v = this.el.attr("kind")) == null) {
        throw 'blocks.NotificationGroupDropdown: element doesnt have attribute "kind"';
      }
      return v;
    };

    return NotificationGroupDropdown;

  })(blocks.UserListDropdownAbstract);

}).call(this);

/*
  Дропдаун со списком рекобов для коба.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  blocks.RecoubsListDropdown = (function(superClass) {
    extend(RecoubsListDropdown, superClass);

    function RecoubsListDropdown() {
      this.getData = bind(this.getData, this);
      this.getProvider = bind(this.getProvider, this);
      return RecoubsListDropdown.__super__.constructor.apply(this, arguments);
    }

    RecoubsListDropdown.ATTR_NAME = "block-recoubs-list-dropdown";

    RecoubsListDropdown.prototype.afterInit = function() {
      return console.log("INIT RECOUBS LIST DROPDOWN");
    };

    RecoubsListDropdown.prototype.getProvider = function() {
      return new dataProviders.ApiV2().getRecoubsForCoub;
    };

    RecoubsListDropdown.prototype.getData = function() {
      return [$(this.el).attr("data-id")];
    };

    return RecoubsListDropdown;

  })(blocks.LikesListDropdown);

}).call(this);

/*
  Дропдаун со списком рекобов (ремиксов) для коба.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  blocks.RemixesListDropdown = (function(superClass) {
    extend(RemixesListDropdown, superClass);

    function RemixesListDropdown() {
      this.getWrapper = bind(this.getWrapper, this);
      this.renderPage = bind(this.renderPage, this);
      this.getData = bind(this.getData, this);
      this.getProvider = bind(this.getProvider, this);
      return RemixesListDropdown.__super__.constructor.apply(this, arguments);
    }

    RemixesListDropdown.ATTR_NAME = "block-remixes-list-dropdown";

    RemixesListDropdown.prototype.afterInit = function() {
      return console.log("INIT REMIXES LIST DROPDOWN");
    };

    RemixesListDropdown.prototype.getProvider = function() {
      return new dataProviders.ApiV2().getRemixesForCoub;
    };

    RemixesListDropdown.prototype.getData = function() {
      return [$(this.el).attr("data-id")];
    };

    RemixesListDropdown.prototype.renderPage = function(response) {
      var c, i, item, len, ref, results;
      ref = response.coubs;
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        c = ref[i];
        item = JST['app/site/templates/media_block/recoub_block']({
          json: c
        });
        results.push(this.dropdownList.append(item));
      }
      return results;
    };

    RemixesListDropdown.prototype.getWrapper = function() {
      return $(JST["app/site/templates/blocks/recoubs_in_list_dropdown/recoubs_in_list_dropdown"]());
    };

    return RemixesListDropdown;

  })(blocks.UserListDropdownAbstract);

}).call(this);

/*
  Дропдаун со списком репостов для стори.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  blocks.RepostsStoryListDropdown = (function(superClass) {
    extend(RepostsStoryListDropdown, superClass);

    function RepostsStoryListDropdown() {
      this.getData = bind(this.getData, this);
      this.getProvider = bind(this.getProvider, this);
      return RepostsStoryListDropdown.__super__.constructor.apply(this, arguments);
    }

    RepostsStoryListDropdown.ATTR_NAME = "block-reposts-story-list-dropdown";

    RepostsStoryListDropdown.prototype.afterInit = function() {
      return console.log("INIT REPOSTS STORY LIST DROPDOWN");
    };

    RepostsStoryListDropdown.prototype.getProvider = function() {
      return new dataProviders.ApiV2().getRepostsForStory;
    };

    RepostsStoryListDropdown.prototype.getData = function() {
      return [$(this.el).attr("data-id")];
    };

    return RepostsStoryListDropdown;

  })(blocks.LikesStoryListDropdown);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  functions.AmplitudeLocationTracker = (function() {
    function AmplitudeLocationTracker(doTrack) {
      var page;
      if (doTrack == null) {
        doTrack = true;
      }
      this.equal = bind(this.equal, this);
      this.contains = bind(this.contains, this);
      this.getPage = bind(this.getPage, this);
      if (doTrack) {
        page = this.getPage();
        if (page) {
          this.track(page);
        }
      }
    }

    AmplitudeLocationTracker.prototype.getPage = function() {
      var cu, pc;
      this.path = window.location.pathname || '';
      if (this.equal("/")) {
        return "mainPage";
      } else if (this.equal("/feed")) {
        return "timeline";
      } else if (GlobalState.PAGE.isFeaturedPage()) {
        return "featured";
      } else if (GlobalState.PAGE.isHotPage()) {
        return "hot";
      } else if (this.equal("/channels")) {
        return "channels";
      } else if (GlobalState.PAGE.isWeekly()) {
        return "weekly";
      } else if (GlobalState.PAGE.isProfile()) {
        cu = Params.getBranchValue("current_user");
        pc = Params.getBranchValue("profile_channel");
        if (cu && pc && cu.id === pc.user_id) {
          return "channelOwn";
        } else {
          return "channel";
        }
      } else if (this.equal("/search")) {
        return "search";
      } else if (this.contains("/search/channels")) {
        return "searchChannels";
      } else if (this.contains("/tags/")) {
        return "tag";
      } else if (GlobalState.PAGE.isLikesPage()) {
        return "likes";
      } else if ($("body").hasClass('find-friends-page')) {
        if (this.equal("/friends/who-to-follow")) {
          return "whoToFollow";
        } else {
          return "findFriends";
        }
      } else if (this.equal("/create")) {
        return "create";
      } else if (this.contains("/sources/")) {
        if (GlobalState.PAGE.getUrlParam('from_id') != null) {
          return "createFromSource";
        } else {
          return "sources";
        }
      } else if (this.contains("/coubs/")) {
        if (this.contains("/remix")) {
          return "remix";
        } else if (this.contains("/edit")) {
          return "edit";
        }
      } else if (GlobalState.PAGE.isBestCoubs2016() || GlobalState.PAGE.isBestCoubs2015() || GlobalState.PAGE.isBestCoubs2014()) {
        return "bestCoubs";
      } else if (this.equal("/about")) {
        return "about";
      } else if (this.equal("/apps")) {
        return "apps";
      } else if (this.equal("/brand-assets")) {
        return "brandAssets";
      } else if (this.contains("/dev/docs/")) {
        return "developers";
      } else if (this.equal("/tos")) {
        return "tos";
      } else if (this.equal("/dmca")) {
        return "dmca";
      } else if (this.equal("/privacy")) {
        return "privacy";
      } else if (this.equal("/api-terms")) {
        return "apiTerms";
      } else if (this.contains("/help/")) {
        return "help";
      } else if ($("body").hasClass('edit-profile-page')) {
        return "settings";
      }
    };

    AmplitudeLocationTracker.prototype.contains = function(substr) {
      return this.path.indexOf(substr) !== -1;
    };

    AmplitudeLocationTracker.prototype.equal = function(substr) {
      return this.path === substr || this.path === substr + "/";
    };

    AmplitudeLocationTracker.prototype.track = function(page) {
      return AmplitudeCoub.track(page + "_view_occured");
    };

    return AmplitudeLocationTracker;

  })();

}).call(this);
(function() {
  functions.CommunitiesService = (function() {
    CommunitiesService.EVENTS = {
      CHANGE_STARTED: "Event.CommunitiesChangeStarted",
      CHANGE_COMPLETED: "Event.CommunitiesChangeCompleted",
      UNSUBSRIBE_FAILED: "Event.CommunitiesUnsubscribeFailed"
    };

    function CommunitiesService() {
      if (functions.CommunitiesService.INSTANCE != null) {
        return functions.CommunitiesService.INSTANCE;
      } else {
        functions.CommunitiesService.INSTANCE = this;
      }
      this.init();
    }

    CommunitiesService.prototype.init = function() {
      new utils.ObservableMixin(this);
      this.s = this.constructor;
      return this.communitiesSorter = new functions.CommunitiesSorter();
    };

    CommunitiesService.prototype.toggle = function(communityId, val) {
      if (val) {
        this.communitiesSorter.undoSetPointsToZero(communityId);
        return this.toggleSubscription(communityId, true);
      } else {
        this.communitiesSorter.setPointsToZero(communityId);
        return this.toggleSubscription(communityId, false);
      }
    };

    CommunitiesService.prototype.handleUnsubscribeFailure = function(communityId, jqXhr) {
      if (jqXhr.status !== 403) {
        return;
      }
      this.trigger(this.s.EVENTS.UNSUBSRIBE_FAILED, communityId);
      return Growl.msg(I18n.t("trends.cant_unsubscribe"), "");
    };

    CommunitiesService.prototype.toggleSubscription = function(communityId, val) {
      this.trigger(this.s.EVENTS.CHANGE_STARTED, communityId, val);
      this.xhr && this.xhr.abort();
      this.xhr = val ? $.post(Routes.subscribe_api_v2_community_path(communityId)) : $.del(Routes.unsubscribe_api_v2_community_path(communityId)).fail(this.handleUnsubscribeFailure.bind(this, communityId));
      return this.xhr.done((function(_this) {
        return function() {
          _this.trigger(_this.s.EVENTS.CHANGE_COMPLETED, communityId, val);
          return _this.xhr = null;
        };
      })(this));
    };

    return CommunitiesService;

  })();

}).call(this);

/*
— каждому комьюнити мы даем условные баллы и сортируем по этим баллам
— в самом начале комьюнити сортируются в том порядке как мы выставили в админке, соответственно нижнему комьюнити мы даем 1 бал, пред последнему 2 бала, пред-пред последнему 3 и так до самого верха
— если мы зашли в какое-то комьюнити, то оно получает пойнт и двагается на одну позицию вверх списка
— в итоге те комьюнити, которые мы часто посещаем будут выше тем, которые посещаем реже и при этом они не будут резко прыгать вверх-вниз и пользователь не потерят их
— комьюнити от которых мы отписываемся опускаются в конец списка, то есть получают 0 баллов, надо сделать какую-то паузу на обнуление, потому что кто-то по приколу может включить/выключить комьюнити
- если коммьюнити было выключено, а потом включено (больше чем через 8 часов), то ставим 1 пойнт и значение пойнтов переписывается сразу
 */

(function() {
  functions.CommunitiesSorter = (function() {
    CommunitiesSorter.COOKIE_KEY = 'coub_communities_sort_data';

    CommunitiesSorter.prototype.DEFAULT_COMMUNITY_DATA = {
      points: 0,
      pendingPoints: -1,
      pendingSince: -1
    };

    function CommunitiesSorter() {
      if (functions.CommunitiesSorter.INSTANCE != null) {
        return functions.CommunitiesSorter.INSTANCE;
      } else {
        functions.CommunitiesSorter.INSTANCE = this;
      }
      this.init();
    }

    CommunitiesSorter.prototype.init = function() {
      this.s = this.constructor;
      return this.data = JSON.parse($.cookie(this.s.COOKIE_KEY));
    };

    CommunitiesSorter.prototype.addOnePoint = function(communityId) {
      var communityData;
      communityData = this.getCommunityData(communityId);
      if (communityData.pendingPoints === -1 && communityData.points !== 0) {
        console.log('CommunitiesSorter add', communityId);
        communityData.pendingPoints = communityData.points + 1;
        communityData.pendingSince = new Date().getTime();
        return this.saveToCookie();
      }
    };

    CommunitiesSorter.prototype.setPointsToZero = function(communityId) {
      var communityData;
      communityData = this.getCommunityData(communityId);
      communityData.pendingPoints = 0;
      communityData.pendingSince = new Date().getTime();
      this.saveToCookie();
      return console.log('CommunitiesSorter zero', communityId);
    };

    CommunitiesSorter.prototype.undoSetPointsToZero = function(communityId) {
      var communityData;
      communityData = this.getCommunityData(communityId);
      if (communityData.pendingPoints === 0 && communityData.points > 0) {
        communityData.pendingPoints = -1;
        communityData.pendingSince = -1;
      } else {
        communityData.points = 1;
        communityData.pendingPoints = -1;
        communityData.pendingSince = -1;
      }
      this.saveToCookie();
      return console.log('CommunitiesSorter undo zero', communityId);
    };

    CommunitiesSorter.prototype.getCommunityData = function(communityId) {
      if (this.data[communityId] == null) {
        this.data[communityId] = $.extend({}, this.DEFAULT_COMMUNITY_DATA);
      }
      return this.data[communityId];
    };

    CommunitiesSorter.prototype.saveToCookie = function() {
      return $.cookie(this.s.COOKIE_KEY, JSON.stringify(this.data), {
        expires: 365 * 5,
        path: '/'
      });
    };

    return CommunitiesSorter;

  })();

}).call(this);
(function() {
  functions.FeaturedStoriesBlockTimerReinit = {
    createListeners: function(timer, block) {
      return timer.on(widgets.CountdownTimer.EVENT_COMPLETE, (function(_this) {
        return function() {
          block.triggerHandler(blocks.StoriesBlock.prototype.ACTION_REINIT);
          return timer.triggerHandler(widgets.CountdownTimer.ACTION_REINIT_WITH_VALUE, [60 * 60 * 24 - 1]);
        };
      })(this));
    }
  };

}).call(this);
(function() {
  functions.FullscreenBodyClass = (function() {
    function FullscreenBodyClass() {
      $(document).on('fullscreenchange', function() {
        return $('body').toggleClass('fullscreen', helpers.Location.isFullScreen());
      });
    }

    return FullscreenBodyClass;

  })();

}).call(this);

/*
  Оптимизация pointer events
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  functions.PointerEventsOptimization = (function() {
    function PointerEventsOptimization() {
      this.handleScroll = bind(this.handleScroll, this);
      this.body = $("body");
      this.scf = functions.ScrollHandler;
      $(document).on(this.scf.EVENT_SCROLL, this.handleScroll);
    }

    PointerEventsOptimization.prototype.handleScroll = function() {
      if (this.resetTimeout != null) {
        clearTimeout(this.resetTimeout);
        this.resetTimeout = void 0;
      } else {
        this.body.addClass("disable-hover");
      }
      return this.resetTimeout = setTimeout((function(_this) {
        return function() {
          _this.body.removeClass("disable-hover");
          return _this.resetTimeout = void 0;
        };
      })(this), this.scf.FREQUENCY + 10);
    };

    return PointerEventsOptimization;

  })();

}).call(this);

/*
  Счетчик попыток совершить какое-то действие
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  functions.RetryCounter = (function(superClass) {
    extend(RetryCounter, superClass);

    function RetryCounter() {
      this.getCounterVal = bind(this.getCounterVal, this);
      this.nulify = bind(this.nulify, this);
      this.loadSuccess = bind(this.loadSuccess, this);
      this.tryAgain = bind(this.tryAgain, this);
      this._retryCounter = 0;
      this.retryTries = 3;
      this.retryTimeout = 3000;
    }

    RetryCounter.prototype.tryAgain = function(retryFn) {
      if (this._retryCounter < this.retryTries) {
        this._retryCounter++;
        if (this._curTry != null) {
          clearTimeout(this._curTry);
          this._curTry = void 0;
        }
        this._curTry = setTimeout(retryFn, this.retryTimeout);
        return true;
      } else {
        this.nulify();
        return false;
      }
    };

    RetryCounter.prototype.loadSuccess = function() {
      return this.nulify();
    };

    RetryCounter.prototype.nulify = function() {
      return this._retryCounter = 0;
    };

    RetryCounter.prototype.getCounterVal = function() {
      return this._retryCounter;
    };

    return RetryCounter;

  })(AbstractPiece);

}).call(this);

/*
  Обработчик скоролла для всего документа
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  functions.ScrollHandler = (function() {
    ScrollHandler.EVENT_SCROLL = "functions-ScrollHandler:Scroll";

    ScrollHandler.FREQUENCY = 300;

    ScrollHandler.prototype.DT = "functions.ScrollHandler";

    function ScrollHandler() {
      this.handleScroll = bind(this.handleScroll, this);
      if (functions.ScrollHandler.__instance == null) {
        this.data = new siteData.AbstractReactiveData({
          offset: void 0
        });
        this.data.set("offset", $(document).scrollTop());
        this.s = this.constructor;
        this.handler = new ScrollEventOptimizer(this.handleScroll, this.s.FREQUENCY);
        functions.ScrollHandler.__instance = this;
      } else {
        return functions.ScrollHandler.__instance;
      }
    }

    ScrollHandler.prototype.handleScroll = function(offset) {
      this.data.set("offset", offset);
      return $(document).trigger({
        type: this.s.EVENT_SCROLL,
        offset: offset
      });
    };

    ScrollHandler.getScrollPos = function() {
      return new functions.ScrollHandler().data.get("offset");
    };

    return ScrollHandler;

  })();

}).call(this);

/*
  Измеряет высоту и ширину браузера
 */

(function() {
  functions.WindowWidthHeight = (function() {
    WindowWidthHeight.prototype.DT = "functions.WindowWidthHeight";

    WindowWidthHeight.prototype.FREQUENCY = 100;

    function WindowWidthHeight() {
      var w;
      if (functions.WindowWidthHeight.__instance == null) {
        this.uidata = new siteData.UI();
        w = $(window);
        w.asEventStream("resize").throttle(this.FREQUENCY).onValue((function(_this) {
          return function() {
            _this.uidata.setIfUnequal("windowHeight", w.height());
            return _this.uidata.setIfUnequal("windowWidth", w.width());
          };
        })(this));
        w.trigger("resize");
        functions.WindowWidthHeight.__instance = this;
      } else {
        return functions.WindowWidthHeight.__instance;
      }
    }

    WindowWidthHeight.get = function() {
      var x;
      x = new functions.WindowWidthHeight();
      return {
        w: x.uidata.get("windowWidth"),
        h: x.uidata.get("windowHeight")
      };
    };

    return WindowWidthHeight;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.AdTimelineBanners = (function() {
    function AdTimelineBanners($anchor, isFirstReq) {
      this.bannerShownHandler = bind(this.bannerShownHandler, this);
      this.clear = bind(this.clear, this);
      this.showNext = bind(this.showNext, this);
      var isUnsafe, preview, queuedBanner, ref;
      this.container = $("<div class='coub timeline-banner' coub-block />").insertBefore($anchor);
      this.el = $("<div />", {
        "class": "viewer"
      }).appendTo(this.container);
      ref = encodeURIComponent(location.href);
      isUnsafe = $('body').hasClass('unsafe-for-ads');
      if (isUnsafe) {
        this.queue = [];
      } else {
        this.queue = [
          [widgets.VastTimelineBanner, [this.el, "https://vast.webvideomarketing.ru/wrapper/NSqqYAJGz9ZNiqfUgL7t5qXp9MWjCTyv.xml"]], [widgets.GoogleTimelineBanner, [this.el, "/112081842/coub_640x400", [640, 400]]], [
            widgets.AdfoxTimelineBanner, [
              this.el, {
                ownerId: 220463,
                p1: 'ciebr',
                p2: 'fqhi'
              }
            ]
          ]
        ];
        if (isFirstReq) {
          this.queue.unshift([widgets.NativerollTimelineBanner, [this.el, "5dfc799155299c767832306b"]], [
            widgets.AdfoxTimelineBanner, [
              this.el, {
                ownerId: 220463,
                p1: 'ciebr',
                p2: 'fqhi'
              }
            ]
          ]);
        }
      }
      if ((preview = getQueryParameters().timeline_banner_preview)) {
        if ((queuedBanner = this.queue[preview])) {
          console.log("AdTimelineBanners", "forcing banner ", queuedBanner[0].ID, queuedBanner[1]);
          this.queue = [queuedBanner];
        } else {
          console.warn("AdTimelineBanners", "no banner with index", preview, "found");
          this.queue = [];
        }
      }
      this.container.on("dom_remove", this.clear);
      setTimeout(this.showNext, 0);
      $.post(Routes.api_analytics_path(), {
        domain: "advertisement",
        properties: {
          type: "show",
          placement: "timeline",
          ad_blocker: !window.Ya || !window.Ya.adfoxCode
        }
      });
    }

    AdTimelineBanners.prototype.showNext = function() {
      var args, bannerObj, nextBanner;
      nextBanner = this.queue.shift();
      if (!nextBanner) {
        return;
      }
      bannerObj = nextBanner[0], args = nextBanner[1];
      console.log("AdTimelineBanners", "showing banner", bannerObj.ID, args);
      return bannerObj.init.apply(bannerObj, args).fail(this.showNext).done(this.bannerShownHandler);
    };

    AdTimelineBanners.prototype.clear = function() {
      return this.queue.length = 0;
    };

    AdTimelineBanners.prototype.bannerShownHandler = function() {
      this.container.addClass("-loaded");
      this.clear();
      return $.post(Routes.api_analytics_path(), {
        domain: "advertisement",
        properties: {
          type: "load",
          placement: "timeline"
        }
      });
    };

    return AdTimelineBanners;

  })();

}).call(this);
(function() {
  widgets.AdfoxAdaptiveBanner = (function() {
    function AdfoxAdaptiveBanner(params, params2) {
      if (params == null) {
        params = {
          p1: 'canqk',
          p2: 'fqhi'
        };
      }
      if (params2 == null) {
        params2 = {
          tabletWidth: 970,
          phoneWidth: 480,
          isAutoReloads: false
        };
      }
      this.id = "adfox_" + (new Date().getTime());
      this.ownerId = params.ownerId || 220463;
      this.params = _.omit(params, "ownerId");
      this.params2 = params2;
      console.log('init adfox adaptive banner with params', this.params, ', ownerId', this.ownerId, ' params2', this.params2);
    }

    AdfoxAdaptiveBanner.prototype.reload = function() {
      if (!window.Ya || !window.Ya.adfoxCode) {
        return;
      }
      return window.Ya.adfoxCode.reload(this.id);
    };

    AdfoxAdaptiveBanner.prototype.load = function(onRender, onError) {
      if (!window.Ya || !window.Ya.adfoxCode) {
        setTimeout(onError, 0);
        return;
      }
      return window.Ya.adfoxCode.createAdaptive({
        ownerId: this.ownerId,
        containerId: this.id,
        params: this.params,
        onRender: onRender,
        onStub: onError
      }, ['desktop'], this.params2);
    };

    return AdfoxAdaptiveBanner;

  })();

}).call(this);
(function() {
  widgets.AdfoxBanner = (function() {
    function AdfoxBanner(params, withScroll, initCriteoOnAdblock, isFirstScreen) {
      if (params == null) {
        params = {
          pp: "h",
          ps: "bkuu",
          p2: "fqfd"
        };
      }
      this.withScroll = withScroll;
      this.initCriteoOnAdblock = initCriteoOnAdblock != null ? initCriteoOnAdblock : false;
      this.isFirstScreen = isFirstScreen != null ? isFirstScreen : false;
      this.id = "adfox_" + (new Date().getTime());
      this.ownerId = params.ownerId || 214153;
      this.params = _.omit(params, "ownerId");
      console.log('itit adfox banner with params', this.params, ', ownerId', this.ownerId, window.Ya);
    }

    AdfoxBanner.prototype.reload = function() {
      if (!window.Ya || !window.Ya.adfoxCode) {
        return;
      }
      return window.Ya.adfoxCode.reload(this.id);
    };

    AdfoxBanner.prototype.load = function(onRender, onError) {
      if (!window.Ya || !window.Ya.adfoxCode) {
        if (this.initCriteoOnAdblock && this.canShowCriteo()) {
          this.initCriteo(onRender, onError);
          return;
        }
        setTimeout(onError, 0);
        return;
      }
      if (this.withScroll) {
        return window.Ya.adfoxCode.createScroll({
          ownerId: this.ownerId,
          containerId: this.id,
          params: this.params,
          onRender: onRender,
          onStub: onError || onRender
        });
      } else {
        return window.Ya.adfoxCode.create({
          ownerId: this.ownerId,
          containerId: this.id,
          params: this.params,
          onRender: onRender,
          onStub: onError || onRender
        });
      }
    };

    AdfoxBanner.prototype.canShowCriteo = function() {
      var bannerSq, limitRatio, screenSq;
      return true;
      screenSq = window.innerWidth * window.innerHeight;
      bannerSq = 300 * 600;
      limitRatio = this.isFirstScreen ? 0.15 : 0.25;
      return bannerSq / screenSq <= limitRatio || window.env === 'development';
    };

    AdfoxBanner.prototype.initCriteo = function(onRender, onError) {
      var callAdblock, container, error, isEmpty, render;
      if (!window.Criteo) {
        return setTimeout(onError, 0);
      }
      window.Criteo = window.Criteo || {};
      window.Criteo.events = window.Criteo.events || [];
      container = $("#" + this.id);
      isEmpty = false;
      render = (function(_this) {
        return function() {
          if (onRender) {
            return onRender();
          }
        };
      })(this);
      error = (function(_this) {
        return function() {
          container.removeAttr('style');
          if (onError) {
            return onError();
          }
        };
      })(this);
      callAdblock = (function(_this) {
        return function(zoneid, width, height) {
          var el;
          el = document.getElementById(_this.id);
          if (el == null) {
            return;
          }
          el.style.height = height + "px";
          Criteo.DisplayAcceptableAdIfAdblocked({
            'zoneid': zoneid,
            'containerid': _this.id,
            'overrideZoneFloor': false,
            'callbacksuccess': function() {
              if (isEmpty) {
                return error();
              } else {
                return render();
              }
            },
            'callbackerror': function() {
              return error();
            }
          });
          return window.addEventListener("message", function(e) {
            if ((e.origin === (location.protocol === 'https:' ? 'https://' : 'http://') + 'cas.criteo.com' && e.data === 'passback-' + zoneid) || !container.children().length) {
              return isEmpty = true;
            }
          });
        };
      })(this);
      return callAdblock(1123460, 300, 600);
    };

    return AdfoxBanner;

  })();

}).call(this);
(function() {
  widgets.AdfoxCoubPageBanner = {
    init: function(bannerEl) {
      var banner;
      banner = new widgets.AdfoxBanner({
        pp: "h",
        ps: "bkuu",
        p2: "frld"
      });
      bannerEl.attr("id", banner.id);
      return banner.load(function() {
        return bannerEl.addClass("-shown");
      }, function() {
        return bannerEl.remove();
      });
    }
  };

}).call(this);
(function() {
  widgets.AdfoxFeaturedBanner = (function() {
    AdfoxFeaturedBanner.ATTR_NAME = "adfox-featured-banner";

    function AdfoxFeaturedBanner($el) {
      var $body, id;
      $body = $("body");
      if (["tag-page--promo", "promo-profile-page", "editor-promo", "promo-page"].some(function(promo_class) {
        return $body.hasClass(promo_class);
      }) || GlobalState.PAGE.isChatPage()) {
        return;
      }
      id = "adfox_" + (Date.now());
      $el.attr("id", id);
      window.Ya && window.Ya.adfoxCode && window.Ya.adfoxCode.createScroll({
        ownerId: 228129,
        containerId: id,
        params: {
          p1: 'cimgr',
          p2: 'ezfl',
          puid1: '',
          puid2: '',
          puid3: '',
          puid4: '',
          puid5: '',
          puid8: '',
          puid9: '',
          puid10: '',
          puid21: '',
          puid22: '',
          puid31: '',
          puid32: '',
          puid33: '',
          puid34: ''
        },
        onRender: function() {
          return $('.coubs-list').triggerHandler(clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_CONTENTS);
        },
        onStub: function() {
          return $('.coubs-list').triggerHandler(clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_CONTENTS);
        }
      });
      page.exit(function(_ctx, next) {
        next();
        return window.Ya.adfoxCode.reload(id);
      });
    }

    return AdfoxFeaturedBanner;

  })();

}).call(this);
(function() {
  widgets.AdfoxSidebarWidget = (function() {
    AdfoxSidebarWidget.ATTR_NAME = "adfox-sidebar-widget";

    function AdfoxSidebarWidget(el) {
      this.el = $("<div />").appendTo(el);
      this.fixedOffset = this.getPlayingCoubMedian();
      this.banner = new widgets.AdfoxBanner({
        ownerId: 220463,
        p1: 'ciwfl',
        p2: 'fqhh'
      }, false);
      this.el.attr("id", this.banner.id).attr("data-provider", "adfox");
      this.reloadBanner();
      page.exit((function(_this) {
        return function(_ctx, next) {
          next();
          return _this.reloadBanner();
        };
      })(this));
      this.throttledScrollHandler = _.throttle(this.scrollHandler.bind(this), 100);
      $(document).on(TimelineViewDataProvider.VIEW_CHANGED_EVENT, this.setupForTimelineView.bind(this));
      this.setupForTimelineView();
    }

    AdfoxSidebarWidget.prototype.toggleRefresh = function(val) {
      clearInterval(this.refreshInterval);
      if (!val) {
        return;
      }
      return this.refreshInterval = setInterval(this.reloadBanner.bind(this), 60000);
    };

    AdfoxSidebarWidget.prototype.toggleFix = function(val) {
      this.isFixed = val;
      this.el.toggleClass("-fixed", val);
      return this.el.css("top", val ? this.fixedOffset : '');
    };

    AdfoxSidebarWidget.prototype.reloadBanner = function() {
      if ($('body').hasClass('unsafe-for-ads')) {
        return;
      }
      if (this.isLoaded) {
        if (!this.el.is(":in-viewport-partly")) {
          return;
        }
        return this.banner.reload();
      } else {
        this.banner.load(function() {
          return $('.coubs-list[view=mosaic]').triggerHandler(clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_CONTENTS);
        });
        return this.isLoaded = true;
      }
    };

    AdfoxSidebarWidget.prototype.setupForTimelineView = function() {
      if ($('.coubs-list').filter('[view=mosaic], .coubs-list--editorial').length) {
        this.toggleRefresh(false);
        $(window).off("scroll", this.throttledScrollHandler);
        if (this.isFixed) {
          this.toggleFix(false);
          return $('.coubs-list[view=mosaic]').triggerHandler(clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_CONTENTS);
        }
      } else {
        this.toggleRefresh(true);
        return $(window).on("scroll", this.throttledScrollHandler);
      }
    };

    AdfoxSidebarWidget.prototype.scrollHandler = function() {
      var anchorTop, scrollTop;
      anchorTop = this.el.parent().offset().top;
      scrollTop = $(window).scrollTop() + this.fixedOffset;
      if (scrollTop > anchorTop && !this.isFixed) {
        this.toggleFix(true);
      }
      if (scrollTop <= anchorTop && this.isFixed) {
        return this.toggleFix(false);
      }
    };

    AdfoxSidebarWidget.prototype.getPlayingCoubMedian = function() {
      if ($('header.header').hasClass('-static') || $('header.header').hasClass('-static-absolute')) {
        return $('.page-menu').height() + 10;
      } else {
        return $('header.header').height() + $('.page-menu').height() + 10;
      }
    };

    return AdfoxSidebarWidget;

  })();

}).call(this);
(function() {
  widgets.AdfoxTileWidget = (function() {
    function AdfoxTileWidget() {
      this.banner = $('body').hasClass('unsafe-for-ads') ? new widgets.AdfoxBanner({
        p1: 'cdasw',
        p2: 'fqhh',
        ownerId: 220463
      }) : new widgets.AdfoxBanner({
        pp: "h",
        ps: "bkuu",
        p2: "frjc"
      });
    }

    AdfoxTileWidget.prototype.render = function() {
      return this.el = $("<div id='" + this.banner.id + "' class='adfox-banner--tile' />");
    };

    AdfoxTileWidget.prototype.load = function() {
      return this.banner.load((function(_this) {
        return function() {
          if ($('body').hasClass('unsafe-for-ads')) {
            _this.el.addClass('-unsafe');
          }
          return $('.coubs-list').triggerHandler(clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_CONTENTS);
        };
      })(this));
    };

    return AdfoxTileWidget;

  })();

}).call(this);
(function() {
  widgets.AdfoxTimelineBanner = {
    ID: "AdfoxTimelineBanner",
    init: function($container, opts) {
      var $el, banner;
      banner = new widgets.AdfoxBanner(opts);
      $el = $("<div/>", {
        id: banner.id
      }).appendTo($container);
      return $.Deferred(function(defer) {
        if (!window.Ya || !window.Ya.headerBidding || !window.Ya.headerBidding.pushAdUnits) {
          return defer.reject();
        }
        window.Ya.headerBidding.pushAdUnits([
          {
            code: banner.id,
            sizes: [[640, 400]],
            bids: [
              {
                bidder: 'betweenDigital',
                params: {
                  placementId: '3621921'
                }
              }, {
                bidder: 'criteo',
                params: {
                  placementId: '1475415'
                }
              }, {
                bidder: 'getintent',
                params: {
                  placementId: '81_MF_Coub.com_D_Main_640x400'
                }
              }, {
                bidder: 'rtbhouse',
                params: {
                  placementId: 'IWAmlY53OlIRkVJrlLtl'
                }
              }, {
                bidder: 'buzzoola',
                params: {
                  placementId: '860064'
                }
              }
            ]
          }
        ]);
        return banner.load(defer.resolve, defer.reject);
      }).promise().fail(function() {
        return $el.remove();
      });
    }
  };

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.GoogleBanner = (function() {
    function GoogleBanner(adUnitPath, size) {
      this.adUnitPath = adUnitPath;
      this.size = size;
      this.onSlotRendered = bind(this.onSlotRendered, this);
      this.id = "div-gpt-ad-" + (Date.now());
      console.log('[googletag] init', this.adUnitPath, this.size, this.id);
    }

    GoogleBanner.prototype.load = function(onRender, onError) {
      if (!googletag || !googletag.cmd || !googletag.cmd.push) {
        onError && onError("google gpt is not loaded");
      }
      console.log('[googletag] load', document.getElementById(this.id));
      this.onRender = onRender;
      this.onError = onError;
      return googletag.cmd.push((function(_this) {
        return function() {
          _this.slot = googletag.defineSlot(_this.adUnitPath, _this.size, _this.id).addService(googletag.pubads());
          googletag.pubads().setCentering(true);
          googletag.pubads().collapseEmptyDivs();
          googletag.enableServices();
          googletag.pubads().addEventListener('slotRenderEnded', _this.onSlotRendered);
          return googletag.display(_this.id);
        };
      })(this));
    };

    GoogleBanner.prototype.reload = function() {
      console.log('[googletag] reload');
      return googletag.pubads().refresh([this.slot]);
    };

    GoogleBanner.prototype.destroy = function() {
      googletag.destroySlots([this.slot]);
      this.onRender = void 0;
      this.onError = void 0;
      return this.slot = void 0;
    };

    GoogleBanner.prototype.onSlotRendered = function(e) {
      var callback;
      if (this.callbackFired || e.slot !== this.slot) {
        return;
      }
      this.callbackFired = true;
      console.log('[googletag] slotRenderEnded', document.getElementById(this.id), e);
      callback = e.isEmpty ? this.onError : this.onRender;
      return callback && callback(e);
    };

    return GoogleBanner;

  })();

}).call(this);
(function() {
  widgets.GoogleTimelineBanner = {
    ID: "GoogleTimelineBanner",
    init: function($container, adUnitPath, size) {
      var $el, banner;
      banner = new widgets.GoogleBanner(adUnitPath, size);
      $el = $("<div/>", {
        id: banner.id,
        "class": "google-timeline-banner"
      }).appendTo($container);
      return $.Deferred(function(defer) {
        return banner.load(defer.resolve, defer.reject);
      }).promise().fail(function() {
        return $el.remove();
      });
    }
  };

}).call(this);
(function() {
  widgets.MediawayssBanner = (function() {
    function MediawayssBanner($container, onRender, onEmpty) {
      var $el, container, id, script_tag;
      id = "_mwayss-b8d24e64d7cc11ff901f9a5c46555a04" + (new Date().getTime());
      $el = $("<div/>", {
        id: id
      }).appendTo($container);
      this.addListeners(onRender, onEmpty);
      script_tag = document.createElement('script');
      script_tag.src = GlobalState.PLATFORM.isMobile() ? 'https://ad.mediawayss.com/ad/mwayss_invocation.min.js?pzoneid=2295&height=405&width=720&tld=coub.com&ctype=div&ch=DOMAIN_HERE' : 'https://ad.mediawayss.com/ad/mwayss_invocation.min.js?pzoneid=2294&height=405&width=720&tld=coub.com&ctype=div&ch=DOMAIN_HERE';
      container = $el.get(0);
      container.parentNode.insertBefore(script_tag, container);
    }

    MediawayssBanner.prototype.addListeners = function(onRender, onEmpty) {
      window.mox_AdLoaded = (function(_this) {
        return function() {
          return console.log('MediawayssBanner loaded');
        };
      })(this);
      window.mox_AdStarted = function() {
        console.log('MediawayssBanner started');
        return onRender && onRender();
      };
      window.mox_AdStopped = (function(_this) {
        return function() {
          return console.log('MediawayssBanner stopped');
        };
      })(this);
      return window.mox_onEmpty = (function(_this) {
        return function() {
          console.log('MediawayssBanner empty');
          return onEmpty && onEmpty();
        };
      })(this);
    };

    return MediawayssBanner;

  })();

}).call(this);
(function() {
  widgets.MediawayssTimelineBanner = {
    ID: "MediawayssTimelineBanner",
    init: function($container) {
      var defer, onEmpty, onRender;
      defer = $.Deferred();
      onRender = (function(_this) {
        return function() {
          return defer.resolve();
        };
      })(this);
      onEmpty = (function(_this) {
        return function() {
          return defer.reject();
        };
      })(this);
      if ($('body').hasClass('featured-coubs-page')) {
        new widgets.MediawayssBanner($container, onRender, onEmpty);
      } else {
        defer.reject();
      }
      return defer.promise();
    }
  };

}).call(this);

/*
  Промо МТС
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.MTSPromoWidget = (function() {
    MTSPromoWidget.ATTR_NAME = "widget-mts-block";

    function MTSPromoWidget(el) {
      var check;
      this.el = el;
      this.handleButtonAdded = bind(this.handleButtonAdded, this);
      this.handleVideoPlay = bind(this.handleVideoPlay, this);
      check = setInterval(((function(_this) {
        return function() {
          var els;
          els = $(".timeline-announcements-item__play-overlay");
          if (els.size() > 0) {
            clearInterval(check);
            return els.click(_this.handleVideoPlay);
          }
        };
      })(this)), 500);
      $(document).on("modal_content_updated", (function(_this) {
        return function() {
          return _this.handleButtonAdded();
        };
      })(this));
    }

    MTSPromoWidget.prototype.handleVideoPlay = function() {
      var x;
      x = new Image();
      return x.src = "http://ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=bfxkk&pfb=dogbn&pr=esvgyot";
    };

    MTSPromoWidget.prototype.handleButtonAdded = function() {
      return $("a.make-coub[href]").on("click", (function(_this) {
        return function() {
          var x;
          x = new Image();
          return x.src = "http://ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=bfxkk&pfb=dogbp&pr=esvhbfq";
        };
      })(this));
    };

    return MTSPromoWidget;

  })();

}).call(this);
(function() {
  widgets.NativerollTimelineBanner = {
    ID: "NativerollTimelineBanner",
    init: function($container, gid) {
      var $el;
      $el = $("<div/>", {
        "class": "nativeroll-timeline-banner",
        "data-gid": gid
      }).appendTo($container);
      return $.Deferred(function(defer) {
        if (typeof SeedrPlayer === "undefined" || SeedrPlayer === null) {
          return defer.reject();
        }
        SeedrPlayer({
          container: $el.get(0),
          desiredOffset: 50,
          gid: gid,
          onLoad: function() {
            $.post(Routes.api_analytics_path(), {
              domain: "nativeroll",
              properties: {
                id: "5dfc799155299c767832306b",
                type: "load",
                placement: "timeline",
                late: defer.isRejected()
              }
            });
            return defer.resolve();
          },
          onError: defer.reject
        });
        $.post(Routes.api_analytics_path(), {
          domain: "nativeroll",
          properties: {
            id: "5dfc799155299c767832306b",
            type: "request",
            placement: "timeline"
          }
        });
        return setTimeout(function() {
          if (defer.isResolved() || defer.isRejected()) {
            return;
          }
          console.log("[NATIVEROLL TIMELINE]", "destroying since ad didn't load in 5s");
          return defer.reject();
        }, 5000);
      }).promise().fail(function() {
        return $el.remove();
      });
    }
  };

}).call(this);
(function() {
  widgets.NewPoleMobileAds = (function() {
    function NewPoleMobileAds($container, onEmpty) {
      var script;
      if (onEmpty == null) {
        onEmpty = null;
      }
      return onEmpty && onEmpty($container);
      $container.addClass("new-pole-banner");
      script = document.createElement("script");
      script.innerHTML = JST["app/site/templates/ads/new_pole_mobile_script"]();
      $container.get(0).appendChild(script);
      this.interval = setInterval((function(_this) {
        return function($el) {
          if ($el.height() < 100) {
            return;
          }
          _this.clearTimeouts();
          $el.addClass('-showed');
          if (typeof clientsideTimeline !== "undefined" && clientsideTimeline !== null) {
            return $('.coubs-list').triggerHandler(clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_CONTENTS);
          }
        };
      })(this), 200, $container);
      if (!onEmpty) {
        return;
      }
      this.timeout = setTimeout((function(_this) {
        return function(callback, $el) {
          _this.clearTimeouts();
          return callback($el);
        };
      })(this), 2100, onEmpty, $container);
    }

    NewPoleMobileAds.prototype.clearTimeouts = function() {
      clearInterval(this.interval);
      return clearTimeout(this.timeout);
    };

    return NewPoleMobileAds;

  })();

}).call(this);
(function() {
  widgets.PromotedCoub = {
    load: function($anchor, renderData) {
      var defer;
      defer = $.Deferred();
      $.get(Routes.ad_coub_api_v2_promoted_coubs_path()).done(function(r) {
        var card, coub, data;
        if (!r) {
          return defer.reject();
        }
        coub = r.coub;
        coub.render = $.extend(true, {}, renderData, {
          promoted: {
            id: r.id,
            click_link: r.click_link,
            click_link_text: r.click_link_text,
            token: r.view_token
          }
        });
        coub.is_safe_for_ads = false;
        data = JSON.stringify(coub);
        card = $(JST["app/site/templates/coub_block/coub"](coub));
        $('<div/>', {
          text: data,
          "class": 'data -hidden'
        }).appendTo(card);
        $anchor.before(card);
        new CoubBlockClientside({
          el: card
        });
        return defer.resolve();
      }).fail(function(e) {
        console.error('ad_coub failed', e);
        return defer.reject();
      });
      return defer.promise();
    }
  };

}).call(this);
(function() {
  widgets.StoryCoubsBanner = (function() {
    function StoryCoubsBanner(container) {
      var banner, bannerEl, el;
      banner = new widgets.AdfoxBanner({
        p1: 'canql',
        p2: 'fqhi',
        ownerId: 220463
      });
      el = $("<div />", {
        "class": "viewer"
      }).appendTo(container);
      bannerEl = $("<div/>", {
        id: banner.id
      }).appendTo(el);
      window.Ya && window.Ya.headerBidding && window.Ya.headerBidding.pushAdUnits([
        {
          code: banner.id,
          sizes: [[640, 400]],
          bids: [
            {
              bidder: 'betweenDigital',
              params: {
                placementId: '2687619'
              }
            }, {
              bidder: 'rtbhouse',
              params: {
                placementId: 'Bk4sK2WNCBYjVBiTl5yj'
              }
            }, {
              bidder: 'criteo',
              params: {
                placementId: '1381790'
              }
            }, {
              bidder: 'alfasense',
              params: {
                placementId: 'direct_otm_1508'
              }
            }, {
              bidder: 'getintent',
              params: {
                placementId: '81_MF_Coub.com_D_640x400'
              }
            }
          ]
        }
      ]);
      banner.load($.noop, (function(_this) {
        return function() {
          return container.remove();
        };
      })(this));
    }

    return StoryCoubsBanner;

  })();

}).call(this);
(function() {
  widgets.VastTimelineBanner = {
    ID: "VastTimelineBanner",
    VAST_BLOCK_HEIGHT: 400,
    init: function($container, vastUrl) {
      var $el;
      $el = $("<div/>", {
        "class": "timeline-banner__vast"
      }).appendTo($container);
      $el.attr("data-vast-tag", vastUrl);
      return $.Deferred((function(_this) {
        return function(defer) {
          return _this.requestAd($el, vastUrl).fail(defer.reject).done(function(adsManager) {
            return _this.initVastPlayer($el, adsManager, vastUrl).then(defer.resolve, defer.reject);
          });
        };
      })(this)).promise().fail(function() {
        return $el.remove();
      });
    },
    initVastPlayer: function($el, adsManager, vastUrl) {
      var $coubBlock, defer, isInitialized, scrollHandler;
      defer = $.Deferred();
      isInitialized = false;
      $coubBlock = $el.closest(".coub.timeline-banner");
      scrollHandler = _.throttle(function() {
        var adError, isActive;
        isActive = $coubBlock.hasClass("active");
        if (isInitialized) {
          if (isActive) {
            return adsManager.resume();
          } else {
            return adsManager.pause();
          }
        } else {
          try {
            adsManager.init($el.width(), widgets.VastTimelineBanner.VAST_BLOCK_HEIGHT, google.ima.ViewMode.NORMAL);
            adsManager.setVolume(0);
            adsManager.start();
            isInitialized = true;
            return setTimeout(function() {
              if (defer.isResolved() || defer.isRejected()) {
                return;
              }
              console.log("[VAST TIMELINE]", "destroying since ad didn't start in 10s");
              adsManager.destroy();
              $el.remove();
              return defer.reject();
            }, 10000);
          } catch (error) {
            adError = error;
            console.error("[VAST TIMELINE]", "init failed", adError);
            $el.remove();
            return defer.reject();
          }
        }
      }, 200);
      $el.on("dom_remove.vastTimelineBanner", function() {
        return $(window).off("scroll", scrollHandler);
      });
      $(window).on("scroll", scrollHandler);
      adsManager.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR, (function(_this) {
        return function(e) {
          console.error("[VAST TIMELINE]", "play failed", e.getError());
          if (defer.isResolved()) {
            $(window).off("scroll", scrollHandler);
            return _this.setNextAdStub($el, vastUrl);
          } else {
            $el.remove();
            return defer.reject();
          }
        };
      })(this));
      adsManager.addEventListener(google.ima.AdEvent.Type.LOADED, function(e) {
        var ad;
        ad = e.getAd();
        return console.log("[VAST TIMELINE]", "ad loaded", ad, "linear:", ad.isLinear(), "system:", ad.getAdSystem(), "adevertiser:", ad.getAdvertiserName());
      });
      adsManager.addEventListener(google.ima.AdEvent.Type.STARTED, function(e) {
        adsManager.setVolume(0);
        console.log("[VAST TIMELINE]", "started", e);
        $el.removeClass("timeline-banner__vast--stub");
        if (!$el.is(":in-viewport-partly")) {
          adsManager.pause();
        }
        defer.resolve();
        return $('.coubs-list').triggerHandler(clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_CONTENTS);
      });
      adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED, (function(_this) {
        return function(e) {
          console.log("[VAST TIMELINE]", "content resume", e);
          $(window).off("scroll", scrollHandler);
          return _this.setNextAdStub($el, vastUrl);
        };
      })(this));
      scrollHandler();
      return defer.promise();
    },
    requestAd: function($container, vastUrl) {
      var adDisplayContainer, adsLoader, adsRequest, defer, onAdError, onAdsManagerLoaded;
      defer = $.Deferred();
      if (!window.google || !window.google.ima) {
        setTimeout(defer.reject, 0);
        return defer.promise();
      }
      adDisplayContainer = new google.ima.AdDisplayContainer($container.get(0));
      adDisplayContainer.initialize();
      onAdError = function(e) {
        console.error("[VAST TIMELINE]", "request failed", e.getError());
        return defer.reject();
      };
      onAdsManagerLoaded = function(adsManagerLoadedEvent) {
        var adsManager;
        adsManager = adsManagerLoadedEvent.getAdsManager({
          currentTime: 0,
          duration: 10
        });
        return defer.resolve(adsManager);
      };
      adsLoader = new google.ima.AdsLoader(adDisplayContainer);
      adsLoader.addEventListener(google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED, onAdsManagerLoaded, false);
      adsLoader.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR, onAdError, false);
      adsRequest = new google.ima.AdsRequest();
      adsRequest.adTagUrl = vastUrl;
      adsLoader.requestAds(adsRequest);
      return defer.promise();
    },
    setNextAdStub: function($container, vastUrl) {
      $container.empty();
      return $container.addClass("timeline-banner__vast--stub").one("click", (function(_this) {
        return function() {
          return _this.requestAd($container, vastUrl).fail(function() {
            $container.remove();
            return $('.coubs-list').triggerHandler(clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_CONTENTS);
          }).done(function(adsManager) {
            $container.removeClass("timeline-banner__vast--stub");
            return _this.initVastPlayer($container, adsManager, vastUrl);
          });
        };
      })(this));
    }
  };

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.AvatarChangeListener = (function() {
    AvatarChangeListener.ATTR_NAME = "widget-avatar-change-listener";

    function AvatarChangeListener(el) {
      this.el = el;
      this.avatarChange = bind(this.avatarChange, this);
      this.el = $(this.el);
      $(document).bind(pages.profile.view.AvatarUpload.ACTIONS.AVATAR_CHANGED, (function(_this) {
        return function(e) {
          return _this.avatarChange(e.channel);
        };
      })(this));
    }

    AvatarChangeListener.prototype.avatarChange = function(channel) {
      if (this.el.attr(widgets.AvatarChangeListener.ATTR_NAME) != null) {
        return helpers.Application.setAvatarAttrs(this.el, channel.avatar_versions.template, 'profile_pic_new');
      }
    };

    return AvatarChangeListener;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.BannerClose = (function() {
    BannerClose.ATTR_NAME = "widget-banner-with-close-button";

    function BannerClose(el) {
      this.bannerClose = bind(this.bannerClose, this);
      var closeBtn;
      this.el = $(el);
      closeBtn = $("<div class='viewer__das__close'><div></div></div>");
      setTimeout((function(_this) {
        return function() {
          var bannerContainer, bannerWithId, bannerWithoutId;
          if (_this.el.height()) {
            bannerWithId = _this.el.find('div[id]');
            bannerWithoutId = _this.el.find('div').first();
            bannerContainer = bannerWithId.length ? bannerWithId : bannerWithoutId;
            bannerContainer.css('position', 'relative').prepend(closeBtn);
            return $('div', closeBtn).click(_this.bannerClose);
          }
        };
      })(this), 1000);
    }

    BannerClose.prototype.bannerClose = function() {
      console.log('banner close click');
      return this.el.slideUp();
    };

    return BannerClose;

  })();

}).call(this);

/*
  Блок сайн апа (с социальными кнопками и формой регистрации по мейлу)
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.BlockSignUp = (function(superClass) {
    extend(BlockSignUp, superClass);

    BlockSignUp.ATTR_NAME = "widget-block-sign-up";

    BlockSignUp.prototype.DT = "widgets.BlockSignUp";

    function BlockSignUp(el) {
      this.el = el;
      this.initAmplitude = bind(this.initAmplitude, this);
      this.subviewsInit = bind(this.subviewsInit, this);
      this.hideLoader = bind(this.hideLoader, this);
      this.showLoader = bind(this.showLoader, this);
      this.oauthBtnFailure = bind(this.oauthBtnFailure, this);
      this.oauthBtnSuccess = bind(this.oauthBtnSuccess, this);
      BlockSignUp.__super__.constructor.apply(this, arguments);
      console.log(this.DT, "Init.");
      AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.SHOWED, {
        from: 'index'
      });
      this.inner = this.el.find(".registration-form__inner");
      this.subviewsInit();
      this.initAmplitude();
    }

    BlockSignUp.prototype.oauthBtnSuccess = function(data) {
      var provider, saveData;
      provider = new LoginDataProvider();
      this.showLoader();
      saveData = JSON.parse(JSON.stringify(data));
      return provider.signupOAuthLogic(saveData, {
        authChecked: (function(_this) {
          return function() {};
        })(this),
        error: (function(_this) {
          return function() {
            AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.SERVER_ERROR + _this.appendix);
            _this.hideLoader();
            return ErrorMessages.internalServerError();
          };
        })(this),
        signin: (function(_this) {
          return function(resp, regData) {
            return provider.signin($.param({
              session: regData
            }), function(data) {
              AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.SUCCESS + _this.appendix);
              if (data.redirect) {
                return $.handleRedirect(data.oauth_redirect || data.redirect);
              } else {
                return _this.hideLoader();
              }
            }, {
              error: function() {
                AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.SERVER_ERROR + _this.appendix);
                _this.hideLoader();
                return ErrorMessages.internalServerError();
              }
            });
          };
        })(this),
        signup: (function(_this) {
          return function(resp, regData, redirect) {
            return provider.signupLogic(regData, redirect, void 0, true, {
              afterSignup: function() {
                var dialog;
                AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.SUCCESS + _this.appendix);
                _this.hideLoader();
                dialog = AuthPopup.Base.constructAuthDialog("sign_up");
                return dialog.moveToPageById("follow-channels-page", false);
              },
              error: function() {
                AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.SERVER_ERROR + _this.appendix);
                _this.hideLoader();
                return ErrorMessages.internalServerError();
              }
            });
          };
        })(this),
        collectMail: (function(_this) {
          return function() {
            var dialog;
            dialog = AuthPopup.Base.constructAuthDialog("sign_up");
            dialog.moveToPageById("emailPage", false);
            return _this.hideLoader();
          };
        })(this),
        collectUsername: (function(_this) {
          return function() {
            var dialog;
            dialog = AuthPopup.Base.constructAuthDialog("sign_up");
            dialog.moveToPageById("usernamePage", false);
            return _this.hideLoader();
          };
        })(this)
      });
    };

    BlockSignUp.prototype.oauthBtnFailure = function() {
      AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.OAUTH_ERROR + this.appendix);
      return Growl.msg(I18n.ERRORS.AUTH_FAILED.HEADER, I18n.ERRORS.AUTH_FAILED.SUB);
    };

    BlockSignUp.prototype.showLoader = function() {
      return LoadRotator.appendWithOverlayAndStart(this.inner);
    };

    BlockSignUp.prototype.hideLoader = function() {
      return LoadRotator.removeWithOverlay(this.inner);
    };

    BlockSignUp.prototype.subviewsInit = function() {
      var that;
      that = this;
      this.subvEmailRegForm = new widgets.EmailRegistrationForm($("[" + widgets.EmailRegistrationForm.ATTR_NAME + "]", this.el), void 0, this);
      return $("[" + AuthPopup.Handlers.OAuthButton.ATTR_NAME + "]", this.el).each(function() {
        return new AuthPopup.Handlers.OAuthButton({
          el: this,
          kind: $(this).attr(AuthPopup.Handlers.OAuthButton.ATTR_NAME),
          onSuccess: function(data) {
            return that.oauthBtnSuccess(data);
          },
          onFailure: function() {
            return that.oauthBtnFailure();
          }
        });
      });
    };

    BlockSignUp.prototype.initAmplitude = function() {
      this.appendix = '_fromIndex';
      AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.SHOWED + this.appendix);
      $('[data-auth-button="vkontakte"]').click((function(_this) {
        return function() {
          return AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.VK_BUTTON_CLICKED + _this.appendix);
        };
      })(this));
      $('[data-auth-button="facebook"]').click((function(_this) {
        return function() {
          return AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.FB_BUTTON_CLICKED + _this.appendix);
        };
      })(this));
      $('[data-auth-button="twitter"]').click((function(_this) {
        return function() {
          return AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.TW_BUTTON_CLICKED + _this.appendix);
        };
      })(this));
      return $('[submit]').click((function(_this) {
        return function() {
          return AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.SUBMIT_BUTTON_CLICKED + _this.appendix);
        };
      })(this));
    };

    return BlockSignUp;

  })(abstract.Object);

}).call(this);

/*
  Дропдаун канала
 */

(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.ChannelDropdown = (function(superClass) {
    extend(ChannelDropdown, superClass);

    ChannelDropdown.ATTR_NAME = "widget-channel-dropdown";

    ChannelDropdown.prototype.DT = "widgets.ChannelDropdown";

    function ChannelDropdown(el1) {
      var e;
      this.el = el1;
      ChannelDropdown.__super__.constructor.apply(this, arguments);
      this.chandata = new siteData.ChannelsData();
      this.data = new siteData.AbstractReactiveData();
      this.data.set("fullChannelData", null);
      try {
        this.data.set("knownChannelData", JSON.parse(this.el.attr("channel")));
      } catch (error) {
        e = error;
        console.error(this.DT, "Can't read JSON from channel attr!");
        return;
      }
      this.xhrLocker = new chms.utils.Locker();
      this.initDropdown();
      this.data.getFiltedStream("fullChannelData").filter(function(v) {
        return v.value != null;
      }).onValue(this.renderAdditionalData.bind(this));
    }

    ChannelDropdown.prototype.initDropdown = function() {
      var channel, templ;
      channel = this.data.get("knownChannelData");
      templ = $(JST["app/site/templates/channel_item/box_channel_item"]({
        channel: channel,
        dontRenderCounters: true
      }));
      chms.utils.Autoinit.init(widgets.WidgetFollowButtonInit, templ);
      this.dropdown = new HoverableAbsoluteDropdown({
        el: this.el,
        defaultContent: templ,
        handle: this.el,
        handlerEventOpen: "mouseenter",
        dropdownPosition: AbsoluteDropdown.POSITION_TYPE.ABSOLUTE_TOP_OR_BOTTOM_CLOSE,
        handlerEventClose: HoverableAbsoluteDropdown.EVENTS.MOUSEOUT_TIMEOUT
      });
      templ.find(".follow-button__container").on("showed", (function(_this) {
        return function() {
          return _this.dropdown.el.trigger(_this.dropdown.s.ACTION_PREVENT_HIDING);
        };
      })(this)).on("hided", (function(_this) {
        return function() {
          return _this.dropdown.el.trigger(_this.dropdown.s.ACTION_ALLOW_HIDING);
        };
      })(this));
      return this.dropdown.el.on(AbsoluteDropdown.EVENT_BEFORE_SHOWED, this.getChannelData.bind(this));
    };

    ChannelDropdown.prototype.getChannelData = function() {
      var cd;
      if (this.xhrLocker.isLocked() || this.data.get("fullChannelData")) {
        return;
      }
      if ((cd = this.chandata.get(this.data.get("knownChannelData").id)) != null) {
        return this.data.set("fullChannelData", cd);
      } else {
        $.get(Routes.api_v2_channel_path(this.data.get("knownChannelData").id)).done((function(_this) {
          return function(c) {
            _this.chandata.set(c.id, c);
            return _this.data.set("fullChannelData", c);
          };
        })(this)).always(this.xhrLocker.unlock);
        return this.xhrLocker.lock();
      }
    };

    ChannelDropdown.prototype.renderAdditionalData = function() {
      var bi, el, fd, img, screen, vc;
      fd = this.data.get("fullChannelData");
      screen = this.dropdown.getContent().find(".box-card__screen");
      if ((bi = fd.background_image) != null) {
        el = $("<div>", {
          "class": "box-card__screen",
          style: "background-image: url('" + bi + "'); opacity: 0;"
        });
        img = new Image();
        img.src = bi;
        img.onload = function() {
          return el.css({
            opacity: 1
          });
        };
        screen.prepend(el);
      }
      if (((vc = fd.views_count) != null) && vc > 0) {
        screen.append($("<div>", {
          "class": "box-card__screen__right-note",
          html: numeral(vc).format("0,0") + "&nbsp;" + pluralize("view", vc)
        }));
      }
      return this.dropdown.getContent().find(".channel__counters").html(JST["app/site/templates/channel_item/box_channel_item_coubs_count"]({
        channel: fd,
        coubs_count_key: "simple_coubs_count"
      }));
    };

    return ChannelDropdown;

  })(AbstractPiece);

}).call(this);

/*
  Это какой нибудь элемент UI который зависит от текущего канала.
  К примеру аватара или ссылка на канал.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.ChannelItemAbstract = (function() {
    function ChannelItemAbstract(el) {
      this.el = el;
      this.onChannelChanged = bind(this.onChannelChanged, this);
      $(document).on(Params.EVENT_PARTICULAR_PARAM_CHANGED("current_channel_id"), (function(_this) {
        return function(e) {
          var channel, id;
          id = parseInt(e.value);
          channel = ChannelsDataProvider.findInParamsById(id);
          if (channel != null) {
            return _this.onChannelChanged(channel);
          } else {
            return console.error("widgets.ChannelItemAbstract: Can't find channel with id " + id);
          }
        };
      })(this));
    }

    ChannelItemAbstract.prototype.onChannelChanged = function(channel) {
      return console.warn("widgets.ChannelItemAbstract: Please implement onChannelChange method!");
    };

    return ChannelItemAbstract;

  })();

}).call(this);

/*
  Аватара канала.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.ChannelItemAvatar = (function(superClass) {
    extend(ChannelItemAvatar, superClass);

    function ChannelItemAvatar() {
      this.enableListener = bind(this.enableListener, this);
      this.disableListener = bind(this.disableListener, this);
      this.getAttrs = bind(this.getAttrs, this);
      this.getImgTemp = bind(this.getImgTemp, this);
      this.avatarSlide = bind(this.avatarSlide, this);
      this.onChannelChanged = bind(this.onChannelChanged, this);
      return ChannelItemAvatar.__super__.constructor.apply(this, arguments);
    }

    ChannelItemAvatar.ATTR_NAME = "widget-channel-item-avatar";

    ChannelItemAvatar.prototype.TIMING = {
      ANIMATE: 150,
      DETACH: 300,
      ANIM_COMPLETE: 100
    };

    ChannelItemAvatar.prototype.onChannelChanged = function(channel) {
      return setTimeout((function(_this) {
        return function() {
          _this.el.before(_this.getImgTemp(channel));
          return _this.avatarSlide();
        };
      })(this), this.TIMING.ANIMATE);
    };

    ChannelItemAvatar.prototype.avatarSlide = function() {
      var prev;
      prev = this.el.next();
      prev.addClass('to').addClass('animated');
      return setTimeout((function(_this) {
        return function() {
          _this.el.removeClass('from');
          prev.detach();
          return setTimeout(function() {
            return _this.el.removeClass('animated');
          }, _this.TIMING.ANIM_COMPLETE);
        };
      })(this), this.TIMING.DETACH);
    };

    ChannelItemAvatar.prototype.getImgTemp = function(channel) {
      this.el = $(" <img height='46' width='46' class='from animated' > ");
      return this.getAttrs(this.el, channel);
    };

    ChannelItemAvatar.prototype.getAttrs = function(elem, channel) {
      helpers.Application.setAvatarAttrs(elem, channel.avatar_versions.template, 'medium');
      if (Params.getBranchValue("profile_channel.id") === channel.id) {
        return this.enableListener();
      } else {
        return this.disableListener();
      }
    };

    ChannelItemAvatar.prototype.disableListener = function() {
      return this.el.removeAttr(widgets.AvatarChangeListener.ATTR_NAME);
    };

    ChannelItemAvatar.prototype.enableListener = function() {
      return this.el.attr(widgets.AvatarChangeListener.ATTR_NAME, 'true');
    };

    return ChannelItemAvatar;

  })(widgets.ChannelItemAbstract);

}).call(this);

/*
  Блок c текущим каналом в таймлайне
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.ChannelItemCurrent = (function(superClass) {
    extend(ChannelItemCurrent, superClass);

    function ChannelItemCurrent() {
      this.changeCover = bind(this.changeCover, this);
      this.changeUrl = bind(this.changeUrl, this);
      this.changeAvatar = bind(this.changeAvatar, this);
      this.changeTitles = bind(this.changeTitles, this);
      this.onChannelChanged = bind(this.onChannelChanged, this);
      return ChannelItemCurrent.__super__.constructor.apply(this, arguments);
    }

    ChannelItemCurrent.ATTR_NAME = "widget-channel-item-current";

    ChannelItemCurrent.prototype.onChannelChanged = function(channel) {
      this.changeAvatar(channel.avatar_versions.template);
      this.changeCover(channel.timeline_banner_image);
      this.changeUrl(channel.permalink);
      return this.changeTitles(channel);
    };

    ChannelItemCurrent.prototype.changeTitles = function(channel) {
      var channelTitle, coubsCountContent;
      channelTitle = this.el.find('h5 > a');
      coubsCountContent = JST['app/site/templates/channel_item/box_channel_item_coubs_count']({
        channel: channel,
        coubs_count_key: 'simple_coubs_count'
      });
      $('.channel__counters', this.el).html(coubsCountContent);
      return channelTitle.text(channel.title);
    };

    ChannelItemCurrent.prototype.changeAvatar = function(template) {
      return helpers.Application.setAvatarAttrs(this.el.find('.channel__avatar img'), template, 'medium');
    };

    ChannelItemCurrent.prototype.changeUrl = function(permalink) {
      var url;
      url = Routes.channel_path({
        id: permalink
      });
      return this.el.find('[widget-channel-item-current-url]').attr('href', url);
    };

    ChannelItemCurrent.prototype.changeCover = function(src) {
      var prop;
      prop = src ? "url(" + src + ")" : "";
      return this.el.find('.box-card__screen').css("background-image", prop);
    };

    return ChannelItemCurrent;

  })(widgets.ChannelItemAbstract);

}).call(this);

/*
  Ссылка на канал
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.ChannelItemUrl = (function(superClass) {
    extend(ChannelItemUrl, superClass);

    ChannelItemUrl.ATTR_NAME = "widget-channel-item-url";

    ChannelItemUrl.ACTIONS = {
      CHANGE: "widgets.ChannelItemUrl:Actions:Change"
    };

    function ChannelItemUrl(el1) {
      this.el = el1;
      this.changeUrl = bind(this.changeUrl, this);
      this.unwrapEl = bind(this.unwrapEl, this);
      this.wrapWithLink = bind(this.wrapWithLink, this);
      this.onChannelChanged = bind(this.onChannelChanged, this);
      this.forceChange = bind(this.forceChange, this);
      ChannelItemUrl.__super__.constructor.apply(this, arguments);
      if (GlobalState.PLATFORM.isMobile() && $('a', this.el).length) {
        this.unwrapEl($('img', this.el));
      }
      $(document).on(widgets.ChannelItemUrl.ACTIONS.CHANGE, (function(_this) {
        return function(e) {
          return _this.forceChange(e);
        };
      })(this));
    }

    ChannelItemUrl.prototype.forceChange = function(opts) {
      var currentChannelId;
      currentChannelId = parseInt(Params.get('current_channel_id'));
      if (currentChannelId === parseInt(opts.channelId)) {
        this.el.find('a').attr('href', Routes.channel_path({
          id: opts.permalink
        }));
      }
      return ChannelsDataProvider.updateProperty(opts.channelId, 'permalink', opts.permalink);
    };

    ChannelItemUrl.prototype.onChannelChanged = function(channel) {
      var img, link, opts, url;
      link = this.el.find('a');
      img = this.el.find('img');
      url = Routes.channel_path({
        id: channel.permalink
      });
      opts = this.el.attr('url-params');
      if (_.isElement(link[0])) {
        this.changeUrl(link, url, opts);
      }
      if (link.length === 0 && !GlobalState.PLATFORM.isMobile()) {
        this.wrapWithLink(img, url);
      }
      if ((GlobalState.PAGE.isProfile() || GlobalState.PAGE.isPromoProfile()) && channel.id === Params.getBranchValue('profile_channel.id')) {
        this.el.addClass('current');
        return this.unwrapEl(img);
      } else {
        return this.el.removeClass('current');
      }
    };

    ChannelItemUrl.prototype.wrapWithLink = function(el, url) {
      return el.wrap("<a href='" + url + "'></a>");
    };

    ChannelItemUrl.prototype.unwrapEl = function(el) {
      return el.unwrap();
    };

    ChannelItemUrl.prototype.changeUrl = function(el, url, opts) {
      var href, params;
      href = url;
      if (opts != null) {
        params = $.parseJSON(opts);
        href += _.values(params).join('');
      }
      return el.attr('href', href);
    };

    return ChannelItemUrl;

  })(widgets.ChannelItemAbstract);

}).call(this);
(function() {
  widgets.FriendsCount = (function() {
    FriendsCount.ATTR_NAME = "data-widget-friends-count";

    function FriendsCount($el) {
      $.get(Routes.friends_count_friends_path(), function(data) {
        if (data.total > 0) {
          return $el.find('.friends-mark').removeClass('-hidden').html(data.total_unique);
        }
      });
    }

    return FriendsCount;

  })();

}).call(this);

/*
  Переключатель активного канала.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.ChannelChanger = (function() {
    ChannelChanger.ATTR_NAME = "widget-channel-changer";

    ChannelChanger.STATES = void 0;

    ChannelChanger.ACTIONS = {
      URL_CHANGED: "widgets.ChannelChanger:Actions:UrlChanged"
    };

    function ChannelChanger(el) {
      this.el = el;
      this.hideLoader = bind(this.hideLoader, this);
      this.showLoader = bind(this.showLoader, this);
      this.unmarkAll = bind(this.unmarkAll, this);
      this.onChannelChanged = bind(this.onChannelChanged, this);
      this.isSelected = bind(this.isSelected, this);
      this.select = bind(this.select, this);
      this.changeUrl = bind(this.changeUrl, this);
      this.locker = new chms.utils.Locker(this.el);
      this.provider = new dataProviders.ApiV2();
      this.channelId = this.el.attr("channel-id");
      this.listItem = this.el.parent();
      this.dropdown = this.el.parents('.channel-menu-dropdown__content');
      this.el.bind("click", (function(_this) {
        return function(e) {
          return _this.select(e);
        };
      })(this));
      $(document).on(Params.EVENT_PARTICULAR_PARAM_CHANGED("current_channel_id"), this.onChannelChanged);
      $(document).on(blocks.NotificationsPopup.ACTIONS.UNMARK_NOTIFICATIONS, (function(_this) {
        return function() {
          return _this.unmarkAll(Params.get("current_channel_id"));
        };
      })(this));
      $(document).on(widgets.ChannelChanger.ACTIONS.URL_CHANGED, (function(_this) {
        return function(e) {
          if (e.channelId === _this.channelId) {
            return _this.changeUrl(e.permalink);
          }
        };
      })(this));
    }

    ChannelChanger.prototype.changeUrl = function(permalink) {
      return this.listItem.find("a").attr('href', Routes.channel_path({
        id: permalink
      }));
    };

    ChannelChanger.prototype.select = function(e) {
      if (e.metaKey || e.ctrlKey) {
        return true;
      }
      this.locker.safeExec((function(_this) {
        return function() {
          var previousId;
          if (!_this.isSelected()) {
            _this.locker.lock();
            previousId = Params.get("current_channel_id");
            return _this.provider.changeChannel($.extend({
              channel_id: _this.channelId
            }, widgets.ChannelChanger.STATES), {
              success: function(r) {
                var i, len, ref, widget;
                ref = [widgets.WidgetListenerLike, widgets.WidgetListenerRecoub, widgets.WidgetListenerDislike];
                for (i = 0, len = ref.length; i < len; i++) {
                  widget = ref[i];
                  widget.STATES = _.pick(r, widget.TYPE);
                }
                return Params.set("current_channel_id", _this.channelId);
              },
              error: function(r) {
                Growl.msg(I18n.t("growl_errors.channels.change.title"), r.statusText);
                return Params.set("current_channel_id", previousId);
              },
              complete: function() {
                _this.locker.unlock();
                return _this.dropdown.trigger(window.AbsoluteDropdown.ACTIONS.HIDE);
              }
            });
          }
        };
      })(this));
      return false;
    };

    ChannelChanger.prototype.isSelected = function() {
      return this.listItem.hasClass("active");
    };

    ChannelChanger.prototype.onChannelChanged = function(e) {
      if (e.value === this.channelId) {
        return this.listItem.addClass("active");
      } else {
        return this.listItem.removeClass("active");
      }
    };

    ChannelChanger.prototype.unmarkAll = function(id) {
      return this.listItem.find(".notify[channel-id=" + id + "]").text('');
    };

    ChannelChanger.prototype.showLoader = function() {
      return this.dropdown.addClass('disabled').find('.sb.select').addClass('loading');
    };

    ChannelChanger.prototype.hideLoader = function() {
      return this.dropdown.removeClass('disabled').find('.sb.select').removeClass('loading');
    };

    return ChannelChanger;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.CoubEmbedPopupLink = (function(superClass) {
    extend(CoubEmbedPopupLink, superClass);

    function CoubEmbedPopupLink() {
      this.appendFrame = bind(this.appendFrame, this);
      this.makeAction = bind(this.makeAction, this);
      return CoubEmbedPopupLink.__super__.constructor.apply(this, arguments);
    }

    CoubEmbedPopupLink.prototype.SELECTOR = 'a[type="coubEmbedPopup"]';

    CoubEmbedPopupLink.prototype.makeAction = function(opts) {
      var provider;
      provider = new dataProviders.ApiV2();
      this.modal = ModalPopup.show({
        content: '',
        type: 'simple',
        classes: 'embed-popup'
      });
      if (this.modal) {
        this.container = this.modal.getContentContainer();
        LoadRotator.appendToContainterAndStart(this.container);
        return provider.getCoub(opts.el.data().permalink, {
          success: (function(_this) {
            return function(data) {
              _this.appendFrame(data);
              $(document).trigger("flash_player:mute");
              return _this.modal.get().on(Popup.EVENT_HIDED, function() {
                return $(document).trigger("flash_player:unmute");
              });
            };
          })(this),
          error: (function(_this) {
            return function() {
              _this.modal.close();
              return ErrorMessages.internalServerError();
            };
          })(this)
        });
      }
    };

    CoubEmbedPopupLink.prototype.appendFrame = function(coub) {
      var frame, h, w;
      w = coub.site_w_h[0];
      h = coub.site_w_h[1];
      frame = $("<iframe>", {
        src: (Routes.embed_coub_path(coub.permalink)) + "?autostart=true&startWithHD=true",
        "class": '-fill'
      });
      this.container.css({
        paddingTop: helpers.Coub.aspectRatio(w, h).percent,
        position: 'relative',
        overflow: 'hidden'
      });
      return this.container.html(frame);
    };

    return CoubEmbedPopupLink;

  })(CustomActionAbstractLink);

}).call(this);

/*
  Таймер обратного отсчета, который кидает евент, когда достигает 0
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.CountdownTimer = (function() {
    CountdownTimer.ATTR_NAME = 'widget-countdown-timer';

    CountdownTimer.EVENT_COMPLETE = 'CountdownTimer:Event:Complete';

    CountdownTimer.ACTION_REINIT_WITH_VALUE = 'CountdownTimer:Action:ReinitWithValue';

    function CountdownTimer(el) {
      this.el = el;
      this.setTimer = bind(this.setTimer, this);
      this.s = this.constructor;
      this.el.on(this.s.ACTION_REINIT_WITH_VALUE, (function(_this) {
        return function(e, value) {
          return _this.init(value);
        };
      })(this));
      this.init(parseInt(this.el.attr('data-timer')));
    }

    CountdownTimer.prototype.init = function(value) {
      this.secondsTotal = value;
      return this.startTimer();
    };

    CountdownTimer.prototype.startTimer = function() {
      clearInterval(this.timerInterval);
      this.timerInterval = setInterval(this.setTimer, 1000);
      return this.setTimer();
    };

    CountdownTimer.prototype.setTimer = function() {
      var hours, minutes, seconds, time;
      hours = Math.floor(this.secondsTotal / 60 / 60);
      minutes = Math.floor(this.secondsTotal / 60 - hours * 60);
      seconds = this.secondsTotal - hours * 60 * 60 - minutes * 60;
      time = [hours, minutes, seconds].map(this.formatTime);
      this.el.text(time.join(':'));
      if (this.secondsTotal > 0) {
        return this.secondsTotal--;
      } else {
        clearInterval(this.timerInterval);
        return this.el.triggerHandler(this.s.EVENT_COMPLETE);
      }
    };

    CountdownTimer.prototype.formatTime = function(t) {
      if (t < 10) {
        return "0" + t;
      } else {
        return t;
      }
    };

    return CountdownTimer;

  })();

}).call(this);

/*
  Счетчик, содержащий в себе целое число (>=0) которое
  можно инкрементировать и декрементировать.

  Если значение счетчика меньше единицы то его контейнер
  прячется.

  Для того чтобы это работало в контейнере должен быть
  элемент с аттрибутом [counter-value]. Этот элемент
  использоватся для хранения значения счетчика.

  Если у элемента есть атрибут [hided-class] тогда этот класс
  используется для того чтобы спрятать элемент
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.Counter = (function() {
    Counter.ACTIONS = {
      INCREASE: "widgets.Counter:increase",
      DECREASE: "widgets.Counter:decrease"
    };

    Counter.ATTR_NAME = "widget-counter";

    function Counter(el, postProcessingFn) {
      this.el = el;
      this.postProcessingFn = postProcessingFn;
      this.decrease = bind(this.decrease, this);
      this.increase = bind(this.increase, this);
      this.valueContainer = this.el.find("[counter-value]");
      if (this.valueContainer.length === 0) {
        throw "widget.Counter: it requires a element with attribute [counter-value] in order to work";
      }
      this.hidedClass = this.el.attr("hided-class") || '-hidden';
      this.data = new siteData.AbstractReactiveData();
      this.readInitialValue();
      this.el.bind(widgets.Counter.ACTIONS.INCREASE, this.increase);
      this.el.bind(widgets.Counter.ACTIONS.DECREASE, this.decrease);
      this.data.getFiltedStream(["value"]).onValue((function(_this) {
        return function() {
          return _.defer(function() {
            _this.draw();
            return _this.updateDigitsClass();
          });
        };
      })(this));
      this.draw();
    }

    Counter.prototype.readInitialValue = function() {
      var x;
      x = parseInt(this.valueContainer.text().trim());
      return this.data.set("value", isNaN(x) ? 0 : x);
    };

    Counter.prototype.setValue = function(val) {
      if (!isNaN(val)) {
        return this.data.set("value", val);
      } else {
        return console.error(this.DT, "Trying to set value to NaN");
      }
    };

    Counter.prototype.getValue = function() {
      return this.data.get("value");
    };

    Counter.prototype.increase = function() {
      return this.data.addNum("value", 1);
    };

    Counter.prototype.decrease = function() {
      var cv;
      cv = this.data.get("value");
      return this.data.set("value", Math.max(0, cv - 1));
    };

    Counter.prototype.showIfNotZeroOrHide = function() {
      return this.el.toggleClass(this.hidedClass, this.data.get("value") === 0);
    };

    Counter.prototype.draw = function() {
      var cv;
      cv = this.data.get("value");
      if (this.postProcessingFn != null) {
        cv = this.postProcessingFn(cv);
      }
      this.valueContainer.text(cv);
      return this.showIfNotZeroOrHide();
    };

    Counter.prototype.updateDigitsClass = function() {
      var classes, cv;
      cv = this.data.get("value");
      if (!cv) {
        return;
      }
      cv = cv.toString().length;
      classes = ["-one-digit", "-two-digits", "-three-or-more-digits"];
      this.el.removeClass(classes.join(" "));
      return this.el.addClass(classes[Math.min(cv - 1, 2)]);
    };

    return Counter;

  })();

}).call(this);

/*
  Счетчик нотификейшнов для текущего канала
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.CurrentChannelNotificationsCount = (function() {
    CurrentChannelNotificationsCount.ATTR_NAME = "widget-current-channel-notifications-count";

    CurrentChannelNotificationsCount.prototype.TIMING = {
      ANIMATE: 200
    };

    CurrentChannelNotificationsCount.prototype.MAX_COUNT = 20;

    function CurrentChannelNotificationsCount(el) {
      this.el = el;
      this.setView = bind(this.setView, this);
      this.getCurrent = bind(this.getCurrent, this);
      this.umarkAll = bind(this.umarkAll, this);
      this.onRead = bind(this.onRead, this);
      this.onSelect = bind(this.onSelect, this);
      this.toggleAnimation = bind(this.toggleAnimation, this);
      this.onChanged = bind(this.onChanged, this);
      this.indicator = this.el.find('.indicator');
      this.counter = this.el.parent();
      this.count = this.el.siblings('[data-count]');
      this.currentChannel = ChannelsDataProvider.findInParamsById(Params.get("current_channel_id"));
      this.setView();
      chms.utils.Autoinit.init(widgets.Counter, this.counter.parent());
      $(document).bind(Params.EVENT_PARTICULAR_PARAM_CHANGED("current_channel_id"), (function(_this) {
        return function(e) {
          _this.currentChannel = ChannelsDataProvider.findInParamsById(parseInt(e.value));
          _this.onChanged(_this.currentChannel.unread_notifications_count);
          return _this.onSelect();
        };
      })(this));
      $(document).bind(blocks.NotificationsPopup.EVENTS.NOTIFICATION_READ, (function(_this) {
        return function() {
          return _this.onRead();
        };
      })(this));
      $(document).bind(blocks.NotificationsPopup.ACTIONS.UNMARK_NOTIFICATIONS, (function(_this) {
        return function() {
          return _this.umarkAll();
        };
      })(this));
    }

    CurrentChannelNotificationsCount.prototype.onChanged = function(count) {
      this.toggleAnimation();
      return setTimeout((function(_this) {
        return function() {
          _this.count.text(count);
          _this.setView();
          _this.onSelect();
          return _this.toggleAnimation();
        };
      })(this), this.TIMING.ANIMATE);
    };

    CurrentChannelNotificationsCount.prototype.toggleAnimation = function() {
      return this.el.toggleClass('onchange');
    };

    CurrentChannelNotificationsCount.prototype.onSelect = function() {
      if (this.getCurrent() === 0) {
        return this.indicator.removeClass('unread');
      } else {
        return this.indicator.addClass('unread');
      }
    };

    CurrentChannelNotificationsCount.prototype.onRead = function() {
      this.counter.trigger(widgets.Counter.ACTIONS.DECREASE);
      this.indicator.html(this.getCurrent());
      if (this.getCurrent() === 0) {
        this.indicator.removeClass('unread');
      }
      this.indicator.addClass('viewed');
      return setTimeout((function(_this) {
        return function() {
          return _this.indicator.removeClass('viewed');
        };
      })(this), 100);
    };

    CurrentChannelNotificationsCount.prototype.umarkAll = function() {
      this.currentChannel.unread_notifications_count = 0;
      return this.indicator.removeClass('unread').text(0);
    };

    CurrentChannelNotificationsCount.prototype.getCurrent = function() {
      return parseInt(this.count.text().trim());
    };

    CurrentChannelNotificationsCount.prototype.setView = function() {
      if (this.getCurrent() > this.MAX_COUNT) {
        return this.indicator.html(this.MAX_COUNT + "<span>+</span>");
      } else {
        return this.indicator.text(this.getCurrent());
      }
    };

    return CurrentChannelNotificationsCount;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.AbstractAfterCreatePopup = (function(superClass) {
    extend(AbstractAfterCreatePopup, superClass);

    AbstractAfterCreatePopup.EVENT_CANCEL = "AbstractAfterCreatePopup:Cancel";

    AbstractAfterCreatePopup.EVENT_SUBMIT = "AbstractAfterCreatePopup:Submit";

    AbstractAfterCreatePopup.prototype.SCREEN = {
      AFTER_CREATE: 'after-create-screen',
      CATEGORIES: 'categories-screen'
    };

    AbstractAfterCreatePopup.prototype.MAX_TAGS = 100;

    function AbstractAfterCreatePopup(opts) {
      this.hideOverlayAndStop = bind(this.hideOverlayAndStop, this);
      this.showOverlayAndStart = bind(this.showOverlayAndStart, this);
      this.togglePublishedAt = bind(this.togglePublishedAt, this);
      this.toggleVisibilitySection = bind(this.toggleVisibilitySection, this);
      this.animateButtonOnError = bind(this.animateButtonOnError, this);
      this.submit = bind(this.submit, this);
      this.close = bind(this.close, this);
      this.show = bind(this.show, this);
      this.addRemoveScroll = bind(this.addRemoveScroll, this);
      this.getForm = bind(this.getForm, this);
      this.getAutocompleteInput = bind(this.getAutocompleteInput, this);
      this.getSubmitButton = bind(this.getSubmitButton, this);
      this.getTitleInput = bind(this.getTitleInput, this);
      this.initValidation = bind(this.initValidation, this);
      this.onSubmitClick = bind(this.onSubmitClick, this);
      this.onSubmitAndStayClick = bind(this.onSubmitAndStayClick, this);
      this.onSubmit = bind(this.onSubmit, this);
      this.resizeDescription = bind(this.resizeDescription, this);
      this.setSubmitButton = bind(this.setSubmitButton, this);
      this.setHeading = bind(this.setHeading, this);
      this.setScreen = bind(this.setScreen, this);
      this.initScreens = bind(this.initScreens, this);
      AbstractAfterCreatePopup.__super__.constructor.apply(this, arguments);
      this.restorable = new RestorableForm(this.getForm());
      $("[type='submit']", this.el).on("click", this.onSubmitClick);
      $('.dropdown', this.el).dropdown();
      $('.dropdown--select', this.el).nice_select();
      $('.date-select', this.el).each(function() {
        return new NiceDateSelect({
          el: this,
          fullMonthNames: true,
          utc: true
        });
      });
      $('.list--selectable.niceScroller', this.el).nice_scroller();
      $('.dropdown--visibility input', this.el).on("change", this.toggleVisibilitySection);
      $('.publish-at input[type=checkbox]', this.el).on("change", this.togglePublishedAt);
      this.initValidation();
      this.initTagIt();
      this.initScreens();
      this.toggleVisibilitySection();
      this.getForm().on("submit", this.onSubmit);
    }

    AbstractAfterCreatePopup.prototype.initScreens = function() {
      var btnBack, btnNext;
      this.afterCreateContent = $(".after-create__content", this.el);
      this.categoriesContent = $(".communities__content", this.el);
      this.header = $("h1", this.el);
      this.headerDefaultText = this.header.text();
      this.submitBtn = $("[form-submit='true']", this.el);
      this.publishAndStayBtn = $(".publish_and_stay", this.el);
      this.publishAndStayBtn.click(this.onSubmitAndStayClick);
      this.communityDescriptionsContainer = $('.communities__descriptions-container', this.categoriesContent);
      $(window).resize(_.debounce(this.resizeDescription, 100));
      this.resizeDescription();
      this.categoriesSelector = new widgets.CategoriesSelector(this.categoriesContent);
      this.categoriesSelector.on('selected', (function(_this) {
        return function() {
          _this.showCommunityDescription();
          _this.setSubmitButton();
          return _this.setHeading();
        };
      })(this));
      this.setScreen(this.SCREEN.AFTER_CREATE);
      this.setSubmitButton();
      btnNext = $(".btn-next", this.afterCreateContent);
      btnNext.click((function(_this) {
        return function() {
          if (_this.getForm().valid() && !_this.getTitleInput().hasClass("error")) {
            return _this.setScreen(_this.SCREEN.CATEGORIES);
          } else {
            return _this.animateButtonOnError(btnNext);
          }
        };
      })(this));
      btnBack = $(".communities__content__back", this.categoriesContent);
      return btnBack.click((function(_this) {
        return function() {
          return _this.setScreen(_this.SCREEN.AFTER_CREATE);
        };
      })(this));
    };

    AbstractAfterCreatePopup.prototype.setScreen = function(screen) {
      this.$el.removeClass(this.screen || '').addClass(screen);
      this.screen = screen;
      switch (screen) {
        case this.SCREEN.AFTER_CREATE:
          this.afterCreateContent.removeClass('-hidden');
          this.categoriesContent.addClass('-hidden');
          break;
        case this.SCREEN.CATEGORIES:
          this.afterCreateContent.addClass('-hidden');
          this.categoriesContent.removeClass('-hidden');
      }
      return this.setHeading();
    };

    AbstractAfterCreatePopup.prototype.setHeading = function() {
      var text;
      text = this.screen === this.SCREEN.AFTER_CREATE ? this.headerDefaultText : I18n.t('customize_popup.select_categories', {
        count: this.categoriesSelector.getSelected().length
      });
      return this.header.text(text);
    };

    AbstractAfterCreatePopup.prototype.setSubmitButton = function() {
      var value;
      return;
      value = this.categoriesSelector.getSelected().length === 0;
      this.submitBtn.toggleClass('disabled', value);
      return this.publishAndStayBtn.toggleClass('disabled', value);
    };

    AbstractAfterCreatePopup.prototype.resizeDescription = function() {
      if (!this.communityDescriptionsContainer.hasClass('-hidden')) {
        return this.communityDescriptionsContainer.nice_scroller();
      }
    };

    AbstractAfterCreatePopup.prototype.showCommunityDescription = function() {
      var selectedCommunityId;
      selectedCommunityId = this.categoriesSelector.selectedCategories[0];
      if (!selectedCommunityId) {
        return;
      }
      this.communityDescriptionsContainer.nice_scroller().removeClass('-hidden');
      $('.community-description__item', this.communityDescriptionsContainer).addClass('-hidden').filter("[data-community-id=" + selectedCommunityId + "]").removeClass('-hidden');
      return this.resizeDescription();
    };

    AbstractAfterCreatePopup.prototype.onSubmit = function(e) {
      this.makeAnotherCoub = false;
      e.preventDefault();
      return e.stopPropagation();
    };

    AbstractAfterCreatePopup.prototype.onSubmitAndStayClick = function(e) {
      this.makeAnotherCoub = true;
      if (this.isVisible()) {
        return this.submit();
      }
    };

    AbstractAfterCreatePopup.prototype.onSubmitClick = function(e) {
      if (this.isVisible()) {
        return this.submit();
      }
    };

    AbstractAfterCreatePopup.prototype.initTagIt = function() {
      var addPlaceholder, removePlaceholder;
      addPlaceholder = (function(_this) {
        return function() {
          if ($(_this.el).find(".tags").tagit('assignedTags').length) {
            return;
          }
          return _this.getAutocompleteInput().addClass('placeholder').attr('placeholder', I18n.CUSTOMIZE_POPUP.AFTER_CREATE.TAGS_PLACEHOLDER);
        };
      })(this);
      removePlaceholder = (function(_this) {
        return function() {
          return _this.getAutocompleteInput().removeClass('placeholder').attr('placeholder', null);
        };
      })(this);
      $(this.el).find(".tags").tagit({
        tagLimit: this.MAX_TAGS,
        allowDuplicates: false,
        allowSpaces: true,
        useCoubAutocomplete: true,
        autocomplete: {
          source: _.throttle((function(_this) {
            return function(search, showChoices) {
              _this.currentQuery && _this.currentQuery.abort();
              return _this.currentQuery = $.get(Routes.search_api_v2_tags_path(), {
                title: search
              }).done(function(data) {
                var tags;
                tags = _.pluck(data, "title");
                return showChoices(tags);
              });
            };
          })(this), 300, {
            leading: false
          })
        },
        onTagClicked: function(event, ui) {
          return $(this).tagit("removeTagByLabel", ui.tagLabel);
        },
        preprocessTag: function(val) {
          return val.replace(/[#,]/g, "");
        },
        afterTagAdded: (function(_this) {
          return function(e, tag) {
            _this.afterTagAdded(tag.tagLabel);
            _this.addRemoveScroll(true);
            return removePlaceholder();
          };
        })(this),
        afterTagRemoved: (function(_this) {
          return function(e, tag) {
            _this.afterTagRemoved(tag.tagLabel);
            _this.addRemoveScroll();
            return addPlaceholder();
          };
        })(this)
      });
      $(this.el).find(".edit-popup__clear-tags").on("click", function(e) {
        return $(e.currentTarget).siblings(".tags").tagit("removeAll");
      });
      return addPlaceholder();
    };

    AbstractAfterCreatePopup.prototype.initValidation = function() {
      var errorMessageContainer;
      errorMessageContainer = $(".-error-text", this.el);
      return this.getForm().validate({
        rules: {
          "coub[title]": {
            required: true,
            maxlength: 140
          },
          "coub_simple[title]": {
            required: true,
            maxlength: 140
          }
        },
        onfocusout: (function(_this) {
          return function(element) {
            var name;
            name = $(element).attr("name");
            if (["coub[title]", "coub_simple[title]"].indexOf(name) !== -1) {
              return $(element).valid();
            }
          };
        })(this),
        errorPlacement: (function(_this) {
          return function(message) {
            _this.getTitleInput().addClass("error");
            errorMessageContainer.html(message);
            return errorMessageContainer.show();
          };
        })(this),
        success: (function(_this) {
          return function() {
            _this.getTitleInput().removeClass("error");
            errorMessageContainer.html("");
            return errorMessageContainer.hide();
          };
        })(this),
        messages: {
          "coub[title]": {
            required: I18n.CUSTOMIZE_POPUP.ERROR_MESSAGES.TITLE_REQUIRED,
            maxlength: I18n.CUSTOMIZE_POPUP.ERROR_MESSAGES.TITLE_TOO_LONG
          },
          "coub_simple[title]": {
            required: I18n.CUSTOMIZE_POPUP.ERROR_MESSAGES.TITLE_REQUIRED,
            maxlength: I18n.CUSTOMIZE_POPUP.ERROR_MESSAGES.TITLE_TOO_LONG
          }
        }
      });
    };

    AbstractAfterCreatePopup.prototype.getTitleInput = function() {
      return $("[name='coub[title]']", this.el) || $("[name='coub_simple[title]']", this.el);
    };

    AbstractAfterCreatePopup.prototype.getSubmitButton = function() {
      return $(".sb[type='submit']", this.el);
    };

    AbstractAfterCreatePopup.prototype.getAutocompleteInput = function() {
      return $("input.ui-widget-content", this.el);
    };

    AbstractAfterCreatePopup.prototype.getForm = function() {
      return $("form", this.el);
    };

    AbstractAfterCreatePopup.prototype.addRemoveScroll = function(scrollToBottom) {
      var tagit;
      if (scrollToBottom == null) {
        scrollToBottom = false;
      }
      tagit = $('.tagit', this.el);
      if (tagit.height() >= 122) {
        tagit.addClass('scroll-y');
        if (scrollToBottom) {
          return tagit.scrollTop(999999999);
        }
      } else {
        return tagit.removeClass('scroll-y');
      }
    };

    AbstractAfterCreatePopup.prototype.show = function() {
      AbstractAfterCreatePopup.__super__.show.apply(this, arguments);
      this.addRemoveScroll(true);
      return $('body').addClass('disable-scroll');
    };

    AbstractAfterCreatePopup.prototype.close = function() {
      this.hideOverlayAndStop();
      $(this).trigger(AbstractAfterCreatePopup.EVENT_CANCEL);
      $(".error", this.el).removeClass("error");
      $(".-error-text", this.el).html("").hide();
      $('body').removeClass('disable-scroll');
      return AbstractAfterCreatePopup.__super__.close.apply(this, arguments);
    };

    AbstractAfterCreatePopup.prototype.submit = function(e) {
      if (e != null) {
        e.stopPropagation();
        e.preventDefault();
      }
      if (!this.getForm().valid()) {
        this.animateButtonOnError(this.getSubmitButton());
        return false;
      } else {
        this.showOverlayAndStart();
        return true;
      }
    };

    AbstractAfterCreatePopup.prototype.animateButtonOnError = function(btn) {
      var amp, right, time;
      right = parseInt(btn.css("right"));
      amp = 8;
      time = 50;
      return btn.animate({
        right: right - amp
      }, time, ((function(_this) {
        return function() {
          return btn.animate({
            right: right + amp
          }, time, (function() {
            return btn.animate({
              right: right
            }, time);
          }));
        };
      })(this)));
    };

    AbstractAfterCreatePopup.prototype.toggleVisibilitySection = function() {
      var $visibilityInput, isDraft;
      $visibilityInput = $('.dropdown--visibility input', this.el);
      isDraft = $visibilityInput.val() === 'draft';
      $('.publish-at', this.el).toggleClass('-hidden', !isDraft).find('input.-hidden').prop('checked', !isDraft);
      $visibilityInput.prop('disabled', isDraft);
      if (isDraft) {
        this.togglePublishedAt();
        return $('button.publish', this.el).text(I18n.t('customize_popup.after_create.buttons.save'));
      } else {
        $('button.publish_and_stay', this.el).text(I18n.t('customize_popup.after_create.buttons.publish_and_stay'));
        return $('button.publish', this.el).text(I18n.t('customize_popup.after_create.buttons.publish'));
      }
    };

    AbstractAfterCreatePopup.prototype.togglePublishedAt = function() {
      var $publishAtInput, $publishSection, isOff;
      $publishSection = $('.publish-at', this.el);
      $publishAtInput = $('.date-select__input', $publishSection).first();
      isOff = !$('input[type=checkbox]', $publishSection).prop('checked');
      $publishSection.find('span').toggleClass('disabled', isOff).end().find('.date-select').toggleClass('disabled', isOff).end();
      if (isOff) {
        this.savedPublishedAt = $publishAtInput.val();
        return $publishAtInput.val('');
      } else if (this.savedPublishedAt) {
        return $publishAtInput.val(this.savedPublishedAt);
      }
    };

    AbstractAfterCreatePopup.prototype.showOverlayAndStart = function() {
      return LoadRotator.appendWithOverlayAndStart($('.modal__content', this.el), '');
    };

    AbstractAfterCreatePopup.prototype.hideOverlayAndStop = function() {
      return LoadRotator.removeWithOverlay($('.modal__content', this.el));
    };

    AbstractAfterCreatePopup.prototype.afterTagAdded = $.noop;

    AbstractAfterCreatePopup.prototype.afterTagRemoved = $.noop;

    return AbstractAfterCreatePopup;

  })(window.Popup);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.EditCoubPopup = (function(superClass) {
    extend(EditCoubPopup, superClass);

    function EditCoubPopup(opts) {
      this.close = bind(this.close, this);
      this.cancel = bind(this.cancel, this);
      this.submit = bind(this.submit, this);
      EditCoubPopup.__super__.constructor.apply(this, arguments);
      this.coubBlock = opts.coubBlock;
      $('.channel--select .niceScroller', this.el).nice_scroller();
      $(document).trigger("flash_player:suspend");
    }

    EditCoubPopup.prototype.submit = function(e) {
      var sd;
      if (!EditCoubPopup.__super__.submit.apply(this, arguments)) {
        return;
      }
      sd = this.getForm().serializeObject();
      sd.coub.normalize_sound = sd.coub.normalize_sound === "1";
      return $.post(Routes.update_info_api_v2_coub_path(sd.id), sd).done((function(_this) {
        return function() {
          $(document).one(CoubBlockClientside.EVENT_RELOAD_COMPLETE, function() {
            _this.restorable.remember();
            _this.close();
            return Growl.succ(I18n.CUSTOMIZE_POPUP.SIMPLE_EDIT.MESSAGE_AFTER_SAVE.HEADER, I18n.CUSTOMIZE_POPUP.SIMPLE_EDIT.MESSAGE_AFTER_SAVE.MESSAGE);
          });
          return _this.coubBlock.reload();
        };
      })(this)).fail((function(_this) {
        return function() {
          ErrorMessages.internalServerError();
          return _this.close();
        };
      })(this));
    };

    EditCoubPopup.prototype.cancel = function() {
      this.restorable.restore();
      return this.close();
    };

    EditCoubPopup.prototype.close = function() {
      EditCoubPopup.__super__.close.apply(this, arguments);
      return $(document).trigger("flash_player:play");
    };

    return EditCoubPopup;

  })(window.AbstractAfterCreatePopup);

}).call(this);

/*
  Форма регистрации по мейлу
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.EmailRegistrationForm = (function(superClass) {
    extend(EmailRegistrationForm, superClass);

    EmailRegistrationForm.ATTR_NAME = "widget-email-registration-form";

    EmailRegistrationForm.prototype.DT = "widgets.EmailRegistrationForm";

    function EmailRegistrationForm(el, authpopup, blockSignUp) {
      this.el = el;
      this.authpopup = authpopup;
      this.blockSignUp = blockSignUp;
      this.getErrorMsgContainer = bind(this.getErrorMsgContainer, this);
      this.errorMailAlreadyUsed = bind(this.errorMailAlreadyUsed, this);
      this.hideErrorMsg = bind(this.hideErrorMsg, this);
      this.showErrorMsg = bind(this.showErrorMsg, this);
      this.validationInit = bind(this.validationInit, this);
      this.submitHandler = bind(this.submitHandler, this);
      EmailRegistrationForm.__super__.constructor.apply(this, arguments);
      console.log(this.DT, "Init.");
      this.isUnloggedIndex = this.authpopup === void 0;
      this.submitbtn = this.el.find("[submit]");
      this.submitbtn.on("click", this.submitHandler);
      this.passwInput = this.el.find("[name=password]");
      this.emailInput = this.el.find("[name=email]");
      this.el.find("input").asEventStream("keyup").filter((function(_this) {
        return function(e) {
          return e.which === Utils.KEY_CODES.ENTER;
        };
      })(this)).onValue(this.submitHandler);
      new AuthPopup.Handlers.PasswordStrengthChecker({
        el: this.passwInput.parent()
      });
      this.validationInit();
      this.reCaptchaInit();
    }

    EmailRegistrationForm.prototype.submitHandler = function(e) {
      e.preventDefault();
      this.hideErrorMsg();
      if (this.hasReCaptcha) {
        if (this.reCaptchaId == null) {
          return this.showErrorMsg("reCAPTCHA failed");
        }
        grecaptcha.reset(this.reCaptchaId);
        return grecaptcha.execute(this.reCaptchaId);
      } else {
        return this.submit();
      }
    };

    EmailRegistrationForm.prototype.submit = function(captchaToken) {
      var data, provider, rd;
      console.log(this.DT, "Submit btn clicked.");
      if (!this.el.valid()) {
        return;
      }
      data = {
        email: this.emailInput.val(),
        name: this.el.find("[name=name]").val(),
        password: this.passwInput.val(),
        captcha: captchaToken
      };
      rd = new siteData.RegistrationData();
      rd.fillData(data);
      if (this.authpopup != null) {
        return this.authpopup.signupForm.signup(rd.get("collectedData"));
      } else {
        provider = new LoginDataProvider();
        return provider.signupLogic(rd.get("collectedData"), false, void 0, false, {
          beforeSignup: (function(_this) {
            return function() {
              return _this.blockSignUp.showLoader();
            };
          })(this),
          afterSignup: (function(_this) {
            return function(resp) {
              var dialog;
              if (_this.isUnloggedIndex) {
                AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.SUCCESS + '_fromIndex');
              }
              dialog = AuthPopup.Base.constructAuthDialog("sign_up");
              dialog.moveToPageById("follow-channels-page", false);
              return _this.blockSignUp.hideLoader();
            };
          })(this),
          error: (function(_this) {
            return function(resp) {
              if (_this.isUnloggedIndex) {
                AmplitudeCoub.track(AmplitudeCoub.SIGN_UP_FORM.SERVER_ERROR + '_fromIndex');
              }
              _this.blockSignUp.hideLoader();
              return ErrorMessages.internalServerError();
            };
          })(this)
        });
      }
    };

    EmailRegistrationForm.prototype.validationInit = function() {
      return this.el.validate({
        rules: {
          email: {
            required: true,
            clearance_0_16_email: true,
            remote: function() {
              return {
                async: false,
                url: "/check_email",
                type: "GET",
                data: {}
              };
            }
          },
          password: {
            required: true,
            minlength: 2,
            normalOrStrongPassword: true
          },
          name: {
            required: true
          }
        },
        onkeyup: false,
        onsubmit: false,
        ignore: "",
        errorPlacement: (function(_this) {
          return function(error, element) {
            if (element.is("input[name=email]")) {
              return _this.showErrorMsg(error[0].innerHTML);
            }
          };
        })(this),
        success: (function(_this) {
          return function(label) {
            if (label[0].htmlFor === "email") {
              _this.hideErrorMsg();
              return _this.emailInput.removeClass("error");
            }
          };
        })(this),
        messages: {
          email: {
            remote: this.errorMailAlreadyUsed(AuthPopupI18n.FORM_VALIDATION.ERROR_MSGS.ALREADY_REGISTERED_EMAIL, 'sign_in')
          }
        }
      });
    };

    EmailRegistrationForm.prototype.showErrorMsg = function(msg) {
      this.getErrorMsgContainer().show().html(msg);
      return ToggleRegistration.construct(this.el);
    };

    EmailRegistrationForm.prototype.hideErrorMsg = function() {
      return this.getErrorMsgContainer().html('').hide();
    };

    EmailRegistrationForm.prototype.errorMailAlreadyUsed = function(msg, action) {
      return helpers.Auth.errorMailAlreadyUsed(msg, action, this.authpopup != null);
    };

    EmailRegistrationForm.prototype.getErrorMsgContainer = function() {
      return $(".-error-text", this.el);
    };

    EmailRegistrationForm.prototype.reCaptchaInit = function() {
      var reCaptchaEl;
      reCaptchaEl = this.el.find(".registration-form__captcha").get(0);
      this.hasReCaptcha = reCaptchaEl != null;
      if (!this.hasReCaptcha) {
        return;
      }
      window.EmailRegistrationFormCaptchaOnLoad = (function(_this) {
        return function() {
          return _this.reCaptchaId = grecaptcha.render(reCaptchaEl, {
            sitekey: "6Ld-QzEUAAAAABCqiSmZhIkoDnp3OjL2Ipb__2Fe",
            size: "invisible",
            callback: _this.submit.bind(_this)
          }, false);
        };
      })(this);
      return $.getScript("https://www.google.com/recaptcha/api.js?onload=EmailRegistrationFormCaptchaOnLoad&render=explicit");
    };

    return EmailRegistrationForm;

  })(abstract.Object);

}).call(this);

/*
  Кнопка фоллоу.

  Позволяет зафоловить канал от группы своих каналов.

  У кнопки должен быть аттрибут channel-id который содержит
  в себе идентификатор канала который нужно зафоловить.

  У кнопки должен быть аттрибут following который может содержать
  два значения

  У кнопки может быть аттрибут from-id который содержит
  в себе идентификатор канала от которого нужно зафоловить.
  Если этот атрибут не указан тогда фоловинг будет совершен
  от текущего активного канала.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.FollowButton = (function() {
    FollowButton.EVENTS = {
      FOLLOWED: "widgets.FollowButton:Follow",
      UNFOLLOWED: "widgets.FollowButton:Unfollow",
      UNLOGED_FOLLOW: UnlogedAction.ACTION_PREFIX + "follow",
      FOLLOW_COMPLETED: "widgets.FollowButton:Element:FollowCompleted",
      ELEMENT: {
        FOLLOWED: "widgets.FollowButton:Element:Follow",
        UNFOLLOWED: "widgets.FollowButton:Element:Unfollow"
      }
    };

    FollowButton.ACTIONS = {
      FOLLOW: "widgets.FollowButton:Action:Follow",
      UNFOLLOW: "widgets.FollowButton:Action:Unfollow"
    };

    FollowButton.ATTR_NAME = "widget-follow-button";

    function FollowButton(el) {
      this.unfollow = bind(this.unfollow, this);
      this.follow = bind(this.follow, this);
      this.mouseleave = bind(this.mouseleave, this);
      this.mouseenter = bind(this.mouseenter, this);
      this.toggle = bind(this.toggle, this);
      this.onChannelIdChanged = bind(this.onChannelIdChanged, this);
      this.onDocUnfollowed = bind(this.onDocUnfollowed, this);
      this.onDocFollowed = bind(this.onDocFollowed, this);
      this.el = $(el);
      this.text = this.el.find('span.text');
      this.container = this.el.closest('.follow-button__container');
      this.EVENTS = widgets.FollowButton.EVENTS;
      this.ACTIONS = widgets.FollowButton.ACTIONS;
      this.provider = new dataProviders.ApiV2();
      this.xhrLock = false;
      this.channelId = this.el.attr('data-channel-id');
      this.fromId = this.el.attr('data-from-id');
      this.isFollowing = this.el.hasClass('following');
      if (!this.fromId) {
        this.fromId = Params.get('current_channel_id').toString();
        $(document).on(Params.EVENT_PARTICULAR_PARAM_CHANGED('current_channel_id'), this.onChannelIdChanged);
      }
      this.el.toggleClass('disabled', this.fromId === this.channelId);
      this.el.on('click', this.toggle);
      this.el.on('mouseenter', this.mouseenter);
      this.el.on('mouseleave', this.mouseleave);
      this.el.on(this.EVENTS.UNLOGED_FOLLOW, this.follow);
      this.el.on(this.ACTIONS.FOLLOW, (function(_this) {
        return function(e, silent) {
          if (silent) {
            _this.updateState(_this.fromId, true);
            return _this.triggerUpdate(_this.fromId, true);
          } else {
            return _this.follow;
          }
        };
      })(this));
      this.el.on(this.ACTIONS.UNFOLLOW, (function(_this) {
        return function(e, silent) {
          if (silent) {
            _this.updateState(_this.fromId, false);
            return _this.triggerUpdate(_this.fromId, false);
          } else {
            return _this.unfollow;
          }
        };
      })(this));
      this.el.on("dom_remove", (function(_this) {
        return function() {
          return $(document).off(_this.EVENTS.FOLLOWED, _this.onDocFollowed).off(_this.EVENTS.UNFOLLOWED, _this.onDocUnfollowed).off(Params.EVENT_PARTICULAR_PARAM_CHANGED('current_channel_id'), _this.onChannelIdChanged);
        };
      })(this));
      $(document).on(this.EVENTS.FOLLOWED, this.onDocFollowed).on(this.EVENTS.UNFOLLOWED, this.onDocUnfollowed);
    }

    FollowButton.prototype.onDocFollowed = function(e) {
      if (e.targetId !== this.channelId || e.performerId !== this.fromId) {
        return;
      }
      return this.updateState(e.performerId, true);
    };

    FollowButton.prototype.onDocUnfollowed = function(e) {
      if (e.targetId !== this.channelId || e.performerId !== this.fromId) {
        return;
      }
      return this.updateState(e.performerId, false);
    };

    FollowButton.prototype.onChannelIdChanged = function() {
      this.fromId = Params.get('current_channel_id').toString();
      return this.el.toggleClass('disabled', this.fromId === this.channelId);
    };

    FollowButton.prototype.toggle = function() {
      if (this.el.hasClass('disabled')) {
        return;
      }
      if (!this.isFollowing) {
        return this.follow();
      } else {
        return this.unfollow();
      }
    };

    FollowButton.prototype.mouseenter = function() {
      if (this.isFollowing) {
        this.el.addClass('unfollow');
        return this.setText(I18n.t("profile.unfollow"));
      }
    };

    FollowButton.prototype.mouseleave = function() {
      if (this.isFollowing) {
        this.setText(I18n.t("profile.following"));
      } else {
        this.setText(I18n.t("profile.follow"));
      }
      return this.el.removeClass('unfollow');
    };

    FollowButton.prototype.setText = function(newText) {
      return this.text.text(newText);
    };

    FollowButton.prototype.follow = function() {
      var fromId;
      if (!this.xhrLock && !this.isFollowing) {
        this.xhrLock = true;
        fromId = this.fromId;
        this.updateState(fromId, true);
        this.triggerUpdate(fromId, true);
        return this.provider.follow(fromId, this.channelId, {
          error: (function(_this) {
            return function(r) {
              if (r.status !== 422) {
                if (!helpers.Application.handle429StatusError(r, "follow")) {
                  ErrorMessages.internalServerError();
                }
                _this.updateState(_this.fromId, false);
                return _this.triggerUpdate(_this.fromId, false);
              }
            };
          })(this),
          complete: (function(_this) {
            return function() {
              _this.xhrLock = false;
              return Stats.track('follow_occured', {
                channel_id: _this.channelId,
                page: window.location.href
              });
            };
          })(this)
        });
      }
    };

    FollowButton.prototype.unfollow = function() {
      var fromId;
      if (!this.xhrLock && this.isFollowing) {
        this.xhrLock = true;
        fromId = this.fromId;
        this.updateState(fromId, false);
        this.triggerUpdate(fromId, false);
        return this.provider.unfollow(fromId, this.channelId, {
          error: (function(_this) {
            return function(r) {
              if (!helpers.Application.handle429StatusError(r, "follow")) {
                ErrorMessages.internalServerError();
              }
              _this.updateState(fromId, true);
              return _this.triggerUpdate(fromId, true);
            };
          })(this),
          complete: (function(_this) {
            return function() {
              _this.xhrLock = false;
              return Stats.track('follow_occured', {
                channel_id: _this.channelId,
                page: window.location.href
              });
            };
          })(this)
        });
      }
    };

    FollowButton.prototype.updateState = function(fromId, isFollowing) {
      if (this.isFollowing === isFollowing) {
        return;
      }
      this.isFollowing = isFollowing;
      this.el.toggleClass('-on following', isFollowing).removeClass('unfollow');
      this.container.toggleClass('following', isFollowing);
      if (isFollowing) {
        this.setText(I18n.t('profile.following'));
        return this.el.trigger(this.EVENTS.ELEMENT.FOLLOWED);
      } else {
        this.setText(I18n.t('profile.follow'));
        return this.el.trigger(this.EVENTS.ELEMENT.UNFOLLOWED);
      }
    };

    FollowButton.prototype.triggerUpdate = function(fromId, isFollowing) {
      return $(document).trigger({
        type: isFollowing && this.EVENTS.FOLLOWED || this.EVENTS.UNFOLLOWED,
        targetId: this.channelId,
        performerId: this.fromId
      });
    };

    FollowButton.prototype.triggerCompleted = function() {
      return $(document).trigger({
        type: this.EVENTS.FOLLOW_COMPLETED,
        targetId: this.channelId
      });
    };

    return FollowButton;

  })();

}).call(this);

/*
  Инит кнопки Follow
  Содержит id канала, который будет фолловиться
  Если у юзера больше одного канала, создается абсолютный дропдаун
 */

(function() {
  widgets.WidgetFollowButtonInit = (function() {
    WidgetFollowButtonInit.ATTR_NAME = "widget-follow-button-init";

    function WidgetFollowButtonInit(el) {
      var followBtn, opts, usersList;
      this.el = el;
      this.el = $(this.el);
      opts = {
        channelId: this.el.attr('data-channel-id'),
        following: this.el.attr('data-following') === 'true',
        classes: this.el.attr('data-btn-cls'),
        ddClasses: this.el.attr('data-dd-cls')
      };
      usersList = Params.getBranchValue("current_user.channels") || [];
      if (!Params.get('is_logged_in')) {
        followBtn = JST['app/site/templates/widgets/buttons/simple_button']({
          classes: "-st -rn -follow toggle-registration " + opts.classes,
          attrs: "data-unloged-action-selector=\".sb.-follow[data-channel-id='" + opts.channelId + "']\" data-unloged-action='follow' data-action='sign_up'",
          value: "<span class=\"text\">" + (I18n.t('profile.follow')) + "</span>"
        });
        this.el.append("<div class=\"follow-btn\">" + followBtn + "</div>");
        ToggleRegistration.construct(this.el);
      } else if (usersList.length > 1) {
        opts.followedFrom = this.el.attr('data-followed-from');
        this.el.html(JST['app/site/templates/widgets/follow_button/follow_button_multi'](opts));
        chms.utils.Autoinit.init(widgets.FollowButtonMulti, this.el);
      } else if (opts.channelId !== Params.get('current_channel_id').toString()) {
        this.el.append(JST['app/site/templates/widgets/follow_button/follow_button_single'](opts));
        chms.utils.Autoinit.init(widgets.FollowButtonSingle, this.el);
      }
    }

    return WidgetFollowButtonInit;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.FollowButtonMulti = (function(superClass) {
    extend(FollowButtonMulti, superClass);

    function FollowButtonMulti(el) {
      this.toggle = bind(this.toggle, this);
      this.onDocUnfollowed = bind(this.onDocUnfollowed, this);
      this.onDocFollowed = bind(this.onDocFollowed, this);
      var followedArray, isFollowsPredefined;
      FollowButtonMulti.__super__.constructor.apply(this, arguments);
      this.followedFrom = {};
      isFollowsPredefined = this.el.attr('data-followed-from') != null;
      this.dropdownHandler = this.container.find('.dropdown__handler');
      if (isFollowsPredefined && (followedArray = this.el.attr('data-followed-from'))) {
        this.updateFollows(followedArray.split(','));
      }
      this.channelsDD = new blocks.MyChannelsListDropdown({
        followInstance: this,
        userChannels: helpers.Channel.presentChannels(),
        followedFrom: this.followedFrom,
        isFollowsPredefined: isFollowsPredefined,
        channelId: this.channelId,
        el: this.container,
        handle: this.dropdownHandler,
        handleEventOpen: HoverableClickableAbsoluteDropdown.EVENTS.OPEN,
        dropdownClass: ControlableAbsoluteDropdown,
        dropdownPosition: AbsoluteDropdown.POSITION_TYPE.ABSOLUTE_BOTTOM,
        dropdownCssClass: this.el.attr('data-dd-cls')
      });
    }

    FollowButtonMulti.prototype.onDocFollowed = function(e) {
      if (e.targetId !== this.channelId) {
        return;
      }
      return this.updateState(e.performerId, true);
    };

    FollowButtonMulti.prototype.onDocUnfollowed = function(e) {
      if (e.targetId !== this.channelId) {
        return;
      }
      return this.updateState(e.performerId, false);
    };

    FollowButtonMulti.prototype.toggle = function() {
      if (this.el.hasClass('disabled')) {
        return;
      }
      if (!this.isFollowing) {
        return this.follow();
      } else {
        return this.channelsDD.dropdown.handle.click();
      }
    };

    FollowButtonMulti.prototype.updateState = function(fromId, isFollowing) {
      if (isFollowing) {
        this.followedFrom[fromId] = void 0;
        if (_.size(this.followedFrom) === 1) {
          return FollowButtonMulti.__super__.updateState.apply(this, arguments);
        }
      } else {
        delete this.followedFrom[fromId];
        if (_.size(this.followedFrom) === 0) {
          return FollowButtonMulti.__super__.updateState.apply(this, arguments);
        }
      }
    };

    FollowButtonMulti.prototype.updateFollows = function(channelIds) {
      return this.followedFrom = _.object(channelIds, []);
    };

    FollowButtonMulti.prototype.triggerUpdate = function() {
      FollowButtonMulti.__super__.triggerUpdate.apply(this, arguments);
      return this.triggerCompleted();
    };

    return FollowButtonMulti;

  })(widgets.FollowButton);

}).call(this);
(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.FollowButtonSingle = (function(superClass) {
    extend(FollowButtonSingle, superClass);

    function FollowButtonSingle() {
      return FollowButtonSingle.__super__.constructor.apply(this, arguments);
    }

    FollowButtonSingle.prototype.triggerUpdate = function() {
      FollowButtonSingle.__super__.triggerUpdate.apply(this, arguments);
      return this.triggerCompleted();
    };

    return FollowButtonSingle;

  })(widgets.FollowButton);

}).call(this);

/*
  Абстрактный класс для каунтера фолловеров и фолловингов.

  Виджет должен иметь аттрибут data-id который содержит идентификатор пользователя
  для которого этот каунтер создан.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.FollowingFollowersCounterAbstract = (function(superClass) {
    extend(FollowingFollowersCounterAbstract, superClass);

    function FollowingFollowersCounterAbstract(el) {
      this.el = el;
      this.showIfNotZeroOrHide = bind(this.showIfNotZeroOrHide, this);
      this.onUnfollow = bind(this.onUnfollow, this);
      this.onFollow = bind(this.onFollow, this);
      FollowingFollowersCounterAbstract.__super__.constructor.apply(this, arguments);
      this.ownerId = this.el.attr("data-id");
      $(document).bind(widgets.FollowButton.EVENTS.FOLLOWED, this.onFollow);
      $(document).bind(widgets.FollowButton.EVENTS.UNFOLLOWED, this.onUnfollow);
    }

    FollowingFollowersCounterAbstract.prototype.onFollow = function(e) {
      return console.warn("widgets.FollowingFollowersCounterAbstract: implement onFollow method");
    };

    FollowingFollowersCounterAbstract.prototype.onUnfollow = function(e) {
      return console.warn("widgets.FollowingFollowersCounterAbstract: implement onUnfollow method");
    };

    FollowingFollowersCounterAbstract.prototype.showIfNotZeroOrHide = function() {
      return null;
    };

    return FollowingFollowersCounterAbstract;

  })(widgets.Counter);

}).call(this);

/*
  Виджет каунтера фолловеров.

  Реагирует на события widgets.FollowButton.EVENTS.FOLLOWED и widgets.FollowButton.EVENTS.UNFOLLOWED
  где user-id = идентификатору на кнопке.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.FollowersCounter = (function(superClass) {
    extend(FollowersCounter, superClass);

    function FollowersCounter() {
      this.onUnfollow = bind(this.onUnfollow, this);
      this.onFollow = bind(this.onFollow, this);
      return FollowersCounter.__super__.constructor.apply(this, arguments);
    }

    FollowersCounter.ATTR_NAME = "widget-followers-counter";

    FollowersCounter.prototype.onFollow = function(e) {
      if (e.targetId === this.ownerId) {
        return this.increase();
      }
    };

    FollowersCounter.prototype.onUnfollow = function(e) {
      if (e.targetId === this.ownerId) {
        return this.decrease();
      }
    };

    return FollowersCounter;

  })(widgets.FollowingFollowersCounterAbstract);

}).call(this);

/*
  Каунтер для фолловинга.

  Реагирует на события widgets.FollowButton.EVENTS.FOLLOWED и widgets.FollowButton.EVENTS.UNFOLLOWED
  где performerId = текущий юзер
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.FollowingCounter = (function(superClass) {
    extend(FollowingCounter, superClass);

    function FollowingCounter() {
      this.getCurrentChannelId = bind(this.getCurrentChannelId, this);
      this.onUnfollow = bind(this.onUnfollow, this);
      this.onFollow = bind(this.onFollow, this);
      return FollowingCounter.__super__.constructor.apply(this, arguments);
    }

    FollowingCounter.ATTR_NAME = "widget-following-counter";

    FollowingCounter.prototype.onFollow = function(e) {
      if (this.getCurrentChannelId() === this.ownerId) {
        return this.increase();
      }
    };

    FollowingCounter.prototype.onUnfollow = function(e) {
      if (this.getCurrentChannelId() === this.ownerId) {
        return this.decrease();
      }
    };

    FollowingCounter.prototype.getCurrentChannelId = function() {
      var v;
      if ((v = Params.get("current_channel_id")) != null) {
        return v.toString();
      } else {
        return "";
      }
    };

    return FollowingCounter;

  })(widgets.FollowingFollowersCounterAbstract);

}).call(this);
(function() {
  widgets.FriendsBanner = (function() {
    FriendsBanner.ATTR_NAME = "widget-friends-banner";

    function FriendsBanner(el) {
      var $el, provider;
      $el = $(el);
      provider = $el.attr('data-provider');
      $el.find('.close-small').click(function() {
        var exp;
        exp = new Date();
        exp.setTime(exp.getTime() + 10 * 365 * 86400 * 1000);
        $.cookie('closed_friends_banner', '1', {
          expires: exp,
          path: '/'
        });
        $el.addClass('-hidden');
        Stats.track('timeline_auth_banner_closed', {
          kind: provider
        });
        return false;
      });
      $el.on('click', function() {
        var success;
        success = function() {
          Stats.track('timeline_auth_banner_authorized', {
            kind: provider
          }, true);
          return location.href = Routes.find_friends_path(provider);
        };
        new AuthDataProvider().addAuthFullCycle(AuthDataProvider.KIND[provider.toUpperCase()], Params.get('current_channel_id'), success, $.noop);
        return Stats.track('timeline_auth_banner_clicked', {
          kind: provider
        });
      });
      $(document).on(clientsideTimeline.ClientsideTimeline.EVENT_FIRST_PAGE_LOADED, function() {
        $el.removeClass('find-friends-banner--hidden');
        return Stats.track('timeline_auth_banner_showed', {
          kind: provider
        });
      });
    }

    return FriendsBanner;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.hints.Dropdown = (function() {
    Dropdown.prototype.STORAGE_KEY = void 0;

    Dropdown.TIMING = 200;

    function Dropdown(el) {
      this.el = el;
      this.getTemp = bind(this.getTemp, this);
      this.get = bind(this.get, this);
      this.set = bind(this.set, this);
      this.initDropdown = bind(this.initDropdown, this);
      this.positionHint = bind(this.positionHint, this);
      this.showHint = bind(this.showHint, this);
      this.locales = this.el.attr('widget-hint-locales');
      this.position = this.el.attr('widget-hint-position');
      this.key = this.el.attr('hint-storage-key');
      this.opts = {
        locales: this.locales,
        position: this.position.split(' '),
        key: this.key
      };
      $(window).on('resize', (function(_this) {
        return function() {
          return _this.positionHint(_this.el.offset(), _this.opts.position[0]);
        };
      })(this));
    }

    Dropdown.prototype.showHint = function(offset, opts) {
      this.dropdown = this.getTemp(opts);
      $('body').append(this.dropdown);
      return this.positionHint(offset, opts.position[0]);
    };

    Dropdown.prototype.positionHint = function(offset, pos) {
      var dWH, hWH, left, setPosition, shift, top;
      top = offset.top;
      left = offset.left;
      hWH = [this.el.outerWidth(), this.el.outerHeight()];
      dWH = [this.dropdown.outerWidth(), this.dropdown.outerHeight()];
      shift = 15;
      setPosition = (function(_this) {
        return function(top, left) {
          _this.dropdown.css({
            top: top,
            left: left
          }).removeClass('-hidden');
          return setTimeout(function() {
            _this.dropdown.addClass('-showed');
            return _this.initDropdown(_this.dropdown);
          }, widgets.hints.Dropdown.TIMING);
        };
      })(this);
      switch (pos) {
        case 'top':
          top = top - dWH[1] - shift;
          break;
        case 'top-center':
          top = top - dWH[1] - shift;
          left = left - (dWH[0] / 2) + (hWH[0] / 2);
          break;
        case 'below-center':
          top += hWH[1] + shift;
          left = left - (dWH[0] / 2) + (hWH[0] / 2);
          break;
        case 'below':
          top += hWH[1] + shift;
          break;
        case 'left':
          left = left - dWH[0] - shift;
          break;
        case 'right':
          left += hWH[0] + shift;
      }
      return setPosition(top, left);
    };

    Dropdown.prototype.initDropdown = function(dropdown) {
      var btn;
      btn = $('.sb.-blue', dropdown);
      return btn.add(this.el).one('click', (function(_this) {
        return function(e) {
          e.preventDefault();
          dropdown.removeClass('-showed');
          setTimeout(function() {
            return dropdown.remove();
          }, widgets.hints.Dropdown.TIMING);
          if (_this.get() == null) {
            return _this.set();
          }
        };
      })(this));
    };

    Dropdown.prototype.set = function() {
      return $.storage.set(this.STORAGE_KEY, true);
    };

    Dropdown.prototype.get = function() {
      return $.storage.get(this.STORAGE_KEY);
    };

    Dropdown.prototype.getTemp = function(opts) {
      var content, locales;
      locales = JSON.parse(opts.locales);
      content = " <h4>" + locales.heading + "</h4>\n<p>" + locales.sub + "</p>\n<button class='sb -rn -push-sdh -blue' type='button'>\n  " + (I18n.t("guide.button")) + "\n</button>";
      return $(JST['app/site/templates/widgets/absolute_dropdown/absolute_dropdown']({
        content: content,
        classes: "dropdown--guide -absolute -" + (opts.position.join(' '))
      }));
    };

    return Dropdown;

  })();

}).call(this);
(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.hints.HintHandler = (function(superClass) {
    extend(HintHandler, superClass);

    HintHandler.ATTR_NAME = "widget-hint-handler";

    function HintHandler(el) {
      this.el = el;
      HintHandler.__super__.constructor.apply(this, arguments);
      this.STORAGE_KEY = this.el.attr('hint-storage-key');
      this.showHint(this.el.offset(), this.opts);
    }

    return HintHandler;

  })(widgets.hints.Dropdown);

}).call(this);
(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.hints.SimpleHint = (function(superClass) {
    extend(SimpleHint, superClass);

    SimpleHint.ATTR_NAME = "widget-simple-hint";

    function SimpleHint(el) {
      this.el = el;
      SimpleHint.__super__.constructor.apply(this, arguments);
      this.STORAGE_KEY = this.el.attr('hint-storage-key');
      this.showHint(this.el.offset(), this.opts);
    }

    SimpleHint.setHint = function(opts) {
      $(opts.el).attr({
        'widget-simple-hint': true,
        'auto-init': true,
        'hint-storage-key': opts.key,
        'widget-hint-position': opts.position,
        'widget-hint-locales': JSON.stringify(opts.locales)
      });
      return chms.utils.Autoinit.init(widgets.hints.SimpleHint);
    };

    return SimpleHint;

  })(widgets.hints.Dropdown);

}).call(this);

/*
  Абстрактный класс для кнопки лайка или рекоба.

  Элемент должен содержать параметр data-coub-id который указывает id коба.

  Если элемент содержать потомка с атрибутом [handler] то этот элемент используется
  как обработчик нажатия. В противном случае используется сам элемент.

  Элемент может содержать атрибут data-channel-id который указывает на id
  канала с которого необходимо совершить действие. Если этот атрибут не указан
  до он ставится в соответствии с текущим каналов и еще элементу добавляется атрибут
  bind-to-current-channel который означает что как только пользователь меняет текущий
  канал то идентификатор канала в виджете тоже изменится. Вообще этот data-channel-id
  нужен для того чтобы отбирать похожие виджеты в доме и обновлять их ui при
  рекобе или анрекобе с других виджетов.

  Если элемент содержит аттрибут container-selector тогда контейнер будет вычислен как
  родительский относительно этого используя данный селектор.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.AbstractLikeRecoubButton = (function() {
    AbstractLikeRecoubButton.ACTION_UPDATE_UI_ON_ACTION = "AbstractLikeRecoubButton:Actions:UpdateUiOnAction";

    AbstractLikeRecoubButton.ACTION_UPDATE_UI_ON_UNDO_ACTION = "AbstractLikeRecoubButton:Actions:UpdateUiOnUndoAction";

    function AbstractLikeRecoubButton(el) {
      var c;
      this.el = el;
      this.onActionComplete = bind(this.onActionComplete, this);
      this.getSimilarButtons = bind(this.getSimilarButtons, this);
      this.getErrorWhenUnsetMessage = bind(this.getErrorWhenUnsetMessage, this);
      this.getErrorWhenSetMessage = bind(this.getErrorWhenSetMessage, this);
      this.getProviderMethodForUndoAction = bind(this.getProviderMethodForUndoAction, this);
      this.getProviderMethodForAction = bind(this.getProviderMethodForAction, this);
      this.getPromptTextUndoAction = bind(this.getPromptTextUndoAction, this);
      this.getPromptTextAction = bind(this.getPromptTextAction, this);
      this.getProviderData = bind(this.getProviderData, this);
      this.bindToCurrentChannel = bind(this.bindToCurrentChannel, this);
      this.getChannelId = bind(this.getChannelId, this);
      this.updatePrompt = bind(this.updatePrompt, this);
      this.updateUiUndoAction = bind(this.updateUiUndoAction, this);
      this.updateUiAction = bind(this.updateUiAction, this);
      this.get429ErrorType = bind(this.get429ErrorType, this);
      this.isLike = bind(this.isLike, this);
      this.isDisabled = bind(this.isDisabled, this);
      this.isActionCommited = bind(this.isActionCommited, this);
      this.onErrorWhenUnset = bind(this.onErrorWhenUnset, this);
      this.onErrorWhenSet = bind(this.onErrorWhenSet, this);
      this.undoAction = bind(this.undoAction, this);
      this.makeAction = bind(this.makeAction, this);
      this.toggle = bind(this.toggle, this);
      this.ACTION_UPDATE_UI_ON_ACTION = widgets.AbstractLikeRecoubButton.ACTION_UPDATE_UI_ON_ACTION;
      this.ACTION_UPDATE_UI_ON_UNDO_ACTION = widgets.AbstractLikeRecoubButton.ACTION_UPDATE_UI_ON_UNDO_ACTION;
      this.locker = new chms.utils.Locker(this.el);
      this.provider = new dataProviders.ApiV2();
      this.permalink = this.el.attr("data-recoub-to-id") || this.el.attr("data-coub-id");
      if ((c = this.el.attr("container-selector")) != null) {
        this.container = this.el.parents(c);
      } else {
        this.container = this.el;
      }
      this.counter = $("[widget-counter]", this.container);
      this.icon = $("i", this.el);
      this.handler = $("[handler]", this.el);
      if (this.handler.size() === 0) {
        this.handler = this.el;
      }
      if (this.getChannelId() == null) {
        this.bindToCurrentChannel();
      }
      this.updatePrompt();
      this.handler.on("click", this.toggle);
      this.el.on(this.ACTION_UPDATE_UI_ON_ACTION, this.updateUiAction).on(this.ACTION_UPDATE_UI_ON_UNDO_ACTION, this.updateUiUndoAction);
    }

    AbstractLikeRecoubButton.prototype.toggle = function() {
      if (!this.isActionCommited()) {
        this.makeAction();
      } else {
        this.undoAction();
      }
      return true;
    };

    AbstractLikeRecoubButton.prototype.makeAction = function() {
      var similar, xhrLogic;
      if (!this.isActionCommited() && GlobalState.USER.isLogedIn() && !this.locker.isLocked() && !this.isDisabled()) {
        this.locker.lock();
        (similar = this.getSimilarButtons()).trigger(this.ACTION_UPDATE_UI_ON_ACTION);
        xhrLogic = {
          success: this.onActionComplete,
          error: (function(_this) {
            return function(e) {
              return _this.onErrorWhenSet(e, similar);
            };
          })(this),
          complete: this.locker.unlock
        };
        this.getProviderMethodForAction().apply(this, this.getProviderData().concat([xhrLogic]));
        return true;
      } else {
        return false;
      }
    };

    AbstractLikeRecoubButton.prototype.undoAction = function() {
      var similar, xhrLogic;
      if (this.isActionCommited() && GlobalState.USER.isLogedIn() && !this.locker.isLocked() && !this.isDisabled()) {
        this.locker.lock();
        (similar = this.getSimilarButtons()).trigger(this.ACTION_UPDATE_UI_ON_UNDO_ACTION);
        xhrLogic = {
          error: (function(_this) {
            return function(e) {
              return _this.onErrorWhenUnset(e, similar);
            };
          })(this),
          complete: this.locker.unlock
        };
        this.getProviderMethodForUndoAction().apply(this, this.getProviderData().concat([xhrLogic]));
        return true;
      } else {
        return false;
      }
    };

    AbstractLikeRecoubButton.prototype.onErrorWhenSet = function(e, similar) {
      var msg;
      if (!helpers.Application.handle429StatusError(e, this.get429ErrorType())) {
        msg = this.getErrorWhenSetMessage();
        Growl.msg(msg.header, msg.error_when_set);
      }
      return similar.trigger(this.ACTION_UPDATE_UI_ON_UNDO_ACTION);
    };

    AbstractLikeRecoubButton.prototype.onErrorWhenUnset = function(e, similar) {
      var msg;
      if (!helpers.Application.handle429StatusError(e, this.get429ErrorType())) {
        msg = this.getErrorWhenUnsetMessage();
        Growl.msg(msg.header, msg.error_when_set);
      }
      return similar.trigger(this.ACTION_UPDATE_UI_ON_ACTION);
    };

    AbstractLikeRecoubButton.prototype.isActionCommited = function() {
      return this.el.hasClass("-on");
    };

    AbstractLikeRecoubButton.prototype.isDisabled = function() {
      return this.el.attr("disabled") != null;
    };

    AbstractLikeRecoubButton.prototype.isLike = function() {
      return this.constructor === widgets.LikeButton;
    };

    AbstractLikeRecoubButton.prototype.get429ErrorType = function() {
      if (this.isLike()) {
        return "like";
      } else {
        return "recoub";
      }
    };

    AbstractLikeRecoubButton.prototype.updateUiAction = function() {
      this.counter.trigger(widgets.Counter.ACTIONS.INCREASE);
      this.el.addClass("-on");
      return this.updatePrompt();
    };

    AbstractLikeRecoubButton.prototype.updateUiUndoAction = function() {
      this.counter.trigger(widgets.Counter.ACTIONS.DECREASE);
      this.el.removeClass("-on");
      return this.updatePrompt();
    };

    AbstractLikeRecoubButton.prototype.updatePrompt = function() {
      var text;
      text = this.isActionCommited() ? this.getPromptTextUndoAction() : this.getPromptTextAction();
      return this.icon.triggerHandler(Prompt.EVENT_CHANGE_TEXT, text);
    };

    AbstractLikeRecoubButton.prototype.getChannelId = function() {
      return this.el.attr("data-channel-id");
    };

    AbstractLikeRecoubButton.prototype.bindToCurrentChannel = function() {
      var update;
      this.el.attr("bind-to-current-channel", "true");
      update = (function(_this) {
        return function() {
          if (!_this.el.attr("bind-to-current-channel")) {
            return;
          }
          return _this.el.attr("data-channel-id", Params.get("current_channel_id"));
        };
      })(this);
      $(document).on(Params.EVENT_PARTICULAR_PARAM_CHANGED("current_channel_id"), update);
      this.el.on("dom_remove", (function(_this) {
        return function() {
          return $(document).off(Params.EVENT_PARTICULAR_PARAM_CHANGED("current_channel_id"), update);
        };
      })(this));
      return update();
    };

    AbstractLikeRecoubButton.prototype.getProviderData = function() {
      return [this.permalink];
    };

    AbstractLikeRecoubButton.prototype.getPromptTextAction = function() {
      throw "widgets.AbstractLikeRecoubButton: implement getPromptTextUndoAction";
    };

    AbstractLikeRecoubButton.prototype.getPromptTextUndoAction = function() {
      throw "widgets.AbstractLikeRecoubButton: implement getPromptTextUndoAction";
    };

    AbstractLikeRecoubButton.prototype.getProviderMethodForAction = function() {
      throw "widgets.AbstractLikeRecoubButton: implement getProviderMethodForAction";
    };

    AbstractLikeRecoubButton.prototype.getProviderMethodForUndoAction = function() {
      throw "widgets.AbstractLikeRecoubButton: implement getProviderMethodForUndoAction";
    };

    AbstractLikeRecoubButton.prototype.getErrorWhenSetMessage = function() {
      throw "widgets.AbstractLikeRecoubButton: implement getErrorWhenSetMessage";
    };

    AbstractLikeRecoubButton.prototype.getErrorWhenUnsetMessage = function() {
      throw "widgets.AbstractLikeRecoubButton: implement getErrorWhenUnserMessage";
    };

    AbstractLikeRecoubButton.prototype.getSimilarButtons = function() {
      throw "widgets.AbstractLikeRecoubButton: implement getSimilarButtons";
    };

    AbstractLikeRecoubButton.prototype.onActionComplete = function() {
      return null;
    };

    return AbstractLikeRecoubButton;

  })();

}).call(this);

/*
  Кнопка дизлайка для коба.

  При нажатии на нее совершается действие.
  Если лайк уже был поставлен - снимает его.
  Если лайк не был поставлен - ставит его.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.DislikeButton = (function(superClass) {
    extend(DislikeButton, superClass);

    DislikeButton.ACTIONS = {
      TOGGLE_DISLIKE: "DislikeButton:Actions:ToggleDislike"
    };

    DislikeButton.EVENTS = {
      DISLIKE_POSTED: "DislikeButton:DislikePosted"
    };

    DislikeButton.ATTR_NAME = "widget-dislike-button";

    function DislikeButton(el) {
      this.el = el;
      this.onErrorWhenSet = bind(this.onErrorWhenSet, this);
      this.onActionComplete = bind(this.onActionComplete, this);
      this.getSimilarButtons = bind(this.getSimilarButtons, this);
      this.getErrorWhenUnsetMessage = bind(this.getErrorWhenUnsetMessage, this);
      this.getErrorWhenSetMessage = bind(this.getErrorWhenSetMessage, this);
      this.getProviderMethodForUndoAction = bind(this.getProviderMethodForUndoAction, this);
      this.getProviderMethodForAction = bind(this.getProviderMethodForAction, this);
      this.getPromptTextUndoAction = bind(this.getPromptTextUndoAction, this);
      this.getPromptTextAction = bind(this.getPromptTextAction, this);
      DislikeButton.__super__.constructor.apply(this, arguments);
      this.ACTIONS = widgets.DislikeButton.ACTIONS;
      this.EVENTS = widgets.DislikeButton.EVENTS;
      this.el.on(this.ACTIONS.TOGGLE_DISLIKE, this.toggle);
      chms.utils.Autoinit.init(widgets.WidgetListenerDislike, this.el.parent());
    }

    DislikeButton.prototype.getPromptTextAction = function() {
      return I18n.t('tooltips.dislike_button.dislike');
    };

    DislikeButton.prototype.getPromptTextUndoAction = function() {
      return I18n.t('tooltips.dislike_button.undislike');
    };

    DislikeButton.prototype.getProviderMethodForAction = function() {
      return this.provider.dislikeCoub;
    };

    DislikeButton.prototype.getProviderMethodForUndoAction = function() {
      return this.provider.undislikeCoub;
    };

    DislikeButton.prototype.getErrorWhenSetMessage = function() {
      return I18n.t("growl_errors.like");
    };

    DislikeButton.prototype.getErrorWhenUnsetMessage = function() {
      return I18n.t("growl_errors.unlike");
    };

    DislikeButton.prototype.getSimilarButtons = function() {
      var coubId, originalId, selectors;
      coubId = this.permalink;
      originalId = this.el.attr("data-recoub-to-id");
      selectors = [".coub__dislike-button[data-coub-id=" + originalId + "] > i", ".coub__dislike-button[data-recoub-to-id=" + coubId + "] > i", ".coub__dislike-button[data-coub-id=" + coubId + "] > i"];
      return $(selectors.join(", "));
    };

    DislikeButton.prototype.onActionComplete = function() {
      return this.el.trigger(this.EVENTS.DISLIKE_POSTED);
    };

    DislikeButton.prototype.onErrorWhenSet = function(e, similar) {
      var isExist;
      DislikeButton.__super__.onErrorWhenSet.apply(this, arguments);
      return;
      if (e.responseText != null) {
        isExist = e.responseText.indexOf("Channel like has already been posted") > -1;
      }
      if (!isExist) {
        return DislikeButton.__super__.onErrorWhenSet.apply(this, arguments);
      }
    };

    return DislikeButton;

  })(widgets.AbstractLikeRecoubButton);

}).call(this);

/*
  Кнопка лайка для коба.

  При нажатии на нее совершается действие.
  Если лайк уже был поставлен - снимает его.
  Если лайк не был поставлен - ставит его.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.LikeButton = (function(superClass) {
    extend(LikeButton, superClass);

    LikeButton.ACTIONS = {
      UNLOGED_LIKE: UnlogedAction.ACTION_PREFIX + "like",
      AUTOLIKE: "LikeButton:Actions:AutoLike",
      TOGGLE_LIKE: "LikeButton:Actions:ToggleLike"
    };

    LikeButton.EVENTS = {
      LIKE_POSTED: "LikeButton:LikePosted"
    };

    LikeButton.ATTR_NAME = "widget-like-button";

    function LikeButton(el) {
      this.el = el;
      this.onErrorWhenSet = bind(this.onErrorWhenSet, this);
      this.onActionComplete = bind(this.onActionComplete, this);
      this.getSimilarButtons = bind(this.getSimilarButtons, this);
      this.getErrorWhenUnsetMessage = bind(this.getErrorWhenUnsetMessage, this);
      this.getErrorWhenSetMessage = bind(this.getErrorWhenSetMessage, this);
      this.getProviderMethodForUndoAction = bind(this.getProviderMethodForUndoAction, this);
      this.getProviderMethodForAction = bind(this.getProviderMethodForAction, this);
      this.getPromptTextUndoAction = bind(this.getPromptTextUndoAction, this);
      this.getPromptTextAction = bind(this.getPromptTextAction, this);
      LikeButton.__super__.constructor.apply(this, arguments);
      this.ACTIONS = widgets.LikeButton.ACTIONS;
      this.EVENTS = widgets.LikeButton.EVENTS;
      this.el.on(this.ACTIONS.UNLOGED_LIKE + " " + this.ACTIONS.AUTOLIKE, this.makeAction).on(this.ACTIONS.TOGGLE_LIKE, this.toggle);
      chms.utils.Autoinit.init(widgets.WidgetListenerLike, this.el.parent());
    }

    LikeButton.prototype.getPromptTextAction = function() {
      return I18n.t('tooltips.like_button.like');
    };

    LikeButton.prototype.getPromptTextUndoAction = function() {
      return I18n.t('tooltips.like_button.unlike');
    };

    LikeButton.prototype.getProviderMethodForAction = function() {
      return this.provider.likeCoub;
    };

    LikeButton.prototype.getProviderMethodForUndoAction = function() {
      return this.provider.unlikeCoub;
    };

    LikeButton.prototype.getErrorWhenSetMessage = function() {
      return I18n.t("growl_errors.like");
    };

    LikeButton.prototype.getErrorWhenUnsetMessage = function() {
      return I18n.t("growl_errors.unlike");
    };

    LikeButton.prototype.getSimilarButtons = function() {
      var coubId, originalId, selectors;
      coubId = this.permalink;
      originalId = this.el.attr("data-recoub-to-id");
      selectors = [".coub__like-button[data-coub-id=" + originalId + "] > i", ".coub__like-button[data-recoub-to-id=" + coubId + "] > i", ".coub__like-button[data-coub-id=" + coubId + "] > i"];
      return $(selectors.join(", "));
    };

    LikeButton.prototype.onActionComplete = function() {
      this.el.parents("[coub-block]").trigger(CoubBlockClientside.ACTION_SHOW_LIKE_PANEL);
      this.el.trigger(this.EVENTS.LIKE_POSTED);
      Stats.track('like_occured', {
        permalink: this.permalink
      });
      return window.ym && ym(48571952, "reachGoal", "coub_like");
    };

    LikeButton.prototype.onErrorWhenSet = function(e, similar) {
      var isExist;
      if (e.responseText != null) {
        isExist = e.responseText.indexOf("Channel like has already been posted") > -1;
      }
      if (!isExist) {
        return LikeButton.__super__.onErrorWhenSet.apply(this, arguments);
      }
    };

    return LikeButton;

  })(widgets.AbstractLikeRecoubButton);

}).call(this);

/*
  Кнопка лайка для стори.

  При нажатии на нее совершается действие.
  Если лайк уже был поставлен - снимает его.
  Если лайк не был поставлен - ставит его.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.LikeStoryButton = (function(superClass) {
    extend(LikeStoryButton, superClass);

    LikeStoryButton.ACTIONS = {
      UNLOGED_LIKE: UnlogedAction.ACTION_PREFIX + "like_story",
      AUTOLIKE: "LikeStoryButton:Actions:AutoLike"
    };

    LikeStoryButton.EVENTS = {
      LIKE_POSTED: "LikeStoryButton:LikePosted"
    };

    LikeStoryButton.ATTR_NAME = "widget-like-story-button";

    function LikeStoryButton(el) {
      this.el = el;
      this.updateUiUndoAction = bind(this.updateUiUndoAction, this);
      this.updateUiAction = bind(this.updateUiAction, this);
      this.onChannelChange = bind(this.onChannelChange, this);
      this.onErrorWhenSet = bind(this.onErrorWhenSet, this);
      this.onActionComplete = bind(this.onActionComplete, this);
      this.getSimilarButtons = bind(this.getSimilarButtons, this);
      this.getErrorWhenUnsetMessage = bind(this.getErrorWhenUnsetMessage, this);
      this.getErrorWhenSetMessage = bind(this.getErrorWhenSetMessage, this);
      this.getProviderMethodForUndoAction = bind(this.getProviderMethodForUndoAction, this);
      this.getProviderMethodForAction = bind(this.getProviderMethodForAction, this);
      this.getPromptTextUndoAction = bind(this.getPromptTextUndoAction, this);
      this.getPromptTextAction = bind(this.getPromptTextAction, this);
      LikeStoryButton.__super__.constructor.apply(this, arguments);
      this.ACTIONS = widgets.LikeStoryButton.ACTIONS;
      this.EVENTS = widgets.LikeStoryButton.EVENTS;
      this.likedBy = JSON.parse($('> script', this.el).text() || '[]');
      this.el.on(this.ACTIONS.UNLOGED_LIKE + " " + this.ACTIONS.AUTOLIKE, this.makeAction);
      chms.utils.Autoinit.init(widgets.WidgetListenerLike, this.el.parent());
      $(document).on(Params.EVENT_PARTICULAR_PARAM_CHANGED('current_channel_id'), this.onChannelChange);
      this.onChannelChange();
      this.el.on("dom_remove", (function(_this) {
        return function() {
          return $(document).off(Params.EVENT_PARTICULAR_PARAM_CHANGED('current_channel_id'), _this.onChannelChange);
        };
      })(this));
    }

    LikeStoryButton.prototype.getPromptTextAction = function() {
      return I18n.t('tooltips.like_button.like');
    };

    LikeStoryButton.prototype.getPromptTextUndoAction = function() {
      return I18n.t('tooltips.like_button.unlike');
    };

    LikeStoryButton.prototype.getProviderMethodForAction = function() {
      return this.provider.likeStory;
    };

    LikeStoryButton.prototype.getProviderMethodForUndoAction = function() {
      return this.provider.unlikeStory;
    };

    LikeStoryButton.prototype.getErrorWhenSetMessage = function() {
      return I18n.t("growl_errors.like");
    };

    LikeStoryButton.prototype.getErrorWhenUnsetMessage = function() {
      return I18n.t("growl_errors.unlike");
    };

    LikeStoryButton.prototype.getSimilarButtons = function() {
      var coubId, selectors;
      coubId = this.permalink;
      selectors = [".story__like-button[data-coub-id=" + coubId + "] > i"];
      return $(selectors.join(", "));
    };

    LikeStoryButton.prototype.onActionComplete = function() {
      this.el.trigger(this.EVENTS.LIKE_POSTED);
      return Stats.track('like_occured', {
        permalink: this.permalink
      });
    };

    LikeStoryButton.prototype.onErrorWhenSet = function(e, similar) {
      return LikeStoryButton.__super__.onErrorWhenSet.apply(this, arguments);
    };

    LikeStoryButton.prototype.onChannelChange = function() {
      this.currentChannelId = parseInt(Params.get('current_channel_id'));
      return this.el.toggleClass('-on', this.likedBy.indexOf(this.currentChannelId) !== -1);
    };

    LikeStoryButton.prototype.updateUiAction = function() {
      LikeStoryButton.__super__.updateUiAction.apply(this, arguments);
      if (this.likedBy.indexOf(this.currentChannelId) === -1) {
        return this.likedBy.push(this.currentChannelId);
      }
    };

    LikeStoryButton.prototype.updateUiUndoAction = function() {
      var index;
      LikeStoryButton.__super__.updateUiUndoAction.apply(this, arguments);
      if ((index = this.likedBy.indexOf(this.currentChannelId)) !== -1) {
        return this.likedBy.splice(index, 1);
      }
    };

    return LikeStoryButton;

  })(widgets.AbstractLikeRecoubButton);

}).call(this);

/*
  Кнопка рекоба.

  При нажатии на нее совершается действие.
  Если рекоб не установлен то он ставится.
  Если уже был поставлен рекоб то он снимается (анрекоб).

  Если есть множество похожих контролов на странице (ссылаются на один
  коб, к примеру рекобы) и с одним из них произведенно действие
  тогда другие тоже обновятся.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.RecoubButton = (function(superClass) {
    extend(RecoubButton, superClass);

    RecoubButton.ACTIONS = {
      UNLOGED_RECOUB: UnlogedAction.ACTION_PREFIX + "recoub",
      AUTORECOUB: "RecoubButton:Actions:Autorecoub"
    };

    RecoubButton.EVENTS = {
      RECOUB_POSTED: "RecoubButton:Actions:RecoubPosted"
    };

    RecoubButton.ATTR_NAME = "widget-recoub-button";

    function RecoubButton(el) {
      this.el = el;
      this.onErrorWhenUnset = bind(this.onErrorWhenUnset, this);
      this.onErrorWhenSet = bind(this.onErrorWhenSet, this);
      this.onActionComplete = bind(this.onActionComplete, this);
      this.getSimilarButtons = bind(this.getSimilarButtons, this);
      this.getErrorWhenUnsetMessage = bind(this.getErrorWhenUnsetMessage, this);
      this.getErrorWhenSetMessage = bind(this.getErrorWhenSetMessage, this);
      this.getProviderData = bind(this.getProviderData, this);
      this.getProviderMethodForUndoAction = bind(this.getProviderMethodForUndoAction, this);
      this.getProviderMethodForAction = bind(this.getProviderMethodForAction, this);
      this.getPromptTextUndoAction = bind(this.getPromptTextUndoAction, this);
      this.getPromptTextAction = bind(this.getPromptTextAction, this);
      this.undoAction = bind(this.undoAction, this);
      this.makeAction = bind(this.makeAction, this);
      RecoubButton.__super__.constructor.apply(this, arguments);
      this.ACTIONS = widgets.RecoubButton.ACTIONS;
      this.EVENTS = widgets.RecoubButton.EVENTS;
      this.el.on(this.ACTIONS.UNLOGED_RECOUB + " " + this.ACTIONS.AUTORECOUB, this.makeAction);
    }

    RecoubButton.prototype.makeAction = function() {
      RecoubButton.__super__.makeAction.apply(this, arguments);
      if (this.container.find('[container-selector].-on').length) {
        return this.container.addClass('-on');
      }
    };

    RecoubButton.prototype.undoAction = function() {
      RecoubButton.__super__.undoAction.apply(this, arguments);
      if (this.container.find('[container-selector].-on').length === 0) {
        return this.container.removeClass('-on');
      }
    };

    RecoubButton.prototype.getPromptTextAction = function() {
      return I18n.t("tooltips.recoub_button.recoub");
    };

    RecoubButton.prototype.getPromptTextUndoAction = function() {
      return I18n.t("tooltips.recoub_button.undo_recoub");
    };

    RecoubButton.prototype.getProviderMethodForAction = function() {
      return this.provider.recoubToChannel;
    };

    RecoubButton.prototype.getProviderMethodForUndoAction = function() {
      return this.provider.undoRecoubFromChannel;
    };

    RecoubButton.prototype.getProviderData = function() {
      return [this.permalink, this.getChannelId()];
    };

    RecoubButton.prototype.getErrorWhenSetMessage = function() {
      return I18n.t("growl_errors.recoub");
    };

    RecoubButton.prototype.getErrorWhenUnsetMessage = function() {
      return I18n.t("growl_errors.unrecoub");
    };

    RecoubButton.prototype.getSimilarButtons = function() {
      return $("[" + widgets.RecoubButton.ATTR_NAME + "][data-coub-id=" + this.permalink + "][data-channel-id=" + (this.getChannelId()) + "]");
    };

    RecoubButton.prototype.onActionComplete = function() {
      this.el.trigger(this.EVENTS.RECOUB_POSTED);
      Stats.track('recoub_occured', {
        permalink: this.permalink
      });
      return window.ym && ym(48571952, "reachGoal", "coub_repost");
    };

    RecoubButton.prototype.onErrorWhenSet = function(e, similar) {
      var isExist;
      if (e.responseText != null) {
        isExist = e.responseText.indexOf("Channel has already been taken") > -1;
      }
      if (!isExist) {
        return RecoubButton.__super__.onErrorWhenSet.apply(this, arguments);
      }
    };

    RecoubButton.prototype.onErrorWhenUnset = function(e, similar) {
      var notExist;
      if (e.responseText != null) {
        notExist = e.responseText.indexOf("Couldn't find Coub::Recoub") > -1;
      }
      if (!notExist) {
        return RecoubButton.__super__.onErrorWhenUnset.apply(this, arguments);
      }
    };

    return RecoubButton;

  })(widgets.AbstractLikeRecoubButton);

}).call(this);

/*
  Кнопка репоста стори.

  При нажатии на нее совершается действие.
  Если репост не установлен то он ставится.
  Если уже был поставлен репост то он снимается (анрепост).

  Если есть множество похожих контролов на странице (ссылаются на один
  коб, к примеру репосты) и с одним из них произведенно действие
  тогда другие тоже обновятся.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.RepostStoryButton = (function(superClass) {
    extend(RepostStoryButton, superClass);

    RepostStoryButton.ACTIONS = {
      UNLOGED_RECOUB: UnlogedAction.ACTION_PREFIX + "repost_story",
      AUTORECOUB: "RepostStoryButton:Actions:Autorepost"
    };

    RepostStoryButton.EVENTS = {
      RECOUB_POSTED: "RepostStoryButton:Actions:RepostPosted"
    };

    RepostStoryButton.ATTR_NAME = "widget-repost-story-button";

    function RepostStoryButton(el) {
      this.el = el;
      this.onErrorWhenUnset = bind(this.onErrorWhenUnset, this);
      this.onErrorWhenSet = bind(this.onErrorWhenSet, this);
      this.onActionComplete = bind(this.onActionComplete, this);
      this.getSimilarButtons = bind(this.getSimilarButtons, this);
      this.getErrorWhenUnsetMessage = bind(this.getErrorWhenUnsetMessage, this);
      this.getErrorWhenSetMessage = bind(this.getErrorWhenSetMessage, this);
      this.getProviderData = bind(this.getProviderData, this);
      this.getProviderMethodForUndoAction = bind(this.getProviderMethodForUndoAction, this);
      this.getProviderMethodForAction = bind(this.getProviderMethodForAction, this);
      this.getPromptTextUndoAction = bind(this.getPromptTextUndoAction, this);
      this.getPromptTextAction = bind(this.getPromptTextAction, this);
      this.undoAction = bind(this.undoAction, this);
      this.makeAction = bind(this.makeAction, this);
      RepostStoryButton.__super__.constructor.apply(this, arguments);
      this.ACTIONS = widgets.RepostStoryButton.ACTIONS;
      this.EVENTS = widgets.RepostStoryButton.EVENTS;
      this.el.bind(this.ACTIONS.UNLOGED_RECOUB + " " + this.ACTIONS.AUTORECOUB, this.makeAction);
      chms.utils.Autoinit.init(widgets.WidgetListenerRecoub, this.el.parent());
    }

    RepostStoryButton.prototype.makeAction = function() {
      if (!this.icon.hasClass("own")) {
        RepostStoryButton.__super__.makeAction.apply(this, arguments);
        if (this.container.find('[container-selector].-on').length) {
          return this.container.addClass('-on');
        }
      }
    };

    RepostStoryButton.prototype.undoAction = function() {
      if (!this.icon.hasClass("own")) {
        RepostStoryButton.__super__.undoAction.apply(this, arguments);
        if (this.container.find('[container-selector].-on').length === 0) {
          return this.container.removeClass('-on');
        }
      }
    };

    RepostStoryButton.prototype.getPromptTextAction = function() {
      return I18n.t("tooltips.recoub_button.recoub");
    };

    RepostStoryButton.prototype.getPromptTextUndoAction = function() {
      return I18n.t("tooltips.recoub_button.undo_recoub");
    };

    RepostStoryButton.prototype.getProviderMethodForAction = function() {
      return this.provider.repostStoryToChannel;
    };

    RepostStoryButton.prototype.getProviderMethodForUndoAction = function() {
      return this.provider.undoRepostStoryFromChannel;
    };

    RepostStoryButton.prototype.getProviderData = function() {
      return [this.permalink, this.getChannelId()];
    };

    RepostStoryButton.prototype.getErrorWhenSetMessage = function() {
      return I18n.t("growl_errors.recoub");
    };

    RepostStoryButton.prototype.getErrorWhenUnsetMessage = function() {
      return I18n.t("growl_errors.unrecoub");
    };

    RepostStoryButton.prototype.getSimilarButtons = function() {
      return $("[" + widgets.RepostStoryButton.ATTR_NAME + "][data-coub-id=" + this.permalink + "][data-channel-id=" + (this.getChannelId()) + "]");
    };

    RepostStoryButton.prototype.onActionComplete = function() {
      this.el.trigger(this.EVENTS.RECOUB_POSTED);
      return Stats.track('recoub_occured', {
        permalink: this.permalink
      });
    };

    RepostStoryButton.prototype.onErrorWhenSet = function(e, similar) {
      var isExist;
      if (e.responseText != null) {
        isExist = e.responseText.indexOf("Channel has already been taken") > -1;
      }
      if (!isExist) {
        return RepostStoryButton.__super__.onErrorWhenSet.apply(this, arguments);
      }
    };

    RepostStoryButton.prototype.onErrorWhenUnset = function(e, similar) {
      var notExist;
      if (e.responseText != null) {
        notExist = e.responseText.indexOf("Couldn't find Coub::Recoub") > -1;
      }
      if (!notExist) {
        return RepostStoryButton.__super__.onErrorWhenUnset.apply(this, arguments);
      }
    };

    return RepostStoryButton;

  })(widgets.AbstractLikeRecoubButton);

}).call(this);

/*
  Список по которому можно навигировать клавишами
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.ListKeyNavigation = (function(superClass) {
    extend(ListKeyNavigation, superClass);

    ListKeyNavigation.ATTR_NAME = "widgets-list-key-navigation";

    ListKeyNavigation.ACTION_FOCUS = "widgets-ListKeyNavigation:Actions:Focus";

    ListKeyNavigation.ACTION_BLUR = "widgets-ListKeyNavigation:Actions:Blur";

    ListKeyNavigation.ACTION_UPDATE = "widgets-ListKeyNavigation:Actions:Update";

    ListKeyNavigation.prototype.DT = "widgets.ListKeyNavigation";

    function ListKeyNavigation(el1) {
      this.el = el1;
      this.draw = bind(this.draw, this);
      this.update = bind(this.update, this);
      this.getListEls = bind(this.getListEls, this);
      this.getLastIndex = bind(this.getLastIndex, this);
      this.keyPressed = bind(this.keyPressed, this);
      this.onBlur = bind(this.onBlur, this);
      this.onFocus = bind(this.onFocus, this);
      ListKeyNavigation.__super__.constructor.apply(this, arguments);
      this._data = new siteData.AbstractReactiveData({
        count: void 0,
        current: void 0
      });
      this.el.on(this.s.ACTION_FOCUS, this.onFocus);
      this.el.on(this.s.ACTION_BLUR, this.onBlur);
      this.el.on(this.s.ACTION_UPDATE, this.update);
      this._data.getFiltedStream(["current"]).onValue(this.draw);
    }

    ListKeyNavigation.prototype.onFocus = function() {
      this.update();
      return this._unbind = $(document).asEventStream("keydown").filter(function(e) {
        return [Utils.KEY_CODES.UP, Utils.KEY_CODES.DOWN].indexOf(e.keyCode) !== -1;
      }).map(function(e) {
        e.preventDefault();
        e.stopPropagation();
        return e.keyCode === Utils.KEY_CODES.UP;
      }).onValue(this.keyPressed);
    };

    ListKeyNavigation.prototype.onBlur = function() {
      if (this._unbind != null) {
        this._unbind();
      }
      return this._data.set("current", void 0);
    };

    ListKeyNavigation.prototype.keyPressed = function(isUp) {
      var v;
      if ((v = this._data.get("current")) != null) {
        if (isUp) {
          v -= 1;
          if (v < 0) {
            v = this.getLastIndex();
          }
        } else {
          v += 1;
          if (v > this.getLastIndex()) {
            v = 0;
          }
        }
        return this._data.set("current", v);
      } else {
        return this._data.set("current", 0);
      }
    };

    ListKeyNavigation.prototype.getLastIndex = function() {
      return Math.max(0, this._data.get("count") - 1);
    };

    ListKeyNavigation.prototype.getListEls = function() {
      return this.el.find("li").not("[disabled]");
    };

    ListKeyNavigation.prototype.update = function() {
      return this._data.set("count", this.getListEls().size());
    };

    ListKeyNavigation.prototype.draw = function() {
      var ci, nc;
      ci = this._data.get("current");
      this.el.find(".active:not(.selected)").removeClass("active");
      if (ci != null) {
        nc = $(this.el.find("li").not("[disabled]")[ci]);
        nc.addClass("active");
        if (this.el.hasClass("niceScroller")) {
          return nc.trigger("moveToItem", nc);
        }
      }
    };

    ListKeyNavigation.focusInEl = function(el) {
      return el.find("[" + widgets.ListKeyNavigation.ATTR_NAME + "]").trigger(widgets.ListKeyNavigation.ACTION_FOCUS);
    };

    ListKeyNavigation.blurInEl = function(el) {
      return el.find("[" + widgets.ListKeyNavigation.ATTR_NAME + "]").trigger(widgets.ListKeyNavigation.ACTION_BLUR);
    };

    return ListKeyNavigation;

  })(AbstractPiece);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.SubscribeToNotificationsButton = (function() {
    function SubscribeToNotificationsButton(opts) {
      this.opts = opts;
      this.onPermissionChanged = bind(this.onPermissionChanged, this);
      this.el = this.opts.el;
      if (!this.el || !this.el.length) {
        return;
      }
      if (!PushNotifications.isSupportedApi()) {
        this.el.remove();
        return;
      }
      this.isSubscribed = this.el.hasClass('-subscribed');
      this.promptEnable = I18n.t('notifications_button.enable');
      this.promptDisable = I18n.t('notifications_button.disable');
      this.pushController = new window.ChromePushNotifications();
      this.pushController.on(ChromePushNotifications.EVENTS.PERMISSION_CHANGED, this.onPermissionChanged);
      this.el.click((function(_this) {
        return function() {
          return _this.toggleSubscribe();
        };
      })(this));
      this.onPermissionChanged();
    }

    SubscribeToNotificationsButton.prototype.changeButtonPrompt = function(text) {
      return this.el.trigger({
        type: Prompt.EVENT_CHANGE_TEXT,
        content: text
      });
    };

    SubscribeToNotificationsButton.prototype.onPermissionChanged = function() {
      switch (this.pushController.permission) {
        case 'granted':
          this.el.addClass('-pushes-on');
          if (this.isSubscribed) {
            return this.changeButtonPrompt(this.promptDisable);
          }
          break;
        case 'denied':
        case 'default':
          this.el.addClass('-pushes-off').attr({
            top: 20
          });
          this.changeButtonPrompt(this.promptEnable);
          return new AbsoluteDropdown({
            classNames: 'notifications__pushes-tip',
            el: this.el,
            handle: this.el,
            defaultContent: this.getPushTipContent(),
            dropdownPosition: AbsoluteDropdown.POSITION_TYPE.ABSOLUTE_BOTTOM
          });
      }
    };

    SubscribeToNotificationsButton.prototype.getPushTipContent = function() {
      return "<div>\n  <h3>" + (I18n.t('notifications_button.pushes_tip.heading')) + "</h3>\n  <div class=\"image\"></div>\n  <button class=\"sb -st -rn -blue close\">" + (I18n.t('notifications_button.pushes_tip.button')) + "</button>\n</div>";
    };

    SubscribeToNotificationsButton.prototype.toggleSubscribe = function() {
      var method;
      if (this.isLoading) {
        return;
      }
      if (!this.pushController.permission) {
        return;
      }
      if (this.pushController.permission !== 'granted' && this.isSubscribed) {
        return;
      }
      this.isLoading = true;
      method = this.isSubscribed ? $.del : $.post;
      return method(this.opts.url, this.opts.url_params).done((function(_this) {
        return function(r) {
          _this.isSubscribed = !_this.isSubscribed;
          _this.el.toggleClass('-subscribed', _this.isSubscribed);
          return _this.changeButtonPrompt(_this.isSubscribed && _this.pushController.permission === 'granted' ? _this.promptDisable : _this.promptEnable);
        };
      })(this)).always((function(_this) {
        return function() {
          return _this.isLoading = false;
        };
      })(this)).fail((function(_this) {
        return function() {
          return Growl.msg(I18n.t('unknown_error'), '');
        };
      })(this));
    };

    return SubscribeToNotificationsButton;

  })();

}).call(this);
(function() {
  widgets.StoryCard = (function() {
    StoryCard.ATTR_NAME = 'widget-story-card';

    StoryCard.prototype.ACTION_RESIZE = 'StoryCard:Action:Resize';

    function StoryCard($el) {
      this.initPlayer($el);
      this.centerThumbnail($el);
      this.initVideoPreview($el);
      $el.on(this.ACTION_RESIZE, this.centerThumbnail.bind(this, $el));
    }

    StoryCard.prototype.initPlayer = function($el) {
      var $videoEl;
      if (GlobalState.PLATFORM.isMobile()) {
        return;
      }
      $videoEl = $("video", $el);
      if (!$videoEl.length) {
        return;
      }
      return this.mediaElement = new html5Player.MediaElementStrategy("video", true, $videoEl);
    };

    StoryCard.prototype.centerThumbnail = function($el) {
      var container, fitVertical, ratio;
      ratio = parseFloat($el.attr("data-thumbnail-ratio"));
      container = $('.story-card__preview', $el);
      fitVertical = (container.outerWidth() / container.outerHeight()) < ratio;
      return $el.toggleClass("-fit-height", fitVertical);
    };

    StoryCard.prototype.startPlay = function(e) {
      var size, src;
      if (!this.playerReady) {
        src = this.mediaElement.el.attr("src");
        size = parseInt(this.mediaElement.el.attr("data-size"));
        this.mediaElement.setSrc(src, size);
        this.playerReady = true;
        this.mediaElement.el.one("loadeddata", function() {
          return $(e.currentTarget).find(".story-card__img").addClass("-hidden");
        });
      }
      return this.mediaElement.el.get(0).play();
    };

    StoryCard.prototype.initVideoPreview = function($el) {
      if (!this.mediaElement) {
        return;
      }
      $el.on("mouseenter", this.startPlay.bind(this));
      return $el.on("mouseleave", function(e) {
        return $("video", e.currentTarget).get(0).pause();
      });
    };

    return StoryCard;

  })();

}).call(this);

/*
  Вложенное меню
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.Submenu = (function(superClass) {
    extend(Submenu, superClass);

    Submenu.ATTR_NAME = "widget-submenu";

    Submenu.prototype.DT = "widgets.Submenu";

    Submenu.prototype.HIDE_TIMEOUT = 500;

    function Submenu(el, opts) {
      this.el = el;
      this.calculateAlign = bind(this.calculateAlign, this);
      this.startHideTimeout = bind(this.startHideTimeout, this);
      this.stopHideTimeout = bind(this.stopHideTimeout, this);
      this.disactivateHideTimeout = bind(this.disactivateHideTimeout, this);
      this.activateHideTimeout = bind(this.activateHideTimeout, this);
      this.hide = bind(this.hide, this);
      this.show = bind(this.show, this);
      this.interactionMouseEnter = bind(this.interactionMouseEnter, this);
      this.initInteractions = bind(this.initInteractions, this);
      this.parseOpts = bind(this.parseOpts, this);
      Submenu.__super__.constructor.apply(this, arguments);
      console.log(this.DT, "Init");
      this.submenu = this.el.find("[submenu-menu]");
      this.parseOpts(opts);
      this.initInteractions();
    }

    Submenu.prototype.parseOpts = function(opts) {
      if (opts.padding != null) {
        return this.padding = opts.padding;
      } else {
        return this.padding = 0;
      }
    };

    Submenu.prototype.initInteractions = function() {
      return this.el.on("mouseenter", this.interactionMouseEnter);
    };

    Submenu.prototype.interactionMouseEnter = function() {
      console.log(this.DT, "Mouse enter");
      return this.show();
    };

    Submenu.prototype.show = function() {
      if (this.submenu.is(":visible")) {
        return;
      }
      console.log(this.DT, "Show");
      this.submenu.addClass("-before-show");
      return _.defer((function(_this) {
        return function() {
          var align;
          align = _this.calculateAlign();
          _this.submenu.addClass("-showed " + align);
          return setTimeout(function() {
            _this.activateHideTimeout();
            return _this.submenu.removeClass("-before-show").addClass("-after-show");
          }, 500);
        };
      })(this));
    };

    Submenu.prototype.hide = function() {
      if (!this.submenu.is(":visible")) {
        return;
      }
      console.log(this.DT, "Hide");
      this.submenu.removeClass("-showed -right -left -before-show -after-show");
      return this.disactivateHideTimeout();
    };

    Submenu.prototype.activateHideTimeout = function() {
      this.disactivateHideTimeout();
      this.el.on("mouseleave", this.startHideTimeout);
      this.submenu.on("mouseleave", this.startHideTimeout);
      this.el.on("mouseenter", this.stopHideTimeout);
      return this.submenu.on("mouseenter", this.stopHideTimeout);
    };

    Submenu.prototype.disactivateHideTimeout = function() {
      this.stopHideTimeout();
      this.el.off("mouseleave", this.startHideTimeout);
      this.submenu.off("mouseleave", this.startHideTimeout);
      this.el.off("mouseenter", this.stopHideTimeout);
      return this.submenu.off("mouseenter", this.stopHideTimeout);
    };

    Submenu.prototype.stopHideTimeout = function() {
      if (this._hideTimer != null) {
        clearTimeout(this._hideTimer);
        return delete this._hideTimer;
      }
    };

    Submenu.prototype.startHideTimeout = function() {
      this.stopHideTimeout();
      return this._hideTimer = setTimeout(this.hide, this.HIDE_TIMEOUT);
    };

    Submenu.prototype.calculateAlign = function() {
      var SCREEN_BOUND_MARGIN, r, w;
      SCREEN_BOUND_MARGIN = 30;
      this.submenu.addClass("-transparent");
      r = this.el.offset().left + this.el.outerWidth(true);
      w = this.submenu.outerWidth(true);
      this.submenu.removeClass("-transparent");
      if ((r + w + this.padding + SCREEN_BOUND_MARGIN) < $(window).width()) {
        return "-right";
      } else {
        return "-left";
      }
    };

    return Submenu;

  })(abstract.Object);

}).call(this);
(function() {
  widgets.timeline.FilterChannelsTimeline = (function() {
    function FilterChannelsTimeline(el) {
      $('.page-menu .page-menu__item').click((function(_this) {
        return function(e) {
          var sortType, target;
          target = $(e.currentTarget);
          if (target.hasClass('-active')) {
            return;
          }
          $('.page-menu .page-menu__item').removeClass('-active');
          target.addClass('-active');
          if ((sortType = target.attr('data-sort')) != null) {
            return _this.updateFilter(sortType);
          }
        };
      })(this));
    }

    FilterChannelsTimeline.prototype.updateFilter = function(val) {
      if (this.sortOrder === val) {
        return;
      }
      this.sortOrder = val;
      return $(document).trigger(clientsideTimeline.ClientsideTimelineChannels.ACTION_UPDATE_PROPERTIES, [
        {
          order_by: this.sortOrder
        }
      ]);
    };

    FilterChannelsTimeline.constructIn = function(container) {
      container || (container = $('body'));
      return container.each(function() {
        return new widgets.timeline.FilterChannelsTimeline(this);
      });
    };

    return FilterChannelsTimeline;

  })();

}).call(this);
(function() {
  widgets.timeline.FilterCoubsType = (function() {
    function FilterCoubsType(el) {
      var sortByPopular;
      this.el = el;
      this.timeline = $("[clientside-timeline]", this.el);
      sortByPopular = $("#order-by-type", this.el);
      sortByPopular.on("click", (function(_this) {
        return function(e) {
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            sortByPopular.filter(".active").removeClass("active");
            el.addClass("active");
            $(document).trigger({
              type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
              val: el.attr("data-type"),
              filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
            });
          }
          if (el.attr("data-type") === "likes") {
            return _this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
              user: _this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
            }));
          } else {
            return _this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
          }
        };
      })(this));
    }

    FilterCoubsType.constructIn = function(container) {
      if (container == null) {
        container = $("body");
      }
      return container.each(function() {
        return new widgets.timeline.FilterCoubsType($(this));
      });
    };

    return FilterCoubsType;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.timeline.FilterTimelineType = (function() {
    FilterTimelineType.prototype.MAP = {
      'views_count': 'views',
      'likes_count': 'likes',
      'newest': 'fresh'
    };

    function FilterTimelineType(el, sortType1, routeParams) {
      var isRoutesEnabled;
      this.el = el;
      this.sortType = sortType1;
      this.routeParams = routeParams;
      this.navigate = bind(this.navigate, this);
      isRoutesEnabled = !!this.routeParams;
      if (isRoutesEnabled) {
        this.initRoutes();
      }
      this.menuItems = $('.page-menu .page-menu__item[data-sort]', this.el);
      this.menuItems.click((function(_this) {
        return function(e) {
          var sortType, target;
          target = $(e.currentTarget);
          if (target.hasClass('-active')) {
            return;
          }
          if ((sortType = target.attr('data-sort')) != null) {
            if (isRoutesEnabled) {
              return _this.navigate(sortType);
            } else {
              return _this.triggerFilterUpdate(sortType);
            }
          }
        };
      })(this));
    }

    FilterTimelineType.prototype.initRoutes = function() {
      var render;
      render = (function(_this) {
        return function(ctx) {
          _this.sortType = _this.getSortTypeFromUrl(ctx.params.sortUrl) || _this.menuItems.first().attr('data-sort');
          return _this.triggerFilterUpdate(_this.sortType);
        };
      })(this);
      this.queryString = window.location.search || '';
      if (GlobalState.PAGE.isLikesPage() || GlobalState.PAGE.isFavouritesPage()) {
        this.MAP['likes_count'] = 'top';
        this.MAP['date'] = '';
      } else if (GlobalState.PAGE.isTagPage()) {
        this.MAP['newest_popular'] = '';
      }
      page('/:sortUrl?', render);
      page.base(this.routeParams.base);
      return page({
        click: false,
        dispatch: false
      });
    };

    FilterTimelineType.prototype.navigate = function(sortType) {
      var url;
      if (this.sortType === sortType) {
        return;
      }
      url = "/" + (this.getUrlFromSortType(sortType)) + this.queryString;
      ga('send', 'pageview', url);
      console.log("[DEBUG]", "pageview!", url);
      return page(url);
    };

    FilterTimelineType.prototype.selectMenuItem = function(sortType) {
      return this.menuItems.each(function() {
        return $(this).toggleClass('-active', $(this).attr('data-sort') === sortType);
      });
    };

    FilterTimelineType.prototype.triggerFilterUpdate = function(sortType) {
      this.selectMenuItem(sortType);
      return $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: sortType,
        filter_type: TimelineDataProvider.FILTER.ORDER_BY
      });
    };

    FilterTimelineType.prototype.getSortTypeFromUrl = function(url) {
      var sortType;
      sortType = url;
      Object.keys(this.MAP).forEach((function(_this) {
        return function(key) {
          if (_this.MAP[key] === url) {
            return sortType = key;
          }
        };
      })(this));
      return sortType;
    };

    FilterTimelineType.prototype.getUrlFromSortType = function(sortType) {
      var st;
      if ((st = this.MAP[sortType]) != null) {
        return st;
      } else {
        return sortType;
      }
    };

    FilterTimelineType.constructIn = function(container) {
      container || (container = $('body'));
      return container.each(function() {
        return new widgets.timeline.FilterTimelineType($(this));
      });
    };

    return FilterTimelineType;

  })();

}).call(this);
(function() {
  widgets.timeline.SimpleTimelineWithFilters = (function() {
    function SimpleTimelineWithFilters(container, routeParams) {
      var sortOrder, timeline_view;
      container || (container = $('body'));
      widgets.timeline.ViewSelector.constructIn(container);
      widgets.timeline.FilterCoubsType.constructIn(container);
      sortOrder = $('.page-menu .page-menu__item.-active', container).attr('data-sort');
      if (sortOrder != null) {
        new widgets.timeline.TimelineControls(container, sortOrder);
        new widgets.timeline.FilterTimelineType(container, sortOrder, routeParams);
      } else {
        new widgets.timeline.TimelineControls(container);
      }
      timeline_view = container.find('[clientside-timeline]:first').attr('view');
      if (timeline_view) {
        $(document).trigger({
          type: TimelineViewDataProvider.VIEW_CHANGED_EVENT,
          view: timeline_view
        });
      }
    }

    return SimpleTimelineWithFilters;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.timeline.TimelineControls = (function() {
    TimelineControls.EVENT_FILTER_UPDATE = 'widgets-timeline-TimelineControls:FilterUpdate';

    TimelineControls.prototype.DT = "widgets.timeline.TimelineControls";

    function TimelineControls(el, sortOrder, timelineWidget) {
      var sk, type, view;
      this.el = el;
      this.timelineWidget = timelineWidget;
      this.updateFilter = bind(this.updateFilter, this);
      this.updateView = bind(this.updateView, this);
      this.updateFilterListener = bind(this.updateFilterListener, this);
      this.updateViewListener = bind(this.updateViewListener, this);
      this.timeline = this.el.find('.coubs-list:first');
      this.timelineProvider = new TimelineDataProvider();
      this.timelineViewProvider = new TimelineViewDataProvider();
      sortOrder || (sortOrder = this.timeline.attr('data-order_by') || '');
      type = this.timeline.attr('data-type') || TimelineDataProvider.COUBS_TYPE.ALL;
      this.currentFilters = {
        type: type,
        order_by: sortOrder,
        scope: 'all'
      };
      $(document).on(this.timelineViewProvider.VIEW_CHANGED_EVENT, this.updateViewListener).on(widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE, this.updateFilterListener);
      if ((sk = this.timeline.attr("storage-key")) != null) {
        console.log(this.DT, "Get by storage key", sk, this.timelineViewProvider.getUserViewSetting(sk));
        view = this.timelineViewProvider.getUserViewSetting(sk);
      } else {
        view = this.timelineViewProvider.get();
      }
      if ((view != null) && type !== 'stories') {
        this.updateView(view, false);
      }
    }

    TimelineControls.prototype.destroy = function() {
      $(document).off(this.timelineViewProvider.VIEW_CHANGED_EVENT, this.updateViewListener);
      return $(document).off(widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE, this.updateFilterListener);
    };

    TimelineControls.prototype.updateViewListener = function(e) {
      return this.updateView(e.view);
    };

    TimelineControls.prototype.updateFilterListener = function(e) {
      return this.updateFilter(e.filter_type, e.val);
    };

    TimelineControls.prototype.updateView = function(view, sendStat) {
      var sk;
      if (sendStat == null) {
        sendStat = true;
      }
      this.timeline.trigger({
        type: clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_VIEW,
        view: blocks.clientsideTimeline.TimelineViews.views[view]
      });
      if (GlobalState.PAGE.isProfile()) {
        this.timelineViewProvider.saveUserViewSettingProfile(view);
      } else if ((sk = this.timeline.attr("storage-key")) != null) {
        this.timelineViewProvider.saveUserViewSetting(view, sk);
      }
      if (sendStat) {
        if (GlobalState.PAGE.isProfile()) {
          Stats.track('profile_view_switch', {
            to: view
          });
        }
        if (GlobalState.PAGE.isBestCoubs2014()) {
          return Stats.track('best2014_view_switch', {
            to: view
          });
        }
      }
    };

    TimelineControls.prototype.updateFilter = function(type, val) {
      if (this.currentFilters[type] === val) {
        return;
      }
      this.currentFilters[type] = val;
      return this.timeline.triggerHandler(clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_PROPERTIES, this.currentFilters);
    };

    TimelineControls.constructIn = function(container, sortOrder) {
      container || (container = $('body'));
      return container.find('[widget-timeline-controls]').each(function() {
        return new widgets.timeline.TimelineControls($(this), sortOrder);
      });
    };

    return TimelineControls;

  })();

}).call(this);

/*
  Контролы таймлайна для эксплора
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.timeline.ExploreTimelineControls = (function(superClass) {
    extend(ExploreTimelineControls, superClass);

    function ExploreTimelineControls() {
      this.updateView = bind(this.updateView, this);
      return ExploreTimelineControls.__super__.constructor.apply(this, arguments);
    }

    ExploreTimelineControls.prototype.updateView = function(view, sendStat) {
      if (sendStat == null) {
        sendStat = true;
      }
      this.timeline.trigger({
        type: clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_VIEW,
        view: blocks.clientsideTimeline.TimelineViews.views[view]
      });
      return this.timelineViewProvider.saveUserViewSetting(view, "explore_timeline_view");
    };

    return ExploreTimelineControls;

  })(widgets.timeline.TimelineControls);

}).call(this);
(function() {
  widgets.timeline.TimelineEditorSwitch = (function() {
    function TimelineEditorSwitch($container) {
      this.$widget = $container.find('[widget-timeline-editor-switch]');
      if (!this.$widget.length) {
        return;
      }
      this.$widget.click((function(_this) {
        return function() {
          return _this.setState(!_this.getState());
        };
      })(this));
      this.$container = $container;
      this.initTimeline();
    }

    TimelineEditorSwitch.prototype.initTimeline = function() {
      this.$timeline = this.$container.find('.coubs-list:first');
      return this.$timeline.on(clientsideTimeline.ClientsideTimeline.EVENT_VIEW_CHANGED, (function(_this) {
        return function(e, view) {
          if (view !== blocks.clientsideTimeline.TimelineViews.views.mosaic.name || !_this.getState()) {
            return;
          }
          return _this.setState(false);
        };
      })(this));
    };

    TimelineEditorSwitch.prototype.reinit = function() {
      if (!this.$widget.length) {
        return;
      }
      this.initTimeline();
      return this.setState(this.getState());
    };

    TimelineEditorSwitch.prototype.getState = function() {
      return this.$widget.hasClass('-on');
    };

    TimelineEditorSwitch.prototype.setState = function(val) {
      var renderProps;
      val = !!val;
      this.$widget.toggleClass('-on', val);
      renderProps = val && {
        'editor-controls': 'true'
      } || {};
      this.$timeline.toggleClass('coubs-list--editorial', val);
      this.$timeline.triggerHandler(clientsideTimeline.ClientsideTimeline.ACTION_SET_RENDER_DATA, [renderProps]);
      if (val) {
        return $(document).trigger({
          type: TimelineViewDataProvider.VIEW_CHANGED_EVENT,
          view: blocks.clientsideTimeline.TimelineViews.views.list.name
        });
      }
    };

    return TimelineEditorSwitch;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.timeline.ViewSelector = (function() {
    ViewSelector.prototype.PUSHED_CLASS = "active";

    function ViewSelector(el) {
      this.unpushButton = bind(this.unpushButton, this);
      this.pushButton = bind(this.pushButton, this);
      this.viewChanged = bind(this.viewChanged, this);
      this.updateViewValue = bind(this.updateViewValue, this);
      this.button = el;
      this.value = this.button.attr("view");
      this.button.removeClass('-hidden');
      if (this.value == null) {
        throw "ViewSelector: require a view attribute";
      }
      this.provider = new TimelineViewDataProvider();
      if (this.value === this.provider.get(this.button.attr("storage-key"))) {
        this.pushButton();
      }
      this.button.bind("click", this.updateViewValue);
      $(document).bind(this.provider.VIEW_CHANGED_EVENT, this.viewChanged);
    }

    ViewSelector.prototype.destroy = function() {
      this.unpushButton();
      this.button.off('click', this.updateViewValue);
      return $(document).off(this.provider.VIEW_CHANGED_EVENT, this.viewChanged);
    };

    ViewSelector.prototype.updateViewValue = function() {
      if (!this.button.hasClass(this.PUSHED_CLASS)) {
        this.pushButton();
        this.provider.set(this.value);
        return true;
      } else {
        return false;
      }
    };

    ViewSelector.prototype.viewChanged = function(e) {
      console.log("LAM", "View changed", e);
      if (e.view === this.value) {
        return this.pushButton();
      } else {
        return this.unpushButton();
      }
    };

    ViewSelector.prototype.pushButton = function() {
      return this.button.addClass(this.PUSHED_CLASS);
    };

    ViewSelector.prototype.unpushButton = function() {
      return this.button.removeClass(this.PUSHED_CLASS);
    };

    ViewSelector.constructIn = function(container) {
      if (container == null) {
        container = $("body");
      }
      return container.find(".viewSelector").map(function() {
        return new ViewSelector($(this));
      });
    };

    ViewSelector.getTestStub = function(view) {
      if (view == null) {
        view = "default";
      }
      return new widgets.timeline.ViewSelector($("<button class=\"viewSelector mousedownable default\" view=\"" + view + "\"></button>"));
    };

    ViewSelector.initWithEvents = function(el, view) {
      var provider, timeline, updateView;
      if (view == null) {
        view = "list";
      }
      if (el == null) {
        el = $('body');
      }
      timeline = el.find('[clientside-timeline]').first();
      provider = new TimelineViewDataProvider();
      provider.setDefaultView(view);
      widgets.timeline.ViewSelector.constructIn(el);
      updateView = function(view) {
        return timeline.trigger({
          type: clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_VIEW,
          view: blocks.clientsideTimeline.TimelineViews.views[view]
        });
      };
      $(document).bind(provider.VIEW_CHANGED_EVENT, (function(_this) {
        return function(e) {
          return updateView(e.view);
        };
      })(this));
      return updateView(provider.get());
    };

    return ViewSelector;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.transliteration.DependentInputs = (function() {
    DependentInputs.ATTR_NAME = 'widget-transliteration-inputs';

    DependentInputs.prototype.STRUCTURE_REGEXP = /^[a-zA-Z\-0-9\.]*$/;

    DependentInputs.prototype.DICTIONARY = {
      VOWELS_CONSONANTS_TRANS: {
        'а': 'a',
        'б': 'b',
        'в': 'v',
        'г': 'g',
        'д': 'd',
        'е': 'e',
        'ё': 'yo',
        'ж': 'zh',
        'з': 'z',
        'и': 'i',
        'й': 'i',
        'к': 'k',
        'л': 'l',
        'м': 'm',
        'н': 'n',
        'о': 'o',
        'п': 'p',
        'р': 'r',
        'с': 's',
        'т': 't',
        'у': 'u',
        'ф': 'f',
        'х': 'h',
        'ц': 'ts',
        'ч': 'ch',
        'ш': 'sh',
        'щ': 'sch',
        'ы': 'i',
        'э': 'e',
        'ю': 'yu',
        'я': 'ya'
      },
      SOFT_HARD_TRANS: {
        'ьа': 'ya',
        'ье': 'iе',
        'ьё': 'yo',
        'ьи': 'yi',
        'ьо': 'yo',
        'ьу': 'u',
        'ьы': 'i',
        'ьэ': 'ye',
        'ью': 'yu',
        'ья': 'ya',
        'ъа': 'ya',
        'ъе': 'iе',
        'ъё': 'yo',
        'ъи': 'yi',
        'ъо': 'yo',
        'ъу': 'u',
        'ъы': 'i',
        'ъэ': 'ye',
        'ъю': 'yu',
        'ъя': 'ya'
      },
      SOFT_HARD: ['ь', 'ъ']
    };

    function DependentInputs(el) {
      this.el = el;
      this.transliterate = bind(this.transliterate, this);
      this.change = bind(this.change, this);
      this.changeable = $('[data-transliteration-type=changeable]', this.el);
      this.listener = $('[data-transliteration-type=listener]', this.el);
      this.listener.val(this.transliterate(this.changeable.val()));
      this.changeable.on('input', this.change);
    }

    DependentInputs.prototype.change = function() {
      return this.listener.val(this.transliterate(this.changeable.val()));
    };

    DependentInputs.prototype.transliterate = function(input) {
      var char, dictionary, i, index, len, next, prev, transliterated;
      transliterated = '';
      input = input.replace(/\s+/g, '.').toLowerCase();
      for (index = i = 0, len = input.length; i < len; index = ++i) {
        char = input[index];
        next = input.charAt(index + 1);
        prev = input.charAt(index - 1);
        dictionary = this.DICTIONARY.VOWELS_CONSONANTS_TRANS[char];
        if (dictionary != null) {
          transliterated += dictionary;
        } else {
          if (_.include(this.DICTIONARY.SOFT_HARD, char) || !char.match(this.STRUCTURE_REGEXP)) {
            transliterated += '';
          } else {
            transliterated += char;
          }
        }
      }
      return transliterated;
    };

    return DependentInputs;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.AbstractWidgetListener = (function() {
    AbstractWidgetListener.STATES = void 0;

    function AbstractWidgetListener(el) {
      this.el = el;
      this.undisable = bind(this.undisable, this);
      this.disable = bind(this.disable, this);
      this.unpress = bind(this.unpress, this);
      this.press = bind(this.press, this);
      this.update = bind(this.update, this);
      this.isOwn = bind(this.isOwn, this);
      this.isPressed = bind(this.isPressed, this);
      this.currentId = bind(this.currentId, this);
      this.el = $(this.el);
      this.id = parseInt(this.el.attr('data-listener-id'));
      this.type = this.el.attr('data-listener-type');
      $(document).trigger({
        type: widgets.WidgetStateChanger.ACTIONS.PUSH,
        listenerId: this.id,
        listenerType: this.type
      });
      $(document).on(Params.EVENT_PARTICULAR_PARAM_CHANGED('current_channel_id'), this.update);
      this.el.on("dom_remove", (function(_this) {
        return function() {
          return $(document).off(Params.EVENT_PARTICULAR_PARAM_CHANGED('current_channel_id'), _this.update);
        };
      })(this));
    }

    AbstractWidgetListener.prototype.currentId = function() {
      return Params.get('current_channel_id');
    };

    AbstractWidgetListener.prototype.isPressed = function(states, type) {
      return _.include(states[type], this.id);
    };

    AbstractWidgetListener.prototype.isOwn = function(id) {
      return id === parseInt(this.currentId());
    };

    AbstractWidgetListener.prototype.update = function() {
      throw 'widgets.WidgetListenerAbstract: override update';
    };

    AbstractWidgetListener.prototype.press = function() {
      throw 'widgets.WidgetListenerAbstract: override press';
    };

    AbstractWidgetListener.prototype.unpress = function() {
      throw 'widgets.WidgetListenerAbstract: override unpress';
    };

    AbstractWidgetListener.prototype.disable = function() {
      throw 'widgets.WidgetListenerAbstract: override disable';
    };

    AbstractWidgetListener.prototype.undisable = function() {
      throw 'widgets.WidgetListenerAbstract: override disable';
    };

    return AbstractWidgetListener;

  })();

}).call(this);

/*
  Класс, меняющий контент какого-то элемента по смене канала на странице профайла
  Два кейса — канал меняется на текущий канал или на другой
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.WidgetListenerContentAbstract = (function() {
    function WidgetListenerContentAbstract(el) {
      this.el = el;
      this.setContentForOtherChannel = bind(this.setContentForOtherChannel, this);
      this.setContentForCurrentChannel = bind(this.setContentForCurrentChannel, this);
      this.setContentForCurrentUser = bind(this.setContentForCurrentUser, this);
      this.update = bind(this.update, this);
      this.isOwn = bind(this.isOwn, this);
      this.currentId = bind(this.currentId, this);
      this.el = $(this.el);
      this.id = parseInt(this.el.attr('data-listener-id'));
      this.contentForCurrentChannel = $('[data-current-channel]', this.el);
      this.contentForOtherChannel = $('[data-other-channel]', this.el);
      this.contentForCurrentUser = $('[data-current-user]', this.el);
      $(document).bind(Params.EVENT_PARTICULAR_PARAM_CHANGED('current_channel_id'), this.update);
    }

    WidgetListenerContentAbstract.prototype.currentId = function() {
      return Params.get('current_channel_id');
    };

    WidgetListenerContentAbstract.prototype.isOwn = function(id) {
      return id === parseInt(this.currentId());
    };

    WidgetListenerContentAbstract.prototype.update = function() {
      this.setContentForCurrentUser();
      if (this.isOwn(this.id)) {
        return this.setContentForCurrentChannel();
      } else {
        return this.setContentForOtherChannel();
      }
    };

    WidgetListenerContentAbstract.prototype.setContentForCurrentUser = function() {
      return this.contentForCurrentUser.removeClass('-hidden');
    };

    WidgetListenerContentAbstract.prototype.setContentForCurrentChannel = function() {
      this.contentForCurrentChannel.removeClass('-hidden');
      return this.contentForOtherChannel.addClass('-hidden');
    };

    WidgetListenerContentAbstract.prototype.setContentForOtherChannel = function() {
      this.contentForCurrentChannel.addClass('-hidden');
      return this.contentForOtherChannel.removeClass('-hidden');
    };

    return WidgetListenerContentAbstract;

  })();

}).call(this);

/*
  Класс, меняющий контент кнопки follow/profile на странице канала по смене канала
  Инитит эти кнопки на клиенте
 */

(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.WidgetProfileButtons = (function(superClass) {
    extend(WidgetProfileButtons, superClass);

    WidgetProfileButtons.ATTR_NAME = "widget-profile-buttons";

    function WidgetProfileButtons(el) {
      var $profileButton;
      this.el = el;
      WidgetProfileButtons.__super__.constructor.apply(this, arguments);
      $profileButton = $(JST['app/site/templates/profile/settings_button']({
        url: this.getProfileLink()
      }));
      this.contentForCurrentUser.html($profileButton);
      this.contentForCurrentChannel.html($profileButton);
      if (this.isOwn(this.id)) {
        this.setContentForCurrentUser();
        this.setContentForCurrentChannel();
      } else {
        this.setContentForOtherChannel();
      }
    }

    WidgetProfileButtons.prototype.getProfileLink = function() {
      return Routes.profile_edit_path({
        id: Params.getBranchValue("profile_channel.permalink")
      });
    };

    return WidgetProfileButtons;

  })(widgets.WidgetListenerContentAbstract);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.WidgetListenerDislike = (function(superClass) {
    extend(WidgetListenerDislike, superClass);

    WidgetListenerDislike.ATTR_NAME = "widget-listener-dislike";

    WidgetListenerDislike.TYPE = "dislikes";

    function WidgetListenerDislike(el) {
      this.el = el;
      this.unpress = bind(this.unpress, this);
      this.press = bind(this.press, this);
      this.update = bind(this.update, this);
      WidgetListenerDislike.__super__.constructor.apply(this, arguments);
      this.icon = $('i[handler]', this.el);
    }

    WidgetListenerDislike.prototype.update = function() {
      var lType, states;
      states = widgets.WidgetListenerDislike.STATES;
      lType = widgets.WidgetListenerDislike.TYPE;
      if (this.isPressed(states, lType)) {
        return this.press();
      } else {
        return this.unpress();
      }
    };

    WidgetListenerDislike.prototype.press = function() {
      this.el.addClass('-on').attr('lock', 'false');
      return this.icon.attr('data-prompt', I18n.t('tooltips.dislike_button.undislike'));
    };

    WidgetListenerDislike.prototype.unpress = function() {
      this.el.removeClass('-on').attr('lock', 'true');
      return this.icon.attr('data-prompt', I18n.t('tooltips.dislike_button.dislike'));
    };

    return WidgetListenerDislike;

  })(widgets.AbstractWidgetListener);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.WidgetListenerLike = (function(superClass) {
    extend(WidgetListenerLike, superClass);

    WidgetListenerLike.ATTR_NAME = "widget-listener-like";

    WidgetListenerLike.TYPE = "likes";

    function WidgetListenerLike(el) {
      this.el = el;
      this.unpress = bind(this.unpress, this);
      this.press = bind(this.press, this);
      this.update = bind(this.update, this);
      WidgetListenerLike.__super__.constructor.apply(this, arguments);
      this.icon = $('i[handler]', this.el);
    }

    WidgetListenerLike.prototype.update = function() {
      var lType, states;
      states = widgets.WidgetListenerLike.STATES;
      lType = widgets.WidgetListenerLike.TYPE;
      if (this.isPressed(states, lType)) {
        return this.press();
      } else {
        return this.unpress();
      }
    };

    WidgetListenerLike.prototype.press = function() {
      this.el.addClass('-on').attr('lock', 'false');
      return this.icon.attr('data-prompt', I18n.t('tooltips.like_button.unlike'));
    };

    WidgetListenerLike.prototype.unpress = function() {
      this.el.removeClass('-on').attr('lock', 'true');
      return this.icon.attr('data-prompt', I18n.t('tooltips.like_button.like'));
    };

    return WidgetListenerLike;

  })(widgets.AbstractWidgetListener);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  widgets.WidgetListenerRecoub = (function(superClass) {
    extend(WidgetListenerRecoub, superClass);

    WidgetListenerRecoub.ATTR_NAME = "widget-listener-recoub";

    WidgetListenerRecoub.TYPE = "recoubs";

    function WidgetListenerRecoub(el) {
      this.el = el;
      this.unpress = bind(this.unpress, this);
      this.press = bind(this.press, this);
      this.update = bind(this.update, this);
      WidgetListenerRecoub.__super__.constructor.apply(this, arguments);
      this.icon = $('i[handler]', this.el);
    }

    WidgetListenerRecoub.prototype.update = function() {
      var lType, states;
      states = widgets.WidgetListenerRecoub.STATES;
      lType = widgets.WidgetListenerRecoub.TYPE;
      if (this.isPressed(states, lType)) {
        return this.press();
      } else {
        return this.unpress();
      }
    };

    WidgetListenerRecoub.prototype.press = function() {
      this.el.addClass('-on');
      return this.icon.attr('data-prompt', I18n.t('tooltips.recoub_button.undo_recoub'));
    };

    WidgetListenerRecoub.prototype.unpress = function() {
      this.el.removeClass('-on');
      return this.icon.attr('data-prompt', I18n.t('tooltips.recoub_button.recoub'));
    };

    return WidgetListenerRecoub;

  })(widgets.AbstractWidgetListener);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  widgets.WidgetStateChanger = (function() {
    WidgetStateChanger.ACTIONS = {
      PUSH: "widgets:WidgetStateChanger:Actions:Push"
    };

    function WidgetStateChanger() {
      this.collectData = bind(this.collectData, this);
      this.listen = bind(this.listen, this);
      this.init = bind(this.init, this);
      if (WidgetStateChanger.__instance == null) {
        WidgetStateChanger.__instance = this;
        this.init();
      } else {
        return WidgetStateChanger.__instance;
      }
    }

    WidgetStateChanger.prototype.init = function() {
      this.coubs = [];
      this.follows = [];
      this.data = {};
      return this.listen();
    };

    WidgetStateChanger.prototype.listen = function() {
      return $(document).on(widgets.WidgetStateChanger.ACTIONS.PUSH, (function(_this) {
        return function(e) {
          return _this.collectData(e.listenerId, e.listenerType);
        };
      })(this));
    };

    WidgetStateChanger.prototype.collectData = function(id, type) {
      this[type].push(id);
      this.data = {
        follows: this.follows,
        coubs: this.coubs
      };
      return widgets.ChannelChanger.STATES = this.data;
    };

    return WidgetStateChanger;

  })();

}).call(this);

/*
  Обертка для Amplitude
 */

(function() {
  window.AmplitudeCoub = {

    /* Список евентов для страницы коба */
    COUB_PAGE: {
      SESSION_STARTED: "coubPage_session_started",
      VIEW_OCCURED: "coubPage_view_occured",
      VIEW_FROM_VIDEO_SOURCE_OCCURED: "coubPage_view_fromVideoSource_occured",
      EMBED_BTN_CLICKED: "coubPage_embedBtn_clicked",
      OPEN_IN_APP_CLICKED: "coubPage_openInApp_clicked",
      COUB_CARD: {
        AUTHOR_CLICKED: "coubPage_coubCard_author_clicked",
        LIKE_CLICKED: "coubPage_coubCard_like_clicked",
        RECOUB_CLICKED: "coubPage_coubCard_recoub_clicked",
        VIDEO_SOURCE_CLICKED: "coubPage_coubCard_videoSource_clicked",
        SHARE_BTN_CLICKED: "coubPage_coubCard_shareBtn_clicked"
      },
      APP_POPUP: {
        CLICK_OUTSIDE: "coubPage_appPopup_outside_clicked",
        CLICK_BUTTON: "coubPage_appPopup_button_clicked",
        CLICK_CLOSE: "coubPage_appPopup_close_clicked"
      },
      PLAYER: {
        SHARE_BTN_CLICKED: "coubPage_player_shareBtn_clicked",
        COPY_LINK_BTN_CLICKED: "coubPage_player_copyLinkBtn_clicked",
        FULLSCREEN_CLICKED: "coubPage_player_fullscreen_clicked",
        PAUSE_OCCURED: "coubPage_player_pause_occured",
        CENTER_CLICKED: "coubPage_player_center_clicked",
        PREV_CLICKED: "coubPage_player_prev_clicked",
        NEXT_CLICKED: "coubPage_player_next_clicked",

        /* tablet & mobile */
        PLAYER_UNMUTE_CLICKED: "coubPage_player_unmute_clicked",
        OPEN_IN_APP_CLICKED: "coubPage_player_openInApp_clicked"
      },
      AUTHOR_BLOCK: {
        AUTHOR_CLICKED: "coubPage_authorBlock_author_clicked",
        FOLLOW_CLICKED: "coubPage_authorBlock_follow_clicked",
        COUBS_COUNTER_CLICKED: "coubPage_authorBlock_coubsCounter_clicked",
        RECOUBS_COUNTER_CLICKED: "coubPage_authorBlock_recoubsCounter_clicked"
      },
      AUTHOR_POPUP: {
        POPUP_SHOWN: "coubPage_authorPopup_shown",
        AUTHOR_CLICKED: "coubPage_authorPopup_author_clicked",
        FOLLOW_CLICKED: "coubPage_authorPopup_follow_clicked",
        COUBS_COUNTER_CLICKED: "coubPage_authorPopup_coubsCounter_clicked",
        RECOUBS_COUNTER_CLICKED: "coubPage_authorPopup_recoubsCounter_clicked"
      },
      VIDEO_SOURCE_BLOCK: {
        SOURCE_CLICKED: "coubPage_videoSourceBlock_source_clicked",
        COUB_IT_CLICKED: "coubPage_videoSourceBlock_coubIt_clicked"
      },
      MUSIC_SOURCE_BLOCK: {
        SOURCE_CLICKED: "coubPage_musicSourceBlock_source_clicked",
        ITUNES_CLICKED: "coubPage_musicSourceBlock_itunes_clicked"
      },
      SHARE: {
        SHARE_SOCIAL: "coubPage_share_social",
        MAIL: "coubPage_share_mail",
        COPY_LINK: "coubPage_share_copyLink"
      },
      TAGS: {
        TAG_CLICKED: "coubPage_tags_tag_clicked",
        MORE_CLICKED: "coubPage_tags_more_clicked"
      },
      MORE_COUBS_BLOCK: {
        COUB_CLICKED: "coubPage_moreCoubsBlock_coub_clicked",
        MORE_CLICKED: "coubPage_moreCoubsBlock_more_clicked"
      },
      SCROLL: {
        SCROLLED_TO_SUGGESTS: "coubPage_scrolledTo_suggests",
        SCROLLED_TO_BOTTOM: "coubPage_scrolledTo_bottom"
      },
      COUBS_SUGGESTS: {
        COUB_CLICKED: "coubPage_coubsSuggests_coub_clicked"
      },
      HEADER: {
        LOGO_CLICKED: "coubPage_header_logo_clicked",
        SEARCH_FOCUSED: "coubPage_header_search_focused",
        SEARCH_OCCURED: "coubPage_header_search_occured",
        FEATURED_CLICKED: "coubPage_header_featured_clicked",
        POPULAR_CLICKED: "coubPage_header_popular_clicked",
        SIGNUP_CLICKED: "coubPage_header_signup_clicked",
        LOGIN_CLICKED: "coubPage_header_login_clicked",
        CREATE_CLICKED: "coubPage_header_create_clicked",
        USERPIC_CLICKED: "coubPage_header_userpic_clicked",
        NOTIFICATIONS_CLICKED: "coubPage_header_notifications_clicked",
        FOLLOWERS_CLICKED: "coubPage_header_followers_clicked",
        MOBILE_MENU: {
          OPENED: "coubPage_mobileMenu_opened",
          CLOSED: "coubPage_mobileMenu_closed",
          TIMELINE_CLICKED: "coubPage_mobileMenu_timeline_clicked",
          CHANNELS_CLICKED: "coubPage_mobileMenu_channels_clicked",
          FEATURED_CLICKED: "coubPage_mobileMenu_featured_clicked",
          HOT_CLICKED: "coubPage_mobileMenu_hot_clicked"
        }
      },
      FOOTER: {
        ABOUT: "coubPage_footer_about_clicked",
        MEDIA: "coubPage_footer_media_clicked",
        BLOG: "coubPage_footer_blog_clicked",
        TERMS_OF_SERVICE: "coubPage_footer_tos_clicked",
        ADVERTISE: "coubPage_footer_advertise_clicked",
        APPS: "coubPage_footer_apps_clicked",
        BRAND: "coubPage_footer_brand_clicked",
        DEVELOPERS: "coubPage_footer_developers_clicked",
        HELP: "coubPage_footer_help_clicked",
        EMAIL: "coubPage_footer_email_clicked"
      },
      SIGNUP_MODAL: {
        SIGNUP: {
          FROM_VK: "coubPage_signupModal_signup_vkontakte",
          FROM_FB: "coubPage_signupModal_signup_facebook",
          FROM_TW: "coubPage_signupModal_signup_twitter",
          FROM_GOOGLE: "coubPage_signupModal_signup_google",
          FROM_MAIL: "coubPage_signupModal_signup_mail"
        },
        LOGIN: {
          FROM_VK: "coubPage_signupModal_login_vkontakte",
          FROM_FB: "coubPage_signupModal_login_facebook",
          FROM_TW: "coubPage_signupModal_login_twitter",
          FROM_GOOGLE: "coubPage_signupModal_login_google",
          FROM_MAIL: "coubPage_signupModal_login_mail"
        },
        CLOSED: "coubPage_signupModal_closed"
      }
    },
    PROPS: {
      HAS_MUSIC_SOURCE: "hasMusicSource",
      HAS_VIDEO_SOURCE: "hasVideoSource",
      HAS_MORE_FROM_AUTHOR: "hasMoreFromAuthor",
      HAS_TAGS: "hasTags",
      IS_NSFW: "isNSFW",
      IS_AGE_RESCTRICTED: "isAgeRestricted",
      DATE_FIRST_WEEK: "dateFirstWeek",
      DATE_FIRST_WEEK_HALFYEAR: "dateFirstWeek-halfYear",
      DATE_HALFYEAR: "dateHalfYear",
      COUB_PERMALINK: "coubPermalink",
      FROM_COUB_SUGGEST: "fromCoubSuggest",
      FROM_PLAYER: "fromPlayer",
      FROM_COUB_CARD: "fromCoubCard",
      SOCIAL_SHARE_TARGET: "social_share_target",
      NEW_MOBILE_COUB_PAGE: "newMobileCoubPage",
      POSITION: "position",
      SUGGESTS_TYPE: "suggestsType",
      SUGGESTS: "suggests"
    },

    /* Editor */
    EDITOR: {
      CREATE: {
        PASTE_A_LINK_BUTTON_CLICKED: "editor_create_pasteALinkButton_clicked",
        PASTE_A_LINK_SCREEN: {
          FROM_CLIPBOARD: "editor_create_pasteALinkScreen_fromClipboard",
          NEXT_BUTTON_CLICKED: "editor_create_pasteALinkScreen_nextButtonClicked",
          BACK_BUTTON_CLICKED: "editor_create_pasteALinkScreen_backButtonClicked"
        },
        UPLOAD_A_VIDEO_BUTTON_CLICKED: "editor_create_uploadAVideoButton_clicked",
        WEB_CAMERA_BUTTON_CLICKED: "editor_create_webCameraButton_clicked",
        UPLOADING: {
          STARTED: "editor_create_uploading_started",
          ERROR: "editor_create_uploading_error"
        },
        CONVERTING: {
          STARTED: "editor_create_converting_started",
          FINISHED: "editor_create_converting_finished"
        }
      },
      PLAYER: {
        PLAY_OCCURED: "editor_player_playOccured",
        PAUSE_OCCURED: "editor_player_pauseOccured"
      },
      CONTROLS: {
        UNDO_BUTTON_CLICKED: "editor_controls_undoButton_clicked",
        REDO_BUTTON_CLICKED: "editor_controls_redoButton_clicked",
        FORWARD_BUTTON_CLICKED: "editor_controls_forwardButton_clicked",
        PING_PONG_BUTTON_CLICKED: "editor_controls_pingPongButton_clicked",
        BACKWARD_BUTTON_CLICKED: "editor_controls_backwardButton_clicked",
        SHADOW_MODE: {
          ON: "editor_controls_shadowMode_on",
          OFF: "editor_controls_shadowMode_off"
        },
        DRAG_AND_DROP_MODE: {
          ON: "editor_controls_dragAndDropMode_on",
          OFF: "editor_controls_dragAndDropMode_off"
        },
        MUTE_MODE: {
          ON: "editor_controls_muteMode_on",
          OFF: "editor_controls_muteMode_off"
        },
        UPLOAD_MUSIC: {
          POPOVER: {
            SHOWN: "editor_controls_uploadMusic_popover_shown",
            COUB_LINK: {
              BUTTON_CLICKED: "editor_controls_uploadMusic_popover_coubLink_button_clicked",
              ERROR: "editor_controls_uploadMusic_popover_coubLink_error"
            },
            LINK: {
              BUTTON_CLICKED: "editor_controls_uploadMusic_popover_link_button_clicked",
              ERROR: "editor_controls_uploadMusic_popover_link_error"
            },
            UPLOAD_BUTTON_CLICKED: "editor_controls_uploadMusic_popover_uploadButton_clicked"
          },
          UPLOADING: {
            STARTED: "editor_controls_uploadMusic_uploading_started",
            FINISHED: "editor_controls_uploadMusic_uploading_finished",
            ERROR: "editor_controls_uploadMusic_uploading_error",
            CANCELED: "editor_controls_uploadMusic_uploading_canceled"
          },
          DELETE_BUTTON_CLICKED: "editor_controls_uploadMusic_deleteButton_clicked"
        }
      },
      ADD_SEGMENT: {
        POPOVER: {
          SHOWN: "editor_addSegment_popover_shown",
          DUPLICATE_BUTTON_CLICKED: "editor_addSegment_popover_duplicateButton_clicked",
          COUB_LINK_BUTTON_CLICKED: "editor_addSegment_popover_coubLinkButton_clicked",
          VIDEO_LINK_BUTTON_CLICKED: "editor_addSegment_popover_videoLinkButton_clicked",
          UPLOAD_VIDEO_BUTTON_CLICKED: "editor_addSegment_popover_uploadVideoButton_clicked",
          WEB_CAMERA_BUTTON_CLICKED: "editor_addSegment_popover_webCameraButton_clicked"
        }
      },
      SEGMENT: {
        UPLOADING: {
          STARTED: "editor_segment_uploading_started",
          ERROR: "editor_segment_uploading_error",
          DELETE: "editor_segment_uploading_delete"
        },
        CONVERTING: {
          STARTED: "editor_segment_converting_started",
          FINISHED: "editor_segment_converting_finished",
          DELETE: "editor_segment_converting_delete"
        },
        DOWNLOADING: {
          STARTED: "editor_segment_downloading_started",
          PRELOADED: "editor_segment_downloading_preloaded",
          FINISHED: "editor_segment_downloading_finished"
        }
      },
      SEGMENTS_LIMIT_ACHIEVED: "editor_segment_limitAchieved",
      AFTER_CREATE_POPUP: {
        PUBLISH_BUTTON_CLICKED: "editor_afterCreatePopup_publishButton_clicked"
      }
    },

    /* Sign up form */
    SIGN_UP_FORM: {
      SHOWED: "singUpForm_showed",
      VK_BUTTON_CLICKED: "singUpForm_vkButtonClicked",
      FB_BUTTON_CLICKED: "singUpForm_fbButtonClicked",
      TW_BUTTON_CLICKED: "singUpForm_twButtonClicked",
      SUBMIT_BUTTON_CLICKED: "singUpForm_submitButtonClicked",
      SUCCESS: "singUpForm_success",
      OAUTH_ERROR: "singUpForm_oauthError",
      SERVER_ERROR: "signUpForm_serverError"
    },
    isInited: false,
    trackedEvents: {},
    timeoutIds: {},
    init: function() {
      var api_key, current_user, opts, platform, user_id;
      if (!this.isInited) {
        this.isInited = true;
        if (!amplitude) {
          console.log("Amplitude not supported");
          return;
        }
        if (GlobalState.PLATFORM.isMobile()) {
          if (GlobalState.SCREEN.isTablet()) {
            api_key = "3958e015bf947e7733b853c05ebbc567";
            platform = "tablet";
          } else {
            api_key = "9d53f21397998c98d4a0b1a1e29843db";
            platform = "mobile";
          }
        } else {
          api_key = "a2e63b22a79860271960c3da06467cee";
          platform = "desktop";
        }
        current_user = Params.getBranchValue("current_user");
        user_id = current_user != null ? current_user.id : null;
        opts = {
          platform: platform
        };
        amplitude.getInstance().init(api_key, user_id, opts);
        return console.log("[AMPLITUDE INIT] platform: " + platform + ", user_id: " + user_id);
      }
    },
    track: function(event, props) {
      if (props == null) {
        props = {};
      }
      this.init();
      console.log("[AMPLITUDE EVENT]: " + event, props);
      if (amplitude) {
        return amplitude.getInstance().logEvent(event, props);
      }
    },
    trackOnce: function(event, props) {
      if (props == null) {
        props = {};
      }
      if (!this.trackedEvents[event]) {
        this.trackedEvents[event] = true;
        return this.track(event, props);
      }
    },
    trackOne: function(event, props) {
      if (props == null) {
        props = {};
      }
      clearTimeout(this.timeoutIds[event]);
      return this.timeoutIds[event] = setTimeout(function() {
        return AmplitudeCoub.track(event, props);
      }, 50);
    },
    clearTrackedOnce: function(event) {
      return this.trackedEvents[event] = false;
    }
  };

}).call(this);
(function() {
  window.AmplitudeEmbed = {
    isInited: false,
    init: function() {
      if (this.isInited) {
        return;
      }
      this.isInited = true;
      if (!amplitude) {
        console.warn("Amplitude not supported");
        return;
      }
      amplitude.getInstance().init('23f0c51ed9326c3a178f58f8fd94bea5');
      return console.log("[AMPLITUDE EMBED INIT]");
    },
    track: function(event, props) {
      if (props == null) {
        props = {};
      }
      this.init();
      if (amplitude) {
        console.log("[AMPLITUDE EMBED EVENT]: " + event, props);
        return amplitude.getInstance().logEvent(event, props);
      }
    }
  };

}).call(this);
(function() {
  window.AmplitudeMobile = {
    get: function() {
      if (this.instance) {
        return this.instance;
      } else {
        AmplitudeCoub.init();
        return this.instance = amplitude;
      }
    },
    oneTimeEvents: {},
    init: function(isEmbed, hasSelfSound, hasAudio, duration, chunksLength) {
      var audioStatParam, domain_match, durationStatParam, statParams, whereStatParam;
      this.isEmbed = isEmbed;
      this.prefix = this.isEmbed && 'mEmbed' || 'mPlayer';
      audioStatParam = hasSelfSound ? 'builtIn' : hasAudio ? 'external' : 'no';
      whereStatParam = window.env === 'development' ? 'dev' : window.request_client ? window.request_client : window.top !== window ? document.referrer ? (domain_match = document.referrer.match(/\/\/(.[^\/]+)/), domain_match && domain_match[1] || document.referrer) : 'no_referrer' : 'site';
      durationStatParam = Math.floor(duration / 0.5) * 0.5;
      if (!this.isEmbed) {
        whereStatParam = this.specifySiteLocation();
      }
      statParams = {
        location: whereStatParam,
        soundtrack: audioStatParam,
        length: durationStatParam + "-" + (durationStatParam + 0.5),
        parts: chunksLength
      };
      return this.track('shown', statParams);
    },
    track: function(event, props) {
      if (this.isEmbed) {
        return;
      }
      console.log('[AMPLITUDE MOBILE]', this.prefix, event, props);
      return this.get().logEvent(this.prefix + "_" + event, props);
    },
    trackOnce: function(event, props) {
      if (this.oneTimeEvents[event]) {
        return;
      }
      this.oneTimeEvents[event] = true;
      return this.track(event, props);
    },
    specifySiteLocation: function() {
      if (GlobalState.PAGE.isCoubPage()) {
        this.prefix = "coubPage_" + this.prefix;
        return 'coub_page';
      } else if (GlobalState.PAGE.isUserTimeline()) {
        this.prefix = "feed_" + this.prefix;
        return 'timeline';
      } else if (GlobalState.PAGE.isTagPage()) {
        this.prefix = "feed_" + this.prefix;
        return 'tag';
      } else if (GlobalState.PAGE.isHotPage()) {
        this.prefix = "feed_" + this.prefix;
        return 'hot';
      } else if (GlobalState.PAGE.isFeaturedPage()) {
        this.prefix = "feed_" + this.prefix;
        return 'featured';
      } else if (GlobalState.PAGE.isProfile()) {
        this.prefix = "feed_" + this.prefix;
        return 'channel';
      } else if (GlobalState.PAGE.isSearchPage()) {
        this.prefix = "feed_" + this.prefix;
        return 'search';
      } else if (GlobalState.PAGE.isWeekly()) {
        this.prefix = "feed_" + this.prefix;
        return 'weeky';
      } else {
        return document.location.pathname;
      }
    }
  };

}).call(this);
(function() {
  window.Ces = {
    host: 'ces.coub.com',
    init: function() {},
    track: function(evt_name, params, sync) {},
    sendQueue: function(sync) {
      if (this.queue.length === 0) {
        return;
      }
      window.queue = this.queue;
      $.ajax({
        async: !sync,
        type: 'POST',
        url: "//" + this.host + "/rec.json",
        data: {
          data: this.pack(this.queue)
        }
      });
      return this.queue = [];
    },
    pack: function(obj) {
      var string;
      string = JSON.stringify(obj);
      return btoa(string);
    }
  };

}).call(this);
(function() {
  (function() {
    var logo;
    if (!window.console || !window.console.log) {
      return;
    }
    if (!location.hostname || location.hostname.indexOf("coub.com") === -1) {
      return;
    }
    logo = "/assets/promo/brand_assets/coub_symbol-6315b8e5b693ddf4b3ea9bcae52fcd332c5eb3b7148087e4a7b35a4c4994fcfa.png";
    logo = "http://" + location.hostname + logo;
    return console.log("\n%c  \n%c \n%cWelcome brah \ud83d\udc4a\n\n", "background: url(" + logo + ") center center no-repeat;background-size:contain;font-size:100px", "", "font-size:15px");
  })();

}).call(this);
(function() {
  window.GlobalState = {
    __cache: {},
    __cacheIt: function(fn, key) {
      if (GlobalState.__cache[key] == null) {
        GlobalState.__cache[key] = fn();
      }
      return GlobalState.__cache[key];
    },
    USER: {
      isLogedIn: function() {
        return $.cookie('is_logged_in') === 'true';
      },
      notVerified: function() {
        return $("body").hasClass("notVerified");
      },
      isAdmin: function() {
        return window.is_admin;
      },
      isEditor: function() {
        return window.is_editor;
      },
      followingCount: function() {
        return window.following_count;
      },
      getCurrentUserId: function() {
        return window.gon.current_user.id;
      },
      isOwnerOf: function(channelId) {
        if (!GlobalState.USER.isLogedIn()) {
          return false;
        }
        return _.some(Params.getBranchValue('current_user.channels'), function(c) {
          return c.id === channelId;
        });
      }
    },
    BROWSER: {
      isChrome: function() {
        return $("html").hasClass("chrome");
      },
      isChromeNative: function() {
        return window.chrome && !GlobalState.BROWSER.isOperaNative();
      },
      isSafari: function() {
        return $("html").hasClass("safari");
      },
      isOpera: function() {
        return $("html").hasClass("opera");
      },
      isOperaNative: function() {
        return window.opera || navigator.userAgent.indexOf(' OPR/') >= 0;
      },
      isOpera12: function() {
        return $("html").hasClass("opera12");
      },
      isIE: function() {
        return navigator.userAgent.indexOf('MSIE ') > -1 || navigator.userAgent.indexOf('Trident/') > -1;
      },
      isEdge: function() {
        return navigator.userAgent.indexOf("Edge") > -1;
      },
      isFirefox: function() {
        return navigator.userAgent.toLowerCase().indexOf('firefox') > -1;
      },
      isYandex: function() {
        return navigator.userAgent.indexOf('YaBrowser/') > -1;
      },
      hasAdblock: function() {
        return window.AdmanHTML === void 0;
      },
      hasFlash: function() {
        return GlobalState.__cacheIt(function() {
          if (window.swfobject && window.chrome) {
            swfobject.ua.pv = [11, 4, 0];
            return true;
          } else {
            return (typeof swfobject !== "undefined" && swfobject !== null) && swfobject.hasFlashPlayerVersion("11.4");
          }
        });
      }
    },
    PAGE: {
      isUserTimeline: function() {
        return GlobalState.__cacheIt(((function(_this) {
          return function() {
            return $("body").hasClass('startpage');
          };
        })(this)), "page.isUserTimeline");
      },
      isNotCoubPage: function() {
        return GlobalState.__cacheIt(((function(_this) {
          return function() {
            return $('.coub-page').length === 0;
          };
        })(this)), "page.isNotCoubPage");
      },
      isCoubPage: function() {
        return !GlobalState.PAGE.isNotCoubPage();
      },
      isProfile: function() {
        return GlobalState.__cacheIt(((function(_this) {
          return function() {
            return $("body").hasClass('profile-page');
          };
        })(this)), "page.isProfile");
      },
      isPromoProfile: function() {
        return GlobalState.__cacheIt(((function(_this) {
          return function() {
            return $("body").hasClass('promo-profile-page');
          };
        })(this)), "page.isPromoProfile");
      },
      isPromoCover: function() {
        return GlobalState.__cacheIt(((function(_this) {
          return function() {
            return $("body").hasClass('promo-cover');
          };
        })(this)), "page.isPromoCover");
      },
      isTimeline: function() {
        return GlobalState.__cacheIt(((function(_this) {
          return function() {
            return $(".coubs-list").size() > 0;
          };
        })(this)), "page.isTimeline");
      },
      isHotPage: function() {
        return GlobalState.__cacheIt(((function(_this) {
          return function() {
            return $("body").hasClass('hot-page');
          };
        })(this)), "page.isHotPage");
      },
      isFeaturedPage: function() {
        return GlobalState.__cacheIt(((function(_this) {
          return function() {
            return $("body").hasClass('featured-page');
          };
        })(this)), "page.isFeaturedPage");
      },
      isFeaturedIndexPage: function() {
        return GlobalState.__cacheIt(((function(_this) {
          return function() {
            return $("body").hasClass('featured-index-page');
          };
        })(this)), "page.isFeaturedIndexPage");
      },
      isFeaturedCoubsPage: function() {
        return GlobalState.__cacheIt(((function(_this) {
          return function() {
            return $("body").hasClass('featured-coubs-page');
          };
        })(this)), "page.isFeaturedCoubsPage");
      },
      isFeaturedStoriesPage: function() {
        return GlobalState.__cacheIt(((function(_this) {
          return function() {
            return $("body").hasClass('featured-stories-page');
          };
        })(this)), "page.isFeaturedStoriesPage");
      },
      isWeekly: function() {
        return GlobalState.__cacheIt(((function(_this) {
          return function() {
            return $("body").hasClass('weekly-page');
          };
        })(this)), "page.isWeekly");
      },
      isTagPage: function() {
        return GlobalState.__cacheIt((function() {
          return $("body").hasClass('tag-page');
        }), "page.isTagPage");
      },
      isSearchPage: function() {
        return GlobalState.__cacheIt((function() {
          return $("body").hasClass('search-page');
        }), "page.isSearchPage");
      },
      isBestCoubs2014: function() {
        return GlobalState.__cacheIt((function() {
          return $("body").hasClass('best-2014');
        }), "page.isBestCoubs2014");
      },
      isBestCoubs2015: function() {
        return GlobalState.__cacheIt((function() {
          return $("body").hasClass('best-2015');
        }), "page.isBestCoubs2015");
      },
      isBestCoubs2016: function() {
        return GlobalState.__cacheIt((function() {
          return $("body").hasClass('best-2016-page');
        }), "page.isBestCoubs2016");
      },
      isBestCoubs2017: function() {
        return GlobalState.__cacheIt((function() {
          return $("body").hasClass('best-2017');
        }), "page.isBestCoubs2017");
      },
      isOldSpicePromo2016: function() {
        return GlobalState.__cacheIt((function() {
          return $("body").hasClass('best-2016-oldspice');
        }), "page.isOldSpicePromo2016");
      },
      isBestCoubs2018: function() {
        return GlobalState.__cacheIt((function() {
          return $("body").hasClass('best2018');
        }), "page.isBestCoubs2018");
      },
      isBestCoubs2019: function() {
        return GlobalState.__cacheIt((function() {
          return $("body").hasClass('best2019');
        }), "page.isBestCoubs2019");
      },
      isLikesPage: function() {
        return GlobalState.__cacheIt((function() {
          return $("body").hasClass('my-likes');
        }), "page.isLikesPage");
      },
      isFavouritesPage: function() {
        return GlobalState.__cacheIt((function() {
          return $("body").hasClass('my-favourites');
        }), "page.isFavouritesPage");
      },
      isEmbed: function() {
        return GlobalState.__cacheIt((function() {
          return $("body").hasClass('coub-embed');
        }), "page.isEmbed");
      },
      isStoryPage: function() {
        return GlobalState.__cacheIt((function() {
          return $("body").hasClass('story-page');
        }), "page.isStoryPage");
      },
      isChatPage: function() {
        return GlobalState.__cacheIt((function() {
          return $("body").hasClass('chat-page');
        }), "page.isChatPage");
      },
      getUrlParam: function(q) {
        var re, s, val;
        s = window.location.search;
        s = s.replace(/\+/g, ' ');
        re = new RegExp("(\\?|&){1}" + q + "=([^&#]*)", 'i');
        val = re.exec(s);
        val = val ? decodeURIComponent(val[2]) : null;
        return val;
      },
      isHttps: function() {
        return GlobalState.__cacheIt((function() {
          return window.location.protocol === "https:";
        }), "page.isHttps");
      },
      getReferrer: function() {
        return GlobalState.PAGE.getUrlParam('referrer') || document.referrer || '';
      }
    },
    UI: {
      hasStaticHeader: function() {
        return $('header.header').hasClass('-static');
      },
      hasTransHeader: function() {
        return $('header.header').hasClass('-transparent');
      },
      hasSolidHeader: function() {
        return $('body').hasClass('solid-header');
      }
    },
    COUNTRY: {
      isRussia: function() {
        return (typeof Params !== "undefined" && Params !== null ? Params.get('country_ip') === 'Russian Federation' : ['RU'].indexOf(window.geo_country) !== -1) || window.env === 'development';
      },
      isExUssr: function() {
        return (typeof Params !== "undefined" && Params !== null ? Params.get('ussr_ip') : ['RU', 'UA', 'KZ', 'BY'].indexOf(window.geo_country) !== -1) || window.env === 'development';
      },
      isUS: function() {
        if (typeof Params !== "undefined" && Params !== null) {
          return Params.get('country_ip') === 'United States';
        } else {
          return ['US'].indexOf(window.geo_country) !== -1;
        }
      }
    },
    TIMELINE: {
      type: function() {
        var path, pathParts;
        path = window.location.pathname || '';
        if (path === '/') {
          return 'mainpage';
        } else if (path === '/feed') {
          return 'timeline';
        } else if (GlobalState.PAGE.isHotPage()) {
          pathParts = path.split('/');
          if (path === '/random' || (pathParts[1] === 'community' && pathParts[3] === 'random')) {
            return 'random';
          } else if (path === '/fresh' || (pathParts[1] === 'community' && pathParts[3] === 'fresh')) {
            return 'newest';
          } else if (path === '/rising' || (pathParts[1] === 'community' && pathParts[3] === 'rising')) {
            return 'rising';
          } else {
            return 'hot';
          }
        } else if (GlobalState.PAGE.isFeaturedPage()) {
          return 'explore';
        } else if (path.indexOf('/search') === 0) {
          return 'search';
        } else if (path.indexOf('/weekly') === 0) {
          return 'weekly';
        } else if (GlobalState.PAGE.isProfile()) {
          return 'profile';
        } else if (path.indexOf('/best/2014/hidden-gems') === 0) {
          return 'best2014_gems';
        } else if (path.indexOf('/best/2014/popular-tags') === 0) {
          return 'best2014_tags';
        } else if (path.indexOf('/best/2014') === 0) {
          return 'best2014_likes';
        } else if (path.indexOf('/best/2015/hidden-gems') === 0) {
          return 'best2015_gems';
        } else if (path.indexOf('/best/2015/memes') === 0) {
          return 'best2015_memes';
        } else if (path.indexOf('/best/2015/mybest') === 0) {
          return 'best2015_mybest';
        } else if (path.indexOf('/best/2015') === 0) {
          return 'best2015_likes';
        } else if (path.indexOf('/best/2016/memes') === 0) {
          return 'best2016_memes';
        } else if (path.indexOf('/best/2016/oldspice') === 0) {
          return 'best2016_oldspice';
        } else {
          return 'unknown';
        }
      }
    },
    PLATFORM: {
      isMobile: function() {
        return GlobalState.__cacheIt((function() {
          return $("html").hasClass("mobile");
        }), "platform.isMobile");
      },
      isAndroid: function() {
        return GlobalState.__cacheIt((function() {
          return $("html").hasClass("android");
        }), "platform.isAndroid");
      },
      isAndroidNative: function() {
        return GlobalState.__cacheIt((function() {
          return navigator.userAgent.toLowerCase().indexOf("android") !== -1;
        }), "platform.isAndroidNative");
      },
      isIos: function() {
        return GlobalState.__cacheIt((function() {
          return $("html").hasClass("ios");
        }), "platform.isIos");
      },
      isWindophone: function() {
        return GlobalState.__cacheIt((function() {
          return $("html").hasClass("win") && $("html").hasClass("mobile");
        }), "platform.isWindophone");
      },
      isWindows: function() {
        return GlobalState.__cacheIt((function() {
          return navigator.appVersion.indexOf("Win") !== -1;
        }), "platform.isWindows");
      },
      isVkIosApp: function() {
        return GlobalState.__cacheIt(function() {
          return location.search.indexOf("vk.iphone") !== -1 || location.search.indexOf("vk.ipad") !== -1;
        }, "platform.isVkIosApp");
      },
      isVkAndroidApp: function() {
        return GlobalState.__cacheIt(function() {
          var rc;
          rc = window.request_client || '';
          return rc.indexOf('com.vk.android') !== -1 || rc.indexOf('com.vkontakte.android') !== -1 || location.search.indexOf("vk.android") !== -1;
        }, "platform.isVkAndroidApp");
      },
      isVkIpadApp: function() {
        return GlobalState.__cacheIt((function() {
          return location.search.indexOf("vk.ipad") !== -1;
        }), "platform.isVkIpadApp");
      },
      hasApp: function() {
        var device;
        device = void 0;
        if (GlobalState.PLATFORM.isIos()) {
          device = 'ios';
        } else if (GlobalState.PLATFORM.isAndroidNative()) {
          device = 'android';
        } else if (GlobalState.PLATFORM.isWindophone()) {
          device = 'win';
        }
        return device;
      }
    },
    SCREEN: {
      isTablet: function() {
        return GlobalState.__cacheIt((function() {
          return Math.max(screen.width, screen.height) / Math.min(screen.width, screen.height) <= 1.6;
        }), 'screen.isTablet');
      }
    },
    EDITOR: {
      isEditing: function() {
        return $(".cb-edtr").attr("editing") === "true";
      },
      isAuthor: function() {
        return $(".cb-edtr").attr("is_author") === "true";
      }
    },
    STATS: {
      getPageSection: function() {
        var path;
        path = window.location.pathname || '';
        if (path.indexOf('/view') === 0) {
          return 'coub_page';
        } else if (path.indexOf('/embed') === 0) {
          return 'embed';
        } else if (path.indexOf('/sources') === 0) {
          return 'make_coub';
        } else if (path.indexOf('/tags') === 0) {
          return 'tags_page';
        } else if (path.indexOf('/search') === 0) {
          return 'search_page';
        } else if (GlobalState.TIMELINE.type() !== 'unknown') {
          return "timeline_" + (GlobalState.TIMELINE.type());
        } else {
          return path;
        }
      }
    }
  };

}).call(this);
(function() {
  window.ImagePlaceholder = {
    init: function() {
      $(document).on('load', '.img-placeholder', function() {
        return $(this).removeClass('img-placeholder');
      });
      return $('img.img-placeholder').each((function(_this) {
        return function(i, v) {
          if (_this.isImageLoaded(v)) {
            return $(v).removeClass('img-placeholder');
          }
        };
      })(this));
    },
    isImageLoaded: function(img) {
      if (!img.complete) {
        return false;
      }
      if (img.naturalWidth === 0) {
        return false;
      }
      return true;
    }
  };

}).call(this);
(function() {
  window.LocalesListPopup = {
    init: function() {
      return $("#toggle-locale-popup").live("click", (function(_this) {
        return function() {
          _this.toggle();
          return false;
        };
      })(this));
    },
    toggle: function() {
      if (this.popup) {
        this.hide();
        return this.popup = null;
      } else {
        return this.show();
      }
    },
    show: function() {
      return this.popup = ModalPopup.show({
        content: $("#locales-list-popup-content").html()
      });
    },
    hide: function() {
      return this.popup.close();
    }
  };

}).call(this);
(function() {
  window.Mouse = {
    init: function() {
      return $(document).bind("mousemove", (function(_this) {
        return function(e) {
          _this.xPos = e.pageX;
          return _this.yPos = e.pageY;
        };
      })(this));
    },
    x: function() {
      return this.xPos || 0;
    },
    y: function() {
      return this.yPos || 0;
    }
  };

}).call(this);

/*
  Класс который управляет параметрами которые передаются с бекэнда.
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.Params = (function() {
    Params.EVENT_PARAM_CHANGED = "Params:ParamChanged";

    Params.EVENT_PARTICULAR_PARAM_CHANGED = function(name) {
      return "Params:ParamChanged:" + name;
    };

    function Params() {
      this.set = bind(this.set, this);
      this.getBranchValue = bind(this.getBranchValue, this);
      this.get = bind(this.get, this);
      if (Params.__instance == null) {
        Params.__instance = this;
        this.vals = gon;
        this.EVENT_PARAM_CHANGED = Params.EVENT_PARAM_CHANGED;
        this.EVENT_PARTICULAR_PARAM_CHANGED = Params.EVENT_PARTICULAR_PARAM_CHANGED;
      } else {
        return Params.__instance;
      }
    }

    Params.prototype.get = function(name) {
      return this.vals[name];
    };

    Params.prototype.getBranchValue = function(param) {
      var get;
      get = (function(_this) {
        return function(cur, path) {
          if (path.length === 0) {
            return cur;
          } else if (!(cur[path[0]] != null)) {
            return void 0;
          } else {
            return get(cur[path[0]], path.slice(1));
          }
        };
      })(this);
      return get(this.vals, param.split("."));
    };

    Params.prototype.set = function(name, value) {
      this.vals[name] = value;
      $(document).trigger({
        type: this.EVENT_PARAM_CHANGED,
        name: name,
        value: value
      });
      return $(document).trigger({
        type: this.EVENT_PARTICULAR_PARAM_CHANGED(name),
        value: value
      });
    };

    Params.get = function(name) {
      return new Params().get(name);
    };

    Params.set = function(name, value) {
      return new Params().set(name, value);
    };

    Params.getBranchValue = function(param) {
      return new Params().getBranchValue(param);
    };

    Params.getCurrentChannel = function() {
      var ccid, channels, cu;
      cu = Params.getBranchValue("current_user");
      ccid = Params.getBranchValue("current_channel_id");
      if ((cu != null) && (ccid != null)) {
        channels = cu.channels;
        channels = channels.filter(function(c) {
          return c.id === ccid;
        });
        if (channels.length > 0) {
          return channels[0];
        } else {
          return void 0;
        }
      }
      return void 0;
    };

    return Params;

  })();

}).call(this);
(function() {
  window.Stats = {
    hosts: {
      production: "metrics.coub.com"
    },
    persistentParams: {},
    queue: [],
    init: function() {
      if (this.inited) {
        return;
      }
      setTimeout((function() {
        return $(window).bind('popstate', (function() {
          return Stats.track('pageview', {
            from_popstate: true
          });
        }));
      }), 5000);
      this.inited = true;
      return Stats.track('pageview');
    },
    track: function(evt_name, params, sync) {
      var ext_params, ga_interpolations, ga_virt_interpolations;
      this.init();
      if (params == null) {
        params = {};
      }
      delete params["_type"];
      ga_interpolations = {
        "coub_created": ['Coub', 'Create'],
        "user_created": ['User', 'Create']
      };
      ga_virt_interpolations = {
        "coub_created": "/virt/coub-create",
        "user_created": "/virt/user-create"
      };
      if ((typeof ga !== "undefined" && ga !== null) && ga_interpolations[evt_name]) {
        ga('send', 'pageview', ga_virt_interpolations[evt_name]);
        ga('send', 'event', ga_interpolations[evt_name][0], ga_interpolations[evt_name][1]);
      }
      if ($('html').attr('class')) {
        params['browser'] = $('html').attr('class').split(' ');
      }
      params['screen_resolution'] = [screen.width, screen.height];
      params['user_agent'] = window.navigator.userAgent;
      params['page_url'] = window.location.pathname;
      params['page_params'] = window.location.search;
      params['page_section'] = GlobalState.STATS.getPageSection();
      if (window.signed_in) {
        params['signed_in'] = true;
      } else {
        params['signed_in'] = false;
      }
      _.extend(params, this.persistentParams);
      if (window.is_admin) {
        params['is_admin'] = true;
      }
      if (params['signed_in']) {
        ext_params = _.extend(params, {
          'cur_user_channels_count': Params.getBranchValue("current_user.channels").length,
          'cur_user_coubs_count': this.sumProp(Params.getBranchValue("current_user.channels"), 'simple_coubs_count'),
          'cur_user_recoubs_count': this.sumProp(Params.getBranchValue("current_user.channels"), 'recoubs_count'),
          'cur_user_followers_count': this.sumProp(Params.getBranchValue("current_user.channels"), 'followers_count'),
          'cur_user_following_count': this.sumProp(Params.getBranchValue("current_user.channels"), 'following_count')
        });
      } else {
        ext_params = params;
      }
      if (typeof Ces !== "undefined") {
        return Ces.track(evt_name, ext_params, sync);
      }
    },
    sumProp: function(objects, prop) {
      return _.reduce(objects, (function(memo, obj) {
        return memo + obj[prop];
      }), 0);
    },
    deliverQueue: function() {
      var host, sending_data;
      if (this.queue.length === 0) {
        return;
      }
      if (!this.hosts[window.env]) {
        return;
      }
      host = this.hosts[window.env];
      sending_data = {
        events: encodeURIComponent(JSON.stringify(this.queue))
      };
      $.ajax({
        type: "GET",
        url: "http://" + host + "/events.jsonp",
        dataType: "jsonp",
        data: sending_data
      });
      return this.queue = [];
    },
    addPersistentParameters: function(obj) {
      this.init();
      return _.extend(this.persistentParams, obj);
    }
  };

}).call(this);
(function() {
  window.Tooltip = (function() {
    function Tooltip(opts) {
      var i, j, k, len, len1, offsetParams, param, ref, v;
      this.element = opts.element;
      if (opts == null) {
        opts = {};
      }
      if (opts.type == null) {
        opts.type = "";
      }
      if (opts.content == null) {
        opts.content = "";
      }
      this.opts = opts;
      this.el = $("<div class=\"tooltip tooltip--simple " + opts.type + "\">\n  <div class=\"tooltip__inner\">\n    " + opts.content + "\n  </div>\n</div>");
      if (this.opts.parent) {
        this.opts.parent.append(this.el);
      } else if (helpers.Location.isFullScreen()) {
        $($(document).fullScreen()).append(this.el);
      } else {
        $("body").append(this.el);
      }
      this.offsets = [];
      offsetParams = ["data-prompt-left", "data-prompt-top"];
      for (j = 0, len = offsetParams.length; j < len; j++) {
        param = offsetParams[j];
        if ((this.element != null) && (v = this.element.attr(param))) {
          this.offsets.push(parseInt(v));
        } else {
          this.offsets.push(0);
        }
      }
      this.fsOffsets = this.offsets.slice();
      i = 0;
      ref = ['data-fs-prompt-left', 'data-fs-prompt-top'];
      for (k = 0, len1 = ref.length; k < len1; k++) {
        param = ref[k];
        if ((this.element != null) && (v = this.element.attr(param))) {
          this.fsOffsets[i] = parseInt(v);
        }
        i++;
      }
    }

    Tooltip.prototype.setContent = function(content) {
      return this.el.find(".tooltip__inner").html(content);
    };

    Tooltip.prototype.remove = function() {
      return this.el.remove();
    };

    Tooltip.prototype.hide = function() {
      if (this.el.is(":visible")) {
        return this.el.hide();
      }
    };

    Tooltip.prototype.show = function() {
      if (!this.el.is(":visible")) {
        return this.el.show();
      }
    };

    Tooltip.prototype.position = function(left, top, direction, constraint) {
      var elWidth, offsets, shift;
      elWidth = this.el.innerWidth();
      shift = 0;
      offsets = helpers.Location.isFullScreen() ? this.fsOffsets : this.offsets;
      if (['above', 'below'].indexOf(direction) !== -1) {
        switch (constraint) {
          case 'left':
            left -= this.element.outerWidth() / 2 - offsets[0];
            break;
          case 'right':
            left -= elWidth - this.element.outerWidth() / 2 - offsets[0];
            break;
          default:
            left = (left - elWidth / 2) + offsets[0];
        }
      }
      switch (direction) {
        case 'above':
          top = (top - this.el.height() + shift) + offsets[1];
          break;
        case 'below':
          shift += 3;
          top = top + this.el.outerHeight() + shift + offsets[1];
          break;
        case 'left':
          top = top + this.el.outerHeight() / 2 + offsets[1];
          left = left - elWidth - 3 + offsets[0];
          break;
        case 'right':
          top = top + this.el.outerHeight() / 2 + offsets[1];
          left = left + elWidth + 3 + offsets[0];
          break;
        default:
          top = (top - this.el.height() + shift) + offsets[1];
          left = (left - elWidth / 2) + offsets[0];
      }
      if (top < 0) {
        top = 0;
      }
      if (left < 0) {
        left = 0;
      }
      return this.el.css({
        top: Math.round(top) + "px",
        left: Math.round(left) + "px"
      });
    };

    Tooltip.prototype.positionDirectly = function(left, top) {
      var elWidth, newLeft, newTop;
      elWidth = this.el.innerWidth();
      newLeft = left - elWidth / 2;
      newTop = top - this.el.height() + 8;
      return this.el.css({
        left: Math.round(newLeft) + "px",
        top: Math.round(newTop) + "px"
      });
    };

    return Tooltip;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  pages.ApplicationBody = (function() {
    ApplicationBody.ATTR_NAME = 'application-body';

    function ApplicationBody(el) {
      this.el = el;
      this.toggleSection = bind(this.toggleSection, this);
      this.$appMenuItem = $('.application__menu__item', this.el);
      this.$appSection = $('[application-section]', this.el);
      this.$form = $('.vertical_application_form', this.el);
      this.$appMenuItem.on('click', this.toggleSection);
      $('[application-item-select]', this.el).on('focus', function() {
        return $(this).select();
      });
      this.validation();
    }

    ApplicationBody.prototype.toggleSection = function(e) {
      var item, section;
      item = $(e.currentTarget);
      section = item.attr('to-application-section');
      if (!item.hasClass('-active')) {
        this.$appMenuItem.removeClass('-active');
        item.addClass('-active');
        this.$appSection.hide();
        return $("[application-section=" + section + "]", this.el).show();
      }
    };

    ApplicationBody.prototype.validation = function() {
      $.validator.addMethod('url', function(value, element) {
        if (value.length) {
          if (value.match(URLRepresent.URL_PATTERN)) {
            return true;
          } else {
            return false;
          }
        } else {
          return true;
        }
      }, I18n.t('dev.applications.form.error'));
      $.validator.addMethod('itunes_url', function(value, element) {
        var url;
        if (value.length) {
          url = new URLRepresent(value);
          if (url.domain && url.domain === 'itunes.apple.com') {
            return true;
          } else {
            return false;
          }
        } else {
          return true;
        }
      }, I18n.t('dev.applications.form.error'));
      $.validator.addMethod('google_play_url', function(value, element) {
        var url;
        if (value.length) {
          url = new URLRepresent(value);
          if (url.domain && url.domain === 'play.google.com') {
            return true;
          } else {
            return false;
          }
        } else {
          return true;
        }
      }, I18n.t('dev.applications.form.error'));
      $.validator.addClassRules('url-dependant', {
        url: true
      });
      return this.$form.validate({
        onkeyup: false,
        onfocusout: false,
        errorElement: 'div',
        rules: {
          'developer_application[name]': {
            required: true
          },
          'developer_application[redirect_uri]': {
            required: true,
            url: true
          },
          'developer_application[url]': {
            required: true,
            url: true
          },
          'developer_application[app_store_url]': {
            itunes_url: true
          },
          'developer_application[google_play_url]': {
            google_play_url: true
          }
        }
      });
    };

    return ApplicationBody;

  })();

}).call(this);
(function() {
  pages.bestCoubs2012.Page = (function() {
    Page.ATTR_NAME = "page-best-coubs-2012";

    function Page(el) {
      this.el = el;
      this.timeline = new clientsideTimeline.ClientsideTimeline($('[clientside-timeline]', this.el));
      if (!$.storage.get('best-2012')) {
        $.storage.set('best-2012', $('[clientside-timeline]', this.el).attr('view'));
      }
      this.viewSelectors = widgets.timeline.ViewSelector.constructIn(this.el);
      this.timelineControls = new widgets.timeline.TimelineControls(this.el);
      CustomSharingButton.constructIn(this.el);
    }

    return Page;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  pages.bestCoubs2013.Page = (function() {
    Page.ATTR_NAME = "page-best-coubs-2013";

    function Page(page) {
      this.unembedAll = bind(this.unembedAll, this);
      this.initBlocks = bind(this.initBlocks, this);
      this.renderMems = bind(this.renderMems, this);
      this.renderCoubs = bind(this.renderCoubs, this);
      this.renderMasonry = bind(this.renderMasonry, this);
      this.setCurrentPage = bind(this.setCurrentPage, this);
      this.makeActive = bind(this.makeActive, this);
      this.getSelectedPage = bind(this.getSelectedPage, this);
      this.initSharing = bind(this.initSharing, this);
      this.initData = bind(this.initData, this);
      this.p = page;
      this.pageSelector = $("[page-selector]", this.p);
      this.pages = $(".best-2013__page", this.p);
      this.initSharing();
      this.initData();
    }

    Page.prototype.initData = function() {
      var complete, rotatorContainer;
      rotatorContainer = this.pages.filter('[data-page-id=popular]').first().find(".best-2013__page__coubs");
      LoadRotator.appendToContainterAndStart(rotatorContainer);
      complete = (function(_this) {
        return function(resp) {
          var p;
          if (typeof resp === 'string') {
            resp = JSON.parse(resp);
          }
          LoadRotator.removeFromContainer(rotatorContainer);
          _this.data = resp;
          _this.DEFAULT_ACTIVE_PAGE = _this.data.popular;
          p = _this.pages.filter("[data-page-id='" + _this.data.hidden_gems.id + "']");
          _this.renderCoubs(_this.data.hidden_gems.coubs, p.find(".best-2013__page__coubs"));
          p.attr("data-rendered", "prerendered-masonry");
          _this.setCurrentPage(_this.getSelectedPage());
          return _this.p.find("[data-page]").bind("click", function(e) {
            var el;
            el = $(e.currentTarget);
            if (el.attr("data-scroll-to-top") === "true") {
              $.scrollTo(0, 500);
              return setTimeout((function() {
                return _this.setCurrentPage(_this.data[el.attr("data-page")]);
              }), 600);
            } else {
              return _this.setCurrentPage(_this.data[el.attr("data-page")]);
            }
          });
        };
      })(this);
      return $.get(Routes.best_coubs2013_data_api_v2_best_index_path()).done(complete).fail(ErrorMessages.internalServerError);
    };

    Page.prototype.initSharing = function() {
      var p, providers, rendered, sharingImage, sharingMessage;
      sharingMessage = I18n.t("meta.pages.best_coubs2013.title");
      sharingImage = this.p.attr("sharing-image");
      p = SocialSharingDataProvider.TYPES;
      if (Params.get("country_ip") === "Russian Federation") {
        providers = [p.FACEBOOK, p.TWITTER, p.VKONTAKTE, p.SURFINGBIRD];
      } else {
        providers = [p.FACEBOOK, p.TWITTER, p.STUMBLEUPON, p.GOOGLEPLUS];
      }
      rendered = JST["app/site/templates/widgets/sharing/sharing_block"]({
        providers: providers,
        url: location.href.split('#')[0],
        message: sharingMessage,
        imgUrl: sharingImage
      });
      return $("[sharing]", this.p).each(function() {
        $(this).append(rendered);
        return CustomSharingButton.constructIn($(this));
      });
    };

    Page.prototype.getSelectedPage = function() {
      var v;
      if ((v = this.pageSelector.find("active")).size() === 0) {
        v = this.pageSelector.find("[data-page='" + this.DEFAULT_ACTIVE_PAGE.id + "']");
        this.makeActive(v);
        return this.DEFAULT_ACTIVE_PAGE;
      } else {
        return this.data[v.attr("data-page")];
      }
    };

    Page.prototype.makeActive = function(selector) {
      this.pageSelector.find("[data-page]").removeClass("active");
      return selector.addClass("active");
    };

    Page.prototype.setCurrentPage = function(data) {
      var container, notMems, p;
      this.unembedAll();
      this.makeActive(this.pageSelector.find("[data-page='" + data.id + "']"));
      this.pages.each(function() {
        return $(this).addClass("-hidden");
      });
      p = this.pages.filter("[data-page-id='" + data.id + "']").first();
      p.removeClass("-hidden");
      notMems = data.id !== "best_mems";
      container = p.find(".best-2013__page__coubs");
      switch (p.attr("data-rendered")) {
        case "false":
          if (notMems) {
            this.renderCoubs(data.coubs, container);
            this.renderMasonry(container);
          } else {
            this.renderMems(p, data.coubs);
          }
          return p.attr("data-rendered", "true");
        case "prerendered-masonry":
          this.renderMasonry(container);
          return p.attr("data-rendered", "true");
        default:
          if (notMems) {
            return container.masonry();
          }
      }
    };

    Page.prototype.renderMasonry = function(container) {
      container.masonry({
        columnWidth: 310,
        gutterWidth: 20,
        itemSelector: ".coub:visible"
      });
      return _.defer((function(_this) {
        return function() {
          container.masonry('reload');
          return _this.initBlocks(container);
        };
      })(this));
    };

    Page.prototype.renderCoubs = function(coubs, container) {
      var coub, i, len, rendered;
      rendered = "";
      for (i = 0, len = coubs.length; i < len; i++) {
        coub = coubs[i];
        coub.render = {
          "card-type": "small"
        };
        rendered += JST["app/site/templates/coub_block/coub"](coub);
      }
      return container.append(rendered);
    };

    Page.prototype.renderMems = function(memBlock, mems) {
      var container, coub, coubs, i, j, len, len1, name, ref, rendered, section;
      ref = memBlock.find("section");
      for (i = 0, len = ref.length; i < len; i++) {
        section = ref[i];
        name = $(section).attr("data-type");
        coubs = mems[name];
        container = $(section).find(".channelPreview");
        rendered = "";
        for (j = 0, len1 = coubs.length; j < len1; j++) {
          coub = coubs[j];
          coub.render = {
            "card-type": "small"
          };
          rendered += JST["app/site/templates/coub_block/coub"](coub);
        }
        container.append(rendered);
      }
      return _.defer((function(_this) {
        return function() {
          return _this.initBlocks(memBlock);
        };
      })(this));
    };

    Page.prototype.initBlocks = function(container) {
      var vbs;
      CoubBlockClientside.constructFromContainer(container);
      vbs = container.find(".viewer");
      return vbs.trigger(Player.ACTION_ACTIVATE_HAND_CONTROL);
    };

    Page.prototype.unembedAll = function(e) {
      var block;
      if (e != null) {
        block = $(e.currentTarget);
        return $(".viewer", this.p).not(block).trigger("unembed");
      } else {
        return $(".viewer", this.p).trigger("unembed");
      }
    };

    return Page;

  })();

}).call(this);
(function() {
  pages.bestCoubs2014.Page = (function() {
    Page.ATTR_NAME = "page-best-coubs-2014";

    function Page(page) {
      this.el = page;
      this.navItems = $('.best-2014__menu li[data-alias]');
      this.tabs = $('.best-2014__page', this.el);
      this.activeTab = this.tabs.filter('.active');
      this.footer = this.el.find('.best-2014__footer');
      this.bgCoub = $('.best-2014__bg-coub .viewer');
      this.hasPromo = $('body').hasClass('best-2014-promo');
      if (!GlobalState.PLATFORM.isMobile()) {
        this.initBgCoub();
        this.initScrollPane();
      }
      this.initNavigation();
      this.initPromoCoubs();
      widgets.timeline.ViewSelector.constructIn($('.best-2014__controls'));
      CustomSharingButton.constructIn(this.$el);
    }

    Page.prototype.initNavigation = function() {
      var $curNav;
      if (History.enabled) {
        this.navItems.click((function(_this) {
          return function(e) {
            var $nav;
            if (e.metaKey || e.ctrlKey) {
              return true;
            }
            $nav = _this.navItems.filter(e.currentTarget);
            if (!$nav.hasClass('active')) {
              History.pushState({
                alias: $nav.attr('data-alias')
              }, $nav.find('a').text(), Routes.best_coubs2014_path({
                section: $nav.attr('data-alias')
              }));
              $(window).scrollTop(0);
            }
            return false;
          };
        })(this));
        $curNav = this.navItems.filter('.active');
        this.changeTab($curNav.attr('data-page-cls'));
        History.replaceState({
          alias: $curNav.attr('data-alias')
        }, document.title, location.href);
        return $(window).on('statechange', (function(_this) {
          return function() {
            var $newNav, state;
            state = History.getState();
            $newNav = _this.navItems.filter("[data-alias=" + state.data.alias + "]");
            _this.navItems.removeClass('active');
            $newNav.addClass('active');
            return _this.changeTab($newNav.attr('data-page-cls'));
          };
        })(this));
      }
    };

    Page.prototype.changeTab = function(cls) {
      this.tabs.removeClass('active');
      this.footer.removeClass('-shown');
      this.activeTab = this.tabs.filter("." + cls).addClass('active');
      this.tab && this.tab.destroy();
      this.tab = new pages.bestCoubs2014.TimelineTab(this.activeTab);
      return $(document).off(clientsideTimeline.ClientsideTimeline.EVENT_ALL_PAGES_LOADED).on(clientsideTimeline.ClientsideTimeline.EVENT_ALL_PAGES_LOADED, (function(_this) {
        return function() {
          return _this.footer.addClass('-shown');
        };
      })(this));
    };

    Page.prototype.initBgCoub = function() {
      var height, resize;
      height = Math.round($(window).width() / this.bgCoub.attr('data-prop'));
      resize = (function(_this) {
        return function() {
          var player, width;
          width = $(window).width();
          height = Math.round(width / _this.bgCoub.attr('data-prop'));
          player = _this.bgCoub.find('object');
          _this.bgCoub.add(player).css({
            width: width,
            height: height
          });
          return player.attr({
            height: height,
            width: width
          });
        };
      })(this);
      this.bgCoub.player({
        muted: true,
        startWithHD: true,
        noControls: true
      }).trigger('play');
      this.bgCoub.one('loaded', (function(_this) {
        return function() {
          resize();
          $(window).on('resize.bestCoubs2014', function() {
            return resize();
          });
          return _this.bgCoub.addClass('faded');
        };
      })(this));
      return this.inFocus = true;
    };

    Page.prototype.initScrollPane = function() {
      var attach, detach, fire, h, panel;
      h = helpers.Scrollers;
      panel = $('.best-2014__header', this.$el);
      panel.find('img:first').on('click', function() {
        return $.scrollTo(0, 150);
      });
      attach = (function(_this) {
        return function() {
          if (_this.inFocus) {
            _this.bgCoub.trigger('suspend');
          }
          panel.addClass('attached');
          return _this.inFocus = false;
        };
      })(this);
      detach = (function(_this) {
        return function() {
          if (!_this.inFocus) {
            _this.bgCoub.trigger('play');
          }
          panel.removeClass('attached');
          return _this.inFocus = true;
        };
      })(this);
      fire = function() {
        return h.changeUI(500, attach, detach);
      };
      return new ScrollEventOptimizer(fire, 500);
    };

    Page.prototype.initPromoCoubs = function() {
      var $coubsContainer;
      if (!this.hasPromo) {
        return;
      }
      $coubsContainer = $('.best-2014__promo-col__coubs', this.el);
      $('.best-2014__page', this.el).on('playWasStarted', function() {
        return $('.best-2014__promo-col__coubs .viewer').trigger('suspend');
      });
      return $.get(Routes.best_2014_promo_coubs_api_v2_best_index_path()).done((function(_this) {
        return function(data) {
          var coub, html, i, len, suspend, vbs;
          $coubsContainer.html('');
          if (data && data.length !== 0) {
            html = '';
            for (i = 0, len = data.length; i < len; i++) {
              coub = data[i];
              coub.render = {
                'card-type': blocks.coub.CardTypes.types.small.name
              };
              html += JST["app/site/templates/coub_block/coub"](coub);
            }
            $coubsContainer.html(html);
            $coubsContainer.find('.viewer__img').on('load', function() {
              return $(this).addClass('loaded');
            });
            CoubBlockClientside.constructFromContainer($coubsContainer);
            $coubsContainer.find('.viewer').trigger(Player.ACTION_ACTIVATE_HAND_CONTROL);
          }
          $('.coubs-list', _this.activeTab).triggerHandler(clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_CONTENTS);
          vbs = $('.viewer', $coubsContainer);
          suspend = function(e) {
            var bVbs, curView;
            bVbs = $(".viewer", $coubsContainer).not($(e.currentTarget));
            curView = $('.coubs-list', _this.activeTab).attr('view');
            switch (curView) {
              case 'list':
                $('.viewer', _this.activeTab).trigger('suspend');
                break;
              case 'mosaic':
                $('.viewer', _this.activeTab).trigger('unembed');
            }
            return bVbs.trigger('unembed');
          };
          return vbs.on('playWasStarted', suspend);
        };
      })(this));
    };

    return Page;

  })();

}).call(this);
(function() {
  pages.bestCoubs2014.TimelineTab = (function() {
    function TimelineTab($el, url) {
      this.el = $el;
      this.timeline = new clientsideTimeline.ClientsideTimeline($('[clientside-timeline]', this.el));
      this.timelineControls = new widgets.timeline.TimelineControls(this.el);
    }

    TimelineTab.prototype.destroy = function() {
      this.timeline.destroy();
      this.timelineControls.destroy();
      this.timeline = void 0;
      return this.timelineControls = void 0;
    };

    return TimelineTab;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  pages.bestCoubs2015.Page = (function() {
    Page.ATTR_NAME = "page-best-coubs-2015";

    function Page(page) {
      this.renderStatsPixel = bind(this.renderStatsPixel, this);
      this.initVoteButton = bind(this.initVoteButton, this);
      this.el = page;
      this.navItems = $('.best-2015__menu li[data-alias]');
      this.tabs = $('.best-2015-page', this.el);
      this.activeTab = this.tabs.filter('.active');
      CustomSharingButton.constructIn();
      if (!GlobalState.PLATFORM.isMobile()) {
        this.initScrollPane();
      }
      this.initNavigation();
      this.initTimelinesView();
      this.initVoteButton();
      this.listenChannelChange();
    }

    Page.prototype.initVoteButton = function() {
      var btn, collection_id, errorUnvoted, errorVoted, isPending, isVoted, provider, successUnvoted, successVoted, votes_count;
      btn = $('.vote-block .vote-button', this.el);
      votes_count = $('.vote-block .votes-count', this.el);
      collection_id = $('.vote-block').attr('data-collection-id');
      isPending = false;
      isVoted = btn.hasClass('-voted');
      provider = new window.Best2015DataProvider();
      successUnvoted = (function(_this) {
        return function() {
          return isPending = false;
        };
      })(this);
      successVoted = (function(_this) {
        return function() {
          return isPending = false;
        };
      })(this);
      errorVoted = (function(_this) {
        return function(e) {
          isPending = false;
          isVoted = false;
          btn.removeClass('-voted');
          votes_count.text(Number($(votes_count[0]).text()) - 1);
          return console.log('Best2015 VoteButton Error', e);
        };
      })(this);
      errorUnvoted = (function(_this) {
        return function(e) {
          isPending = false;
          isVoted = true;
          btn.addClass('-voted');
          votes_count.text(Number($(votes_count[0]).text()) + 1);
          return console.log('Best2015 VoteButton Error', e);
        };
      })(this);
      return btn.on('click', (function(_this) {
        return function() {
          if (isPending) {
            return;
          }
          isPending = true;
          if (isVoted) {
            provider.unvote(collection_id, successUnvoted, errorUnvoted);
            isVoted = false;
            btn.removeClass('-voted');
            return votes_count.text(Number($(votes_count[0]).text()) - 1);
          } else {
            provider.vote(collection_id, successVoted, errorVoted);
            isVoted = true;
            btn.addClass('-voted');
            return votes_count.text(Number($(votes_count[0]).text()) + 1);
          }
        };
      })(this));
    };

    Page.prototype.initNavigation = function() {
      var $curNav;
      if (History.enabled) {
        $curNav = this.navItems.filter('.active');
        this.navItems.click((function(_this) {
          return function(e) {
            var $nav;
            if (e.metaKey || e.ctrlKey) {
              return true;
            }
            $nav = _this.navItems.filter(e.currentTarget);
            if ($curNav.hasClass('-others-best')) {
              return true;
            } else if (!$nav.hasClass('active')) {
              History.pushState({
                alias: $nav.attr('data-alias')
              }, $nav.find('a').text(), Routes.best_coubs2015_path({
                section: $nav.attr('data-alias')
              }));
              $(window).scrollTop(0);
            }
            return false;
          };
        })(this));
        this.changeTab($curNav.attr('data-page-cls'));
        if (!$curNav.hasClass('-others-best')) {
          History.replaceState({
            alias: $curNav.attr('data-alias')
          }, document.title, location.href);
        }
        return $(window).on('statechange', (function(_this) {
          return function() {
            var $newNav, state;
            state = History.getState();
            if (state.data.alias == null) {
              return;
            }
            $newNav = _this.navItems.filter("[data-alias='" + state.data.alias + "']");
            _this.navItems.removeClass('active selected');
            $newNav.addClass('active selected');
            return _this.changeTab($newNav.attr('data-page-cls'));
          };
        })(this));
      }
    };

    Page.prototype.changeTab = function(cls) {
      this.tabs.removeClass('active selected');
      this.activeTab = this.tabs.filter("." + cls).addClass('active selected');
      this.tab && this.tab.destroy();
      this.tab = false;
      if (cls === 'best-2015-page--users-best' && (this.tabUsersBest == null)) {
        this.tabUsersBest = new pages.bestCoubs2015.TabUsersBest(this.activeTab);
      } else if (this.activeTab.attr('timeline-tab') != null) {
        this.tab = new pages.bestCoubs2015.TimelineTab(this.activeTab, cls === 'best-2015-page--memes');
      }
      return this.renderStatsPixel(this.activeTab);
    };

    Page.prototype.initScrollPane = function() {
      var attach, detach, fire, h, panel, sharing;
      h = helpers.Scrollers;
      panel = $('.best-2015__header');
      sharing = $('.best-2015__menu__sharing', panel);
      attach = (function(_this) {
        return function() {
          panel.removeClass('-detached').addClass('-attached');
          return sharing.removeClass('-hidden');
        };
      })(this);
      detach = (function(_this) {
        return function() {
          panel.removeClass('-attached').addClass('-detached');
          return sharing.addClass('-hidden');
        };
      })(this);
      fire = function() {
        return h.changeUI(60, attach, detach);
      };
      return new ScrollEventOptimizer(fire, 500);
    };

    Page.prototype.initTimelinesView = function() {
      var provider;
      provider = new TimelineViewDataProvider();
      if (!provider.getUserViewSetting('best-2015')) {
        provider.saveUserViewSetting(provider.LIST, 'best-2015');
      }
      if (!provider.getUserViewSetting('best-2015-memes')) {
        return provider.saveUserViewSetting(provider.MOSAIC, 'best-2015-memes');
      }
    };

    Page.prototype.listenChannelChange = function() {
      return $(document).on(Params.EVENT_PARTICULAR_PARAM_CHANGED("current_channel_id"), function(e) {
        return location.reload();
      });
    };

    Page.prototype.renderStatsPixel = function(tab) {
      var img, url;
      if (tab.hasClass("best-2015-page--coubs")) {
        url = "http://ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=belzl&pfb=diuxm&pr=escpgly";
      } else if (tab.hasClass("best-2015-page--gems")) {
        url = "http://ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=belzl&pfb=diuxl&pr=escpgle";
      } else if (tab.hasClass("best-2015-page--memes")) {
        url = "http://ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=belzl&pfb=diuxj&pr=escpgki";
      } else if (tab.hasClass("best-2015-page--users-best")) {
        url = "http://ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=belzl&pfb=diuxi&pr=escpgjm";
      } else if (tab.hasClass("best-2015-page--mybest")) {
        url = "http://ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=belzl&pfb=diuxn&pr=escpgng";
      }
      if (url != null) {
        img = new Image();
        return img.src = url;
      }
    };

    return Page;

  })();

}).call(this);

/*
  Таб с подборками
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  pages.bestCoubs2015.TabUsersBest = (function(superClass) {
    extend(TabUsersBest, superClass);

    function TabUsersBest(el1) {
      this.el = el1;
      this.isLoadingComplete = bind(this.isLoadingComplete, this);
      this.getData = bind(this.getData, this);
      this.getTemplate = bind(this.getTemplate, this);
      this.appendToList = bind(this.appendToList, this);
      this.hideLoader = bind(this.hideLoader, this);
      this.showLoader = bind(this.showLoader, this);
      this.getFinalists = bind(this.getFinalists, this);
      this.getCurrentPage = bind(this.getCurrentPage, this);
      this.getNextPage = bind(this.getNextPage, this);
      this.initScroll = bind(this.initScroll, this);
      TabUsersBest.__super__.constructor.apply(this, arguments);
      this.locker = new chms.utils.Locker();
      this.lists = this.el.find("[users-list]");
      this.loader = this.el.find("[loader]");
      this.currentPage = 1;
      this._rendered = {};
      this.pageCunts = {
        total: []
      };
      this.getFinalists();

      /*@getCurrentPage()
      _.defer @initScroll
       */
    }

    TabUsersBest.prototype.initScroll = function() {
      var sh;
      sh = functions.ScrollHandler;
      return $(document).bind(sh.EVENT_SCROLL, (function(_this) {
        return function() {
          if ((sh.getScrollPos() + $(window).height()) >= _this.loader.offset().top) {
            return _this.getNextPage();
          }
        };
      })(this));
    };

    TabUsersBest.prototype.getNextPage = function() {
      if (this.isLoadingComplete()) {
        return;
      }
      return this.locker.safeExec((function(_this) {
        return function() {
          _this.currentPage++;
          return _this.getCurrentPage();
        };
      })(this));
    };

    TabUsersBest.prototype.getCurrentPage = function() {
      var collected, completed, onComplete;
      if (this.locker.isLocked() || this.isLoadingComplete()) {
        return;
      }
      this.locker.lock();
      this.showLoader();
      collected = {};
      completed = 0;
      onComplete = (function(_this) {
        return function(data, listId) {
          var entry;
          completed++;
          collected[listId] = data['collections'];
          if (_this.pageCunts[listId] == null) {
            _this.pageCunts[listId] = true;
            _this.pageCunts.total.push(data.total_pages);
          }
          if (completed === _this.lists.length) {
            _this.hideLoader();
            for (listId in collected) {
              entry = collected[listId];
              _this.appendToList(listId, entry);
            }
            return _this.locker.unlock();
          }
        };
      })(this);
      return this.lists.each((function(_this) {
        return function(i, el) {
          var group, id, list, pageSize;
          list = $(el);
          group = list.attr("group");
          id = list.attr("id");
          pageSize = list.attr("page-size");
          return _this.getData(group, _this.currentPage, (function(data) {
            return onComplete(data, this.id);
          }).bind({
            id: id
          }), ErrorMessages.internalServerError, pageSize);
        };
      })(this));
    };

    TabUsersBest.prototype.getFinalists = function() {
      var group, id, list, onComplete, pageSize;
      if (this.locker.isLocked() || this.isLoadingComplete()) {
        return;
      }
      this.locker.lock();
      this.showLoader();
      onComplete = (function(_this) {
        return function(data, listId) {
          _this.hideLoader();
          _this.appendToList(listId, data['collections']);
          return _this.locker.unlock();
        };
      })(this);
      list = this.lists;
      group = list.attr("group");
      id = list.attr("id");
      pageSize = list.attr("page-size");
      return this.getData(group, this.currentPage, (function(data) {
        return onComplete(data, this.id);
      }).bind({
        id: id
      }), ErrorMessages.internalServerError, pageSize);
    };

    TabUsersBest.prototype.showLoader = function() {
      return LoadRotator.appendToContainterAndStart(this.loader);
    };

    TabUsersBest.prototype.hideLoader = function() {
      return LoadRotator.removeFromContainer(this.loader);
    };

    TabUsersBest.prototype.appendToList = function(listId, data) {
      var avatar, e, entry, html, j, len, list;
      list = this.lists.filter("[id='" + listId + "']");
      html = '';
      for (j = 0, len = data.length; j < len; j++) {
        entry = data[j];
        if ((this._rendered[listId] != null) && this._rendered[listId][entry.id] === true) {
          continue;
        } else {
          if (!this._rendered[listId]) {
            this._rendered[listId] = {};
          }
          this._rendered[listId][entry.id] = true;
        }
        try {
          avatar = entry.channel_avatar_versions.template;
          if (avatar != null) {
            avatar = helpers.Application.retinizeImg(avatar.replace("%{version}", "profile_pic_new"), avatar.replace("%{version}", "profile_pic_new_2x"));
          } else {
            avatar = "src='" + (Params.get("missing_userpic")) + "'";
          }
        } catch (error1) {
          e = error1;
          avatar = "src='" + (Params.get("missing_userpic")) + "'";
        }
        html += this.getTemplate(avatar, entry.best2015_collection_url, entry.channel_title, entry.votes_count);
      }
      return list.find("[container]").append(html);
    };

    TabUsersBest.prototype.getTemplate = function(img, bestUrl, channelTitle, votesCount) {
      var desc;
      desc = "<b>" + votesCount + "</b> vote";
      if (votesCount !== 1) {
        desc += "s";
      }
      channelTitle = utils.htmlEncode(channelTitle);
      return "<div class=\"object-media\">\n  <div class=\"object-media__img\">\n    <a href=\"" + bestUrl + "\" class=\"-ribbon\">\n      <img " + img + " class=\"image\" width=\"55\" height=\"55\">\n    </a>\n  </div>\n  <div class=\"object-media__body\">\n    <div class=\"object-media__body__title\">\n      <a href=\"" + bestUrl + "\">" + channelTitle + "</a>\n    </div>\n    <div class=\"object-media__body__desc " + (votesCount > 0 ? '' : '-v-hidden') + "\">\n      " + desc + "\n    </div>\n  </div>\n</div>";
    };

    TabUsersBest.prototype.PAGE_SIZE = 10;

    TabUsersBest.prototype.getData = function(group, page, success, error, pageSize) {
      if (pageSize == null) {
        pageSize = this.PAGE_SIZE;
      }
      return $.ajax({
        type: "GET",
        url: Routes.api_v2_promo_best2015_collections_path({
          type: group,
          page: page,
          per_page: pageSize
        }),
        success: success,
        error: error
      });
    };

    TabUsersBest.prototype.isLoadingComplete = function() {
      var max;
      if (this.pageCunts.total.length > 0) {
        max = Math.max.apply(this, this.pageCunts.total);
        return this.currentPage > max;
      } else {
        return false;
      }
    };

    return TabUsersBest;

  })(abstract.Object);

}).call(this);
(function() {
  pages.bestCoubs2015.TimelineTab = (function() {
    function TimelineTab($el, disable_controls) {
      this.disable_controls = disable_controls;
      this.timeline = new clientsideTimeline.ClientsideTimeline($('[clientside-timeline]', $el));
      if (!this.disable_controls) {
        this.viewSelectors = widgets.timeline.ViewSelector.constructIn($el);
        this.timelineControls = new widgets.timeline.TimelineControls($el);
      }
    }

    TimelineTab.prototype.destroy = function() {
      this.timeline.destroy();
      this.timeline = void 0;
      if (!this.disable_controls) {
        this.timelineControls.destroy();
        this.timelineControls = void 0;
        this.viewSelectors.each(function() {
          return this.destroy();
        });
        return this.viewSelectors = void 0;
      }
    };

    return TimelineTab;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  pages.bestCoubs2016.Page = (function() {
    Page.ATTR_NAME = "page-best-coubs-2016";

    function Page(el) {
      this.el = el;
      this.checkScrollPos = bind(this.checkScrollPos, this);
      this.initAnimationControl = bind(this.initAnimationControl, this);
      this.timeline = new clientsideTimeline.ClientsideTimeline($('[clientside-timeline]', this.el));
      this.viewSelectors = widgets.timeline.ViewSelector.constructIn(this.el);
      this.timelineControls = new widgets.timeline.TimelineControls(this.el);
      CustomSharingButton.constructIn(this.el);
      $('.best-2016__triangle', this.el).click((function(_this) {
        return function() {
          var top;
          top = $('.best-2016-page-timeline', _this.el).offset().top + 15;
          return $('body, html').animate({
            scrollTop: top
          }, 250);
        };
      })(this));
      $('.best-2016__footer .best-2016__nav-item__link', this.el).on('mouseover', (function(_this) {
        return function() {
          return $('.best-2016__footer .best-2016__nav-item__icon', _this.el).addClass('-colored');
        };
      })(this));
      $('.best-2016__footer .best-2016__nav-item__link', this.el).on('mouseout', (function(_this) {
        return function() {
          return $('.best-2016__footer .best-2016__nav-item__icon', _this.el).removeClass('-colored');
        };
      })(this));
      this.isAnimationPlaying = true;
      this.animationIframe = $('iframe.best-2016__animation', this.el);
      if (this.animationIframe.length > 0) {
        this.initAnimationControl();
      }
    }

    Page.prototype.initAnimationControl = function() {
      this.player = this.animationIframe[0].contentWindow.player;
      if (this.player) {
        this.checkScrollPos();
        return $(window).scroll(this.checkScrollPos);
      } else {
        return setTimeout(this.initAnimationControl, 1000);
      }
    };

    Page.prototype.checkScrollPos = function() {
      var scrollPos;
      if (!this.player) {
        return;
      }
      scrollPos = $(window).scrollTop();
      if (scrollPos > this.animationIframe.offset().top + this.animationIframe.height() / 2) {
        if (this.isAnimationPlaying) {
          this.isAnimationPlaying = false;
          return this.player.pause();
        }
      } else {
        if (!this.isAnimationPlaying) {
          this.isAnimationPlaying = true;
          return this.player.play();
        }
      }
    };

    return Page;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  pages.bestCoubs2016.Countdown = (function() {
    Countdown.ATTR_NAME = 'page-best-coubs-2016-countdown';

    function Countdown(el1) {
      var button, successMsg;
      this.el = el1;
      this.setValueToElement = bind(this.setValueToElement, this);
      this.updateCountdown = bind(this.updateCountdown, this);
      this.secsToLaunch = parseInt(this.el.attr('data-time'));
      this.secsPerMinute = 60;
      this.secsPerHour = this.secsPerMinute * 60;
      this.secsPerDay = this.secsPerHour * 24;
      this.updateInterval = setInterval(this.updateCountdown, 1000);
      button = $('.best-2016__get-notified', this.el);
      successMsg = $('.best-2016__notify-success-msg', this.el);
      button.click((function(_this) {
        return function() {
          if (button.hasClass('-disabled') || button.hasClass('toggle-registration')) {
            return;
          }
          button.addClass('-disabled');
          return $.ajax({
            url: "/api/v2/users/update_regular_info",
            type: "PUT",
            data: {
              user: {
                mail_newsletter: true,
                mail_digest: true,
                system_mail: true
              }
            },
            success: function(r) {
              button.addClass('-hidden');
              return successMsg.removeClass('-hidden');
            },
            error: function(e) {
              button.removeClass('-disabled');
              return console.log(e);
            }
          });
        };
      })(this));
    }

    Countdown.prototype.updateCountdown = function() {
      var days, hours, mins, secs;
      this.secsToLaunch -= 1;
      if (this.secsToLaunch < 0) {
        clearInterval(this.updateInterval);
        setTimeout((function(_this) {
          return function() {
            return location.reload();
          };
        })(this), 5000);
      }
      days = Math.floor(this.secsToLaunch / this.secsPerDay);
      hours = Math.floor((this.secsToLaunch - days * this.secsPerDay) / this.secsPerHour);
      mins = Math.floor((this.secsToLaunch - days * this.secsPerDay - hours * this.secsPerHour) / this.secsPerMinute);
      secs = Math.floor(this.secsToLaunch - days * this.secsPerDay - hours * this.secsPerHour - mins * this.secsPerMinute);
      this.setValueToElement($('.best-2016__countdown > .days', this.el), days, 'day');
      this.setValueToElement($('.best-2016__countdown > .hours', this.el), hours, 'hour');
      this.setValueToElement($('.best-2016__countdown > .mins', this.el), mins, 'minute');
      return this.setValueToElement($('.best-2016__countdown > .secs', this.el), secs, 'second');
    };

    Countdown.prototype.setValueToElement = function(el, value, dim) {
      if (value !== 1) {
        dim = dim + "s";
      }
      if (value < 10) {
        value = "0" + value;
      }
      $('> div', el).text(value);
      return $('> p', el).text(dim.toUpperCase());
    };

    return Countdown;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  pages.bestCoubs2016.OldSpice = (function() {
    OldSpice.ATTR_NAME = 'page-best-2016-oldspice-promo';

    OldSpice.prototype.MESSAGES = {
      LOGGED: "Всё просто — проголосуй за свой любимый коуб 2016 года. Но помни, в каждой категории можно выбрать только один.",
      UNLOGGED: "Привет! У нас всё просто: логинься и голосуй! Или смотри подборку коубов от Old Spice!",
      VOTED: "Шикарно! У нас ещё куча категорий, которые ждут твоего голоса, а также взрывная подборка коубов от Old Spice!",
      VOTED_BEFORE: "Круто! Ниже — лучшие на данный момент коубы по мнению других пользователей. Зацени!"
    };

    function OldSpice(el1) {
      this.el = el1;
      this.playAudio = bind(this.playAudio, this);
      this.setHeaderText = bind(this.setHeaderText, this);
      this.onError = bind(this.onError, this);
      this.resetVoteBlock = bind(this.resetVoteBlock, this);
      this.setCategory = bind(this.setCategory, this);
      this.initTimeline = bind(this.initTimeline, this);
      this.markCoubAndCategoryAsVoted = bind(this.markCoubAndCategoryAsVoted, this);
      this.initCoubVote = bind(this.initCoubVote, this);
      this.initCoubInput = bind(this.initCoubInput, this);
      this.dataProvider = new window.OldSpiceDataProvider();
      this.locker = new chms.utils.Locker();
      widgets.timeline.ViewSelector.constructIn(this.el);
      this.originalHeaderText = GlobalState.USER.isLogedIn() ? this.MESSAGES.LOGGED : this.MESSAGES.UNLOGGED;
      this.setHeaderText(this.originalHeaderText);
      this.initCans();
      this.initCoubInput();
      this.setCategory('oldspice');
      this.initCoubVote();
    }

    OldSpice.prototype.initCans = function() {
      var $bodyContainer, $voteCanBlocks;
      $bodyContainer = $('.body-container');
      $voteCanBlocks = $('.oldspice-promo__vote-can');
      return $voteCanBlocks.on('click', '.oldspice-promo__can', (function(_this) {
        return function(e) {
          var $block;
          $block = $(e.delegateTarget).addClass('-voted');
          $bodyContainer.removeClass('citron timber');
          $bodyContainer.addClass($block.attr('data-promo-class'));
          $voteCanBlocks.not(e.delegateTarget).removeClass('-voted');
          if ($bodyContainer.hasClass('citron')) {
            return _this.trackPixel('//ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pfc=bkket&pfb=efaqe&pr=654195&pe=b');
          } else if ($bodyContainer.hasClass('timber')) {
            return _this.trackPixel('//ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pfc=bkket&pfb=efaqq&pr=554312&pe=b');
          }
        };
      })(this));
    };

    OldSpice.prototype.initCoubInput = function() {
      var addCoubToCategory, desc, form, input, loadCoub, submitBtn;
      if (!GlobalState.USER.isLogedIn()) {
        return;
      }
      form = $('.oldspice-promo__vote-block__form', this.el);
      input = $('> input', form);
      desc = $('> span', form);
      submitBtn = $('> .sb', form);
      addCoubToCategory = (function(_this) {
        return function(p) {
          var onCoubAdded;
          if (form.hasClass('-disabled')) {
            return;
          }
          form.addClass('-disabled');
          LoadRotator.appendToContainterAndStart(form);
          onCoubAdded = function(r) {
            var onVoteSuccess;
            onVoteSuccess = function(r) {
              _this.setHeaderText(_this.MESSAGES.VOTED);
              _this.playAudio();
              return loadCoub(p);
            };
            if (GlobalState.USER.isAdmin() || GlobalState.USER.isEditor()) {
              return _this.resetVoteBlock();
            } else {
              return _this.dataProvider.voteForCoub(p, _this.currentCategory, onVoteSuccess, _this.onError);
            }
          };
          return _this.dataProvider.addCoubToCategory(p, _this.currentCategory, onCoubAdded, _this.onError);
        };
      })(this);
      loadCoub = (function(_this) {
        return function(p) {
          var onCoubJsonLoaded;
          onCoubJsonLoaded = function(coub) {
            var card;
            coub.render = {
              'card-type': blocks.coub.CardTypes.types.small.name,
              'card-class': '-voted'
            };
            card = $(JST["app/site/templates/coub_block/coub"](coub));
            form.addClass('-hidden');
            form.after(card);
            new CoubBlockClientside({
              el: card
            });
            card.find('.viewer').trigger(Player.ACTION_ACTIVATE_HAND_CONTROL);
            _this.markCoubAndCategoryAsVoted(p);
            return $('.coubs-list', _this.el).triggerHandler(clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_CONTENTS);
          };
          return _this.dataProvider.loadCoubJson(p, onCoubJsonLoaded, _this.onError);
        };
      })(this);
      input.on('input', function() {
        desc.addClass('-hidden');
        return submitBtn.removeClass('-hidden');
      });
      input.on('paste', function() {
        return _.defer(function() {
          return form.submit();
        });
      });
      return form.submit(function(e) {
        var permalink, v;
        e.preventDefault();
        v = input.val();
        permalink = helpers.Application.getCoubPermalinkFromUrl(v);
        if (permalink) {
          return addCoubToCategory(permalink);
        } else {
          return addCoubToCategory('khooynya123');
        }
      });
    };

    OldSpice.prototype.initCoubVote = function() {
      if (!GlobalState.USER.isLogedIn()) {
        return;
      }
      return $('[coub-block] .coub__oldspice-vote_btn').live('click', (function(_this) {
        return function(e) {
          var onVoteSuccess, p;
          p = $(e.currentTarget).attr('data-permalink');
          onVoteSuccess = function() {
            _this.markCoubAndCategoryAsVoted(p);
            _this.setHeaderText(_this.MESSAGES.VOTED);
            return _this.playAudio();
          };
          return _this.dataProvider.voteForCoub(p, _this.currentCategory, onVoteSuccess, _this.onError);
        };
      })(this));
    };

    OldSpice.prototype.markCoubAndCategoryAsVoted = function(coubPermalink) {
      $(".oldspice-promo__categories .category-item[data-category='" + this.currentCategory + "']", this.el).addClass('-voted');
      $(".oldspice-promo__timeline [coub-block][data-permalink='" + coubPermalink + "']", this.el).addClass('-voted');
      return $(".oldspice-promo__timeline [coub-block]", this.el).each((function(_this) {
        return function(i, el) {
          el = $(el);
          if (el.attr('data-permalink') !== coubPermalink) {
            return el.addClass('-disable-vote');
          }
        };
      })(this));
    };

    OldSpice.prototype.initTimeline = function() {
      var timelineStub, url;
      timelineStub = $('.oldspice-promo__timeline-stub', this.el);
      url = "/api/v2/promo/best2016/categories/" + this.currentCategory + "/coubs";
      this.timeline && this.timeline.destroy();
      this.controls && this.controls.destroy();
      timelineStub.off('page:loaded');
      if ($(".oldspice-promo__categories .category-item[data-category='" + this.currentCategory + "']", this.el).hasClass('-voted')) {
        this.setHeaderText(this.MESSAGES.VOTED_BEFORE);
        $('.oldspice-promo__timeline').addClass('-voted');
        timelineStub.html(JST["app/site/templates/timeline/list"]({
          url: url,
          "storage-key": "best2016_oldspice"
        }));
        timelineStub.on('page:loaded', (function(_this) {
          return function() {
            var count;
            count = 0;
            return $(".oldspice-promo__timeline [coub-block]", _this.el).each(function(i, el) {
              el = $('.coub__oldspice-counter', el);
              if (el.attr('data-count')) {
                return count = parseInt(el.attr('data-count'));
              } else {
                return el.attr('data-count', ++count);
              }
            });
          };
        })(this));
      } else {
        $('.oldspice-promo__timeline').removeClass('-voted');
        timelineStub.html(JST["app/site/templates/timeline/list"]({
          url: url,
          view: "mosaic",
          "storage-key": "best2016_oldspice_vote"
        }));
      }
      this.timeline = new clientsideTimeline.ClientsideTimeline($('[clientside-timeline]', this.el));
      return this.controls = new widgets.timeline.TimelineControls(this.el);
    };

    OldSpice.prototype.setCategory = function(p) {
      this.currentCategory = p;
      this.resetVoteBlock();
      this.initTimeline();
      if (this.currentCategory === 'oldspice') {
        $('.oldspice-promo__vote-block__form', this.el).addClass('-hidden');
        return this.trackPixel('//ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pfc=bkket&pfb=efaqt&pr=887543&pe=b');
      } else {
        return $('.oldspice-promo__vote-block__form', this.el).removeClass('-hidden');
      }
    };

    OldSpice.prototype.resetVoteBlock = function() {
      var form;
      form = $('.oldspice-promo__vote-block__form', this.el);
      form.removeClass('-disabled -hidden');
      form.nextAll('div').remove();
      $('> input', form).val('');
      $('> span', form).removeClass('-hidden');
      $('> .sb', form).addClass('-hidden');
      LoadRotator.removeFromContainer(form);
      return $('.oldspice-promo__heading h1').text(this.originalHeaderText);
    };

    OldSpice.prototype.onError = function(e) {
      var error;
      this.resetVoteBlock();
      error = JSON.parse(e.responseText);
      return this.setHeaderText(error.error);
    };

    OldSpice.prototype.setHeaderText = function(t) {
      return $('.oldspice-promo__heading h1').text(t);
    };

    OldSpice.prototype.trackPixel = function(url) {
      return $('body').append("<img src='" + url + "'/>");
    };

    OldSpice.prototype.playAudio = function() {
      return $('.oldspice-promo__audio > audio').get(0).play();
    };

    return OldSpice;

  })();

}).call(this);
(function() {
  window.OldSpiceDataProvider = (function() {
    function OldSpiceDataProvider() {
      if (window.OldSpiceDataProvider.__instance == null) {
        OldSpiceDataProvider.__instance = this;
      } else {
        return OldSpiceDataProvider.__instance;
      }
    }

    OldSpiceDataProvider.prototype.addCoubToCategory = function(coubPermalink, categoryPermalink, success, error) {
      return $.ajax({
        url: "/api/v2/promo/best2016/categories/" + categoryPermalink + "/coubs",
        type: 'POST',
        data: {
          coub_url: coubPermalink
        },
        success: success,
        error: error
      });
    };

    OldSpiceDataProvider.prototype.voteForCoub = function(coubPermalink, categoryPermalink, success, error) {
      return $.ajax({
        url: "/api/v2/promo/best2016/categories/" + categoryPermalink + "/coubs/" + coubPermalink + "/vote",
        type: 'POST',
        success: success,
        error: error
      });
    };

    OldSpiceDataProvider.prototype.loadCoubJson = function(coubPermalink, success, error) {
      return $.ajax({
        url: "/coubs/" + coubPermalink + ".json",
        type: "GET",
        success: success,
        error: error
      });
    };

    return OldSpiceDataProvider;

  })();

}).call(this);
(function() {
  pages.bestCoubs2017.Page = (function() {
    Page.ATTR_NAME = "page-best-coubs-2017";

    function Page(el) {
      widgets.timeline.ViewSelector.initWithEvents(el, $(".viewSelector.active", el).attr("view"));
      new widgets.timeline.TimelineControls(el);
      CustomSharingButton.constructIn(el);
      chms.utils.Autoinit.init(widgets.CopyLinkToClipboard, el);
    }

    return Page;

  })();

}).call(this);
(function() {
  pages.bestCoubs2018.Page = (function() {
    Page.ATTR_NAME = "page-best-coubs-2018";

    function Page(el) {
      this.el = el;
      widgets.timeline.ViewSelector.constructIn(this.el);
      new widgets.timeline.TimelineControls(this.el);
      CustomSharingButton.constructIn(this.el);
      chms.utils.Autoinit.init(widgets.CopyLinkToClipboard, this.el);
    }

    return Page;

  })();

}).call(this);
(function() {
  pages.bestCoubs2019.Page = (function() {
    Page.ATTR_NAME = "page-best-coubs-2019";

    function Page(el) {
      this.el = el;
      widgets.timeline.ViewSelector.constructIn(this.el);
      new widgets.timeline.TimelineControls(this.el);
      CustomSharingButton.constructIn(this.el);
      chms.utils.Autoinit.init(widgets.CopyLinkToClipboard, this.el);
    }

    return Page;

  })();

}).call(this);
(function() {
  window.DevDocsPage = (function() {
    function DevDocsPage(el) {
      this.$el = $(el);
      this.heading = $('.dev-docs-heading h1', this.$el);
      this.content = $('.dev-docs-content', this.$el);
      this.searchInput = $('.dev-docs-nav__form input', this.$el);
      this.navItems = $('.dev-docs-nav__list:first [menu-item]', this.$el);
      this.navRootItems = $('.dev-docs-nav__list:first [menu-item-root]', this.$el);
      this.isSearchMode = false;
      this.initSearchForm();
      this.initNavigation();
    }

    DevDocsPage.prototype.initSearchForm = function() {
      var inputTimeout;
      inputTimeout = 0;
      return this.searchInput.on('input', (function(_this) {
        return function(e) {
          clearTimeout(inputTimeout);
          if (!_this.searchInput.val()) {
            return;
          }
          return inputTimeout = _.delay(function() {
            _this.isSearchMode = true;
            _this.setLoader();
            _this.menuMarkActive();
            _this.heading.html(I18n.t('dev.docs.search.title'));
            _this.searchXhr && _this.searchXhr.abort();
            _this.searchXhr = $.get(Routes.dev_docs_search_path({
              q: _this.searchInput.val()
            }));
            _this.searchXhr.done(function(data) {
              var html;
              if (data.length !== 0) {
                html = '';
                _.each(data, function(row) {
                  html += "<h3><a href='" + (Routes.dev_doc_path(row.path)) + "'>" + row.title + "</a></h3>";
                  return _.each(row.matches, function(match) {
                    return html += "<p>" + match + "</p>";
                  });
                });
                return _this.setContent("<div class='dev-docs-search-item'>" + html + "</div>");
              } else {
                return _this.setContent("<div class='dev-docs-nothing-found'>" + (I18n.t('dev.docs.search.nothing_found')) + "</div>");
              }
            });
            return _this.searchXhr.fail(ErrorMessages.ajaxCallServerError);
          }, e.which === 13 && 1 || 500);
        };
      })(this));
    };

    DevDocsPage.prototype.initNavigation = function() {
      if (History.enabled) {
        this.navItems.click((function(_this) {
          return function(e) {
            var $link;
            if (e.metaKey || event.ctrlKey) {
              return true;
            }
            _this.searchInput.val('');
            $link = _this.navItems.filter(e.currentTarget);
            if (_this.isSearchMode) {
              _this.isSearchMode = false;
              if ($link.attr('data-id') === History.getState().data.pageId) {
                $(window).trigger('statechange');
                return false;
              }
            }
            History.pushState({
              title: $link.attr('data-title'),
              pageId: $link.attr('data-id'),
              pagePath: $link.attr('data-path')
            }, $link.attr('data-title'), $link.attr('href'));
            return false;
          };
        })(this));
        History.replaceState({
          title: this.heading.html(),
          pageId: this.$el.attr('data-preloaded-id'),
          pagePath: this.$el.attr('data-preloaded-path')
        }, document.title, location.href);
        return $(window).on('statechange', (function(_this) {
          return function() {
            var state;
            state = History.getState();
            _this.heading.html(state.data.title);
            _this.menuMarkActive(state.data.pageId);
            _this.setLoader();
            _this.navXhr && _this.navXhr.abort();
            return _this.navXhr = $.get(Routes.dev_doc_path(state.data.pagePath), {
              format: "json"
            }).done(function(data) {
              return _this.setContent(data.html);
            }).fail(ErrorMessages.ajaxCallServerError);
          };
        })(this));
      }
    };

    DevDocsPage.prototype.setLoader = function() {
      this.content.addClass('fade');
      return LoadRotator.appendToContainterAndStart(this.content, '-abs');
    };

    DevDocsPage.prototype.setContent = function(html) {
      window.scrollTo(0, 0);
      return this.content.removeClass('fade').html(html);
    };

    DevDocsPage.prototype.menuMarkActive = function(id) {
      var $menuEl, childsContainer, cr, needToUnfold, pm;
      $menuEl = this.navItems.filter("[data-id=" + id + "]:last");
      if ($menuEl.length !== 0) {
        cr = $menuEl.parents("[menu-item-root]");
        pm = $menuEl.parents("[menu-item]");
        childsContainer = cr.find(".dev-docs-nav__children");
        needToUnfold = !cr.hasClass("selected") && childsContainer.length !== 0;
        $menuEl.addClass("selected current");
        pm.add(cr).addClass("selected");
        needToUnfold && this.menuAnimateUnfold(childsContainer);
        this.navItems.not($menuEl).removeClass("selected current");
        return this.navRootItems.not(cr).removeClass("selected");
      } else {
        this.navItems.removeClass("selected current");
        return this.navRootItems.removeClass("selected");
      }
    };

    DevDocsPage.prototype.menuAnimateUnfold = function(childrenContainer) {
      var f, t;
      childrenContainer.addClass("no-transition").css({
        position: "absolute",
        height: "auto"
      });
      f = 0;
      t = childrenContainer.height();
      childrenContainer.css({
        height: f
      }).removeClass("no-transition").css({
        position: ""
      });
      return _.defer((function(_this) {
        return function() {
          return requestAnimationFrame(function() {
            return childrenContainer.css({
              height: t
            });
          });
        };
      })(this));
    };

    return DevDocsPage;

  })();

}).call(this);
(function() {
  pages.FavouritesPage = (function() {
    FavouritesPage.ATTR_NAME = 'pages-favourites-page';

    function FavouritesPage(el) {
      this.el = el;
      new widgets.timeline.SimpleTimelineWithFilters(this.el, {
        base: '/bookmarks'
      });
    }

    return FavouritesPage;

  })();

}).call(this);
(function() {
  pages.FeedPage = (function() {
    FeedPage.ATTR_NAME = 'pages-feed-page';

    function FeedPage(el) {
      this.el = el;
      widgets.timeline.ViewSelector.constructIn(this.el);
      new widgets.timeline.TimelineControls(this.el);
    }

    return FeedPage;

  })();

}).call(this);
(function() {
  pages.LikesPage = (function() {
    LikesPage.ATTR_NAME = 'pages-likes-page';

    function LikesPage(el) {
      this.el = el;
      new widgets.timeline.SimpleTimelineWithFilters(this.el, {
        base: '/likes'
      });
      $(document).on(Params.EVENT_PARTICULAR_PARAM_CHANGED("current_channel_id"), function() {
        if ($(".my-likes__all-channels > input").prop("checked")) {
          return;
        }
        return $('.coubs-list').triggerHandler(clientsideTimeline.ClientsideTimeline.ACTION_RELOAD);
      });
      $('.my-likes__all-channels > .switcher').click(function() {
        var filters;
        $(this).toggleClass('-off');
        filters = $(this).hasClass('-off') ? {
          all: null
        } : {
          all: true
        };
        return $('.coubs-list').triggerHandler(clientsideTimeline.ClientsideTimeline.ACTION_UPDATE_PROPERTIES, filters);
      });
    }

    return LikesPage;

  })();

}).call(this);

/*
  Промо страница нового редактора
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  pages.newEditorPromo.Page = (function(superClass) {
    extend(Page, superClass);

    Page.ATTR_NAME = "page-new-editor-promo";

    Page.prototype.DT = "pages.newEditorPromo.Page";

    function Page(el) {
      var $slideshow;
      this.el = el;
      this.getCoverHeight = bind(this.getCoverHeight, this);
      this.coverPlay = bind(this.coverPlay, this);
      Page.__super__.constructor.apply(this, arguments);
      this.cover = $('.hero-cover', this.el);
      this.coverViewer = this.cover.find('.viewer:first');
      this.coverHeight = this.getCoverHeight();
      new blocks.LazyViewerBlocks($('section', this.$el).not('.-carousel'));
      if (!GlobalState.PLATFORM.isMobile()) {
        this.coverViewer.player({
          muted: true,
          startWithHD: true,
          noControls: true
        }).trigger('preload').trigger('play');
        $(document).on(functions.ScrollHandler.EVENT_SCROLL, this.coverPlay);
        $(window).on('resize', (function(_this) {
          return function() {
            return _this.coverHeight = _this.getCoverHeight();
          };
        })(this));
        $slideshow = $('.slideshow', this.el);
        blocks.ViewerBlock.constructFromContainer($slideshow).done(function() {
          return $slideshow.coubs_double_carousel();
        });
      }
    }

    Page.prototype.coverPlay = function() {
      if (functions.ScrollHandler.getScrollPos() < this.coverHeight) {
        return this.coverViewer.trigger('play');
      } else {
        return this.coverViewer.trigger('suspend');
      }
    };

    Page.prototype.getCoverHeight = function() {
      return this.cover.outerHeight();
    };

    return Page;

  })(AbstractPiece);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  pages.CommunityDescription = (function() {
    function CommunityDescription(container, communityJson) {
      this.container = container;
      this.onSettingsClick = bind(this.onSettingsClick, this);
      this.onMoveRuleDown = bind(this.onMoveRuleDown, this);
      this.onMoveRuleUp = bind(this.onMoveRuleUp, this);
      this.onEditRuleClick = bind(this.onEditRuleClick, this);
      this.onNewRuleClick = bind(this.onNewRuleClick, this);
      this.init(communityJson);
    }

    CommunityDescription.prototype.init = function(communityJson) {
      var initialData;
      this.communityJson = communityJson;
      initialData = this.communityJson.description || {};
      this.data = {
        description: initialData.description || "",
        descriptionHtml: initialData.description_html || "",
        rules: initialData.rules || [],
        rulesHtml: initialData.rules_html || []
      };
      this.el = $(JST["app/site/templates/blocks/community/community_description"](this.data));
      this.container.prepend(this.el);
      if (this.data.rules.length >= 15) {
        $('.community-description__new-rule', this.el).addClass('disabled');
      }
      $('.community-description__rule:first-child .community-description__rule-dropdown .community-description__move-up', this.el).addClass('disabled');
      $('.community-description__rule:last-child .community-description__rule-dropdown .community-description__move-down', this.el).addClass('disabled');
      $('.dropdown', this.el).dropdown();
      $('.community-description__rule-dropdown', this.el).on('beforeShowed', (function(_this) {
        return function(e) {
          return _this.getClosestRuleEl(e.target).addClass('-active');
        };
      })(this));
      $('.community-description__rule-dropdown', this.el).on('beforeHided', (function(_this) {
        return function(e) {
          return _this.getClosestRuleEl(e.target).removeClass('-active');
        };
      })(this));
      $('.community-description__new-rule', this.el).click(this.onNewRuleClick);
      $('.community-description__edit-rule', this.el).click(this.onEditRuleClick);
      $('.community-description__move-up', this.el).click(this.onMoveRuleUp);
      $('.community-description__move-down', this.el).click(this.onMoveRuleDown);
      return $('.community-description__settings', this.el).click(this.onSettingsClick);
    };

    CommunityDescription.prototype.clear = function() {
      this.rulePopup && this.rulePopup.close();
      this.settingsPopup && this.settingsPopup.close();
      return this.el.remove();
    };

    CommunityDescription.prototype.save = function() {
      var dataToSave, url;
      if (this.isLoading) {
        return;
      }
      this.isLoading = true;
      url = Routes.update_description_api_v2_community_path(this.communityJson.id);
      dataToSave = {
        rules: this.data.rules.length && this.data.rules || "",
        description: this.data.description
      };
      return $.post(url, dataToSave).done((function(_this) {
        return function(r) {
          _this.clear();
          return _this.init(r);
        };
      })(this)).fail((function(_this) {
        return function(e) {
          return alert(e.responseText);
        };
      })(this)).always((function(_this) {
        return function() {
          return _this.isLoading = false;
        };
      })(this));
    };

    CommunityDescription.prototype.onNewRuleClick = function() {
      return this.createRulePopup();
    };

    CommunityDescription.prototype.onEditRuleClick = function(e) {
      var index;
      index = this.getClosestRuleEl(e.target).index();
      return this.createRulePopup(index);
    };

    CommunityDescription.prototype.onMoveRuleUp = function(e) {
      var index;
      index = this.getClosestRuleEl(e.target).index();
      return this.swapRules(index, index - 1);
    };

    CommunityDescription.prototype.onMoveRuleDown = function(e) {
      var index;
      index = this.getClosestRuleEl(e.target).index();
      return this.swapRules(index, index + 1);
    };

    CommunityDescription.prototype.onSettingsClick = function() {
      this.settingsPopup = CoubModal.createPopup({
        content: JST["app/site/templates/blocks/community/community_settings_form"]({
          description: this.data.description
        }),
        classes: 'community-description__settings-popup',
        removeOnClose: true
      });
      return $('.save', this.settingsPopup.el).click((function(_this) {
        return function() {
          var description;
          description = $("textarea[name=description]", _this.settingsPopup.el).val();
          _this.data.description = description;
          return _this.save();
        };
      })(this));
    };

    CommunityDescription.prototype.swapRules = function(i1, i2) {
      var ref;
      ref = [this.data.rules[i2], this.data.rules[i1]], this.data.rules[i1] = ref[0], this.data.rules[i2] = ref[1];
      return this.save();
    };

    CommunityDescription.prototype.createRulePopup = function(ruleIndex) {
      var data, descEl, rule, tempEl, titleEl;
      if (ruleIndex != null) {
        rule = this.data.rules[ruleIndex];
        tempEl = $(rule);
        data = {
          title: $('summary', tempEl).text(),
          description: $('section', tempEl).text()
        };
      }
      this.rulePopup = CoubModal.createPopup({
        content: JST["app/site/templates/blocks/community/community_rule_form"](data),
        classes: 'community-description__rule-popup',
        removeOnClose: true
      });
      titleEl = $("input[name=title]", this.rulePopup.el);
      descEl = $("textarea[name=description]", this.rulePopup.el);
      $('.save', this.rulePopup.el).click((function(_this) {
        return function() {
          var desc, details, result, title;
          title = titleEl.val();
          desc = descEl.val();
          if (!(title && desc)) {
            return alert('You must enter title and description');
          }
          details = $('<details>').append($('<summary>').text(title)).append($('<section>').text(desc));
          result = details.get(0).outerHTML;
          if (ruleIndex != null) {
            _this.data.rules[ruleIndex] = result;
          } else {
            _this.data.rules.push(result);
          }
          return _this.save();
        };
      })(this));
      return $('.delete', this.rulePopup.el).click((function(_this) {
        return function() {
          _this.data.rules.splice(ruleIndex, 1);
          return _this.save();
        };
      })(this));
    };

    CommunityDescription.prototype.getClosestRuleEl = function(target) {
      return $(target).closest('.community-description__rule');
    };

    return CommunityDescription;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  pages.CommunityPage = (function() {
    CommunityPage.ATTR_NAME = 'pages-community-page';

    function CommunityPage(el) {
      this.el = el;
      this.navigate = bind(this.navigate, this);
      this.render = bind(this.render, this);
      this.timelineStub = this.el.find('[pages-hot-page-timeline]');
      widgets.timeline.ViewSelector.constructIn(this.el);
      this.initRandomSelector();
      this.initPeriodSelector();
      this.initNavigation();
      this.initCommunityService();
      this.initCommunityCard();
      this.initRoutes();
    }

    CommunityPage.prototype.initNavigation = function() {
      this.pageMenuItems = $('.hot__menu .page-menu__item[data-hot-kind]', this.el);
      return this.pageMenuItems.click((function(_this) {
        return function(e) {
          var hotKind, item;
          item = $(e.currentTarget);
          hotKind = item.attr('data-hot-kind');
          return _this.navigate(hotKind, _this.communityPermalink);
        };
      })(this));
    };

    CommunityPage.prototype.initRoutes = function() {
      page('/community/:communityPermalink/:hotKind?', this.render);
      return page({
        click: false
      });
    };

    CommunityPage.prototype.initRandomSelector = function() {
      this.randomSelector = $('.page-menu__random-selector', this.el);
      return this.randomSelector.click((function(_this) {
        return function() {
          return _this.navigate('random', _this.communityPermalink);
        };
      })(this));
    };

    CommunityPage.prototype.initPeriodSelector = function() {
      this.periodContainer = $('.page-menu__period-selector', this.el);
      this.period = this.periodContainer.attr('data-period');
      return $('.dropdown--select', this.periodContainer).on(NiceSelect.EVENT_SELECTED, (function(_this) {
        return function(e) {
          if (_this.period === e.val) {
            return;
          }
          _this.period = e.val;
          $.cookie('hot_period', _this.period, {
            expires: 30,
            path: '/'
          });
          $.cookie('hot_period_selected_at', new Date().getTime(), {
            expires: 30,
            path: '/'
          });
          return _this.initializeTimeline();
        };
      })(this));
    };

    CommunityPage.prototype.initCommunityCard = function() {
      var communityId, communityTitle, defaultTitle, switcher, title;
      this.communityCard = $('.hot__community', this.el);
      switcher = $('.switcher', this.communityCard);
      communityId = this.communityCard.attr('data-community-id');
      new widgets.SubscribeToNotificationsButton({
        el: $('.notifications__subscribe', this.communityCard),
        url: Routes.api_v2_community_notifications_subscriptions_path(),
        url_params: {
          community_id: communityId
        }
      });
      if (this.communitiesService) {
        switcher.on('click', (function(_this) {
          return function() {
            var isOff;
            isOff = switcher.hasClass('-off');
            return _this.communitiesService.toggle(communityId, isOff);
          };
        })(this));
      } else {
        ToggleRegistration.construct(this.communityCard);
      }
      if (GlobalState.USER.isLogedIn()) {
        communityId = parseInt(this.communityCard.attr('data-community-id'));
        new functions.CommunitiesSorter().addOnePoint(communityId);
      }
      if (this.hotKind) {
        communityTitle = I18n.t("categories.titles." + this.communityPermalink, {
          defaultValue: $('.title h2', this.communityCard).text()
        });
        defaultTitle = (helpers.Application.capitalize(this.hotKind)) + " " + communityTitle + " coubs";
        title = I18n.t("titles." + this.hotKind + "_category", {
          category: communityTitle,
          defaultValue: defaultTitle
        });
        document.title = title;
      }
      return $('[data-prompt]', this.communityCard).prompt();
    };

    CommunityPage.prototype.initCommunityService = function() {
      var changeOffState, onCommunitiesChangeStarted, onCommunitiesUnsubscribeFailed, onCommunitySelected;
      changeOffState = (function(_this) {
        return function(communityId, isOn, disable) {
          return $(".hot__community[data-community-id=" + communityId + "] .switcher", _this.el).toggleClass('-off', !isOn).toggleClass('disabled', !!disable).trigger({
            type: Prompt.EVENT_CHANGE_TEXT,
            content: !isOn ? I18n.t('trends.prompts.unsubscribe') : I18n.t('trends.prompts.subscribe')
          });
        };
      })(this);
      onCommunitiesChangeStarted = (function(_this) {
        return function(communityId, isOn) {
          changeOffState(communityId, isOn);
          if (isOn) {
            return $('.hot__community .switcher', _this.el).removeClass('disabled');
          }
        };
      })(this);
      onCommunitiesUnsubscribeFailed = (function(_this) {
        return function(communityId) {
          return changeOffState(communityId, true, true);
        };
      })(this);
      onCommunitySelected = (function(_this) {
        return function(e, communityPermalink, communityId) {
          return _this.navigate('hot', communityPermalink);
        };
      })(this);
      if (GlobalState.USER.isLogedIn()) {
        this.communitiesService = new functions.CommunitiesService();
        this.communitiesService.on(functions.CommunitiesService.EVENTS.CHANGE_STARTED, onCommunitiesChangeStarted);
        this.communitiesService.on(functions.CommunitiesService.EVENTS.UNSUBSRIBE_FAILED, onCommunitiesUnsubscribeFailed);
      }
      this.mainMenu = $('.main-menu');
      return this.mainMenu.on(window.CoubMainMenu.EVENTS.COMMUNITY_CLICKED, onCommunitySelected);
    };

    CommunityPage.prototype.render = function(ctx) {
      this.hotKind = ctx.params.hotKind || 'hot';
      this.communityPermalink = ctx.params.communityPermalink;
      this.periodContainer.toggleClass('-hidden', this.hotKind !== 'hot');
      this.pageMenuItems.removeClass('-active');
      this.pageMenuItems.filter("[data-hot-kind=" + this.hotKind + "]").addClass('-active');
      this.mainMenu.triggerHandler(CoubMainMenu.ACTIONS.COMMUNITY_SELECT, [this.communityPermalink]);
      this.checkWebPushHash();
      this.initializeTimeline();
      this.renderCommunityCard();
      return this.checkMegafonPromo();
    };

    CommunityPage.prototype.checkMegafonPromo = function() {
      var isPromo, src;
      if (!$(".community-megafontv__promo-bg").length) {
        return;
      }
      isPromo = ["mashup", "movies"].indexOf(this.communityPermalink) !== -1;
      $("body").toggleClass("-promo-bg", isPromo);
      $(".community-megafontv__promo-bg").toggleClass("-hidden", !isPromo);
      if (isPromo) {
        src = "//ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pfc=cnuke&pfb=hayko&pr=[" + (Math.random()) + "]&pe=b";
        return $("<img src='" + src + "' style='position:absolute;left:-10000px;top:-1000px;' />").appendTo('body').load(function() {
          return $(this).remove();
        });
      }
    };

    CommunityPage.prototype.checkWebPushHash = function() {
      var docTitle;
      if (window.location.hash === "#push") {
        $(".list__item.daily", this.periodContainer).click();
        docTitle = document.title;
        $(window).one("popstate", function() {
          return document.title = docTitle;
        });
        window.history.replaceState(null, null, location.pathname);
        return setTimeout((function(_this) {
          return function() {
            return $(window).scrollTop(_this.communityCard.offset().top + _this.communityCard.height());
          };
        })(this), 1000);
      }
    };

    CommunityPage.prototype.navigate = function(hotKind, communityPermalink) {
      var url;
      url = hotKind === 'hot' ? "/community/" + communityPermalink : "/community/" + communityPermalink + "/" + hotKind;
      ga('send', 'pageview', url);
      console.log("[DEBUG]", "pageview!", url);
      return page(url);
    };

    CommunityPage.prototype.initializeTimeline = function() {
      var renderParams, sort, url;
      url = (function() {
        switch (this.hotKind) {
          case 'hot':
            return Routes.community_api_v2_timeline_index_path(this.communityPermalink, this.period);
          case 'rising':
            return Routes.community_api_v2_timeline_index_path(this.communityPermalink, 'rising');
          case 'random':
            return Routes.category_random_api_v2_timeline_index_path(this.communityPermalink);
          case 'new-hot':
            return Routes.hotness_api_v2_timeline_index_path({
              category_id: this.communityPermalink
            });
          case 'new-rising':
            return Routes.hotness_api_v2_timeline_index_path({
              category_id: this.communityPermalink,
              order_by: "rising_score"
            });
          default:
            sort = (function() {
              switch (this.hotKind) {
                case 'top':
                  return 'likes_count';
                case "views":
                  return 'views_count';
              }
            }).call(this);
            return Routes.community_api_v2_timeline_index_path(this.communityPermalink, 'fresh', {
              order_by: sort
            });
        }
      }).call(this);
      this.timeline && this.timeline.destroy();
      this.controls && this.controls.destroy();
      renderParams = {
        url: url,
        'storage-key': 'explore_timeline_view',
        'render-no-date': Params.getBranchValue('current_user.is_editor') ? 'hover' : 'hidden'
      };
      this.timelineStub.html(JST['app/site/templates/timeline/list'](renderParams));
      this.timeline = new clientsideTimeline.ClientsideTimeline($('[clientside-timeline]', this.el));
      this.controls = new widgets.timeline.ExploreTimelineControls(this.el);
      if (this.editorSwitch) {
        return this.editorSwitch.reinit();
      } else {
        return this.editorSwitch = new widgets.timeline.TimelineEditorSwitch(this.el);
      }
    };

    CommunityPage.prototype.renderCommunityCard = function() {
      if (this.communityCard.attr('data-community-permalink') === this.communityPermalink) {
        this.initCommunityDescription();
        return;
      }
      this.communityCard.addClass('disabled');
      this.communityXhr && this.communityXhr.abort();
      return this.communityXhr = $.get(Routes.api_v2_community_path(this.communityPermalink)).done((function(_this) {
        return function(r) {
          var newCard;
          newCard = $(JST["app/site/templates/blocks/community/community_card"](r));
          _this.communityCard.replaceWith(newCard);
          _this.initCommunityCard();
          return _this.initCommunityDescription(r);
        };
      })(this));
    };

    CommunityPage.prototype.initCommunityDescription = function(communityJson) {
      if (!GlobalState.USER.isAdmin()) {
        return;
      }
      communityJson || (communityJson = JSON.parse($('> .data', this.communityCard).text()));
      this.communityDescription && this.communityDescription.clear();
      return this.communityDescription = new pages.CommunityDescription($('.timeline-right-block', this.el), communityJson);
    };

    return CommunityPage;

  })();

}).call(this);
(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  pages.CommunitySpecialPage = (function(superClass) {
    extend(CommunitySpecialPage, superClass);

    CommunitySpecialPage.ATTR_NAME = 'pages-community-special-page';

    function CommunitySpecialPage(el) {
      this.el = el;
      new widgets.timeline.TimelineEditorSwitch(this.el);
      new widgets.timeline.SimpleTimelineWithFilters(this.el);
      this.initCommunityService();
      this.initCommunityCard();
      this.initCommunityDescription();
      this.checkWebPushHash();
    }

    return CommunitySpecialPage;

  })(pages.CommunityPage);

}).call(this);
(function() {
  pages.FeaturedIndexPage = (function() {
    FeaturedIndexPage.ATTR_NAME = 'featured-index-page';

    function FeaturedIndexPage(el) {
      var featuredStoriesBlock, timer;
      this.el = el;
      widgets.timeline.ViewSelector.constructIn(this.el);
      new widgets.timeline.ExploreTimelineControls(this.el);
      timer = $('.featured-stories__timer [widget-countdown-timer]', this.el);
      featuredStoriesBlock = $('.featured-stories-block [blocks-stories-block]', this.el);
      functions.FeaturedStoriesBlockTimerReinit.createListeners(timer, featuredStoriesBlock);
    }

    return FeaturedIndexPage;

  })();

}).call(this);
(function() {
  pages.FeaturedPage = (function() {
    FeaturedPage.ATTR_NAME = 'pages-featured-page';

    function FeaturedPage(el) {
      this.el = el;
      new widgets.timeline.TimelineEditorSwitch(this.el);
      new widgets.timeline.SimpleTimelineWithFilters(this.el, {
        base: '/featured/coubs'
      });
    }

    return FeaturedPage;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  pages.HotPage = (function() {
    HotPage.ATTR_NAME = 'pages-hot-page';

    function HotPage(el) {
      this.el = el;
      this.navigate = bind(this.navigate, this);
      this.render = bind(this.render, this);
      this.timelineStub = this.el.find('[pages-hot-page-timeline]');
      widgets.timeline.ViewSelector.constructIn(this.el);
      this.initPeriodSelector();
      this.initCommunitiesReload();
      this.initNavigation();
      this.initRoutes();
    }

    HotPage.prototype.initNavigation = function() {
      this.pageMenuItems = $('.hot__menu .page-menu__item[data-hot-kind]', this.el);
      return this.pageMenuItems.click((function(_this) {
        return function(e) {
          var hotKind, item;
          item = $(e.currentTarget);
          hotKind = item.attr('data-hot-kind');
          return _this.navigate(hotKind);
        };
      })(this));
    };

    HotPage.prototype.initRoutes = function() {
      page('/:hotKind?', this.render);
      return page({
        click: false
      });
    };

    HotPage.prototype.initPeriodSelector = function() {
      this.periodContainer = $('.page-menu__period-selector', this.el);
      this.period = this.periodContainer.attr('data-period');
      return $('.dropdown--select', this.periodContainer).on(NiceSelect.EVENT_SELECTED, (function(_this) {
        return function(e) {
          if (_this.period === e.val) {
            return;
          }
          _this.period = e.val;
          $.cookie('hot_period', _this.period, {
            expires: 30,
            path: '/'
          });
          $.cookie('hot_period_selected_at', new Date().getTime(), {
            expires: 30,
            path: '/'
          });
          return _this.initializeTimeline();
        };
      })(this));
    };

    HotPage.prototype.initCommunitiesReload = function() {
      var onCommunitiesChangeCompleted;
      onCommunitiesChangeCompleted = (function(_this) {
        return function() {
          return _this.initializeTimeline();
        };
      })(this);
      if (GlobalState.USER.isLogedIn()) {
        this.communitiesService = new functions.CommunitiesService();
        return this.communitiesService.on(functions.CommunitiesService.EVENTS.CHANGE_COMPLETED, onCommunitiesChangeCompleted);
      }
    };

    HotPage.prototype.render = function(ctx) {
      this.hotKind = ctx.params.hotKind || 'hot';
      document.title = I18n.t("titles." + this.hotKind);
      this.locationTracker || (this.locationTracker = new functions.AmplitudeLocationTracker(false));
      this.locationTracker.track(this.hotKind);
      this.periodContainer.toggleClass('-hidden', this.hotKind !== 'hot');
      this.pageMenuItems.removeClass('-active');
      this.pageMenuItems.filter("[data-hot-kind=" + this.hotKind + "]").addClass('-active');
      return this.initializeTimeline();
    };

    HotPage.prototype.navigate = function(hotKind) {
      var url;
      if (this.hotKind === hotKind) {
        return;
      }
      url = "/" + hotKind;
      ga('send', 'pageview', url);
      console.log("[DEBUG]", "pageview!", url);
      return page(url);
    };

    HotPage.prototype.initializeTimeline = function() {
      var renderParams, url;
      url = this.hotKind === 'hot' ? Routes.subscriptions_api_v2_timeline_index_path(this.period) : this.hotKind === 'new-hot' ? Routes.hotness_api_v2_timeline_index_path() : this.hotKind === 'new-rising' ? Routes.hotness_api_v2_timeline_index_path({
        order_by: "rising_score"
      }) : Routes.subscriptions_api_v2_timeline_index_path(this.hotKind);
      console.log('[initTimeline]', this.hotKind, this.period, url);
      this.timeline && this.timeline.destroy();
      this.controls && this.controls.destroy();
      renderParams = {
        url: url,
        'storage-key': 'explore_timeline_view',
        'render-no-date': Params.getBranchValue('current_user.is_editor') ? 'hover' : 'hidden'
      };
      this.timelineStub.html(JST['app/site/templates/timeline/list'](renderParams));
      this.timeline = new clientsideTimeline.ClientsideTimeline($('[clientside-timeline]', this.el));
      this.controls = new widgets.timeline.ExploreTimelineControls(this.el);
      if (this.editorSwitch) {
        return this.editorSwitch.reinit();
      } else {
        return this.editorSwitch = new widgets.timeline.TimelineEditorSwitch(this.el);
      }
    };

    return HotPage;

  })();

}).call(this);
(function() {
  pages.RandomPage = (function() {
    RandomPage.ATTR_NAME = 'pages-random-page';

    function RandomPage(el) {
      var renderParams;
      this.el = el;
      renderParams = {
        url: Routes.explore_cat_api_v2_timeline_index_path("random"),
        "storage-key": "random_timeline_view",
        "render-no-date": Params.getBranchValue("current_user.is_editor") ? "hover" : "hidden",
        'data-order_by': $('.page-menu__item.-active', this.el).attr('data-sort')
      };
      $('[pages-hot-page-timeline]', this.el).html(JST["app/site/templates/timeline/list"](renderParams));
      new clientsideTimeline.ClientsideTimeline($('[clientside-timeline]', this.el));
      new widgets.timeline.SimpleTimelineWithFilters(this.el, {
        base: '/random'
      });
      new widgets.timeline.TimelineEditorSwitch(this.el);
    }

    return RandomPage;

  })();

}).call(this);
(function() {
  pages.profile.promo.Ahmad = (function() {
    Ahmad.ATTR_NAME = 'page-ahmad-promo';

    function Ahmad(page) {
      this.$el = $(page);
      $('.ahmad-promo__share__buttons button', this.$el).on('click', (function(_this) {
        return function() {
          return $('body').append("<img src='http://ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=bgfpp&pfb=dpmlg&pr=esyfaii'/>");
        };
      })(this));
      CustomSharingButton.constructIn(this.$el);
      widgets.timeline.ViewSelector.constructIn($('.ahmad-promo__timeline', this.$el));
      widgets.timeline.TimelineControls.constructIn(this.$el);
      this.initFilters();
    }

    Ahmad.prototype.initFilters = function() {
      var filterUpdate, selector;
      selector = $('.ahmad-promo__timeline__controls .dropdown.dropdown--select.sort__filter', this.$el);
      filterUpdate = (function(_this) {
        return function(val) {
          return $(document).trigger({
            type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
            val: val,
            filter_type: TimelineDataProvider.FILTER.ORDER_BY
          });
        };
      })(this);
      selector.on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val);
      });
      return $('.list__item.sort__type', selector).on('click', (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            return _this.setPopularFilter(el.attr("data-type"));
          }
        };
      })(this));
    };

    Ahmad.prototype.setPopularFilter = function(filter) {
      $(".list__item.sort__type", selector).filter(".active").removeClass("active");
      $(".list__item.sort__type[data-type=" + filter + "]", selector).addClass("active");
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    return Ahmad;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  pages.profile.promo.Ahmad18 = (function() {
    Ahmad18.ATTR_NAME = 'page-ahmad18-promo';

    function Ahmad18(el1) {
      this.el = el1;
      CustomSharingButton.constructIn(this.el);
      widgets.timeline.ViewSelector.constructIn();
      widgets.timeline.TimelineControls.constructIn();
      new window.Ahmad18StoryLink();
      this.initFilters();
      this.initVkWidget();
    }

    Ahmad18.prototype.initVkWidget = function() {
      return VK.Widgets.Group('ahmad18-promo__vk-widget', {
        mode: 3
      }, 48329354);
    };

    Ahmad18.prototype.initFilters = function() {
      var filterUpdate, selector;
      selector = $('.timeline-controls .dropdown.dropdown--select.sort__filter');
      filterUpdate = (function(_this) {
        return function(val) {
          return $(document).trigger({
            type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
            val: val,
            filter_type: TimelineDataProvider.FILTER.ORDER_BY
          });
        };
      })(this);
      selector.on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val);
      });
      return $('.list__item.sort__type', selector).on('click', (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            return _this.setPopularFilter(el.attr("data-type"));
          }
        };
      })(this));
    };

    Ahmad18.prototype.setPopularFilter = function(filter) {
      $(".list__item.sort__type", selector).filter(".active").removeClass("active");
      $(".list__item.sort__type[data-type=" + filter + "]", selector).addClass("active");
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    return Ahmad18;

  })();

  window.Ahmad18StoryLink = (function(superClass) {
    extend(Ahmad18StoryLink, superClass);

    function Ahmad18StoryLink() {
      this.makeAction = bind(this.makeAction, this);
      return Ahmad18StoryLink.__super__.constructor.apply(this, arguments);
    }

    Ahmad18StoryLink.prototype.SELECTOR = 'a[type="ahmadStoryPopup"]';

    Ahmad18StoryLink.prototype.makeAction = function(opts) {
      var iframe, intervalId, popup;
      if (opts.mobile) {
        window.open(opts.link, '_blank');
        return;
      }
      if (opts.link && !opts.newTab) {
        iframe = "<iframe class=\"ahmad18-promo__iframe -hidden\" src=\"" + opts.link + "\" width=\"100%\" height=\"100%\" />";
        popup = EmbedPopup.show({
          content: iframe,
          type: 'simple'
        });
        iframe = $('.ahmad18-promo__iframe');
        intervalId = setInterval((function(_this) {
          return function() {
            var content;
            if (iframe.contents().find("footer").length) {
              iframe.removeClass('-hidden');
              content = iframe.contents();
              $('header, footer, .story__stamp', content).addClass('-force-hidden');
              $('.page-container', content).css({
                padding: 0
              });
              return clearInterval(intervalId);
            }
          };
        })(this), 50);
        return popup.get().on(Popup.EVENT_HIDED, (function(_this) {
          return function() {
            return clearInterval(intervalId);
          };
        })(this));
      }
    };

    return Ahmad18StoryLink;

  })(CustomActionAbstractLink);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  pages.profile.promo.Ahmad2017 = (function() {
    Ahmad2017.ATTR_NAME = 'page-ahmad2017-promo';

    function Ahmad2017(el1) {
      this.el = el1;
      this.onCoubStarted = bind(this.onCoubStarted, this);
      this.onAudioTrackEnded = bind(this.onAudioTrackEnded, this);
      this.onScroll = bind(this.onScroll, this);
      this.initPlaylist = bind(this.initPlaylist, this);
      CustomSharingButton.constructIn(this.el);
      widgets.timeline.ViewSelector.constructIn($('.ahmad2017-promo__timeline', this.el));
      widgets.timeline.TimelineControls.constructIn(this.el);
      this.initFilters();
      if (!GlobalState.PLATFORM.isMobile()) {
        this.initPlaylist();
      }
    }

    Ahmad2017.prototype.initPlaylist = function() {
      this.playlist = $('.ahmad2017-promo__playlist', this.el);
      this.playlistItems = $('.ahmad2017-promo__coubs-list .content .ahmad2017-promo__playlist-item', this.playlist);
      this.playlistScroll = $('.ahmad2017-promo__coubs-list .content', this.playlist).nice_scroller();
      this.indexIndicator = $('.ahmad2017-promo__coubs-list .heading span:first-child', this.playlist);
      this.playlistButtons = $('.ahmad2017-promo__playlist-button', this.playlist);
      this.embed = $('iframe', this.playlist);
      this.currentIndex = 0;
      this.totalCoubs = this.playlistItems.length;
      this.playlistItems.click((function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (el.hasClass('selected')) {
            return;
          }
          _this.dontScroll = true;
          _this.dontTrack = true;
          _this.embed[0].contentWindow.$('body').trigger('EmbedController::Action::Changer::SelectCoubByIndex', [el.index()]);
          return helpers.Ads.trackStatsPixel('//ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pfc=bmqba&pfb=enzue&pr=[RANDOM]&pe=b');
        };
      })(this));
      this.playlistButtons.click((function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          el.toggleClass('-active');
          if (el.hasClass('repeat')) {
            _this.repeatMode = el.hasClass('-active');
          }
          if (el.hasClass('shuffle')) {
            return _this.shuffleMode = el.hasClass('-active');
          }
        };
      })(this));
      $('body').on('EmbedController::Event::Changer::CoubStarted', this.onCoubStarted);
      $('body').on('audio-ended-mazafaka', this.onAudioTrackEnded);
      return this.embed.on('load', (function(_this) {
        return function() {
          var vb;
          vb = _this.embed[0].contentWindow.$('body .coub__viewer .viewer');
          vb.trigger('play.player');
          _this.isPlaying = true;
          _this.onScroll();
          return $(window).on('scroll', _.debounce(_this.onScroll));
        };
      })(this));
    };

    Ahmad2017.prototype.onScroll = function() {
      var pHeight, pTop, sTop, vb;
      pTop = this.playlist.offset().top;
      pHeight = this.playlist.height();
      sTop = $(window).scrollTop();
      vb = this.embed[0].contentWindow.$('body .coub__viewer:not(.-hidden) .viewer');
      if (pTop + pHeight <= sTop + window.innerHeight && pTop >= sTop) {
        if (!this.isPlaying) {
          vb.trigger('play.player');
        }
        return this.isPlaying = true;
      } else {
        if (this.isPlaying) {
          vb.trigger('suspend.player');
        }
        return this.isPlaying = false;
      }
    };

    Ahmad2017.prototype.onAudioTrackEnded = function() {
      var index;
      if (this.repeatMode) {
        return;
      }
      index = this.shuffleMode ? helpers.Application.getRandomExcept(0, this.totalCoubs - 1, this.currentIndex) : this.currentIndex === this.totalCoubs - 1 ? 0 : this.currentIndex + 1;
      return this.embed[0].contentWindow.$('body').trigger('EmbedController::Action::Changer::SelectCoubByIndex', [index]);
    };

    Ahmad2017.prototype.onCoubStarted = function(e, index, permalink) {
      var selectedItem;
      this.playlistItems.removeClass('selected');
      selectedItem = this.playlistItems.eq(index);
      selectedItem.addClass('selected');
      this.currentIndex = index;
      this.indexIndicator.text(index + 1);
      if (this.dontScroll) {
        this.dontScroll = false;
      } else {
        this.playlistScroll.trigger('moveToItem', [selectedItem]);
      }
      if (this.dontTrack) {
        return this.dontTrack = false;
      } else {
        return helpers.Ads.trackStatsPixel('//ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pfc=bmqba&pfb=enztt&pr=[RANDOM]&pe=b');
      }
    };

    Ahmad2017.prototype.initFilters = function() {
      var filterUpdate, selector;
      selector = $('.timeline-controls .dropdown.dropdown--select.sort__filter', this.el);
      filterUpdate = (function(_this) {
        return function(val) {
          return $(document).trigger({
            type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
            val: val,
            filter_type: TimelineDataProvider.FILTER.ORDER_BY
          });
        };
      })(this);
      selector.on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val);
      });
      return $('.list__item.sort__type', selector).on('click', (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            return _this.setPopularFilter(el.attr("data-type"));
          }
        };
      })(this));
    };

    Ahmad2017.prototype.setPopularFilter = function(filter) {
      $(".list__item.sort__type", selector).filter(".active").removeClass("active");
      $(".list__item.sort__type[data-type=" + filter + "]", selector).addClass("active");
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    return Ahmad2017;

  })();

}).call(this);
(function() {
  pages.profile.promo.Arko = (function() {
    Arko.ATTR_NAME = "page-arko-promo";

    function Arko(el1) {
      this.el = el1;
      CustomSharingButton.constructIn(this.el);
      widgets.timeline.ViewSelector.constructIn($('.arko-promo__timeline', this.el));
      widgets.timeline.TimelineControls.constructIn(this.el);
      this.initFilters();
    }

    Arko.prototype.initFilters = function() {
      var filterUpdate, selector;
      selector = $('.arko-promo__timeline__controls .dropdown.dropdown--select.sort__filter', this.el);
      filterUpdate = (function(_this) {
        return function(val) {
          return $(document).trigger({
            type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
            val: val,
            filter_type: TimelineDataProvider.FILTER.ORDER_BY
          });
        };
      })(this);
      selector.on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val);
      });
      return $('.list__item.sort__type', selector).on('click', (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            return _this.setPopularFilter(el.attr("data-type"));
          }
        };
      })(this));
    };

    Arko.prototype.setPopularFilter = function(filter) {
      $(".list__item.sort__type", selector).filter(".active").removeClass("active");
      $(".list__item.sort__type[data-type=" + filter + "]", selector).addClass("active");
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    return Arko;

  })();

}).call(this);
(function() {
  pages.profile.promo.Clear = (function() {
    Clear.ATTR_NAME = 'page-clear-promo';

    function Clear($el) {
      this.$el = $el;
      $('.clear-promo__share__buttons button', this.$el).on('click', (function(_this) {
        return function() {
          return $('body').append("<img src='//ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=bgxhn&pfb=dryuh&pr=etghgox'/>");
        };
      })(this));
      CustomSharingButton.constructIn(this.$el);
      widgets.timeline.ViewSelector.constructIn($('.clear-promo__timeline', this.$el));
      widgets.timeline.TimelineControls.constructIn(this.$el);
      this.initFilters();
    }

    Clear.prototype.initFilters = function() {
      var filterUpdate, selector;
      selector = $('.clear-promo__timeline__controls .dropdown.dropdown--select.sort__filter', this.$el);
      filterUpdate = (function(_this) {
        return function(val) {
          return $(document).trigger({
            type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
            val: val,
            filter_type: TimelineDataProvider.FILTER.ORDER_BY
          });
        };
      })(this);
      selector.on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val);
      });
      return $('.list__item.sort__type', selector).on('click', (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            return _this.setPopularFilter(el.attr("data-type"));
          }
        };
      })(this));
    };

    Clear.prototype.setPopularFilter = function(filter) {
      $(".list__item.sort__type", selector).filter(".active").removeClass("active");
      $(".list__item.sort__type[data-type=" + filter + "]", selector).addClass("active");
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    return Clear;

  })();

}).call(this);
(function() {
  pages.profile.promo.Deadpool = (function() {
    Deadpool.ATTR_NAME = 'page-deadpool-promo';

    function Deadpool(page) {
      this.$el = $(page);
      $('.deadpool-promo__share__buttons button', this.$el).on('click', (function(_this) {
        return function() {
          return $('body').append("<img src='http://ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=bevbc&pfb=dkexf&pr=esjkjmw'/>");
        };
      })(this));
      $('.deadpool-promo__rules_video button', this.$el).on('click', (function(_this) {
        return function() {
          return $('body').append("<img src='http://ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=bevbc&pfb=dkexk&pr=esjkjos'/>");
        };
      })(this));
      CustomSharingButton.constructIn(this.$el);
      widgets.timeline.ViewSelector.constructIn($('.deadpool-promo__timeline', this.$el));
      widgets.timeline.TimelineControls.constructIn(this.$el);
      this.initFilters();
    }

    Deadpool.prototype.initFilters = function() {
      var filterUpdate, selector;
      selector = $('.deadpool-promo__timeline__controls .dropdown.dropdown--select.sort__filter', this.$el);
      filterUpdate = (function(_this) {
        return function(val) {
          return $(document).trigger({
            type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
            val: val,
            filter_type: TimelineDataProvider.FILTER.ORDER_BY
          });
        };
      })(this);
      selector.on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val);
      });
      return $('.list__item.sort__type', selector).on('click', (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            return _this.setPopularFilter(el.attr("data-type"));
          }
        };
      })(this));
    };

    Deadpool.prototype.setPopularFilter = function(filter) {
      $(".list__item.sort__type", selector).filter(".active").removeClass("active");
      $(".list__item.sort__type[data-type=" + filter + "]", selector).addClass("active");
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    return Deadpool;

  })();

}).call(this);
(function() {
  pages.profile.promo.Honor10 = (function() {
    Honor10.ATTR_NAME = 'page-honor10-promo';

    function Honor10(el1) {
      this.el = el1;
      CustomSharingButton.constructIn(this.el);
      widgets.timeline.ViewSelector.constructIn($('.honor10-promo__timeline', this.el));
      widgets.timeline.TimelineControls.constructIn(this.el);
      this.initFilters();
      this.initSocialWidgets();
    }

    Honor10.prototype.initSocialWidgets = function() {
      return VK.Widgets.Group('honor10-promo__vk-widget', {
        mode: 3,
        width: '180'
      }, 102047696);
    };

    Honor10.prototype.initFilters = function() {
      var filterUpdate, selector;
      selector = $('.timeline-controls .dropdown.dropdown--select.sort__filter', this.el);
      filterUpdate = (function(_this) {
        return function(val) {
          return $(document).trigger({
            type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
            val: val,
            filter_type: TimelineDataProvider.FILTER.ORDER_BY
          });
        };
      })(this);
      selector.on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val);
      });
      return $('.list__item.sort__type', selector).on('click', (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            return _this.setPopularFilter(el.attr("data-type"));
          }
        };
      })(this));
    };

    Honor10.prototype.setPopularFilter = function(filter) {
      $(".list__item.sort__type", selector).filter(".active").removeClass("active");
      $(".list__item.sort__type[data-type=" + filter + "]", selector).addClass("active");
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    return Honor10;

  })();

}).call(this);
(function() {
  pages.profile.promo.ICQ = (function() {
    ICQ.ATTR_NAME = 'page-icq-promo';

    function ICQ($el) {
      this.$el = $el;
      $('.icq-promo__share__buttons button', this.$el).on('click', (function(_this) {
        return function() {
          return $('body').append("<img src='//ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=bgvvb&pfb=drtpp&pr=etfsomq'/>");
        };
      })(this));
      CustomSharingButton.constructIn(this.$el);
      widgets.timeline.ViewSelector.constructIn($('.icq-promo__timeline', this.$el));
      widgets.timeline.TimelineControls.constructIn(this.$el);
      this.initFilters();
    }

    ICQ.prototype.initFilters = function() {
      var filterUpdate, selector;
      selector = $('.icq-promo__timeline__controls .dropdown.dropdown--select.sort__filter', this.$el);
      filterUpdate = (function(_this) {
        return function(val) {
          return $(document).trigger({
            type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
            val: val,
            filter_type: TimelineDataProvider.FILTER.ORDER_BY
          });
        };
      })(this);
      selector.on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val);
      });
      return $('.list__item.sort__type', selector).on('click', (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            return _this.setPopularFilter(el.attr("data-type"));
          }
        };
      })(this));
    };

    ICQ.prototype.setPopularFilter = function(filter) {
      $(".list__item.sort__type", selector).filter(".active").removeClass("active");
      $(".list__item.sort__type[data-type=" + filter + "]", selector).addClass("active");
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    return ICQ;

  })();

}).call(this);
(function() {
  pages.profile.promo.Kaspersky = (function() {
    Kaspersky.ATTR_NAME = 'page-kaspersky-promo';

    function Kaspersky(page) {
      this.page = page;
      this.bgCoub = $('.kaspersky-promo__bg-coub .viewer');
      this.inFocus = true;
      if (!GlobalState.PLATFORM.isMobile()) {
        this.initBgCoub();
        this.initFixedDesc();
      }
      CustomSharingButton.constructIn($('.fixed-block__inner__col'));
    }

    Kaspersky.prototype.initBgCoub = function() {
      return this.bgCoub.player({
        muted: true,
        startWithHD: true,
        noControls: true
      }).trigger('play');
    };

    Kaspersky.prototype.initFixedDesc = function() {
      var block, value;
      block = $('.kaspersky-promo__fixed-block');
      value = 477;
      return $(window).on('scroll', (function(_this) {
        return function() {
          if ($(window).scrollTop() > value) {
            block.addClass('-fixed');
            if (_this.inFocus) {
              _this.bgCoub.trigger('suspend');
            }
            return _this.inFocus = false;
          } else {
            block.removeClass('-fixed');
            if (!_this.inFocus) {
              _this.bgCoub.trigger('play');
            }
            return _this.inFocus = true;
          }
        };
      })(this));
    };

    return Kaspersky;

  })();

}).call(this);
(function() {
  pages.profile.promo.Klm = (function() {
    Klm.ATTR_NAME = 'page-klm-promo';

    function Klm($el) {
      this.$el = $el;
      CustomSharingButton.constructIn(this.$el);
      widgets.timeline.ViewSelector.constructIn($('.klm-promo__timeline', this.$el));
      widgets.timeline.TimelineControls.constructIn(this.$el);
      this.initFilters();
      $('.klm-promo__sharing button', this.$el).click(function() {
        return $('body').append("<img src='//ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=bhvvb&pfb=dvcgm&pr=etraibj'/>");
      });
      this.renderCoubs();
      this.initTabs();
      if (!GlobalState.PLATFORM.isMobile()) {
        this.initSocialColorChanger();
      }
    }

    Klm.prototype.initFilters = function() {
      var filterUpdate, selector;
      selector = $('.klm-promo__timeline__controls .dropdown.dropdown--select.sort__filter', this.$el);
      filterUpdate = (function(_this) {
        return function(val) {
          return $(document).trigger({
            type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
            val: val,
            filter_type: TimelineDataProvider.FILTER.ORDER_BY
          });
        };
      })(this);
      selector.on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val);
      });
      return $('.list__item.sort__type', selector).on('click', (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            return _this.setPopularFilter(el.attr("data-type"));
          }
        };
      })(this));
    };

    Klm.prototype.setPopularFilter = function(filter) {
      $(".list__item.sort__type", selector).filter(".active").removeClass("active");
      $(".list__item.sort__type[data-type=" + filter + "]", selector).addClass("active");
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    Klm.prototype.renderCoubs = function() {
      var coub, coubs, coubs_html, j, len;
      coubs = JSON.parse($('.klm-promo__residents > .data', this.$el).text());
      coubs_html = [];
      for (j = 0, len = coubs.length; j < len; j++) {
        coub = coubs[j];
        coubs_html.push(JST['app/site/templates/coub_block/coub'](coub));
      }
      return $('.klm-promo__city__coub', this.$el).each(function(i, el) {
        return el.innerHTML = coubs_html[i] || coubs_html[0];
      });
    };

    Klm.prototype.initTabs = function() {
      var pixels;
      this.$tabsContainer = $('.klm-promo__residents', this.$el);
      pixels = ['//ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=bhvvb&pfb=dvcgc&pr=etrahlv', '//ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=bhvvb&pfb=dvcge&pr=etrudmy', '//ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=bhvvb&pfb=dvcgf&pr=etrahqv', '//ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=bhvvb&pfb=dvcgh&pr=etrahst', '//ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=bhvvb&pfb=dvcgi&pr=etrahvd'];
      this.$tabsContainer.on('click', '.klm-promo__city-selector li', (function(_this) {
        return function(e) {
          var selectedIndex;
          selectedIndex = $(e.currentTarget).index();
          $('body').append("<img src=" + pixels[selectedIndex] + "/>");
          return _this.selectTab(selectedIndex);
        };
      })(this));
      return this.selectTab(0);
    };

    Klm.prototype.selectTab = function(index) {
      var $currentTab, $nextTab, tabs;
      tabs = this.$tabsContainer.children('section');
      $currentTab = tabs.filter('.active').removeClass('active');
      $nextTab = tabs.eq(index).addClass('active');
      if ($nextTab.is($currentTab)) {
        return;
      }
      $('.klm-promo__city-selector li', this.$tabsContainer).removeClass('active');
      $('.klm-promo__city-selector', this.$tabsContainer).find("li:eq(" + index + ")").addClass('active');
      if ($currentTab.length) {
        $currentTab.stop().fadeOut(300, (function(_this) {
          return function() {
            return _this.showTab($nextTab);
          };
        })(this));
        return $('.viewer', $currentTab).trigger('unembed');
      } else {
        return this.showTab($nextTab);
      }
    };

    Klm.prototype.showTab = function($tab) {
      $tab.show();
      if (!$tab.hasClass('initialized')) {
        $tab.addClass('initialized');
        console.log('init shit', $tab);
        CoubBlockClientside.constructFromContainer($tab);
      }
      return $('.viewer', $tab).trigger('preload');
    };

    Klm.prototype.initSocialColorChanger = function() {
      this.fixedBlock = $('.klm-promo__fixed:first', this.$el);
      this.contentBlock = $('.klm-promo__content:first', this.$el);
      return $(window).on('periodic_scroll', (function(_this) {
        return function() {
          return _this.fixedBlock.toggleClass('-blue', _this.fixedBlock.offset().top > _this.contentBlock.offset().top + _this.contentBlock.height());
        };
      })(this));
    };

    return Klm;

  })();

}).call(this);
(function() {
  pages.profile.promo.Lays = (function() {
    Lays.ATTR_NAME = 'page-lays-promo';

    function Lays(page) {
      this.$el = $(page);
      this.spider = $('.slideshow .-spider', this.$el);
      this.initRotator();
      widgets.timeline.ViewSelector.constructIn($('.lays-promo__timeline', this.$el));
      widgets.timeline.TimelineControls.constructIn(this.$el);
      CustomSharingButton.constructIn(this.$el);
      $('.lays-promo__sharing button', this.$el).on('click', (function(_this) {
        return function() {
          return $('body').append("<img src='http://ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=bdtqo&pfb=dgcuw&pr=ervfebf'/>");
        };
      })(this));
      this.initPages();
      this.initFilters();
    }

    Lays.prototype.initRotator = function() {
      var buttons, chips, container, container_buttons, container_images, onButtonClick, selected_num, setChips;
      container = $('.lays-promo__rotator', this.$el);
      container_images = $('.lays-promo__rotator-images', container);
      container_buttons = $('.lays-promo__rotator-buttons', container);
      chips = $('div', container_images);
      buttons = $('button', container_buttons);
      selected_num = 0;
      setChips = (function(_this) {
        return function(num) {
          selected_num = num;
          chips.removeClass('-visible');
          $(chips[num]).addClass('-visible');
          buttons.removeClass('-selected');
          return $(buttons[num]).addClass('-selected');
        };
      })(this);
      onButtonClick = (function(_this) {
        return function(e) {
          var i, results;
          i = 0;
          results = [];
          while (i < buttons.length) {
            if (e.currentTarget === buttons[i]) {
              if (selected_num !== i) {
                setChips(i);
                break;
              }
            }
            results.push(i++);
          }
          return results;
        };
      })(this);
      buttons.on('click', onButtonClick);
      return setChips(0);
    };

    Lays.prototype.initFilters = function() {
      var filterUpdate, selector;
      selector = $('.lays-promo__timeline__controls .dropdown.dropdown--select.sort__filter', this.$el);
      filterUpdate = (function(_this) {
        return function(val) {
          return $(document).trigger({
            type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
            val: val,
            filter_type: TimelineDataProvider.FILTER.ORDER_BY
          });
        };
      })(this);
      selector.on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val);
      });
      return $('.list__item.sort__type', selector).on('click', (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            return _this.setPopularFilter(el.attr("data-type"));
          }
        };
      })(this));
    };

    Lays.prototype.setPopularFilter = function(filter) {
      $(".list__item.sort__type", selector).filter(".active").removeClass("active");
      $(".list__item.sort__type[data-type=" + filter + "]", selector).addClass("active");
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    Lays.prototype.initPages = function() {
      var $buttonBg, $indicator, $pageContainer, $pages, $titles;
      $pageContainer = $('.lays-promo__genres');
      $titles = $('.lays-promo__genres__titles li', $pageContainer);
      $pages = $('.lays-promo__genre__page', $pageContainer);
      $indicator = $('.lays-promo__genres__titles span', $pageContainer);
      $buttonBg = $('.lays-promo__genres__titles div', $pageContainer);
      $pages.bind("animationFinished", (function(_this) {
        return function() {
          return _this.setBodyBgPosition();
        };
      })(this));
      if ($("html").hasClass('safari')) {
        setTimeout(((function(_this) {
          return function() {
            return _this.setBodyBgPosition();
          };
        })(this)), 1000);
      }
      $titles.on('click', (function(_this) {
        return function(e) {
          var $title, page;
          $('body').append("<img src='http://ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=bdtqo&pfb=dgcub&pr=ervfdbd'/>");
          console.log("title e ", e, arguments);
          $('.lays-promo__carousel.-carousel .slideshow button', _this.$el).removeClass('-no-visible');
          $('.slideshow .-tip', _this.$el).removeClass('-no-visible');
          _this.spider.removeClass('-visible');
          $titles.removeClass('-active');
          $title = $(e.currentTarget).addClass('-active');
          console.log('title obj is ', $title, 'attr ', $title.attr('data-page-id'));
          $indicator.removeClass('-action').removeClass('-comedy').removeClass('-horror');
          $buttonBg.removeClass('-action').removeClass('-comedy').removeClass('-horror');
          $indicator.addClass('-' + $title.attr('data-page-id'));
          $buttonBg.addClass('-' + $title.attr('data-page-id'));
          console.log('click', $pages);
          $pages.filter('.-active').each(function() {
            var page;
            page = $(this);
            console.log('deactivate page ', page);
            page.find(".lays-promo__carousel").trigger('carouselUnembed').trigger('carouselDisable');
            return page.removeClass('-active');
          });
          page = $(".lays-promo__genre__page[data-page-id=" + ($title.attr('data-page-id')) + "]");
          console.log('activate page ', page);
          page.find(".lays-promo__carousel").trigger('carouselEnable').trigger('carouselPlay');
          page.addClass('-active');
          return setTimeout((function() {
            return _this.setBodyBgPosition();
          }), 500);
        };
      })(this));
      $pageContainer.on('click', '.lays-promo__genre__next .-next-page', function() {
        var $nextPage;
        $('body').append("<img src='http://ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=bdtqo&pfb=dgcug&pr=ervfdfy'/>");
        $nextPage = $titles.filter('.-active').next();
        if (!$nextPage.length) {
          $nextPage = $titles.first();
        }
        return $nextPage.click();
      });
      $pageContainer.on('click', '.lays-promo__genre__next .-watch-movie', function() {
        return $('body').append("<img src='http://ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=bdtqo&pfb=dgcui&pr=ervfdhe'/>");
      });
      $pages.each((function(_this) {
        return function(i, el) {
          return _this.initCarousel($(el));
        };
      })(this));
      return this.setBodyBgPosition();
    };

    Lays.prototype.setBodyBgPosition = function() {
      var bodyCssBgString, css, el, height;
      el = $(".body-container");
      height = $(".lays-promo__middle").offset().top - 300;
      bodyCssBgString = "url('/assets/profile/promo/lays/lays-bg1-a804a9c046677fdf4c2ebe47463b5160f2797326d44c3ae16cadc682276ef663.jpg') no-repeat center top, url('/assets/profile/promo/lays/lays-bg2-ae633aa2ee785e2f6f9141380787ddaf0023f4bea8e0e615070fa779be1d717b.jpg') no-repeat center %{BG_TOP_STR}";
      css = bodyCssBgString.replace("%{BG_TOP_STR}", height + "px");
      return el.css('background', css);
    };

    Lays.prototype.initCarousel = function($pageEl) {
      var $card, $carousel, $slideHolder, coub, coubs, j, len;
      $carousel = $('.lays-promo__carousel', $pageEl);
      $slideHolder = $('.slideshow__wrapper', $carousel);
      coubs = JSON.parse($('.data > script', $carousel).html());
      for (j = 0, len = coubs.length; j < len; j++) {
        coub = coubs[j];
        $card = $(JST['app/site/templates/coub_block/coub'](coub));
        $card.prependTo($slideHolder);
      }
      $('.coub', $carousel).wrap('<div class="slideshow__item lays-promo__slideshow__item"></div>');
      $carousel.on('lastElement', (function(_this) {
        return function() {
          $('.lays-promo__carousel.-carousel .slideshow button', _this.$el).addClass('-no-visible');
          $('.slideshow .-tip', _this.$el).addClass('-no-visible');
          return setTimeout((function() {
            return _this.spider.addClass('-visible');
          }), 500);
        };
      })(this));
      $carousel.coubs_double_carousel({
        dynamicHeight: true,
        disabled: !$pageEl.hasClass('-active')
      });
      CoubBlockClientside.constructFromContainer($slideHolder);
      return $(".slideshow__item .text-container").removeClass('loading');
    };

    return Lays;

  })();

}).call(this);
(function() {
  pages.profile.promo.MasterCard2017Quiz = (function() {
    MasterCard2017Quiz.ATTR_NAME = 'page-mastercard2017-quiz-promo';

    function MasterCard2017Quiz(page) {
      $(".mastercard2017-quiz__question__choice", page).on("change", function(e) {
        var $choice, $question;
        $choice = $(e.delegateTarget);
        $question = $choice.closest(".mastercard2017-quiz__question");
        $choice.find('.mastercard2017-quiz__question__choice__sub').removeClass('-hidden');
        $question.find(".mastercard2017-quiz__question__choice").not($choice).addClass("disabled");
        return $question.find(".mastercard2017-quiz__question__submit").prop("disabled", false);
      });
      $(".mastercard2017-quiz__question__submit", page).on("click", function(e) {
        var $btn;
        $btn = $(e.target);
        if ($btn.attr("type") === "submit") {
          return;
        }
        $btn.closest(".mastercard2017-quiz__question").addClass("-hidden").find(".viewer").trigger("suspend").end().next().removeClass("-hidden").find(".viewer").trigger("resize").trigger("play");
        return $.scrollTo(0);
      });
      $(".mastercard2017-quiz__form", page).on("submit", function(e) {
        var res, secret;
        e.preventDefault();
        res = _.inject($(e.currentTarget).find("input[type=radio]").filter(":checked"), function(res, input) {
          return res + (parseInt(input.value) || 0);
        }, 0);
        secret = _.tap({}, function(o) {
          return o[Math.random()] = res;
        });
        return location.href = Routes.mastercard2017_quiz_result_path({
          score: btoa(JSON.stringify(secret))
        });
      });
      $(".mastercard2017-quiz__coub", page).each(function(i, el) {
        var $data, $el, card, coubData;
        $el = $(el);
        $data = $el.find(".data");
        coubData = JSON.parse($data.html());
        coubData.render = {
          "no-tags": "true",
          "no-sharing": "true"
        };
        $data.remove();
        card = JST["app/site/templates/coub_block/coub"](coubData);
        $el.append(card);
        return setTimeout(function($el) {
          new CoubBlockClientside({
            el: $el.find(".coub")
          });
          if (i === 0) {
            return $el.find(".viewer").triggerHandler("play");
          }
        }, i * 1000, $el);
      });
      CustomSharingButton.constructIn($('.mastercard2017__sharing', page));
    }

    return MasterCard2017Quiz;

  })();

}).call(this);
(function() {
  pages.profile.promo.Megafontv = (function() {
    Megafontv.ATTR_NAME = 'page-megafontv-promo';

    function Megafontv(el1) {
      this.el = el1;
      CustomSharingButton.constructIn(this.el);
      widgets.timeline.ViewSelector.constructIn($('.megafontv-promo__timeline', this.el));
      widgets.timeline.TimelineControls.constructIn(this.el);
      this.initFilters();
    }

    Megafontv.prototype.initFilters = function() {
      var filterUpdate;
      this.selector = $('.timeline-controls .dropdown.dropdown--select.sort__filter', this.el);
      filterUpdate = (function(_this) {
        return function(val) {
          return $(document).trigger({
            type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
            val: val,
            filter_type: TimelineDataProvider.FILTER.ORDER_BY
          });
        };
      })(this);
      this.selector.on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val);
      });
      return $('.list__item.sort__type', this.selector).on('click', (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            return _this.setPopularFilter(el.attr("data-type"));
          }
        };
      })(this));
    };

    Megafontv.prototype.setPopularFilter = function(filter) {
      $(".list__item.sort__type", this.selector).filter(".active").removeClass("active");
      $(".list__item.sort__type[data-type=" + filter + "]", this.selector).addClass("active");
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    return Megafontv;

  })();

}).call(this);
(function() {
  pages.profile.promo.Mts2017 = (function() {
    Mts2017.ATTR_NAME = 'page-mts2017-promo';

    function Mts2017(el1) {
      this.el = el1;
      CustomSharingButton.constructIn(this.el);
      widgets.timeline.ViewSelector.constructIn($('.mts2017-promo__timeline', this.el));
      widgets.timeline.TimelineControls.constructIn(this.el);
      this.initFilters();
      this.initBgFit();
      this.initAnchors();
    }

    Mts2017.prototype.initAnchors = function() {
      var offset;
      offset = $('#prizes', this.el).offset().top + 120;
      return $("a[href='#prizes']", this.el).click((function(_this) {
        return function(e) {
          e.preventDefault();
          return $(window).scrollTo(offset, 300);
        };
      })(this));
    };

    Mts2017.prototype.initBgFit = function() {
      var bg, isFixed, onScroll;
      bg = $('.mts2017-promo__bg', this.el);
      isFixed = false;
      onScroll = (function(_this) {
        return function(forceRecalculate) {
          if (forceRecalculate == null) {
            forceRecalculate = false;
          }
          if ($(window).scrollTop() + window.innerHeight >= bg.height()) {
            if (!isFixed || forceRecalculate) {
              isFixed = true;
              return bg.css({
                position: 'fixed',
                top: window.innerHeight - bg.height()
              });
            }
          } else {
            if (isFixed || forceRecalculate) {
              isFixed = false;
              return bg.css({
                position: 'absolute',
                top: 0
              });
            }
          }
        };
      })(this);
      $(window).on('scroll', (function(_this) {
        return function() {
          return requestAnimationFrame(onScroll);
        };
      })(this));
      $(window).on('resize', (function(_this) {
        return function() {
          return requestAnimationFrame(function() {
            return onScroll(true);
          });
        };
      })(this));
      return onScroll();
    };

    Mts2017.prototype.initFilters = function() {
      var filterUpdate, selector;
      selector = $('.timeline-controls .dropdown.dropdown--select.sort__filter', this.el);
      filterUpdate = (function(_this) {
        return function(val) {
          return $(document).trigger({
            type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
            val: val,
            filter_type: TimelineDataProvider.FILTER.ORDER_BY
          });
        };
      })(this);
      selector.on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val);
      });
      return $('.list__item.sort__type', selector).on('click', (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            return _this.setPopularFilter(el.attr("data-type"));
          }
        };
      })(this));
    };

    Mts2017.prototype.setPopularFilter = function(filter) {
      $(".list__item.sort__type", selector).filter(".active").removeClass("active");
      $(".list__item.sort__type[data-type=" + filter + "]", selector).addClass("active");
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    return Mts2017;

  })();

}).call(this);
(function() {
  pages.profile.promo.MtsNY = (function() {
    MtsNY.ATTR_NAME = 'page-mtsNY-promo';

    function MtsNY(el1) {
      this.el = el1;
      CustomSharingButton.constructIn(this.el);
      widgets.timeline.ViewSelector.constructIn($('.mtsNY-promo__timeline', this.el));
      widgets.timeline.TimelineControls.constructIn(this.el);
      this.initFilters();
    }

    MtsNY.prototype.initFilters = function() {
      var filterUpdate, selector;
      selector = $('.timeline-controls .dropdown.dropdown--select.sort__filter', this.el);
      filterUpdate = (function(_this) {
        return function(val) {
          return $(document).trigger({
            type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
            val: val,
            filter_type: TimelineDataProvider.FILTER.ORDER_BY
          });
        };
      })(this);
      selector.on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val);
      });
      return $('.list__item.sort__type', selector).on('click', (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            return _this.setPopularFilter(el.attr("data-type"));
          }
        };
      })(this));
    };

    MtsNY.prototype.setPopularFilter = function(filter) {
      $(".list__item.sort__type", selector).filter(".active").removeClass("active");
      $(".list__item.sort__type[data-type=" + filter + "]", selector).addClass("active");
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    return MtsNY;

  })();

}).call(this);
(function() {
  pages.profile.promo.MtsHype = (function() {
    MtsHype.ATTR_NAME = 'page-mtshype-promo';

    function MtsHype(el) {
      this.el = el;
      CustomSharingButton.constructIn(this.el);
      if ($('.mtshype-promo__tv', this.el).width() > 0) {
        this.initTv();
      }
    }

    MtsHype.prototype.initTv = function() {
      var buttons, container, currentCoubIndex, embed, isPlaying, loadTimeline, lockButtons, loopsCount, onButtonClick, onCoubStarted, onLoop, onScroll, provider, scrollHandler, totalCoubs, unlockButtons, whiteNoise;
      container = $('.mtshype-promo__tv-container', this.el);
      buttons = $('.buttons', container);
      provider = new TimelineDataProvider();
      embed = $('.coub-embed-container iframe.tv', container);
      whiteNoise = $('.coub-embed-container iframe.white-noise', container);
      currentCoubIndex = 0;
      totalCoubs = 0;
      loopsCount = 0;
      isPlaying = false;
      onButtonClick = (function(_this) {
        return function(e) {
          $('.sb', buttons).removeClass('-active');
          $(e.target).addClass('-active');
          return loadTimeline();
        };
      })(this);
      lockButtons = (function(_this) {
        return function() {
          var whiteNoiseVb;
          whiteNoise.removeClass('-hidden');
          buttons.addClass('-locked');
          if (!whiteNoise[0].contentWindow.$) {
            return;
          }
          whiteNoiseVb = whiteNoise[0].contentWindow.$('body .coub__viewer .viewer');
          if (whiteNoiseVb.hasClass('-state-paused')) {
            return whiteNoiseVb.trigger('player.play');
          }
        };
      })(this);
      unlockButtons = (function(_this) {
        return function() {
          whiteNoise.addClass('-hidden');
          return buttons.removeClass('-locked');
        };
      })(this);
      onScroll = (function(_this) {
        return function() {
          var pHeight, pTop, sTop, vb;
          pTop = embed.offset().top;
          pHeight = embed.height();
          sTop = $(window).scrollTop();
          vb = embed[0].contentWindow.$('body .coub__viewer:not(.-hidden) .viewer');
          if (pTop + pHeight <= sTop + window.innerHeight && pTop >= sTop) {
            if (!isPlaying) {
              vb.trigger('play.player');
            }
            return isPlaying = true;
          } else {
            if (isPlaying) {
              vb.trigger('suspend.player');
            }
            return isPlaying = false;
          }
        };
      })(this);
      loadTimeline = (function(_this) {
        return function() {
          var channelPermalink, data;
          lockButtons();
          $(window).off('scroll', scrollHandler);
          embed.attr('src', '');
          currentCoubIndex = 0;
          totalCoubs = 0;
          loopsCount = 0;
          channelPermalink = $('.sb.-active', buttons).attr('data-permalink');
          if (window.env === 'development') {
            channelPermalink = gon.current_user.channels[0].permalink;
          }
          data = {
            order_by: 'random',
            page: 1,
            per_page: 20,
            permalink: channelPermalink,
            scope: 'all'
          };
          return provider.getByUrl("/api/v2/timeline/channel/" + channelPermalink, data, {
            success: function(r) {
              var permalinks;
              totalCoubs = r.coubs.length;
              permalinks = r.coubs.map(function(c) {
                if (c.type === 'Coub::Recoub') {
                  return c.recoub_to.permalink;
                } else {
                  return c.permalink;
                }
              });
              embed.attr('src', "/embed/" + permalinks[0] + "?playlist=" + (permalinks.join(',')) + "&with-loop-event=true");
              return embed.one('load', function() {
                var vb;
                vb = embed[0].contentWindow.$('body .coub__viewer .viewer');
                vb.trigger('play.player');
                isPlaying = true;
                onScroll();
                $(window).on('scroll', scrollHandler);
                return unlockButtons();
              });
            },
            error: function(e) {
              console.log("ERRRROR");
              return unlockButtons();
            }
          });
        };
      })(this);
      onLoop = (function(_this) {
        return function(e) {
          var i;
          loopsCount++;
          console.log('onLoop', loopsCount, currentCoubIndex, totalCoubs);
          if (loopsCount >= 2) {
            i = currentCoubIndex + 1;
            if (i === totalCoubs) {
              i = 0;
            }
            embed[0].contentWindow.$('body').trigger('EmbedController::Action::Changer::SelectCoubByIndex', [i]);
            return console.log('nextCoub', currentCoubIndex, totalCoubs);
          }
        };
      })(this);
      onCoubStarted = (function(_this) {
        return function(e, index, permalink) {
          currentCoubIndex = index;
          loopsCount = 0;
          return console.log('coubStarted', index, permalink);
        };
      })(this);
      $('.sb', buttons).on('click', onButtonClick);
      $('body').on('loop-occured-mazafaka', onLoop);
      $('body').on('EmbedController::Event::Changer::CoubStarted', onCoubStarted);
      scrollHandler = _.debounce(onScroll);
      return loadTimeline();
    };

    return MtsHype;

  })();

}).call(this);
(function() {
  pages.profile.promo.Mvideo = (function() {
    Mvideo.ATTR_NAME = 'page-mvideo-promo';

    function Mvideo(el1) {
      this.el = el1;
      CustomSharingButton.constructIn(this.el);
      widgets.timeline.ViewSelector.constructIn($('.mvideo-promo__timeline', this.el));
      widgets.timeline.TimelineControls.constructIn(this.el);
      this.initFilters();
      this.initPopupSizeFix();
    }

    Mvideo.prototype.initPopupSizeFix = function() {
      return $(document).on(EmbedPopup.prototype.EVENT_CONTENT_UPDATED, function(e, modalContent) {
        if (modalContent.height() > 800) {
          modalContent.width(320);
        }
        if (typeof instgrm !== "undefined" && instgrm !== null) {
          return instgrm.Embeds.process();
        }
      });
    };

    Mvideo.prototype.initFilters = function() {
      var filterUpdate, selector;
      selector = $('.timeline-controls .dropdown.dropdown--select.sort__filter', this.el);
      filterUpdate = (function(_this) {
        return function(val) {
          return $(document).trigger({
            type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
            val: val,
            filter_type: TimelineDataProvider.FILTER.ORDER_BY
          });
        };
      })(this);
      selector.on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val);
      });
      return $('.list__item.sort__type', selector).on('click', (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            return _this.setPopularFilter(el.attr("data-type"));
          }
        };
      })(this));
    };

    Mvideo.prototype.setPopularFilter = function(filter) {
      $(".list__item.sort__type", selector).filter(".active").removeClass("active");
      $(".list__item.sort__type[data-type=" + filter + "]", selector).addClass("active");
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    return Mvideo;

  })();

}).call(this);
(function() {
  pages.profile.promo.Nike = (function() {
    Nike.ATTR_NAME = "page-nike-promo";

    function Nike(el1) {
      this.el = el1;
      CustomSharingButton.constructIn(this.el);
      widgets.timeline.ViewSelector.constructIn($('.nike-promo__timeline', this.el));
      widgets.timeline.TimelineControls.constructIn(this.el);
      this.initFilters();
    }

    Nike.prototype.initFilters = function() {
      var filterUpdate, selector;
      selector = $('.timeline-controls .dropdown.dropdown--select.sort__filter', this.el);
      filterUpdate = (function(_this) {
        return function(val) {
          return $(document).trigger({
            type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
            val: val,
            filter_type: TimelineDataProvider.FILTER.ORDER_BY
          });
        };
      })(this);
      selector.on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val);
      });
      return $('.list__item.sort__type', selector).on('click', (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            return _this.setPopularFilter(el.attr("data-type"));
          }
        };
      })(this));
    };

    Nike.prototype.setPopularFilter = function(filter) {
      $(".list__item.sort__type", selector).filter(".active").removeClass("active");
      $(".list__item.sort__type[data-type=" + filter + "]", selector).addClass("active");
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    return Nike;

  })();

}).call(this);
(function() {
  pages.profile.promo.Pelmeshki = (function() {
    Pelmeshki.ATTR_NAME = 'page-pelmeshki-promo';

    function Pelmeshki(el1) {
      this.el = el1;
      CustomSharingButton.constructIn(this.el);
      widgets.timeline.ViewSelector.constructIn($('.pelmeshki-promo__timeline', this.el));
      widgets.timeline.TimelineControls.constructIn(this.el);
      this.initFilters();
    }

    Pelmeshki.prototype.initFilters = function() {
      var filterUpdate, selector;
      selector = $('.timeline-controls .dropdown.dropdown--select.sort__filter', this.el);
      filterUpdate = (function(_this) {
        return function(val) {
          return $(document).trigger({
            type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
            val: val,
            filter_type: TimelineDataProvider.FILTER.ORDER_BY
          });
        };
      })(this);
      selector.on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val);
      });
      return $('.list__item.sort__type', selector).on('click', (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            return _this.setPopularFilter(el.attr("data-type"));
          }
        };
      })(this));
    };

    Pelmeshki.prototype.setPopularFilter = function(filter) {
      $(".list__item.sort__type", selector).filter(".active").removeClass("active");
      $(".list__item.sort__type[data-type=" + filter + "]", selector).addClass("active");
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    return Pelmeshki;

  })();

}).call(this);
(function() {
  pages.profile.promo.Qiwirussia = (function() {
    Qiwirussia.ATTR_NAME = 'page-qiwirussia-promo';

    function Qiwirussia(el1) {
      this.el = el1;
      CustomSharingButton.constructIn(this.el);
      widgets.timeline.ViewSelector.constructIn($('.qiwirussia-promo__timeline', this.el));
      widgets.timeline.TimelineControls.constructIn(this.el);
      this.initFilters();
    }

    Qiwirussia.prototype.initFilters = function() {
      var filterUpdate;
      this.selector = $('.timeline-controls .dropdown.dropdown--select.sort__filter', this.el);
      filterUpdate = (function(_this) {
        return function(val) {
          return $(document).trigger({
            type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
            val: val,
            filter_type: TimelineDataProvider.FILTER.ORDER_BY
          });
        };
      })(this);
      this.selector.on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val);
      });
      return $('.list__item.sort__type', this.selector).on('click', (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            return _this.setPopularFilter(el.attr("data-type"));
          }
        };
      })(this));
    };

    Qiwirussia.prototype.setPopularFilter = function(filter) {
      $(".list__item.sort__type", this.selector).filter(".active").removeClass("active");
      $(".list__item.sort__type[data-type=" + filter + "]", this.selector).addClass("active");
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    return Qiwirussia;

  })();

}).call(this);

/*
  Промо страница стар варс
 */

(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  pages.profile.promo.Starwars = (function() {
    Starwars.ATTR_NAME = 'page-starwars-promo';

    Starwars.prototype.DT = "pages.profile.promo.Starwars";

    function Starwars(page) {
      this.page = page;
      this.initSharingStat = bind(this.initSharingStat, this);
      console.log(this.DT, "Init.");
      this.timeline = $('[clientside-timeline]', this.page);
      widgets.timeline.ViewSelector.constructIn($('.starwars-promo__timeline-container:first', this.$el));
      widgets.timeline.TimelineControls.constructIn(this.page);
      CustomSharingButton.constructIn($('.starwars-promo__social__buttons:first'));
      this.timeline.on(clientsideTimeline.ClientsideTimeline.EVENT_VIEW_CHANGED, (function(_this) {
        return function() {
          $(".body-container").addClass("-view-changed");
          return setTimeout(function() {
            return $(".body-container").removeClass("-view-changed");
          }, 300);
        };
      })(this));
      this.initFilters();
      this.initSharingStat();
    }

    Starwars.prototype.initFilters = function() {
      var filterUpdate, selector;
      selector = $('.starwars-promo__timeline__controls .dropdown.dropdown--select.sort__filter', this.$el);
      filterUpdate = (function(_this) {
        return function(val) {
          return $(document).trigger({
            type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
            val: val,
            filter_type: TimelineDataProvider.FILTER.ORDER_BY
          });
        };
      })(this);
      selector.on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val);
      });
      return $('.list__item.sort__type', selector).on('click', (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            return _this.setPopularFilter(el.attr("data-type"));
          }
        };
      })(this));
    };

    Starwars.prototype.setPopularFilter = function(filter) {
      $(".list__item.sort__type", selector).filter(".active").removeClass("active");
      $(".list__item.sort__type[data-type=" + filter + "]", selector).addClass("active");
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    Starwars.prototype.initSharingStat = function() {
      var render;
      render = (function(_this) {
        return function(url) {
          var pixel;
          pixel = new Image();
          url = url + '&cb_date=' + +new Date();
          return pixel.src = url;
        };
      })(this);
      return $(".starwars-promo__social__buttons .sb.social").on("click", (function(_this) {
        return function() {
          var urlEn, urlRu;
          urlRu = 'http://ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=behvp&pfb=dielx&pr=esanhxo';
          urlEn = 'http://ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pe=b&pfc=behvs&pfb=diems&pr=esanhzz';
          if ($(".starwars-promo").hasClass("-ru")) {
            return render(urlRu);
          } else {
            return render(urlEn);
          }
        };
      })(this));
    };

    return Starwars;

  })();

}).call(this);
(function() {
  window.GetApp = {
    init: function() {
      return $(".get-app").each(function() {
        var app_url, link, p, path, site_url;
        link = $(this);
        if (p = link.attr("data-path")) {
          path = p;
        } else {
          path = location.pathname + location.search;
        }
        if (GlobalState.PLATFORM.isIos() && (link.attr("data-open") != null)) {
          app_url = "coub:/" + path;
        } else {
          site_url = encodeURIComponent("http://coub.com" + path);
          app_url = "https://w3jvk.app.goo.gl/?link=" + site_url + "&apn=com.coub.android&ibi=com.coub.app&ius=coub&isi=714042522&at=10l5bB&efr=1";
        }
        return link.attr("href", app_url);
      });
    }
  };

}).call(this);
(function() {
  pages.profile.promo.Tarifishe = (function() {
    Tarifishe.ATTR_NAME = 'page-tarifishe-promo';

    function Tarifishe(el1) {
      this.el = el1;
      CustomSharingButton.constructIn(this.el);
      widgets.timeline.ViewSelector.constructIn($('.tarifishe-promo__timeline', this.el));
      widgets.timeline.TimelineControls.constructIn(this.el);
      GetApp.init();
      $('header.header .nav__item.create a').click((function(_this) {
        return function() {
          var pixel, url;
          pixel = new Image();
          url = 'http://ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pfc=cfcrw&pfb=gkepc&pr=[RANDOM]&pe=b'.replace('[RANDOM]', new Date().getTime());
          return pixel.src = url;
        };
      })(this));
      this.initFilters();
    }

    Tarifishe.prototype.initFilters = function() {
      var filterUpdate;
      this.selector = $('.timeline-controls .dropdown.dropdown--select.sort__filter', this.el);
      filterUpdate = (function(_this) {
        return function(val) {
          return $(document).trigger({
            type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
            val: val,
            filter_type: TimelineDataProvider.FILTER.ORDER_BY
          });
        };
      })(this);
      this.selector.on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val);
      });
      return $('.list__item.sort__type', this.selector).on('click', (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            return _this.setPopularFilter(el.attr("data-type"));
          }
        };
      })(this));
    };

    Tarifishe.prototype.setPopularFilter = function(filter) {
      $(".list__item.sort__type", this.selector).filter(".active").removeClass("active");
      $(".list__item.sort__type[data-type=" + filter + "]", this.selector).addClass("active");
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    return Tarifishe;

  })();

}).call(this);
(function() {
  pages.profile.promo.Tele2 = (function() {
    Tele2.ATTR_NAME = "page-tele2-promo";

    function Tele2($el) {
      this.$el = $el;
      $('.tele2-promo__video button', this.$el).on('click', (function(_this) {
        return function() {
          return $('body').append("<img src='//ads.adfox.ru/214153/getCode?p1=brkor&p2=v&pfc=bkinj&pfb=eeqrs&pr=651329&pe=b'/>");
        };
      })(this));
      CustomSharingButton.constructIn(this.$el);
      widgets.timeline.ViewSelector.constructIn($('.tele2-promo__timeline', this.$el));
      widgets.timeline.TimelineControls.constructIn(this.$el);
      this.initFilters();
    }

    Tele2.prototype.initFilters = function() {
      var filterUpdate, selector;
      selector = $('.tele2-promo__timeline__controls .dropdown.dropdown--select.sort__filter', this.$el);
      filterUpdate = (function(_this) {
        return function(val) {
          return $(document).trigger({
            type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
            val: val,
            filter_type: TimelineDataProvider.FILTER.ORDER_BY
          });
        };
      })(this);
      selector.on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val);
      });
      return $('.list__item.sort__type', selector).on('click', (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            return _this.setPopularFilter(el.attr("data-type"));
          }
        };
      })(this));
    };

    Tele2.prototype.setPopularFilter = function(filter) {
      $(".list__item.sort__type", selector).filter(".active").removeClass("active");
      $(".list__item.sort__type[data-type=" + filter + "]", selector).addClass("active");
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    return Tele2;

  })();

}).call(this);
(function() {
  pages.profile.promo.XXX = (function() {
    XXX.ATTR_NAME = "page-xxx-promo";

    function XXX(el1) {
      this.el = el1;
      CustomSharingButton.constructIn(this.el);
      widgets.timeline.ViewSelector.constructIn($('.xxx-promo__timeline', this.el));
      widgets.timeline.TimelineControls.constructIn(this.el);
      this.initFilters();
      this.initCarousel();
    }

    XXX.prototype.initCarousel = function() {
      var advices, card, carousel, coub, coubs, j, len, slideHolder;
      carousel = $('.xxx-promo__carousel .-carousel', this.el);
      slideHolder = $('.slideshow__wrapper', carousel);
      coubs = JSON.parse($('.data > script', carousel).html());
      for (j = 0, len = coubs.length; j < len; j++) {
        coub = coubs[j];
        card = $(JST['app/site/templates/coub_block/coub'](coub));
        card.prependTo(slideHolder);
      }
      $('.coub', carousel).wrap('<div class="slideshow__item xxx-promo__slideshow__item"></div>');
      carousel.coubs_double_carousel({
        dynamicHeight: true
      });
      CoubBlockClientside.constructFromContainer(slideHolder);
      advices = $('.xxx-promo__advices .advice', this.el);
      return carousel.on('animationFinished', (function(_this) {
        return function(e, index) {
          return advices.each(function(i, el) {
            return $(el).toggleClass('hide', index !== i);
          });
        };
      })(this));
    };

    XXX.prototype.initFilters = function() {
      var filterUpdate, selector;
      selector = $('.xxx-promo__timeline__controls .dropdown.dropdown--select.sort__filter', this.el);
      filterUpdate = (function(_this) {
        return function(val) {
          return $(document).trigger({
            type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
            val: val,
            filter_type: TimelineDataProvider.FILTER.ORDER_BY
          });
        };
      })(this);
      selector.on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val);
      });
      return $('.list__item.sort__type', selector).on('click', (function(_this) {
        return function(e) {
          var el;
          el = $(e.currentTarget);
          if (!el.hasClass("active")) {
            return _this.setPopularFilter(el.attr("data-type"));
          }
        };
      })(this));
    };

    XXX.prototype.setPopularFilter = function(filter) {
      $(".list__item.sort__type", selector).filter(".active").removeClass("active");
      $(".list__item.sort__type[data-type=" + filter + "]", selector).addClass("active");
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    return XXX;

  })();

}).call(this);
(function() {
  window.pages.profile.view.AvatarUpload = (function() {
    AvatarUpload.ACTIONS = {
      AVATAR_CHANGED: "pages.profile.view.AvatarUpload:Actions:AvatarChanged"
    };

    function AvatarUpload(el) {
      var avatarUpload, changeUserpic;
      this.el = el;
      avatarUpload = $("#avatarUpload", this.el);
      changeUserpic = $(".change-avatar", this.el);
      avatarUpload.fileupload({
        datatype: "script",
        add: (function(_this) {
          return function(e, data) {
            data.submit();
            return LoadRotator.appendWithOverlayAndStart(avatarUpload, '', 'avatar');
          };
        })(this),
        done: (function(_this) {
          return function(e, data) {
            LoadRotator.removeWithOverlay(avatarUpload, '', 'avatar');
            changeUserpic.removeClass('-empty').addClass('-uploaded').removeAttr('disabled');
            return $(document).trigger({
              type: pages.profile.view.AvatarUpload.ACTIONS.AVATAR_CHANGED,
              channel: $.parseJSON(data.jqXHR.responseText)
            });
          };
        })(this),
        fail: (function(_this) {
          return function() {
            ErrorMessages.internalServerError();
            LoadRotator.removeWithOverlay(avatarUpload, '', 'avatar');
            return changeUserpic.removeClass('-uploaded').addClass('-empty').removeAttr('disabled');
          };
        })(this)
      });
      changeUserpic.bind("click", (function(_this) {
        return function() {
          return document.forms['avatarUpload']['chooseFile'].click();
        };
      })(this));
    }

    return AvatarUpload;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.pages.profile.view.ConfirmCoverDelete = (function() {
    ConfirmCoverDelete.EVENTS = {
      REMOVE: "pages.profile.view.ConfirmCoverDelete:ok",
      CANCEL: "pages.profile.view.ConfirmCoverDelete:Cancel"
    };

    function ConfirmCoverDelete(opts) {
      this.hide = bind(this.hide, this);
      this.insert = bind(this.insert, this);
      this.parent = opts.parent;
      this.EVENTS = pages.profile.view.ConfirmCoverDelete.EVENTS;
    }

    ConfirmCoverDelete.prototype.insert = function() {
      var heading;
      this.parent.el.addClass('-working');
      if (this.parent.getCoverType() === this.parent.COVER_TYPE.COUB) {
        heading = I18n.t('profile.cover.popups.remove_cover.coub');
      } else {
        heading = I18n.t('profile.cover.popups.remove_cover.photo');
      }
      (this.popup = $(JST["app/site/templates/profile/delete_cover_popup"]({
        heading: heading
      }))).appendTo(this.parent.el);
      this.popup.find('.sb.remove').on('click', (function(_this) {
        return function() {
          _this.parent.el.trigger(_this.EVENTS.REMOVE);
          return _this.hide();
        };
      })(this));
      return this.popup.find('.box__close, .sb.cancel').on('click', this.hide);
    };

    ConfirmCoverDelete.prototype.hide = function() {
      this.popup.remove();
      return this.parent.el.removeClass('-working');
    };

    return ConfirmCoverDelete;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.pages.profile.view.CoverReposition = (function() {
    function CoverReposition(container, parent) {
      this.getTopPos = bind(this.getTopPos, this);
      this.cancelReposition = bind(this.cancelReposition, this);
      this.resetPos = bind(this.resetPos, this);
      this.setPosAttr = bind(this.setPosAttr, this);
      this.save = bind(this.save, this);
      this.deactivate = bind(this.deactivate, this);
      this.activate = bind(this.activate, this);
      this.parent = parent;
      this.provider = this.parent.provider;
      this.controlable = new Controlable();
    }

    CoverReposition.prototype.activate = function(firstTime) {
      var cover, move, moveHandler, onKey, startMouseYPos;
      if (firstTime == null) {
        firstTime = false;
      }
      (this.repositionControl = $(JST["app/site/templates/profile/reposition_cover_control"]())).appendTo(this.parent.el);
      this.cancelRepositionButton = this.repositionControl.find(".sb[action=cancelReposition]");
      this.resetCoverToPreviousButton = this.repositionControl.find(".sb[action=resetCoverToPrevious]");
      this.submitButton = this.repositionControl.find(".sb[action=saveCover]");
      this.cancelRepositionButton.on("click", this.cancelReposition);
      this.submitButton.on("click", (function(_this) {
        return function(e) {
          e.preventDefault();
          return _this.save();
        };
      })(this));
      this.resetCoverToPreviousButton.on("click", this.parent.resetCoverToPrevious);
      this.coverToDrag = this.parent.getCoverEl();
      if (firstTime) {
        this.resetPos();
        this.cancelRepositionButton.hide();
        this.resetCoverToPreviousButton.show();
      } else {
        this.cancelRepositionButton.show();
        this.resetCoverToPreviousButton.hide();
      }
      startMouseYPos = void 0;
      cover = this.parent.getCoverEl();
      this.initialTop = this.getTopPos(cover);
      move = (function(_this) {
        return function(offset) {
          var currentPos, downLimit, newPos, prop, topLimit;
          prop = _this.parent.getCoverTopProp();
          currentPos = _this.parent.getCurrentPositon();
          newPos = currentPos + offset;
          topLimit = newPos <= 0;
          downLimit = $(_this.parent.el).outerHeight() - _this.parent.getCurrentCoverHeight();
          downLimit = newPos >= downLimit;
          if (topLimit && downLimit) {
            newPos = _this.parent.getValueForPosition(newPos);
            return _this.coverToDrag.css(prop, newPos);
          } else {
            return false;
          }
        };
      })(this);
      moveHandler = (function(_this) {
        return function(e) {
          if (startMouseYPos) {
            e.preventDefault();
            move(e.pageY - startMouseYPos);
            return startMouseYPos = e.pageY;
          }
        };
      })(this);
      onKey = (function(_this) {
        return function(e) {
          var offset;
          if (e.keyCode === $.ui.keyCode.DOWN || e.keyCode === $.ui.keyCode.UP) {
            e.preventDefault();
            if (e.keyCode === $.ui.keyCode.DOWN) {
              offset = -4;
            } else {
              offset = +4;
            }
            if (e.shiftKey) {
              offset *= 4;
            }
            return move(offset);
          }
        };
      })(this);
      this.parent.el.addClass('-reposition -working');
      setTimeout((function(_this) {
        return function() {
          return _this.parent.el.addClass('-drag');
        };
      })(this), 300);
      this.coverToDrag.add(this.repositionControl).bind("mousedown", (function(_this) {
        return function(e) {
          startMouseYPos = e.pageY;
          $(document).bind("mousemove", moveHandler);
          return $(document).one("mouseup", function(e) {
            startMouseYPos = void 0;
            return $(document).unbind("mousemove", moveHandler);
          });
        };
      })(this));
      this.controlable.handleFn = onKey;
      return this.controlable.listen();
    };

    CoverReposition.prototype.deactivate = function() {
      this.controlable.unlisten();
      this.initialTop = void 0;
      this.coverToDrag.unbind("mousedown");
      this.repositionControl.remove();
      this.parent.el.removeClass('-drag');
      return setTimeout((function(_this) {
        return function() {
          return _this.parent.el.removeClass('-reposition -working');
        };
      })(this), 200);
    };

    CoverReposition.prototype.save = function() {
      var pos;
      pos = this.getTopPos();
      this.setPosAttr(pos);
      this.provider.saveCoverPosition(pos, this.parent.channelId, {
        error: ErrorMessages.internalServerError
      });
      return this.deactivate();
    };

    CoverReposition.prototype.setPosAttr = function(val) {
      return this.parent.el.attr("position", val);
    };

    CoverReposition.prototype.resetPos = function() {
      this.parent.getCoverEl().css(this.parent.getCoverTopProp(), this.parent.getValueForPosition(0));
      return this.setPosAttr(0);
    };

    CoverReposition.prototype.cancelReposition = function() {
      var params, top;
      top = this.initialTop * this.parent.resizer.getZoomCoef();
      params = {};
      params[this.parent.getCoverTopProp()] = this.parent.getValueForPosition(top);
      if (this.parent.getCoverType() === this.parent.COVER_TYPE.COUB) {
        this.parent.getCoverEl().css(params);
      } else {
        this.parent.getCoverEl().animate(params, 300);
      }
      return this.deactivate();
    };

    CoverReposition.prototype.getTopPos = function(cover) {
      if (!cover) {
        cover = this.parent.getCoverEl();
      }
      if (cover == null) {
        return 0;
      } else {
        return this.parent.getCurrentPositon() / this.parent.resizer.getZoomCoef();
      }
    };

    return CoverReposition;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.pages.profile.view.CoverResizer = (function() {
    function CoverResizer(coverContainer, parent) {
      this.getSizes = bind(this.getSizes, this);
      this.onResize = bind(this.onResize, this);
      this.c = coverContainer;
      this.parent = parent;
      $(window).on("resize", this.onResize);
      this.onResize();
    }

    CoverResizer.prototype.onResize = function(e) {
      var cover, params, s;
      if (this.parent.getCoverType() === this.parent.COVER_TYPE.NOTHING) {
        return;
      }
      s = this.getSizes(this.parent.el.width());
      this.c.css({
        height: s.h
      });
      params = {
        left: s.left,
        width: s.cw,
        height: s.ch
      };
      params[this.parent.getCoverTopProp()] = this.parent.getValueForPosition(s.pos);
      cover = this.parent.getCoverEl();
      cover.css(params);
      cover.attr("zoom-coef", s.coef);
      return this.parent.getCoverBottomOffset(true);
    };

    CoverResizer.prototype.START_GROW = 970;

    CoverResizer.prototype.START_HEIGHT = 270;

    CoverResizer.prototype.getSizes = function(docWidth) {
      var coef, getResult, h, left, pos, round;
      getResult = function(h, cw, ch, left, pos, coef) {
        return {
          h: h,
          cw: cw,
          ch: ch,
          left: left,
          pos: pos,
          coef: coef
        };
      };
      if (docWidth <= this.START_GROW && docWidth >= 768) {
        left = (this.START_GROW - docWidth) / 2 * -1;
        return getResult(this.START_HEIGHT, this.START_GROW, "", left, this.getPosition(), 1);
      } else {
        round = function(v) {
          return Math.round(v * 100) / 100;
        };
        coef = round(docWidth / this.START_GROW);
        h = round(this.START_HEIGHT * coef);
        pos = round(this.getPosition() * coef);
        if (docWidth < 768) {
          return getResult("", "", h, "", pos, coef);
        } else {
          return getResult(h, "", "", "", pos, coef);
        }
      }
    };

    CoverResizer.prototype.getZoomCoef = function() {
      var v;
      if (isNaN(v = parseFloat(this.parent.getCoverEl().attr("zoom-coef")))) {
        return 1;
      } else {
        return v;
      }
    };

    CoverResizer.prototype.getPosition = function() {
      return parseInt(this.parent.el.attr("position"));
    };

    CoverResizer.getStub = function() {
      return new ProfileCoverResizer($("<div class='coverAndInfo'></div>"));
    };

    return CoverResizer;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.pages.profile.view.Cover = (function() {
    Cover.COVER_TYPE = {
      COUB: "coub",
      IMAGE: "image",
      NOTHING: "none"
    };

    Cover.EVENT_COVER_FOCUS = "pages.profile.view.Cover:CoverFocus";

    Cover.EVENT_COVER_BLUR = "pages.profile.view.Cover:CoverBlur";

    function Cover(el1) {
      this.el = el1;
      this.getCurrentPositon = bind(this.getCurrentPositon, this);
      this.getValueForPosition = bind(this.getValueForPosition, this);
      this.spawnFocusBlurEvent = bind(this.spawnFocusBlurEvent, this);
      this.restoreRememberedCover = bind(this.restoreRememberedCover, this);
      this.rememberCurrentCover = bind(this.rememberCurrentCover, this);
      this.resetCoverToPrevious = bind(this.resetCoverToPrevious, this);
      this.setCover = bind(this.setCover, this);
      this.getCoverBottomOffset = bind(this.getCoverBottomOffset, this);
      this.hideRepositionAndDeleteMenuItems = bind(this.hideRepositionAndDeleteMenuItems, this);
      this.showAllMenuItems = bind(this.showAllMenuItems, this);
      this.deleteCover = bind(this.deleteCover, this);
      this.getImageCoverHeight = bind(this.getImageCoverHeight, this);
      this.getCurrentImageCoverScaleInPercent = bind(this.getCurrentImageCoverScaleInPercent, this);
      this.getCoverScale = bind(this.getCoverScale, this);
      this.getCoverSpaceSizes = bind(this.getCoverSpaceSizes, this);
      this.getOriginalCoverImageSizes = bind(this.getOriginalCoverImageSizes, this);
      this.getCurrentCoverHeight = bind(this.getCurrentCoverHeight, this);
      this.getCoverType = bind(this.getCoverType, this);
      this.setCoverType = bind(this.setCoverType, this);
      this.initImageUpload = bind(this.initImageUpload, this);
      this.initCoubCover = bind(this.initCoubCover, this);
      this.s = this.constructor;
      this.COVER_TYPE = this.s.COVER_TYPE;
      this.COVER_STATE = this.s.COVER_STATE;
      this.el = $(this.el);
      this.form = $("#updateBackgroundImage", this.el);
      this.menu = $(".cover__options", this.el);
      this.coverAtt = $('.hero-cover__att', this.el);
      this.provider = new dataProviders.ApiV2();
      this.channelId = $(this.el).attr("channel-id");
      this.coubLoadProgress = $(".hero-cover__progress-bar", this.el);
      this.uploadCoubPopup = new pages.profile.view.UploadCoubPopup({
        parent: this
      });
      this.confirmCoverDelete = new pages.profile.view.ConfirmCoverDelete({
        parent: this
      });
      this.coverReposition = new pages.profile.view.CoverReposition(this.el, this);
      this.resizer = new pages.profile.view.CoverResizer(this.el, this);
      this.el.on(pages.profile.view.UploadCoubPopup.EVENT_COUB_UPLOADED, (function(_this) {
        return function(e) {
          _this.setCover(_this.COVER_TYPE.COUB, e.layout);
          return _this.coverReposition.activate(true);
        };
      })(this));
      this.el.on(pages.profile.view.ConfirmCoverDelete.EVENTS.REMOVE, this.deleteCover);
      this.menu.find("li[option='coub']").on("click", this.uploadCoubPopup.insert);
      this.menu.find("li[option='picture']").on("click", (function(_this) {
        return function() {
          return _this.form.find("[type='file']").click();
        };
      })(this));
      this.menu.find("li[option='reposition']").on("click", (function(_this) {
        return function() {
          return _this.coverReposition.activate();
        };
      })(this));
      this.menu.find("li[option='delete']").on("click", this.confirmCoverDelete.insert);
      if (!GlobalState.PLATFORM.isMobile()) {
        if (this.getCoverType() === "coub") {
          this.initCoubCover();
        }
      }
      new ScrollEventOptimizer((function(_this) {
        return function() {
          return _this.spawnFocusBlurEvent();
        };
      })(this));
      this.initImageUpload();
      this.spawnFocusBlurEvent();
      this.coverAtt.addClass("-faded");
    }

    Cover.prototype.initCoubCover = function() {
      var startProgress, stopProgress, vb;
      vb = this.coverAtt.find(".viewer").first();
      stopProgress = (function(_this) {
        return function() {
          clearInterval(_this.coubLoadProgressTimer);
          _this.coubLoadProgressTimer = void 0;
          _this.coubLoadProgress.css("width", "100%");
          return setTimeout(function() {
            return _this.coubLoadProgress.css("width", "");
          }, 300);
        };
      })(this);
      startProgress = (function(_this) {
        return function(inc) {
          var cp, pinc;
          pinc = inc;
          cp = 0;
          return _this.coubLoadProgressTimer = setInterval(function() {
            if ((cp += pinc) >= 90) {
              stopProgress();
            }
            return _this.coubLoadProgress.css("width", cp + "%");
          }, 500);
        };
      })(this);
      if (!GlobalState.PLATFORM.isMobile()) {
        vb.player({
          noAudio: true,
          muted: true,
          startWithHD: true,
          noControls: true
        }).one(Player.EVENT_PLAYING, stopProgress).triggerHandler("play");
      }
      return startProgress((90 / parseInt(vb.attr("duration"))) / 2);
    };

    Cover.prototype.initImageUpload = function() {
      var hideLoader, jqXHR, showErrorPopup, showLoader;
      jqXHR = void 0;
      showLoader = (function(_this) {
        return function() {
          _this.el.addClass('-working');
          return LoadRotator.appendWithOverlayAndStart(_this.el, '');
        };
      })(this);
      hideLoader = (function(_this) {
        return function() {
          jqXHR = void 0;
          return LoadRotator.removeWithOverlay(_this.el);
        };
      })(this);
      showErrorPopup = (function(_this) {
        return function() {
          return (_this.imageErrorPopup = $(JST["app/site/templates/profile/cover_error_popup"]())).appendTo(_this.el).on('click', function() {
            return $(this).remove();
          });
        };
      })(this);
      return this.form.fileupload({
        add: (function(_this) {
          return function(e, data) {
            if ((_this.imageErrorPopup != null) && _this.imageErrorPopup.is(':visible')) {
              _this.imageErrorPopup.remove();
            }
            showLoader();
            return jqXHR = data.submit();
          };
        })(this),
        done: (function(_this) {
          return function(e, data) {
            var loader;
            loader = $("<img src=\"" + data.result.url + "\"/>");
            return loader.on("load", function() {
              var template;
              template = "<div class=\"hero-cover__att -image\" style=\"background-image: url(" + data.result.url + ")\" img-width=\"" + loader[0].width + "\" img-height=\"" + loader[0].height + "\"></div>";
              _this.setCover(_this.COVER_TYPE.IMAGE, template);
              hideLoader();
              return _this.coverReposition.activate(true);
            });
          };
        })(this),
        fail: (function(_this) {
          return function() {
            var e, obj;
            if (jqXHR != null) {
              if (jqXHR.statusText === "abort") {
                hideLoader();
                return;
              } else {
                try {
                  obj = $.parseJSON(jqXHR.responseText);
                } catch (error) {
                  e = error;
                  ErrorMessages.internalServerError();
                  hideLoader();
                }
                if (obj != null) {
                  switch (obj.status) {
                    case "toosmall":
                      showErrorPopup();
                      break;
                    case "notjpg":
                      Growl.msg(obj.message);
                      break;
                    default:
                      ErrorMessages.internalServerError();
                  }
                } else {
                  ErrorMessages.internalServerError();
                }
                hideLoader();
              }
            } else {
              ErrorMessages.internalServerError();
            }
            return _this.el.removeClass('-working');
          };
        })(this)
      });
    };

    Cover.prototype.setCoverType = function(type) {
      return this.el.attr("type", type);
    };

    Cover.prototype.getCoverType = function() {
      var t;
      if ((t = this.el.attr("type")) != null) {
        return t;
      } else {
        this.setCover(this.COVER_TYPE.NOTHING, null, 0, true);
        return this.COVER_TYPE.NOTHING;
      }
    };

    Cover.prototype.getCoverEl = function() {
      switch (this.getCoverType()) {
        case this.COVER_TYPE.COUB:
          return this.el.find(".hero-cover__att.-coub");
        case this.COVER_TYPE.IMAGE:
          return this.el.find(".hero-cover__att.-image");
      }
    };

    Cover.prototype.getCurrentCoverHeight = function() {
      switch (this.getCoverType()) {
        case this.COVER_TYPE.COUB:
          return this.getCoverEl().height();
        case this.COVER_TYPE.IMAGE:
          return this.getImageCoverHeight() * this.getCurrentImageCoverScaleInPercent();
      }
    };

    Cover.prototype.getOriginalCoverImageSizes = function() {
      var ce, ih, iw;
      ce = this.getCoverEl();
      ih = parseInt(ce.attr("img-height"));
      iw = parseInt(ce.attr("img-width"));
      return [iw, ih];
    };

    Cover.prototype.getCoverSpaceSizes = function() {
      var e;
      e = $(this.el);
      return [e.width(), e.outerHeight()];
    };

    Cover.prototype.getCoverScale = function() {
      var imgRatio, ims, spaceRatio, ss;
      switch (this.getCoverType()) {
        case this.COVER_TYPE.COUB:
          return 1;
        case this.COVER_TYPE.IMAGE:
          ims = this.getOriginalCoverImageSizes();
          ss = this.getCoverSpaceSizes();
          imgRatio = ims[0] / ims[1];
          spaceRatio = ss[0] / ss[1];
          if (imgRatio > spaceRatio) {
            return imgRatio / spaceRatio;
          } else {
            return 1;
          }
          break;
        default:
          return void 0;
      }
    };

    Cover.prototype.getCurrentImageCoverScaleInPercent = function() {
      var iiw, ssw;
      ssw = this.getCoverSpaceSizes()[0];
      iiw = this.getOriginalCoverImageSizes()[0];
      return ssw / iiw;
    };

    Cover.prototype.getImageCoverHeight = function() {
      return this.getOriginalCoverImageSizes()[1] * this.getCoverScale();
    };

    Cover.prototype.deleteCover = function() {
      this.setCover(this.COVER_TYPE.NOTHING);
      return this.provider.deleteCover(this.channelId, {
        error: ErrorMessages.internalServerError
      });
    };

    Cover.prototype.showAllMenuItems = function() {
      return this.menu.find("li").show().removeClass('-last');
    };

    Cover.prototype.hideRepositionAndDeleteMenuItems = function() {
      var i, len, opt, ref;
      ref = ['reposition', 'delete'];
      for (i = 0, len = ref.length; i < len; i++) {
        opt = ref[i];
        this.menu.find("li[option='" + opt + "']").hide();
      }
      return this.menu.find("li[option='picture']").addClass('-last');
    };

    Cover.prototype.getCoverBottomOffset = function(recalc) {
      if (recalc == null) {
        recalc = false;
      }
      if ((this.coverBottomOffset == null) || recalc) {
        this.coverBottomOffset = this.el.offset().top + this.el.outerHeight();
      }
      return this.coverBottomOffset;
    };

    Cover.prototype.setCover = function(type, el, pos, force) {
      if (pos == null) {
        pos = 0;
      }
      if (force == null) {
        force = false;
      }
      if (!force) {
        this.rememberCurrentCover();
      }
      if (type === this.COVER_TYPE.NOTHING) {
        el = " <div class=\"hero-cover__att -default\"></div> ";
        this.hideRepositionAndDeleteMenuItems();
        this.el.removeClass('-with-cover');
      } else {
        this.el.addClass('-with-cover');
        this.showAllMenuItems();
      }
      if (type === this.COVER_TYPE.COUB) {
        el = " <div class='hero-cover__att -coub'>" + el + "</div>";
      }
      this.coverAtt.replaceWith(el);
      this.coverAtt = $('.hero-cover__att', this.el);
      this.setCoverType(type);
      this.coverReposition.setPosAttr(pos);
      if (type !== this.COVER_TYPE.NOTHING && (this.resizer != null)) {
        this.resizer.onResize();
      }
      if (type === this.COVER_TYPE.COUB) {
        this.initCoubCover();
      }
      return this.coverAtt.addClass('-faded');
    };

    Cover.prototype.resetCoverToPrevious = function() {
      this.coverReposition.deactivate();
      this.restoreRememberedCover();
      return this.provider.setPreviousCover(this.channelId);
    };

    Cover.prototype.rememberCurrentCover = function() {
      return this.rememberedCurrentCover = {
        el: this.el.find('.hero-cover__att')[0].outerHTML,
        type: this.getCoverType(),
        pos: this.coverReposition.getTopPos()
      };
    };

    Cover.prototype.restoreRememberedCover = function() {
      var c;
      c = this.rememberedCurrentCover;
      this.setCover(c.type, c.el, c.pos);
      return this.rememberedCurrentCover = void 0;
    };

    Cover.prototype.spawnFocusBlurEvent = function() {
      var currentState, type;
      if (!Header.isProfilePanelVisible() && !helpers.Location.isFullScreen()) {
        type = pages.profile.view.Cover.EVENT_COVER_FOCUS;
        currentState = true;
        this.coverAtt.attr("focus", true.toString());
      } else {
        type = pages.profile.view.Cover.EVENT_COVER_BLUR;
        currentState = false;
        this.coverAtt.attr("focus", false.toString());
      }
      if ((type != null) && this.previousVisibleState !== currentState) {
        this.previousVisibleState = currentState;
        return this.coverAtt.trigger({
          type: type,
          coverType: this.getCoverType()
        });
      }
    };

    Cover.prototype.getCoverTopProp = function() {
      switch (this.getCoverType()) {
        case this.COVER_TYPE.COUB:
          return "top";
        case this.COVER_TYPE.IMAGE:
          return "background-position";
      }
    };

    Cover.prototype.getValueForPosition = function(pos) {
      switch (this.getCoverType()) {
        case this.COVER_TYPE.COUB:
          return pos + "px";
        case this.COVER_TYPE.IMAGE:
          return "0px " + pos + "px";
      }
    };

    Cover.prototype.getCurrentPositon = function() {
      var c, m, pos, v;
      c = this.getCoverEl();
      pos = void 0;
      switch (this.getCoverType()) {
        case this.COVER_TYPE.COUB:
          pos = parseInt(c.css(this.getCoverTopProp()));
          break;
        case this.COVER_TYPE.IMAGE:
          v = c.css(this.getCoverTopProp());
          if ((m = v.match(/(-?[\d\.]+px)/gi)) != null) {
            pos = parseInt(m[1]);
          }
          break;
        default:
          pos = void 0;
      }
      if (isNaN(pos)) {
        return 0;
      } else {
        return pos;
      }
    };

    Cover.getCoverHeight = function() {
      return $(".hero-cover__att").height();
    };

    Cover.getCoverType = function() {
      return $(".hero-cover").attr("type");
    };

    Cover.isInFocus = function() {
      return $(".hero-cover__att").attr("focus") === "true";
    };

    Cover.getCoverContainer = function() {
      return $('.hero-cover');
    };

    return Cover;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.pages.profile.view.Page = (function() {
    Page.prototype.GUIDE_STORAGE_KEY = "profile_tooltips";

    Page.prototype.ATTACHED_CHANNEL_KEY = "attached_channel";

    Page.prototype.HAS_SEEN_LIKE_HELPER_KEY = "has_seen_like_helper";

    Page.prototype.UNLOGED_FOLLOW = UnlogedAction.ACTION_PREFIX + "profile_follow";

    function Page(el) {
      this.initAttachedChannelPopup = bind(this.initAttachedChannelPopup, this);
      this.initGuide = bind(this.initGuide, this);
      this.unlogedFollow = bind(this.unlogedFollow, this);
      this.getFollowButton = bind(this.getFollowButton, this);
      var description, dropdown, i, len, ref, title;
      this.el = $(el);
      this.timeline = $("[clientside-timeline]", this.el);
      this.cover = $(".hero-cover", this.el);
      this.initFilters();
      widgets.timeline.ViewSelector.constructIn(this.el);
      widgets.timeline.TimelineControls.constructIn(this.el);
      new widgets.timeline.TimelineEditorSwitch(this.el);
      new pages.profile.view.AvatarUpload(this.cover.find('.avatar-upload'));
      new pages.profile.view.Cover(this.cover);
      chms.utils.Autoinit.init(widgets.WidgetProfileButtons, this.cover);
      chms.utils.Autoinit.init(widgets.AvatarChangeListener);
      new widgets.SubscribeToNotificationsButton({
        el: $('.notifications__subscribe', this.cover),
        url: Routes.api_v2_channel_notifications_subscriptions_path(),
        url_params: {
          channel_id: Params.getBranchValue("profile_channel.id")
        }
      });
      UnlogedActionHandler.construct(this.cover);
      if (!GlobalState.PLATFORM.isMobile()) {
        ref = [blocks.FollowersListDropdown, blocks.FollowingListDropdown];
        for (i = 0, len = ref.length; i < len; i++) {
          dropdown = ref[i];
          blocks.UserListDropdownAbstract.constructIn(dropdown, this.cover, false);
        }
        rawVideoAnnouncements.Block.constructIn($('.timeline-right-block'));
        chms.utils.Autoinit.init(widgets.ProfileRecommendations);
      }
      this.initRoutes();
      this.initAttachedChannelPopup();
      this.initHashFollow();
      if (!GlobalState.PLATFORM.isMobile()) {
        this.initGuide();
      }
      if ((description = $('[data-profile-description]', this.cover)).length) {
        title = description.html().replace(new RegExp(Params.get("coub_hash_tag_regexp"), "gi"), (function(_this) {
          return function(str) {
            return $("<a>", {
              text: str,
              href: Routes.search_path({
                q: str.toLowerCase()
              }),
              "class": "-undr hashtag",
              target: "_blank"
            })[0].outerHTML;
          };
        })(this));
        description.html(title);
      }
      this.cover.on(this.UNLOGED_FOLLOW, this.unlogedFollow);
    }

    Page.prototype.getFollowButton = function() {
      return $(".channel__relationships [" + widgets.FollowButton.ATTR_NAME + "]", this.cover);
    };

    Page.prototype.unlogedFollow = function() {
      return window.location.hash = "#follow";
    };

    Page.prototype.remove = function() {
      $(window).off('.profilePage');
      return Page.__super__.remove.apply(this, arguments);
    };

    Page.prototype.initGuide = function() {
      if ($.storage.get(this.GUIDE_STORAGE_KEY) == null) {
        return chms.utils.Autoinit.init(widgets.hints.HintHandler, this.el);
      }
    };

    Page.prototype.initHashFollow = function() {
      return $(window).on('hashchange.profilePage', (function(_this) {
        return function() {
          var cuc, cucid, prcid, rendered;
          if (location.hash === '#follow') {
            cucid = Params.get("current_channel_id");
            prcid = Params.getBranchValue("profile_channel.id");
            if (GlobalState.USER.isLogedIn() && (cucid != null) && (prcid != null) && cucid !== prcid) {
              cuc = Params.getBranchValue("current_user.channels");
              if (cuc) {
                rendered = JST["app/site/templates/widgets/follow_popup/follow_popup"]({
                  channel: gon.profile_channel,
                  user: gon.current_user
                });
                ModalPopup.constructPopup({
                  content: rendered,
                  classes: 'profile__follow-popup',
                  constructed: function(cont) {
                    return chms.utils.Autoinit.init(widgets.WidgetFollowButtonInit, cont);
                  }
                });
              }
            } else if (!GlobalState.USER.isLogedIn()) {
              AuthPopup.Base.constructAuthDialog('sign_in');
              _this.page.trigger(UnlogedActionHandler.ACTIONS.START_SESSION);
            }
            if (History.enabled) {
              return History.replaceState({}, document.title, location.pathname);
            }
          }
        };
      })(this));
    };

    Page.prototype.initAttachedChannelPopup = function() {
      var channelId, key, userId;
      key = $.storage.get(this.ATTACHED_CHANNEL_KEY);
      channelId = Params.getBranchValue("profile_channel.id");
      userId = Params.getBranchValue("current_user.id");
      if (GlobalState.USER.isLogedIn()) {
        if ((key != null) && key.channelId === channelId && key.userId === userId) {
          return channels.AttachedChannelPopup.show();
        }
      }
    };

    Page.prototype.initRoutes = function() {
      var base, parts, path;
      page('/:sortType?', (function(_this) {
        return function(ctx) {
          var filter, sortType;
          sortType = ctx.params.sortType || '';
          filter = (function() {
            switch (sortType) {
              case 'coubs':
                return 'simples';
              case 'reposts':
                return 'recoubs';
              default:
                return sortType;
            }
          })();
          return _this.setPopularFilter(filter);
        };
      })(this));
      path = window.location.pathname;
      parts = path.split('/');
      parts.length = 2;
      base = parts.join('/');
      page.base(base);
      return page({
        click: false,
        dispatch: false
      });
    };

    Page.prototype.initFilters = function() {
      var filterUpdate, isStories;
      filterUpdate = function(val, filter_type) {
        return $(document).trigger({
          type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
          val: val,
          filter_type: filter_type
        });
      };
      isStories = $(".profile__menu .page-menu__item.-active", this.el).attr('data-type') === 'stories';
      $('.page-menu__view-selector', this.el).toggleClass('-hidden', isStories);
      $(".sort__filter", this.el).on(NiceSelect.EVENT_SELECTED, function(e) {
        return filterUpdate(e.val, TimelineDataProvider.FILTER.ORDER_BY);
      });
      $(".scope__filter", this.el).on(NiceSelect.EVENT_SELECTED, (function(_this) {
        return function(e) {
          return filterUpdate(e.val, TimelineDataProvider.FILTER.SCOPE);
        };
      })(this));
      $(".profile__menu .page-menu__item", this.el).on("click", (function(_this) {
        return function(e) {
          var el, filter, sortType;
          el = $(e.currentTarget);
          if (el.hasClass("-active")) {
            return;
          }
          filter = el.attr("data-type");
          sortType = (function() {
            switch (filter) {
              case 'simples':
                return 'coubs';
              case 'recoubs':
                return 'reposts';
              default:
                return filter;
            }
          })();
          return page("/" + sortType);
        };
      })(this));
      return $('.timeline-right-block__stories .more-stories-button', this.el).on('click', (function(_this) {
        return function(e) {
          e.preventDefault();
          return page('/stories');
        };
      })(this));
    };

    Page.prototype.setPopularFilter = function(filter) {
      $('.profile__menu .page-menu__item').removeClass('-active').filter("[data-type=" + filter + "]").addClass('-active');
      $('.timeline-right-block__stories', this.el).toggleClass('-hidden', filter === 'stories');
      $('.page-menu__view-selector', this.el).toggleClass('-hidden', filter === 'stories');
      $(document).trigger({
        type: widgets.timeline.TimelineControls.EVENT_FILTER_UPDATE,
        val: filter,
        filter_type: TimelineDataProvider.FILTER.COUBS_TYPE
      });
      if (filter === "likes") {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_likes_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else if (filter === 'stories') {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, I18n.t("profile.no_stories_available", {
          user: this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_SHOW_NO_COUBS_STUB)
        }));
      } else {
        return this.timeline.attr(clientsideTimeline.ClientsideTimeline.ATTR_NO_COUBS_STUB_TEXT, null);
      }
    };

    Page.construct = function() {
      return $("body.profile-page").each(function() {
        return new pages.profile.view.Page(this);
      });
    };

    return Page;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  window.pages.profile.view.UploadCoubPopup = (function(superClass) {
    extend(UploadCoubPopup, superClass);

    UploadCoubPopup.EVENT_COUB_UPLOADED = "pages.profile.view.UploadCoubPopup:CoubUploaded";

    UploadCoubPopup.prototype.COUB_PERMALINK_REGEX = /(^https?:\/\/(staging.)?coub.(com|local)\/view\/[\w\d]+)/i;

    function UploadCoubPopup(opts) {
      this.onKeydown = bind(this.onKeydown, this);
      this.hideAndShowControls = bind(this.hideAndShowControls, this);
      this.clean = bind(this.clean, this);
      this.hideLoader = bind(this.hideLoader, this);
      this.showLoader = bind(this.showLoader, this);
      this.hideStaticError = bind(this.hideStaticError, this);
      this.showStaticError = bind(this.showStaticError, this);
      this.hideHDError = bind(this.hideHDError, this);
      this.showHDError = bind(this.showHDError, this);
      this.submit = bind(this.submit, this);
      this.paste = bind(this.paste, this);
      this.insert = bind(this.insert, this);
      this.parent = opts.parent;
      this.provider = this.parent.provider;
      this.locker = new chms.utils.Locker();
      this.channelId = this.parent.channelId;
    }

    UploadCoubPopup.prototype.insert = function() {
      this.parent.el.addClass('-working');
      (this.popup = $(JST["app/site/templates/profile/upload_coub_popup"]())).appendTo(this.parent.el);
      this.permalinkInput = this.popup.find("[name=permalink]");
      this.hdMark = this.popup.find(".hd");
      this.error = this.popup.find('.-error-text');
      this.permalinkInput.on("paste", (function(_this) {
        return function() {
          return setTimeout(function() {
            return _this.paste();
          }, 300);
        };
      })(this));
      return this.popup.find('.box__close').on('click', this.hideAndShowControls);
    };

    UploadCoubPopup.prototype.paste = function() {
      if (this.permalinkInput.val().match(this.COUB_PERMALINK_REGEX)) {
        return this.submit();
      }
    };

    UploadCoubPopup.prototype.submit = function(e) {
      var permalink;
      if (e != null) {
        e.preventDefault();
      }
      if (this.locker.isLocked()) {
        return;
      }
      this.locker.lock();
      this.hideHDError();
      this.hideStaticError();
      permalink = this.permalinkInput.val();
      this.showLoader();
      return this.provider.changeCoverToCoub(permalink, this.channelId, {
        success: ((function(_this) {
          return function(e) {
            _this.hideAndShowControls();
            _this.unlisten();
            return _this.parent.el.trigger({
              type: pages.profile.view.UploadCoubPopup.EVENT_COUB_UPLOADED,
              layout: e.layout
            });
          };
        })(this)),
        error: ((function(_this) {
          return function(e) {
            var err;
            err = JSON.parse(e.responseText);
            switch (err.status) {
              case "nohd":
                return _this.showHDError();
              case "notpublic":
              case "agerestricted":
              case "invalidurl":
              case "noexist":
                return _this.showStaticError(err.message);
              default:
                ErrorMessages.internalServerError();
                return _this.hideAndShowControls();
            }
          };
        })(this)),
        complete: ((function(_this) {
          return function() {
            _this.locker.unlock();
            return _this.hideLoader();
          };
        })(this))
      });
    };

    UploadCoubPopup.prototype.showHDError = function() {
      return this.permalinkInput.add(this.hdMark).addClass("-error");
    };

    UploadCoubPopup.prototype.hideHDError = function() {
      return this.permalinkInput.add(this.hdMark).removeClass("-error");
    };

    UploadCoubPopup.prototype.showStaticError = function(msg) {
      return this.error.html(msg).show();
    };

    UploadCoubPopup.prototype.hideStaticError = function() {
      return this.error.html("").hide();
    };

    UploadCoubPopup.prototype.showLoader = function() {
      return LoadRotator.appendWithOverlayAndStart(this.popup);
    };

    UploadCoubPopup.prototype.hideLoader = function() {
      return LoadRotator.removeWithOverlay(this.popup);
    };

    UploadCoubPopup.prototype.clean = function() {
      this.permalinkInput.val("");
      this.hideHDError();
      return this.hideStaticError();
    };

    UploadCoubPopup.prototype.hideAndShowControls = function() {
      this.popup.remove();
      this.parent.el.removeClass('-working');
      return this.unlisten();
    };

    UploadCoubPopup.prototype.onKeydown = function(e) {
      if (e.keyCode === $.ui.keyCode.ESCAPE) {
        e.preventDefault();
        return this.hideAndShowControls();
      }
    };

    return UploadCoubPopup;

  })(AbstractControlable);

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  pages.PromotedCoubDetails = (function() {
    PromotedCoubDetails.EVENTS = {
      CLOSED: 'PromotedCoubDetails.Closed'
    };

    function PromotedCoubDetails(id) {
      this.onResize = bind(this.onResize, this);
      new utils.ObservableMixin(this);
      this.s = this.constructor;
      this.popup = CoubModal.createPopup({
        content: '',
        classes: 'promoted-coub__details-popup'
      });
      this.popupBody = $('.modal__body', this.popup.el).attr({
        "data-scroll-type": "vertical"
      });
      this.popup.el.one(window.Popup.EVENT_HIDED, (function(_this) {
        return function() {
          return _this.trigger(_this.s.EVENTS.CLOSED);
        };
      })(this));
      this.loadPromotedCoub(id);
    }

    PromotedCoubDetails.prototype.onResize = function() {
      return this.popupBody.nice_scroller();
    };

    PromotedCoubDetails.prototype.initPauseButton = function() {
      var button, isActive, isLoading, statusEl, url;
      button = $('.campaign-details__pause-button', this.popup.el);
      statusEl = $('.campaign-details__status span', this.popup.el);
      isActive = this.promotedCoub.is_active;
      url = Routes.api_v2_promoted_coub_path(this.promotedCoub.id);
      isLoading = false;
      return button.click((function(_this) {
        return function() {
          var data;
          if (isLoading) {
            return;
          }
          isLoading = true;
          button.addClass('disabled');
          isActive = !isActive;
          data = {
            promoted_coub: {
              is_active: isActive
            }
          };
          return _this.xhr = $.put(url, data).done(function(r) {
            console.log('UPDATE DONE', r);
            if (isActive) {
              statusEl.text(I18n.t("promoted_coubs.statuses." + r.status));
              return button.text(I18n.t('promoted_coubs.details.pause'));
            } else {
              if (r.status === 'approved') {
                statusEl.text(I18n.t("promoted_coubs.statuses.paused"));
              }
              return button.text(I18n.t('promoted_coubs.details.start'));
            }
          }).fail(function(e) {
            return alert(e.responseText);
          }).always(function() {
            isLoading = false;
            return button.removeClass('disabled');
          });
        };
      })(this));
    };

    PromotedCoubDetails.prototype.initEditButton = function() {
      var button;
      button = $('.campaign-details__edit-button', this.popupBody);
      return button.click(function(e) {
        if (e.metaKey || e.ctrlKey) {
          return;
        }
        e.preventDefault();
        return page($(e.currentTarget).attr('href'));
      });
    };

    PromotedCoubDetails.prototype.initClicksDropdown = function() {
      var content, handler;
      handler = $('.campaign-details__clicks-dropdown-handler', this.popupBody);
      content = $('.campaign-details__clicks-dropdown-content', this.popupBody).removeClass('-hidden').detach();
      return this.clicksDropdown = new window.HoverableAbsoluteDropdown({
        el: this.popupBody,
        classNames: 'campaign-details__clicks-dropdown',
        defaultContent: content,
        handle: handler,
        handlerEventOpen: 'mouseenter',
        dropdownPosition: AbsoluteDropdown.POSITION_TYPE.ABSOLUTE_TOP,
        handlerEventClose: HoverableAbsoluteDropdown.EVENTS.MOUSEOUT_TIMEOUT,
        hideTimeout: 150,
        animationDuration: 50
      });
    };

    PromotedCoubDetails.prototype.loadPromotedCoub = function(id) {
      LoadIndicator.appendToContainer(this.popup.el, LoadIndicator.SIZE.BIG);
      return this.xhr = $.get(Routes.api_v2_promoted_coub_path(id)).done((function(_this) {
        return function(r) {
          console.log('pc done', r);
          _this.promotedCoub = r;
          if (_this.promotedCoub.coub) {
            return _this.loadCoub(_this.promotedCoub.coub.permalink);
          } else {
            LoadIndicator.removeFromContainer(_this.popup.el);
            return _this.popup.setContent(JST['app/site/templates/promoted_coubs/campaign_details']({
              promotedCoub: _this.promotedCoub
            }));
          }
        };
      })(this)).fail((function(_this) {
        return function(e) {
          return console.error(e);
        };
      })(this));
    };

    PromotedCoubDetails.prototype.loadCoub = function(permalink) {
      return this.xhr = $.get("/coubs/" + permalink + ".json").done((function(_this) {
        return function(coub) {
          LoadIndicator.removeFromContainer(_this.popup.el);
          coub.render = {
            'card-type': 'small',
            'no-date': 'hidden'
          };
          _this.popup.setContent(JST['app/site/templates/promoted_coubs/campaign_details']({
            promotedCoub: _this.promotedCoub,
            coub: coub
          }));
          CoubBlockClientside.constructFromContainer(_this.popup.el);
          _this.viewer = $('.viewer', _this.popup.el);
          _this.initPauseButton();
          _this.initEditButton();
          _this.initClicksDropdown();
          _this.debouncedResize = _.debounce(_this.onResize, 100);
          $(window).on('resize', _this.debouncedResize);
          return _this.onResize();
        };
      })(this)).fail((function(_this) {
        return function(e) {
          return console.error(e);
        };
      })(this));
    };

    PromotedCoubDetails.prototype.destroy = function() {
      this.xhr && this.xhr.abort();
      this.clicksDropdown && this.clicksDropdown.hide();
      this.popup.el.off(window.Popup.EVENT_HIDED);
      this.popup.el.remove();
      this.viewer && this.viewer.trigger('unembed');
      return $(window).off('resize', this.debouncedResize);
    };

    return PromotedCoubDetails;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  pages.PromotedCoubForm = (function() {
    PromotedCoubForm.EVENTS = {
      CLOSED: 'PromotedCoubForm.Closed',
      CHANGED: 'PromotedCoubForm.Changed'
    };

    function PromotedCoubForm(opts) {
      var pcid;
      if (opts == null) {
        opts = {};
      }
      this.triggerCoub = bind(this.triggerCoub, this);
      this.onResize = bind(this.onResize, this);
      new utils.ObservableMixin(this);
      this.s = this.constructor;
      this.popup = CoubModal.createPopup({
        content: "<div class='promoted-coub__form'></div>",
        classes: 'promoted-coub__form-popup'
      });
      this.popupBody = $('.modal__body', this.popup.el).attr({
        "data-scroll-type": "vertical"
      });
      this.isEditMode = !!opts.promotedCoubId;
      if (pcid = opts.promotedCoubId) {
        this.loadPromotedCoub(pcid);
      } else {
        this.initForm();
        this.initCoubInput(opts.coubPermalink, true);
        this.initViewsInput();
        this.initCountrySelect();
        this.initPlatformsSelect();
        this.initDateSelect();
      }
      this.show();
    }

    PromotedCoubForm.prototype.loadPromotedCoub = function(id) {
      LoadIndicator.appendToContainer(this.popup.el, LoadIndicator.SIZE.BIG);
      return this.xhr = $.get(Routes.api_v2_promoted_coub_path(id)).done((function(_this) {
        return function(r) {
          console.log('pc done', r);
          _this.initialCoubPermalink = r.coub && r.coub.permalink;
          _this.isCoubPermalinkCheckEnabled = r.status === 'rejected';
          _this.initForm(r);
          _this.initCoubInput(r.coub && r.coub.permalink, r.status === 'rejected' || !r.coub);
          _this.initViewsInput(r.target_views);
          _this.initCountrySelect(r.country_codes);
          _this.initPlatformsSelect(r);
          return _this.initDateSelect();
        };
      })(this)).fail((function(_this) {
        return function(e) {
          return console.error(e);
        };
      })(this)).always((function(_this) {
        return function() {
          return LoadIndicator.removeFromContainer(_this.popup.el);
        };
      })(this));
    };

    PromotedCoubForm.prototype.initForm = function(promotedCoub) {
      var form, nameForm;
      form = JST['app/site/templates/promoted_coubs/promoted_coub_form'](promotedCoub);
      nameForm = JST['app/site/templates/promoted_coubs/promoted_coub_name_inputs'](this.getSavedName());
      this.popup.setContent(form + nameForm);
      this.form = $('form.promoted-coub__form', this.popup.el);
      this.form.on('submit', function(e) {
        return e.preventDefault();
      });
      this.submitButton = $('.sb.submit', this.form);
      this.submitButton.click((function(_this) {
        return function() {
          return _this.submit();
        };
      })(this));
      this.initNameForm();
      return this.initResize();
    };

    PromotedCoubForm.prototype.initNameForm = function() {
      this.nameForm = $('form.promoted-coub__name-form', this.popup.el);
      this.firstNameInput = $('[name=first]', this.nameForm);
      this.lastNameInput = $('[name=last]', this.nameForm);
      this.nextButton = $('.promoted-coub__name-form__next', this.nameForm);
      this.nameForm.on('submit', function(e) {
        return e.preventDefault();
      });
      $('.promoted-coub__name-form__back', this.nameForm).click((function(_this) {
        return function() {
          _this.form.removeClass('-hidden');
          _this.nameForm.addClass('-hidden');
          return _this.nextButton.off('click');
        };
      })(this));
      this.firstNameInput.add(this.lastNameInput).on('input', (function(_this) {
        return function() {
          return _this.nextButton.toggleClass('disabled', !_this.firstNameInput.val() || !_this.lastNameInput.val());
        };
      })(this));
      return this.firstNameInput.add(this.lastNameInput).on('keydown', (function(_this) {
        return function(e) {
          if (e.keyCode === 13) {
            return e.preventDefault();
          }
        };
      })(this));
    };

    PromotedCoubForm.prototype.initCoubInput = function(coubPermalink, isReplaceCoubShowed) {
      var appendCoub, changeButton, clearCoub, coubContainer, coubInput, coubInputContainer, loadCoub, submitCoub;
      coubInputContainer = $('.promoted-coub__form__coub-input-container', this.form);
      coubInput = $('input[name=coub_id]', coubInputContainer);
      coubContainer = $('.promoted-coub__form__coub-container', this.form);
      changeButton = $('> button', coubContainer);
      submitCoub = (function(_this) {
        return function() {
          if (_this.isCoubLoading) {
            return;
          }
          return _.defer(function() {
            var p, url;
            url = coubInput.val();
            if (p = helpers.Application.getCoubPermalinkFromUrl(url)) {
              return loadCoub(p);
            } else {
              return console.error('invalid coub url');
            }
          });
        };
      })(this);
      loadCoub = (function(_this) {
        return function(permalink) {
          _this.isCoubLoading = true;
          coubInput.addClass('disabled');
          LoadIndicator.appendToContainer(coubInputContainer, LoadIndicator.SIZE.BIG);
          return _this.xhr = $.get(Routes.api_v2_coub_path(permalink)).done(function(json) {
            if (helpers.PromotedCoubsHelper.coubCanToBePromoted(json)) {
              coubInputContainer.addClass('-hidden');
              return appendCoub(json);
            } else {
              return alert("this coub can't be promoted");
            }
          }).fail(function(e) {
            return console.error('coub load failed', e);
          }).always(function() {
            _this.isCoubLoading = false;
            coubInput.removeClass('disabled');
            return LoadIndicator.removeFromContainer(coubInputContainer);
          });
        };
      })(this);
      appendCoub = (function(_this) {
        return function(json) {
          var card;
          _this.loadedCoubPermalink = json.permalink;
          coubInput.val(json.id);
          json.render = {
            'no-sharing': 'true',
            'card-type': 'small'
          };
          card = $(JST['app/site/templates/coub_block/coub'](json));
          card.prependTo(coubContainer);
          _this.viewer = $('.viewer', card);
          coubContainer.removeClass('-hidden');
          if (isReplaceCoubShowed) {
            changeButton.removeClass('-hidden');
          }
          _this.setSubmitButtonState();
          return CoubBlockClientside.constructFromContainer(coubContainer);
        };
      })(this);
      clearCoub = (function(_this) {
        return function() {
          _this.loadedCoubPermalink = null;
          coubInputContainer.removeClass('-hidden');
          coubInput.val(null).focus();
          $('.coub', coubContainer).remove();
          coubContainer.addClass('-hidden');
          _this.triggerCoub('unembed');
          return _this.setSubmitButtonState();
        };
      })(this);
      coubInput.on('keydown', (function(_this) {
        return function(e) {
          if (_this.isCoubLoading || e.keyCode === 13) {
            e.preventDefault();
          }
          if (e.keyCode === Utils.KEY_CODES.ENTER) {
            return submitCoub();
          }
        };
      })(this));
      coubInput.on('paste', submitCoub);
      changeButton.click(clearCoub);
      if (coubPermalink) {
        return loadCoub(coubPermalink);
      }
    };

    PromotedCoubForm.prototype.initDateSelect = function() {
      $('.date-select', this.form).one('mouseover', (function(_this) {
        return function() {
          $('.date-select', _this.form).each(function() {
            return new NiceDateSelect({
              el: this,
              fullMonthNames: true,
              utc: true
            });
          });
          return $('.dropdown', _this.form).each(function() {
            return $(this).dropdown();
          });
        };
      })(this));
      return $('.date-select__input[type=hidden]', this.form).on("change", (function(_this) {
        return function(e) {
          var dateVal, maxDate;
          dateVal = new Date(e.target.value);
          maxDate = new Date();
          maxDate.setMonth(maxDate.getMonth() + 3);
          return $('.date-select__input', _this.form).toggleClass("error", dateVal > maxDate);
        };
      })(this));
    };

    PromotedCoubForm.prototype.initViewsInput = function(viewsCount) {
      var onInput, setViewsCount;
      this.viewsCountInput = $('input[name=target_views]', this.form);
      this.totalBudget = $('.promoted-coub__form-total .budget', this.form);
      setViewsCount = (function(_this) {
        return function(value) {
          _this.viewsCountInput.removeClass('error');
          _this.viewsCountInput.val(value);
          return _this.totalBudget.text(value / 10);
        };
      })(this);
      if (viewsCount) {
        setViewsCount(viewsCount);
        return;
      }
      onInput = (function(_this) {
        return function() {
          var value;
          _this.viewsCountInput.removeClass('error');
          value = parseInt(_this.viewsCountInput.val());
          if (isNaN(value) || value < 1000) {
            _this.viewsCountInput.addClass('error');
            _this.totalBudget.text('-');
          } else {
            setViewsCount(value);
          }
          return _this.setSubmitButtonState();
        };
      })(this);
      this.viewsCountInput.on('input', onInput);
      return onInput();
    };

    PromotedCoubForm.prototype.initCountrySelect = function(countryCodes) {
      var container, opts;
      container = $('.promoted-coub__form__countries-selector', this.form);
      opts = {
        tagName: 'country_codes[]',
        availableCountries: Params.getBranchValue('promote.countries'),
        value: countryCodes
      };
      this.countriesSelector = new CountriesSelector(container, opts);
      return this.countriesSelector.on(CountriesSelector.EVENTS.CHANGE, (function(_this) {
        return function() {
          return _this.setSubmitButtonState();
        };
      })(this));
    };

    PromotedCoubForm.prototype.initPlatformsSelect = function(promotedCoubData) {
      var container, i, j, len, len1, p, platformInputs, platforms, ref;
      container = $('.promoted-coub__form__platforms', this.form);
      platformInputs = $("input[type=checkbox]", container);
      this.linkInputs = $("input[name$=_link]", container);
      if (promotedCoubData) {
        if ((platforms = promotedCoubData.platforms) && platforms.length) {
          platformInputs.attr('checked', false);
          this.linkInputs.addClass('-hidden');
          for (i = 0, len = platforms.length; i < len; i++) {
            p = platforms[i];
            platformInputs.filter("[value=" + p + "]").attr('checked', true);
            this.linkInputs.filter("[name=" + p + "_link]").removeClass('-hidden');
          }
        }
        ref = ["web", "ios", "android"];
        for (j = 0, len1 = ref.length; j < len1; j++) {
          p = ref[j];
          this.linkInputs.filter("[name=" + p + "_link]").val(promotedCoubData[p + "_link"] || "");
        }
      }
      platformInputs.change((function(_this) {
        return function(e) {
          var isChecked, linkInput, target, val;
          target = $(e.currentTarget);
          isChecked = target.is(':checked');
          val = target.val();
          linkInput = _this.linkInputs.filter("[name=" + val + "_link]");
          linkInput.toggleClass('-hidden', !isChecked);
          return _this.setSubmitButtonState();
        };
      })(this));
      return this.linkInputs.on('input', (function(_this) {
        return function(e) {
          var target, val;
          target = $(e.currentTarget);
          target.removeClass('error');
          if ((val = target.val()) && !target.val().match(new RegExp(/^https?:\/\//))) {
            target.addClass('error');
          }
          return _this.setSubmitButtonState();
        };
      })(this));
    };

    PromotedCoubForm.prototype.initResize = function() {
      this.debouncedResize = _.debounce(this.onResize, 100);
      $(window).on('resize', this.debouncedResize);
      return this.onResize();
    };

    PromotedCoubForm.prototype.onResize = function() {
      return this.popupBody.nice_scroller();
    };

    PromotedCoubForm.prototype.triggerCoub = function(action) {
      this.viewer && this.viewer.triggerHandler(action);
      if (action === 'unembed') {
        return this.viewer = null;
      }
    };

    PromotedCoubForm.prototype.show = function() {
      this.popup.show();
      return this.popup.el.one(window.Popup.EVENT_HIDED, (function(_this) {
        return function() {
          return _this.trigger(_this.s.EVENTS.CLOSED);
        };
      })(this));
    };

    PromotedCoubForm.prototype.hide = function() {
      this.triggerCoub('suspend');
      this.popup.el.off(window.Popup.EVENT_HIDED);
      return this.popup.close();
    };

    PromotedCoubForm.prototype.destroy = function() {
      this.hide();
      this.triggerCoub('unembed');
      this.xhr && this.xhr.abort();
      this.countriesSelector && this.countriesSelector.destroy();
      this.popup.el.remove();
      return $(window).off('resize', this.debouncedResize);
    };

    PromotedCoubForm.prototype.setSubmitButtonState = function() {
      return this.submitButton.toggleClass('disabled', !this.isFormValid());
    };

    PromotedCoubForm.prototype.isFormValid = function() {
      var data, editCheck, key, ref, result, value;
      data = this.form.serializeObject();
      if (!data.platforms) {
        return false;
      }
      result = true;
      ref = _.omit(data, 'android_link', 'ios_link', 'web_link', 'label');
      for (key in ref) {
        value = ref[key];
        if (!value) {
          result = false;
        }
      }
      editCheck = this.isEditMode ? this.isCoubPermalinkCheckEnabled ? this.initialCoubPermalink !== this.loadedCoubPermalink : true : true;
      return result && !this.viewsCountInput.hasClass('error') && !this.linkInputs.filter('.error').length && editCheck;
    };

    PromotedCoubForm.prototype.getSavedName = function() {
      return Params.get("promoted_coubs_name") || {};
    };

    PromotedCoubForm.prototype.saveName = function() {
      var data;
      data = {
        first: this.firstNameInput.val(),
        last: this.lastNameInput.val()
      };
      Params.set("promoted_coubs_name", data);
      return $.put(Routes.save_name_promoted_coubs_path(), data);
    };

    PromotedCoubForm.prototype.submit = function() {
      var createPayment, createPromotedCoub, data, method, onError, showNameForm, updatePromotedCoub, url;
      if (this.isLoading || !this.isFormValid()) {
        return;
      }
      onError = (function(_this) {
        return function(e) {
          var err, msg;
          if (e.status === 422) {
            err = JSON.parse(e.responseText).validation_errors;
            msg = Object.keys(err).map(function(field) {
              return field + " " + err[field];
            }).join("<br />");
            Growl.msg(I18n.t("growl_errors.save_error"), msg);
          } else {
            alert(e.responseText);
          }
          _this.isLoading = false;
          return _this.submitButton.add(_this.nextButton).removeClass('disabled');
        };
      })(this);
      showNameForm = (function(_this) {
        return function() {
          _this.form.addClass('-hidden');
          _this.nameForm.removeClass('-hidden');
          return _this.nextButton.click(function() {
            return _this.saveName().always(function() {
              return createPromotedCoub(url, data);
            });
          });
        };
      })(this);
      createPromotedCoub = (function(_this) {
        return function(url, data) {
          if (_this.isLoading) {
            return;
          }
          _this.isLoading = true;
          _this.submitButton.add(_this.nextButton).addClass('disabled');
          return _this.xhr = $.post(url, data).done(function(r) {
            console.log('DONE', r);
            return createPayment(r.id);
          }).fail(onError);
        };
      })(this);
      createPayment = (function(_this) {
        return function(pcid) {
          var data;
          data = {
            first_name: _this.firstNameInput.val(),
            last_name: _this.lastNameInput.val()
          };
          return _this.xhr = $.post(Routes.create_payment_api_v2_promoted_coub_path(pcid), data).done(function(r) {
            console.log('PAYMENT', r);
            return window.location.replace(r.confirmation_url);
          }).fail(onError);
        };
      })(this);
      updatePromotedCoub = (function(_this) {
        return function(url, data) {
          _this.isLoading = true;
          _this.submitButton.addClass('disabled');
          return _this.xhr = $.put(url, data).done(function(r) {
            console.log('UPDATE DONE', r);
            return _this.trigger(_this.s.EVENTS.CHANGED, r.id);
          }).fail(onError);
        };
      })(this);
      url = this.form.attr('action');
      method = this.form.attr('method');
      data = {
        promoted_coub: this.form.serializeObject()
      };
      if (method === 'POST') {
        return showNameForm();
      } else {
        return updatePromotedCoub(url, data);
      }
    };

    return PromotedCoubForm;

  })();

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  pages.PromotedCoubsPage = (function() {
    PromotedCoubsPage.ATTR_NAME = 'promoted-coubs-page';

    function PromotedCoubsPage(el) {
      this.el = el;
      this.renderEdit = bind(this.renderEdit, this);
      this.renderDetails = bind(this.renderDetails, this);
      this.renderNew = bind(this.renderNew, this);
      this.clearPopups = bind(this.clearPopups, this);
      this.initNavigation();
      this.initCoubsList();
      this.initRoutes();
      this.initPayButton();
    }

    PromotedCoubsPage.prototype.initNavigation = function() {
      return this.el.on('click', '.promoted-coubs__new-campaign, .promoted-coubs__table-item, .promoted-coubs__edit', function(e) {
        if (e.metaKey || e.ctrlKey) {
          return;
        }
        e.preventDefault();
        return page($(e.currentTarget).attr('href'));
      });
    };

    PromotedCoubsPage.prototype.initRoutes = function() {
      page.base('/promote');
      page('/', this.clearPopups, $.noop);
      page('/new', this.clearPopups, this.renderNew);
      page('/:id', this.clearPopups, this.renderDetails);
      page('/:id/edit', this.clearPopups, this.renderEdit);
      return page({
        click: false
      });
    };

    PromotedCoubsPage.prototype.initPayButton = function() {
      var isLoading;
      isLoading = false;
      return this.el.on('click', '.promoted-coubs__pay', (function(_this) {
        return function(e) {
          var id, target;
          if (isLoading) {
            return;
          }
          target = $(e.currentTarget);
          id = target.closest('tr[data-id]').attr('data-id');
          isLoading = true;
          return $.post(Routes.create_payment_api_v2_promoted_coub_path(id)).done(function(r) {
            console.log('PAYMENT', r);
            return window.location.replace(r.confirmation_url);
          }).fail(function(e) {
            isLoading = false;
            return console.error(e);
          });
        };
      })(this));
    };

    PromotedCoubsPage.prototype.initCoubsList = function() {
      var container, currentPage, indicatorContainer, isLoading, loadCurrentPage, onScroll, perPage, renderList, renderStub, table, totalPages;
      currentPage = 1;
      totalPages = 100;
      perPage = 30;
      isLoading = false;
      indicatorContainer = $('.promoted-coubs__load-indicator', this.el);
      table = $('.promoted-coubs__table', this.el);
      container = $('tbody', table);
      loadCurrentPage = (function(_this) {
        return function() {
          var params;
          if (isLoading) {
            return;
          }
          isLoading = true;
          LoadIndicator.appendToContainer(indicatorContainer, LoadIndicator.SIZE.BIG);
          params = {
            page: currentPage,
            per_page: perPage
          };
          return $.get(Routes.api_v2_promoted_coubs_path(), params).done(function(r) {
            totalPages = r.total_pages;
            if (totalPages !== 0) {
              return renderList(r.promoted_coubs);
            } else {
              return renderStub();
            }
          }).fail(function(e) {
            return console.error('ERROR', e);
          }).always(function() {
            LoadIndicator.removeFromContainer(indicatorContainer);
            return isLoading = false;
          });
        };
      })(this);
      renderList = (function(_this) {
        return function(promotedCoubs) {
          var i, len, list, pc, promotedCoub;
          list = [];
          for (i = 0, len = promotedCoubs.length; i < len; i++) {
            pc = promotedCoubs[i];
            promotedCoub = JST['app/site/templates/promoted_coubs/promoted_coub_table_item'](pc);
            list.push(promotedCoub);
          }
          return container.append(list.join(''));
        };
      })(this);
      renderStub = (function(_this) {
        return function() {
          var stub;
          stub = JST['app/site/templates/promoted_coubs/promoted_coubs_stub']();
          return table.replaceWith(stub);
        };
      })(this);
      onScroll = (function(_this) {
        return function() {
          if ($(window).scrollTop() + window.innerHeight + 300 > container.offset().top + container.height() && currentPage < totalPages) {
            currentPage++;
            return loadCurrentPage();
          }
        };
      })(this);
      $(window).scroll(_.throttle(onScroll, 50));
      return loadCurrentPage();
    };

    PromotedCoubsPage.prototype.clearPopups = function(ctx, next) {
      this.newPromotedCoubForm && this.newPromotedCoubForm.hide();
      if (this.detailsView) {
        this.detailsView.destroy();
        this.detailsView.off(pages.PromotedCoubDetails.EVENTS.CLOSED);
        this.detailsView = null;
      }
      if (this.editForm) {
        this.editForm.destroy();
        this.editForm.off(pages.PromotedCoubForm.EVENTS.CLOSED);
        this.editForm.off(pages.PromotedCoubForm.EVENTS.CHANGED);
        this.editForm = null;
      }
      return next && next();
    };

    PromotedCoubsPage.prototype.renderNew = function() {
      if (!this.newPromotedCoubForm) {
        this.newPromotedCoubForm = new pages.PromotedCoubForm();
        this.newPromotedCoubForm.on(pages.PromotedCoubForm.EVENTS.CLOSED, function() {
          return page('/');
        });
      }
      return this.newPromotedCoubForm.show();
    };

    PromotedCoubsPage.prototype.renderDetails = function(ctx) {
      var id;
      id = ctx.params.id;
      this.detailsView = new pages.PromotedCoubDetails(id);
      return this.detailsView.on(pages.PromotedCoubDetails.EVENTS.CLOSED, function() {
        return page('/');
      });
    };

    PromotedCoubsPage.prototype.renderEdit = function(ctx) {
      this.editForm = new pages.PromotedCoubForm({
        promotedCoubId: ctx.params.id
      });
      this.editForm.on(pages.PromotedCoubForm.EVENTS.CLOSED, function() {
        return page('/');
      });
      this.editForm.on(pages.PromotedCoubForm.EVENTS.CHANGED, function(id) {
        return page("/" + id);
      });
      return this.editForm.show();
    };

    return PromotedCoubsPage;

  })();

}).call(this);
(function() {
  window.SearchPage = {
    init: function(el) {
      var $el;
      $el = $(el);
      new widgets.timeline.SimpleTimelineWithFilters($el, {
        base: '/search'
      });
      return new widgets.timeline.TimelineEditorSwitch($el);
    }
  };

}).call(this);
(function() {
  pages.TagPage = (function() {
    TagPage.ATTR_NAME = 'pages-tag-page';

    function TagPage(el) {
      var base, parts, path;
      this.el = el;
      path = window.location.pathname;
      parts = path.split('/');
      parts.length = 3;
      base = parts.join('/');
      new widgets.timeline.SimpleTimelineWithFilters(this.el, {
        base: base
      });
      new widgets.timeline.TimelineEditorSwitch(this.el);
    }

    return TagPage;

  })();

}).call(this);
(function() {
  pages.WeeklyPage = (function() {
    WeeklyPage.ATTR_NAME = "page-weekly-single";

    function WeeklyPage(el) {
      var targetCoubPermalink;
      this.el = el;
      widgets.timeline.ViewSelector.constructIn(this.el);
      new widgets.timeline.TimelineControls(this.el);
      $.cookie('last_visited_weekly_at', new Date().getTime(), {
        expires: 7,
        path: '/'
      });
      if ((targetCoubPermalink = window.location.hash.substr(1))) {
        $(document).one(clientsideTimeline.ClientsideTimeline.EVENT_FIRST_PAGE_LOADED, _.wrap(this.scrollToCoub.bind(this, targetCoubPermalink), _.defer));
      }
    }

    WeeklyPage.prototype.scrollToCoub = function(permalink) {
      var $coub;
      $coub = $(".coub[data-permalink=" + permalink + "]");
      if (!$coub.length) {
        return;
      }
      $(window).scrollTop($coub.offset().top - 130);
      return setTimeout(function($coub) {
        return $coub.find(".viewer").triggerHandler("play");
      }, 1000, $coub);
    };

    return WeeklyPage;

  })();

}).call(this);
(function() {
  $(function() {
    var aiWidgets, i, len, promoPage, results, w;
    window._debugStackEditorAudioTrack = [];
    $.storage = new $.store();
    $.cookie('last_visited_at', new Date().getTime(), {
      expires: 365,
      path: '/'
    });
    new initializers.ModelFiller();
    Mouse.init();
    ImagePlaceholder.init();
    new EmbedPopupLink();
    new CoubEmbedPopupLink();
    new PromoteCoubLink();
    new widgets.WidgetStateChanger();
    PushNotifications.init();
    new window.CoubMainMenu();
    new window.CoubPageMenu();
    $(".loadRotator").makeLoader();
    $(".dropdown--select").nice_select();
    $(".hasScroller").nice_scroller();
    $(".dropdown").dropdown();
    $('.box.raw-video-notify').each(function() {
      return new RawVideoNotification(this);
    });
    $('.channel-featured-editor').featured_channels();
    $('.editorMenu .moderatedButton').moderated_button();
    $('.coub-page').each(function() {
      return new ModernCoubPage($(this));
    });
    if (!GlobalState.PLATFORM.isMobile()) {
      $("[data-prompt]").prompt();
    }
    $(".tos__navigation").tos_navigation();
    _.defer((function(_this) {
      return function() {
        return chms.utils.Autoinit.init(SearchAutocomplete);
      };
    })(this));
    chms.utils.Autoinit.init(StoryPage);
    chms.utils.Autoinit.init(StoryForm);
    pages.editAccount.Main.construct();
    $(".header").header();
    clientsideTimeline.ClientsideTimeline.constructIn();
    chms.utils.Autoinit.init(window.clientsideTimeline.ClientsideTimelineChannels);
    $('.about-page').each(function() {
      return new AboutPage(this);
    });
    $('.faq-page').each(function() {
      return new FaqPage({
        el: this
      });
    });
    $('.dev-docs').each(function() {
      return new DevDocsPage(this);
    });
    $('.explore-channels-page').each(function() {
      return new ExplorePage(this);
    });
    chms.utils.Autoinit.init(pages.HotPage);
    chms.utils.Autoinit.init(pages.RandomPage);
    chms.utils.Autoinit.init(pages.CommunityPage);
    chms.utils.Autoinit.init(pages.CommunitySpecialPage);
    chms.utils.Autoinit.init(pages.FeaturedPage);
    chms.utils.Autoinit.init(pages.FeaturedIndexPage);
    chms.utils.Autoinit.init(pages.FeedPage);
    chms.utils.Autoinit.init(pages.TagPage);
    chms.utils.Autoinit.init(pages.LikesPage);
    chms.utils.Autoinit.init(pages.FavouritesPage);
    chms.utils.Autoinit.init(pages.PromotedCoubsPage);
    $('body.find-friends-page').each(function() {
      return new pages.findFriends.Page(this);
    });
    $('body.media-page').each(function() {
      return new MediaPage({
        el: this
      });
    });
    $('[single-search-page]').each(function() {
      return SearchPage.init(this);
    });
    $('.howtochannels-page').each(function() {
      return new ChannelsPromoPage({
        el: this
      });
    });
    if (!GlobalState.USER.isLogedIn()) {
      ToggleRegistration.construct($("body"));
    }
    VerificationEmailBlock.construct();
    Scroller.construct();
    new UnlogedAction();
    pages.profile.view.Page.construct();
    chms.utils.Autoinit.init(pages.bestCoubs2013.Page);
    chms.utils.Autoinit.init(pages.bestCoubs2014.Page);
    chms.utils.Autoinit.init(pages.bestCoubs2015.Page);
    chms.utils.Autoinit.init(pages.bestCoubs2016.Countdown);
    chms.utils.Autoinit.init(pages.bestCoubs2016.Page);
    chms.utils.Autoinit.init(pages.bestCoubs2016.OldSpice);
    chms.utils.Autoinit.init(pages.bestCoubs2012.Page);
    chms.utils.Autoinit.init(pages.bestCoubs2017.Page);
    chms.utils.Autoinit.init(pages.bestCoubs2018.Page);
    chms.utils.Autoinit.init(pages.bestCoubs2019.Page);
    chms.utils.Autoinit.init(pages.WeeklyPage);
    for (promoPage in pages.profile.promo) {
      chms.utils.Autoinit.init(pages.profile.promo[promoPage]);
    }
    new functions.ScrollHandler();
    new functions.WindowWidthHeight();
    new functions.AmplitudeLocationTracker();
    new functions.FullscreenBodyClass();
    chms.utils.Autoinit.init(widgets.ChannelChanger);
    chms.utils.Autoinit.init(blocks.NotificationsPopup);
    LocalesListPopup.init();
    aiWidgets = [channels.CreateChannelPopup, widgets.ChannelItemAvatar, widgets.ChannelItemUrl, widgets.ChannelItemCurrent, widgets.CurrentChannelNotificationsCount, blocks.ChannelMenuDropdown, blocks.FriendshipsBlock, blocks.ChannelsBlock, blocks.StoriesBlock, widgets.FollowingCounter, widgets.FollowersCounter, widgets.ListKeyNavigation, widgets.WidgetFollowButtonInit, widgets.FriendsCount, widgets.FriendsBanner, widgets.BannerClose, widgets.CountrySelector, widgets.LocaleSelector, widgets.CountdownTimer, widgets.StoryCard, blocks.FriendshipNotificationsPopup, pages.newEditorPromo.Page, pages.ApplicationBody, MTSPromoWidget, widgets.AdfoxSidebarWidget, widgets.AdfoxFeaturedBanner];
    results = [];
    for (i = 0, len = aiWidgets.length; i < len; i++) {
      w = aiWidgets[i];
      results.push(chms.utils.Autoinit.init(w));
    }
    return results;
  });

}).call(this);
/*! jQuery UI - v1.11.4+CommonJS - 2015-08-28
* http://jqueryui.com
* Includes: widget.js
* Copyright 2015 jQuery Foundation and other contributors; Licensed MIT */


(function( factory ) {
	if ( typeof define === "function" && define.amd ) {

		// AMD. Register as an anonymous module.
		define([ "jquery" ], factory );

	} else if ( typeof exports === "object" ) {

		// Node/CommonJS
		factory( require( "jquery" ) );

	} else {

		// Browser globals
		factory( jQuery );
	}
}(function( $ ) {
/*!
 * jQuery UI Widget 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/jQuery.widget/
 */


var widget_uuid = 0,
	widget_slice = Array.prototype.slice;

$.cleanData = (function( orig ) {
	return function( elems ) {
		var events, elem, i;
		for ( i = 0; (elem = elems[i]) != null; i++ ) {
			try {

				// Only trigger remove when necessary to save time
				events = $._data( elem, "events" );
				if ( events && events.remove ) {
					$( elem ).triggerHandler( "remove" );
				}

			// http://bugs.jquery.com/ticket/8235
			} catch ( e ) {}
		}
		orig( elems );
	};
})( $.cleanData );

$.widget = function( name, base, prototype ) {
	var fullName, existingConstructor, constructor, basePrototype,
		// proxiedPrototype allows the provided prototype to remain unmodified
		// so that it can be used as a mixin for multiple widgets (#8876)
		proxiedPrototype = {},
		namespace = name.split( "." )[ 0 ];

	name = name.split( "." )[ 1 ];
	fullName = namespace + "-" + name;

	if ( !prototype ) {
		prototype = base;
		base = $.Widget;
	}

	// create selector for plugin
	$.expr[ ":" ][ fullName.toLowerCase() ] = function( elem ) {
		return !!$.data( elem, fullName );
	};

	$[ namespace ] = $[ namespace ] || {};
	existingConstructor = $[ namespace ][ name ];
	constructor = $[ namespace ][ name ] = function( options, element ) {
		// allow instantiation without "new" keyword
		if ( !this._createWidget ) {
			return new constructor( options, element );
		}

		// allow instantiation without initializing for simple inheritance
		// must use "new" keyword (the code above always passes args)
		if ( arguments.length ) {
			this._createWidget( options, element );
		}
	};
	// extend with the existing constructor to carry over any static properties
	$.extend( constructor, existingConstructor, {
		version: prototype.version,
		// copy the object used to create the prototype in case we need to
		// redefine the widget later
		_proto: $.extend( {}, prototype ),
		// track widgets that inherit from this widget in case this widget is
		// redefined after a widget inherits from it
		_childConstructors: []
	});

	basePrototype = new base();
	// we need to make the options hash a property directly on the new instance
	// otherwise we'll modify the options hash on the prototype that we're
	// inheriting from
	basePrototype.options = $.widget.extend( {}, basePrototype.options );
	$.each( prototype, function( prop, value ) {
		if ( !$.isFunction( value ) ) {
			proxiedPrototype[ prop ] = value;
			return;
		}
		proxiedPrototype[ prop ] = (function() {
			var _super = function() {
					return base.prototype[ prop ].apply( this, arguments );
				},
				_superApply = function( args ) {
					return base.prototype[ prop ].apply( this, args );
				};
			return function() {
				var __super = this._super,
					__superApply = this._superApply,
					returnValue;

				this._super = _super;
				this._superApply = _superApply;

				returnValue = value.apply( this, arguments );

				this._super = __super;
				this._superApply = __superApply;

				return returnValue;
			};
		})();
	});
	constructor.prototype = $.widget.extend( basePrototype, {
		// TODO: remove support for widgetEventPrefix
		// always use the name + a colon as the prefix, e.g., draggable:start
		// don't prefix for widgets that aren't DOM-based
		widgetEventPrefix: existingConstructor ? (basePrototype.widgetEventPrefix || name) : name
	}, proxiedPrototype, {
		constructor: constructor,
		namespace: namespace,
		widgetName: name,
		widgetFullName: fullName
	});

	// If this widget is being redefined then we need to find all widgets that
	// are inheriting from it and redefine all of them so that they inherit from
	// the new version of this widget. We're essentially trying to replace one
	// level in the prototype chain.
	if ( existingConstructor ) {
		$.each( existingConstructor._childConstructors, function( i, child ) {
			var childPrototype = child.prototype;

			// redefine the child widget using the same prototype that was
			// originally used, but inherit from the new version of the base
			$.widget( childPrototype.namespace + "." + childPrototype.widgetName, constructor, child._proto );
		});
		// remove the list of existing child constructors from the old constructor
		// so the old child constructors can be garbage collected
		delete existingConstructor._childConstructors;
	} else {
		base._childConstructors.push( constructor );
	}

	$.widget.bridge( name, constructor );

	return constructor;
};

$.widget.extend = function( target ) {
	var input = widget_slice.call( arguments, 1 ),
		inputIndex = 0,
		inputLength = input.length,
		key,
		value;
	for ( ; inputIndex < inputLength; inputIndex++ ) {
		for ( key in input[ inputIndex ] ) {
			value = input[ inputIndex ][ key ];
			if ( input[ inputIndex ].hasOwnProperty( key ) && value !== undefined ) {
				// Clone objects
				if ( $.isPlainObject( value ) ) {
					target[ key ] = $.isPlainObject( target[ key ] ) ?
						$.widget.extend( {}, target[ key ], value ) :
						// Don't extend strings, arrays, etc. with objects
						$.widget.extend( {}, value );
				// Copy everything else by reference
				} else {
					target[ key ] = value;
				}
			}
		}
	}
	return target;
};

$.widget.bridge = function( name, object ) {
	var fullName = object.prototype.widgetFullName || name;
	$.fn[ name ] = function( options ) {
		var isMethodCall = typeof options === "string",
			args = widget_slice.call( arguments, 1 ),
			returnValue = this;

		if ( isMethodCall ) {
			this.each(function() {
				var methodValue,
					instance = $.data( this, fullName );
				if ( options === "instance" ) {
					returnValue = instance;
					return false;
				}
				if ( !instance ) {
					return $.error( "cannot call methods on " + name + " prior to initialization; " +
						"attempted to call method '" + options + "'" );
				}
				if ( !$.isFunction( instance[options] ) || options.charAt( 0 ) === "_" ) {
					return $.error( "no such method '" + options + "' for " + name + " widget instance" );
				}
				methodValue = instance[ options ].apply( instance, args );
				if ( methodValue !== instance && methodValue !== undefined ) {
					returnValue = methodValue && methodValue.jquery ?
						returnValue.pushStack( methodValue.get() ) :
						methodValue;
					return false;
				}
			});
		} else {

			// Allow multiple hashes to be passed on init
			if ( args.length ) {
				options = $.widget.extend.apply( null, [ options ].concat(args) );
			}

			this.each(function() {
				var instance = $.data( this, fullName );
				if ( instance ) {
					instance.option( options || {} );
					if ( instance._init ) {
						instance._init();
					}
				} else {
					$.data( this, fullName, new object( options, this ) );
				}
			});
		}

		return returnValue;
	};
};

$.Widget = function( /* options, element */ ) {};
$.Widget._childConstructors = [];

$.Widget.prototype = {
	widgetName: "widget",
	widgetEventPrefix: "",
	defaultElement: "<div>",
	options: {
		disabled: false,

		// callbacks
		create: null
	},
	_createWidget: function( options, element ) {
		element = $( element || this.defaultElement || this )[ 0 ];
		this.element = $( element );
		this.uuid = widget_uuid++;
		this.eventNamespace = "." + this.widgetName + this.uuid;

		this.bindings = $();
		this.hoverable = $();
		this.focusable = $();

		if ( element !== this ) {
			$.data( element, this.widgetFullName, this );
			this._on( true, this.element, {
				remove: function( event ) {
					if ( event.target === element ) {
						this.destroy();
					}
				}
			});
			this.document = $( element.style ?
				// element within the document
				element.ownerDocument :
				// element is window or document
				element.document || element );
			this.window = $( this.document[0].defaultView || this.document[0].parentWindow );
		}

		this.options = $.widget.extend( {},
			this.options,
			this._getCreateOptions(),
			options );

		this._create();
		this._trigger( "create", null, this._getCreateEventData() );
		this._init();
	},
	_getCreateOptions: $.noop,
	_getCreateEventData: $.noop,
	_create: $.noop,
	_init: $.noop,

	destroy: function() {
		this._destroy();
		// we can probably remove the unbind calls in 2.0
		// all event bindings should go through this._on()
		this.element
			.unbind( this.eventNamespace )
			.removeData( this.widgetFullName )
			// support: jquery <1.6.3
			// http://bugs.jquery.com/ticket/9413
			.removeData( $.camelCase( this.widgetFullName ) );
		this.widget()
			.unbind( this.eventNamespace )
			.removeAttr( "aria-disabled" )
			.removeClass(
				this.widgetFullName + "-disabled " +
				"ui-state-disabled" );

		// clean up events and states
		this.bindings.unbind( this.eventNamespace );
		this.hoverable.removeClass( "ui-state-hover" );
		this.focusable.removeClass( "ui-state-focus" );
	},
	_destroy: $.noop,

	widget: function() {
		return this.element;
	},

	option: function( key, value ) {
		var options = key,
			parts,
			curOption,
			i;

		if ( arguments.length === 0 ) {
			// don't return a reference to the internal hash
			return $.widget.extend( {}, this.options );
		}

		if ( typeof key === "string" ) {
			// handle nested keys, e.g., "foo.bar" => { foo: { bar: ___ } }
			options = {};
			parts = key.split( "." );
			key = parts.shift();
			if ( parts.length ) {
				curOption = options[ key ] = $.widget.extend( {}, this.options[ key ] );
				for ( i = 0; i < parts.length - 1; i++ ) {
					curOption[ parts[ i ] ] = curOption[ parts[ i ] ] || {};
					curOption = curOption[ parts[ i ] ];
				}
				key = parts.pop();
				if ( arguments.length === 1 ) {
					return curOption[ key ] === undefined ? null : curOption[ key ];
				}
				curOption[ key ] = value;
			} else {
				if ( arguments.length === 1 ) {
					return this.options[ key ] === undefined ? null : this.options[ key ];
				}
				options[ key ] = value;
			}
		}

		this._setOptions( options );

		return this;
	},
	_setOptions: function( options ) {
		var key;

		for ( key in options ) {
			this._setOption( key, options[ key ] );
		}

		return this;
	},
	_setOption: function( key, value ) {
		this.options[ key ] = value;

		if ( key === "disabled" ) {
			this.widget()
				.toggleClass( this.widgetFullName + "-disabled", !!value );

			// If the widget is becoming disabled, then nothing is interactive
			if ( value ) {
				this.hoverable.removeClass( "ui-state-hover" );
				this.focusable.removeClass( "ui-state-focus" );
			}
		}

		return this;
	},

	enable: function() {
		return this._setOptions({ disabled: false });
	},
	disable: function() {
		return this._setOptions({ disabled: true });
	},

	_on: function( suppressDisabledCheck, element, handlers ) {
		var delegateElement,
			instance = this;

		// no suppressDisabledCheck flag, shuffle arguments
		if ( typeof suppressDisabledCheck !== "boolean" ) {
			handlers = element;
			element = suppressDisabledCheck;
			suppressDisabledCheck = false;
		}

		// no element argument, shuffle and use this.element
		if ( !handlers ) {
			handlers = element;
			element = this.element;
			delegateElement = this.widget();
		} else {
			element = delegateElement = $( element );
			this.bindings = this.bindings.add( element );
		}

		$.each( handlers, function( event, handler ) {
			function handlerProxy() {
				// allow widgets to customize the disabled handling
				// - disabled as an array instead of boolean
				// - disabled class as method for disabling individual parts
				if ( !suppressDisabledCheck &&
						( instance.options.disabled === true ||
							$( this ).hasClass( "ui-state-disabled" ) ) ) {
					return;
				}
				return ( typeof handler === "string" ? instance[ handler ] : handler )
					.apply( instance, arguments );
			}

			// copy the guid so direct unbinding works
			if ( typeof handler !== "string" ) {
				handlerProxy.guid = handler.guid =
					handler.guid || handlerProxy.guid || $.guid++;
			}

			var match = event.match( /^([\w:-]*)\s*(.*)$/ ),
				eventName = match[1] + instance.eventNamespace,
				selector = match[2];
			if ( selector ) {
				delegateElement.delegate( selector, eventName, handlerProxy );
			} else {
				element.bind( eventName, handlerProxy );
			}
		});
	},

	_off: function( element, eventName ) {
		eventName = (eventName || "").split( " " ).join( this.eventNamespace + " " ) +
			this.eventNamespace;
		element.unbind( eventName ).undelegate( eventName );

		// Clear the stack to avoid memory leaks (#10056)
		this.bindings = $( this.bindings.not( element ).get() );
		this.focusable = $( this.focusable.not( element ).get() );
		this.hoverable = $( this.hoverable.not( element ).get() );
	},

	_delay: function( handler, delay ) {
		function handlerProxy() {
			return ( typeof handler === "string" ? instance[ handler ] : handler )
				.apply( instance, arguments );
		}
		var instance = this;
		return setTimeout( handlerProxy, delay || 0 );
	},

	_hoverable: function( element ) {
		this.hoverable = this.hoverable.add( element );
		this._on( element, {
			mouseenter: function( event ) {
				$( event.currentTarget ).addClass( "ui-state-hover" );
			},
			mouseleave: function( event ) {
				$( event.currentTarget ).removeClass( "ui-state-hover" );
			}
		});
	},

	_focusable: function( element ) {
		this.focusable = this.focusable.add( element );
		this._on( element, {
			focusin: function( event ) {
				$( event.currentTarget ).addClass( "ui-state-focus" );
			},
			focusout: function( event ) {
				$( event.currentTarget ).removeClass( "ui-state-focus" );
			}
		});
	},

	_trigger: function( type, event, data ) {
		var prop, orig,
			callback = this.options[ type ];

		data = data || {};
		event = $.Event( event );
		event.type = ( type === this.widgetEventPrefix ?
			type :
			this.widgetEventPrefix + type ).toLowerCase();
		// the original event may come from any element
		// so we need to reset the target on the new event
		event.target = this.element[ 0 ];

		// copy original event properties over to the new event
		orig = event.originalEvent;
		if ( orig ) {
			for ( prop in orig ) {
				if ( !( prop in event ) ) {
					event[ prop ] = orig[ prop ];
				}
			}
		}

		this.element.trigger( event, data );
		return !( $.isFunction( callback ) &&
			callback.apply( this.element[0], [ event ].concat( data ) ) === false ||
			event.isDefaultPrevented() );
	}
};

$.each( { show: "fadeIn", hide: "fadeOut" }, function( method, defaultEffect ) {
	$.Widget.prototype[ "_" + method ] = function( element, options, callback ) {
		if ( typeof options === "string" ) {
			options = { effect: options };
		}
		var hasOptions,
			effectName = !options ?
				method :
				options === true || typeof options === "number" ?
					defaultEffect :
					options.effect || defaultEffect;
		options = options || {};
		if ( typeof options === "number" ) {
			options = { duration: options };
		}
		hasOptions = !$.isEmptyObject( options );
		options.complete = callback;
		if ( options.delay ) {
			element.delay( options.delay );
		}
		if ( hasOptions && $.effects && $.effects.effect[ effectName ] ) {
			element[ method ]( options );
		} else if ( effectName !== method && element[ effectName ] ) {
			element[ effectName ]( options.duration, options.easing, callback );
		} else {
			element.queue(function( next ) {
				$( this )[ method ]();
				if ( callback ) {
					callback.call( element[ 0 ] );
				}
				next();
			});
		}
	};
});

var widget = $.widget;



}));
/*
 * jQuery Iframe Transport Plugin
 * https://github.com/blueimp/jQuery-File-Upload
 *
 * Copyright 2011, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */

/* global define, require, window, document */


;(function (factory) {
    'use strict';
    if (typeof define === 'function' && define.amd) {
        // Register as an anonymous AMD module:
        define(['jquery'], factory);
    } else if (typeof exports === 'object') {
        // Node/CommonJS:
        factory(require('jquery'));
    } else {
        // Browser globals:
        factory(window.jQuery);
    }
}(function ($) {
    'use strict';

    // Helper variable to create unique names for the transport iframes:
    var counter = 0;

    // The iframe transport accepts four additional options:
    // options.fileInput: a jQuery collection of file input fields
    // options.paramName: the parameter name for the file form data,
    //  overrides the name property of the file input field(s),
    //  can be a string or an array of strings.
    // options.formData: an array of objects with name and value properties,
    //  equivalent to the return data of .serializeArray(), e.g.:
    //  [{name: 'a', value: 1}, {name: 'b', value: 2}]
    // options.initialIframeSrc: the URL of the initial iframe src,
    //  by default set to "javascript:false;"
    $.ajaxTransport('iframe', function (options) {
        if (options.async) {
            // javascript:false as initial iframe src
            // prevents warning popups on HTTPS in IE6:
            /*jshint scripturl: true */
            var initialIframeSrc = options.initialIframeSrc || 'javascript:false;',
            /*jshint scripturl: false */
                form,
                iframe,
                addParamChar;
            return {
                send: function (_, completeCallback) {
                    form = $('<form style="display:none;"></form>');
                    form.attr('accept-charset', options.formAcceptCharset);
                    addParamChar = /\?/.test(options.url) ? '&' : '?';
                    // XDomainRequest only supports GET and POST:
                    if (options.type === 'DELETE') {
                        options.url = options.url + addParamChar + '_method=DELETE';
                        options.type = 'POST';
                    } else if (options.type === 'PUT') {
                        options.url = options.url + addParamChar + '_method=PUT';
                        options.type = 'POST';
                    } else if (options.type === 'PATCH') {
                        options.url = options.url + addParamChar + '_method=PATCH';
                        options.type = 'POST';
                    }
                    // IE versions below IE8 cannot set the name property of
                    // elements that have already been added to the DOM,
                    // so we set the name along with the iframe HTML markup:
                    counter += 1;
                    iframe = $(
                        '<iframe src="' + initialIframeSrc +
                            '" name="iframe-transport-' + counter + '"></iframe>'
                    ).bind('load', function () {
                        var fileInputClones,
                            paramNames = $.isArray(options.paramName) ?
                                    options.paramName : [options.paramName];
                        iframe
                            .unbind('load')
                            .bind('load', function () {
                                var response;
                                // Wrap in a try/catch block to catch exceptions thrown
                                // when trying to access cross-domain iframe contents:
                                try {
                                    response = iframe.contents();
                                    // Google Chrome and Firefox do not throw an
                                    // exception when calling iframe.contents() on
                                    // cross-domain requests, so we unify the response:
                                    if (!response.length || !response[0].firstChild) {
                                        throw new Error();
                                    }
                                } catch (e) {
                                    response = undefined;
                                }
                                // The complete callback returns the
                                // iframe content document as response object:
                                completeCallback(
                                    200,
                                    'success',
                                    {'iframe': response}
                                );
                                // Fix for IE endless progress bar activity bug
                                // (happens on form submits to iframe targets):
                                $('<iframe src="' + initialIframeSrc + '"></iframe>')
                                    .appendTo(form);
                                window.setTimeout(function () {
                                    // Removing the form in a setTimeout call
                                    // allows Chrome's developer tools to display
                                    // the response result
                                    form.remove();
                                }, 0);
                            });
                        form
                            .prop('target', iframe.prop('name'))
                            .prop('action', options.url)
                            .prop('method', options.type);
                        if (options.formData) {
                            $.each(options.formData, function (index, field) {
                                $('<input type="hidden"/>')
                                    .prop('name', field.name)
                                    .val(field.value)
                                    .appendTo(form);
                            });
                        }
                        if (options.fileInput && options.fileInput.length &&
                                options.type === 'POST') {
                            fileInputClones = options.fileInput.clone();
                            // Insert a clone for each file input field:
                            options.fileInput.after(function (index) {
                                return fileInputClones[index];
                            });
                            if (options.paramName) {
                                options.fileInput.each(function (index) {
                                    $(this).prop(
                                        'name',
                                        paramNames[index] || options.paramName
                                    );
                                });
                            }
                            // Appending the file input fields to the hidden form
                            // removes them from their original location:
                            form
                                .append(options.fileInput)
                                .prop('enctype', 'multipart/form-data')
                                // enctype must be set as encoding for IE:
                                .prop('encoding', 'multipart/form-data');
                            // Remove the HTML5 form attribute from the input(s):
                            options.fileInput.removeAttr('form');
                        }
                        form.submit();
                        // Insert the file input fields at their original location
                        // by replacing the clones with the originals:
                        if (fileInputClones && fileInputClones.length) {
                            options.fileInput.each(function (index, input) {
                                var clone = $(fileInputClones[index]);
                                // Restore the original name and form properties:
                                $(input)
                                    .prop('name', clone.prop('name'))
                                    .attr('form', clone.attr('form'));
                                clone.replaceWith(input);
                            });
                        }
                    });
                    form.append(iframe).appendTo(document.body);
                },
                abort: function () {
                    if (iframe) {
                        // javascript:false as iframe src aborts the request
                        // and prevents warning popups on HTTPS in IE6.
                        // concat is used to avoid the "Script URL" JSLint error:
                        iframe
                            .unbind('load')
                            .prop('src', initialIframeSrc);
                    }
                    if (form) {
                        form.remove();
                    }
                }
            };
        }
    });

    // The iframe transport returns the iframe content document as response.
    // The following adds converters from iframe to text, json, html, xml
    // and script.
    // Please note that the Content-Type for JSON responses has to be text/plain
    // or text/html, if the browser doesn't include application/json in the
    // Accept header, else IE will show a download dialog.
    // The Content-Type for XML responses on the other hand has to be always
    // application/xml or text/xml, so IE properly parses the XML response.
    // See also
    // https://github.com/blueimp/jQuery-File-Upload/wiki/Setup#content-type-negotiation
    $.ajaxSetup({
        converters: {
            'iframe text': function (iframe) {
                return iframe && $(iframe[0].body).text();
            },
            'iframe json': function (iframe) {
                return iframe && $.parseJSON($(iframe[0].body).text());
            },
            'iframe html': function (iframe) {
                return iframe && $(iframe[0].body).html();
            },
            'iframe xml': function (iframe) {
                var xmlDoc = iframe && iframe[0];
                return xmlDoc && $.isXMLDoc(xmlDoc) ? xmlDoc :
                        $.parseXML((xmlDoc.XMLDocument && xmlDoc.XMLDocument.xml) ||
                            $(xmlDoc.body).html());
            },
            'iframe script': function (iframe) {
                return iframe && $.globalEval($(iframe[0].body).text());
            }
        }
    });

}));
/*
 * jQuery File Upload Plugin
 * https://github.com/blueimp/jQuery-File-Upload
 *
 * Copyright 2010, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */

/* jshint nomen:false */
/* global define, require, window, document, location, Blob, FormData */


;(function (factory) {
    'use strict';
    if (typeof define === 'function' && define.amd) {
        // Register as an anonymous AMD module:
        define([
            'jquery',
            'jquery.ui.widget'
        ], factory);
    } else if (typeof exports === 'object') {
        // Node/CommonJS:
        factory(
            require('jquery'),
            require('./vendor/jquery.ui.widget')
        );
    } else {
        // Browser globals:
        factory(window.jQuery);
    }
}(function ($) {
    'use strict';

    // Detect file input support, based on
    // http://viljamis.com/blog/2012/file-upload-support-on-mobile/
    $.support.fileInput = !(new RegExp(
        // Handle devices which give false positives for the feature detection:
        '(Android (1\\.[0156]|2\\.[01]))' +
            '|(Windows Phone (OS 7|8\\.0))|(XBLWP)|(ZuneWP)|(WPDesktop)' +
            '|(w(eb)?OSBrowser)|(webOS)' +
            '|(Kindle/(1\\.0|2\\.[05]|3\\.0))'
    ).test(window.navigator.userAgent) ||
        // Feature detection for all other devices:
        $('<input type="file">').prop('disabled'));

    // The FileReader API is not actually used, but works as feature detection,
    // as some Safari versions (5?) support XHR file uploads via the FormData API,
    // but not non-multipart XHR file uploads.
    // window.XMLHttpRequestUpload is not available on IE10, so we check for
    // window.ProgressEvent instead to detect XHR2 file upload capability:
    $.support.xhrFileUpload = !!(window.ProgressEvent && window.FileReader);
    $.support.xhrFormDataFileUpload = !!window.FormData;

    // Detect support for Blob slicing (required for chunked uploads):
    $.support.blobSlice = window.Blob && (Blob.prototype.slice ||
        Blob.prototype.webkitSlice || Blob.prototype.mozSlice);

    // Helper function to create drag handlers for dragover/dragenter/dragleave:
    function getDragHandler(type) {
        var isDragOver = type === 'dragover';
        return function (e) {
            e.dataTransfer = e.originalEvent && e.originalEvent.dataTransfer;
            var dataTransfer = e.dataTransfer;
            if (dataTransfer && $.inArray('Files', dataTransfer.types) !== -1 &&
                    this._trigger(
                        type,
                        $.Event(type, {delegatedEvent: e})
                    ) !== false) {
                e.preventDefault();
                if (isDragOver) {
                    dataTransfer.dropEffect = 'copy';
                }
            }
        };
    }

    // The fileupload widget listens for change events on file input fields defined
    // via fileInput setting and paste or drop events of the given dropZone.
    // In addition to the default jQuery Widget methods, the fileupload widget
    // exposes the "add" and "send" methods, to add or directly send files using
    // the fileupload API.
    // By default, files added via file input selection, paste, drag & drop or
    // "add" method are uploaded immediately, but it is possible to override
    // the "add" callback option to queue file uploads.
    $.widget('blueimp.fileupload', {

        options: {
            // The drop target element(s), by the default the complete document.
            // Set to null to disable drag & drop support:
            dropZone: $(document),
            // The paste target element(s), by the default undefined.
            // Set to a DOM node or jQuery object to enable file pasting:
            pasteZone: undefined,
            // The file input field(s), that are listened to for change events.
            // If undefined, it is set to the file input fields inside
            // of the widget element on plugin initialization.
            // Set to null to disable the change listener.
            fileInput: undefined,
            // By default, the file input field is replaced with a clone after
            // each input field change event. This is required for iframe transport
            // queues and allows change events to be fired for the same file
            // selection, but can be disabled by setting the following option to false:
            replaceFileInput: true,
            // The parameter name for the file form data (the request argument name).
            // If undefined or empty, the name property of the file input field is
            // used, or "files[]" if the file input name property is also empty,
            // can be a string or an array of strings:
            paramName: undefined,
            // By default, each file of a selection is uploaded using an individual
            // request for XHR type uploads. Set to false to upload file
            // selections in one request each:
            singleFileUploads: true,
            // To limit the number of files uploaded with one XHR request,
            // set the following option to an integer greater than 0:
            limitMultiFileUploads: undefined,
            // The following option limits the number of files uploaded with one
            // XHR request to keep the request size under or equal to the defined
            // limit in bytes:
            limitMultiFileUploadSize: undefined,
            // Multipart file uploads add a number of bytes to each uploaded file,
            // therefore the following option adds an overhead for each file used
            // in the limitMultiFileUploadSize configuration:
            limitMultiFileUploadSizeOverhead: 512,
            // Set the following option to true to issue all file upload requests
            // in a sequential order:
            sequentialUploads: false,
            // To limit the number of concurrent uploads,
            // set the following option to an integer greater than 0:
            limitConcurrentUploads: undefined,
            // Set the following option to true to force iframe transport uploads:
            forceIframeTransport: false,
            // Set the following option to the location of a redirect url on the
            // origin server, for cross-domain iframe transport uploads:
            redirect: undefined,
            // The parameter name for the redirect url, sent as part of the form
            // data and set to 'redirect' if this option is empty:
            redirectParamName: undefined,
            // Set the following option to the location of a postMessage window,
            // to enable postMessage transport uploads:
            postMessage: undefined,
            // By default, XHR file uploads are sent as multipart/form-data.
            // The iframe transport is always using multipart/form-data.
            // Set to false to enable non-multipart XHR uploads:
            multipart: true,
            // To upload large files in smaller chunks, set the following option
            // to a preferred maximum chunk size. If set to 0, null or undefined,
            // or the browser does not support the required Blob API, files will
            // be uploaded as a whole.
            maxChunkSize: undefined,
            // When a non-multipart upload or a chunked multipart upload has been
            // aborted, this option can be used to resume the upload by setting
            // it to the size of the already uploaded bytes. This option is most
            // useful when modifying the options object inside of the "add" or
            // "send" callbacks, as the options are cloned for each file upload.
            uploadedBytes: undefined,
            // By default, failed (abort or error) file uploads are removed from the
            // global progress calculation. Set the following option to false to
            // prevent recalculating the global progress data:
            recalculateProgress: true,
            // Interval in milliseconds to calculate and trigger progress events:
            progressInterval: 100,
            // Interval in milliseconds to calculate progress bitrate:
            bitrateInterval: 500,
            // By default, uploads are started automatically when adding files:
            autoUpload: true,

            // Error and info messages:
            messages: {
                uploadedBytes: 'Uploaded bytes exceed file size'
            },

            // Translation function, gets the message key to be translated
            // and an object with context specific data as arguments:
            i18n: function (message, context) {
                message = this.messages[message] || message.toString();
                if (context) {
                    $.each(context, function (key, value) {
                        message = message.replace('{' + key + '}', value);
                    });
                }
                return message;
            },

            // Additional form data to be sent along with the file uploads can be set
            // using this option, which accepts an array of objects with name and
            // value properties, a function returning such an array, a FormData
            // object (for XHR file uploads), or a simple object.
            // The form of the first fileInput is given as parameter to the function:
            formData: function (form) {
                return form.serializeArray();
            },

            // The add callback is invoked as soon as files are added to the fileupload
            // widget (via file input selection, drag & drop, paste or add API call).
            // If the singleFileUploads option is enabled, this callback will be
            // called once for each file in the selection for XHR file uploads, else
            // once for each file selection.
            //
            // The upload starts when the submit method is invoked on the data parameter.
            // The data object contains a files property holding the added files
            // and allows you to override plugin options as well as define ajax settings.
            //
            // Listeners for this callback can also be bound the following way:
            // .bind('fileuploadadd', func);
            //
            // data.submit() returns a Promise object and allows to attach additional
            // handlers using jQuery's Deferred callbacks:
            // data.submit().done(func).fail(func).always(func);
            add: function (e, data) {
                if (e.isDefaultPrevented()) {
                    return false;
                }
                if (data.autoUpload || (data.autoUpload !== false &&
                        $(this).fileupload('option', 'autoUpload'))) {
                    data.process().done(function () {
                        data.submit();
                    });
                }
            },

            // Other callbacks:

            // Callback for the submit event of each file upload:
            // submit: function (e, data) {}, // .bind('fileuploadsubmit', func);

            // Callback for the start of each file upload request:
            // send: function (e, data) {}, // .bind('fileuploadsend', func);

            // Callback for successful uploads:
            // done: function (e, data) {}, // .bind('fileuploaddone', func);

            // Callback for failed (abort or error) uploads:
            // fail: function (e, data) {}, // .bind('fileuploadfail', func);

            // Callback for completed (success, abort or error) requests:
            // always: function (e, data) {}, // .bind('fileuploadalways', func);

            // Callback for upload progress events:
            // progress: function (e, data) {}, // .bind('fileuploadprogress', func);

            // Callback for global upload progress events:
            // progressall: function (e, data) {}, // .bind('fileuploadprogressall', func);

            // Callback for uploads start, equivalent to the global ajaxStart event:
            // start: function (e) {}, // .bind('fileuploadstart', func);

            // Callback for uploads stop, equivalent to the global ajaxStop event:
            // stop: function (e) {}, // .bind('fileuploadstop', func);

            // Callback for change events of the fileInput(s):
            // change: function (e, data) {}, // .bind('fileuploadchange', func);

            // Callback for paste events to the pasteZone(s):
            // paste: function (e, data) {}, // .bind('fileuploadpaste', func);

            // Callback for drop events of the dropZone(s):
            // drop: function (e, data) {}, // .bind('fileuploaddrop', func);

            // Callback for dragover events of the dropZone(s):
            // dragover: function (e) {}, // .bind('fileuploaddragover', func);

            // Callback for the start of each chunk upload request:
            // chunksend: function (e, data) {}, // .bind('fileuploadchunksend', func);

            // Callback for successful chunk uploads:
            // chunkdone: function (e, data) {}, // .bind('fileuploadchunkdone', func);

            // Callback for failed (abort or error) chunk uploads:
            // chunkfail: function (e, data) {}, // .bind('fileuploadchunkfail', func);

            // Callback for completed (success, abort or error) chunk upload requests:
            // chunkalways: function (e, data) {}, // .bind('fileuploadchunkalways', func);

            // The plugin options are used as settings object for the ajax calls.
            // The following are jQuery ajax settings required for the file uploads:
            processData: false,
            contentType: false,
            cache: false,
            timeout: 0
        },

        // A list of options that require reinitializing event listeners and/or
        // special initialization code:
        _specialOptions: [
            'fileInput',
            'dropZone',
            'pasteZone',
            'multipart',
            'forceIframeTransport'
        ],

        _blobSlice: $.support.blobSlice && function () {
            var slice = this.slice || this.webkitSlice || this.mozSlice;
            return slice.apply(this, arguments);
        },

        _BitrateTimer: function () {
            this.timestamp = ((Date.now) ? Date.now() : (new Date()).getTime());
            this.loaded = 0;
            this.bitrate = 0;
            this.getBitrate = function (now, loaded, interval) {
                var timeDiff = now - this.timestamp;
                if (!this.bitrate || !interval || timeDiff > interval) {
                    this.bitrate = (loaded - this.loaded) * (1000 / timeDiff) * 8;
                    this.loaded = loaded;
                    this.timestamp = now;
                }
                return this.bitrate;
            };
        },

        _isXHRUpload: function (options) {
            return !options.forceIframeTransport &&
                ((!options.multipart && $.support.xhrFileUpload) ||
                $.support.xhrFormDataFileUpload);
        },

        _getFormData: function (options) {
            var formData;
            if ($.type(options.formData) === 'function') {
                return options.formData(options.form);
            }
            if ($.isArray(options.formData)) {
                return options.formData;
            }
            if ($.type(options.formData) === 'object') {
                formData = [];
                $.each(options.formData, function (name, value) {
                    formData.push({name: name, value: value});
                });
                return formData;
            }
            return [];
        },

        _getTotal: function (files) {
            var total = 0;
            $.each(files, function (index, file) {
                total += file.size || 1;
            });
            return total;
        },

        _initProgressObject: function (obj) {
            var progress = {
                loaded: 0,
                total: 0,
                bitrate: 0
            };
            if (obj._progress) {
                $.extend(obj._progress, progress);
            } else {
                obj._progress = progress;
            }
        },

        _initResponseObject: function (obj) {
            var prop;
            if (obj._response) {
                for (prop in obj._response) {
                    if (obj._response.hasOwnProperty(prop)) {
                        delete obj._response[prop];
                    }
                }
            } else {
                obj._response = {};
            }
        },

        _onProgress: function (e, data) {
            if (e.lengthComputable) {
                var now = ((Date.now) ? Date.now() : (new Date()).getTime()),
                    loaded;
                if (data._time && data.progressInterval &&
                        (now - data._time < data.progressInterval) &&
                        e.loaded !== e.total) {
                    return;
                }
                data._time = now;
                loaded = Math.floor(
                    e.loaded / e.total * (data.chunkSize || data._progress.total)
                ) + (data.uploadedBytes || 0);
                // Add the difference from the previously loaded state
                // to the global loaded counter:
                this._progress.loaded += (loaded - data._progress.loaded);
                this._progress.bitrate = this._bitrateTimer.getBitrate(
                    now,
                    this._progress.loaded,
                    data.bitrateInterval
                );
                data._progress.loaded = data.loaded = loaded;
                data._progress.bitrate = data.bitrate = data._bitrateTimer.getBitrate(
                    now,
                    loaded,
                    data.bitrateInterval
                );
                // Trigger a custom progress event with a total data property set
                // to the file size(s) of the current upload and a loaded data
                // property calculated accordingly:
                this._trigger(
                    'progress',
                    $.Event('progress', {delegatedEvent: e}),
                    data
                );
                // Trigger a global progress event for all current file uploads,
                // including ajax calls queued for sequential file uploads:
                this._trigger(
                    'progressall',
                    $.Event('progressall', {delegatedEvent: e}),
                    this._progress
                );
            }
        },

        _initProgressListener: function (options) {
            var that = this,
                xhr = options.xhr ? options.xhr() : $.ajaxSettings.xhr();
            // Accesss to the native XHR object is required to add event listeners
            // for the upload progress event:
            if (xhr.upload) {
                $(xhr.upload).bind('progress', function (e) {
                    var oe = e.originalEvent;
                    // Make sure the progress event properties get copied over:
                    e.lengthComputable = oe.lengthComputable;
                    e.loaded = oe.loaded;
                    e.total = oe.total;
                    that._onProgress(e, options);
                });
                options.xhr = function () {
                    return xhr;
                };
            }
        },

        _isInstanceOf: function (type, obj) {
            // Cross-frame instanceof check
            return Object.prototype.toString.call(obj) === '[object ' + type + ']';
        },

        _initXHRData: function (options) {
            var that = this,
                formData,
                file = options.files[0],
                // Ignore non-multipart setting if not supported:
                multipart = options.multipart || !$.support.xhrFileUpload,
                paramName = $.type(options.paramName) === 'array' ?
                    options.paramName[0] : options.paramName;
            options.headers = $.extend({}, options.headers);
            if (options.contentRange) {
                options.headers['Content-Range'] = options.contentRange;
            }
            if (!multipart || options.blob || !this._isInstanceOf('File', file)) {
                options.headers['Content-Disposition'] = 'attachment; filename="' +
                    encodeURI(file.name) + '"';
            }
            if (!multipart) {
                options.contentType = file.type || 'application/octet-stream';
                options.data = options.blob || file;
            } else if ($.support.xhrFormDataFileUpload) {
                if (options.postMessage) {
                    // window.postMessage does not allow sending FormData
                    // objects, so we just add the File/Blob objects to
                    // the formData array and let the postMessage window
                    // create the FormData object out of this array:
                    formData = this._getFormData(options);
                    if (options.blob) {
                        formData.push({
                            name: paramName,
                            value: options.blob
                        });
                    } else {
                        $.each(options.files, function (index, file) {
                            formData.push({
                                name: ($.type(options.paramName) === 'array' &&
                                    options.paramName[index]) || paramName,
                                value: file
                            });
                        });
                    }
                } else {
                    if (that._isInstanceOf('FormData', options.formData)) {
                        formData = options.formData;
                    } else {
                        formData = new FormData();
                        $.each(this._getFormData(options), function (index, field) {
                            formData.append(field.name, field.value);
                        });
                    }
                    if (options.blob) {
                        formData.append(paramName, options.blob, file.name);
                    } else {
                        $.each(options.files, function (index, file) {
                            // This check allows the tests to run with
                            // dummy objects:
                            if (that._isInstanceOf('File', file) ||
                                    that._isInstanceOf('Blob', file)) {
                                formData.append(
                                    ($.type(options.paramName) === 'array' &&
                                        options.paramName[index]) || paramName,
                                    file,
                                    file.uploadName || file.name
                                );
                            }
                        });
                    }
                }
                options.data = formData;
            }
            // Blob reference is not needed anymore, free memory:
            options.blob = null;
        },

        _initIframeSettings: function (options) {
            var targetHost = $('<a></a>').prop('href', options.url).prop('host');
            // Setting the dataType to iframe enables the iframe transport:
            options.dataType = 'iframe ' + (options.dataType || '');
            // The iframe transport accepts a serialized array as form data:
            options.formData = this._getFormData(options);
            // Add redirect url to form data on cross-domain uploads:
            if (options.redirect && targetHost && targetHost !== location.host) {
                options.formData.push({
                    name: options.redirectParamName || 'redirect',
                    value: options.redirect
                });
            }
        },

        _initDataSettings: function (options) {
            if (this._isXHRUpload(options)) {
                if (!this._chunkedUpload(options, true)) {
                    if (!options.data) {
                        this._initXHRData(options);
                    }
                    this._initProgressListener(options);
                }
                if (options.postMessage) {
                    // Setting the dataType to postmessage enables the
                    // postMessage transport:
                    options.dataType = 'postmessage ' + (options.dataType || '');
                }
            } else {
                this._initIframeSettings(options);
            }
        },

        _getParamName: function (options) {
            var fileInput = $(options.fileInput),
                paramName = options.paramName;
            if (!paramName) {
                paramName = [];
                fileInput.each(function () {
                    var input = $(this),
                        name = input.prop('name') || 'files[]',
                        i = (input.prop('files') || [1]).length;
                    while (i) {
                        paramName.push(name);
                        i -= 1;
                    }
                });
                if (!paramName.length) {
                    paramName = [fileInput.prop('name') || 'files[]'];
                }
            } else if (!$.isArray(paramName)) {
                paramName = [paramName];
            }
            return paramName;
        },

        _initFormSettings: function (options) {
            // Retrieve missing options from the input field and the
            // associated form, if available:
            if (!options.form || !options.form.length) {
                options.form = $(options.fileInput.prop('form'));
                // If the given file input doesn't have an associated form,
                // use the default widget file input's form:
                if (!options.form.length) {
                    options.form = $(this.options.fileInput.prop('form'));
                }
            }
            options.paramName = this._getParamName(options);
            if (!options.url) {
                options.url = options.form.prop('action') || location.href;
            }
            // The HTTP request method must be "POST" or "PUT":
            options.type = (options.type ||
                ($.type(options.form.prop('method')) === 'string' &&
                    options.form.prop('method')) || ''
                ).toUpperCase();
            if (options.type !== 'POST' && options.type !== 'PUT' &&
                    options.type !== 'PATCH') {
                options.type = 'POST';
            }
            if (!options.formAcceptCharset) {
                options.formAcceptCharset = options.form.attr('accept-charset');
            }
        },

        _getAJAXSettings: function (data) {
            var options = $.extend({}, this.options, data);
            this._initFormSettings(options);
            this._initDataSettings(options);
            return options;
        },

        // jQuery 1.6 doesn't provide .state(),
        // while jQuery 1.8+ removed .isRejected() and .isResolved():
        _getDeferredState: function (deferred) {
            if (deferred.state) {
                return deferred.state();
            }
            if (deferred.isResolved()) {
                return 'resolved';
            }
            if (deferred.isRejected()) {
                return 'rejected';
            }
            return 'pending';
        },

        // Maps jqXHR callbacks to the equivalent
        // methods of the given Promise object:
        _enhancePromise: function (promise) {
            promise.success = promise.done;
            promise.error = promise.fail;
            promise.complete = promise.always;
            return promise;
        },

        // Creates and returns a Promise object enhanced with
        // the jqXHR methods abort, success, error and complete:
        _getXHRPromise: function (resolveOrReject, context, args) {
            var dfd = $.Deferred(),
                promise = dfd.promise();
            context = context || this.options.context || promise;
            if (resolveOrReject === true) {
                dfd.resolveWith(context, args);
            } else if (resolveOrReject === false) {
                dfd.rejectWith(context, args);
            }
            promise.abort = dfd.promise;
            return this._enhancePromise(promise);
        },

        // Adds convenience methods to the data callback argument:
        _addConvenienceMethods: function (e, data) {
            var that = this,
                getPromise = function (args) {
                    return $.Deferred().resolveWith(that, args).promise();
                };
            data.process = function (resolveFunc, rejectFunc) {
                if (resolveFunc || rejectFunc) {
                    data._processQueue = this._processQueue =
                        (this._processQueue || getPromise([this])).then(
                            function () {
                                if (data.errorThrown) {
                                    return $.Deferred()
                                        .rejectWith(that, [data]).promise();
                                }
                                return getPromise(arguments);
                            }
                        ).then(resolveFunc, rejectFunc);
                }
                return this._processQueue || getPromise([this]);
            };
            data.submit = function () {
                if (this.state() !== 'pending') {
                    data.jqXHR = this.jqXHR =
                        (that._trigger(
                            'submit',
                            $.Event('submit', {delegatedEvent: e}),
                            this
                        ) !== false) && that._onSend(e, this);
                }
                return this.jqXHR || that._getXHRPromise();
            };
            data.abort = function () {
                if (this.jqXHR) {
                    return this.jqXHR.abort();
                }
                this.errorThrown = 'abort';
                that._trigger('fail', null, this);
                return that._getXHRPromise(false);
            };
            data.state = function () {
                if (this.jqXHR) {
                    return that._getDeferredState(this.jqXHR);
                }
                if (this._processQueue) {
                    return that._getDeferredState(this._processQueue);
                }
            };
            data.processing = function () {
                return !this.jqXHR && this._processQueue && that
                    ._getDeferredState(this._processQueue) === 'pending';
            };
            data.progress = function () {
                return this._progress;
            };
            data.response = function () {
                return this._response;
            };
        },

        // Parses the Range header from the server response
        // and returns the uploaded bytes:
        _getUploadedBytes: function (jqXHR) {
            var range = jqXHR.getResponseHeader('Range'),
                parts = range && range.split('-'),
                upperBytesPos = parts && parts.length > 1 &&
                    parseInt(parts[1], 10);
            return upperBytesPos && upperBytesPos + 1;
        },

        // Uploads a file in multiple, sequential requests
        // by splitting the file up in multiple blob chunks.
        // If the second parameter is true, only tests if the file
        // should be uploaded in chunks, but does not invoke any
        // upload requests:
        _chunkedUpload: function (options, testOnly) {
            options.uploadedBytes = options.uploadedBytes || 0;
            var that = this,
                file = options.files[0],
                fs = file.size,
                ub = options.uploadedBytes,
                mcs = options.maxChunkSize || fs,
                slice = this._blobSlice,
                dfd = $.Deferred(),
                promise = dfd.promise(),
                jqXHR,
                upload;
            if (!(this._isXHRUpload(options) && slice && (ub || mcs < fs)) ||
                    options.data) {
                return false;
            }
            if (testOnly) {
                return true;
            }
            if (ub >= fs) {
                file.error = options.i18n('uploadedBytes');
                return this._getXHRPromise(
                    false,
                    options.context,
                    [null, 'error', file.error]
                );
            }
            // The chunk upload method:
            upload = function () {
                // Clone the options object for each chunk upload:
                var o = $.extend({}, options),
                    currentLoaded = o._progress.loaded;
                o.blob = slice.call(
                    file,
                    ub,
                    ub + mcs,
                    file.type
                );
                // Store the current chunk size, as the blob itself
                // will be dereferenced after data processing:
                o.chunkSize = o.blob.size;
                // Expose the chunk bytes position range:
                o.contentRange = 'bytes ' + ub + '-' +
                    (ub + o.chunkSize - 1) + '/' + fs;
                // Process the upload data (the blob and potential form data):
                that._initXHRData(o);
                // Add progress listeners for this chunk upload:
                that._initProgressListener(o);
                jqXHR = ((that._trigger('chunksend', null, o) !== false && $.ajax(o)) ||
                        that._getXHRPromise(false, o.context))
                    .done(function (result, textStatus, jqXHR) {
                        ub = that._getUploadedBytes(jqXHR) ||
                            (ub + o.chunkSize);
                        // Create a progress event if no final progress event
                        // with loaded equaling total has been triggered
                        // for this chunk:
                        if (currentLoaded + o.chunkSize - o._progress.loaded) {
                            that._onProgress($.Event('progress', {
                                lengthComputable: true,
                                loaded: ub - o.uploadedBytes,
                                total: ub - o.uploadedBytes
                            }), o);
                        }
                        options.uploadedBytes = o.uploadedBytes = ub;
                        o.result = result;
                        o.textStatus = textStatus;
                        o.jqXHR = jqXHR;
                        that._trigger('chunkdone', null, o);
                        that._trigger('chunkalways', null, o);
                        if (ub < fs) {
                            // File upload not yet complete,
                            // continue with the next chunk:
                            upload();
                        } else {
                            dfd.resolveWith(
                                o.context,
                                [result, textStatus, jqXHR]
                            );
                        }
                    })
                    .fail(function (jqXHR, textStatus, errorThrown) {
                        o.jqXHR = jqXHR;
                        o.textStatus = textStatus;
                        o.errorThrown = errorThrown;
                        that._trigger('chunkfail', null, o);
                        that._trigger('chunkalways', null, o);
                        dfd.rejectWith(
                            o.context,
                            [jqXHR, textStatus, errorThrown]
                        );
                    });
            };
            this._enhancePromise(promise);
            promise.abort = function () {
                return jqXHR.abort();
            };
            upload();
            return promise;
        },

        _beforeSend: function (e, data) {
            if (this._active === 0) {
                // the start callback is triggered when an upload starts
                // and no other uploads are currently running,
                // equivalent to the global ajaxStart event:
                this._trigger('start');
                // Set timer for global bitrate progress calculation:
                this._bitrateTimer = new this._BitrateTimer();
                // Reset the global progress values:
                this._progress.loaded = this._progress.total = 0;
                this._progress.bitrate = 0;
            }
            // Make sure the container objects for the .response() and
            // .progress() methods on the data object are available
            // and reset to their initial state:
            this._initResponseObject(data);
            this._initProgressObject(data);
            data._progress.loaded = data.loaded = data.uploadedBytes || 0;
            data._progress.total = data.total = this._getTotal(data.files) || 1;
            data._progress.bitrate = data.bitrate = 0;
            this._active += 1;
            // Initialize the global progress values:
            this._progress.loaded += data.loaded;
            this._progress.total += data.total;
        },

        _onDone: function (result, textStatus, jqXHR, options) {
            var total = options._progress.total,
                response = options._response;
            if (options._progress.loaded < total) {
                // Create a progress event if no final progress event
                // with loaded equaling total has been triggered:
                this._onProgress($.Event('progress', {
                    lengthComputable: true,
                    loaded: total,
                    total: total
                }), options);
            }
            response.result = options.result = result;
            response.textStatus = options.textStatus = textStatus;
            response.jqXHR = options.jqXHR = jqXHR;
            this._trigger('done', null, options);
        },

        _onFail: function (jqXHR, textStatus, errorThrown, options) {
            var response = options._response;
            if (options.recalculateProgress) {
                // Remove the failed (error or abort) file upload from
                // the global progress calculation:
                this._progress.loaded -= options._progress.loaded;
                this._progress.total -= options._progress.total;
            }
            response.jqXHR = options.jqXHR = jqXHR;
            response.textStatus = options.textStatus = textStatus;
            response.errorThrown = options.errorThrown = errorThrown;
            this._trigger('fail', null, options);
        },

        _onAlways: function (jqXHRorResult, textStatus, jqXHRorError, options) {
            // jqXHRorResult, textStatus and jqXHRorError are added to the
            // options object via done and fail callbacks
            this._trigger('always', null, options);
        },

        _onSend: function (e, data) {
            if (!data.submit) {
                this._addConvenienceMethods(e, data);
            }
            var that = this,
                jqXHR,
                aborted,
                slot,
                pipe,
                options = that._getAJAXSettings(data),
                send = function () {
                    that._sending += 1;
                    // Set timer for bitrate progress calculation:
                    options._bitrateTimer = new that._BitrateTimer();
                    jqXHR = jqXHR || (
                        ((aborted || that._trigger(
                            'send',
                            $.Event('send', {delegatedEvent: e}),
                            options
                        ) === false) &&
                        that._getXHRPromise(false, options.context, aborted)) ||
                        that._chunkedUpload(options) || $.ajax(options)
                    ).done(function (result, textStatus, jqXHR) {
                        that._onDone(result, textStatus, jqXHR, options);
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                        that._onFail(jqXHR, textStatus, errorThrown, options);
                    }).always(function (jqXHRorResult, textStatus, jqXHRorError) {
                        that._onAlways(
                            jqXHRorResult,
                            textStatus,
                            jqXHRorError,
                            options
                        );
                        that._sending -= 1;
                        that._active -= 1;
                        if (options.limitConcurrentUploads &&
                                options.limitConcurrentUploads > that._sending) {
                            // Start the next queued upload,
                            // that has not been aborted:
                            var nextSlot = that._slots.shift();
                            while (nextSlot) {
                                if (that._getDeferredState(nextSlot) === 'pending') {
                                    nextSlot.resolve();
                                    break;
                                }
                                nextSlot = that._slots.shift();
                            }
                        }
                        if (that._active === 0) {
                            // The stop callback is triggered when all uploads have
                            // been completed, equivalent to the global ajaxStop event:
                            that._trigger('stop');
                        }
                    });
                    return jqXHR;
                };
            this._beforeSend(e, options);
            if (this.options.sequentialUploads ||
                    (this.options.limitConcurrentUploads &&
                    this.options.limitConcurrentUploads <= this._sending)) {
                if (this.options.limitConcurrentUploads > 1) {
                    slot = $.Deferred();
                    this._slots.push(slot);
                    pipe = slot.then(send);
                } else {
                    this._sequence = this._sequence.then(send, send);
                    pipe = this._sequence;
                }
                // Return the piped Promise object, enhanced with an abort method,
                // which is delegated to the jqXHR object of the current upload,
                // and jqXHR callbacks mapped to the equivalent Promise methods:
                pipe.abort = function () {
                    aborted = [undefined, 'abort', 'abort'];
                    if (!jqXHR) {
                        if (slot) {
                            slot.rejectWith(options.context, aborted);
                        }
                        return send();
                    }
                    return jqXHR.abort();
                };
                return this._enhancePromise(pipe);
            }
            return send();
        },

        _onAdd: function (e, data) {
            var that = this,
                result = true,
                options = $.extend({}, this.options, data),
                files = data.files,
                filesLength = files.length,
                limit = options.limitMultiFileUploads,
                limitSize = options.limitMultiFileUploadSize,
                overhead = options.limitMultiFileUploadSizeOverhead,
                batchSize = 0,
                paramName = this._getParamName(options),
                paramNameSet,
                paramNameSlice,
                fileSet,
                i,
                j = 0;
            if (!filesLength) {
                return false;
            }
            if (limitSize && files[0].size === undefined) {
                limitSize = undefined;
            }
            if (!(options.singleFileUploads || limit || limitSize) ||
                    !this._isXHRUpload(options)) {
                fileSet = [files];
                paramNameSet = [paramName];
            } else if (!(options.singleFileUploads || limitSize) && limit) {
                fileSet = [];
                paramNameSet = [];
                for (i = 0; i < filesLength; i += limit) {
                    fileSet.push(files.slice(i, i + limit));
                    paramNameSlice = paramName.slice(i, i + limit);
                    if (!paramNameSlice.length) {
                        paramNameSlice = paramName;
                    }
                    paramNameSet.push(paramNameSlice);
                }
            } else if (!options.singleFileUploads && limitSize) {
                fileSet = [];
                paramNameSet = [];
                for (i = 0; i < filesLength; i = i + 1) {
                    batchSize += files[i].size + overhead;
                    if (i + 1 === filesLength ||
                            ((batchSize + files[i + 1].size + overhead) > limitSize) ||
                            (limit && i + 1 - j >= limit)) {
                        fileSet.push(files.slice(j, i + 1));
                        paramNameSlice = paramName.slice(j, i + 1);
                        if (!paramNameSlice.length) {
                            paramNameSlice = paramName;
                        }
                        paramNameSet.push(paramNameSlice);
                        j = i + 1;
                        batchSize = 0;
                    }
                }
            } else {
                paramNameSet = paramName;
            }
            data.originalFiles = files;
            $.each(fileSet || files, function (index, element) {
                var newData = $.extend({}, data);
                newData.files = fileSet ? element : [element];
                newData.paramName = paramNameSet[index];
                that._initResponseObject(newData);
                that._initProgressObject(newData);
                that._addConvenienceMethods(e, newData);
                result = that._trigger(
                    'add',
                    $.Event('add', {delegatedEvent: e}),
                    newData
                );
                return result;
            });
            return result;
        },

        _replaceFileInput: function (data) {
            var input = data.fileInput,
                inputClone = input.clone(true),
                restoreFocus = input.is(document.activeElement);
            // Add a reference for the new cloned file input to the data argument:
            data.fileInputClone = inputClone;
            $('<form></form>').append(inputClone)[0].reset();
            // Detaching allows to insert the fileInput on another form
            // without loosing the file input value:
            input.after(inputClone).detach();
            // If the fileInput had focus before it was detached,
            // restore focus to the inputClone.
            if (restoreFocus) {
                inputClone.focus();
            }
            // Avoid memory leaks with the detached file input:
            $.cleanData(input.unbind('remove'));
            // Replace the original file input element in the fileInput
            // elements set with the clone, which has been copied including
            // event handlers:
            this.options.fileInput = this.options.fileInput.map(function (i, el) {
                if (el === input[0]) {
                    return inputClone[0];
                }
                return el;
            });
            // If the widget has been initialized on the file input itself,
            // override this.element with the file input clone:
            if (input[0] === this.element[0]) {
                this.element = inputClone;
            }
        },

        _handleFileTreeEntry: function (entry, path) {
            var that = this,
                dfd = $.Deferred(),
                errorHandler = function (e) {
                    if (e && !e.entry) {
                        e.entry = entry;
                    }
                    // Since $.when returns immediately if one
                    // Deferred is rejected, we use resolve instead.
                    // This allows valid files and invalid items
                    // to be returned together in one set:
                    dfd.resolve([e]);
                },
                successHandler = function (entries) {
                    that._handleFileTreeEntries(
                        entries,
                        path + entry.name + '/'
                    ).done(function (files) {
                        dfd.resolve(files);
                    }).fail(errorHandler);
                },
                readEntries = function () {
                    dirReader.readEntries(function (results) {
                        if (!results.length) {
                            successHandler(entries);
                        } else {
                            entries = entries.concat(results);
                            readEntries();
                        }
                    }, errorHandler);
                },
                dirReader, entries = [];
            path = path || '';
            if (entry.isFile) {
                if (entry._file) {
                    // Workaround for Chrome bug #149735
                    entry._file.relativePath = path;
                    dfd.resolve(entry._file);
                } else {
                    entry.file(function (file) {
                        file.relativePath = path;
                        dfd.resolve(file);
                    }, errorHandler);
                }
            } else if (entry.isDirectory) {
                dirReader = entry.createReader();
                readEntries();
            } else {
                // Return an empy list for file system items
                // other than files or directories:
                dfd.resolve([]);
            }
            return dfd.promise();
        },

        _handleFileTreeEntries: function (entries, path) {
            var that = this;
            return $.when.apply(
                $,
                $.map(entries, function (entry) {
                    return that._handleFileTreeEntry(entry, path);
                })
            ).then(function () {
                return Array.prototype.concat.apply(
                    [],
                    arguments
                );
            });
        },

        _getDroppedFiles: function (dataTransfer) {
            dataTransfer = dataTransfer || {};
            var items = dataTransfer.items;
            if (items && items.length && (items[0].webkitGetAsEntry ||
                    items[0].getAsEntry)) {
                return this._handleFileTreeEntries(
                    $.map(items, function (item) {
                        var entry;
                        if (item.webkitGetAsEntry) {
                            entry = item.webkitGetAsEntry();
                            if (entry) {
                                // Workaround for Chrome bug #149735:
                                entry._file = item.getAsFile();
                            }
                            return entry;
                        }
                        return item.getAsEntry();
                    })
                );
            }
            return $.Deferred().resolve(
                $.makeArray(dataTransfer.files)
            ).promise();
        },

        _getSingleFileInputFiles: function (fileInput) {
            fileInput = $(fileInput);
            var entries = fileInput.prop('webkitEntries') ||
                    fileInput.prop('entries'),
                files,
                value;
            if (entries && entries.length) {
                return this._handleFileTreeEntries(entries);
            }
            files = $.makeArray(fileInput.prop('files'));
            if (!files.length) {
                value = fileInput.prop('value');
                if (!value) {
                    return $.Deferred().resolve([]).promise();
                }
                // If the files property is not available, the browser does not
                // support the File API and we add a pseudo File object with
                // the input value as name with path information removed:
                files = [{name: value.replace(/^.*\\/, '')}];
            } else if (files[0].name === undefined && files[0].fileName) {
                // File normalization for Safari 4 and Firefox 3:
                $.each(files, function (index, file) {
                    file.name = file.fileName;
                    file.size = file.fileSize;
                });
            }
            return $.Deferred().resolve(files).promise();
        },

        _getFileInputFiles: function (fileInput) {
            if (!(fileInput instanceof $) || fileInput.length === 1) {
                return this._getSingleFileInputFiles(fileInput);
            }
            return $.when.apply(
                $,
                $.map(fileInput, this._getSingleFileInputFiles)
            ).then(function () {
                return Array.prototype.concat.apply(
                    [],
                    arguments
                );
            });
        },

        _onChange: function (e) {
            var that = this,
                data = {
                    fileInput: $(e.target),
                    form: $(e.target.form)
                };
            this._getFileInputFiles(data.fileInput).always(function (files) {
                data.files = files;
                if (that.options.replaceFileInput) {
                    that._replaceFileInput(data);
                }
                if (that._trigger(
                        'change',
                        $.Event('change', {delegatedEvent: e}),
                        data
                    ) !== false) {
                    that._onAdd(e, data);
                }
            });
        },

        _onPaste: function (e) {
            var items = e.originalEvent && e.originalEvent.clipboardData &&
                    e.originalEvent.clipboardData.items,
                data = {files: []};
            if (items && items.length) {
                $.each(items, function (index, item) {
                    var file = item.getAsFile && item.getAsFile();
                    if (file) {
                        data.files.push(file);
                    }
                });
                if (this._trigger(
                        'paste',
                        $.Event('paste', {delegatedEvent: e}),
                        data
                    ) !== false) {
                    this._onAdd(e, data);
                }
            }
        },

        _onDrop: function (e) {
            e.dataTransfer = e.originalEvent && e.originalEvent.dataTransfer;
            var that = this,
                dataTransfer = e.dataTransfer,
                data = {};
            if (dataTransfer && dataTransfer.files && dataTransfer.files.length) {
                e.preventDefault();
                this._getDroppedFiles(dataTransfer).always(function (files) {
                    data.files = files;
                    if (that._trigger(
                            'drop',
                            $.Event('drop', {delegatedEvent: e}),
                            data
                        ) !== false) {
                        that._onAdd(e, data);
                    }
                });
            }
        },

        _onDragOver: getDragHandler('dragover'),

        _onDragEnter: getDragHandler('dragenter'),

        _onDragLeave: getDragHandler('dragleave'),

        _initEventHandlers: function () {
            if (this._isXHRUpload(this.options)) {
                this._on(this.options.dropZone, {
                    dragover: this._onDragOver,
                    drop: this._onDrop,
                    // event.preventDefault() on dragenter is required for IE10+:
                    dragenter: this._onDragEnter,
                    // dragleave is not required, but added for completeness:
                    dragleave: this._onDragLeave
                });
                this._on(this.options.pasteZone, {
                    paste: this._onPaste
                });
            }
            if ($.support.fileInput) {
                this._on(this.options.fileInput, {
                    change: this._onChange
                });
            }
        },

        _destroyEventHandlers: function () {
            this._off(this.options.dropZone, 'dragenter dragleave dragover drop');
            this._off(this.options.pasteZone, 'paste');
            this._off(this.options.fileInput, 'change');
        },

        _setOption: function (key, value) {
            var reinit = $.inArray(key, this._specialOptions) !== -1;
            if (reinit) {
                this._destroyEventHandlers();
            }
            this._super(key, value);
            if (reinit) {
                this._initSpecialOptions();
                this._initEventHandlers();
            }
        },

        _initSpecialOptions: function () {
            var options = this.options;
            if (options.fileInput === undefined) {
                options.fileInput = this.element.is('input[type="file"]') ?
                        this.element : this.element.find('input[type="file"]');
            } else if (!(options.fileInput instanceof $)) {
                options.fileInput = $(options.fileInput);
            }
            if (!(options.dropZone instanceof $)) {
                options.dropZone = $(options.dropZone);
            }
            if (!(options.pasteZone instanceof $)) {
                options.pasteZone = $(options.pasteZone);
            }
        },

        _getRegExp: function (str) {
            var parts = str.split('/'),
                modifiers = parts.pop();
            parts.shift();
            return new RegExp(parts.join('/'), modifiers);
        },

        _isRegExpOption: function (key, value) {
            return key !== 'url' && $.type(value) === 'string' &&
                /^\/.*\/[igm]{0,3}$/.test(value);
        },

        _initDataAttributes: function () {
            var that = this,
                options = this.options,
                data = this.element.data();
            // Initialize options set via HTML5 data-attributes:
            $.each(
                this.element[0].attributes,
                function (index, attr) {
                    var key = attr.name.toLowerCase(),
                        value;
                    if (/^data-/.test(key)) {
                        // Convert hyphen-ated key to camelCase:
                        key = key.slice(5).replace(/-[a-z]/g, function (str) {
                            return str.charAt(1).toUpperCase();
                        });
                        value = data[key];
                        if (that._isRegExpOption(key, value)) {
                            value = that._getRegExp(value);
                        }
                        options[key] = value;
                    }
                }
            );
        },

        _create: function () {
            this._initDataAttributes();
            this._initSpecialOptions();
            this._slots = [];
            this._sequence = this._getXHRPromise(true);
            this._sending = this._active = 0;
            this._initProgressObject(this);
            this._initEventHandlers();
        },

        // This method is exposed to the widget API and allows to query
        // the number of active uploads:
        active: function () {
            return this._active;
        },

        // This method is exposed to the widget API and allows to query
        // the widget upload progress.
        // It returns an object with loaded, total and bitrate properties
        // for the running uploads:
        progress: function () {
            return this._progress;
        },

        // This method is exposed to the widget API and allows adding files
        // using the fileupload API. The data parameter accepts an object which
        // must have a files property and can contain additional options:
        // .fileupload('add', {files: filesList});
        add: function (data) {
            var that = this;
            if (!data || this.options.disabled) {
                return;
            }
            if (data.fileInput && !data.files) {
                this._getFileInputFiles(data.fileInput).always(function (files) {
                    data.files = files;
                    that._onAdd(null, data);
                });
            } else {
                data.files = $.makeArray(data.files);
                this._onAdd(null, data);
            }
        },

        // This method is exposed to the widget API and allows sending files
        // using the fileupload API. The data parameter accepts an object which
        // must have a files or fileInput property and can contain additional options:
        // .fileupload('send', {files: filesList});
        // The method returns a Promise object for the file upload call.
        send: function (data) {
            if (data && !this.options.disabled) {
                if (data.fileInput && !data.files) {
                    var that = this,
                        dfd = $.Deferred(),
                        promise = dfd.promise(),
                        jqXHR,
                        aborted;
                    promise.abort = function () {
                        aborted = true;
                        if (jqXHR) {
                            return jqXHR.abort();
                        }
                        dfd.reject(null, 'abort', 'abort');
                        return promise;
                    };
                    this._getFileInputFiles(data.fileInput).always(
                        function (files) {
                            if (aborted) {
                                return;
                            }
                            if (!files.length) {
                                dfd.reject();
                                return;
                            }
                            data.files = files;
                            jqXHR = that._onSend(null, data);
                            jqXHR.then(
                                function (result, textStatus, jqXHR) {
                                    dfd.resolve(result, textStatus, jqXHR);
                                },
                                function (jqXHR, textStatus, errorThrown) {
                                    dfd.reject(jqXHR, textStatus, errorThrown);
                                }
                            );
                        }
                    );
                    return this._enhancePromise(promise);
                }
                data.files = $.makeArray(data.files);
                if (data.files.length) {
                    return this._onSend(null, data);
                }
            }
            return this._getXHRPromise(false, data && data.context);
        }

    });

}));



(function() {
  window.ChromePushNotifications = (function() {
    ChromePushNotifications.SENDER_ID = '56466713725';

    ChromePushNotifications.VAPID_KEY = 'BGP2u3_V7cOQi0hmg3utI7wkxtimNIDKLdYf3kWYStPDLrp2Am73BgoYH_5cc2Mzwq8rlpcjRsaKneevtyQFuzM';

    ChromePushNotifications.EVENTS = {
      PERMISSION_CHANGED: 'ChromePushNotifications:PermissionChanged'
    };

    function ChromePushNotifications() {
      if (window.ChromePushNotifications.INSTANCE != null) {
        return window.ChromePushNotifications.INSTANCE;
      } else {
        window.ChromePushNotifications.INSTANCE = this;
      }
      this.s = this.constructor;
      new utils.ObservableMixin(this);
      firebase.initializeApp({
        messagingSenderId: this.s.SENDER_ID
      });
      this.messaging = firebase.messaging();
      this.messaging.usePublicVapidKey(this.s.VAPID_KEY);
      this.messaging.onMessage(this.createNotification);
      this.messaging.onTokenRefresh((function(_this) {
        return function() {
          return _this.saveToken();
        };
      })(this));
      Notification.requestPermission().then((function(_this) {
        return function(permission) {
          _this.permission = permission;
          _this.trigger(_this.s.EVENTS.PERMISSION_CHANGED);
          if (permission === 'granted') {
            return _this.saveToken();
          }
        };
      })(this));
    }

    ChromePushNotifications.prototype.createNotification = function(payload) {
      var data, notification, params;
      data = payload.notification;
      if (!data) {
        return;
      }
      params = {
        body: data.body,
        icon: data.icon,
        data: {
          url: data.click_action
        }
      };
      notification = new Notification(data.title, params);
      return notification.onclick = function(e) {
        var notif;
        notif = e.currentTarget;
        notif.close();
        return window.open(notif.data.url);
      };
    };

    ChromePushNotifications.prototype.saveToken = function() {
      return this.messaging.getToken().then(function(token) {
        if (!token) {
          return;
        }
        return $.post(Routes.web_pushes_chrome_subscribe_path(), {
          token: token
        });
      });
    };

    return ChromePushNotifications;

  })();

}).call(this);
(function() {
  window.PushNotifications = {
    init: function() {
      if (this.isSupportedApi()) {
        return new window.ChromePushNotifications();
      } else if (GlobalState.BROWSER.isSafari()) {
        return new window.SafariPushNotifications();
      }
    },
    isSupportedApi: function() {
      return window.firebase && window.firebase.messaging && firebase.messaging.isSupported();
    }
  };

}).call(this);
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.SafariPushNotifications = (function() {
    SafariPushNotifications.PUSH_ID = 'web.com.coub';

    function SafariPushNotifications() {
      this.checkRemotePermission = bind(this.checkRemotePermission, this);
      var permissionData;
      if ('safari' in window && 'pushNotification' in window.safari) {
        permissionData = window.safari.pushNotification.permission(SafariPushNotifications.PUSH_ID);
        this.checkRemotePermission(permissionData);
        this.permissionAsked = false;
      } else {
        Stats.track("push_not_supported");
      }
    }

    SafariPushNotifications.prototype.checkRemotePermission = function(permissionData) {
      var e;
      switch (permissionData.permission) {
        case 'default':
          Stats.track("push_permission_asked");
          this.permissionAsked = true;
          try {
            return window.safari.pushNotification.requestPermission('https://coub.com/web_pushes/safari', SafariPushNotifications.PUSH_ID, {}, this.checkRemotePermission);
          } catch (error) {
            e = error;
            return console.warn("Safari push notifications prompt is disabled");
          }
          break;
        case 'denied':
          if (this.permissionAsked) {
            return Stats.track("push_permission_denied");
          }
          break;
        case 'granted':
          if (this.permissionAsked) {
            return Stats.track("push_permission_granted");
          }
      }
    };

    return SafariPushNotifications;

  })();

}).call(this);
